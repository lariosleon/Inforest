
if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spIns_MPEDIDO]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spIns_MPEDIDO]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spIns_TIPOCAMBIO]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spIns_TIPOCAMBIO]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spUpd_MPEDIDO]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spUpd_MPEDIDO]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_Anulacion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_Anulacion]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_Diferencia]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_Diferencia]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_Rotacion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_Rotacion]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_Ocupabilidad]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_Ocupabilidad]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_InforestAdm_ObtenerPrropiedadesReporte]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_InforestAdm_ObtenerPrropiedadesReporte]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_InforestAdm_ObtenerOfertasReporte]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_InforestAdm_ObtenerOfertasReporte]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_InforestAdm_ObtenerProductosReporteLocal]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_InforestAdm_ObtenerProductosReporteLocal]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_InforestAdm_ObtenerOperadoresReporteLocal]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_InforestAdm_ObtenerOperadoresReporteLocal]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_InforestCon_ObtenerReporteLiquidacionVentas]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_InforestCon_ObtenerReporteLiquidacionVentas]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_Comanda]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_Comanda]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_Cortesia]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_Cortesia]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_CtaCteN]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_CtaCteN]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_CuentasCobrar]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_CuentasCobrar]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_Descuento]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_Descuento]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_Liquidacion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_Liquidacion]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_LiquidacionOutPut]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_LiquidacionOutPut]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_LiquidacionSuma]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_LiquidacionSuma]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_PaloteoInsumo]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_PaloteoInsumo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_PaloteoProduccion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_PaloteoProduccion]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_PaloteoPropiedad]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_PaloteoPropiedad]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_PaloteoSubProd]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_PaloteoSubProd]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_Pedido]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_Pedido]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_Propina]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_Propina]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_PaloteoOferta]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_PaloteoOferta]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_AnaliticoMotorizado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_AnaliticoMotorizado]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_AnaliticoMozo]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_AnaliticoMozo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_Cancelacion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_Cancelacion]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_CobranzaFecha]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_CobranzaFecha]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_PaloteoComparativo]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_PaloteoComparativo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_PrincipalCliente]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_PrincipalCliente]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_Ranking]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_Ranking]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_RegVenta]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_RegVenta]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_RepClieFrecuentes]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_RepClieFrecuentes]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_ResultadoOperativo]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_ResultadoOperativo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_TiempoDelivery]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_TiempoDelivery]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_TiempoSalon]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_TiempoSalon]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_VentaCompMensual]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_VentaCompMensual]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_VentaFecha]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_VentaFecha]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[CreaTabla]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[CreaTabla]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_ActualizaTablas]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[sp_ActualizaTablas]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_AnaliticoMotorizadoIntegrado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_AnaliticoMotorizadoIntegrado]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_CtaCteIntegrado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_CtaCteIntegrado]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_FormaPagoIntegrado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_FormaPagoIntegrado]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_PaloteoInsumoIntegrado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_PaloteoInsumoIntegrado]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_PaloteoVentaIntegrado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_PaloteoVentaIntegrado]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_RankingIntegrado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_RankingIntegrado]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_RegVentaIntegrado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_RegVentaIntegrado]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_VentaMensualCanalesIntegrado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_VentaMensualCanalesIntegrado]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_VentaMensualIntegrado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_VentaMensualIntegrado]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_AnaliticoMozoIntegrado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_AnaliticoMozoIntegrado]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_PaloteoProduccionPorMes]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_PaloteoProduccionPorMes]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_KDS_GrabarPath]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_KDS_GrabarPath]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_KDS_ObtenerArea]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_KDS_ObtenerArea]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_KDS_ObtenerAreaImpresionKDS]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_KDS_ObtenerAreaImpresionKDS]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_KDS_ObtenerCategoria]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_KDS_ObtenerCategoria]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_KDS_ObtenerDetalleCombo]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_KDS_ObtenerDetalleCombo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_KDS_ObtenerDetallePedido]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_KDS_ObtenerDetallePedido]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_KDS_ObtenerNombreMesaXCodigo]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_KDS_ObtenerNombreMesaXCodigo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_KDS_ObtenerPath]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_KDS_ObtenerPath]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_KDS_ObtenerProductoArea]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_KDS_ObtenerProductoArea]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_KDS_ObtenerProductoPedido]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_KDS_ObtenerProductoPedido]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_KDS_ObtenerProductoPedidoDeCombo]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_KDS_ObtenerProductoPedidoDeCombo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_KDS_ObtenerProductoPedidoImpresos]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_KDS_ObtenerProductoPedidoImpresos]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_KDS_ObtenerPropiedadesProducto]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_KDS_ObtenerPropiedadesProducto]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_KDS_ObtenerTipoPedido]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_KDS_ObtenerTipoPedido]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_CopiaArchivosRemotos]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[sp_CopiaArchivosRemotos]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_KDS_GrabarTiempoSalidaDPedido]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_KDS_GrabarTiempoSalidaDPedido]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_TiempoDeliveryIntegrado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_TiempoDeliveryIntegrado]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_ComparativoConsumo]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[sp_ComparativoConsumo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_TipoProductoVentaIntegrado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_TipoProductoVentaIntegrado]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_KDS_ResporteTiempoPedido]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_KDS_ResporteTiempoPedido]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_KDS_ResporteTiempoProducto]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_KDS_ResporteTiempoProducto]
GO
if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_RegVentaSunat]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_RegVentaSunat]
GO
if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_RegVentaSunatAD]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_RegVentaSunatAD]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_UpdateReplicado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_UpdateReplicado]
GO
if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_ListadoMensajes]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_ListadoMensajes]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_CerrarMensajes_CierreTurno]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_CerrarMensajes_CierreTurno]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_agregarMensaje]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_agregarMensaje]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_modificarMensaje]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_modificarMensaje]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_LISTARMENSAJES]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_LISTARMENSAJES]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_CERRAR_MENSAJES_CIERRETURNO]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_CERRAR_MENSAJES_CIERRETURNO]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_ELIMINARRMENSAJES]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_ELIMINARRMENSAJES]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_MODIFICARINSUMOS]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_MODIFICARINSUMOS]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_LISTARINSUMOS]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_LISTARINSUMOS]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_AGREGARINSUMOS]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_AGREGARINSUMOS]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_ELIMINARINSUMOS]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_ELIMINARINSUMOS]
GO

IF  EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[dbo].[sgsnet_sps_split]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION sgsnet_sps_split
go

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_actualizaStockInsumo]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_actualizaStockInsumo]
GO 

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[ups_ObtieneFechaHora]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[ups_ObtieneFechaHora]
GO 

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_GenObtieneDiaContable]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_GenObtieneDiaContable]
GO 

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_GenInsertarDiaContable]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_GenInsertarDiaContable]
GO 

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[USP_INF_verificaProductoAreaPantalla]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[USP_INF_verificaProductoAreaPantalla]

GO 

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ActualizaDetalleAtendido]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ActualizaDetalleAtendido]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtieneRegistros]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtieneRegistros]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtieneRegistrosAtendidos]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtieneRegistrosAtendidos]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtieneComboRegistros]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtieneComboRegistros]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtienePropiedades]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtienePropiedades]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[ups_ObtieneFechaHoraS]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[ups_ObtieneFechaHoraS]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ReactivaDetalleAtendido]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ReactivaDetalleAtendido]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtieneAreasPantalla]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtieneAreasPantalla]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtenerResumen]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtenerResumen]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtenerResumenColores]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtenerResumenColores]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ActualizaDetalleComboAtendido]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ActualizaDetalleComboAtendido]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_deleteColumnasAreas]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_deleteColumnasAreas]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_InsertaColumnaAreaPantalla]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_InsertaColumnaAreaPantalla]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtieneOrdenColumnaAreaPantalla]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtieneOrdenColumnaAreaPantalla]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtieneCadenaGrilla]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtieneCadenaGrilla]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ActualizaDetalleCantado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ActualizaDetalleCantado]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Prototipo_Usuario_Validar]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Prototipo_Usuario_Validar]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtieneRegistrosDespacho]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtieneRegistrosDespacho]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ActualizaCabeceraAtendido]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ActualizaCabeceraAtendido]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtieneRegistrosDespachoAtendidos]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtieneRegistrosDespachoAtendidos]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_deleteColumnasAreasDespacho]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_deleteColumnasAreasDespacho]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_InsertaColumnaAreaPantallaDespacho]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_InsertaColumnaAreaPantallaDespacho]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtieneOrdenColumnaAreaPantallaDespacho]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtieneOrdenColumnaAreaPantallaDespacho]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtieneCadenaGrillaDespacho]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtieneCadenaGrillaDespacho]
GO
if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtieneDetallePedido]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtieneDetallePedido]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ReporteTiempoProductoResumido]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ReporteTiempoProductoResumido]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ReporteTiempoProductoDetallado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ReporteTiempoProductoDetallado]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtenerResumeng]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtenerResumeng]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtenerResumenz]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtenerResumenz]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtenerResument]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtenerResument]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_validarUsuario]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_validarUsuario]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_LimpaPedidos]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_LimpaPedidos]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_RevertirDetalleCantado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_RevertirDetalleCantado]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtieneResumenProductos]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtieneResumenProductos]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtienePropiedadesItemsCombos]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Cheff_ObtienePropiedadesItemsCombos]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Seg_cLientes]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Seg_cLientes]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Seg_verConexiones]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Seg_verConexiones]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_CargaPedidoReqExternoInforest]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[sp_CargaPedidoReqExternoInforest]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_PlanillaMovilidad]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_PlanillaMovilidad]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_PlanillaMovilidadGeneral]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_PlanillaMovilidadGeneral]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_CargaPedidoReqExternoDirectosInforest]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[sp_CargaPedidoReqExternoDirectosInforest]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AdmCen_ActualizarTablaCampos]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AdmCen_ActualizarTablaCampos]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AdmCen_ActualizarTablaPrincipal]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AdmCen_ActualizarTablaPrincipal]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AdmCen_ObtenerCamposxTablas]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AdmCen_ObtenerCamposxTablas]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AdmCen_ObtenerDependenciaPadres]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AdmCen_ObtenerDependenciaPadres]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AdmCen_ObtenerTablas]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AdmCen_ObtenerTablas]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AdmCen_ObtenerTablasPrincipales]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AdmCen_ObtenerTablasPrincipales]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AdmCen_ObtenerTablasPrincipales]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AdmCen_ObtenerTablasPrincipales]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AdmCen_ObtenerPermisosUsuario]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AdmCen_ObtenerPermisosUsuario]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Aud_ObtenerMozos]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Aud_ObtenerMozos]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Aud_ObtenerSalones]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Aud_ObtenerSalones]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Aud_ValidadUsuario]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Aud_ValidadUsuario]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Aud_ObtenerMotivoEliminacion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Aud_ObtenerMotivoEliminacion]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Aud_ObtenerUsuarios]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Aud_ObtenerUsuarios]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Aud_ObtenerEstadoImpreso]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Aud_ObtenerEstadoImpreso]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Aud_ObtenerTurnos]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Aud_ObtenerTurnos]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_ObtenerTipoDocumento]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_ObtenerTipoDocumento]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_ObtenerCliente]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_ObtenerCliente]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_ObtenerEstadoDocumento]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_ObtenerEstadoDocumento]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_ObtenerCaja]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_ObtenerCaja]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_ControlDocumentos]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_ControlDocumentos]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ObtenerTipoTramite]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ObtenerTipoTramite]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ValidadUsuario]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ValidadUsuario]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ObtenerTiposDocumentos]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ObtenerTiposDocumentos]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ObtenerEstablecimientoSeries]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ObtenerEstablecimientoSeries]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ObtenerTipoDocumentoSerieAProcesar]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ObtenerTipoDocumentoSerieAProcesar]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ObtieneAutorizacionAnterior]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ObtieneAutorizacionAnterior]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_InsertarSolicitudCab]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_InsertarSolicitudCab]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_InsertarSolicitudDetalle]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_InsertarSolicitudDetalle]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ObtenerSolicitudes]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ObtenerSolicitudes]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ObtenerTiposDocumentosActualizar]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ObtenerTiposDocumentosActualizar]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ObtenerTipoDocumentoSerieActualizar]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ObtenerTipoDocumentoSerieActualizar]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ActualizarSolicitudCab]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ActualizarSolicitudCab]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ActualizaEstadoSolicitudDetalle]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ActualizaEstadoSolicitudDetalle]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_AnularSolicitud]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_AnularSolicitud]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ObtenerTipoDocumentoSerieAntes]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ObtenerTipoDocumentoSerieAntes]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_obtenerSolicitudXAutorizacion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_obtenerSolicitudXAutorizacion]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ActualizarTiposDeDocumentos]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ActualizarTiposDeDocumentos]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_ComprobantesVentas]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_ComprobantesVentas]
go

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_AutorizacionAutoimpresion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_AutorizacionAutoimpresion]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ObtenerTipoDocumento]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ObtenerTipoDocumento]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ObtenerCliente]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ObtenerCliente]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ObtenerEstadoDocumento]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ObtenerEstadoDocumento]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ObtenerSolicitud]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ObtenerSolicitud]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ObtenerCaja]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ObtenerCaja]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ObtenerTramite]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ObtenerTramite]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_AutSol_ObtenerEstadoTramite]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_AutSol_ObtenerEstadoTramite]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_UpdFotoDelivery]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[sp_UpdFotoDelivery]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_TraeDatosVentas_SyBase]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[sp_TraeDatosVentas_SyBase]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_TraeDatosPagos_SyBase]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[sp_TraeDatosPagos_SyBase]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_InsUptSocioDelivery_SyBASE]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[sp_InsUptSocioDelivery_SyBASE]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_CreaTemporalSocio_SyBASE]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[sp_CreaTemporalSocio_SyBASE]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Inforest_ObtenerInsumosCriticos]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Inforest_ObtenerInsumosCriticos]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Inforest_RevertirInsumosCriticos]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Inforest_RevertirInsumosCriticos]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Inforest_RevertirInsumosCriticosCabecera]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Inforest_RevertirInsumosCriticosCabecera]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Inforest_ValidaDeliveryCliente]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Inforest_ValidaDeliveryCliente]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_VentaIntervaloIntegrado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[spRep_VentaIntervaloIntegrado]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Inforest_ObtienePedidosPorSocios]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Inforest_ObtienePedidosPorSocios]
GO
if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Inforest_ObtieneClientesFactura]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Inforest_ObtieneClientesFactura]
GO
if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Inforest_ObtenerClientesFrecuente]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_Inforest_ObtenerClientesFrecuente]
GO
if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_UpdFotoProducto]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[sp_UpdFotoProducto]
GO

IF exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtenerResumenColoresXCaja]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP procedure [dbo].[usp_Cheff_ObtenerResumenColoresXCaja]
GO
IF exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtenerResumenXCaja]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP procedure [dbo].[usp_Cheff_ObtenerResumenXCaja]
GO
IF exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtieneAreasPantallaxCaja]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP procedure [dbo].[usp_Cheff_ObtieneAreasPantallaxCaja]
GO
IF exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtieneAreaxCaja]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP procedure [dbo].[usp_Cheff_ObtieneAreaxCaja]
GO
IF exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtieneRegistrosAtendidosXCaja]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP procedure [dbo].[usp_Cheff_ObtieneRegistrosAtendidosXCaja]
GO
IF exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtieneRegistrosxCaja]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP procedure [dbo].[usp_Cheff_ObtieneRegistrosxCaja]
GO
IF exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_Cheff_ObtieneResumenProductosXCaja]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP procedure [dbo].[usp_Cheff_ObtieneResumenProductosXCaja]
GO

IF exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_AnulacionPedidoIntegrado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP procedure [dbo].[spRep_AnulacionPedidoIntegrado]
GO
IF exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_AnulacionDocumentoIntegrado]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP procedure [dbo].[spRep_AnulacionDocumentoIntegrado]
GO

IF exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spRep_MensajeUsuario]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP procedure [dbo].[spRep_MensajeUsuario]
GO




SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE Proc [dbo].[USP_INF_verificaProductoAreaPantalla]
@tCodigoProducto as nvarchar(7) 
AS

begin

set nocount on

Select 
	Count(*) cantidad 
from 
	TPRODUCTOAREA AS Pa 	Left Join vArea A On Pa.tArea = A.Codigo Where  Pa.tCodigoProducto = @tCodigoProducto 	 and isnull(a.lcheffcontrol,0)=1

end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO





SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create PROCEDURE [dbo].[spRep_AnaliticoMozoIntegrado]
@flagProduccion as bit,
@flagVenta as bit,
@flagCortesia as bit,
@flagCuentaCte as bit,
@flagPedidosFacturados as bit,
@flagCombinacion as bit,
@flagCargo as bit,
@finicio as smalldatetime,
@ffinal as smalldatetime,
@sPrecio as nvarchar(150)
AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(2000)
declare @sCriterioM nvarchar(2000)
declare @xCriterio nvarchar(2000)
PRINT @SCRITERIOM
set @comilla=''''
	
	CREATE TABLE #DBTRANS (Mozo nVarChar(150) collate Modern_Spanish_CI_AS, TipoProducto nVarChar(150) collate Modern_Spanish_CI_AS, Grupo nVarChar(150) collate Modern_Spanish_CI_AS, SubGrupo nVarChar(150) collate Modern_Spanish_CI_AS, Producto nVarChar(150) collate Modern_Spanish_CI_AS, Cantidad Float, Venta Float, nPedidos Float,tcodigopedido nvarchar(15) collate Modern_Spanish_CI_AS)
	

	set @scriterio =' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @xCriterio =' MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + '  and MDOCUMENTO.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @scriterioM=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla


 
	 --print @scriterio
	--print @sfiltro


if @flagProduccion=1 --produccion
begin
	--Produccion
	set @sql =  ' Insert into #DBTRANS (Mozo, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,  nPedidos,tcodigopedido )  ' +
        	    ' SELECT dbo.vMozo.Descripcion AS MOZO, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta,  A.Pedidos,dpedido.tcodigopedido ' + 
	            ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo  RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido  LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo  ' + 
	            ' LEFT OUTER JOIN (select max(tMozo) as tMozo, isnull(sum(dbo.mPedido.nAdulto),0) as Adultos, isnull(sum(dbo.mPedido.nNino),0) as Ninos, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+'   and ' +  @sCriterioM + ' group by tMozo) AS a ON A.tMozo=dbo.mPedido.tMozo  ' +
	            ' where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+ 'N'+@comilla+'  and ' + @sCriterio
END 
	
if @flagVenta=1 --venta
begin
   --Ventas
	set @sql =  ' Insert into #DBTRANS (Mozo, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,  nPedidos,tcodigopedido )  ' +
        	    ' SELECT dbo.vMozo.Descripcion AS MOZO, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta,  A.Pedidos,dpedido.tcodigopedido  ' +
	            ' FROM dbo.MDOCUMENTO INNER JOIN   dbo.DPEDIDO ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN  dbo.MPEDIDO LEFT OUTER JOIN  dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN  ' +
	            ' ( SELECT MAX(tMozo) AS tMozo, ISNULL(SUM(nAdulto), 0) AS Adultos, ISNULL(SUM(nNino), 0) AS Ninos, ISNULL(COUNT(tCodigoPedido), 0) AS Pedidos From dbo.MPEDIDO WHERE tCodigoPedido IN (SELECT dbo.MPEDIDO.tCodigoPedido FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento  ' +
	            ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sCriterioM + ' and '+ @xCriterio + ' GROUP BY dbo.MPEDIDO.tCodigoPedido ) Group by tMozo) AS A ON A.tMozo=dbo.mPedido.tMozo  ' +
	            ' where dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sCriterio + ' and ' + @xCriterio
 
end

if @flagCortesia=1 --cortesia
begin
  --Cortesias
	set @sql =  ' Insert into #DBTRANS (Mozo, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,  nPedidos,tcodigopedido )  ' +
        	    ' SELECT dbo.vMozo.Descripcion AS MOZO, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta,  A.Pedidos ,dbo.dpedido.tcodigopedido ' +
	            ' FROM dbo.MDOCUMENTO INNER JOIN   dbo.DPEDIDO ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN  dbo.MPEDIDO LEFT OUTER JOIN  dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN  ' +
	            ' ( SELECT MAX(tMozo) AS tMozo, ISNULL(SUM(nAdulto), 0) AS Adultos, ISNULL(SUM(nNino), 0) AS Ninos, ISNULL(COUNT(tCodigoPedido), 0) AS Pedidos From dbo.MPEDIDO WHERE tCodigoPedido IN (SELECT dbo.MPEDIDO.tCodigoPedido FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento  ' +
	            ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' and ' + @sCriterioM + ' GROUP BY dbo.MPEDIDO.tCodigoPedido ) Group by tMozo) AS A ON A.tMozo=dbo.mPedido.tMozo  ' +
        	    ' where dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' and ' + @sCriterio
     
end 


if @flagCuentaCte=1 --cuenta corriente
begin
   --Cuentas Corrientes
	set @sql =  ' Insert into #DBTRANS (Mozo, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,  nPedidos,tcodigopedido )  ' +
        	    ' SELECT dbo.vMozo.Descripcion AS MOZO, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, A.Pedidos,dbo.dpedido.tcodigopedido  ' +
	            ' FROM dbo.MPEDIDO  LEFT OUTER JOIN dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo  RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido   LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo  ' +
	            ' LEFT OUTER JOIN (select max(tMozo) as tMozo, isnull(sum(dbo.mPedido.nAdulto),0) as Adultos, isnull(sum(dbo.mPedido.nNino),0) as Ninos, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido = '+@comilla+ '04'+@comilla+' and ' + @sCriterioM + ' group by tMozo) AS a ON A.tMozo=dbo.mPedido.tMozo  ' +
	            ' where MPEDIDO.tEstadoPedido = '+@comilla+ '04'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+ 'N'+@comilla+' and ' +  @sCriterio
 
END

if @flagCombinacion=1 --combinacion
begin
   --Combinacion
	set @sql =  ' Insert into #DBTRANS (Mozo, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,  nPedidos,tcodigopedido )  ' +
        	    ' SELECT dbo.vMozo.Descripcion AS Mozo, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, ' + @sPrecio + ' AS Venta,  A.Pedidos,dbo.mpedido.tcodigopedido  ' +
	            ' FROM dbo.MPEDIDO  LEFT OUTER JOIN dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo  RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido  LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCOMBO = dbo.vProducto.Codigo  ' +
	            ' LEFT OUTER JOIN (select max(tMozo) as tMozo, isnull(sum(dbo.mPedido.nAdulto),0) as Adultos, isnull(sum(dbo.mPedido.nNino),0) as Ninos, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and ' + @sCriterioM + ' group by tMozo) AS a ON A.tMozo=dbo.mPedido.tMozo  ' +
	            ' where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and ' + @sCriterio
end

if @flagCargo=1 --cargo
begin
	   
   --Cargos
	set @sql =  ' Insert into #DBTRANS (Mozo, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,  nPedidos,tcodigopedido )  ' +
    	       	    ' SELECT dbo.vMozo.Descripcion AS MOZO, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta,  A.Pedidos ,dbo.dpedido.tcodigopedido ' +
      	   	    ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo  RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido  LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo  ' +
     	       	    ' LEFT OUTER JOIN (select max(tMozo) as tMozo, isnull(sum(dbo.mPedido.nAdulto),0) as Adultos, isnull(sum(dbo.mPedido.nNino),0) as Ninos, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido = '+@comilla+ '05'+@comilla+' and ' + @sCriterioM +  ' group by tMozo) AS a ON A.tMozo=dbo.mPedido.tMozo  ' +
     	            ' where MPEDIDO.tEstadoPedido ='+@comilla+ '05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+ 'N'+@comilla+' and ' + @sCriterio

end	
	
if @flagPedidosFacturados=1 --pedidos facturados
begin
       
   --Pedidos Facturados
	set @sql =  ' Insert into #DBTRANS (Mozo, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,  nPedidos,tcodigopedido )  ' +
           		' SELECT dbo.vMozo.Descripcion AS MOZO, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta,  A.Pedidos,dbo.dpedido.tcodigopedido  ' +
            		' FROM dbo.MDOCUMENTO INNER JOIN   dbo.DPEDIDO ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN  dbo.MPEDIDO LEFT OUTER JOIN  dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN  ' +
	                ' ( SELECT MAX(tMozo) AS tMozo, ISNULL(SUM(nAdulto), 0) AS Adultos, ISNULL(SUM(nNino), 0) AS Ninos, ISNULL(COUNT(tCodigoPedido), 0) AS Pedidos From dbo.MPEDIDO WHERE tCodigoPedido IN (SELECT dbo.MPEDIDO.tCodigoPedido FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento  ' +
	                ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sCriterioM + ' GROUP BY dbo.MPEDIDO.tCodigoPedido ) Group by tMozo) AS A ON A.tMozo=dbo.mPedido.tMozo  ' +
                    ' where dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sCriterio

end

-- print @sql
EXEC sp_executesql @sql

  SELECT isnull(Mozo,'SIN MOZO'), TipoProducto, Grupo, SubGrupo, Producto, tcodigopedido,SUM(Cantidad) AS Cantidad, SUM(Venta) AS Ventas, max(nPedidos) as nPedidos 
  From #dbtrans Group By Mozo, Grupo, SubGrupo, Producto, TipoProducto,tcodigopedido

/**/


END

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create PROCEDURE [dbo].[spIns_MPEDIDO] 
@tCliente as nVarChar(7),
@tTipoPedido as nVarChar(2),
@lPrioridad as bit,
@tTipoAtencion as nVarChar(2),
@tMesa as nVarChar(3),
@tMozo as nVarChar(4),
@tMotorizado as nVarChar(4),
@tCaja as nVarChar(3),
@tSalon as nVarChar(3),
@tTurno as nVarchar(10),
@tObservacion as nVarchar(250),
@nTiempo as int,
@tUsuario as nVarchar(15),
@nAdulto as int,
@nNino as int,
@nMesa as int,
@tPuntoVenta as nVarChar(2),
@tHabitacion as nVarChar(6),
@tReserva as nVarChar(6),
@tPasajero as nVarChar(50),
@tCompania as nVarChar(5),
@tContacto as nVarChar(4),
@nDescuento as float,
@tDescuento as nVarChar(3),
@tObservacionDescuento  as nVarchar(250),
@tAutorizaDescuento as nVarchar(15),
@nTiempoDelivery as int,
@tTienda as nVarChar(3),
@fDiaContable as datetime,
@fProgramacion as datetime,
@tCodigoInvitado as nVarChar(10),
@tcodigoPariente as nvarchar(7),
@tPedido as nvarchar(10) output

AS
Begin
declare @nCorrela bigint
declare @xSalon nVarchar(2)

set @nCorrela = (isnull((select nCORRELATIVO from TPARAMETRO) + 1,1))
Update TPARAMETRO Set nCorrelativo = @nCorrela

if @tMesa <> '' 
set @xSalon=(select tSalon from TMESA where tCodigoMesa=@tMesa)
else
set @xSalon=@tSalon

set @tPedido=(select substring(max(tCodigoPedido),3,8)+1 as Codigo from mpedido where substring(tCodigoPedido,1,2)= substring(ltrim(str(year(getdate()))),3,2))
set @tPedido = (substring(ltrim(str(year(getdate()))),3,2)+substring('00000000',1,8-len(ltrim(str(isnull(@tPedido,1)))))+isnull(@tPedido,1))

Insert into MPEDIDO (tCodigoPedido,nCorrelativo, tClienteDelivery,fFecha,tEstadoPedido,tTipoPedido,lPrioridad, tTipoAtencion,tMesa,tMozo,tMotorizado,tCaja, tSalon, tTurno, tObservacion, nTiempo,tUsuario,nAdulto,nNino,nMesa,tPuntoVenta,tHabitacion, tReserva, tPasajero, tCompania, tContacto, tCajaAnterior, tTurnoAnterior, nDescuento, tDescuento, tObservacionDescuento, tUsuarioDescuento, nTiempoDelivery, fRegistro, tTienda, fDiaContable, fProgramacion, tCodigoInvitado,tcodigopariente)
Values( @tPedido, @nCorrela, @tCliente, getdate(), '01', @tTipoPedido, @lPrioridad,@tTipoAtencion, @tMesa, @tMozo, @tMotorizado, @tCaja, @xSalon, @tTurno, @tObservacion, @nTiempo, @tUsuario, @nAdulto, @nNino, @nMesa, @tPuntoVenta, @tHabitacion, @tReserva, @tPasajero, @tCompania, @tContacto, @tCaja, @tTurno, @nDescuento, @tDescuento, @tObservacionDescuento, @tAutorizaDescuento, @nTiempoDelivery, getdate(), @tTienda, @fDiaContable, @fProgramacion, @tCodigoInvitado,@tcodigoPariente)

update TPEDIDOMESA set tCodigoPedido=@tPedido where tCodigoPedido=''


End





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE spIns_TipoCambio
@nTC  float=0,
@tUsuario   VARCHAR(15)='',
@nTCO  float=0
AS
BEGIN

if (select count(nVenta) from TTIPOCAMBIO where fFecha = {fn curdate()})=0
begin

insert into TTIPOCAMBIO(ffecha, nVenta, nCompra, tUsuario, fRegistro, nOficial )  values ( {fn curdate()}, @nTC, 0, @tUsuario, getdate(), @nTCO )

end

else

begin

update TTIPOCAMBIO set nventa=@nTC,noficial=@nTCO  
where fFecha = {fn curdate()}

end

END
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE [dbo].[spUpd_MPEDIDO] 
@tCliente as nVarChar(7),
@tTipoPedido as nVarChar(2),
@lPrioridad as bit,
@tTipoAtencion as nVarChar(2),
@tMozo as nVarChar(4),
@tMotorizado as nVarChar(4),
@tObservacion as nVarchar(250),
@nTiempo as int,
@tPuntoVenta as nVarChar(2),
@tHabitacion as nVarChar(6),
@tReserva as nVarChar(6),
@tPasajero as nVarChar(50),
@tCompania as nVarChar(5),
@tContacto as nVarChar(4),
@nDescuento as float,
@tDescuento as nVarChar(3),
@tObservacionDescuento  as nVarchar(250),
@tAutorizaDescuento as nVarchar(15),
@tTienda as nVarChar(3),
@fProgramacion as datetime,
@tcodigoInvitado as nVarChar(10),
@tCodigoPariente as nvarchar(7),
@tPedido as nvarchar(10) 

AS
Begin

Update MPEDIDO Set tClienteDelivery = @tCliente,  tTipoPedido = @tTipoPedido, lPrioridad = @lPrioridad, tTipoAtencion = @tTipoAtencion, tMozo =@tMozo, tMotorizado=@tMotorizado, tObservacion = @tObservacion, nTiempo = @nTiempo, tcodigoinvitado=@tcodigoInvitado ,
                          tPuntoVenta=@tPuntoVenta, tHabitacion=@tHabitacion, tReserva=@tReserva, tPasajero=@tPasajero, tCompania=@tCompania, tContacto=@tContacto, nDescuento= @nDescuento, 
                          tDescuento=@tDescuento, tUsuarioDescuento=@tAutorizaDescuento, tObservacionDescuento=@tObservacionDescuento,
						  tTienda=@tTienda, fProgramacion=@fProgramacion, tcodigopariente=@tCodigoPariente	
                          where tCodigoPedido = @tPedido 


End
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE [dbo].[spRep_Anulacion]
@lFranjaHoraria as bit,
@tTurno as nVarChar(10),
@fInicio as smalldatetime,
@fFinal as smalldatetime,
@lFlag1 as bit,
@lFlag2 as bit,
@lFlag3 as bit

AS BEGIN
set nocount on

CREATE TABLE #DBTRANS (
	tCodigoPedido nVarchar(10)	collate Modern_Spanish_CI_AS,
	tItem nVarchar(3)	collate Modern_Spanish_CI_AS,
	tCodigoProducto nVarChar(7)	collate Modern_Spanish_CI_AS,
	nCantidad float, 
	nVenta float, 
	tEstadoItem nVarChar(1)	collate Modern_Spanish_CI_AS,
	tDocumento nVarChar(20)	collate Modern_Spanish_CI_AS,
	fRegistro smalldatetime, 
	lImprime bit, 
	tMotivoAnulacion nVarChar(3)	collate Modern_Spanish_CI_AS,
	tObservacionAnulado nVarChar(250)	collate Modern_Spanish_CI_AS,
	tUsuarioAnulado nVarChar(15)	collate Modern_Spanish_CI_AS,
	fRegAnulado smalldatetime, 
	tTurno nVarChar(10)	collate Modern_Spanish_CI_AS,
	fFechaItem smalldatetime)

if @lFranjaHoraria=0 
begin

-- Items Facturados
if @lFlag1 = 1
Begin
if @tTurno = ''
	Insert into #DBTRANS
	SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, dbo.DPEDIDO.nCantidad, dbo.DPEDIDO.nVenta, dbo.DPEDIDO.tEstadoItem, dbo.DPEDIDO.tDocumento, dbo.MDOCUMENTO.fregistro, dbo.DPEDIDO.lImprime, '' as tMotivoAnulacion, '' as tObservacionAnulado, '' as tUsuarioAnulado, '' as fRegAnulado, '' as tTurno, dbo.DPEDIDO.fRegistro
	FROM  dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento
	Where (dbo.DPEDIDO.tEstadoItem =  'N')  and (MPEDIDO.fRegistro >= @fInicio and MPEDIDO.fRegistro<= @fFinal)  
else
	Insert into #DBTRANS
	SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, dbo.DPEDIDO.nCantidad, dbo.DPEDIDO.nVenta, dbo.DPEDIDO.tEstadoItem, dbo.DPEDIDO.tDocumento, dbo.MDOCUMENTO.fregistro, dbo.DPEDIDO.lImprime, '' as tMotivoAnulacion, '' as tObservacionAnulado, '' as tUsuarioAnulado, '' as fRegAnulado, '' as tTurno, dbo.DPEDIDO.fRegistro
	FROM  dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento
	WHERE     (dbo.DPEDIDO.tEstadoItem = 'N') and dbo.MPEDIDO.tTurno = @tTurno 
end


-- Cabeceras en blanco
if @lFlag2 = 1
Begin
if @tTurno = ''
	Insert into #DBTRANS
	SELECT tCodigoPedido, '', '', 0, 0, 'A', '', null, 0, dbo.MPEDIDO.tMotivoAnulacion, Dbo.MPEDIDO.tobservacionAnulado, dbo.MPEDIDO.tusuarioAnulado, '' as fRegAnulado, '' as tTurno, '' as fFechaItem
	from mpedido 
	WHERE  tEstadoPedido='03'  and ((MPEDIDO.fRegistro >= @fInicio and MPEDIDO.fRegistro<= @fFinal)  or (MPEDIDO.fRegAnulado >= @fInicio and MPEDIDO.fRegAnulado<= @fFinal))
	and tcodigopedido not in (select distinct tcodigopedido from dpedido where fRegistro >=  @fInicio and fRegistro<= @fFinal ) 
	and tcodigopedido not in (select distinct tcodigopedido from apedido where fRegistro >=  @fInicio and fRegistro<= @fFinal ) 

else
	Insert into #DBTRANS
	SELECT tCodigoPedido, '', '', 0, 0, 'A', '', null, 0, dbo.MPEDIDO.tMotivoAnulacion, Dbo.MPEDIDO.tobservacionAnulado, dbo.MPEDIDO.tusuarioAnulado, '' as fRegAnulado, '' as tTurno, '' as fFechaItem
	from mpedido 
	WHERE  tEstadoPedido='03'  and (tTurno = @tTurno or MPEDIDO.tTurnoAnulado = @tTurno)
	and tcodigopedido not in (select distinct tcodigopedido from dpedido where tTurno = @tTurno ) 
	and tcodigopedido not in (select distinct tcodigopedido from apedido where tTurno = @tTurno ) 

end

-- Pedidos Anulados
if @lFlag2 = 1
Begin
if @tTurno = ''
	Insert into #DBTRANS
	SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, dbo.DPEDIDO.nCantidad, dbo.DPEDIDO.nVenta, dbo.DPEDIDO.tEstadoItem, '' as tDocumento, dbo.MPEDIDO.fregAnulado, dbo.DPEDIDO.lImprime, dbo.MPEDIDO.tMotivoAnulacion, Dbo.MPEDIDO.tobservacionAnulado, dbo.MPEDIDO.tusuarioAnulado, dbo.MPEDIDO.fregAnulado, dbo.MPEDIDO.tTurnoAnulado, dbo.DPEDIDO.fRegistro
	FROM   dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido 
	WHERE     (dbo.DPEDIDO.tEstadoItem <> 'N')  and ((MPEDIDO.fRegistro >= @fInicio and MPEDIDO.fRegistro<= @fFinal)  or (MPEDIDO.fRegAnulado >= @fInicio and MPEDIDO.fRegAnulado<= @fFinal))
else

	Insert into #DBTRANS
	SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, dbo.DPEDIDO.nCantidad, dbo.DPEDIDO.nVenta, dbo.DPEDIDO.tEstadoItem, '' as tDocumento, dbo.MPEDIDO.fregAnulado, dbo.DPEDIDO.lImprime, dbo.MPEDIDO.tMotivoAnulacion, Dbo.MPEDIDO.tobservacionAnulado, dbo.MPEDIDO.tusuarioAnulado, dbo.MPEDIDO.fregAnulado, dbo.MPEDIDO.tTurnoAnulado , dbo.DPEDIDO.fRegistro
	FROM   dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido 
	WHERE     (dbo.DPEDIDO.tEstadoItem <> 'N') and (tTurno = @tTurno or MPEDIDO.tTurnoAnulado = @tTurno)
end

-- Items Anulados
if @lFlag2 = 1
Begin
if @tTurno = ''
	Insert into #DBTRANS
	SELECT dbo.APEDIDO.tCodigoPedido, dbo.APEDIDO.tItem, dbo.APEDIDO.tCodigoProducto, dbo.APEDIDO.nCantidad, dbo.APEDIDO.nVenta, 'A' AS tEstadoItem, '' as tDocumento, dbo.APEDIDO.fRegistroAnulado, dbo.APEDIDO.lImprime, dbo.APEDIDO.tMotivoEliminacion, dbo.APEDIDO.tObservacionAnulado, dbo.APEDIDO.tUsuarioAnulado, dbo.APEDIDO.fRegistroAnulado, dbo.APEDIDO.tTurnoAnulado, dbo.APEDIDO.fRegistro
	FROM   dbo.MPEDIDO INNER JOIN dbo.APEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.APEDIDO.tCodigoPedido 
	where   (MPEDIDO.fRegistro >= @fInicio and MPEDIDO.fRegistro<= @fFinal) or (APEDIDO.fRegistroAnulado >= @fInicio and APEDIDO.fRegistroAnulado <= @fFinal)
else
	Insert into #DBTRANS
	SELECT dbo.APEDIDO.tCodigoPedido, dbo.APEDIDO.tItem, dbo.APEDIDO.tCodigoProducto, dbo.APEDIDO.nCantidad, dbo.APEDIDO.nVenta, 'A' AS tEstadoItem, '' as tDocumento, dbo.APEDIDO.fRegistroAnulado, dbo.APEDIDO.lImprime, dbo.APEDIDO.tMotivoEliminacion, dbo.APEDIDO.tObservacionAnulado, dbo.APEDIDO.tUsuarioAnulado, dbo.APEDIDO.fRegistroAnulado, dbo.APEDIDO.tTurnoAnulado, dbo.APEDIDO.fRegistro
	FROM   dbo.MPEDIDO INNER JOIN dbo.APEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.APEDIDO.tCodigoPedido 
	Where  MPEDIDO.tTurno = @tTurno or APEDIDO.tTurnoAnulado = @tTurno
end

-- Items Transferidos
if @lFlag3 = 1
Begin
if @tTurno = ''
	Insert into #DBTRANS
	SELECT  dbo.MPEDIDO.tCodigoPedido, dbo.TPEDIDO.tItemIni, dbo.TPEDIDO.tProducto, dbo.TPEDIDO.nCantidad, dbo.TPEDIDO.nVenta, 'T' AS tEstadoItem,  '' as tDocumento, dbo.TPEDIDO.fRegistro, 1, '000' as tMotivoEliminacion, 'Transferencia al Pedido ' + dbo.TPEDIDO.tPedidoFin AS tobservacionAnulado, dbo.TPEDIDO.tUsuario AS tusuarioAnulado, '' AS fregAnulado, TPEDIDO.tTurno, dbo.MPEDIDO.fRegistro
	FROM dbo.MPEDIDO INNER JOIN dbo.TPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.TPEDIDO.tPedidoIni
	where   (MPEDIDO.fRegistro >= @fInicio and MPEDIDO.fRegistro<= @fFinal) OR (TPEDIDO.fRegistro >= @fInicio and TPEDIDO.fRegistro<= @fFinal)
else
	Insert into #DBTRANS
	SELECT  dbo.MPEDIDO.tCodigoPedido, dbo.TPEDIDO.tItemIni, dbo.TPEDIDO.tProducto, dbo.TPEDIDO.nCantidad, dbo.TPEDIDO.nVenta, 'T' AS tEstadoItem,  '' as tDocumento, dbo.TPEDIDO.fRegistro, 1, '000' as tMotivoEliminacion, 'Transferencia al Pedido ' + dbo.TPEDIDO.tPedidoFin AS tobservacionAnulado, dbo.TPEDIDO.tUsuario AS tusuarioAnulado, '' AS fregAnulado, TPEDIDO.tTurno, dbo.MPEDIDO.fRegistro
	FROM dbo.MPEDIDO INNER JOIN dbo.TPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.TPEDIDO.tPedidoIni
	Where MPEDIDO.tTurno = @tTurno or TPEDIDO.tTurno = @tTurno
end

--Pedidos
SELECT     dbo.MPEDIDO.tCodigoPedido, dbo.MPEDIDO.tEstadoPedido, dbo.vEstadoPedido.Descripcion AS EstadoPedido, 
                   dbo.MPEDIDO.fRegistro, dbo.MPEDIDO.tUsuario, dbo.MPEDIDO.tCaja, dbo.MPEDIDO.tTurno, dbo.MPEDIDO.fregAnulado, 
                   dbo.MPEDIDO.tusuarioAnulado, dbo.MPEDIDO.tTurnoAnulado, dbo.MPEDIDO.tMotivoAnulacion, vMotivoEliminacion_2.Descripcion AS MotivoAnulacion,
                   dbo.MPEDIDO.tobservacionAnulado, #DBTRANS.tItem, #DBTRANS.nCantidad, #DBTRANS.nVenta, #DBTRANS.tEstadoItem, 
                   #DBTRANS.fRegistro AS ItemRegistro, #DBTRANS.lImprime, #DBTRANS.tMotivoAnulacion AS ItemtMotivoAnulacion, 
                   #DBTRANS.tObservacionAnulado AS ItemObservacionAnulacion, #DBTRANS.tUsuarioAnulado AS ItemtUsuarioAnulado, 
                   #DBTRANS.fRegAnulado AS ItemfRegAnulado, #DBTRANS.tTurno AS tItemTurno, dbo.vProducto.Descripcion AS Producto, 
                   vMotivoEliminacion_1.Descripcion AS ItemMotivoEliminacion, #DBTRANS.tDocumento, tDocumento, dbo.MPEDIDO.tSalon, dbo.vSalon.Descripcion AS Salon, 
                   dbo.TMESA.tDetallado AS Mesa, #DBTRANS.fFechaItem
FROM         dbo.TMESA RIGHT OUTER JOIN
                   dbo.MPEDIDO ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN
                   dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN
                   dbo.vMotivoEliminacion vMotivoEliminacion_2 ON dbo.MPEDIDO.tMotivoAnulacion = vMotivoEliminacion_2.Codigo LEFT OUTER JOIN
                   dbo.vEstadoPedido ON dbo.MPEDIDO.tEstadoPedido = dbo.vEstadoPedido.Codigo RIGHT OUTER JOIN
                   dbo.vMotivoEliminacion vMotivoEliminacion_1 RIGHT OUTER JOIN
                   #DBTRANS ON vMotivoEliminacion_1.Codigo = #DBTRANS.tMotivoAnulacion LEFT OUTER JOIN
                   dbo.vProducto ON #DBTRANS.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = #DBTRANS.tCodigoPedido
ORDER BY dbo.MPEDIDO.tCodigoPedido, #DBTRANS.tEstadoItem, #DBTRANS.tItem

end


if @lFranjaHoraria=1
begin

 
declare @numdias int
declare @contaDias int
declare @finicial as datetime
set @numdias=(select   DATEDIFF ( day , @finicio,@ffinal))
 
set @contaDias=0
set @finicial=@finicio
while (@contadias<=@numdias)
	begin
		set @finicio=(select dateadd(day,@contadias,@finicial))	
	set @ffinal= (select  cast(convert(nvarchar,@finicio,112)   + ' '  + CONVERT(VARCHAR,@ffinal,108) as datetime))

		begin

-- Items Facturados
if @lFlag1 = 1
Begin
if @tTurno = ''
	Insert into #DBTRANS
	SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, dbo.DPEDIDO.nCantidad, dbo.DPEDIDO.nVenta, dbo.DPEDIDO.tEstadoItem, dbo.DPEDIDO.tDocumento, dbo.MDOCUMENTO.fregistro, dbo.DPEDIDO.lImprime, '' as tMotivoAnulacion, '' as tObservacionAnulado, '' as tUsuarioAnulado, '' as fRegAnulado, '' as tTurno, dbo.DPEDIDO.fRegistro
	FROM  dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento
	Where (dbo.DPEDIDO.tEstadoItem =  'N')  and (MPEDIDO.fRegistro >= @fInicio and MPEDIDO.fRegistro<= @fFinal)  
else
	Insert into #DBTRANS
	SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, dbo.DPEDIDO.nCantidad, dbo.DPEDIDO.nVenta, dbo.DPEDIDO.tEstadoItem, dbo.DPEDIDO.tDocumento, dbo.MDOCUMENTO.fregistro, dbo.DPEDIDO.lImprime, '' as tMotivoAnulacion, '' as tObservacionAnulado, '' as tUsuarioAnulado, '' as fRegAnulado, '' as tTurno, dbo.DPEDIDO.fRegistro
	FROM  dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento
	WHERE     (dbo.DPEDIDO.tEstadoItem = 'N') and dbo.MPEDIDO.tTurno = @tTurno 
end


-- Cabeceras en blanco
if @lFlag2 = 1
Begin
if @tTurno = ''
	Insert into #DBTRANS
	SELECT tCodigoPedido, '', '', 0, 0, 'A', '', null, 0, dbo.MPEDIDO.tMotivoAnulacion, Dbo.MPEDIDO.tobservacionAnulado, dbo.MPEDIDO.tusuarioAnulado, '' as fRegAnulado, '' as tTurno, '' as fFechaItem
	from mpedido 
	WHERE  tEstadoPedido='03'  and ((MPEDIDO.fRegistro >= @fInicio and MPEDIDO.fRegistro<= @fFinal)  or (MPEDIDO.fRegAnulado >= @fInicio and MPEDIDO.fRegAnulado<= @fFinal))
	and tcodigopedido not in (select distinct tcodigopedido from dpedido where fRegistro >=  @fInicio and fRegistro<= @fFinal ) 
	and tcodigopedido not in (select distinct tcodigopedido from apedido where fRegistro >=  @fInicio and fRegistro<= @fFinal ) 

else
	Insert into #DBTRANS
	SELECT tCodigoPedido, '', '', 0, 0, 'A', '', null, 0, dbo.MPEDIDO.tMotivoAnulacion, Dbo.MPEDIDO.tobservacionAnulado, dbo.MPEDIDO.tusuarioAnulado, '' as fRegAnulado, '' as tTurno, '' as fFechaItem
	from mpedido 
	WHERE  tEstadoPedido='03'  and (tTurno = @tTurno or MPEDIDO.tTurnoAnulado = @tTurno)
	and tcodigopedido not in (select distinct tcodigopedido from dpedido where tTurno = @tTurno ) 
	and tcodigopedido not in (select distinct tcodigopedido from apedido where tTurno = @tTurno ) 

end

-- Pedidos Anulados
if @lFlag2 = 1
Begin
if @tTurno = ''
	Insert into #DBTRANS
	SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, dbo.DPEDIDO.nCantidad, dbo.DPEDIDO.nVenta, dbo.DPEDIDO.tEstadoItem, '' as tDocumento, dbo.MPEDIDO.fregAnulado, dbo.DPEDIDO.lImprime, dbo.MPEDIDO.tMotivoAnulacion, Dbo.MPEDIDO.tobservacionAnulado, dbo.MPEDIDO.tusuarioAnulado, dbo.MPEDIDO.fregAnulado, dbo.MPEDIDO.tTurnoAnulado, dbo.DPEDIDO.fRegistro
	FROM   dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido 
	WHERE     (dbo.DPEDIDO.tEstadoItem <> 'N')  and ((MPEDIDO.fRegistro >= @fInicio and MPEDIDO.fRegistro<= @fFinal)  or (MPEDIDO.fRegAnulado >= @fInicio and MPEDIDO.fRegAnulado<= @fFinal))
else

	Insert into #DBTRANS
	SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, dbo.DPEDIDO.nCantidad, dbo.DPEDIDO.nVenta, dbo.DPEDIDO.tEstadoItem, '' as tDocumento, dbo.MPEDIDO.fregAnulado, dbo.DPEDIDO.lImprime, dbo.MPEDIDO.tMotivoAnulacion, Dbo.MPEDIDO.tobservacionAnulado, dbo.MPEDIDO.tusuarioAnulado, dbo.MPEDIDO.fregAnulado, dbo.MPEDIDO.tTurnoAnulado , dbo.DPEDIDO.fRegistro
	FROM   dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido 
	WHERE     (dbo.DPEDIDO.tEstadoItem <> 'N') and (tTurno = @tTurno or MPEDIDO.tTurnoAnulado = @tTurno)
end

-- Items Anulados
if @lFlag2 = 1
Begin
if @tTurno = ''
	Insert into #DBTRANS
	SELECT dbo.APEDIDO.tCodigoPedido, dbo.APEDIDO.tItem, dbo.APEDIDO.tCodigoProducto, dbo.APEDIDO.nCantidad, dbo.APEDIDO.nVenta, 'A' AS tEstadoItem, '' as tDocumento, dbo.APEDIDO.fRegistroAnulado, dbo.APEDIDO.lImprime, dbo.APEDIDO.tMotivoEliminacion, dbo.APEDIDO.tObservacionAnulado, dbo.APEDIDO.tUsuarioAnulado, dbo.APEDIDO.fRegistroAnulado, dbo.APEDIDO.tTurnoAnulado, dbo.APEDIDO.fRegistro
	FROM   dbo.MPEDIDO INNER JOIN dbo.APEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.APEDIDO.tCodigoPedido 
	where   (MPEDIDO.fRegistro >= @fInicio and MPEDIDO.fRegistro<= @fFinal) or (APEDIDO.fRegistroAnulado >= @fInicio and APEDIDO.fRegistroAnulado <= @fFinal)
else
	Insert into #DBTRANS
	SELECT dbo.APEDIDO.tCodigoPedido, dbo.APEDIDO.tItem, dbo.APEDIDO.tCodigoProducto, dbo.APEDIDO.nCantidad, dbo.APEDIDO.nVenta, 'A' AS tEstadoItem, '' as tDocumento, dbo.APEDIDO.fRegistroAnulado, dbo.APEDIDO.lImprime, dbo.APEDIDO.tMotivoEliminacion, dbo.APEDIDO.tObservacionAnulado, dbo.APEDIDO.tUsuarioAnulado, dbo.APEDIDO.fRegistroAnulado, dbo.APEDIDO.tTurnoAnulado, dbo.APEDIDO.fRegistro
	FROM   dbo.MPEDIDO INNER JOIN dbo.APEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.APEDIDO.tCodigoPedido 
	Where  MPEDIDO.tTurno = @tTurno or APEDIDO.tTurnoAnulado = @tTurno
end

-- Items Transferidos
if @lFlag3 = 1
Begin
if @tTurno = ''
	Insert into #DBTRANS
	SELECT  dbo.MPEDIDO.tCodigoPedido, dbo.TPEDIDO.tItemIni, dbo.TPEDIDO.tProducto, dbo.TPEDIDO.nCantidad, dbo.TPEDIDO.nVenta, 'T' AS tEstadoItem,  '' as tDocumento, dbo.TPEDIDO.fRegistro, 1, '000' as tMotivoEliminacion, 'Transferencia al Pedido ' + dbo.TPEDIDO.tPedidoFin AS tobservacionAnulado, dbo.TPEDIDO.tUsuario AS tusuarioAnulado, '' AS fregAnulado, TPEDIDO.tTurno, dbo.MPEDIDO.fRegistro
	FROM dbo.MPEDIDO INNER JOIN dbo.TPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.TPEDIDO.tPedidoIni
	where   (MPEDIDO.fRegistro >= @fInicio and MPEDIDO.fRegistro<= @fFinal) OR (TPEDIDO.fRegistro >= @fInicio and TPEDIDO.fRegistro<= @fFinal)
else
	Insert into #DBTRANS
	SELECT  dbo.MPEDIDO.tCodigoPedido, dbo.TPEDIDO.tItemIni, dbo.TPEDIDO.tProducto, dbo.TPEDIDO.nCantidad, dbo.TPEDIDO.nVenta, 'T' AS tEstadoItem,  '' as tDocumento, dbo.TPEDIDO.fRegistro, 1, '000' as tMotivoEliminacion, 'Transferencia al Pedido ' + dbo.TPEDIDO.tPedidoFin AS tobservacionAnulado, dbo.TPEDIDO.tUsuario AS tusuarioAnulado, '' AS fregAnulado, TPEDIDO.tTurno, dbo.MPEDIDO.fRegistro
	FROM dbo.MPEDIDO INNER JOIN dbo.TPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.TPEDIDO.tPedidoIni
	Where MPEDIDO.tTurno = @tTurno or TPEDIDO.tTurno = @tTurno
end

		end

		set @contadias=@contaDias+1
	end 

 
--Pedidos
SELECT     dbo.MPEDIDO.tCodigoPedido, dbo.MPEDIDO.tEstadoPedido, dbo.vEstadoPedido.Descripcion AS EstadoPedido, 
                   dbo.MPEDIDO.fRegistro, dbo.MPEDIDO.tUsuario, dbo.MPEDIDO.tCaja, dbo.MPEDIDO.tTurno, dbo.MPEDIDO.fregAnulado, 
                   dbo.MPEDIDO.tusuarioAnulado, dbo.MPEDIDO.tTurnoAnulado, dbo.MPEDIDO.tMotivoAnulacion, vMotivoEliminacion_2.Descripcion AS MotivoAnulacion,
                   dbo.MPEDIDO.tobservacionAnulado, #DBTRANS.tItem, #DBTRANS.nCantidad, #DBTRANS.nVenta, #DBTRANS.tEstadoItem, 
                   #DBTRANS.fRegistro AS ItemRegistro, #DBTRANS.lImprime, #DBTRANS.tMotivoAnulacion AS ItemtMotivoAnulacion, 
                   #DBTRANS.tObservacionAnulado AS ItemObservacionAnulacion, #DBTRANS.tUsuarioAnulado AS ItemtUsuarioAnulado, 
                   #DBTRANS.fRegAnulado AS ItemfRegAnulado, #DBTRANS.tTurno AS tItemTurno, dbo.vProducto.Descripcion AS Producto, 
                   vMotivoEliminacion_1.Descripcion AS ItemMotivoEliminacion, #DBTRANS.tDocumento, tDocumento, dbo.MPEDIDO.tSalon, dbo.vSalon.Descripcion AS Salon, 
                   dbo.TMESA.tDetallado AS Mesa, #DBTRANS.fFechaItem
FROM         dbo.TMESA RIGHT OUTER JOIN
                   dbo.MPEDIDO ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN
                   dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN
                   dbo.vMotivoEliminacion vMotivoEliminacion_2 ON dbo.MPEDIDO.tMotivoAnulacion = vMotivoEliminacion_2.Codigo LEFT OUTER JOIN
                   dbo.vEstadoPedido ON dbo.MPEDIDO.tEstadoPedido = dbo.vEstadoPedido.Codigo RIGHT OUTER JOIN
                   dbo.vMotivoEliminacion vMotivoEliminacion_1 RIGHT OUTER JOIN
                   #DBTRANS ON vMotivoEliminacion_1.Codigo = #DBTRANS.tMotivoAnulacion LEFT OUTER JOIN
                   dbo.vProducto ON #DBTRANS.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = #DBTRANS.tCodigoPedido
ORDER BY dbo.MPEDIDO.tCodigoPedido, #DBTRANS.tEstadoItem, #DBTRANS.tItem



end 

 
end


GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE spRep_Diferencia
@tTurno as nVarChar(10),
@fInicio as smalldatetime,
@fFinal as smalldatetime

AS BEGIN
set nocount on

CREATE TABLE #DBTRANS (
	tTipo nVarChar(10)	collate Modern_Spanish_CI_AS,
	tDocumento nVarchar(20)	collate Modern_Spanish_CI_AS,
	tItem nVarchar(3)	collate Modern_Spanish_CI_AS,
	tCodigoProducto nVarChar(7)	collate Modern_Spanish_CI_AS,
	nCantidad float, nVenta float, 
	tRelacion nVarChar(15)	collate Modern_Spanish_CI_AS,
	fRegistro smalldatetime, 
	tUsuario nVarChar(15)	collate Modern_Spanish_CI_AS,
	tTurno nVarChar(10)	collate Modern_Spanish_CI_AS,
	nPaloteo float, xVenta float)

declare @nPaloteo as float
declare @nVenta as float

IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'[dbo].[diferenciaPedidos]') AND type in (N'U'))
DROP TABLE [dbo].[diferenciaPedidos]

IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'[dbo].[diferenciaDocumentos]') AND type in (N'U'))
DROP TABLE [dbo].[diferenciaDocumentos]

 

if @tTurno=''
	begin
	select dbo.DDOCUMENTO.tcodigopedido+dbo.DDOCUMENTO.tItem as titem into diferenciaDocumentos
	FROM dbo.MDOCUMENTO INNER JOIN dbo.DDOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DDOCUMENTO.tDocumento
	where tTipoDocumento<>'00' and tEstadodocumento<>'04' and MDOCUMENTO.fRegistro >=@fInicio and MDOCUMENTO.fRegistro <=@fFinal	


	select DPEDIDO.tcodigopedido+dPEDIDO.titem  as titem into diferenciaPedidos
	FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido
	where tEstadoPedido<>'03' and tFacturado='P' and MPEDIDO.fRegistro >=@fInicio and MPEDIDO.fRegistro <=@fFinal

	end
else
	begin
	select dbo.DDOCUMENTO.tcodigopedido+dbo.DDOCUMENTO.tItem as titem into diferenciaDocumentos
	FROM dbo.MDOCUMENTO INNER JOIN dbo.DDOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DDOCUMENTO.tDocumento
	where tTipoDocumento<>'00' and tEstadodocumento<>'04' and MDOCUMENTO.tTurno=@tTurno

	select DPEDIDO.tcodigopedido+dPEDIDO.titem as titem into diferenciaPedidos
	FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido
	where tEstadoPedido<>'03' and MPEDIDO.tTurno=@tTurno

	end 


print'1'
-- Paloteo de Ventas
if @tTurno = ''
set @nPaloteo = 	(select sum(NVENTA)
 			FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido
			where tEstadoPedido<>'03' and tFacturado='P' and MPEDIDO.fRegistro >=@fInicio and MPEDIDO.fRegistro <=@fFinal)
else
set @nPaloteo = 	(select sum(NVENTA)
 			FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido
			where tEstadoPedido<>'03' and tFacturado='P' and MPEDIDO.tTurno=@tTurno)

-- Liquidacin de Cajero (ojo con los descuentos)
print'2'
if @tTurno = ''
set @nVenta =		(select sum(ddocumento.NVENTA)
			FROM dbo.MDOCUMENTO INNER JOIN dbo.DDOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DDOCUMENTO.tDocumento
			where tTipoDocumento<>'00' and tEstadodocumento<>'04' and MDOCUMENTO.fRegistro >=@fInicio and MDOCUMENTO.fRegistro <=@fFinal)
else
set @nVenta =		(select sum(ddocumento.NVENTA)
			FROM dbo.MDOCUMENTO INNER JOIN dbo.DDOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DDOCUMENTO.tDocumento
			where tTipoDocumento<>'00' and tEstadodocumento<>'04' and MDOCUMENTO.tTurno=@tTurno)
print'3'

-- Pedidos vs facturado
if @tTurno = ''
	insert into #DBTRANS
	SELECT 'Paloteo', dbo.MPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, dbo.DPEDIDO.nCantidad, dbo.DPEDIDO.nVenta, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fRegistro, dbo.MPEDIDO.tUsuario, dbo.MPEDIDO.tTurno, @nPaloteo, @nVenta
	FROM   dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido
	where tEstadoPedido<>'03' and tFacturado='P' and MPEDIDO.fRegistro >=@fInicio and MPEDIDO.fRegistro <=@fFinal
	and dbo.dpedido.tCodigoPedido+dbo.dpedido.tItem not in 
	( 
	select titem
	FROM dbo.diferenciaDocumentos  
	)
else
	insert into #DBTRANS
	SELECT 'Paloteo', dbo.MPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, dbo.DPEDIDO.nCantidad, dbo.DPEDIDO.nVenta, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fRegistro, dbo.MPEDIDO.tUsuario, dbo.MPEDIDO.tTurno, @nPaloteo, @nVenta
	FROM   dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido
	where tEstadoPedido<>'03' and tFacturado='P' and MPEDIDO.tTurno=@tTurno
	and dbo.dpedido.tCodigoPedido+dbo.dpedido.tItem not in 
	( 
	select titem
	FROM dbo.diferenciaDocumentos  
	)
print'4'
-- Facturado vs Pedidos
if @tTurno = ''
	insert into #DBTRANS
	SELECT   'Venta',  dbo.DDOCUMENTO.tDocumento, dbo.DDOCUMENTO.tItem, dbo.DDOCUMENTO.tCodigoProducto, dbo.DDOCUMENTO.nCantidad,  dbo.DDOCUMENTO.nVenta,  dbo.DDOCUMENTO.tCodigoPedido, dbo.MDOCUMENTO.fRegistro, dbo.MDOCUMENTO.tUsuario, dbo.MDOCUMENTO.tTurno, @nPaloteo, @nVenta
	FROM      dbo.MDOCUMENTO INNER JOIN   dbo.DDOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DDOCUMENTO.tDocumento INNER JOIN dbo.MPEDIDO ON dbo.DDOCUMENTO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido
	where tTipoDocumento<>'00' and tEstadodocumento<>'04' and MDOCUMENTO.fRegistro >=@fInicio and MDOCUMENTO.fRegistro <=@fFinal
	and dbo.DDOCUMENTO.tCodigoPedido+dbo.DDOCUMENTO.titem not in 
	(
	select titem
	FROM dbo.diferenciaPedidos  
	) 
else
	insert into #DBTRANS
	SELECT   'Venta',  dbo.DDOCUMENTO.tDocumento, dbo.DDOCUMENTO.tItem, dbo.DDOCUMENTO.tCodigoProducto, dbo.DDOCUMENTO.nCantidad,  dbo.DDOCUMENTO.nVenta,  dbo.DDOCUMENTO.tCodigoPedido, dbo.MDOCUMENTO.fRegistro, dbo.MDOCUMENTO.tUsuario, dbo.MDOCUMENTO.tTurno, @nPaloteo, @nVenta
	FROM      dbo.MDOCUMENTO INNER JOIN   dbo.DDOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DDOCUMENTO.tDocumento INNER JOIN dbo.MPEDIDO ON dbo.DDOCUMENTO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido
	where tTipoDocumento<>'00' and tEstadodocumento<>'04' and MDOCUMENTO.tTurno=@tTurno
	and dbo.DDOCUMENTO.tCodigoPedido+dbo.DDOCUMENTO.titem not in 
	(
	select titem
	FROM dbo.diferenciaPedidos  
	) 

SELECT     #DBTRANS.tTipo, #DBTRANS.tDocumento, #DBTRANS.tItem, #DBTRANS.tCodigoProducto, #DBTRANS.nCantidad, 
                   #DBTRANS.nVenta, #DBTRANS.tRelacion, #DBTRANS.fRegistro, #DBTRANS.tUsuario, #DBTRANS.tTurno, #DBTRANS.nPaloteo, #DBTRANS.xVenta, dbo.vProducto.tResumido AS Producto
FROM         #DBTRANS INNER JOIN
                    dbo.vProducto ON #DBTRANS.tCodigoProducto = dbo.vProducto.Codigo                     
Order by tTipo, tDocumento, tItem

END
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE [dbo].[spRep_Rotacion]  
@fInicio as smalldatetime,
@fFinal as smalldatetime

AS BEGIN
set nocount on

CREATE TABLE #DBTRANS (
      tMesa nVarChar(3) collate Modern_Spanish_CI_AS,
      nVeces float, nVenta float, nPax float, nAsociado float)

INSERT INTO  #DBTRANS 
SELECT tCodigoMesa, 0, 0, 0, 0 from TMESA where lActivo=1

UPDATE #DBTRANS set nVeces = T1.Veces, nVenta = T1.nVentas, nPax= T1.nPaxs
FROM #DBTRANS, 
(SELECT dbo.MPEDIDO.tMesa, COUNT(dbo.MPEDIDO.tCodigoPedido) AS Veces, isnull(SUM(A.nVenta),0) AS nVentas,   SUM(dbo.MPEDIDO.nAdulto) AS nPaxs
FROM   dbo.MPEDIDO LEFT OUTER JOIN (
      SELECT MAX(tCodigoPedido) AS tCodigoPedido, SUM(nVenta) AS nVenta
            FROM dbo.dpedido
            WHERE tEstadoItem = 'N' AND DPEDIDO.fRegistro >= @finicio AND DPEDIDO.fRegistro <= @fFinal
            GROUP BY dbo.dpedido.tCodigoPedido
) A ON A.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido  left  OUTER join TCANALVENTA  on MPEDIDO.tTipoPedido=TCANALVENTA.tCodigoCanalVenta
WHERE  (ISNULL(dbo.MPEDIDO.tMesa, '') <> '') AND isnull(TCANALVENTA.lobligamesa,0)=1   AND (dbo.MPEDIDO.fRegistro >= @fInicio AND dbo.MPEDIDO.fRegistro <= @fFinal)
GROUP BY dbo.MPEDIDO.tMesa) T1
where #DBTRANS.tMesa = T1.tMesa

UPDATE #DBTRANS set nAsociado = T1.Asociado
FROM #DBTRANS, 
(SELECT dbo.TPEDIDOMESA.tMesa, count(dbo.TPEDIDOMESA.tMesa) as Asociado
FROM   dbo.MPEDIDO INNER JOIN dbo.TPEDIDOMESA ON dbo.MPEDIDO.tCodigoPedido = dbo.TPEDIDOMESA.tCodigoPedido left  OUTER join TCANALVENTA on MPEDIDO.tTipoPedido=TCANALVENTA.tCodigoCanalVenta
WHERE  (dbo.MPEDIDO.tEstadoPedido <> '03') AND isnull(TCANALVENTA.lobligamesa,0)=1 AND (dbo.MPEDIDO.fRegistro >= @fInicio AND dbo.MPEDIDO.fRegistro <= @fFinal)
GROUP BY dbo.TPEDIDOMESA.tMesa) T1
where #DBTRANS.tMesa = T1.tMesa



SELECT     dbo.vLocal.Descripcion AS Local, dbo.vSalon.Descripcion AS Salon, dbo.TMESA.nPersona as nPersonal, dbo.TMESA.tDetallado AS Mesa, nVeces, nVenta, nPax, nAsociado
FROM         dbo.TMESA INNER JOIN  #DBTRANS ON dbo.TMESA.tCodigoMesa = #DBTRANS.tMesa LEFT OUTER JOIN
                      dbo.vSalon ON dbo.TMESA.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN
                      dbo.vLocal ON dbo.vSalon.tLocal = dbo.vLocal.Codigo


END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE [dbo].[spRep_Ocupabilidad]
@fInicio as smalldatetime,
@fFinal as smalldatetime,
@nHora as int

AS BEGIN
set nocount on

DECLARE @nContador as int
DECLARE @nOrden as int
DECLARE @sHora as nvarchar(5)
DECLARE @nMesa as int
DECLARE @nSilla as int
DECLARE @nDia as int
DECLARE @nHoraInicial as int



CREATE TABLE #DBTRANS 	(
	Orden Int, 
	Hora nvarchar(20) collate Modern_Spanish_CI_AS, 
	Mesa nVarchar(4) collate Modern_Spanish_CI_AS, 
	Adicional float, Adulto float, Nino float, Venta float, tMesa float, tAdulto float,  nDias float, 
	tCodigoPedido nvarchar(10)	collate Modern_Spanish_CI_AS, 
	dMesa nvarchar(50)	collate Modern_Spanish_CI_AS, 
	FechaInicial smalldatetime, FechaFinal smalldatetime,
	local nvarchar(250) collate Modern_Spanish_CI_AS, 
	Salon nvarchar(250) collate Modern_Spanish_CI_AS )

SELECT 	MPEDIDO.tCodigoPedido, max(MPEDIDO.fregistro) as Inicio, max(MDOCUMENTO.fregistro) as Final, max(tMesa) as Mesa, max(nMesa) as nMesa, max(nAdulto) as Adulto, 
		max(nNino) as Nino, sum(DPEDIDO.nVenta) as Venta, dbo.TMESA.tDetallado as dMesa , dbo.vSalon.Local AS [Local], dbo.vSalon.Descripcion as Salon

into #TEMPORAL
FROM  dbo.vSalon INNER JOIN  dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon RIGHT OUTER JOIN dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN 
(SELECT dbo.TPEDIDOMESA.tCodigoPedido, COUNT(dbo.TPEDIDOMESA.tMesa) AS nAdicional FROM dbo.MPEDIDO INNER JOIN dbo.TPEDIDOMESA ON dbo.MPEDIDO.tCodigoPedido = dbo.TPEDIDOMESA.tCodigoPedido
WHERE  (ISNULL(dbo.MPEDIDO.tMesa, '') <> '') AND dbo.MPEDIDO.tEstadoPedido <> '03'  AND (dbo.MPEDIDO.fRegistro >= @fInicio AND dbo.MPEDIDO.fRegistro <= @fFinal)
GROUP BY dbo.TPEDIDOMESA.tCodigoPedido) T1 ON dbo.MPEDIDO.tCodigoPedido = T1.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa
WHERE  (ISNULL(dbo.MPEDIDO.tMesa, '') <> '') AND dbo.MPEDIDO.tEstadoPedido <> '03'  AND (dbo.MPEDIDO.fRegistro >= @fInicio AND dbo.MPEDIDO.fRegistro <= @fFinal)
Group by MPEDIDO.tCodigoPedido, dbo.TMESA.tDetallado, dbo.vSalon.Local , dbo.vSalon.Descripcion

SET @nContador=1
SET @nOrden = (@nHora * 2) + 1
SELECT @nMesa = count(tCodigoMesa) from TMESA where lActivo=1 and tcodigoMesa<>'000'
SELECT @nSilla = sum(nPersona) from TMESA where lActivo=1 and tcodigoMesa<>'000'

WHILE @nContador <= 48
BEGIN	
	SET @nHoraInicial = (@nContador -1 )  * 30

	IF @nContador % 2 = 0	

		BEGIN	
			IF @nContador < 20
				SET @sHora = '0' + LTrim(Str  ( (@nContador/2) -1)  ) + ':30'
			ELSE
				SET @sHora =   LTrim(Str  ( (@nContador/2) -1)  ) + ':30'
		END

	ELSE	
		BEGIN
			IF @nContador < 20
				SET @sHora = '0' + LTrim(Str((@nContador-1)/2)) + ':00'
			ELSE
				SET @sHora =  LTrim(Str((@nContador-1)/2)) + ':00'
		END		


	SELECT @nDia = DATEDIFF ( dd , @fInicio, @fFinal ) 

	IF @nDia = 0 SET @nDia = 1

	INSERT INTO #DBTRANS (Orden, Hora, Mesa, Adicional, Adulto, Nino, Venta, tMesa, tAdulto, nDias, tCodigoPedido, dMesa, FechaInicial, FechaFinal,[local],Salon) 
	select @nOrden, @sHora,  1 as Mesa,  isnull(nMesa,0) as Adicional, isnull(Adulto,0), isnull(Nino,0), isnull(Venta,0), @nMesa, @nSilla, @nDia, tCodigoPedido, dMesa, Inicio, Final,[local],Salon 
	from #TEMPORAL
	Where (DatePart(hh, Inicio) * 60 + DatePart(mi, Inicio) <= @nHoraInicial And DatePart(hh, Final) * 60 + DatePart(mi, Final) >= @nHoraInicial) or 
	(DatePart(hh, Inicio) * 60 + DatePart(mi, Inicio) >= @nHoraInicial And DatePart(hh, Final) * 60 + DatePart(mi, Final) >= @nHoraInicial and datepart(dayofyear,inicio)+1 = datepart(dayofyear,final)) or 
	(DatePart(hh, Inicio) * 60 + DatePart(mi, Inicio) >= @nHoraInicial And DatePart(hh, Final) * 60 + DatePart(mi, Final) <= @nHoraInicial + 30 and datepart(dayofyear,inicio) = datepart(dayofyear,final))

	IF @nOrden = 48 
		SET @nOrden = 1
	ELSE
		SET @nOrden = @nOrden + 1
	

	SET @nContador = @nContador + 1	

END
select *  from #DBTRANS

END


GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

CREATE Proc usp_InforestAdm_ObtenerPrropiedadesReporte
AS
SELECT 
	dbo.vProducto.tTipoProducto,
	dbo.vProducto.tGrupo,
	UPPER(dbo.vProducto.Grupo) AS 'ProdGrupo', 
	dbo.vProducto.tSubGrupo,
	UPPER(dbo.vProducto.SubGrupo) AS 'ProdSubGrupo', 
	UPPER(dbo.vProducto.Descripcion) AS 'Producto', 
	dbo.TPROPIEDAD.tCodigoPropiedad AS 'PropCodigo', 
	UPPER(dbo.vOperador.Descripcion + ' ' + dbo.TPROPIEDAD.tDetallado) AS Descripcion, 
	dbo.TPROPIEDAD.nPrecio AS 'PropPrecio', 
	Case isnull(dbo.vOperador.lValor,0) When 1 Then 'Si' Else 'No' End AS 'ValorVenta', 
	Case isnull(dbo.vOperador.lStockMas,0) When 1 Then 'Si' Else 'No' End AS 'OpelStockMas', 
	Case isnull(dbo.vOperador.lStockMenos,0) When 1 Then 'Si' Else 'No' End AS 'OpelStockMenos', 
	dbo.vOperador.nBoton AS 'OpeBoton', 
	dbo.vOperador.nControl AS 'OpePropConcurrentes', 
	Case isnull(dbo.vOperador.lImprime,0) When 1 Then 'Si' Else 'No' End AS 'OpeVisibleDoc',
	dbo.vProducto.lActivo,
	Case isnull(dbo.vOperador.lObligaPropiedad,0) When 1 Then 'Si' Else 'No' End AS 'lObligaPropiedad'
FROM 
	dbo.TPROPIEDAD 
	INNER JOIN dbo.vOperador ON dbo.TPROPIEDAD.tOperador = dbo.vOperador.Codigo 
	LEFT OUTER JOIN dbo.vProducto ON dbo.TPROPIEDAD.tProducto = dbo.vProducto.Codigo 
Order By 
	dbo.vProducto.Grupo, 
	dbo.vProducto.SubGrupo, 
	dbo.vProducto.Descripcion, 
	dbo.vOperador.Descripcion + ' ' + dbo.TPROPIEDAD.tDetallado


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

CREATE proc usp_InforestAdm_ObtenerOfertasReporte  
AS  

SET NOCOUNT ON
Declare @Oferta Table (
	tOferta		nvarchar(5) 	collate Modern_Spanish_CI_AS,
	tNombre		nvarchar(50) 	collate Modern_Spanish_CI_AS,
	tGrupo		nvarchar(50) 	collate Modern_Spanish_CI_AS,
	Grupo		nvarchar(50) 	collate Modern_Spanish_CI_AS,
	tSubGrupo	nvarchar(50) 	collate Modern_Spanish_CI_AS,
	SubGrupo	nvarchar(50) 	collate Modern_Spanish_CI_AS,
	Producto	nvarchar(3655) 	collate Modern_Spanish_CI_AS,
	tFrecuencia	nvarchar(2) 	collate Modern_Spanish_CI_AS,
	Frecuencia	nvarchar(50) 	collate Modern_Spanish_CI_AS,
	fFecha		smalldatetime,
	tHoraInicial	nvarchar(5) 	collate Modern_Spanish_CI_AS,
	tHoraFinal	nvarchar(5) 	collate Modern_Spanish_CI_AS,
	lAcumulable	bit,
	nRatio		float,
	nMonto		float,
	lPermanente	nvarchar(2) 	collate Modern_Spanish_CI_AS,
	fFechaInicial	smalldatetime,
	fFechaFinal	smalldatetime,
	lActivo		nvarchar(2) 	collate Modern_Spanish_CI_AS,
	lLocal		nvarchar(2) 	collate Modern_Spanish_CI_AS,
	lDelivery	nvarchar(2) 	collate Modern_Spanish_CI_AS,
	lLlevar		nvarchar(2) 	collate Modern_Spanish_CI_AS,
	lCanal4		nvarchar(2) 	collate Modern_Spanish_CI_AS,
	lCanal5		nvarchar(2) 	collate Modern_Spanish_CI_AS)

Insert Into @Oferta
SELECT   
 	dbo.TOFERTA.tOferta,   
 	dbo.TOFERTA.tNombre,   
	dbo.vProducto.tGrupo,  
	dbo.vProducto.Grupo,   
	dbo.vProducto.tSubGrupo, 
	dbo.vProducto.SubGrupo,   
	'' AS Producto,--dbo.vProducto.Descripcion AS Producto,   
	dbo.TOFERTA.tFrecuencia,   
	dbo.vFrecuencia.Descripcion AS Frecuencia,   
	dbo.TOFERTA.fFecha,  
	dbo.TOFERTA.tHoraInicial,   
	dbo.TOFERTA.tHoraFinal,   
	dbo.TOFERTA.lAcumulable,   
	dbo.TOFERTA.nRatio,   
	dbo.TOFERTA.nMonto,   
	Case When dbo.TOFERTA.lPermanente = 0 Then 'No' else 'Si' end lPermanente,   
	CONVERT(NVARCHAR,dbo.TOFERTA.fFechaInicial,10) fFechaInicial,   
	CONVERT(NVARCHAR,dbo.TOFERTA.fFechaFinal,10) fFechaFinal,   
	Case When dbo.TOFERTA.lActivo = 0 Then 'No' else 'Si' end lActivo,   
	Case When dbo.TOFERTA.lLocal = 0 Then 'No' else 'Si' end lLocal,   
	Case When dbo.TOFERTA.lDelivery = 0 Then 'No' else 'Si' end lDelivery,   
	Case When dbo.TOFERTA.lLlevar = 0 Then 'No' else 'Si' end lLlevar,  
	Case When dbo.TOFERTA.lCanal4 = 0 Then 'No' else 'Si' end lCanal4,   
	Case When dbo.TOFERTA.lCanal5 = 0 Then 'No' else 'Si' end lCanal5   
FROM   
	dbo.TOFERTA   
	INNER JOIN dbo.vProducto ON dbo.TOFERTA.tCodigoProducto = dbo.vProducto.Codigo   
	LEFT OUTER JOIN dbo.vFrecuencia ON dbo.TOFERTA.tFrecuencia = dbo.vFrecuencia.Codigo  
Group By  	dbo.TOFERTA.tOferta,   
 	dbo.TOFERTA.tNombre, 
	dbo.vProducto.tGrupo, 
	dbo.vProducto.Grupo,   
	dbo.vProducto.tSubGrupo,   
	dbo.vProducto.SubGrupo,   
	dbo.TOFERTA.tFrecuencia,   
	dbo.vFrecuencia.Descripcion,
	dbo.TOFERTA.fFecha,  
	dbo.TOFERTA.tHoraInicial,   
	dbo.TOFERTA.tHoraFinal,   
	dbo.TOFERTA.lAcumulable,   
	dbo.TOFERTA.nRatio,   
	dbo.TOFERTA.nMonto,   
	dbo.TOFERTA.lPermanente,
	dbo.TOFERTA.fFechaInicial,
	dbo.TOFERTA.fFechaFinal,
	dbo.TOFERTA.lActivo,
	dbo.TOFERTA.lLocal,
	dbo.TOFERTA.lDelivery,
	dbo.TOFERTA.lLlevar,
	dbo.TOFERTA.lCanal4,
	dbo.TOFERTA.lCanal5 
Order by   
	tNombre

declare @tOferta as nvarchar(7)
declare	@tGrupo as nvarchar(2)
declare	@tSubGrupo as nvarchar(4)

declare CURSOR1 cursor for
Select tOferta, tGrupo, tSubGrupo from @Oferta
Open CURSOR1
fetch next from CURSOR1
into @tOferta, @tGrupo, @tSubGrupo
While @@fetch_status = 0
begin
	----------------------------
	Declare @Producto as nvarchar(50)
	
	Declare CURSOR2 cursor for	
	SELECT  dbo.vProducto.Descripcion 
	FROM   
		dbo.TOFERTA   
		INNER JOIN dbo.vProducto ON dbo.TOFERTA.tCodigoProducto = dbo.vProducto.Codigo
	Where 
		dbo.TOFERTA.tOferta = @tOferta And dbo.vProducto.tGrupo = @tGrupo And dbo.vProducto.tSubGrupo = @tSubGrupo
	Open CURSOR2
	fetch next from CURSOR2
	into @Producto
	While @@fetch_status = 0
	begin
		--Print @tOferta+'-'+@tGrupo+'-'+@tSubGrupo+'-'+@Producto
		Update @Oferta
		Set Producto = Producto + '(' + @Producto + ')'
		Where tOferta = @tOferta And tGrupo = @tGrupo And tSubGrupo = @tSubGrupo

		fetch next from CURSOR2
		into @Producto
	end
	close CURSOR2
	deallocate CURSOR2
	-----------------------------
	fetch next from CURSOR1
	into @tOferta, @tGrupo, @tSubGrupo
end
close CURSOR1
deallocate CURSOR1
Select * from @Oferta

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

CREATE Proc [dbo].[usp_InforestAdm_ObtenerProductosReporteLocal]
@tcodigoCanal as nvarchar(3)

as
SET NOCOUNT ON
Declare @xProductos TABLE
	( Codigo	nvarchar(7)	collate Modern_Spanish_CI_AS,
	tTipoProducto	nvarchar(2)	collate Modern_Spanish_CI_AS,
 	TipoProducto	nvarchar(50)	collate Modern_Spanish_CI_AS,
	Descripcion	nvarchar(50)	collate Modern_Spanish_CI_AS,
	tResumido	nvarchar(24)	collate Modern_Spanish_CI_AS,
	tSubGrupo	nvarchar(4)	collate Modern_Spanish_CI_AS,
	SubGrupo	nvarchar(50)	collate Modern_Spanish_CI_AS,
	lActivo		nvarchar(2)	collate Modern_Spanish_CI_AS,
	nNetoSalon	float,
	nImpuesto1	float,
	nImpuesto2	float,
	nImpuesto3	float,
	nPrecioVenta	float,
	lImprimeArea	nvarchar(2)	collate Modern_Spanish_CI_AS,
	tGrupo		nvarchar(2)	collate Modern_Spanish_CI_AS,
	Grupo		nvarchar(50)	collate Modern_Spanish_CI_AS,
	lModificable	nvarchar(2)	collate Modern_Spanish_CI_AS,
	tDescargo	nvarchar(1)	collate Modern_Spanish_CI_AS,
	Area		nvarchar(50)	collate Modern_Spanish_CI_AS,
	nBoton		Integer,
	nBotonRapido	Integer,
	tCajaRapida	nvarchar(2)	collate Modern_Spanish_CI_AS,
	Moneda		nvarchar(24)	collate Modern_Spanish_CI_AS,
	lPropiedad	nvarchar(2)	collate Modern_Spanish_CI_AS,
	lDescuento	nvarchar(2)	collate Modern_Spanish_CI_AS,
	nCosto		float,
	Combo		nvarchar(50)	collate Modern_Spanish_CI_AS,
	AreaImpresion	nvarchar(200)	collate Modern_Spanish_CI_AS)
	
Declare @Impuesto1 as Float 
Set @Impuesto1 = (Select Top 1 Impuesto1 From TParametro )
Declare @Impuesto2 as Float 
Set @Impuesto2 = (Select Top 1 Impuesto2 From TParametro )
Declare @IMpuesto3 as Float 
Set @IMpuesto3 = (Select Top 1 Impuesto3 From TParametro )




if @tcodigoCanal='01'
begin

Insert Into @xProductos
SELECT   
	dbo.vProducto.Codigo, 
	dbo.vProducto.tTipoProducto,  
	dbo.vProducto.TipoProducto,  
	dbo.vProducto.Descripcion,  
	dbo.vProducto.tResumido, 
	dbo.vProducto.tSubGrupo, 
	dbo.vProducto.SubGrupo,  
 	dbo.vProducto.lActivo as lActivo,  
 	case when lLocal=0 then 0 else nPrecioVenta / nFactorLocal end as nNetoSalon,   
 	case when lLocal=0 then 0 else nPrecioVenta / nFactorLocal * nImpuesto1 / 100 end as nImpuesto1,   
	case when lLocal=0 then 0 else nPrecioVenta / nFactorLocal * nImpuesto2 / 100 end as nImpuesto2,   
	case when lLocal=0 then 0 else nPrecioVenta / nFactorLocal * nImpuesto3 / 100 end as nImpuesto3,   
	case when lLocal=0 then 0 else nPrecioVenta end as nPrecioVenta,   
	Case When dbo.vProducto.lImprimeArea = 0 Then 'No' else 'Si' end as lImprimeArea,  
	dbo.vProducto.tGrupo,
	dbo.vProducto.Grupo,  
	Case When dbo.vProducto.lModificable = 0 Then 'No' else 'Si' end as lModificable,   
	dbo.vProducto.tDescargo,  
	dbo.vProducto.Area,  
	dbo.vProducto.nBoton,  
	dbo.vProducto.nBotonRapido,  
	dbo.vProducto.tCajaRapida,  
	dbo.vProducto.Moneda,  
	Case When dbo.vProducto.lPropiedad = 0 Then 'No' else 'Si' end as lPropiedad,  
	Case When dbo.vProducto.lDescuento = 0 Then 'No' else 'Si' end as lDescuento,  
	isnull(dbo.vProducto.nInsumo,0)+isnull(dbo.vProducto.nGasto,0)+isnull(dbo.vProducto.nManoObra,0),
	ISNULL(T1.tDetallado,'') AS Combo,  
	'' as AreaImpresion
FROM   
 	(SELECT tCodigoProducto, tDetallado FROM TPRODUCTO) T1   
 	RIGHT OUTER JOIN dbo.TCOMBO ON T1.tCodigoProducto = dbo.TCOMBO.tCodigoProducto   
 	RIGHT OUTER JOIN dbo.vProducto ON dbo.TCOMBO.tCombo = dbo.vProducto.Codigo    
 	INNER JOIN (select tCodigoProducto,   
	  			case when lImpuesto1=0 then 0 else @Impuesto1 end as nImpuesto1,   
	  			case when lImpuesto2=0 then 0 else @Impuesto2 end as nImpuesto2,   
	  			case when lImpuesto3=0 then 0 else @Impuesto3 end as nImpuesto3,   
	  			case when lImpuesto4=0 then 0 else @Impuesto1 end as nImpuesto4,   
	  			case when lImpuesto5=0 then 0 else @Impuesto2 end as nImpuesto5,   
	  			case when lImpuesto6=0 then 0 else @Impuesto3 end as nImpuesto6,   
				case when lImpuesto7=0 then 0 else @Impuesto1 end as nImpuesto7,   
				case when lImpuesto8=0 then 0 else @Impuesto2 end as nImpuesto8,   
				case when lImpuesto9=0 then 0 else @Impuesto3 end as nImpuesto9,   
				case when lImpuesto10=0 then 0 else @Impuesto1 end as nImpuesto10,   
				case when lImpuesto11=0 then 0 else @Impuesto2 end as nImpuesto11,   
				case when lImpuesto12=0 then 0 else @Impuesto3 end as nImpuesto12,   
				case when lImpuesto13=0 then 0 else @Impuesto1 end as nImpuesto13,   
				case when lImpuesto14=0 then 0 else @Impuesto2 end as nImpuesto14,   
				case when lImpuesto15=0 then 0 else @Impuesto3 end as nImpuesto15,   
	  			1 + ((case when lImpuesto1=0 then 0 else @Impuesto1 end + case when lImpuesto2 = 0 then 0 else @Impuesto2 end + case when lImpuesto3 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorLocal,   
				1 + ((case when lImpuesto4=0 then 0 else @Impuesto1 end + case when lImpuesto5 = 0 then 0 else @Impuesto2 end + case when lImpuesto6 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorDelivery,  
				1 + ((case when lImpuesto7=0 then 0 else @Impuesto1 end + case when lImpuesto8 = 0 then 0 else @Impuesto2 end + case when lImpuesto9 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorLlevar,   
				1 + ((case when lImpuesto10=0 then 0 else @Impuesto1 end + case when lImpuesto11 = 0 then 0 else @Impuesto2 end + case when lImpuesto12 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorCanal4,  
				1 + ((case when lImpuesto13=0 then 0 else @Impuesto1 end + case when lImpuesto14 = 0 then 0 else @Impuesto2 end + case when lImpuesto15 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorCanal5   
  			from TPRODUCTO) IMPUESTOS ON dbo.vProducto.Codigo = IMPUESTOS.tCodigoProducto  


 --RIGHT JOIN tProductoArea On tProductoArea.tCodigoProducto = vProducto.Codigo  
 --LEFT JOIN vArea on tProductoArea.tArea = vArea.Codigo  
Where   
 dbo.vProducto.Codigo IS NOT NULL   and lLocal=1
 end


if @tcodigoCanal='02'
begin

Insert Into @xProductos
SELECT   
	dbo.vProducto.Codigo, 
	dbo.vProducto.tTipoProducto,  
	dbo.vProducto.TipoProducto,  
	dbo.vProducto.Descripcion,  
	dbo.vProducto.tResumido, 
	dbo.vProducto.tSubGrupo, 
	dbo.vProducto.SubGrupo,  
 	dbo.vProducto.lActivo as lActivo,  
 	case when lDelivery=0 then 0 else nPrecioDelivery / nFactorDelivery end as nNetoSalon,   
 	case when lDelivery=0 then 0 else nPrecioDelivery / nFactorDelivery * nImpuesto1 / 100 end as nImpuesto1,   
	case when lDelivery=0 then 0 else nPrecioDelivery / nFactorDelivery * nImpuesto2 / 100 end as nImpuesto2,   
	case when lDelivery=0 then 0 else nPrecioDelivery / nFactorDelivery * nImpuesto3 / 100 end as nImpuesto3,   
	case when lDelivery=0 then 0 else nPrecioDelivery end as nPrecioVenta,   
	Case When dbo.vProducto.lImprimeArea = 0 Then 'No' else 'Si' end as lImprimeArea,  
	dbo.vProducto.tGrupo,
	dbo.vProducto.Grupo,  
	Case When dbo.vProducto.lModificable = 0 Then 'No' else 'Si' end as lModificable,   
	dbo.vProducto.tDescargo,  
	dbo.vProducto.Area,  
	dbo.vProducto.nBoton,  
	dbo.vProducto.nBotonRapido,  
	dbo.vProducto.tCajaRapida,  
	dbo.vProducto.Moneda,  
	Case When dbo.vProducto.lPropiedad = 0 Then 'No' else 'Si' end as lPropiedad,  
	Case When dbo.vProducto.lDescuento = 0 Then 'No' else 'Si' end as lDescuento,  
	isnull(dbo.vProducto.nInsumo2,0)+isnull(dbo.vProducto.nGasto2,0)+isnull(dbo.vProducto.nManoObra2,0),
	ISNULL(T1.tDetallado,'') AS Combo,  
	'' as AreaImpresion
FROM   
 	(SELECT tCodigoProducto, tDetallado FROM TPRODUCTO) T1   
 	RIGHT OUTER JOIN dbo.TCOMBO ON T1.tCodigoProducto = dbo.TCOMBO.tCodigoProducto   
 	RIGHT OUTER JOIN dbo.vProducto ON dbo.TCOMBO.tCombo = dbo.vProducto.Codigo    
 	INNER JOIN (select tCodigoProducto,   
	  			case when lImpuesto1=0 then 0 else @Impuesto1 end as nImpuesto1,   
	  			case when lImpuesto2=0 then 0 else @Impuesto2 end as nImpuesto2,   
	  			case when lImpuesto3=0 then 0 else @Impuesto3 end as nImpuesto3,   
	  			case when lImpuesto4=0 then 0 else @Impuesto1 end as nImpuesto4,   
	  			case when lImpuesto5=0 then 0 else @Impuesto2 end as nImpuesto5,   
	  			case when lImpuesto6=0 then 0 else @Impuesto3 end as nImpuesto6,   
				case when lImpuesto7=0 then 0 else @Impuesto1 end as nImpuesto7,   
				case when lImpuesto8=0 then 0 else @Impuesto2 end as nImpuesto8,   
				case when lImpuesto9=0 then 0 else @Impuesto3 end as nImpuesto9,   
				case when lImpuesto10=0 then 0 else @Impuesto1 end as nImpuesto10,   
				case when lImpuesto11=0 then 0 else @Impuesto2 end as nImpuesto11,   
				case when lImpuesto12=0 then 0 else @Impuesto3 end as nImpuesto12,   
				case when lImpuesto13=0 then 0 else @Impuesto1 end as nImpuesto13,   
				case when lImpuesto14=0 then 0 else @Impuesto2 end as nImpuesto14,   
				case when lImpuesto15=0 then 0 else @Impuesto3 end as nImpuesto15,   
	  			1 + ((case when lImpuesto1=0 then 0 else @Impuesto1 end + case when lImpuesto2 = 0 then 0 else @Impuesto2 end + case when lImpuesto3 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorLocal,   
				1 + ((case when lImpuesto4=0 then 0 else @Impuesto1 end + case when lImpuesto5 = 0 then 0 else @Impuesto2 end + case when lImpuesto6 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorDelivery,  
				1 + ((case when lImpuesto7=0 then 0 else @Impuesto1 end + case when lImpuesto8 = 0 then 0 else @Impuesto2 end + case when lImpuesto9 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorLlevar,   
				1 + ((case when lImpuesto10=0 then 0 else @Impuesto1 end + case when lImpuesto11 = 0 then 0 else @Impuesto2 end + case when lImpuesto12 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorCanal4,  
				1 + ((case when lImpuesto13=0 then 0 else @Impuesto1 end + case when lImpuesto14 = 0 then 0 else @Impuesto2 end + case when lImpuesto15 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorCanal5   
  			from TPRODUCTO) IMPUESTOS ON dbo.vProducto.Codigo = IMPUESTOS.tCodigoProducto  


 --RIGHT JOIN tProductoArea On tProductoArea.tCodigoProducto = vProducto.Codigo  
 --LEFT JOIN vArea on tProductoArea.tArea = vArea.Codigo  
Where   
 dbo.vProducto.Codigo IS NOT NULL  and lDelivery=1
 end



 
if @tcodigoCanal='03'
begin

Insert Into @xProductos
SELECT   
	dbo.vProducto.Codigo, 
	dbo.vProducto.tTipoProducto,  
	dbo.vProducto.TipoProducto,  
	dbo.vProducto.Descripcion,  
	dbo.vProducto.tResumido, 
	dbo.vProducto.tSubGrupo, 
	dbo.vProducto.SubGrupo,  
 	dbo.vProducto.lActivo as lActivo,  
 	case when lLlevar=0 then 0 else nPrecioLlevar / nFactorLlevar end as nNetoSalon,   
 	case when lLlevar=0 then 0 else nPrecioLlevar / nFactorLlevar * nImpuesto1 / 100 end as nImpuesto1,   
	case when lLlevar=0 then 0 else nPrecioLlevar / nFactorLlevar * nImpuesto2 / 100 end as nImpuesto2,   
	case when lLlevar=0 then 0 else nPrecioLlevar / nFactorLlevar * nImpuesto3 / 100 end as nImpuesto3,   
	case when lLlevar=0 then 0 else nPrecioLlevar end as nPrecioVenta,   
	Case When dbo.vProducto.lImprimeArea = 0 Then 'No' else 'Si' end as lImprimeArea,  
	dbo.vProducto.tGrupo,
	dbo.vProducto.Grupo,  
	Case When dbo.vProducto.lModificable = 0 Then 'No' else 'Si' end as lModificable,   
	dbo.vProducto.tDescargo,  
	dbo.vProducto.Area,  
	dbo.vProducto.nBoton,  
	dbo.vProducto.nBotonRapido,  
	dbo.vProducto.tCajaRapida,  
	dbo.vProducto.Moneda,  
	Case When dbo.vProducto.lPropiedad = 0 Then 'No' else 'Si' end as lPropiedad,  
	Case When dbo.vProducto.lDescuento = 0 Then 'No' else 'Si' end as lDescuento,  
	isnull(dbo.vProducto.nInsumo3,0)+isnull(dbo.vProducto.nGasto3,0)+isnull(dbo.vProducto.nManoObra3,0),
	ISNULL(T1.tDetallado,'') AS Combo,  
	'' as AreaImpresion
FROM   
 	(SELECT tCodigoProducto, tDetallado FROM TPRODUCTO) T1   
 	RIGHT OUTER JOIN dbo.TCOMBO ON T1.tCodigoProducto = dbo.TCOMBO.tCodigoProducto   
 	RIGHT OUTER JOIN dbo.vProducto ON dbo.TCOMBO.tCombo = dbo.vProducto.Codigo    
 	INNER JOIN (select tCodigoProducto,   
	  			case when lImpuesto1=0 then 0 else @Impuesto1 end as nImpuesto1,   
	  			case when lImpuesto2=0 then 0 else @Impuesto2 end as nImpuesto2,   
	  			case when lImpuesto3=0 then 0 else @Impuesto3 end as nImpuesto3,   
	  			case when lImpuesto4=0 then 0 else @Impuesto1 end as nImpuesto4,   
	  			case when lImpuesto5=0 then 0 else @Impuesto2 end as nImpuesto5,   
	  			case when lImpuesto6=0 then 0 else @Impuesto3 end as nImpuesto6,   
				case when lImpuesto7=0 then 0 else @Impuesto1 end as nImpuesto7,   
				case when lImpuesto8=0 then 0 else @Impuesto2 end as nImpuesto8,   
				case when lImpuesto9=0 then 0 else @Impuesto3 end as nImpuesto9,   
				case when lImpuesto10=0 then 0 else @Impuesto1 end as nImpuesto10,   
				case when lImpuesto11=0 then 0 else @Impuesto2 end as nImpuesto11,   
				case when lImpuesto12=0 then 0 else @Impuesto3 end as nImpuesto12,   
				case when lImpuesto13=0 then 0 else @Impuesto1 end as nImpuesto13,   
				case when lImpuesto14=0 then 0 else @Impuesto2 end as nImpuesto14,   
				case when lImpuesto15=0 then 0 else @Impuesto3 end as nImpuesto15,   
	  			1 + ((case when lImpuesto1=0 then 0 else @Impuesto1 end + case when lImpuesto2 = 0 then 0 else @Impuesto2 end + case when lImpuesto3 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorLocal,   
				1 + ((case when lImpuesto4=0 then 0 else @Impuesto1 end + case when lImpuesto5 = 0 then 0 else @Impuesto2 end + case when lImpuesto6 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorDelivery,  
				1 + ((case when lImpuesto7=0 then 0 else @Impuesto1 end + case when lImpuesto8 = 0 then 0 else @Impuesto2 end + case when lImpuesto9 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorLlevar,   
				1 + ((case when lImpuesto10=0 then 0 else @Impuesto1 end + case when lImpuesto11 = 0 then 0 else @Impuesto2 end + case when lImpuesto12 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorCanal4,  
				1 + ((case when lImpuesto13=0 then 0 else @Impuesto1 end + case when lImpuesto14 = 0 then 0 else @Impuesto2 end + case when lImpuesto15 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorCanal5   
  			from TPRODUCTO) IMPUESTOS ON dbo.vProducto.Codigo = IMPUESTOS.tCodigoProducto  


 --RIGHT JOIN tProductoArea On tProductoArea.tCodigoProducto = vProducto.Codigo  
 --LEFT JOIN vArea on tProductoArea.tArea = vArea.Codigo  
Where   
 dbo.vProducto.Codigo IS NOT NULL  and lLlevar=1
 end


 
 
if @tcodigoCanal='04'
begin

Insert Into @xProductos
SELECT   
	dbo.vProducto.Codigo, 
	dbo.vProducto.tTipoProducto,  
	dbo.vProducto.TipoProducto,  
	dbo.vProducto.Descripcion,  
	dbo.vProducto.tResumido, 
	dbo.vProducto.tSubGrupo, 
	dbo.vProducto.SubGrupo,  
 	dbo.vProducto.lActivo as lActivo,  
 	case when lCanal4=0 then 0 else nPrecioCanal4 / nFactorCanal4 end as nNetoSalon,   
 	case when lCanal4=0 then 0 else nPrecioCanal4 / nFactorCanal4 * nImpuesto1 / 100 end as nImpuesto1,   
	case when lCanal4=0 then 0 else nPrecioCanal4 / nFactorCanal4 * nImpuesto2 / 100 end as nImpuesto2,   
	case when lCanal4=0 then 0 else nPrecioCanal4 / nFactorCanal4 * nImpuesto3 / 100 end as nImpuesto3,   
	case when lCanal4=0 then 0 else nPrecioCanal4 end as nPrecioVenta,   
	Case When dbo.vProducto.lImprimeArea = 0 Then 'No' else 'Si' end as lImprimeArea,  
	dbo.vProducto.tGrupo,
	dbo.vProducto.Grupo,  
	Case When dbo.vProducto.lModificable = 0 Then 'No' else 'Si' end as lModificable,   
	dbo.vProducto.tDescargo,  
	dbo.vProducto.Area,  
	dbo.vProducto.nBoton,  
	dbo.vProducto.nBotonRapido,  
	dbo.vProducto.tCajaRapida,  
	dbo.vProducto.Moneda,  
	Case When dbo.vProducto.lPropiedad = 0 Then 'No' else 'Si' end as lPropiedad,  
	Case When dbo.vProducto.lDescuento = 0 Then 'No' else 'Si' end as lDescuento,  
	isnull(dbo.vProducto.nInsumo4,0)+isnull(dbo.vProducto.nGasto4,0)+isnull(dbo.vProducto.nManoObra4,0),
	ISNULL(T1.tDetallado,'') AS Combo,  
	'' as AreaImpresion
FROM   
 	(SELECT tCodigoProducto, tDetallado FROM TPRODUCTO) T1   
 	RIGHT OUTER JOIN dbo.TCOMBO ON T1.tCodigoProducto = dbo.TCOMBO.tCodigoProducto   
 	RIGHT OUTER JOIN dbo.vProducto ON dbo.TCOMBO.tCombo = dbo.vProducto.Codigo    
 	INNER JOIN (select tCodigoProducto,   
	  			case when lImpuesto1=0 then 0 else @Impuesto1 end as nImpuesto1,   
	  			case when lImpuesto2=0 then 0 else @Impuesto2 end as nImpuesto2,   
	  			case when lImpuesto3=0 then 0 else @Impuesto3 end as nImpuesto3,   
	  			case when lImpuesto4=0 then 0 else @Impuesto1 end as nImpuesto4,   
	  			case when lImpuesto5=0 then 0 else @Impuesto2 end as nImpuesto5,   
	  			case when lImpuesto6=0 then 0 else @Impuesto3 end as nImpuesto6,   
				case when lImpuesto7=0 then 0 else @Impuesto1 end as nImpuesto7,   
				case when lImpuesto8=0 then 0 else @Impuesto2 end as nImpuesto8,   
				case when lImpuesto9=0 then 0 else @Impuesto3 end as nImpuesto9,   
				case when lImpuesto10=0 then 0 else @Impuesto1 end as nImpuesto10,   
				case when lImpuesto11=0 then 0 else @Impuesto2 end as nImpuesto11,   
				case when lImpuesto12=0 then 0 else @Impuesto3 end as nImpuesto12,   
				case when lImpuesto13=0 then 0 else @Impuesto1 end as nImpuesto13,   
				case when lImpuesto14=0 then 0 else @Impuesto2 end as nImpuesto14,   
				case when lImpuesto15=0 then 0 else @Impuesto3 end as nImpuesto15,   
	  			1 + ((case when lImpuesto1=0 then 0 else @Impuesto1 end + case when lImpuesto2 = 0 then 0 else @Impuesto2 end + case when lImpuesto3 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorLocal,   
				1 + ((case when lImpuesto4=0 then 0 else @Impuesto1 end + case when lImpuesto5 = 0 then 0 else @Impuesto2 end + case when lImpuesto6 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorDelivery,  
				1 + ((case when lImpuesto7=0 then 0 else @Impuesto1 end + case when lImpuesto8 = 0 then 0 else @Impuesto2 end + case when lImpuesto9 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorLlevar,   
				1 + ((case when lImpuesto10=0 then 0 else @Impuesto1 end + case when lImpuesto11 = 0 then 0 else @Impuesto2 end + case when lImpuesto12 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorCanal4,  
				1 + ((case when lImpuesto13=0 then 0 else @Impuesto1 end + case when lImpuesto14 = 0 then 0 else @Impuesto2 end + case when lImpuesto15 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorCanal5   
  			from TPRODUCTO) IMPUESTOS ON dbo.vProducto.Codigo = IMPUESTOS.tCodigoProducto  


 --RIGHT JOIN tProductoArea On tProductoArea.tCodigoProducto = vProducto.Codigo  
 --LEFT JOIN vArea on tProductoArea.tArea = vArea.Codigo  
Where   
 dbo.vProducto.Codigo IS NOT NULL  and lCanal4=1
 end


 
 
if @tcodigoCanal='05'
begin

Insert Into @xProductos
SELECT   
	dbo.vProducto.Codigo, 
	dbo.vProducto.tTipoProducto,  
	dbo.vProducto.TipoProducto,  
	dbo.vProducto.Descripcion,  
	dbo.vProducto.tResumido, 
	dbo.vProducto.tSubGrupo, 
	dbo.vProducto.SubGrupo,  
 	dbo.vProducto.lActivo as lActivo,  
 	case when lCanal5=0 then 0 else nPrecioCanal5 / nFactorCanal5 end as nNetoSalon,   
 	case when lCanal5=0 then 0 else nPrecioCanal5 / nFactorCanal5 * nImpuesto1 / 100 end as nImpuesto1,   
	case when lCanal5=0 then 0 else nPrecioCanal5 / nFactorCanal5 * nImpuesto2 / 100 end as nImpuesto2,   
	case when lCanal5=0 then 0 else nPrecioCanal5 / nFactorCanal5 * nImpuesto3 / 100 end as nImpuesto3,   
	case when lCanal5=0 then 0 else nPrecioCanal5 end as nPrecioVenta,   
	Case When dbo.vProducto.lImprimeArea = 0 Then 'No' else 'Si' end as lImprimeArea,  
	dbo.vProducto.tGrupo,
	dbo.vProducto.Grupo,  
	Case When dbo.vProducto.lModificable = 0 Then 'No' else 'Si' end as lModificable,   
	dbo.vProducto.tDescargo,  
	dbo.vProducto.Area,  
	dbo.vProducto.nBoton,  
	dbo.vProducto.nBotonRapido,  
	dbo.vProducto.tCajaRapida,  
	dbo.vProducto.Moneda,  
	Case When dbo.vProducto.lPropiedad = 0 Then 'No' else 'Si' end as lPropiedad,  
	Case When dbo.vProducto.lDescuento = 0 Then 'No' else 'Si' end as lDescuento,  
	isnull(dbo.vProducto.nInsumo5,0)+isnull(dbo.vProducto.nGasto5,0)+isnull(dbo.vProducto.nManoObra5,0),
	ISNULL(T1.tDetallado,'') AS Combo,  
	'' as AreaImpresion
FROM   
 	(SELECT tCodigoProducto, tDetallado FROM TPRODUCTO) T1   
 	RIGHT OUTER JOIN dbo.TCOMBO ON T1.tCodigoProducto = dbo.TCOMBO.tCodigoProducto   
 	RIGHT OUTER JOIN dbo.vProducto ON dbo.TCOMBO.tCombo = dbo.vProducto.Codigo    
 	INNER JOIN (select tCodigoProducto,   
	  			case when lImpuesto1=0 then 0 else @Impuesto1 end as nImpuesto1,   
	  			case when lImpuesto2=0 then 0 else @Impuesto2 end as nImpuesto2,   
	  			case when lImpuesto3=0 then 0 else @Impuesto3 end as nImpuesto3,   
	  			case when lImpuesto4=0 then 0 else @Impuesto1 end as nImpuesto4,   
	  			case when lImpuesto5=0 then 0 else @Impuesto2 end as nImpuesto5,   
	  			case when lImpuesto6=0 then 0 else @Impuesto3 end as nImpuesto6,   
				case when lImpuesto7=0 then 0 else @Impuesto1 end as nImpuesto7,   
				case when lImpuesto8=0 then 0 else @Impuesto2 end as nImpuesto8,   
				case when lImpuesto9=0 then 0 else @Impuesto3 end as nImpuesto9,   
				case when lImpuesto10=0 then 0 else @Impuesto1 end as nImpuesto10,   
				case when lImpuesto11=0 then 0 else @Impuesto2 end as nImpuesto11,   
				case when lImpuesto12=0 then 0 else @Impuesto3 end as nImpuesto12,   
				case when lImpuesto13=0 then 0 else @Impuesto1 end as nImpuesto13,   
				case when lImpuesto14=0 then 0 else @Impuesto2 end as nImpuesto14,   
				case when lImpuesto15=0 then 0 else @Impuesto3 end as nImpuesto15,   
	  			1 + ((case when lImpuesto1=0 then 0 else @Impuesto1 end + case when lImpuesto2 = 0 then 0 else @Impuesto2 end + case when lImpuesto3 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorLocal,   
				1 + ((case when lImpuesto4=0 then 0 else @Impuesto1 end + case when lImpuesto5 = 0 then 0 else @Impuesto2 end + case when lImpuesto6 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorDelivery,  
				1 + ((case when lImpuesto7=0 then 0 else @Impuesto1 end + case when lImpuesto8 = 0 then 0 else @Impuesto2 end + case when lImpuesto9 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorLlevar,   
				1 + ((case when lImpuesto10=0 then 0 else @Impuesto1 end + case when lImpuesto11 = 0 then 0 else @Impuesto2 end + case when lImpuesto12 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorCanal4,  
				1 + ((case when lImpuesto13=0 then 0 else @Impuesto1 end + case when lImpuesto14 = 0 then 0 else @Impuesto2 end + case when lImpuesto15 = 0 then 0 else @Impuesto3 end) / 100 ) as nFactorCanal5   
  			from TPRODUCTO) IMPUESTOS ON dbo.vProducto.Codigo = IMPUESTOS.tCodigoProducto  


 --RIGHT JOIN tProductoArea On tProductoArea.tCodigoProducto = vProducto.Codigo  
 --LEFT JOIN vArea on tProductoArea.tArea = vArea.Codigo  
Where   
 dbo.vProducto.Codigo IS NOT NULL   and lCanal5=1
 end













declare @Codigo as nvarchar(7)

declare CURSORITO cursor for
Select Codigo from @xProductos
Open CURSORITO
fetch next from CURSORITO
into @Codigo
While @@fetch_status = 0
begin
	----------------------------
	Declare @Descripcion as nvarchar(50)
	
	Declare CURSORITO2 cursor for	
	Select vArea.Descripcion 
	from 
		vProducto
 		RIGHT JOIN tProductoArea On tProductoArea.tCodigoProducto = vProducto.Codigo  
 		LEFT JOIN vArea on tProductoArea.tArea = vArea.Codigo 
	Where 
		vProducto.Codigo = @Codigo
	Open CURSORITO2
	fetch next from CURSORITO2
	into @Descripcion
	While @@fetch_status = 0
	begin
		Update @xProductos
		Set AreaImpresion = AreaImpresion + '(' + @Descripcion+')'
		Where Codigo = @Codigo

		fetch next from CURSORITO2
		into @Descripcion
	end
	close CURSORITO2
	deallocate CURSORITO2
	-----------------------------
	fetch next from CURSORITO
	into @Codigo
end
close CURSORITO
deallocate CURSORITO
Select * from @xProductos


GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

CREATE Proc usp_InforestAdm_ObtenerOperadoresReporteLocal
AS
select 
	Codigo,
	Descripcion,
	tResumido,
	nBoton,
	Case When lValor = 0 Then 'No' else 'Si' end as lValor,
	Case When lStockMas = 0 Then 'No' else 'Si' end as lStockMas,
	Case When lStockMenos = 0 Then 'No' else 'Si' end as lStockMenos,
	Case When nControl = 0 Then 'Mximo' else Convert(nVarchar,nControl) end as nControl,
	Case When lImprime = 0 Then 'No' else 'Si' end as lImprime,
	Case When lActivo = 0 Then 'No' else 'Si' end as lActivo,
	tUsuario,
	fRegistro,
	Case When lObligaPropiedad = 0 Then 'Opcional' else 'Obligatorio' end as lObligaPropiedad
from vOperador

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE PROCEDURE [dbo].[usp_InforestCon_ObtenerReporteLiquidacionVentas] --'1000000228', NULL, NULL, NULL
@tTurno as nVarchar(10) = NULL,                
@fRegistroi as smalldatetime = NULL,                
@fRegistrof as smalldatetime = NULL,                
@tUsuario as nVarchar(16) = NULL       ,
@flagDiaContable as bit,
@sSectorVenta as nvarchar(50) --CESAR SECTOR VENTA
         
AS                
if @flagdiaContable=0
begin
--INGRESOS-------------------------------------------------------------------------------------------------------                
--Efectivo+Tarjetas+Propinas-------------------------------------------------------------------------------------                

SELECT                   
	'01 INGRESOS' as Titulo,                
   	'Total Cierre (FONDOS + Propinas)' AS Grupo,                
	ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '01' THEN ISNULL(dbo.DPAGODOCUMENTO.nMonto,0) ELSE 0 END),0) 
  	+      
  	(SELECT        
    		ISNULL(SUM( CASE WHEN dPag.tMoneda = '01' THEN dPag.nMonto ELSE 0 END),0) +      
    		ISNULL(SUM((CASE WHEN dPag.tMoneda = '02' THEN dPag.nMonto ELSE 0 END)*(dPag.nTipoCambio)),0)      
  	FROM       
    		dbo.DPAGODOCUMENTO as dPag 
    		LEFT JOIN dbo.MDOCUMENTO m ON dPag.tDocumento = m.tDocumento  
    		LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja    
  	WHERE       
    		dPag.tTipoPago='01'       
    		and isnull(dPag.tDocumento,'0')<>'0'       
    		And (dPag.tTurno = @tTurno OR @tTurno IS NULL)                
     		And (dPag.tUsuario = @tUsuario OR @tUsuario IS NULL)
     		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                 
     		And ((dPag.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))-      
-- - nEgresoN      
(SELECT        
 	ISNULL(SUM(CASE WHEN vEgr.tMoneda = '01' THEN vEgr.nMonto ELSE 0 END),0)      
FROM       
 	dbo.vEgreso as vEgr  LEFT JOIN dbo.TCAJA t ON vEgr.tCaja = t.tCaja    
WHERE       
 	vEgr.tEstadoDocumento='01'       
 	and isnull(vEgr.tCaja,'0')<>'0'       
 	And (vEgr.tTurno = @tTurno OR @tTurno IS NULL)      
 	And (vEgr.tUsuario = @tUsuario OR @tUsuario IS NULL) 
 	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')      
 	And ((vEgr.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))+                
+      
-- + nIngresoN + xIngresoE      
(SELECT       
 	ISNULL(SUM(CASE WHEN vIng.tMoneda = '01' THEN vIng.nMonto ELSE 0 END),0) +       
 	ISNULL(SUM((CASE WHEN vIng.tMoneda = '02' THEN vIng.nMonto ELSE 0 END)*(vIng.nTipoCambio)),0)      
FROM       
 	dbo.vIngreso as vIng  LEFT JOIN dbo.TCAJA t ON vIng.tCaja = t.tCaja     
WHERE       
 	vIng.lAnticipo=0       
 	and vIng.tEstadoDocumento='01'       
 	and isnull(vIng.tCaja,'0')<>'0'       
 	and vIng.tTipoPago ='01'       
 	And (vIng.tTurno = @tTurno OR @tTurno IS NULL)      
 	And (vIng.tUsuario = @tUsuario OR @tUsuario IS NULL)
 	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')       
 	And ((vIng.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))+               
+      
--  + nIngresoAN + xIngresoAE      
(SELECT        
 	ISNULL(SUM(CASE WHEN vIng.tMoneda = '01' THEN vIng.nMonto ELSE 0 END),0)+      
 	ISNULL(SUM((CASE WHEN vIng.tMoneda = '02' THEN vIng.nMonto ELSE 0 END)*isnull((vIng.nTipoCambio),0)),0)      
FROM       
 	dbo.vIngreso as vIng LEFT JOIN dbo.TCAJA t ON vIng.tCaja = t.tCaja     
WHERE       
	vIng.lAnticipo=1       
	and vIng.tEstadoDocumento='01'       
	and isnull(vIng.tCaja,'0')<>'0'       
	And vIng.tTipoPago = '01'      
	And (vIng.tTurno = @tTurno OR @tTurno IS NULL)                
	And (vIng.tUsuario = @tUsuario OR @tUsuario IS NULL)
	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                  
	And ((vIng.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))-      
-- - xDolar      
(select       
 	ISNULL(SUM(dPag.nDolar * dPag.nTipoCambio),0) as xSuma       
from       
 	dpagodocumento as dPag LEFT JOIN dbo.MDOCUMENTO m ON dPag.tDocumento = m.tDocumento  
    LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja      
where       
	dPag.tTipopago='01'       
	and dPag.tMoneda='02'       
	and isnull(dPag.tDocumento,'0')<>'0'       
	And (dPag.tTurno = @tTurno OR @tTurno IS NULL)                
	And (dPag.tUsuario = @tUsuario OR @tUsuario IS NULL)
	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                 
	And ((dPag.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))      
 +              
 (ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '02' THEN dbo.DPAGODOCUMENTO.nDolar*dbo.DPAGODOCUMENTO.nTipoCambio ELSE 0 END),0) - (SELECT ISNULL(SUM(CASE WHEN dbo.vEgreso.tMoneda = '02' THEN dbo.vEgreso.nMonto ELSE 0 END),0) As nVenta2     
FROM  	dbo.vEgreso LEFT JOIN dbo.TCAJA t ON dbo.vEgreso.tCaja = t.tCaja       
WHERE  	dbo.vEgreso.tEstadoDocumento='01'       
	and isnull(vEgreso.tCaja,'0')<>'0'       
	And (dbo.vEgreso.tTurno = @tTurno OR @tTurno IS NULL)       
	And (dbo.vEgreso.tUsuario = @tUsuario OR @tUsuario IS NULL) 
	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')     
	And ( 	(dbo.vEgreso.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR       
		(@fRegistroi IS NULL AND @fRegistrof IS NULL)      
	    )        
))      
+                
 	ISNULL(SUM(dbo.DPAGODOCUMENTO.nPropina),0) As nVenta1, NULL As nVenta2,
	'' AS Cantidad                
FROM
 	dbo.MDOCUMENTO                   
 	LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento
 	LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja                    
WHERE                   
  	(dbo.DPAGODOCUMENTO.tTipoPago IN ('01','02','03','04','05')) And NOT((dbo.DPAGODOCUMENTO.ttipoPago = '01' and dbo.DPAGODOCUMENTO.tMoneda = '01'))      
  	And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
 	And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
 	And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
 	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                 
 	And ((DPAGODOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))                
--Descuentos-----------------------------------------------------------------------------------------------------                
UNION                
SELECT                   
 	'01 INGRESOS' as Titulo,                  
 	'Total Cortesias 'as Grupo,                   
 	ISNULL(Sum(nVenta)+  
  
	(SELECT  
 		ISNULL(SUM(dPed.nDescuento*dPed.nCantidad),0)  
	FROM  
  		MPedido as mPed       
  		Left Join vMotivoDescuento as vMot On mPed.tDescuento = vMot.Codigo      
  		Left Join DPedido as dPed On dPed.tCodigoPedido = mPed.tCodigoPedido      
 		Left Join MDocumento as mdoc On dPed.tDocumento  = mdoc.tDocumento
 		LEFT JOIN dbo.TCAJA t ON mdoc.tCaja = t.tCaja       
	Where  
  		mPed.tDescuento <> ''  
  		And isnull(mdoc.tCaja,'0')<>'0'  
  		And (mdoc.tTurno = @tTurno OR @tTurno IS NULL)  
  		And (mdoc.tUsuario = @tUsuario OR @tUsuario IS NULL) 
  		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='') 
  		And ((mdoc.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))),0)
 	as nVenta1, 
	NULL As nVenta2,          
 	'' AS Cantidad                
From  
 	dbo.mDOCUMENTO  
 	left join vcortesia on mdocumento.tcortesia = vcortesia.Codigo
 	LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja   
WHERE  
 	mdocumento.ttipodocumento='00'  
 	And isnull(MDOCUMENTO.tCaja,'0')<>'0'  
 	And (MDOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)  
 	And (MDOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL) 
 	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='') 
 	And ((MDOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof)  
  	OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))
	And MDOCUMENTO.tEstadoDocumento <> '04'

--DEDUCCIONES----------------------------------------------------------------------------------------------------                  
UNION      
--DEDUCCIONES - Descuentos  
SELECT       
  	'02 DEDUCCIONES' as Titulo,      
  	' '+LTRIM(RTRIM(vMot.Descripcion))+ Convert(NVARCHAR,vMot.nRatio) + '% '  as Grupo,      
 	SUM(dPed.nDescuento*nCantidad) as nVenta1,   
 	NULL As nVenta2,      
  	'('+CONVERT(NVARCHAR,Count(Distinct mPed.tCodigoPedido))+')' AS Cantidad  
FROM      
  	MPedido as mPed       
  	Left Join vMotivoDescuento as vMot On mPed.tDescuento = vMot.Codigo      
  	Left Join DPedido as dPed On dPed.tCodigoPedido = mPed.tCodigoPedido      
 	Left Join MDocumento as mdoc On dPed.tDocumento  = mdoc.tDocumento
 	LEFT JOIN dbo.TCAJA t ON mdoc.tCaja = t.tCaja       
Where  
  	mPed.tDescuento <> ''  
	and  mped.testadopedido<>'03' 
  	And isnull(mdoc.tCaja,'0')<>'0'  
  	And (mdoc.tTurno = @tTurno OR @tTurno IS NULL)  
  	And (mdoc.tUsuario = @tUsuario OR @tUsuario IS NULL)
  	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')  
  	And ((mdoc.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))  
group by      
 	' '+LTRIM(RTRIM(vMot.Descripcion))+ Convert(NVARCHAR,vMot.nRatio) + '% ',        
 	vMot.nRatio,       
 	vMot.lRatio  
--------------------------      
UNION      
SELECT                   
 	'02 DEDUCCIONES' as Titulo,                  
 	'Cortesia 100% ' + vCortesia.descripcion as Grupo,                   
 	Sum(nVenta) as nVenta1, NULL As nVenta2,          
 	'('+CONVERT(NVARCHAR,Count(*))+')' AS Cantidad                
From                   
 	dbo.mDOCUMENTO                    
 	left join vcortesia on mdocumento.tcortesia = vcortesia.Codigo
 	LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja                      
WHERE                   
 	mdocumento.ttipodocumento='00'                   
 	And isnull(MDOCUMENTO.tCaja,'0')<>'0'                   
 	And (MDOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
 	And (MDOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
 	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
 	And ((MDOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof)                 
   	OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))                
	And MDOCUMENTO.tEstadoDocumento <> '04'
group by                   
 	'Cortesia 100% ' + vCortesia.descripcion                  
--DEDUCCIONES-----------------                
UNION                  
SELECT                   
 	'02 DEDUCCIONES' as Titulo,                  
 	'Propinas' AS Grupo,                
 	SUM(dbo.DPAGODOCUMENTO.nPropina) As nVenta1 , NULL As nVenta2,          
 	'('+CONVERT(NVARCHAR,Count(*))+')' AS Cantidad                
FROM                   
 	dbo.TTARJETACREDITO                   
 	RIGHT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.TTARJETACREDITO.tCodigoTarjeta = dbo.DPAGODOCUMENTO.tTarjeta                   
 	RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento
 	LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja                    
WHERE                   
	dbo.DPAGODOCUMENTO.tTipoPago='02'                   
	And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
	And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
	And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
	And ((DPAGODOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof)                 
	OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))                
	And dbo.DPAGODOCUMENTO.nPropina > 0                
--VENTA NETA--------------------------------------------------------------------------------------------------------                  
UNION                  
SELECT                   
	'02 VENTA BRUTA' as Titulo,                  
	' ' AS Grupo,          
	CONVERT(NVARCHAR,ISNULL(      
  		ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '01' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END),0)+           
  		(SELECT        
		   ISNULL(SUM( CASE WHEN dPag.tMoneda = '01' THEN dPag.nMonto ELSE 0 END),0) +      
		   ISNULL(SUM((CASE WHEN dPag.tMoneda = '02' THEN dPag.nMonto ELSE 0 END)*(dPag.nTipoCambio)),0)      
		FROM       
			dbo.DPAGODOCUMENTO as dPag LEFT JOIN dbo.MDOCUMENTO m ON dPag.tDocumento = m.tDocumento 
			LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja     
		WHERE       
			dPag.tTipoPago='01'       
   			and isnull(dPag.tDocumento,'0')<>'0'
   			And (dPag.tTurno = @tTurno OR @tTurno IS NULL)                
    			And (dPag.tUsuario = @tUsuario OR @tUsuario IS NULL) 
    			And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
    			And ((dPag.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))-      
-- - nEgresoN      
  	(SELECT        
   		ISNULL(SUM(CASE WHEN vEgr.tMoneda = '01' THEN vEgr.nMonto ELSE 0 END),0)      
	FROM       
   		dbo.vEgreso as vEgr LEFT JOIN dbo.TCAJA t ON vEgr.tCaja = t.tCaja       
  	WHERE       
 		vEgr.tEstadoDocumento='01'       
		and isnull(vEgr.tCaja,'0')<>'0'       
		And (vEgr.tTurno = @tTurno OR @tTurno IS NULL)      
		And (vEgr.tUsuario = @tUsuario OR @tUsuario IS NULL)
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')      
 		And ((vEgr.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))+                
	+      
-- + nIngresoN + xIngresoE      
	(SELECT       
 		ISNULL(SUM(CASE WHEN vIng.tMoneda = '01' THEN vIng.nMonto ELSE 0 END),0) +       
 		ISNULL(SUM((CASE WHEN vIng.tMoneda = '02' THEN vIng.nMonto ELSE 0 END)*(vIng.nTipoCambio)),0)      
	FROM       
 		dbo.vIngreso as vIng LEFT JOIN dbo.TCAJA t ON vIng.tCaja = t.tCaja     
	WHERE       
 		vIng.lAnticipo=0       
 		and vIng.tEstadoDocumento='01'       
		and isnull(vIng.tCaja,'0')<>'0'       
 		and vIng.tTipoPago ='01'       
 		And (vIng.tTurno = @tTurno OR @tTurno IS NULL)      
 		And (vIng.tUsuario = @tUsuario OR @tUsuario IS NULL) 
 		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')     
 		And ((vIng.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))+               
	+      
--  + nIngresoAN + xIngresoAE      
	(SELECT        
		ISNULL(SUM(CASE WHEN vIng.tMoneda = '01' THEN vIng.nMonto ELSE 0 END),0)+      
		ISNULL(SUM((CASE WHEN vIng.tMoneda = '02' THEN vIng.nMonto ELSE 0 END)*isnull((vIng.nTipoCambio),0)),0)      
	FROM       
		dbo.vIngreso as vIng LEFT JOIN dbo.TCAJA t ON vIng.tCaja = t.tCaja      
	WHERE       
		vIng.lAnticipo=1       
		and vIng.tEstadoDocumento='01'       
		and isnull(vIng.tCaja,'0')<>'0'       
		And vIng.tTipoPago = '01'      
		And (vIng.tTurno = @tTurno OR @tTurno IS NULL)                
		And (vIng.tUsuario = @tUsuario OR @tUsuario IS NULL) 
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')             
		And ((vIng.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))-      
-- - xDolar      
	(select       
		ISNULL(SUM(dPag.nDolar * dPag.nTipoCambio),0) as xSuma       
	from       
		dpagodocumento as dPag LEFT JOIN dbo.MDOCUMENTO m ON dPag.tDocumento = m.tDocumento 
		LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja       
	where       
 		dPag.tTipopago='01'       
 		and dPag.tMoneda='02'       
 		and isnull(dPag.tDocumento,'0')<>'0'       
 		And (dPag.tTurno = @tTurno OR @tTurno IS NULL)                
  		And (dPag.tUsuario = @tUsuario OR @tUsuario IS NULL)
  		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                 
  		And ((dPag.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))                
/**/      
      
   	+ ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '02' THEN dbo.DPAGODOCUMENTO.nDolar*dbo.DPAGODOCUMENTO.nTipoCambio ELSE 0 END),0)-      
    	(      
    	SELECT ISNULL(SUM(dPed.nDescuento),0)       
    	FROM MPedido as mPed Left Join DPedido as dPed On dPed.tCodigoPedido = mPed.tCodigoPedido Left Join MDocumento as mdoc On dPed.tDocumento  = mdoc.tDocumento LEFT JOIN dbo.TCAJA t ON mdoc.tCaja = t.tCaja      
    	Where mPed.tDescuento <> '' And isnull(mdoc.tCaja,'0')<>'0' And (mdoc.tTurno = @tTurno OR @tTurno IS NULL) And (mdoc.tUsuario = @tUsuario OR @tUsuario IS NULL) And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='') And  ((mdoc.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))      
   	)      
   ,0))  
  
 + (SELECT  
 ISNULL(SUM(dPed.nDescuento),0)  
FROM  
  MPedido as mPed       
  Left Join vMotivoDescuento as vMot On mPed.tDescuento = vMot.Codigo      
  Left Join DPedido as dPed On dPed.tCodigoPedido = mPed.tCodigoPedido      
  Left Join MDocumento as mdoc On dPed.tDocumento  = mdoc.tDocumento
  LEFT JOIN dbo.TCAJA t ON mdoc.tCaja = t.tCaja       
Where  
  mPed.tDescuento <> ''  
  And isnull(mdoc.tCaja,'0')<>'0'  
  And (mdoc.tTurno = @tTurno OR @tTurno IS NULL)  
  And (mdoc.tUsuario = @tUsuario OR @tUsuario IS NULL)
  And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')  
  And ((mdoc.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))  
  
  
 As nVenta1,      
 0 As nVenta2,      
 '' AS Cantidad      
FROM                   
 dbo.MDOCUMENTO                   
 LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento
 LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja       
WHERE                 
 dbo.DPAGODOCUMENTO.tTipoPago IN ('01','02','03','04','05')   And NOT((dbo.DPAGODOCUMENTO.ttipoPago = '01' and dbo.DPAGODOCUMENTO.tMoneda = '01'))      
 And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                 
 And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)              
 And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
 And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')              
 And ((DPAGODOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof)               
  OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))    
--FONDOS-Efectivo Soles--------------------------------------------------------------------------------------------------------    
UNION                  
SELECT                   
 '03 FONDOS' as Titulo,                  
 'Efectivo  Soles - Propinas' AS Grupo,                   
 --SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '01' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END) As nVenta1,      
-- nEfectivoN + xEfectivoE        
0+( SELECT        
  ISNULL(SUM( CASE WHEN dPag.tMoneda = '01' THEN dPag.nMonto ELSE 0 END),0) +      
  ISNULL(SUM((CASE WHEN dPag.tMoneda = '02' THEN dPag.nMonto ELSE 0 END)*(dPag.nTipoCambio)),0)      
 FROM       
  dbo.DPAGODOCUMENTO as dPag LEFT JOIN  dbo.MDOCUMENTO m ON dPag.tDocumento = m.tDocumento
  LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja      
 WHERE       
  dPag.tTipoPago='01'       
  and isnull(dPag.tDocumento,'0')<>'0'       
  And (dPag.tTurno = @tTurno OR @tTurno IS NULL)                
   And (dPag.tUsuario = @tUsuario OR @tUsuario IS NULL)
   And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                 
   And ((dPag.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))-      
-- - nEgresoN      
(SELECT        
 ISNULL(SUM(CASE WHEN vEgr.tMoneda = '01' THEN vEgr.nMonto ELSE 0 END),0)      
FROM       
 dbo.vEgreso as vEgr LEFT JOIN dbo.TCAJA t ON vegr.tCaja = t.tCaja     
WHERE       
 vEgr.tEstadoDocumento='01'       
 and isnull(vEgr.tCaja,'0')<>'0'       
 And (vEgr.tTurno = @tTurno OR @tTurno IS NULL)      
 And (vEgr.tUsuario = @tUsuario OR @tUsuario IS NULL)
 And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')      
 And ((vEgr.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))+                
+      
-- + nIngresoN + xIngresoE      
(SELECT       
 ISNULL(SUM(CASE WHEN vIng.tMoneda = '01' THEN vIng.nMonto ELSE 0 END),0) +       
 ISNULL(SUM((CASE WHEN vIng.tMoneda = '02' THEN vIng.nMonto ELSE 0 END)*(vIng.nTipoCambio)),0)      
FROM       
 dbo.vIngreso as vIng LEFT JOIN dbo.TCAJA t ON vIng.tCaja = t.tCaja     
WHERE       
 vIng.lAnticipo=0       
 and vIng.tEstadoDocumento='01'       
 and isnull(vIng.tCaja,'0')<>'0'       
 and vIng.tTipoPago ='01'       
 And (vIng.tTurno = @tTurno OR @tTurno IS NULL)      
 And (vIng.tUsuario = @tUsuario OR @tUsuario IS NULL) 
 And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')     
 And ((vIng.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))+               
+      
--  + nIngresoAN + xIngresoAE      
(SELECT        
 ISNULL(SUM(CASE WHEN vIng.tMoneda = '01' THEN vIng.nMonto ELSE 0 END),0)+      
 ISNULL(SUM((CASE WHEN vIng.tMoneda = '02' THEN vIng.nMonto ELSE 0 END)*isnull((vIng.nTipoCambio),0)),0)      
FROM       
 dbo.vIngreso as vIng LEFT JOIN dbo.TCAJA t ON vIng.tCaja = t.tCaja    
WHERE       
 vIng.lAnticipo=1       
 and vIng.tEstadoDocumento='01'       
 and isnull(vIng.tCaja,'0')<>'0'       
 And vIng.tTipoPago = '01'      
 And (vIng.tTurno = @tTurno OR @tTurno IS NULL)                
 And (vIng.tUsuario = @tUsuario OR @tUsuario IS NULL) 
 And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
 And ((vIng.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))-      
-- - xDolar      
( select       
   ISNULL(SUM(dPag.nDolar * dPag.nTipoCambio),0) as xSuma       
 from       
   dpagodocumento as dPag LEFT JOIN  dbo.MDOCUMENTO m ON dPag.tDocumento = m.tDocumento
   LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja         
 where       
   dPag.tTipopago='01'       
   and dPag.tMoneda='02'       
   and isnull(dPag.tDocumento,'0')<>'0'       
   And (dPag.tTurno = @tTurno OR @tTurno IS NULL)                
   And (dPag.tUsuario = @tUsuario OR @tUsuario IS NULL)
   And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                 
   And ((dPag.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))    
)-    
-- -Propinas    
		(    
	SELECT                   
		ISNULL(SUM(dbo.DPAGODOCUMENTO.nPropina),0) as xSuma    
		FROM                   
		dbo.TTARJETACREDITO                   
		RIGHT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.TTARJETACREDITO.tCodigoTarjeta = dbo.DPAGODOCUMENTO.tTarjeta                   
		RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento
		LEFT JOIN dbo.tCaja t ON dbo.MDOCUMENTO.tCaja = t.tCaja                    
		WHERE                   
		dbo.DPAGODOCUMENTO.tTipoPago='02'                   
		And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
		And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
		And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
		And ((DPAGODOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof)                 
		OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))                
		And dbo.DPAGODOCUMENTO.nPropina > 0       
		)                  
		AS nVenta1,        
		NULL As nVenta2,          
		'('+CONVERT(NVARCHAR,Count(*))+')' AS Cantidad                
		FROM                   
		dbo.MDOCUMENTO                   
		LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento
		LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja                     
		WHERE                   
		dbo.DPAGODOCUMENTO.tTipoPago='01'                   
		and isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
		And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
		And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
		And ((DPAGODOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof)                 
		OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))                
--FONDOS-Efectivo Dolares--------------------------------------------------------------------------------------------------------                  
UNION                  
	SELECT      
		'03 FONDOS' as Titulo,                  
		'Efectivo Dolares        '+CONVERT(NVARCHAR,SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '02' THEN dbo.DPAGODOCUMENTO.nDolar ELSE 0 END)) AS Grupo,                
		SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '02' THEN dbo.DPAGODOCUMENTO.nDolar*dbo.DPAGODOCUMENTO.nTipoCambio ELSE 0 END)
		- ( 	SELECT ISNULL(SUM(CASE WHEN dbo.vEgreso.tMoneda = '02' THEN dbo.vEgreso.nMonto ELSE 0 END),0) As nVenta2      
			FROM  dbo.vEgreso LEFT JOIN dbo.TCAJA t ON dbo.vEgreso.tCaja = t.tCaja        
			WHERE  dbo.vEgreso.tEstadoDocumento='01'       
				and isnull(dbo.vEgreso.tCaja,'0')<>'0'       
				And (dbo.vEgreso.tTurno = @tTurno OR @tTurno IS NULL)       
				And (dbo.vEgreso.tUsuario = @tUsuario OR @tUsuario IS NULL)
				And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')      
				And ((dbo.vEgreso.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))        
		As nVenta1, NULL As nVenta2,                
		'('+CONVERT(NVARCHAR,Count(*))+')' AS Cantidad                
	FROM                   
		dbo.MDOCUMENTO                   
		LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento
		LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja                
	WHERE                   
		dbo.DPAGODOCUMENTO.tTipoPago='01'                   
		And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
		And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
		And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
		And ((DPAGODOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))      
--FONDOS-Tarjeta de Credito--------------------------------------------------------------------------------------------------------                  
UNION                  
	SELECT                   
		'03 FONDOS' as Titulo,                  
		'Tarjeta Crdito '/*+dbo.TTARJETACREDITO.tResumido*/ AS Grupo,                  
		SUM(dbo.DPAGODOCUMENTO.nMonto+dbo.DPAGODOCUMENTO.nPropina) as nVenta1, NULL As nVenta2,          
		'('+CONVERT(NVARCHAR,Count(*))+')' AS Cantidad                 
	FROM                   
		dbo.TTARJETACREDITO                   
		RIGHT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.TTARJETACREDITO.tCodigoTarjeta = dbo.DPAGODOCUMENTO.tTarjeta                   
		RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento
		LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja                    
	WHERE                   
		dbo.DPAGODOCUMENTO.tTipoPago='02'                   
		and isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
		And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
		And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
		And ((DPAGODOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof)                 
		OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))                
--GROUP BY 'Tarjeta Crdito '+dbo.TTARJETACREDITO.tResumido                 
--FONDOS-Cheques/Depositos--------------------------------------------------------------------------------------------------------                  
UNION                  
	SELECT                   
		'03 FONDOS' as Titulo,                  
		'Cheques / Depositos    ' AS Grupo,                
		ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '01' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END)+           
		SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '02' THEN dbo.DPAGODOCUMENTO.nMonto*dbo.DPAGODOCUMENTO.nTipoCambio ELSE 0 END),0) As nVenta1, NULL As nVenta2,          
		'('+CONVERT(NVARCHAR,Count(*))+')' AS Cantidad                
	FROM                   
		dbo.MDOCUMENTO                   
		LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento
		LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja                    
	WHERE                   
		dbo.DPAGODOCUMENTO.tTipoPago='03'            
		And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
		And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
		And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
		And ((DPAGODOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof)                 
		OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))                 
--FONDOS-Otros Pagos--------------------------------------------------------------------------------------------------------                  
UNION                  
	SELECT                   
		'03 FONDOS' as Titulo,                  
		'Otros Pagos / ' + vTip.Descripcion AS Grupo,                
		ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '01' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END),0)+      
		ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '02' THEN dbo.DPAGODOCUMENTO.nMonto*dbo.DPAGODOCUMENTO.nTipoCambio ELSE 0 END),0) As nVenta1, NULL As nVenta2,          
		'('+CONVERT(NVARCHAR,Count(*))+')' AS Cantidad                
	FROM                   
		dbo.MDOCUMENTO                   
		LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento                   
		LEFT OUTER JOIN dbo.vTipoCancelacion as vTip ON vTip.Codigo = dbo.DPAGODOCUMENTO.tOtroTipoPago
		LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja        
	WHERE                   
		dbo.DPAGODOCUMENTO.tTipoPago='04'            
		And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
		And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
		And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
		And ((DPAGODOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof)                 
		OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))                 
		GROUP BY 'Otros Pagos / ' + vTip.Descripcion        
--FONDOS-Puntos--------------------------------------------------------------------------------------------------------                  
UNION                  
	SELECT                   
 		'03 FONDOS' as Titulo,                  
		'Puntos    ' AS Grupo,                
		ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '01' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END)+           
		SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '02' THEN dbo.DPAGODOCUMENTO.nMonto*dbo.DPAGODOCUMENTO.nTipoCambio ELSE 0 END),0) As nVenta1, NULL As nVenta2,          
		'('+CONVERT(NVARCHAR,Count(*))+')' AS Cantidad                
	FROM                   
 		dbo.MDOCUMENTO                   
 		LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento
 		LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja                    
	WHERE                   
		dbo.DPAGODOCUMENTO.tTipoPago='05'            
		And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
		And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
		And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL) 
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')               
		And ((DPAGODOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof)                 
		OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))                 
--LIQUIDACION DE TARJETAS DE CREDITO--------------------------------------------------------------------------------------------------------                  
UNION                  
	SELECT                   
		'04 LIQUIDACION DE TARJETAS DE CREDITO' as Titulo,                  
		dbo.TTARJETACREDITO.tResumido AS Grupo,                  
		SUM(dbo.DPAGODOCUMENTO.nMonto+dbo.DPAGODOCUMENTO.nPropina) as nVenta1, NULL As nVenta2,          
		'('+CONVERT(NVARCHAR,Count(*))+')' AS Cantidad                
	FROM                   
		dbo.TTARJETACREDITO                   
		RIGHT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.TTARJETACREDITO.tCodigoTarjeta = dbo.DPAGODOCUMENTO.tTarjeta                   
		RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento 
		LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja                   
	WHERE                   
		dbo.DPAGODOCUMENTO.tTipoPago='02'                   
		and isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
		And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
		And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
		And ((DPAGODOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof)                 
		OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))              
		GROUP BY dbo.TTARJETACREDITO.tResumido

end
if @flagDiaContable=1
begin

SELECT                   
	'01 INGRESOS' as Titulo,                
   	'Total Cierre (FONDOS + Propinas)' AS Grupo,                
	ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '01' THEN ISNULL(dbo.DPAGODOCUMENTO.nMonto,0) ELSE 0 END),0) 
  	+      
  	(SELECT        
    		ISNULL(SUM( CASE WHEN dPag.tMoneda = '01' THEN dPag.nMonto ELSE 0 END),0) +      
    		ISNULL(SUM((CASE WHEN dPag.tMoneda = '02' THEN dPag.nMonto ELSE 0 END)*(dPag.nTipoCambio)),0)      
  	FROM       
    		dbo.DPAGODOCUMENTO as dPag RIGHT OUTER JOIN dbo.MDOCUMENTO m ON dPag.tDocumento = m.tDocumento 
		    LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja      
  	WHERE       
    		dPag.tTipoPago='01'       
    		and isnull(dPag.tDocumento,'0')<>'0'       
    		And (dPag.tTurno = @tTurno OR @tTurno IS NULL)                
     		And (dPag.tUsuario = @tUsuario OR @tUsuario IS NULL)
     		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                 
     		And ((dPag.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))-      
-- - nEgresoN      
(SELECT        
 	ISNULL(SUM(CASE WHEN vEgr.tMoneda = '01' THEN vEgr.nMonto ELSE 0 END),0)      
FROM       
 	dbo.vEgreso as vEgr LEFT JOIN dbo.TCAJA t ON vEgr.tCaja = t.tCaja       
WHERE       
 	vEgr.tEstadoDocumento='01'       
 	and isnull(vEgr.tCaja,'0')<>'0'       
 	And (vEgr.tTurno = @tTurno OR @tTurno IS NULL)      
 	And (vEgr.tUsuario = @tUsuario OR @tUsuario IS NULL)
 	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')      
 	And ((vEgr.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))+                
+      
-- + nIngresoN + xIngresoE      
(SELECT       
 	ISNULL(SUM(CASE WHEN vIng.tMoneda = '01' THEN vIng.nMonto ELSE 0 END),0) +       
 	ISNULL(SUM((CASE WHEN vIng.tMoneda = '02' THEN vIng.nMonto ELSE 0 END)*(vIng.nTipoCambio)),0)      
FROM       
 	dbo.vIngreso as vIng LEFT JOIN dbo.TCAJA t ON vIng.tCaja = t.tCaja      
WHERE       
 	vIng.lAnticipo=0       
 	and vIng.tEstadoDocumento='01'       
 	and isnull(vIng.tCaja,'0')<>'0'       
 	and vIng.tTipoPago ='01'       
 	And (vIng.tTurno = @tTurno OR @tTurno IS NULL)      
 	And (vIng.tUsuario = @tUsuario OR @tUsuario IS NULL)
 	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')      
 	And ((vIng.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))+               
+      
--  + nIngresoAN + xIngresoAE      
(SELECT        
 	ISNULL(SUM(CASE WHEN vIng.tMoneda = '01' THEN vIng.nMonto ELSE 0 END),0)+      
 	ISNULL(SUM((CASE WHEN vIng.tMoneda = '02' THEN vIng.nMonto ELSE 0 END)*isnull((vIng.nTipoCambio),0)),0)      
FROM       
 	dbo.vIngreso as vIng LEFT JOIN dbo.TCAJA t ON vIng.tCaja = t.tCaja      
WHERE       
	vIng.lAnticipo=1       
	and vIng.tEstadoDocumento='01'       
	and isnull(vIng.tCaja,'0')<>'0'       
	And vIng.tTipoPago = '01'      
	And (vIng.tTurno = @tTurno OR @tTurno IS NULL)                
	And (vIng.tUsuario = @tUsuario OR @tUsuario IS NULL)
	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                 
	And ((vIng.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))-      
-- - xDolar      
(select       
 	ISNULL(SUM(dPag.nDolar * dPag.nTipoCambio),0) as xSuma       
from       
 	dpagodocumento as dPag RIGHT OUTER JOIN dbo.MDOCUMENTO m ON dPag.tDocumento = m.tDocumento 
	LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja       
where       
	dPag.tTipopago='01'       
	and dPag.tMoneda='02'       
	and isnull(dPag.tDocumento,'0')<>'0'       
	And (dPag.tTurno = @tTurno OR @tTurno IS NULL)                
	And (dPag.tUsuario = @tUsuario OR @tUsuario IS NULL)
	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                 
	And ((dPag.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))      
 +              
 (ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '02' THEN dbo.DPAGODOCUMENTO.nDolar*dbo.DPAGODOCUMENTO.nTipoCambio ELSE 0 END),0) - (SELECT ISNULL(SUM(CASE WHEN dbo.vEgreso.tMoneda = '02' THEN dbo.vEgreso.nMonto ELSE 0 END),0) As nVenta2     
FROM  	dbo.vEgreso LEFT JOIN TCAJA t ON vEgreso.tCaja = t.tCaja        
WHERE  	dbo.vEgreso.tEstadoDocumento='01'       
	and isnull(dbo.vEgreso.tCaja,'0')<>'0'       
	And (dbo.vEgreso.tTurno = @tTurno OR @tTurno IS NULL)       
	And (dbo.vEgreso.tUsuario = @tUsuario OR @tUsuario IS NULL)
	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')      
	And ( 	(dbo.vEgreso.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR       
		(@fRegistroi IS NULL AND @fRegistrof IS NULL)      
	    )        
))      
+                
 	ISNULL(SUM(dbo.DPAGODOCUMENTO.nPropina),0) As nVenta1, NULL As nVenta2,
	'' AS Cantidad                
FROM
 	dbo.MDOCUMENTO                   
 	LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento
 	LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja                    
WHERE                   
  	(dbo.DPAGODOCUMENTO.tTipoPago IN ('01','02','03','04','05')) And NOT((dbo.DPAGODOCUMENTO.ttipoPago = '01' and dbo.DPAGODOCUMENTO.tMoneda = '01'))      
  	And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
 	And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
 	And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
 	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                 
 	And ((DPAGODOCUMENTO.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))                
--Descuentos-----------------------------------------------------------------------------------------------------                
UNION                
SELECT                   
 	'01 INGRESOS' as Titulo,                  
 	'Total Cortesias 'as Grupo,                   
 	ISNULL(Sum(nVenta)+  
  
	(SELECT  
 		ISNULL(SUM(dPed.nDescuento*dPed.nCantidad),0)  
	FROM  
  		MPedido as mPed       
  		Left Join vMotivoDescuento as vMot On mPed.tDescuento = vMot.Codigo      
  		Left Join DPedido as dPed On dPed.tCodigoPedido = mPed.tCodigoPedido      
 		Left Join MDocumento as mdoc On dPed.tDocumento  = mdoc.tDocumento
 		LEFT JOIN dbo.TCAJA t ON mdoc.tCaja = t.tCaja       
	Where  
  		mPed.tDescuento <> ''  
  		And isnull(mdoc.tCaja,'0')<>'0'  
  		And (mdoc.tTurno = @tTurno OR @tTurno IS NULL)  
  		And (mdoc.tUsuario = @tUsuario OR @tUsuario IS NULL)
  		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')   
  		And ((mdoc.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))),0)
 	as nVenta1, 
	NULL As nVenta2,          
 	'' AS Cantidad                
From  
 	dbo.mDOCUMENTO  
 	left join vcortesia on mdocumento.tcortesia = vcortesia.Codigo
 	LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja   
WHERE  
 	mdocumento.ttipodocumento='00'  
 	And isnull(MDOCUMENTO.tCaja,'0')<>'0'  
 	And (MDOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)  
 	And (MDOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)  
 	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
 	And ((MDOCUMENTO.fdiacontable BETWEEN @fRegistroi AND @fRegistrof)  
  	OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))
	And MDOCUMENTO.tEstadoDocumento <> '04'

--DEDUCCIONES----------------------------------------------------------------------------------------------------                  
UNION      
--DEDUCCIONES - Descuentos  
SELECT       
  	'02 DEDUCCIONES' as Titulo,      
  	' '+LTRIM(RTRIM(vMot.Descripcion))+ Convert(NVARCHAR,vMot.nRatio) + '% '  as Grupo,      
 	SUM(dPed.nDescuento*nCantidad) as nVenta1,   
 	NULL As nVenta2,      
  	'('+CONVERT(NVARCHAR,Count(Distinct mPed.tCodigoPedido))+')' AS Cantidad  
FROM      
  	MPedido as mPed       
  	Left Join vMotivoDescuento as vMot On mPed.tDescuento = vMot.Codigo      
  	Left Join DPedido as dPed On dPed.tCodigoPedido = mPed.tCodigoPedido      
 	Left Join MDocumento as mdoc On dPed.tDocumento  = mdoc.tDocumento
 	LEFT JOIN dbo.TCAJA t ON mdoc.tCaja = t.tCaja       
Where  
  	mPed.tDescuento <> ''  
	and  mped.testadopedido<>'03' 
  	And isnull(mdoc.tCaja,'0')<>'0'  
  	And (mdoc.tTurno = @tTurno OR @tTurno IS NULL)  
  	And (mdoc.tUsuario = @tUsuario OR @tUsuario IS NULL)
  	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')  
  	And ((mdoc.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))  
group by      
 	' '+LTRIM(RTRIM(vMot.Descripcion))+ Convert(NVARCHAR,vMot.nRatio) + '% ',        
 	vMot.nRatio,       
 	vMot.lRatio  
--------------------------      
UNION      
SELECT                   
 	'02 DEDUCCIONES' as Titulo,                  
 	'Cortesia 100% ' + vCortesia.descripcion as Grupo,                   
 	Sum(nVenta) as nVenta1, NULL As nVenta2,          
 	'('+CONVERT(NVARCHAR,Count(*))+')' AS Cantidad                
From                   
 	dbo.mDOCUMENTO                    
 	left join vcortesia on mdocumento.tcortesia = vcortesia.Codigo
 	LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja                     
WHERE                   
 	mdocumento.ttipodocumento='00'                   
 	And isnull(MDOCUMENTO.tCaja,'0')<>'0'                   
 	And (MDOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
 	And (MDOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
 	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
 	And ((MDOCUMENTO.fdiacontable BETWEEN @fRegistroi AND @fRegistrof)                 
   	OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))                
	And MDOCUMENTO.tEstadoDocumento <> '04'
group by                   
 	'Cortesia 100% ' + vCortesia.descripcion                  
--DEDUCCIONES-----------------                
UNION                  
SELECT                   
 	'02 DEDUCCIONES' as Titulo,                  
 	'Propinas' AS Grupo,                
 	SUM(dbo.DPAGODOCUMENTO.nPropina) As nVenta1 , NULL As nVenta2,          
 	'('+CONVERT(NVARCHAR,Count(*))+')' AS Cantidad                
FROM                   
 	dbo.TTARJETACREDITO                   
 	RIGHT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.TTARJETACREDITO.tCodigoTarjeta = dbo.DPAGODOCUMENTO.tTarjeta                   
 	RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento
 	LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja                    
WHERE                   
	dbo.DPAGODOCUMENTO.tTipoPago='02'                   
	And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
	And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
	And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
	And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
	And ((DPAGODOCUMENTO.fdiacontable BETWEEN @fRegistroi AND @fRegistrof)                 
	OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))                
	And dbo.DPAGODOCUMENTO.nPropina > 0                
--VENTA NETA--------------------------------------------------------------------------------------------------------                  
UNION                  
SELECT                   
	'02 VENTA BRUTA' as Titulo,                  
	' ' AS Grupo,          
	CONVERT(NVARCHAR,ISNULL(      
  		ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '01' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END),0)+           
  		(SELECT        
		   ISNULL(SUM( CASE WHEN dPag.tMoneda = '01' THEN dPag.nMonto ELSE 0 END),0) +      
		   ISNULL(SUM((CASE WHEN dPag.tMoneda = '02' THEN dPag.nMonto ELSE 0 END)*(dPag.nTipoCambio)),0)      
		FROM       
			dbo.DPAGODOCUMENTO as dPag RIGHT OUTER JOIN dbo.MDOCUMENTO m ON dPag.tDocumento = m.tDocumento
 	        LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja       
		WHERE       
			dPag.tTipoPago='01'       
   			and isnull(dPag.tDocumento,'0')<>'0'
   			And (dPag.tTurno = @tTurno OR @tTurno IS NULL)                
    		And (dPag.tUsuario = @tUsuario OR @tUsuario IS NULL)
    		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                 
    		And ((dPag.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))-      
-- - nEgresoN      
  	(SELECT        
   		ISNULL(SUM(CASE WHEN vEgr.tMoneda = '01' THEN vEgr.nMonto ELSE 0 END),0)      
	FROM       
   		dbo.vEgreso as vEgr LEFT JOIN dbo.TCAJA t ON vEgr.tCaja = t.tCaja       
  	WHERE       
 		vEgr.tEstadoDocumento='01'       
		and isnull(vEgr.tCaja,'0')<>'0'       
		And (vEgr.tTurno = @tTurno OR @tTurno IS NULL)      
		And (vEgr.tUsuario = @tUsuario OR @tUsuario IS NULL)
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')      
 		And ((vEgr.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))+                
	+      
-- + nIngresoN + xIngresoE      
	(SELECT       
 		ISNULL(SUM(CASE WHEN vIng.tMoneda = '01' THEN vIng.nMonto ELSE 0 END),0) +       
 		ISNULL(SUM((CASE WHEN vIng.tMoneda = '02' THEN vIng.nMonto ELSE 0 END)*(vIng.nTipoCambio)),0)      
	FROM       
 		dbo.vIngreso as vIng LEFT JOIN dbo.TCAJA t ON vIng.tCaja = t.tCaja       
	WHERE       
 		vIng.lAnticipo=0       
 		and vIng.tEstadoDocumento='01'       
		and isnull(vIng.tCaja,'0')<>'0'       
 		and vIng.tTipoPago ='01'       
 		And (vIng.tTurno = @tTurno OR @tTurno IS NULL)      
 		And (vIng.tUsuario = @tUsuario OR @tUsuario IS NULL)
 		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')      
 		And ((vIng.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))+               
	+      
--  + nIngresoAN + xIngresoAE      
	(SELECT        
		ISNULL(SUM(CASE WHEN vIng.tMoneda = '01' THEN vIng.nMonto ELSE 0 END),0)+      
		ISNULL(SUM((CASE WHEN vIng.tMoneda = '02' THEN vIng.nMonto ELSE 0 END)*isnull((vIng.nTipoCambio),0)),0)      
	FROM       
		dbo.vIngreso as vIng LEFT JOIN dbo.TCAJA t ON vIng.tCaja = t.tCaja      
	WHERE       
		vIng.lAnticipo=1       
		and vIng.tEstadoDocumento='01'       
		and isnull(vIng.tCaja,'0')<>'0'       
		And vIng.tTipoPago = '01'      
		And (vIng.tTurno = @tTurno OR @tTurno IS NULL)                
		And (vIng.tUsuario = @tUsuario OR @tUsuario IS NULL)
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')              
		And ((vIng.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))-      
-- - xDolar      
	(select       
		ISNULL(SUM(dPag.nDolar * dPag.nTipoCambio),0) as xSuma       
	from       
		dpagodocumento as dPag  RIGHT OUTER JOIN dbo.MDOCUMENTO m ON dPag.tDocumento = m.tDocumento
 	    LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja     
	where       
 		dPag.tTipopago='01'       
 		and dPag.tMoneda='02'       
 		and isnull(dPag.tDocumento,'0')<>'0'       
 		And (dPag.tTurno = @tTurno OR @tTurno IS NULL)                
  		And (dPag.tUsuario = @tUsuario OR @tUsuario IS NULL)
  		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                 
  		And ((dPag.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))                
/**/      
      
   	+ ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '02' THEN dbo.DPAGODOCUMENTO.nDolar*dbo.DPAGODOCUMENTO.nTipoCambio ELSE 0 END),0)-      
    	(      
    	SELECT ISNULL(SUM(dPed.nDescuento),0)       
    	FROM MPedido as mPed Left Join DPedido as dPed On dPed.tCodigoPedido = mPed.tCodigoPedido Left Join MDocumento as mdoc On dPed.tDocumento  = mdoc.tDocumento LEFT JOIN dbo.TCAJA t ON mdoc.tCaja = t.tCaja      
    	Where mPed.tDescuento <> '' And isnull(mdoc.tCaja,'0')<>'0' And (mdoc.tTurno = @tTurno OR @tTurno IS NULL) And (mdoc.tUsuario = @tUsuario OR @tUsuario IS NULL) And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='') And ((mdoc.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))      
   	)      
   ,0))  
  
 + (SELECT  
 ISNULL(SUM(dPed.nDescuento),0)  
FROM  
  MPedido as mPed       
  Left Join vMotivoDescuento as vMot On mPed.tDescuento = vMot.Codigo      
  Left Join DPedido as dPed On dPed.tCodigoPedido = mPed.tCodigoPedido      
 Left Join MDocumento as mdoc On dPed.tDocumento  = mdoc.tDocumento
 LEFT JOIN dbo.TCAJA t ON mdoc.tCaja = t.tCaja       
Where  
  mPed.tDescuento <> ''  
  And isnull(mdoc.tCaja,'0')<>'0'  
  And (mdoc.tTurno = @tTurno OR @tTurno IS NULL)  
  And (mdoc.tUsuario = @tUsuario OR @tUsuario IS NULL)
  And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')  
  And ((mdoc.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))  
  
  
 As nVenta1,      
 0 As nVenta2,      
 '' AS Cantidad      
FROM                   
 dbo.MDOCUMENTO                   
 LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento 
 LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja      
WHERE                 
 dbo.DPAGODOCUMENTO.tTipoPago IN ('01','02','03','04','05')   And NOT((dbo.DPAGODOCUMENTO.ttipoPago = '01' and dbo.DPAGODOCUMENTO.tMoneda = '01'))      
 And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                 
 And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)              
 And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)   
 And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')           
 And ((DPAGODOCUMENTO.fdiacontable BETWEEN @fRegistroi AND @fRegistrof)               
  OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))    
--FONDOS-Efectivo Soles--------------------------------------------------------------------------------------------------------    
UNION                  
SELECT                   
 '03 FONDOS' as Titulo,                  
 'Efectivo  Soles - Propinas' AS Grupo,                   
 --SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '01' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END) As nVenta1,      
-- nEfectivoN + xEfectivoE        
0+( SELECT        
  ISNULL(SUM( CASE WHEN dPag.tMoneda = '01' THEN dPag.nMonto ELSE 0 END),0) +      
  ISNULL(SUM((CASE WHEN dPag.tMoneda = '02' THEN dPag.nMonto ELSE 0 END)*(dPag.nTipoCambio)),0)      
 FROM       
  dbo.DPAGODOCUMENTO as dPag RIGHT OUTER JOIN dbo.MDOCUMENTO m ON dPag.tDocumento = m.tDocumento
  LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja      
 WHERE       
  dPag.tTipoPago='01'       
  and isnull(dPag.tDocumento,'0')<>'0'       
  And (dPag.tTurno = @tTurno OR @tTurno IS NULL)                
  And (dPag.tUsuario = @tUsuario OR @tUsuario IS NULL)
  And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                 
  And ((dPag.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))-      
-- - nEgresoN      
(SELECT        
 ISNULL(SUM(CASE WHEN vEgr.tMoneda = '01' THEN vEgr.nMonto ELSE 0 END),0)      
FROM       
 dbo.vEgreso as vEgr LEFT JOIN dbo.TCAJA t ON vEgr.tCaja = t.tCaja       
WHERE       
 vEgr.tEstadoDocumento='01'       
 and isnull(vEgr.tCaja,'0')<>'0'       
 And (vEgr.tTurno = @tTurno OR @tTurno IS NULL)      
 And (vEgr.tUsuario = @tUsuario OR @tUsuario IS NULL)
 And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')      
 And ((vEgr.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))+                
+      
-- + nIngresoN + xIngresoE      
(SELECT       
 ISNULL(SUM(CASE WHEN vIng.tMoneda = '01' THEN vIng.nMonto ELSE 0 END),0) +       
 ISNULL(SUM((CASE WHEN vIng.tMoneda = '02' THEN vIng.nMonto ELSE 0 END)*(vIng.nTipoCambio)),0)      
FROM       
 dbo.vIngreso as vIng LEFT JOIN dbo.TCAJA t ON vIng.tCaja = t.tCaja       
WHERE       
 vIng.lAnticipo=0       
 and vIng.tEstadoDocumento='01'       
 and isnull(vIng.tCaja,'0')<>'0'       
 and vIng.tTipoPago ='01'       
 And (vIng.tTurno = @tTurno OR @tTurno IS NULL)      
 And (vIng.tUsuario = @tUsuario OR @tUsuario IS NULL)
 And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')      
 And ((vIng.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))+               
+      
--  + nIngresoAN + xIngresoAE      
(SELECT        
 ISNULL(SUM(CASE WHEN vIng.tMoneda = '01' THEN vIng.nMonto ELSE 0 END),0)+      
 ISNULL(SUM((CASE WHEN vIng.tMoneda = '02' THEN vIng.nMonto ELSE 0 END)*isnull((vIng.nTipoCambio),0)),0)      
FROM       
 dbo.vIngreso as vIng LEFT JOIN dbo.TCAJA t ON vIng.tCaja = t.tCaja     
WHERE       
 vIng.lAnticipo=1       
 and vIng.tEstadoDocumento='01'       
 and isnull(vIng.tCaja,'0')<>'0'       
 And vIng.tTipoPago = '01'      
 And (vIng.tTurno = @tTurno OR @tTurno IS NULL)                
 And (vIng.tUsuario = @tUsuario OR @tUsuario IS NULL)
 And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                 
 And ((vIng.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))-      
-- - xDolar      
( select       
   ISNULL(SUM(dPag.nDolar * dPag.nTipoCambio),0) as xSuma       
 from       
   dpagodocumento as dPag RIGHT OUTER JOIN dbo.MDOCUMENTO m ON dPag.tDocumento = m.tDocumento
   LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja     
 where       
   dPag.tTipopago='01'       
   and dPag.tMoneda='02'       
   and isnull(dPag.tDocumento,'0')<>'0'       
   And (dPag.tTurno = @tTurno OR @tTurno IS NULL)                
   And (dPag.tUsuario = @tUsuario OR @tUsuario IS NULL)
   And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                 
   And ((dPag.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))    
)-    
-- -Propinas    
		(    
	SELECT                   
		ISNULL(SUM(dbo.DPAGODOCUMENTO.nPropina),0) as xSuma    
		FROM                   
		dbo.TTARJETACREDITO                   
		RIGHT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.TTARJETACREDITO.tCodigoTarjeta = dbo.DPAGODOCUMENTO.tTarjeta                   
		RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento
		LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja                    
		WHERE                   
		dbo.DPAGODOCUMENTO.tTipoPago='02'                   
		And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
		And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
		And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
		And ((DPAGODOCUMENTO.fdiacontable BETWEEN @fRegistroi AND @fRegistrof)                 
		OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))                
		And dbo.DPAGODOCUMENTO.nPropina > 0       
		)                  
		AS nVenta1,        
		NULL As nVenta2,          
		'('+CONVERT(NVARCHAR,Count(*))+')' AS Cantidad                
		FROM                   
		dbo.MDOCUMENTO                   
		LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento
		LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja                    
		WHERE                   
		dbo.DPAGODOCUMENTO.tTipoPago='01'                   
		and isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
		And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
		And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
		And ((DPAGODOCUMENTO.fdiacontable BETWEEN @fRegistroi AND @fRegistrof)                 
		OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))                
--FONDOS-Efectivo Dolares--------------------------------------------------------------------------------------------------------                  
UNION                  
	SELECT      
		'03 FONDOS' as Titulo,                  
		'Efectivo Dolares        '+CONVERT(NVARCHAR,SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '02' THEN dbo.DPAGODOCUMENTO.nDolar ELSE 0 END)) AS Grupo,                
		SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '02' THEN dbo.DPAGODOCUMENTO.nDolar*dbo.DPAGODOCUMENTO.nTipoCambio ELSE 0 END)
		- ( 	SELECT ISNULL(SUM(CASE WHEN dbo.vEgreso.tMoneda = '02' THEN dbo.vEgreso.nMonto ELSE 0 END),0) As nVenta2      
			FROM  dbo.vEgreso LEFT JOIN dbo.TCAJA t ON vEgreso.tCaja = t.tCaja       
			WHERE  dbo.vEgreso.tEstadoDocumento='01'       
				and isnull(dbo.vEgreso.tCaja,'0')<>'0'       
				And (dbo.vEgreso.tTurno = @tTurno OR @tTurno IS NULL)       
				And (dbo.vEgreso.tUsuario = @tUsuario OR @tUsuario IS NULL)
				And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')      
				And ((dbo.vEgreso.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))        
		As nVenta1, NULL As nVenta2,                
		'('+CONVERT(NVARCHAR,Count(*))+')' AS Cantidad                
	FROM                   
		dbo.MDOCUMENTO                   
		LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento
		LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja               
	WHERE                   
		dbo.DPAGODOCUMENTO.tTipoPago='01'                   
		And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
		And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
		And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
		And ((DPAGODOCUMENTO.fdiacontable BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))      
--FONDOS-Tarjeta de Credito--------------------------------------------------------------------------------------------------------                  
UNION                  
	SELECT                   
		'03 FONDOS' as Titulo,                  
		'Tarjeta Crdito '/*+dbo.TTARJETACREDITO.tResumido*/ AS Grupo,                  
		SUM(dbo.DPAGODOCUMENTO.nMonto+dbo.DPAGODOCUMENTO.nPropina) as nVenta1, NULL As nVenta2,          
		'('+CONVERT(NVARCHAR,Count(*))+')' AS Cantidad                 
	FROM                   
		dbo.TTARJETACREDITO                   
		RIGHT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.TTARJETACREDITO.tCodigoTarjeta = dbo.DPAGODOCUMENTO.tTarjeta                   
		RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento
		LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja                    
	WHERE                   
		dbo.DPAGODOCUMENTO.tTipoPago='02'                   
		and isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
		And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
		And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                 
		And ((DPAGODOCUMENTO.fdiacontable BETWEEN @fRegistroi AND @fRegistrof)                 
		OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))                
--GROUP BY 'Tarjeta Crdito '+dbo.TTARJETACREDITO.tResumido                 
--FONDOS-Cheques/Depositos--------------------------------------------------------------------------------------------------------                  
UNION                  
	SELECT                   
		'03 FONDOS' as Titulo,                  
		'Cheques / Depositos    ' AS Grupo,                
		ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '01' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END)+           
		SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '02' THEN dbo.DPAGODOCUMENTO.nMonto*dbo.DPAGODOCUMENTO.nTipoCambio ELSE 0 END),0) As nVenta1, NULL As nVenta2,          
		'('+CONVERT(NVARCHAR,Count(*))+')' AS Cantidad                
	FROM                   
		dbo.MDOCUMENTO                   
		LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento
		LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja                    
	WHERE                   
		dbo.DPAGODOCUMENTO.tTipoPago='03'            
		And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
		And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
		And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
		And ((DPAGODOCUMENTO.fdiacontable BETWEEN @fRegistroi AND @fRegistrof)                 
		OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))                 
--FONDOS-Otros Pagos--------------------------------------------------------------------------------------------------------                  
UNION                  
	SELECT                   
		'03 FONDOS' as Titulo,                  
		'Otros Pagos / ' + vTip.Descripcion AS Grupo,                
		ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '01' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END),0)+      
		ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '02' THEN dbo.DPAGODOCUMENTO.nMonto*dbo.DPAGODOCUMENTO.nTipoCambio ELSE 0 END),0) As nVenta1, NULL As nVenta2,          
		'('+CONVERT(NVARCHAR,Count(*))+')' AS Cantidad                
	FROM                   
		dbo.MDOCUMENTO                   
		LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento                   
		LEFT OUTER JOIN dbo.vTipoCancelacion as vTip ON vTip.Codigo = dbo.DPAGODOCUMENTO.tOtroTipoPago
		LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja        
	WHERE                   
		dbo.DPAGODOCUMENTO.tTipoPago='04'            
		And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
		And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
		And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
		And ((DPAGODOCUMENTO.fdiacontable BETWEEN @fRegistroi AND @fRegistrof)                 
		OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))                 
		GROUP BY 'Otros Pagos / ' + vTip.Descripcion        
--FONDOS-Puntos--------------------------------------------------------------------------------------------------------                  
UNION                  
	SELECT                   
 		'03 FONDOS' as Titulo,                  
		'Puntos    ' AS Grupo,                
		ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '01' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END)+           
		SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '02' THEN dbo.DPAGODOCUMENTO.nMonto*dbo.DPAGODOCUMENTO.nTipoCambio ELSE 0 END),0) As nVenta1, NULL As nVenta2,          
		'('+CONVERT(NVARCHAR,Count(*))+')' AS Cantidad                
	FROM                   
 		dbo.MDOCUMENTO                   
 		LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento
 		LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja                    
	WHERE                   
		dbo.DPAGODOCUMENTO.tTipoPago='05'            
		And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
		And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
		And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
		And ((DPAGODOCUMENTO.fdiacontable BETWEEN @fRegistroi AND @fRegistrof)                 
		OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))                 
--LIQUIDACION DE TARJETAS DE CREDITO--------------------------------------------------------------------------------------------------------                  
UNION                  
	SELECT                   
		'04 LIQUIDACION DE TARJETAS DE CREDITO' as Titulo,                  
		dbo.TTARJETACREDITO.tResumido AS Grupo,                  
		SUM(dbo.DPAGODOCUMENTO.nMonto+dbo.DPAGODOCUMENTO.nPropina) as nVenta1, NULL As nVenta2,          
		'('+CONVERT(NVARCHAR,Count(*))+')' AS Cantidad                
	FROM                   
		dbo.TTARJETACREDITO                   
		RIGHT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.TTARJETACREDITO.tCodigoTarjeta = dbo.DPAGODOCUMENTO.tTarjeta                   
		RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento
		LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja                    
	WHERE                   
		dbo.DPAGODOCUMENTO.tTipoPago='02'                   
		and isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'                   
		And (DPAGODOCUMENTO.tTurno = @tTurno OR @tTurno IS NULL)                
		And (DPAGODOCUMENTO.tUsuario = @tUsuario OR @tUsuario IS NULL)
		And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')                
		And ((DPAGODOCUMENTO.fdiacontable BETWEEN @fRegistroi AND @fRegistrof)                 
		OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))              
		GROUP BY dbo.TTARJETACREDITO.tResumido
END





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE spRep_Comanda
@flagTipo as bit,
@SOrden as nvarchar(50),
@fInicio as smalldatetime,
@fFinal as smalldatetime
/*modificado el procedimiento*/
AS BEGIN
set nocount on
   if @flagtipo=1
	begin
		CREATE TABLE #DBTRANS (tCodigoPedido nVarChar(10) collate Modern_Spanish_CI_AS, tComanda nVarChar(10) collate Modern_Spanish_CI_AS, NombreProducto nVarChar(60) collate Modern_Spanish_CI_AS, Mozo nVarChar(30) collate Modern_Spanish_CI_AS, nCantidad Float, PrecioUnitario Float, PrecioTotal Float, fFecha smalldatetime, Usuario nVarChar(15) collate Modern_Spanish_CI_AS, tDocumento nVarChar(20) collate Modern_Spanish_CI_AS, Estado nVarChar(1) collate Modern_Spanish_CI_AS, tObservacion nVarChar(250) collate Modern_Spanish_CI_AS)
	
		Insert Into #DBTRANS(tCodigoPedido, tComanda, NombreProducto, Mozo, nCantidad, PrecioUnitario, PrecioTotal, fFecha, Usuario, tDocumento, Estado, tObservacion) 
           		    Select dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tComanda AS tComanda, dbo.TPRODUCTO.tResumido AS NombreProducto, dbo.vMozo.tResumido AS Mozo, dbo.DPEDIDO.nCantidad AS Cantidad, dbo.DPEDIDO.nPrecioVenta AS PrecioUnitario, dbo.DPEDIDO.nVenta AS PrecioTotal, dbo.MPedido.fFecha,dbo.MPedido.tUsuario As Usuario, dbo.DPEDIDO.tDocumento, dbo.DPEDIDO.tEstadoItem AS Estado, dbo.MPEDIDO.tObservacionAnulado as tObservacion 
           		    FROM dbo.MPedido LEFT OUTER JOIN  dbo.vMozo ON dbo.MPedido.tMozo = dbo.vMozo.Codigo RIGHT OUTER JOIN  dbo.DPEDIDO LEFT OUTER JOIN dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto ON  dbo.MPedido.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido 
           		    Where MPEDIDO.fFecha >= @finicio and mpedido.fFecha <= @ffinal


		Insert Into #DBTRANS (tCodigoPedido, tComanda, NombreProducto, Mozo, nCantidad, PrecioUnitario, PrecioTotal, fFecha, Usuario, Estado, tObservacion) 
		             Select dbo.APEDIDO.tCodigoPedido, dbo.APEDIDO.tComanda AS tComanda, dbo.TPRODUCTO.tResumido AS NombreProducto, dbo.vMozo.tResumido AS Mozo, dbo.APEDIDO.nCantidad AS Cantidad, dbo.APEDIDO.nPrecioVenta AS PrecioUnitario, dbo.APEDIDO.nVenta AS PrecioTotal, dbo.MPedido.fFecha,dbo.APedido.tUsuarioAnulado As Usuario, 'E' AS Estado, dbo.APEDIDO.tObservacion 
		            FROM dbo.MPedido LEFT OUTER JOIN  dbo.vMozo ON dbo.MPedido.tMozo = dbo.vMozo.Codigo RIGHT OUTER JOIN  dbo.APEDIDO LEFT OUTER JOIN dbo.TPRODUCTO ON dbo.APEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto ON  dbo.MPedido.tCodigoPedido = dbo.APEDIDO.tCodigoPedido 
		             Where MPEDIDO.fFecha >= @finicio and mpedido.fFecha <= @ffinal 
       
		select * from #DBTRANS order by case @sOrden when 'PEDIDO' then tcodigopedido else tcomanda end 
	end
   else
	begin
		 if @sOrden='PEDIDO'
			BEGIN
				

				 Select Distinct dbo.DPEDIDO.tCodigoPedido, Case When Count(Distinct DPEDIDO.tComanda)>1 Then  'Varios' Else Max(DPedido.tComanda) End as tcomanda, 
           			 dbo.vMozo.tResumido AS Mozo, Sum(DPEDIDO.nCantidad) As Cantidad, Sum(DPEDIDO.nPrecioVenta) As PrecioUnitario, Sum(DPEDIDO.nVenta)As PrecioTotal, MPedido.fFecha,dbo.MPedido.tUsuario As Usuario,dbo.vEstadoPedido.tResumido AS Estado 
           			FROM dbo.MPedido LEFT OUTER JOIN dbo.vEstadoPedido ON dbo.MPedido.tEstadoPedido = dbo.vEstadoPedido.Codigo Left Outer Join dbo.vMozo ON dbo.MPedido.tMozo = dbo.vMozo.Codigo Right Outer Join  dbo.DPEDIDO LEFT OUTER JOIN dbo.TPRODUCTO ON dbo.DPedido.tCodigoProducto = dbo.tProducto.tCodigoProducto ON dbo.MPedido.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido 
           			  Where MPEDIDO.fFecha >= @finicio and mpedido.fFecha <= @ffinal
 	   			 Group By DPEDIDO.tCodigoPedido,vMozo.tResumido,MPedido.fFecha,MPedido.tUsuario,vEstadoPedido.tResumido 
				order by  dpedido.tCodigoPedido asc
			END
		else
			BEGIN
				Select Distinct dbo.DPEDIDO.tCodigoPedido, Case When Count(Distinct DPEDIDO.tComanda)>1 Then  'Varios' Else Max(DPedido.tComanda) End as tcomanda, 
           			 dbo.vMozo.tResumido AS Mozo, Sum(DPEDIDO.nCantidad) As Cantidad, Sum(DPEDIDO.nPrecioVenta) As PrecioUnitario, Sum(DPEDIDO.nVenta)As PrecioTotal, MPedido.fFecha,dbo.MPedido.tUsuario As Usuario,dbo.vEstadoPedido.tResumido AS Estado 
           			FROM dbo.MPedido LEFT OUTER JOIN dbo.vEstadoPedido ON dbo.MPedido.tEstadoPedido = dbo.vEstadoPedido.Codigo Left Outer Join dbo.vMozo ON dbo.MPedido.tMozo = dbo.vMozo.Codigo Right Outer Join  dbo.DPEDIDO LEFT OUTER JOIN dbo.TPRODUCTO ON dbo.DPedido.tCodigoProducto = dbo.tProducto.tCodigoProducto ON dbo.MPedido.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido 
           			  Where MPEDIDO.fFecha >= @finicio and mpedido.fFecha <= @ffinal
 	   			 Group By DPEDIDO.tCodigoPedido,vMozo.tResumido,MPedido.fFecha,MPedido.tUsuario,vEstadoPedido.tResumido 
				order by  2 asc	
		END   
	end
END

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


GO
/****** Object:  StoredProcedure [dbo].[spRep_Cortesia]    Script Date: 05/31/2013 09:38:32 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE PROCEDURE [dbo].[spRep_Cortesia]
@tipo as varchar(10),
@fInicio as smalldatetime,
@fFinal as smalldatetime,
@Forma as varchar(1),
@tipoX as varchar(20)

AS BEGIN
set nocount on

			CREATE TABLE #DBTRANS (
			Grupo nVarchar(4)	collate Modern_Spanish_CI_AS,
			tDocumento nVarchar(20) 	collate Modern_Spanish_CI_AS,
			Descripcion nvarchar(50) 	collate Modern_Spanish_CI_AS,
			tipoProducto nVarchar(100)	collate Modern_Spanish_CI_AS,
			tTipoDocumento nVarchar(10)	collate Modern_Spanish_CI_AS,
			tCortesia nVarchar(50)	collate Modern_Spanish_CI_AS,
			nPrecioImpuesto1 float,
			nPrecioImpuesto2 float,
			nPrecioImpuesto3 float,
			nVenta float,
			nRecargo	float,
			nDescuento	float,
			tEstadoDocumento nVarchar(20)	collate Modern_Spanish_CI_AS,
			Ubicacion nVarchar(100)	collate Modern_Spanish_CI_AS,
			tTipoPedido nvarchar(4) collate Modern_Spanish_CI_AS)
			
			CREATE TABLE #DBTRANS1 (
			Grupo nVarchar(4)	collate Modern_Spanish_CI_AS,
			tDocumento nVarchar(20) 	collate Modern_Spanish_CI_AS,
			Descripcion nvarchar(50) 	collate Modern_Spanish_CI_AS,
			fRegistro datetime,
			tTipoDocumento nVarchar(10)	collate Modern_Spanish_CI_AS,
			tCortesia nVarchar(50)	collate Modern_Spanish_CI_AS,
			nPrecioImpuesto1 float,
			nPrecioImpuesto2 float,
			nPrecioImpuesto3 float,
			nVenta float,
			nRecargo	float,
			nDescuento	float,
			tEstadoDocumento nVarchar(20)	collate Modern_Spanish_CI_AS,
			Ubicacion nVarchar(200)	collate Modern_Spanish_CI_AS,
			tCodigoProducto nvarchar(20) collate Modern_Spanish_CI_AS,
			tDetallado nvarchar(50) collate Modern_Spanish_CI_AS,
			nPrecioVenta float,
			nCantidad float, nVentaD float, ttipopedido nvarchar(20) collate Modern_Spanish_CI_AS)
			
			CREATE TABLE #DBTRANS2 (tDocumento nVarchar(20) collate Modern_Spanish_CI_AS, tTipoDocumento nVarchar(20) collate Modern_Spanish_CI_AS, 
			tCortesia nVarchar(20) collate Modern_Spanish_CI_AS, Grupo nVarchar(50) collate Modern_Spanish_CI_AS,Subgrupo nVarchar(50) collate Modern_Spanish_CI_AS, 
			Codigo nVarchar(7) collate Modern_Spanish_CI_AS, Producto nVarchar(50) collate Modern_Spanish_CI_AS,
			Neto  float, Costo  float, Cantidad Float, nPrecioOficial Float,tTipoPedido nVarchar(5) collate Modern_Spanish_CI_AS,
			tAgrupacion nVarchar(100) collate Modern_Spanish_CI_AS)


IF @tipo='RESUMIDO'
	BEGIN
		IF @forma='1' -- precio venta	
		BEGIN
		    INSERT INTO #DBTRANS 
			SELECT CASE dbo.MDOCUMENTO.tTipoDocumento WHEN '00' THEN '01' ELSE '02' END AS Grupo, 
			dbo.MDOCUMENTO.tDocumento, dbo.vCortesia.Descripcion, 
			convert(nvarchar(20), dbo.MDOCUMENTO.fRegistro,103), 
			dbo.MDOCUMENTO.tTipoDocumento, 
			dbo.MDOCUMENTO.tCortesia,
			dbo.MDOCUMENTO.nPrecioImpuesto1, 
			dbo.MDOCUMENTO.nPrecioImpuesto2, 
			dbo.MDOCUMENTO.nPrecioImpuesto3, 
			dbo.MDOCUMENTO.nVenta, 
			dbo.MDOCUMENTO.nRecargo, 
			dbo.MDOCUMENTO.nDescuento, 
			dbo.MDOCUMENTO.tEstadoDocumento, 
			MAX( substring( CASE dbo.MPEDIDO.tMesa WHEN '' THEN dbo.MPEDIDO.tObservacion ELSE dbo.MPEDIDO.tObservacion+ ' ' + ltrim(dbo.vSalon.Descripcion) + ' - ' + dbo.TMESA.tDetallado END ,1,50)) AS Ubicacion,
			dbo.mpedido.ttipopedido 
			FROM dbo.vCortesia RIGHT OUTER JOIN dbo.MPEDIDO RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ON dbo.vCortesia.Codigo = dbo.MDOCUMENTO.tCortesia LEFT OUTER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa
			WHERE dbo.MDOCUMENTO.tEstadoDocumento<>'04' and (isnull(dbo.MDOCUMENTO.tCortesia,'0')<>'0' and len(ltrim(dbo.MDOCUMENTO.tCortesia))<>0) AND MDOCUMENTO.fRegistro>=@FINICIO AND MDOCUMENTO.FREGISTRO<=@FFINAL
			GROUP BY dbo.MDOCUMENTO.tTipoDocumento, dbo.MDOCUMENTO.tDocumento, dbo.vCortesia.Descripcion, dbo.MDOCUMENTO.fRegistro, dbo.MDOCUMENTO.tCortesia, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, dbo.MDOCUMENTO.nVenta , dbo.MDOCUMENTO.nRecargo, dbo.MDOCUMENTO.nDescuento, dbo.MDOCUMENTO.tEstadoDocumento,dbo.mpedido.ttipopedido 
		END

		IF @forma='2'-- precio neto
		BEGIN
		    INSERT INTO #DBTRANS 
			SELECT CASE dbo.MDOCUMENTO.tTipoDocumento WHEN '00' THEN '01' ELSE '02' END AS Grupo, 
			dbo.MDOCUMENTO.tDocumento, dbo.vCortesia.Descripcion, 
			convert(nvarchar(20), dbo.MDOCUMENTO.fRegistro,103), 
			dbo.MDOCUMENTO.tTipoDocumento, 
			dbo.MDOCUMENTO.tCortesia,
			0 As nPrecioImpuesto1, 
			0 As nPrecioImpuesto2, 
			0 As nPrecioImpuesto3, 
			SUM(DPEDIDO.NPRECIONETO*DPEDIDO.NCANTIDAD) As nVenta, 
			dbo.MDOCUMENTO.nRecargo, 
			dbo.MDOCUMENTO.nDescuento, 
			dbo.MDOCUMENTO.tEstadoDocumento, 
			MAX(substring( CASE dbo.MPEDIDO.tMesa WHEN '' THEN dbo.MPEDIDO.tObservacion ELSE dbo.MPEDIDO.tObservacion+ ' ' + ltrim(dbo.vSalon.Descripcion) + ' - ' + dbo.TMESA.tDetallado END ,1,50)) AS Ubicacion,
			dbo.mpedido.ttipopedido 
			FROM dbo.vCortesia RIGHT OUTER JOIN dbo.MPEDIDO RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ON dbo.vCortesia.Codigo = dbo.MDOCUMENTO.tCortesia LEFT OUTER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa
			WHERE dbo.MDOCUMENTO.tEstadoDocumento<>'04' and (isnull(dbo.MDOCUMENTO.tCortesia,'0')<>'0' and len(ltrim(dbo.MDOCUMENTO.tCortesia))<>0) AND MDOCUMENTO.fRegistro>=@FINICIO AND MDOCUMENTO.FREGISTRO<=@FFINAL
			GROUP BY dbo.MDOCUMENTO.tTipoDocumento, dbo.MDOCUMENTO.tDocumento, dbo.vCortesia.Descripcion, dbo.MDOCUMENTO.fRegistro, dbo.MDOCUMENTO.tCortesia, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, dbo.MDOCUMENTO.nVenta , dbo.MDOCUMENTO.nRecargo, dbo.MDOCUMENTO.nDescuento, dbo.MDOCUMENTO.tEstadoDocumento,dbo.mpedido.ttipopedido 

		END 
		
		IF @forma='3'-- precio costos
		BEGIN
		    INSERT INTO #DBTRANS 
			SELECT CASE dbo.MDOCUMENTO.tTipoDocumento WHEN '00' THEN '01' ELSE '02' END AS Grupo, 
			dbo.MDOCUMENTO.tDocumento, dbo.vCortesia.Descripcion, 
			convert(nvarchar(20), dbo.MDOCUMENTO.fRegistro,103), 
			dbo.MDOCUMENTO.tTipoDocumento, 
			dbo.MDOCUMENTO.tCortesia,
			0 As nPrecioImpuesto1, 
			0 As nPrecioImpuesto2, 
			0 As nPrecioImpuesto3, 
			SUM((ISNULL(DPEDIDO.NINSUMO,0)+ISNULL(DPEDIDO.NGASTO,0)+ISNULL(DPEDIDO.NMANOOBRA,0))*DPEDIDO.NCANTIDAD) As nVenta, 
			dbo.MDOCUMENTO.nRecargo, 
			dbo.MDOCUMENTO.nDescuento, 
			dbo.MDOCUMENTO.tEstadoDocumento, 
			MAX(substring( CASE dbo.MPEDIDO.tMesa WHEN '' THEN dbo.MPEDIDO.tObservacion ELSE dbo.MPEDIDO.tObservacion+ ' ' + ltrim(dbo.vSalon.Descripcion) + ' - ' + dbo.TMESA.tDetallado END ,1,50)) AS Ubicacion,
			dbo.mpedido.ttipopedido 
			FROM dbo.vCortesia RIGHT OUTER JOIN dbo.MPEDIDO RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ON dbo.vCortesia.Codigo = dbo.MDOCUMENTO.tCortesia LEFT OUTER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa
			WHERE dbo.MDOCUMENTO.tEstadoDocumento<>'04' and (isnull(dbo.MDOCUMENTO.tCortesia,'0')<>'0' and len(ltrim(dbo.MDOCUMENTO.tCortesia))<>0) AND MDOCUMENTO.fRegistro>=@FINICIO AND MDOCUMENTO.FREGISTRO<=@FFINAL
			GROUP BY dbo.MDOCUMENTO.tTipoDocumento, dbo.MDOCUMENTO.tDocumento, dbo.vCortesia.Descripcion, dbo.MDOCUMENTO.fRegistro, dbo.MDOCUMENTO.tCortesia, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, dbo.MDOCUMENTO.nVenta , dbo.MDOCUMENTO.nRecargo, dbo.MDOCUMENTO.nDescuento, dbo.MDOCUMENTO.tEstadoDocumento,dbo.mpedido.ttipopedido 
			
			
			UPDATE dbo.#DBTRANS SET nVenta = nVenta + T2.Costo
			FROM dbo.#DBTRANS  INNER JOIN 
			(SELECT dbo.DDOCUMENTO.tDocumento, dbo.DDOCUMENTO.tCodigoProducto ,SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) As Costo FROM CPEDIDO 
			INNER JOIN dbo.DDOCUMENTO ON dbo.CPEDIDO.tCodigoPedido =  dbo.DDOCUMENTO.tCodigoPedido  AND dbo.CPEDIDO.tProducto = dbo.DDOCUMENTO.tCodigoProducto Group By dbo.DDOCUMENTO.tDocumento, dbo.DDOCUMENTO.tCodigoProducto) As T2
			ON dbo.#DBTRANS.tDocumento = T2.tDocumento
		    
		END 		
		--SELECT * FROM #DBTRANS 		
	END
	
	
	
--------------DETALLADO	
IF @tipo='DETALLADO'
BEGIN
  IF @tipoX = 'VENTA'
     BEGIN		
				IF @forma='1' -- precio venta	
						INSERT INTO #DBTRANS1 		
						SELECT CASE dbo.MDOCUMENTO.tTipoDocumento WHEN '00' THEN '01' ELSE '02' END AS Grupo,
						dbo.MDOCUMENTO.tDocumento, 
						dbo.vCortesia.Descripcion, 
						dbo.MDOCUMENTO.fRegistro, 
						dbo.MDOCUMENTO.tTipoDocumento, 
						dbo.MDOCUMENTO.tCortesia, 
						dbo.MDOCUMENTO.nPrecioImpuesto1, 
						dbo.MDOCUMENTO.nPrecioImpuesto2, 
						dbo.MDOCUMENTO.nPrecioImpuesto3, 
						dbo.MDOCUMENTO.nVenta, 
						dbo.MDOCUMENTO.nRecargo, 
						dbo.MDOCUMENTO.nDescuento, 
						dbo.MDOCUMENTO.tEstadoDocumento, 
						substring( CASE dbo.MPEDIDO.tMesa WHEN '' THEN dbo.MPEDIDO.tObservacion ELSE dbo.MPEDIDO.tObservacion+ ' ' + ltrim(dbo.vSalon.Descripcion) + ' - ' + dbo.TMESA.tDetallado END ,1,50) AS Ubicacion, dbo.DPEDIDO.tCodigoProducto, 
					    dbo.TPRODUCTO.tDetallado, 
						dbo.DPEDIDO.nPrecioVenta, 
						dbo.DPEDIDO.nCantidad, 
						dbo.DPEDIDO.nVenta As nVentaD,
						--dbo.DPEDIDO.nVenta,
						dbo.mpedido.ttipopedido  
						FROM dbo.MDOCUMENTO left join dbo.vCortesia on dbo.MDOCUMENTO.tCortesia = dbo.vCortesia.Codigo left join dbo.DPEDIDO on dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento left join dbo.MPEDIDO on dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido left join dbo.TMESA on dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa left join dbo.vSalon on dbo.TMESA.tSalon = dbo.vSalon.codigo left join dbo.TPRODUCTO on dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto 
						WHERE dbo.MDOCUMENTO.tEstadoDocumento<>'04' and (isnull(dbo.MDOCUMENTO.tCortesia,'0')<>'0' and len(ltrim(dbo.MDOCUMENTO.tCortesia))<>0) AND MDOCUMENTO.fRegistro>=@FINICIO AND MDOCUMENTO.FREGISTRO<=@FFINAL

				IF @Forma='2' -- precio neto
				        INSERT INTO #DBTRANS1 
						SELECT CASE dbo.MDOCUMENTO.tTipoDocumento WHEN '00' THEN '01' ELSE '02' END AS Grupo,
						dbo.MDOCUMENTO.tDocumento, 
						dbo.vCortesia.Descripcion, 
						dbo.MDOCUMENTO.fRegistro, 
						dbo.MDOCUMENTO.tTipoDocumento, 
						dbo.MDOCUMENTO.tCortesia, 
						dbo.MDOCUMENTO.nPrecioImpuesto1, 
						dbo.MDOCUMENTO.nPrecioImpuesto2, 
						dbo.MDOCUMENTO.nPrecioImpuesto3, 
						dbo.MDOCUMENTO.nVenta, 
						dbo.MDOCUMENTO.nRecargo, 
						dbo.MDOCUMENTO.nDescuento, 
						dbo.MDOCUMENTO.tEstadoDocumento, 
					    substring( CASE dbo.MPEDIDO.tMesa WHEN '' THEN dbo.MPEDIDO.tObservacion ELSE dbo.MPEDIDO.tObservacion+ ' ' + ltrim(dbo.vSalon.Descripcion) + ' - ' + dbo.TMESA.tDetallado END ,1,50) AS Ubicacion, dbo.DPEDIDO.tCodigoProducto, 
					    dbo.TPRODUCTO.tDetallado, 
						dbo.DPEDIDO.nPrecioNeto As nPrecioVenta, 
						dbo.DPEDIDO.nCantidad, 
						(dbo.DPEDIDO.nprecioneto * ncantidad) As nVentaD,
						dbo.mpedido.ttipopedido  
						FROM dbo.MDOCUMENTO left join dbo.vCortesia on dbo.MDOCUMENTO.tCortesia = dbo.vCortesia.Codigo left join dbo.DPEDIDO on dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento left join dbo.MPEDIDO on dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido left join dbo.TMESA on dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa left join dbo.vSalon on dbo.TMESA.tSalon = dbo.vSalon.codigo left join dbo.TPRODUCTO on dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto 
						WHERE dbo.MDOCUMENTO.tEstadoDocumento<>'04' and (isnull(dbo.MDOCUMENTO.tCortesia,'0')<>'0' and len(ltrim(dbo.MDOCUMENTO.tCortesia))<>0) AND MDOCUMENTO.fRegistro>=@FINICIO AND MDOCUMENTO.FREGISTRO<=@FFINAL
				
				IF @Forma='3' -- precio costo
				  BEGIN
				        INSERT INTO #DBTRANS1 
						SELECT CASE dbo.MDOCUMENTO.tTipoDocumento WHEN '00' THEN '01' ELSE '02' END AS Grupo,
						dbo.MDOCUMENTO.tDocumento, 
						dbo.vCortesia.Descripcion, 
						dbo.MDOCUMENTO.fRegistro, 
						dbo.MDOCUMENTO.tTipoDocumento, 
						dbo.MDOCUMENTO.tCortesia, 
						dbo.MDOCUMENTO.nPrecioImpuesto1, 
						dbo.MDOCUMENTO.nPrecioImpuesto2, 
						dbo.MDOCUMENTO.nPrecioImpuesto3, 
						dbo.MDOCUMENTO.nVenta, 
						dbo.MDOCUMENTO.nRecargo, 
						dbo.MDOCUMENTO.nDescuento, 
						dbo.MDOCUMENTO.tEstadoDocumento, 
						substring( CASE dbo.MPEDIDO.tMesa WHEN '' THEN dbo.MPEDIDO.tObservacion ELSE dbo.MPEDIDO.tObservacion+ ' ' + ltrim(dbo.vSalon.Descripcion) + ' - ' + dbo.TMESA.tDetallado END ,1,50) AS Ubicacion, dbo.DPEDIDO.tCodigoProducto, 
					    dbo.TPRODUCTO.tDetallado, 
					    (isnull(dpedido.ninsumo,0) + isnull(dpedido.ngasto,0) + isnull(dpedido.nmanoobra,0)) As nPrecioVenta,
						dbo.DPEDIDO.nCantidad, 
						((isnull(dpedido.ninsumo,0) + isnull(dpedido.ngasto,0) + isnull(dpedido.nmanoobra,0)) * dbo.DPEDIDO.nCantidad) as nventaD,
						dbo.mpedido.ttipopedido  
						FROM dbo.MDOCUMENTO left join dbo.vCortesia on dbo.MDOCUMENTO.tCortesia = dbo.vCortesia.Codigo 
						left join dbo.DPEDIDO on dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento 
						left join dbo.MPEDIDO on dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido 
						left join dbo.TMESA on dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa left join dbo.vSalon on dbo.TMESA.tSalon = dbo.vSalon.codigo 
						left join dbo.TPRODUCTO on dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto  
						WHERE dbo.MDOCUMENTO.tEstadoDocumento<>'04' and (isnull(dbo.MDOCUMENTO.tCortesia,'0')<>'0' and len(ltrim(dbo.MDOCUMENTO.tCortesia))<>0) AND MDOCUMENTO.fRegistro>=@FINICIO AND MDOCUMENTO.FREGISTRO<=@FFINAL
				
				
						UPDATE dbo.#DBTRANS1 SET nPrecioVenta = Venta, nventaD = T2.Costo
						FROM dbo.#DBTRANS1  INNER JOIN 
						(SELECT dbo.DDOCUMENTO.tDocumento,dbo.DDOCUMENTO.tCodigoProducto, SUM(ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) As Venta,
						SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) As Costo 
						FROM CPEDIDO INNER JOIN dbo.DDOCUMENTO
						ON dbo.CPEDIDO.tCodigoPedido =  dbo.DDOCUMENTO.tCodigoPedido AND dbo.CPEDIDO.tProducto = dbo.DDOCUMENTO.tCodigoProducto 
						GROUP BY dbo.DDOCUMENTO.tDocumento,dbo.DDOCUMENTO.tCodigoProducto) As T2
						ON dbo.#DBTRANS1.tDocumento = T2.tDocumento AND dbo.#DBTRANS1.tCodigoProducto = T2.tCodigoProducto 
                    END
	 END

   
  IF @tipoX = 'COMBO'
	 BEGIN
				IF @forma='1' -- precio venta	
						INSERT INTO #DBTRANS1 		
						SELECT CASE dbo.MDOCUMENTO.tTipoDocumento WHEN '00' THEN '01' ELSE '02' END AS Grupo,
						dbo.MDOCUMENTO.tDocumento, 
						dbo.vCortesia.Descripcion, 
						dbo.MDOCUMENTO.fRegistro, 
						dbo.MDOCUMENTO.tTipoDocumento, 
						dbo.MDOCUMENTO.tCortesia, 
						dbo.MDOCUMENTO.nPrecioImpuesto1, 
						dbo.MDOCUMENTO.nPrecioImpuesto2, 
						dbo.MDOCUMENTO.nPrecioImpuesto3, 
						dbo.MDOCUMENTO.nVenta, 
						dbo.MDOCUMENTO.nRecargo, 
						dbo.MDOCUMENTO.nDescuento, 
						dbo.MDOCUMENTO.tEstadoDocumento, 
						substring( CASE dbo.MPEDIDO.tMesa WHEN '' THEN dbo.MPEDIDO.tObservacion ELSE dbo.MPEDIDO.tObservacion+ ' ' + ltrim(dbo.vSalon.Descripcion) + ' - ' + dbo.TMESA.tDetallado END ,1,50) AS Ubicacion, dbo.DPEDIDO.tCodigoProducto, 
					    dbo.TPRODUCTO.tDetallado, 
						dbo.CPEDIDO.nVenta As nPrecioVenta, 
						dbo.CPEDIDO.nCantidad, 
						dbo.CPEDIDO.nVenta As nVentaD,
						--dbo.DPEDIDO.nVenta,
						dbo.mpedido.ttipopedido  
						FROM dbo.MDOCUMENTO left join dbo.vCortesia on dbo.MDOCUMENTO.tCortesia = dbo.vCortesia.Codigo 
						left join dbo.DPEDIDO on dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento 
						left join dbo.MPEDIDO on dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido 
						left join dbo.TMESA on dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa 
						left join dbo.vSalon on dbo.TMESA.tSalon = dbo.vSalon.codigo 
						INNER JOIN dbo.CPEDIDO ON  dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido  AND dbo.DPEDIDO.tCodigoProducto = dbo.CPEDIDO.tProducto
						LEFT JOIN dbo.TPRODUCTO ON dbo.CPEDIDO.tProductoCombo = dbo.TPRODUCTO.tCodigoProducto
						WHERE dbo.MDOCUMENTO.tEstadoDocumento<>'04' and (isnull(dbo.MDOCUMENTO.tCortesia,'0')<>'0' and len(ltrim(dbo.MDOCUMENTO.tCortesia))<>0) AND MDOCUMENTO.fRegistro>=@FINICIO AND MDOCUMENTO.FREGISTRO<=@FFINAL

				IF @Forma='2' -- precio neto
				        INSERT INTO #DBTRANS1 
						SELECT CASE dbo.MDOCUMENTO.tTipoDocumento WHEN '00' THEN '01' ELSE '02' END AS Grupo,
						dbo.MDOCUMENTO.tDocumento, 
						dbo.vCortesia.Descripcion, 
						dbo.MDOCUMENTO.fRegistro, 
						dbo.MDOCUMENTO.tTipoDocumento, 
						dbo.MDOCUMENTO.tCortesia, 
						dbo.MDOCUMENTO.nPrecioImpuesto1, 
						dbo.MDOCUMENTO.nPrecioImpuesto2, 
						dbo.MDOCUMENTO.nPrecioImpuesto3, 
						dbo.MDOCUMENTO.nVenta, 
						dbo.MDOCUMENTO.nRecargo, 
						dbo.MDOCUMENTO.nDescuento, 
						dbo.MDOCUMENTO.tEstadoDocumento, 
					    substring( CASE dbo.MPEDIDO.tMesa WHEN '' THEN dbo.MPEDIDO.tObservacion ELSE dbo.MPEDIDO.tObservacion+ ' ' + ltrim(dbo.vSalon.Descripcion) + ' - ' + dbo.TMESA.tDetallado END ,1,50) AS Ubicacion, dbo.DPEDIDO.tCodigoProducto, 
					    dbo.TPRODUCTO.tDetallado, 
						dbo.CPEDIDO.nPrecioNeto As nPrecioVenta, 
						dbo.CPEDIDO.nCantidad, 
						(dbo.CPEDIDO.nPrecioNeto * dbo.CPEDIDO.nCantidad) As nVentaD,
						dbo.mpedido.ttipopedido  
						FROM dbo.MDOCUMENTO left join dbo.vCortesia on dbo.MDOCUMENTO.tCortesia = dbo.vCortesia.Codigo 
						left join dbo.DPEDIDO on dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento 
						left join dbo.MPEDIDO on dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido 
						left join dbo.TMESA on dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa 
						left join dbo.vSalon on dbo.TMESA.tSalon = dbo.vSalon.codigo 
						INNER JOIN dbo.CPEDIDO ON  dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido  AND dbo.DPEDIDO.tCodigoProducto = dbo.CPEDIDO.tProducto
						LEFT JOIN dbo.TPRODUCTO ON dbo.CPEDIDO.tProductoCombo = dbo.TPRODUCTO.tCodigoProducto
						WHERE dbo.MDOCUMENTO.tEstadoDocumento<>'04' and (isnull(dbo.MDOCUMENTO.tCortesia,'0')<>'0' and len(ltrim(dbo.MDOCUMENTO.tCortesia))<>0) AND MDOCUMENTO.fRegistro>=@FINICIO AND MDOCUMENTO.FREGISTRO<=@FFINAL

				IF @Forma='3' -- precio costo
				        INSERT INTO #DBTRANS1 
						SELECT CASE dbo.MDOCUMENTO.tTipoDocumento WHEN '00' THEN '01' ELSE '02' END AS Grupo,
						dbo.MDOCUMENTO.tDocumento, 
						dbo.vCortesia.Descripcion, 
						dbo.MDOCUMENTO.fRegistro, 
						dbo.MDOCUMENTO.tTipoDocumento, 
						dbo.MDOCUMENTO.tCortesia, 
						dbo.MDOCUMENTO.nPrecioImpuesto1, 
						dbo.MDOCUMENTO.nPrecioImpuesto2, 
						dbo.MDOCUMENTO.nPrecioImpuesto3, 
						dbo.MDOCUMENTO.nVenta, 
						dbo.MDOCUMENTO.nRecargo, 
						dbo.MDOCUMENTO.nDescuento, 
						dbo.MDOCUMENTO.tEstadoDocumento, 
						SUBSTRING( CASE dbo.MPEDIDO.tMesa WHEN '' THEN dbo.MPEDIDO.tObservacion ELSE dbo.MPEDIDO.tObservacion+ ' ' + ltrim(dbo.vSalon.Descripcion) + ' - ' + dbo.TMESA.tDetallado END ,1,50) AS Ubicacion, dbo.DPEDIDO.tCodigoProducto, 
					    dbo.TPRODUCTO.tDetallado, 
					    SUM(ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) As nPrecioVenta,
						dbo.CPEDIDO.nCantidad, 
						SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) as nventaD,
						dbo.mpedido.ttipopedido  
						FROM dbo.MDOCUMENTO left join dbo.vCortesia on dbo.MDOCUMENTO.tCortesia = dbo.vCortesia.Codigo 
						left join dbo.DPEDIDO on dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento 
						left join dbo.MPEDIDO on dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido 
						left join dbo.TMESA on dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa left join dbo.vSalon on dbo.TMESA.tSalon = dbo.vSalon.codigo 
						INNER JOIN dbo.CPEDIDO ON  dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido  AND dbo.DPEDIDO.tCodigoProducto = dbo.CPEDIDO.tProducto
						LEFT JOIN dbo.TPRODUCTO ON dbo.CPEDIDO.tProductoCombo = dbo.TPRODUCTO.tCodigoProducto 
						WHERE dbo.MDOCUMENTO.tEstadoDocumento<>'04' and (isnull(dbo.MDOCUMENTO.tCortesia,'0')<>'0' and len(ltrim(dbo.MDOCUMENTO.tCortesia))<>0) AND MDOCUMENTO.fRegistro>=@FINICIO AND MDOCUMENTO.FREGISTRO<=@FFINAL
				        GROUP BY dbo.MDOCUMENTO.tTipoDocumento, dbo.MDOCUMENTO.tDocumento, dbo.vCortesia.Descripcion, dbo.MDOCUMENTO.fRegistro, 
				        dbo.MDOCUMENTO.tCortesia, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, 
				        dbo.MDOCUMENTO.nVenta , dbo.MDOCUMENTO.nRecargo, dbo.MDOCUMENTO.nDescuento, dbo.MDOCUMENTO.tEstadoDocumento,dbo.mpedido.ttipopedido, 
			            dbo.MPEDIDO.tMesa, dbo.MPEDIDO.tObservacion, dbo.vSalon.Descripcion, dbo.TMESA.tDetallado, dbo.DPEDIDO.tCodigoProducto,
			            dbo.TPRODUCTO.tDetallado, dbo.CPEDIDO.nCantidad
							
     END		
			--SELECT * FROM #DBTRANS1
END	   



---- CESAR AGRUPADO
IF @tipo='AGRUPADO'
BEGIN
  IF @tipoX = 'VENTA'
     BEGIN
	    INSERT INTO #DBTRANS2 
		SELECT 			dbo.MDOCUMENTO.tDocumento, 
						dbo.MDOCUMENTO.tTipoDocumento, 
						dbo.MDOCUMENTO.tCortesia, 
						dbo.vGrupo.Descripcion As Grupo,
						dbo.vSubGrupo.Descripcion as SubGrupo,
						dbo.DPEDIDO.tCodigoProducto As Codigo, 
					    dbo.TPRODUCTO.tDetallado As Producto, 
						dbo.DPEDIDO.nPrecioNeto * dbo.DPEDIDO.nCantidad As Neto, 
						(dbo.DPEDIDO.nGasto + dbo.DPEDIDO.nInsumo + dbo.DPEDIDO.nManoObra) * (dbo.DPEDIDO.nCantidad) As Costo , 
						dbo.DPEDIDO.nCantidad As Cantidad,
						dbo.DPEDIDO.nPrecioOficial, 
						dbo.MPEDIDO.tTipoPedido,
						vSubGrupo.tAgrupacion As Agrupacion 
						FROM dbo.MDOCUMENTO left join dbo.vCortesia on dbo.MDOCUMENTO.tCortesia = dbo.vCortesia.Codigo 
						left join dbo.DPEDIDO on dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento left join dbo.MPEDIDO 
						ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido left join dbo.TPRODUCTO 
						ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto 
						INNER JOIN dbo.vGrupo ON dbo.DPEDIDO.tCodigoGrupo = dbo.vGrupo.Codigo 
						INNER JOIN dbo.vSubGrupo ON dbo.DPEDIDO.tCodigoSubGrupo = dbo.vSubGrupo.Codigo
						WHERE dbo.MDOCUMENTO.tEstadoDocumento<>'04' and (isnull(dbo.MDOCUMENTO.tCortesia,'0')<>'0' and len(ltrim(dbo.MDOCUMENTO.tCortesia))<>0) 
						AND MDOCUMENTO.fRegistro>=@fInicio AND MDOCUMENTO.FREGISTRO<=@fFinal
						--AND (dbo.MPEDIDO.tTipoPedido=@tipo OR @tipo='') 
	 END
	   
	   
  IF @tipoX = 'COMBO'
     BEGIN
	        INSERT INTO #DBTRANS2
	 		SELECT 		dbo.MDOCUMENTO.tDocumento,  
						dbo.MDOCUMENTO.tTipoDocumento, 
						dbo.MDOCUMENTO.tCortesia, 
						dbo.vGrupo.Descripcion As Grupo,
						dbo.vSubGrupo.Descripcion as SubGrupo,
						dbo.CPEDIDO.tProducto   As Codigo, 
					    dbo.TPRODUCTO.tDetallado As Producto, 
						dbo.CPEDIDO.nPrecioNeto As Neto, 
						(dbo.CPEDIDO.nGasto + dbo.CPEDIDO.nInsumo + dbo.CPEDIDO.nManoObra) * (dbo.CPEDIDO.nCantidad) As Costo , 
						dbo.CPEDIDO.nCantidad,
						dbo.CPEDIDO.nVenta As nPrecioOficial, 
						dbo.MPEDIDO.tTipopedido,
						vSubGrupo.tAgrupacion As Agrupacion 
						FROM dbo.MDOCUMENTO left join dbo.vCortesia on dbo.MDOCUMENTO.tCortesia = dbo.vCortesia.Codigo 
						left join dbo.DPEDIDO on dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento left join dbo.MPEDIDO 
						ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido left join dbo.TPRODUCTO 
						ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto 
						INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido 
						INNER JOIN dbo.vGrupo ON dbo.DPEDIDO.tCodigoGrupo = dbo.vGrupo.Codigo 
						INNER JOIN dbo.vSubGrupo ON dbo.DPEDIDO.tCodigoSubGrupo = dbo.vSubGrupo.Codigo
						WHERE dbo.MDOCUMENTO.tEstadoDocumento<>'04' and (isnull(dbo.MDOCUMENTO.tCortesia,'0')<>'0' and len(ltrim(dbo.MDOCUMENTO.tCortesia))<>0) 
						AND MDOCUMENTO.fRegistro>=@fInicio AND MDOCUMENTO.FREGISTRO<=@fFinal
						--AND (dbo.MPEDIDO.tTipoPedido=@tipo OR @tipo='') 			
	 END	   
	   
END

IF @tipo='RESUMIDO'
	BEGIN
	     SELECT * FROM #DBTRANS
	END
IF @tipo='DETALLADO'
	BEGIN
	     SELECT * FROM #DBTRANS1
	END
IF @tipo='AGRUPADO'
	BEGIN
		 SELECT Grupo ,Subgrupo,Codigo , Producto, SUM(Neto) As Neto, SUM(Costo) As Costo,
				SUM(Cantidad) As Cantidad, SUM(nPrecioOficial) As nPrecioOficial,tAgrupacion 
		FROM #DBTRANS2 
		GROUP BY Producto,Grupo ,Subgrupo,Codigo,tAgrupacion
	END


END



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


CREATE PROCEDURE spRep_CtaCteN
@flagTDetalle as bit,
@flagTResumido as bit,
@flagTConsolidado as bit,
@fInicio as smalldatetime,
@fFinal as smalldatetime

AS BEGIN
set nocount on 
declare @sCriterio as nvarchar(2000)
if @flagTDetalle=1  --detallado CTACTE
	begin
		 SELECT dbo.vCompania.Descripcion, dbo.vCompania.Identidad, dbo.vCompania.nConsumo, dbo.vCompania.nLinea, dbo.vCompania.nSaldo, dbo.MPEDIDO.tCodigoPedido, dbo.MPEDIDO.fFecha, dbo.vSalon.[Local] AS Local, dbo.MPEDIDO.tEstadoPedido, dbo.DPEDIDO.nVenta AS nVenta, dbo.MPEDIDO.tClienteCtaCte AS tClienteCtaCte, dbo.vProducto.tResumido AS Producto, dbo.DPEDIDO.nCantidad, dbo.DPEDIDO.tDocumento,tTipoCtaCte,tsubTipoCtaCte 
	  	 FROM dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido RIGHT OUTER JOIN dbo.vCompania ON dbo.MPEDIDO.tClienteCtaCte = dbo.vCompania.Codigo 
          	 WHERE isnull(tClienteCtaCte,' ')<>' ' and tEstadoPedido<>'03' AND (dbo.DPEDIDO.tEstadoItem <>  'A') AND MPEDIDO.fRegistro >=@finicio and mpedido.fregistro<@ffinal

	end
if @flagTResumido=1	-- resumido
	begin
		SELECT dbo.vCompania.Descripcion, dbo.vCompania.Identidad, dbo.vCompania.nConsumo, dbo.vCompania.nLinea, dbo.vCompania.nSaldo, dbo.MPEDIDO.tCodigoPedido, dbo.MPEDIDO.fFecha, dbo.vSalon.Local AS Local, tEstadoPedido,  dbo.DPEDIDO.tDocumento, SUM(dbo.DPEDIDO.nVenta) AS nVenta, max(dbo.MPEDIDO.tClienteCtaCte) AS tClienteCtaCte ,dbo.DPEDIDO.tDocumento,tTipoCtaCte,tsubTipoCtaCte 
           	FROM dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido RIGHT OUTER JOIN dbo.vCompania ON dbo.MPEDIDO.tClienteCtaCte = dbo.vCompania.Codigo 
   		WHERE isnull(tClienteCtaCte,' ')<>' ' and tEstadoPedido<> '03' AND (dbo.DPEDIDO.tEstadoItem <> 'A') AND MPEDIDO.fRegistro >=@finicio and mpedido.fregistro<@ffinal
		GROUP BY dbo.vCompania.Descripcion, dbo.vCompania.Identidad, dbo.vCompania.nConsumo, dbo.vCompania.nLinea, dbo.vCompania.nSaldo, dbo.MPEDIDO.tCodigoPedido , dbo.MPEDIDO.fFecha, dbo.vSalon.Local, tEstadoPedido, dbo.DPEDIDO.tDocumento ,tTipoCtaCte,tsubTipoCtaCte 
	end
if @flagTConsolidado=1 -- consolidado
	begin
		 SELECT dbo.vCompania.Descripcion, dbo.vCompania.Identidad, dbo.vCompania.nConsumo AS Consumo, dbo.vCompania.nLinea AS Linea, dbo.vCompania.nSaldo AS Saldo, dbo.vSalon.[Local] AS Local, MIN(dbo.MPEDIDO.fFecha) AS Fecha, SUM(dbo.DPEDIDO.nVenta) AS Suma , dbo.MPEDIDO.tClienteCtaCte AS tClienteCtaCte,tTipoCtaCte,tsubTipoCtaCte ,testadopedido
            	 FROM dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido RIGHT OUTER JOIN dbo.vCompania ON dbo.MPEDIDO.tClienteCtaCte = dbo.vCompania.Codigo 
		 WHERE isnull(tClienteCtaCte,' ')<>' ' and tEstadoPedido<>'03' AND (dbo.DPEDIDO.tEstadoItem <> 'A') AND MPEDIDO.fRegistro >=@finicio and mpedido.fregistro<@ffinal
 		 GROUP BY dbo.vCompania.Descripcion, dbo.vCompania.Identidad, dbo.vSalon.[Local], dbo.vCompania.nConsumo, dbo.vCompania.nLinea, dbo.vCompania.nSaldo , dbo.MPEDIDO.tClienteCtaCte,tTipoCtaCte,tsubTipoCtaCte ,testadopedido

	end
END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

CREATE PROCEDURE [dbo].[spRep_CuentasCobrar]
@tipo as nvarchar(10),
@cliente as nvarchar(10),
@tipoDoc as nvarchar(5),
@estadodoc as nvarchar(5),
@fInicio as smalldatetime,
@fFinal as smalldatetime
AS BEGIN
set nocount on


CREATE TABLE #DBTRANS   (Fregistro datetime,Tdocumento nvarchar(20) collate Modern_Spanish_CI_AS,Tclientepago nvarchar(100) collate Modern_Spanish_CI_AS,
              Ndescuento float,Nventa float, Tlocal nvarchar(3) collate Modern_Spanish_CI_AS,Ttipodocumento nvarchar(2) collate Modern_Spanish_CI_AS,
              Testadodocumento nvarchar(30) collate Modern_Spanish_CI_AS, Estado nvarchar(30) collate Modern_Spanish_CI_AS, fPago datetime) ----
CREATE TABLE #DBT (Documento nvarchar(20) collate Modern_Spanish_CI_AS, Estado nvarchar(15) collate Modern_Spanish_CI_AS)


if @estadodoc=''
     begin
              insert into #DBTRANS(Fregistro,Tdocumento,Tclientepago,Ndescuento,Nventa,Tlocal,Ttipodocumento, Estado, fPago, Testadodocumento) ----
                            Select dbo.MDOCUMENTO.fRegistro, case when len(mdocumento.tdocumento)>15 then   substring(mdocumento.tdocumento,1,2) + ''+ substring(mdocumento.tdocumento,4,len(mdocumento.tdocumento)) else mdocumento.tdocumento end tDocumento,
 tClientePago, nDescuento, nVenta, vSalon.tLocal, tTipoDocumento, 
                                dbo.MDOCUMENTO.tEstadoDocumento As Estado, dbo.MDOCUMENTO.fPago, ---
                            case when MAX(dbo.DPAGODOCUMENTO.fRegistro) is null  THEN 'POR COBRAR' ELSE  CASE WHEN MAX(dbo.DPAGODOCUMENTO.fRegistro)>@finicio AND MAX(dbo.DPAGODOCUMENTO.fRegistro)<=@ffinal THEN 'PAGADO' ELSE 'POR COBRAR' END  END 
                            FROM         dbo.MDOCUMENTO LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vSalon ON dbo.MDOCUMENTO.tSalon = dbo.vSalon.Codigo
                            Where dbo.MDOCUMENTO.fRegistro >= @finicio And dbo.MDOCUMENTO.fRegistro <= @ffinal  And tClientePago <> ''    and tclientepago like @cliente+'%' and ttipodocumento like @tipodoc+'%' 
                            GROUP BY dbo.MDOCUMENTO.fRegistro, dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.tClientePago, dbo.MDOCUMENTO.nDescuento, dbo.MDOCUMENTO.nVenta, dbo.vSalon.tLocal, dbo.MDOCUMENTO.tTipoDocumento,
                               dbo.MDOCUMENTO.tEstadoDocumento, dbo.MDOCUMENTO.fPago ---

              DELETE FROM  #DBTRANS WHERE Estado = '02' And fPago IS NULL  ----
     end
if @estadodoc<>''
     begin 
              Insert Into #DBT(Documento,Estado) 
                        select case when  len(MDOCUMENTO_1.tDocumento)>15 then substring(mdocumento_1.tdocumento,1,2) + ''+ substring(mdocumento_1.tdocumento,4,len(mdocumento_1.tdocumento)) else mdocumento_1.tdocumento end  ,(Case when (X.fRegistro) is null then 'POR COBRAR'
                            else case when (X.fRegistro)>@finicio AND (X.fRegistro)<=@ffinal 
                            THEN 'PAGADO' ELSE 'POR COBRAR' END  END)
                           FROM         dbo.DPAGODOCUMENTO AS X RIGHT OUTER JOIN
                      dbo.MDOCUMENTO AS MDOCUMENTO_1 ON X.tDocumento = MDOCUMENTO_1.tDocumento
                            Where MDOCUMENTO_1.fRegistro >= @finicio And MDOCUMENTO_1.fRegistro <= @ffinal

              insert into #DBTRANS(Fregistro,Tdocumento,Tclientepago,Ndescuento,Nventa,Tlocal,Ttipodocumento,Estado, fPago, Testadodocumento)----
                            Select dbo.MDOCUMENTO.fRegistro,case when len(mdocumento.tdocumento)>15 then   substring(mdocumento.tdocumento,1,2) + ''+ substring(mdocumento.tdocumento,4,len(mdocumento.tdocumento)) else mdocumento.tdocumento end tDocumento, 
tClientePago, nDescuento, nVenta, vSalon.tLocal, tTipoDocumento,
                                   dbo.MDOCUMENTO.tEstadoDocumento As Estado, dbo.MDOCUMENTO.fPago, ----
                        case when MAX(dbo.DPAGODOCUMENTO.fRegistro) is null  THEN 'POR COBRAR'
                        ELSE  CASE WHEN MAX(dbo.DPAGODOCUMENTO.fRegistro)>@finicio 
                        AND MAX(dbo.DPAGODOCUMENTO.fRegistro)<=@ffinal THEN 'PAGADO' ELSE 'POR COBRAR' END  END 
                            FROM  dbo.MDOCUMENTO LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento 
                        LEFT OUTER JOIN dbo.vSalon ON dbo.MDOCUMENTO.tSalon = dbo.vSalon.Codigo
                        INNER JOIN #DBT ON #DBT.Documento=dbo.MDOCUMENTO.tDocumento
                            Where   dbo.MDOCUMENTO.fRegistro >= @finicio And dbo.MDOCUMENTO.fRegistro <= @ffinal  
                        And tClientePago <> '' and tclientepago like @cliente+'%' and ttipodocumento like @tipodoc+'%' and 
                        (#DBT.Estado = (Select Descripcion from dbo.vEstadoDocumento where Codigo like @estadodoc+'%'))
                            GROUP BY dbo.MDOCUMENTO.fRegistro, dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.tClientePago, 
                        dbo.MDOCUMENTO.nDescuento, dbo.MDOCUMENTO.nVenta, dbo.vSalon.tLocal, dbo.MDOCUMENTO.tTipoDocumento,
                        dbo.MDOCUMENTO.tEstadoDocumento, dbo.MDOCUMENTO.fPago
                        
              DELETE FROM  #DBTRANS WHERE Estado = '02' And fPago IS NULL  ----     

    end

if @tipo='RESUMIDO'
     Select Min(#DBTRANS.fRegistro) as fRegistro, Min(#DBTRANS.tDocumento) as tDocumento, dbo.vCompania.Descripcion, Sum(#DBTRANS.nDescuento) As nDescuento, Sum(#DBTRANS.nVenta) As nVenta, count(#DBTRANS.tDocumento) as Cantidad 
     From #DBTRANS Left Outer Join dbo.vCompania ON #DBTRANS.tClientePago = dbo.vCompania.Codigo 
     Group By dbo.vCompania.Descripcion
ELSE
     select #DBTRANS.fRegistro,#DBTRANS.tDocumento, vCompania.Descripcion,#DBTRANS.nDescuento, #DBTRANS.nVenta, dbo.vLocal.Descripcion AS Local, tEstadoDocumento AS Estado 
     FROM #DBTRANS LEFT OUTER JOIN  dbo.vEstadoDocumento ON #DBTRANS.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN  dbo.vLocal ON #DBTRANS.tLocal = dbo.vLocal.Codigo LEFT OUTER JOIN dbo.vCompania ON #DBTRANS.tClientePago = dbo.vCompania.Codigo 

     order by vCompania.Descripcion, tDocumento
         
END




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE [dbo].[spRep_Descuento]
@flag1 as nvarchar(2),
@fInicio as smalldatetime,
@fFinal as smalldatetime,
@mdesc as nvarchar(10),
@tipoPedido as nvarchar(10),
@sValor as nvarchar(50)

AS BEGIN
set nocount on

DECLARE @IMP float

SELECT @IMP = 1 + (Impuesto1/100) + (Impuesto2/100 ) FROM TPARAMETRO 


create table #DBTRANS (tCodigoPedido nVarchar(15) collate Modern_Spanish_CI_AS,  fRegistro datetime, 
              nPrecioNeto Float,nprecioventa Float, npreciooficial Float, 
              ndescuento Float,  descuento nvarchar(50) collate Modern_Spanish_CI_AS, tipopedido nvarchar(30) collate Modern_Spanish_CI_AS, 
              tObservacion nvarchar(250) collate Modern_Spanish_CI_AS, VenTotal Float, Observacion nvarchar(250) collate Modern_Spanish_CI_AS, tDocumento nvarchar(20) collate Modern_Spanish_CI_AS,Costo Float)

    
create table #DBTRANS1 (tCodigoPedido nVarchar(15) collate Modern_Spanish_CI_AS, fRegistro datetime, 
              nPrecioNeto Float, nprecioventa Float, npreciooficial Float, 
              ndescuento Float, tCodigoProducto nVarchar(7) collate Modern_Spanish_CI_AS, nCantidad Float,
			  tUsuariod nVarchar(30) collate Modern_Spanish_CI_AS, descuento nvarchar(50) collate Modern_Spanish_CI_AS, tipopedido nvarchar(30) collate Modern_Spanish_CI_AS,
			  tDetallado nvarchar(50) collate Modern_Spanish_CI_AS, nDescuento1 Float, nDescuento2 Float, 
		      tUsuarioA nvarchar(30) collate Modern_Spanish_CI_AS, Observacion nvarchar(250) collate Modern_Spanish_CI_AS, tDocumento nvarchar(20) collate Modern_Spanish_CI_AS,Costo Float, Item nvarchar(3) collate Modern_Spanish_CI_AS)

create table #DBTRANS2 (tCodigoPedido nVarchar(15) collate Modern_Spanish_CI_AS, fRegistro datetime, 
              nPrecioNeto Float, nprecioventa Float, npreciooficial Float, ndescuento Float, 
              tCodigoProducto nVarchar(7) collate Modern_Spanish_CI_AS, nCantidad Float,
              tUsuariod nVarchar(30) collate Modern_Spanish_CI_AS, descuento nvarchar(50) collate Modern_Spanish_CI_AS, tipopedido nvarchar(30) collate Modern_Spanish_CI_AS,
              Agrupacion nvarchar(50) collate Modern_Spanish_CI_AS,
              Grupo nvarchar(50) collate Modern_Spanish_CI_AS, SubGrupo nvarchar(50) collate Modern_Spanish_CI_AS, 
              Producto nvarchar(50) collate Modern_Spanish_CI_AS, nDescuento1 Float, nDescuento2 Float, 
              tUsuarioA nvarchar(30) collate Modern_Spanish_CI_AS, Observacion nvarchar(250) collate Modern_Spanish_CI_AS, tDocumento nvarchar(20) collate Modern_Spanish_CI_AS,Costo Float, Item nvarchar(3) collate Modern_Spanish_CI_AS)


IF @flag1='00' --PEDIDOS RESUMIDO

		BEGIN
		   if @sValor='01' -- PRECIO VENTA
				--PEDIDOS
				 insert into #DBTRANS (tCodigoPedido,FRegistro ,nPrecioNeto ,nprecioventa , npreciooficial ,ndescuento ,descuento , tipopedido ,tObservacion , VenTotal , Observacion, tDocumento, Costo )
				 SELECT MPEDIDO.TCODIGOPEDIDO,MAX(MPEDIDO.FREGISTRO)AS FREGISTRO,SUM(NPRECIONETO) AS NPRECIONETO, SUM(dbo.DPEDIDO.nVenta) AS NPRECIOVENTA, SUM(nPrecioOficial*nCantidad) AS NPRECIOOFICIAL, MAX(MPEDIDO.NDESCUENTO) AS NDESCUENTO, MAX(vmotivodescuento.DESCRIPCION) As DESCUENTO,max(vTipoPedido.Descripcion) as TipoPedido, max(MPEDIDO.tusuariodescuento) as tobservacion,max(mp1.venTotal)as VenTotal, MAX(MPEDIDO.tObservacion) AS Observacion, DPEDIDO.tDocumento,SUM((ISNULL(nInsumo,0)+ ISNULL(nGasto,0)+ISNULL(nManoObra,0))* nCantidad) As Costo  
				 FROM DPEDIDO INNER JOIN MPEDIDO ON DPEDIDO.TCODIGOPEDIDO =MPEDIDO.TCODIGOPEDIDO LEFT OUTER JOIN dbo.vmotivodescuento ON dbo.MPedido.tDescuento = dbo.vmotivodescuento.Codigo left outer join vtipopedido ON dbo.mpedido.tTipoPedido = dbo.vTipoPedido.codigo , (select sum(dbo.DPEDIDO.nVenta) as venTotal from dpedido inner join mpedido on dpedido.tcodigopedido=mpedido.tcodigopedido where dbo.MPedido.tEstadopedido<>'03' AND Mpedido.fRegistro >=@FINICIO and Mpedido.fRegistro <= @FFINAL ) as mp1 
				 WHERE RTRIM(MPEDIDO.TDESCUENTO) <> '' AND MPEDIDO.NDESCUENTO>0 AND dbo.MPedido.tEstadopedido<>'03' AND Mpedido.fRegistro >= @finicio and Mpedido.fRegistro <=  @ffinal AND vmotivodescuento.codigo LIKE @mDesc+'%' and MPEDIDO.tTipoPedido like @tipoPedido+'%'
				 GROUP BY MPEDIDO.TCODIGOPEDIDO, DPEDIDO.tDocumento  
				 ORDER BY DESCUENTO,FREGISTRO 

		   if @sValor='02'  -- PRECIO NETO
				 insert into #DBTRANS (tCodigoPedido,FRegistro ,nPrecioNeto ,nprecioventa , npreciooficial ,ndescuento ,descuento , tipopedido ,tObservacion , VenTotal , Observacion, tDocumento, Costo )
				 SELECT MPEDIDO.TCODIGOPEDIDO,MAX(MPEDIDO.FREGISTRO)AS FREGISTRO,SUM(NPRECIONETO) AS NPRECIONETO, SUM(dbo.DPEDIDO.nPrecioNeto*dbo.DPEDIDO.nCantidad) AS NPRECIOVENTA, SUM( CASE dbo.DPEDIDO.nPrecioNeto WHEN 0 THEN dbo.DPEDIDO.nPrecioOficial/@IMP ELSE(100*dbo.DPEDIDO.nPrecioNeto*dbo.DPEDIDO.nCantidad) / (100 - case dbo.MPEDIDO.nDescuento when 100 then 99 else dbo.mpedido.ndescuento end )END) AS NPRECIOOFICIAL, MAX(MPEDIDO.NDESCUENTO) AS NDESCUENTO, MAX(vmotivodescuento.DESCRIPCION) As DESCUENTO,max(vTipoPedido.Descripcion) as TipoPedido, max(MPEDIDO.tusuariodescuento) as tobservacion,max(mp1.venTotal)as VenTotal, MAX(MPEDIDO.tObservacion) AS Observacion, DPEDIDO.tDocumento,SUM((ISNULL(nInsumo,0)+ ISNULL(nGasto,0)+ISNULL(nManoObra,0))* nCantidad) As Costo  
				 FROM DPEDIDO INNER JOIN MPEDIDO ON DPEDIDO.TCODIGOPEDIDO =MPEDIDO.TCODIGOPEDIDO LEFT OUTER JOIN dbo.vmotivodescuento ON dbo.MPedido.tDescuento = dbo.vmotivodescuento.Codigo left outer join vtipopedido ON dbo.mpedido.tTipoPedido = dbo.vTipoPedido.codigo , (select sum(dbo.DPEDIDO.nPrecioNeto*dbo.DPEDIDO.nCantidad) as venTotal from dpedido inner join mpedido on dpedido.tcodigopedido=mpedido.tcodigopedido where dbo.MPedido.tEstadopedido<>'03' AND Mpedido.fRegistro >= @finicio and Mpedido.fRegistro <= @ffinal) as mp1 
				 WHERE RTRIM(MPEDIDO.TDESCUENTO)<>'' AND MPEDIDO.NDESCUENTO>0 AND dbo.MPedido.tEstadopedido<>'03'  and Mpedido.fRegistro >= @finicio and Mpedido.fRegistro <=  @ffinal AND vmotivodescuento.codigo LIKE @mDesc+'%' and MPEDIDO.tTipoPedido like @tipoPedido+'%' 
				 GROUP BY MPEDIDO.TCODIGOPEDIDO, DPEDIDO.tDocumento   
                 ORDER BY DESCUENTO,FREGISTRO

                --ACTUALIZO LOS COSTOS DE LAS PROPIEDADES
				UPDATE #DBTRANS Set Costo = T1.Costo + T2.Costo FROM #DBTRANS As T1 INNER JOIN
				(SELECT tcodigopedido,
				SUM(isnull(ninsumo,0)+isnull(ngasto,0)+isnull(nmanoobra,0))As Costo 
				FROM dbo.TPRODUCTOPROPIEDAD 
				GROUP BY tcodigopedido) AS T2 
				ON T1.tCodigoPedido = T2.tCodigoPedido 

  END 


IF @flag1='01' -- PEDIDOS DETALLADO
  BEGIN
	   if @sValor='01' -- PRECIO VENTA
			 insert into #DBTRANS1 (tCodigoPedido , fRegistro ,nPrecioNeto , nprecioventa , npreciooficial , ndescuento , tCodigoProducto , nCantidad ,tUsuariod , descuento , tipopedido ,tDetallado , nDescuento1 , nDescuento2 , tUsuarioA , Observacion, tDocumento, Costo, Item )
			 SELECT MPEDIDO.TCODIGOPEDIDO, MPEDIDO.FREGISTRO, NPRECIONETO, Dbo.DPEDIDO.nVenta as nPrecioVenta, nPrecioOficial*nCantidad as NPRECIOOFICIAL, mpedido.NDESCUENTO,dpedido.tcodigoproducto,dpedido.ncantidad,dpedido.tusuariod, VMOTIVODESCUENTO.DESCRIPCION AS DESCUENTO,vTipoPedido.Descripcion TipoPedido,tproducto.tdetallado,0 as ndescuento1,0 as ndescuento2,tUsuarioDescuento as tUsuarioA, MPEDIDO.tObservacion as Observacion, DPEDIDO.tDocumento, ((ISNULL(DPEDIDO.nInsumo,0) + ISNULL(DPEDIDO.nGasto,0) + ISNULL(DPEDIDO.nManoObra,0))* nCantidad) As Costo, DPEDIDO.tItem 
			 FROM DPEDIDO INNER JOIN MPEDIDO ON DPEDIDO.TCODIGOPEDIDO =MPEDIDO.TCODIGOPEDIDO LEFT OUTER JOIN dbo.vmotivodescuento ON dbo.MPedido.tDescuento = dbo.vmotivodescuento.Codigo left outer join vtipopedido ON dbo.mpedido.tTipoPedido = dbo.vTipoPedido.codigo left outer join tproducto ON dbo.dpedido.tcodigoproducto = tproducto.tcodigoproducto 
			 WHERE RTRIM(MPEDIDO.TDESCUENTO)<>'' AND MPEDIDO.NDESCUENTO>0 AND dbo.MPedido.tEstadopedido<>'03' AND Mpedido.fRegistro >= @finicio and Mpedido.fRegistro <=  @ffinal AND vmotivodescuento.codigo LIKE @mDesc+'%' and MPEDIDO.tTipoPedido like @tipoPedido+'%' 
			 ORDER BY DESCUENTO, mpedido.tcodigopedido 
	             
	   if @sValor='02' -- PRECIO NETO
			 insert into #DBTRANS1 (tCodigoPedido , fRegistro ,nPrecioNeto , nprecioventa , npreciooficial , ndescuento , tCodigoProducto , nCantidad ,tUsuariod , descuento , tipopedido ,tDetallado , nDescuento1 , nDescuento2 , tUsuarioA , Observacion, tDocumento, Costo, Item )
			 SELECT MPEDIDO.TCODIGOPEDIDO, MPEDIDO.FREGISTRO, NPRECIONETO, dbo.DPEDIDO.nPrecioNeto*dbo.DPEDIDO.nCantidad as nPrecioVenta, CASE dbo.DPEDIDO.nPrecioNeto WHEN 0 THEN dbo.DPEDIDO.nPrecioOficial/@IMP ELSE(100*dbo.DPEDIDO.nPrecioNeto*dbo.DPEDIDO.nCantidad) / (100 - case dbo.MPEDIDO.nDescuento when 100 then 99 else dbo.mpedido.ndescuento end)END AS NPRECIOOFICIAL, mpedido.NDESCUENTO,dpedido.tcodigoproducto,dpedido.ncantidad,dpedido.tusuariod, VMOTIVODESCUENTO.DESCRIPCION AS DESCUENTO,vTipoPedido.Descripcion TipoPedido,tproducto.tdetallado,0 as ndescuento1,0 as ndescuento2,tUsuarioDescuento as tUsuarioA, MPEDIDO.tObservacion as Observacion, DPEDIDO.tDocumento,((ISNULL(DPEDIDO.nInsumo,0) + ISNULL(DPEDIDO.nGasto,0) + ISNULL(DPEDIDO.nManoObra,0))* nCantidad) As Costo, DPEDIDO.tItem 
			 FROM DPEDIDO INNER JOIN MPEDIDO ON DPEDIDO.TCODIGOPEDIDO =MPEDIDO.TCODIGOPEDIDO LEFT OUTER JOIN dbo.vmotivodescuento ON dbo.MPedido.tDescuento = dbo.vmotivodescuento.Codigo left outer join vtipopedido ON dbo.mpedido.tTipoPedido = dbo.vTipoPedido.codigo left outer join tproducto ON dbo.dpedido.tcodigoproducto = tproducto.tcodigoproducto 
			 WHERE RTRIM(MPEDIDO.TDESCUENTO)<>'' AND MPEDIDO.NDESCUENTO>0 AND dbo.MPedido.tEstadopedido<>'03'  AND Mpedido.fRegistro >= @finicio and Mpedido.fRegistro <=  @ffinal AND vmotivodescuento.codigo LIKE @mDesc+'%' and MPEDIDO.tTipoPedido like @tipoPedido+'%' 
			ORDER BY DESCUENTO, mpedido.tcodigopedido 
			
			    --ACTUALIZO LOS COSTOS DE LAS PROPIEDADES
				UPDATE #DBTRANS1 Set Costo = T1.Costo + T2.Costo FROM #DBTRANS1 As T1 INNER JOIN
				(SELECT tcodigopedido,tproducto,tItem,
				(isnull(ninsumo,0)+isnull(ngasto,0)+isnull(nmanoobra,0))As Costo 
				FROM dbo.TPRODUCTOPROPIEDAD) AS T2 
				ON T1.tCodigoPedido = T2.tCodigoPedido AND T1.tCodigoProducto = T2.tProducto AND T1.Item = T2.tItem
				
  END    
  
  
  IF @flag1='02' -- AGRUPADO (SUB GRUPOS)
  BEGIN
	   if @sValor='01' -- PRECIO VENTA
			 insert into #DBTRANS2 (tCodigoPedido , fRegistro ,nPrecioNeto , nprecioventa , npreciooficial , ndescuento , tCodigoProducto , nCantidad ,tUsuariod , descuento , tipopedido , Agrupacion, Grupo, Subgrupo, Producto , nDescuento1 , nDescuento2 , tUsuarioA , Observacion, tDocumento, Costo, Item )
			 SELECT MPEDIDO.TCODIGOPEDIDO, MPEDIDO.FREGISTRO, NPRECIONETO, Dbo.DPEDIDO.nVenta as nPrecioVenta, nPrecioOficial*nCantidad as NPRECIOOFICIAL, mpedido.NDESCUENTO,dpedido.tcodigoproducto,dpedido.ncantidad,dpedido.tusuariod, VMOTIVODESCUENTO.DESCRIPCION AS DESCUENTO,vTipoPedido.Descripcion As TipoPedido, vSubGrupo.tAgrupacion As Agrupacion, vGrupo.Descripcion As Grupo, vSubGrupo.Descripcion As SubGrupo,tproducto.tdetallado As Producto, 0 as ndescuento1, 0 as ndescuento2,tUsuarioDescuento As tUsuarioA, MPEDIDO.tObservacion As Observacion, DPEDIDO.tDocumento, ((ISNULL(DPEDIDO.nInsumo,0) + ISNULL(DPEDIDO.nGasto,0) + ISNULL(DPEDIDO.nManoObra,0))* nCantidad) As Costo, DPEDIDO.tItem 
			 FROM DPEDIDO INNER JOIN MPEDIDO ON DPEDIDO.TCODIGOPEDIDO =MPEDIDO.TCODIGOPEDIDO LEFT OUTER JOIN dbo.vmotivodescuento ON dbo.MPedido.tDescuento = dbo.vmotivodescuento.Codigo left outer join vtipopedido ON dbo.mpedido.tTipoPedido = dbo.vTipoPedido.codigo left outer join tproducto ON dbo.dpedido.tcodigoproducto = tproducto.tcodigoproducto LEFT JOIN vGrupo ON TPRODUCTO.tGrupo = vGrupo.Codigo LEFT JOIN vSubGrupo ON TPRODUCTO.tSubGrupo = vSubGrupo.Codigo 
			 WHERE RTRIM(MPEDIDO.TDESCUENTO)<>'' AND MPEDIDO.NDESCUENTO>0 AND dbo.MPedido.tEstadopedido<>'03' AND Mpedido.fRegistro >= @finicio and Mpedido.fRegistro <=  @ffinal AND vmotivodescuento.codigo LIKE @mDesc+'%' and MPEDIDO.tTipoPedido like @tipoPedido+'%' 
			 ORDER BY DESCUENTO, mpedido.tcodigopedido 
	             
	   if @sValor='02' -- PRECIO NETO
			 insert into #DBTRANS2 (tCodigoPedido , fRegistro ,nPrecioNeto , nprecioventa , npreciooficial , ndescuento , tCodigoProducto , nCantidad ,tUsuariod , descuento , tipopedido , Agrupacion, Grupo, Subgrupo, Producto , nDescuento1 , nDescuento2 , tUsuarioA , Observacion, tDocumento, Costo, Item )
			 SELECT MPEDIDO.TCODIGOPEDIDO, MPEDIDO.FREGISTRO, NPRECIONETO, dbo.DPEDIDO.nPrecioNeto*dbo.DPEDIDO.nCantidad as nPrecioVenta, CASE dbo.DPEDIDO.nPrecioNeto WHEN 0 THEN dbo.DPEDIDO.nPrecioOficial/@IMP ELSE (100*dbo.DPEDIDO.nPrecioNeto*dbo.DPEDIDO.nCantidad) / (100 - case dbo.MPEDIDO.nDescuento when 100 then 99 else dbo.mpedido.ndescuento end)END AS NPRECIOOFICIAL, mpedido.NDESCUENTO,dpedido.tcodigoproducto,dpedido.ncantidad,dpedido.tusuariod, VMOTIVODESCUENTO.DESCRIPCION AS DESCUENTO,vTipoPedido.Descripcion As TipoPedido, vSubGrupo.tAgrupacion As Agrupacion, vGrupo.Descripcion As Grupo, vSubGrupo.Descripcion As SubGrupo,tproducto.tdetallado As Producto, 0 As ndescuento1,0 As ndescuento2,tUsuarioDescuento As tUsuarioA, MPEDIDO.tObservacion As Observacion, DPEDIDO.tDocumento,((ISNULL(DPEDIDO.nInsumo,0) + ISNULL(DPEDIDO.nGasto,0) + ISNULL(DPEDIDO.nManoObra,0))* nCantidad) As Costo, DPEDIDO.tItem 
			 FROM DPEDIDO INNER JOIN MPEDIDO ON DPEDIDO.TCODIGOPEDIDO =MPEDIDO.TCODIGOPEDIDO LEFT OUTER JOIN dbo.vmotivodescuento ON dbo.MPedido.tDescuento = dbo.vmotivodescuento.Codigo left outer join vtipopedido ON dbo.mpedido.tTipoPedido = dbo.vTipoPedido.codigo left outer join tproducto ON dbo.dpedido.tcodigoproducto = tproducto.tcodigoproducto LEFT JOIN vGrupo ON TPRODUCTO.tGrupo = vGrupo.Codigo LEFT JOIN vSubGrupo ON TPRODUCTO.tSubGrupo = vSubGrupo.Codigo 
			 WHERE RTRIM(MPEDIDO.TDESCUENTO)<>'' AND MPEDIDO.NDESCUENTO>0 AND dbo.MPedido.tEstadopedido<>'03'  AND Mpedido.fRegistro >= @finicio and Mpedido.fRegistro <=  @ffinal AND vmotivodescuento.codigo LIKE @mDesc+'%' and MPEDIDO.tTipoPedido like @tipoPedido+'%' 
			ORDER BY DESCUENTO, mpedido.tcodigopedido 
			
			    --ACTUALIZO LOS COSTOS DE LAS PROPIEDADES
				UPDATE #DBTRANS2 Set Costo = T1.Costo + T2.Costo FROM #DBTRANS2 As T1 INNER JOIN
				(SELECT tcodigopedido,tproducto,tItem,
				(isnull(ninsumo,0)+isnull(ngasto,0)+isnull(nmanoobra,0))As Costo 
				FROM dbo.TPRODUCTOPROPIEDAD) AS T2 
				ON T1.tCodigoPedido = T2.tCodigoPedido AND T1.tCodigoProducto = T2.tProducto AND T1.Item = T2.tItem
				
  END     


IF @flag1='00' -- PEDIDO RESUMIDO
     SELECT *, (SELECT sum(distinct ventotal) as total FROM #DBTRANS) as total FROM #DBTRANS order by TipoPedido, tCodigoPedido
IF @flag1='01' -- PEIDO DETALLADO
     SELECT * FROM #DBTRANS1
     
IF @flag1='02' -- AGRUPADO X SUB GRUPO
     SELECT Agrupacion,Grupo,SubGrupo,Producto,costo,nCantidad,npreciooficial,ndescuento,nprecioventa FROM #DBTRANS2
     ORDER by Agrupacion,Grupo,SubGrupo, Producto
END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

/****** Object:  StoredProcedure [dbo].[spRep_Liquidacion]    Script Date: 06/18/2013 16:05:03 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO




CREATE PROCEDURE [dbo].[spRep_Liquidacion]
@flagTipo as nvarchar(1),
@flagTurnoFecha as bit,
@flagDiaContable as bit,
@flagDocGenerado as bit,
@flagEfectivo as bit,
@flagCheque as bit,
@flagTarjetaCredito as bit,
@flagPagosVarios as bit,
@flagPunto as bit,
@flagPagoCortesia as bit,
@flagPorCobrar as bit,
@flagReciboIngreso as bit,
@flagReciboAnticipo as bit,
@flagReciboEgreso as bit,
@flagNoCortesia as bit,
@flagCortesia as bit,
@flagCuentaCorriente as bit,
@flagAnulado as bit,
@flagPedidoOtroRango as bit,
@sTurno as nvarchar(30),
@sUsuario as nvarchar(30),
@sClub as nvarchar(30),
@fechaInicial as smalldatetime,
@finicio as smalldatetime,
@ffinal as smalldatetime,
@sSectorVenta as nvarchar(50) --CESAR SECTOR VENTA


AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @sCriterio nvarchar(1000)
declare @cortesia nvarchar(50)
declare @comilla nvarchar(5)
declare @nCambio float
declare @sBase  nvarchar(200)
declare @xBase  nvarchar(200)
declare @yBase  nvarchar(200)
declare @xSectorV  nvarchar(200) --CESAR SECTOR VENTA
set @scriterio=''
set @sql=''
set @comilla=''''

CREATE TABLE #DBTRANS (tGrupo nVarChar(2) collate Modern_Spanish_CI_AS, Grupo nVarChar(150) collate Modern_Spanish_CI_AS, tSubGrupo nVarChar(3) collate Modern_Spanish_CI_AS, SubGrupo nVarChar(150) collate Modern_Spanish_CI_AS,  tDocumento nVarChar(20) collate Modern_Spanish_CI_AS, tUsuario nVarChar(15) collate Modern_Spanish_CI_AS, fFecha nVarChar(35) collate Modern_Spanish_CI_AS, fPago nVarChar(35) collate Modern_Spanish_CI_AS, nTC Float, nVenta Float, nVenta1 Float, nVenta2 Float, tObservacion nVarChar(450) collate Modern_Spanish_CI_AS, tTipoDocumento nVarChar(450) collate Modern_Spanish_CI_AS, tInicio nVarChar(450) collate Modern_Spanish_CI_AS, tFinal nVarChar(450) collate Modern_Spanish_CI_AS, tEmitido nVarChar(450) collate Modern_Spanish_CI_AS, tAnulado nVarChar(450) collate Modern_Spanish_CI_AS,total00 float,total14 float,totalNF float)

--set @scriterio=' isnull(tCaja,' +@comilla+ '0'+@comilla+')<>'+@comilla+ '0'+@comilla
set @sBase = ' isnull(MDOCUMENTO.tCaja,'+@comilla+ '0'+@comilla+')<>'+@comilla+ '0'+@comilla 
set @xBase = ' isnull(DPAGODOCUMENTO.tDocumento,'+@comilla+ '0'+@comilla+')<>'+@comilla+ '0'+@comilla 
 
set @yBase = ' isnull(MPEDIDO.tCaja,'+@comilla+ '0'+@comilla+')<>'+@comilla+ '0'+@comilla 


--CESAR SECTOR VENTA
if @sSectorVenta = ''
	begin
	     set @xSectorV = ' dbo.TCAJA.tSectorVenta <> '+@comilla+ '00'+@comilla 
	end
else
	begin
	     set @xSectorV = ' dbo.TCAJA.tSectorVenta = '+@comilla+ @sSectorVenta +@comilla 
	end
----	
      
if @flagTurnoFecha=0
	begin
		set @sCriterio=@sCriterio + 'And tTurno ='+@comilla+@sTurno + @comilla
		set @sBase=@sBase+ ' And MDOCUMENTO.tTurno ='+@comilla+@sTurno + @comilla
		set @xBase=@xBase+ ' And DPAGODOCUMENTO.tTurno ='+@comilla+@sTurno + @comilla
		set @yBase=@yBase+ ' And MPEDIDO.tTurno ='+@comilla+@sTurno + @comilla 

	end
else
	begin
		if @flagDiaContable=0 
			begin
				set @scriterio=@scriterio+ ' and  fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
				set @sBase=@sBase+ ' and  MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and MDOCUMENTO.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
				set @xBase=@xBase+ ' and  DPAGODOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and DPAGODOCUMENTO.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
				set @yBase=@yBase+ ' and  MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and MPEDIDO.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
			end
		if @flagDiaContable=1
			begin
				set @scriterio=@scriterio+ ' and  fDiaContable >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+   @comilla + ' and fDiaContable <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+  @comilla
				set @sBase=@sBase+ ' and  MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+   @comilla + ' and MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+   @comilla
				set @xBase=@xBase+ ' and  DPAGODOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+   @comilla + ' and DPAGODOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+   @comilla
				set @yBase=@yBase+ ' and  MPEDIDO.fDiaContable >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+   @comilla + ' and MPEDIDO.fDiaContable <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+   @comilla
			end
	end

if @sUsuario<>''
	begin
		set @scriterio=@scriterio + ' And tUsuario= ' +@comilla+@sUsuario + @comilla
		set @sBase=@sBase + ' And MDOCUMENTO.tUsuario= ' +@comilla+@sUsuario + @comilla
		set @xBase=@xBase + ' And DPAGODOCUMENTO.tUsuario= ' +@comilla+@sUsuario + @comilla
		set @yBase=@yBase + ' And MPEDIDO.tUsuario= ' +@comilla+@sUsuario + @comilla
	end

 
if @flagNoCortesia=0
	begin
		set @sBase=@sBase + ' and tTipoDocumento <> '+@comilla+ '00'+@comilla 
	end 

	select @nCambio=nventa from ttipocambio where ffecha=@fechaInicial

	if @flagEfectivo=1 --pagos con  efectivo
		begin
		set @sql   = ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, nVenta1, nVenta2, tObservacion, nTC ) ' + 
		             ' SELECT '+@comilla+ '01'+@comilla+' AS tGrupo, '+@comilla+ 'Efectivo'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, '+@comilla+ ''+@comilla+' AS tDocumento, '+@comilla+ ''+@comilla+' AS tUsuario, '+@comilla+ ''+@comilla+' AS fFecha, '+@comilla+ ''+@comilla+' AS fPago, ' +
		             ' SUM(nVenta) AS nVenta, ' +
		             ' SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '+@comilla+ '01'+@comilla+' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END) As nVenta1, ' +
		             ' SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '+@comilla+ '02'+@comilla+' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END) As nVenta2, '+@comilla+ ''+@comilla+' as tObservacion, AVG(nTipoCambio) ' + 
		             ' FROM dbo.MDOCUMENTO LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento ' +
		             ' WHERE dbo.DPAGODOCUMENTO.tTipoPago='+@comilla+ '01'+@comilla+' and ' + @xBase
		EXECUTE  sp_executesql @sql
				delete from #DBTRANS where tGrupo='01' and nVenta=0
		end
	else
		begin 
		set @sql =  ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nTC, nVenta, nVenta1, nVenta2, tObservacion ) ' +
             		     ' SELECT '+@comilla+ '01'+@comilla+' AS tGrupo, '+@comilla+ 'Efectivo'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, dbo.MDOCUMENTO.tDocumento, ' +
		             ' dbo.DPAGODOCUMENTO.tUsuario AS tUsuario, CONVERT(nvarchar(8), dbo.MDOCUMENTO.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.MDOCUMENTO.fRegistro, 8) AS fRegistro, ' +
		             ' CONVERT(nvarchar(8), dbo.DPAGODOCUMENTO.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.DPAGODOCUMENTO.fRegistro, 8) AS fPago, dbo.DPAGODOCUMENTO.nTipoCambio, ' + 
		             ' dbo.MDOCUMENTO.nVenta As nVenta, ' +
		             ' CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '+@comilla+ '01'+@comilla+' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END As nVenta1, ' +
		             ' CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '+@comilla+ '02'+@comilla+' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END As nVenta2, ' + @comilla+ 'Doc. Gen. :  '+@comilla+' + dbo.MDOCUMENTO.tTurno AS tObservacion ' +
		             ' FROM dbo.MDOCUMENTO LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento ' +
		             ' LEFT JOIN dbo.TCAJA ON dbo.MDOCUMENTO.tCaja = dbo.TCAJA.tCaja ' +  --CESAR SECTOR VENTA
		             ' WHERE dbo.DPAGODOCUMENTO.tTipoPago='+@comilla+ '01'+@comilla+' and ' +  @xBase + ' AND ' + @xSectorV --CESAR SECTOR VENTA
		EXECUTE  sp_executesql @sql
print @sql
		end
--PRINT @SQL
	if @flagDocGenerado=1 --documentos generados
		begin
		set @sql=    ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, nVenta1, tObservacion ) ' + 
			     ' SELECT '+@comilla+ '00'+@comilla+' AS tGrupo, '+@comilla+ 'Documentos Generados'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, '+@comilla+ ''+@comilla+' AS tDocumento, '+@comilla+ ''+@comilla+' AS tUsuario, '+@comilla+ ''+@comilla+' AS fFecha, '+@comilla+ ''+@comilla+' AS fPago, SUM(nVenta) AS nVenta, SUM(CASE WHEN tTipoDocumento = '+@comilla+ '00'+@comilla+' THEN 0 WHEN tEstadoDocumento = '+@comilla+ '04'+@comilla+' THEN 0 ELSE nventa END) As nVenta1, '+@comilla+ ''+@comilla+' as tObservacion ' +
		             ' From dbo.MDOCUMENTO ' +
		             ' WHERE ' + @sBase
	
			     EXECUTE  sp_executesql @sql
		             delete from #DBTRANS where tGrupo='00' and nVenta=0
		
		end
	else
		begin
		set @sql = ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, nVenta1, tObservacion ) ' +
     			   ' SELECT Distinct '+@comilla+ '00'+@comilla+' AS tGrupo, '+@comilla+ 'Documentos Generados'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.tUsuarioAutoriza AS tUsuario, ' +
		           ' CONVERT(nvarchar(8), dbo.MDOCUMENTO.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.MDOCUMENTO.fRegistro, 8) AS fRegistro, CONVERT(nvarchar(8), dbo.MDOCUMENTO.fPago, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.MDOCUMENTO.fPago, 8) AS fPago, ' + 
		           ' dbo.MDOCUMENTO.nVenta AS nVenta, CASE WHEN tTipoDocumento = '+@comilla+ '00'+@comilla+' THEN 0 WHEN tEstadoDocumento = '+@comilla+ '04'+@comilla+' THEN 0 ELSE nventa END As nVenta1, CASE WHEN MDOCUMENTO.TESTADODOCUMENTO <>'+@comilla+ '04'+@comilla+'  THEN  case when isnull(tclientepago,'+@comilla+ ' '+@comilla+' )<>'+@comilla+ ' '+@comilla+'  then '+@comilla+ 'POR COBRAR '+@comilla+ ' ELSE dbo.vEstadoDocumento.Descripcion +  CASE WHEN isnull(dbo.dPagoDocumento.tTurno,'+@comilla+ ''+@comilla+')='+@comilla+ ''+@comilla+' then '+@comilla+ ''+@comilla+' else '+@comilla+ ' - '+@comilla+' END + ISNULL(dbo.DPAGODOCUMENTO.tTurno, N'+@comilla+ ''+@comilla+') + '+@comilla+ ' '+@comilla+' + ISNULL(dbo.vCortesia.Descripcion, N'+@comilla+ ''+@comilla+') END ELSE   case when isnull(tclientepago,'+@comilla+ ' '+@comilla+' )<>'+@comilla+ ' '+@comilla+'  then '+@comilla+ 'POR COBRAR '+@comilla+ ' ELSE dbo.vEstadoDocumento.Descripcion +  CASE WHEN isnull(dbo.dPagoDocumento.tTurno,'+@comilla+ ''+@comilla+')='+@comilla+ ''+@comilla+' then '+@comilla+ ''+@comilla+' else '+@comilla+ ' - '+@comilla+' END + ISNULL(dbo.DPAGODOCUMENTO.tTurno, N'+@comilla+ ''+@comilla+') + '+@comilla+ ' '+@comilla+' + ISNULL(dbo.vCortesia.Descripcion, N'+@comilla+ ''+@comilla+') END END  AS tObservacion ' +
		           ' FROM dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vCortesia ON dbo.MDOCUMENTO.tCortesia = dbo.vCortesia.Codigo LEFT OUTER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento ' +
		           ' LEFT JOIN dbo.TCAJA ON dbo.MDOCUMENTO.tCaja = dbo.TCAJA.tCaja ' +  --CESAR SECTOR VENTA
		           ' WHERE ' + @sBase + ' AND ' + @xSectorV  --CESAR SECTOR VENTA
		           
		EXECUTE  sp_executesql @sql
		end

	if @flagTarjetaCredito=1
		begin	
		 SET @sql = ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, nVenta1, nVenta2, tObservacion ) ' + 
 		            ' SELECT '+@comilla+ '02'+@comilla+' AS tGrupo, '+@comilla+ 'Tarjeta Crdito'+@comilla+' AS Grupo, dbo.DPAGODOCUMENTO.tTarjeta AS tSubGrupo, dbo.TTARJETACREDITO.tResumido AS SubGrupo, '+@comilla+ ''+@comilla+' AS tDocumento, '+@comilla+ ''+@comilla+' AS tUsuario, '+@comilla+ ''+@comilla+' AS fFecha, '+@comilla+ ''+@comilla+' AS fPago, ' +
 		            ' sUM(nVenta) AS nVenta, SUM(dbo.DPAGODOCUMENTO.nMonto) as nVenta1, SUM(dbo.DPAGODOCUMENTO.nPropina) As nVenta2, '+@comilla+ ''+@comilla+' as tObservacion ' + 
		            ' FROM dbo.TTARJETACREDITO RIGHT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.TTARJETACREDITO.tCodigoTarjeta = dbo.DPAGODOCUMENTO.tTarjeta RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
  		            ' WHERE dbo.DPAGODOCUMENTO.tTipoPago='+@comilla+ '02'+@comilla+' and ' + @xBase +
 			    ' GROUP BY dbo.DPAGODOCUMENTO.tTarjeta, dbo.TTARJETACREDITO.tResumido'
		EXECUTE  sp_executesql @sql
   				delete from #DBTRANS where tGrupo=  '02' and isnull(nVenta,0)=0
		end
	else
		begin
		
		 set @sql =  ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nTC, nVenta, nVenta1, nVenta2, tObservacion ) ' +
		             ' SELECT '+@comilla+ '02'+@comilla+' AS tGrupo, '+@comilla+ 'Tarjeta Crdito'+@comilla+' AS Grupo, dbo.DPAGODOCUMENTO.tTarjeta AS tSubGrupo, dbo.TTARJETACREDITO.tResumido AS SubGrupo, dbo.MDOCUMENTO.tDocumento, ' +
		             ' dbo.DPAGODOCUMENTO.tUsuario AS tUsuario, CONVERT(nvarchar(8), dbo.MDOCUMENTO.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.MDOCUMENTO.fRegistro, 8) AS fRegistro, ' +
		             ' CONVERT(nvarchar(8), dbo.DPAGODOCUMENTO.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.DPAGODOCUMENTO.fRegistro, 8) AS fPago, dbo.DPAGODOCUMENTO.nTipoCambio, ' +
		             ' dbo.MDOCUMENTO.nVenta As nVenta, dbo.DPAGODOCUMENTO.nMonto as nVenta1,dbo.DPAGODOCUMENTO.nPropina As nVenta2, '+@comilla+ 'Doc. Gen. : '+@comilla+' + dbo.MDOCUMENTO.tTurno + '+@comilla+ ' Nro. '+@comilla+' + dbo.DPAGODOCUMENTO.tNumero AS tObservacion '+
		             ' FROM dbo.TTARJETACREDITO RIGHT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.TTARJETACREDITO.tCodigoTarjeta = dbo.DPAGODOCUMENTO.tTarjeta RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento '+
		             ' LEFT JOIN dbo.TCAJA ON dbo.MDOCUMENTO.tCaja = dbo.TCAJA.tCaja ' +  --CESAR SECTOR VENTA
		             ' WHERE dbo.DPAGODOCUMENTO.tTipoPago='+@comilla+ '02'+@comilla+' and ' + @xBase + ' AND ' + @xSectorV  --CESAR SECTOR VENTA
		EXECUTE  sp_executesql @sql
		end
		
--PRINT @SQL 
	if @flagCheque =1 --cheques
		begin
		set @sql =   ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, nVenta1, nVenta2, tObservacion, nTC ) ' +
             			' SELECT '+@comilla+ '03'+@comilla+' AS tGrupo, '+@comilla+ 'Cheque / Deposito'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, '+@comilla+ ''+@comilla+' AS tDocumento, '+@comilla+ ''+@comilla+' AS tUsuario, '+@comilla+ ''+@comilla+' AS fFecha, '+@comilla+ ''+@comilla+' AS fPago, ' +
             			' SUM(nVenta) AS nVenta, SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '+@comilla+ '01'+@comilla+' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END) As nVenta1, ' +
             			' SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '+@comilla+ '02'+@comilla+' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END) As nVenta2, '+@comilla+ ''+@comilla+' as tObservacion, AVG(nTipoCambio) ' +
             			' FROM dbo.MDOCUMENTO LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento ' + 
            			' WHERE dbo.DPAGODOCUMENTO.tTipoPago='+@comilla+ '03'+@comilla+' and ' + @xBase
		EXECUTE  sp_executesql @sql
				delete from #DBTRANS where tGrupo='03' and isnull(nVenta,0)=0
		end
	else
		begin
		set @sql =   ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nTC, nVenta, nVenta1, nVenta2, tObservacion ) ' + 
             			' SELECT '+@comilla+ '03'+@comilla+' AS tGrupo, '+@comilla+ 'Cheque / Deposito'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, dbo.MDOCUMENTO.tDocumento, ' + 
            			' dbo.DPAGODOCUMENTO.tUsuario AS tUsuario, CONVERT(nvarchar(8), dbo.MDOCUMENTO.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.MDOCUMENTO.fRegistro, 8) AS fRegistro, ' +
             			' CONVERT(nvarchar(8), dbo.DPAGODOCUMENTO.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.DPAGODOCUMENTO.fRegistro, 8) AS fPago, dbo.DPAGODOCUMENTO.nTipoCambio, ' +
             			' dbo.MDOCUMENTO.nVenta As nVenta, ' + 
             			' CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '+@comilla+ '01'+@comilla+' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END As nVenta1, ' + 
             			' CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '+@comilla+ '02'+@comilla+' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END As nVenta2, '+@comilla+ 'Doc. Gen. : '+@comilla+' + dbo.MDOCUMENTO.tTurno + '+@comilla+ ' Nro. '+@comilla+' + dbo.DPAGODOCUMENTO.tNumero AS tObservacion ' +
             			' FROM dbo.MDOCUMENTO LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento ' +
            			' LEFT JOIN dbo.TCAJA ON dbo.MDOCUMENTO.tCaja = dbo.TCAJA.tCaja ' + --CESAR SECTOR VENTA
            			' WHERE dbo.DPAGODOCUMENTO.tTipoPago='+@comilla+ '03'+@comilla+' and '+ @xBase + ' AND ' + @xSectorV  --CESAR SECTOR VENTA   
		EXECUTE  sp_executesql @sql
		end
		
--PRINT @SQL
	if @flagPagosVarios =1 --pagos varios
		begin
		set @sql= ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, nVenta1, nVenta2, tObservacion, nTC ) ' + 
	                  ' SELECT '+@comilla+ '04'+@comilla+' AS tGrupo, '+@comilla+ 'Otros Pagos'+@comilla+' AS Grupo, dbo.DPAGODOCUMENTO.tOtroTipoPago AS tSubGrupo, vTipoCancelacion.Descripcion AS SubGrupo, '+@comilla+ ''+@comilla+' AS tDocumento, '+@comilla+ ''+@comilla+' AS tUsuario, '+@comilla+ ''+@comilla+' AS fFecha, '+@comilla+ ''+@comilla+' AS fPago, ' + 
			  ' SUM(nVenta) AS nVenta,  SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '+@comilla+ '01'+@comilla+' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END) As nVenta1, ' + 
	        	  ' SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '+@comilla+ '02'+@comilla+' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END) As nVenta2, '+@comilla+ ''+@comilla+' as tObservacion, AVG(nTipoCambio) ' + 
		          ' FROM dbo.vTipoCancelacion RIGHT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.vTipoCancelacion.Codigo = dbo.DPAGODOCUMENTO.tOtroTipoPago RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento ' + 
        	     	  ' WHERE dbo.DPAGODOCUMENTO.tTipoPago='+@comilla+ '04'+@comilla+' and ' + @xBase +
 	        	  ' GROUP BY dbo.DPAGODOCUMENTO.tOtroTipoPago, dbo.vTipoCancelacion.Descripcion '
		EXECUTE  sp_executesql @sql
	             	delete from #DBTRANS where tGrupo='04' and isnull(nVenta,0)=0
		end
	else
		begin
		set @sql= ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nTC, nVenta, nVenta1, nVenta2, tObservacion ) ' +
             			' SELECT '+@comilla+ '04'+@comilla+' AS tGrupo, '+@comilla+ 'Otros Pagos'+@comilla+' AS Grupo, dbo.DPAGODOCUMENTO.tOtroTipoPago AS tSubGrupo, vTipoCancelacion.Descripcion AS SubGrupo, dbo.MDOCUMENTO.tDocumento, ' +
             			' dbo.DPAGODOCUMENTO.tUsuario AS tUsuario, CONVERT(nvarchar(8), dbo.MDOCUMENTO.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.MDOCUMENTO.fRegistro, 8) AS fRegistro, ' +
             			' CONVERT(nvarchar(8), dbo.DPAGODOCUMENTO.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.DPAGODOCUMENTO.fRegistro, 8) AS fPago, dbo.DPAGODOCUMENTO.nTipoCambio, ' +
		             	' dbo.MDOCUMENTO.nVenta As nVenta, CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '+@comilla+ '01'+@comilla+' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END As nVenta1, ' +
		             	' CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '+@comilla+ '02'+@comilla+' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END As nVenta2, '+@comilla+ 'Doc. Gen. : '+@comilla+' + dbo.MDOCUMENTO.tTurno + '+@comilla+ ' '+@comilla+' + CASE WHEN isnull(dbo.dPagoDocumento.tNumero,'+@comilla+ ''+@comilla+')='+@comilla+ ''+@comilla+' then '+@comilla+ ''+@comilla+' else '+@comilla+ 'Doc: '+@comilla+' END + ltrim(dbo.DPAGODOCUMENTO.tNumero) + '+@comilla+ ' '+@comilla+' + lTrim(dbo.DPAGODOCUMENTO.tBanco) AS tObservacion  ' +
		             	' FROM dbo.vTipoCancelacion RIGHT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.vTipoCancelacion.Codigo = dbo.DPAGODOCUMENTO.tOtroTipoPago RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
		   	            ' LEFT JOIN dbo.TCAJA ON dbo.MDOCUMENTO.tCaja = dbo.TCAJA.tCaja ' + --CESAR SECTOR VENTA
		   	            ' WHERE dbo.DPAGODOCUMENTO.tTipoPago='+@comilla+ '04'+@comilla+' and ' + @xBase + ' AND ' + @xSectorV  --CESAR SECTOR VENTA 
		EXECUTE  sp_executesql @sql
		end
		
--PRINT @SQL
	if @flagPunto=1 --inserta puntos
		begin
		 set @sql= 	' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, nVenta1, nVenta2, tObservacion ) ' +
             			' SELECT '+@comilla+ '05'+@comilla+' AS tGrupo, '+@COMILLA+ @sClub+@comilla + ' as Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, '+@comilla+ ''+@comilla+' AS tDocumento, '+@comilla+ ''+@comilla+' AS tUsuario, '+@comilla+ ''+@comilla+' AS fFecha, '+@comilla+ ''+@comilla+' AS fPago, ' +
             			' SUM(nVenta) AS nVenta, SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '+@comilla+ '01'+@comilla+' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END) As nVenta1, ' +
             			' 0 As nVenta2, '+@comilla+ ''+@comilla+' as tObservacion ' +
             			' FROM dbo.vDelivery RIGHT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.vDelivery.Codigo = dbo.DPAGODOCUMENTO.tNumero RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
             			' WHERE dbo.DPAGODOCUMENTO.tTipoPago='+@comilla+ '05'+@comilla+' and ' + @xBase

 		EXECUTE  sp_executesql @sql     
     		delete from #DBTRANS where tGrupo='05' and isnull(nVenta,0)=0
		end
	else
		begin
		set @sql= ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nTC, nVenta, nVenta1, nVenta2, tObservacion ) ' + 
             			' SELECT '+@comilla+ '05'+@comilla+' AS tGrupo, '+@COMILLA+ @sClub+@comilla + ' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, dbo.MDOCUMENTO.tDocumento, ' + 
               			' dbo.DPAGODOCUMENTO.tUsuario AS tUsuario, CONVERT(nvarchar(8), dbo.DPAGODOCUMENTO.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.MDOCUMENTO.fRegistro, 8) AS fRegistro, ' +
		             	' CONVERT(nvarchar(8), dbo.DPAGODOCUMENTO.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.DPAGODOCUMENTO.fRegistro, 8) AS fPago, dbo.DPAGODOCUMENTO.nTipoCambio, ' +
		             	' dbo.MDOCUMENTO.nVenta As nVenta, ' +
		             	' CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '+@comilla+ '01'+@comilla+' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END As nVenta1, ' + 
		             	' 0 As nVenta2,'+@comilla+ 'Doc. Gen. : '+@comilla+' + dbo.MDOCUMENTO.tTurno + '+@comilla+ ' Cliente: '+@comilla+' + ltrim(dbo.vDelivery.Cliente) AS tObservacion ' + 
             			' FROM dbo.vDelivery RIGHT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.vDelivery.Codigo = dbo.DPAGODOCUMENTO.tNumero RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento ' + 
		               	' LEFT JOIN dbo.TCAJA ON dbo.MDOCUMENTO.tCaja = dbo.TCAJA.tCaja ' + --CESAR SECTOR VENTA
		               	' WHERE dbo.DPAGODOCUMENTO.tTipoPago='+@comilla+ '05'+@comilla+' and ' + @xBase + ' AND ' + @xSectorV  --CESAR SECTOR VENTA 
		EXECUTE  sp_executesql @sql     
		end
		
--PRINT @SQL
	if @flagPagoCortesia=1 --pagos con cortesia
		begin
		  set @sql = ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, nVenta1, nVenta2, tObservacion ) ' +
             			' SELECT '+@comilla+ '06'+@comilla+' AS tGrupo, '+@comilla+ 'Cancelacion Cortesias'+@comilla+' as Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, mdocumento.tDocumento, tUsuario, ' +
             			' convert(nvarchar(8), MDOCUMENTO.fRegistro,3) + '+@comilla+ ' '+@comilla+' + convert(nvarchar(5), MDOCUMENTO.fRegistro,8) as fFecha, fPago, nVenta, nVenta as nVenta1, 0 as nVenta2, (vCortesia.descripcion) as tObservacion  ' +
             			' From dbo.mDOCUMENTO left join vcortesia on mdocumento.tcortesia = vcortesia.Codigo ' +
             			' WHERE ltrim(rtrim(isnull(dbo.mDOCUMENTO.tCortesia,'+@comilla+ ''+@comilla+')))<>'+@comilla+ ''+@comilla+' and mdocumento.ttipodocumento<>'+@comilla+ '00'+@comilla+' and ' + @sBase + ' and testadodocumento='+@comilla+ '02'+@comilla
		EXECUTE  sp_executesql @sql  
		delete from #DBTRANS where tGrupo= '06'and isnull(nVenta,0)=0
   
		end
	else
		begin
		set @sql = ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, nVenta1, nVenta2, tObservacion ) ' + 
		             ' SELECT '+@comilla+ '06'+@comilla+' AS tGrupo, '+@comilla+ 'Cancelacion Cortesias'+@comilla+' as Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, mdocumento.tDocumento, tUsuario,  ' +
		             ' convert(nvarchar(8), MDOCUMENTO.fRegistro,3) + '+@comilla+ ' '+@comilla+' + convert(nvarchar(5), MDOCUMENTO.fRegistro,8) as fFecha, fPago, SUM(nVenta) AS nVenta, Sum(nVenta) as nVenta1, 0 as nVenta2, max(vCortesia.descripcion) as tObservacion ' +
		             ' From dbo.MDOCUMENTO  left join vcortesia on mdocumento.tcortesia = vcortesia.Codigo '  +
		             ' LEFT JOIN dbo.TCAJA ON dbo.MDOCUMENTO.tCaja = dbo.TCAJA.tCaja ' + --CESAR SECTOR VENTA
		             ' WHERE ltrim(rtrim(isnull(dbo.mDOCUMENTO.tCortesia,'+@comilla+ ''+@comilla+')))<>'+@comilla+ ''+@comilla+' and mdocumento.ttipodocumento<>'+@comilla+ '00'+@comilla+' and ' + @sBase + ' and testadodocumento='+@comilla+ '02'+@comilla+' AND '  + @xSectorV  + 
		             ' group by tdocumento, fRegistro, fpago, tusuario '
		EXECUTE  sp_executesql @sql  
		end
		
--PRINT @SQL
	if @flagPorCobrar=1 --doc por cobrar
		begin
		      set @sql =     ' insert into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, nVenta, nVenta1, tObservacion ) ' +
             			     ' SELECT '+@comilla+ '07'+@comilla+' AS tGrupo, '+@comilla+ 'Cuentas por Cobrar'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, '+@comilla+ ''+@comilla+' AS tDocumento, '+@comilla+ ''+@comilla+' AS tUsuario, '+@comilla+ ''+@comilla+' AS fFecha,  ' +
		        	     ' SUM(MDOCUMENTO.nVenta) AS nVenta, SUM(MDOCUMENTO.nVenta) AS nVenta1, '+@comilla+ ''+@comilla+' AS tObservacion ' +
				     ' FROM MDOCUMENTO LEFT JOIN vCOMPANIA ON MDOCUMENTO.tClientePago = vCompania.Codigo  ' +
			             --' WHERE MDOCUMENTO.tEstadoDocumento = '+@comilla+ '03'+@comilla+' and isnull(MDOCUMENTO.tClientePago,'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+' and ' + @sBase
					' WHERE isnull(MDOCUMENTO.tClientePago,'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+' and ' + @sBase 
		EXECUTE  sp_executesql @sql  

		delete from #DBTRANS where tGrupo='11' and isnull(nVenta,0)=0

		end
	else
		begin
	      set @sql =  ' insert into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, nVenta, nVenta1, tObservacion ) ' + 
             		' SELECT '+@comilla+ '07'+@comilla+' as tGrupo, '+@comilla+ 'Cuentas por Cobrar'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, MDOCUMENTO.tDocumento, MDOCUMENTO.tUsuarioAutoriza, convert(nvarchar(8), MDOCUMENTO.fRegistro,3) + '+@comilla+ ' '+@comilla+' + convert(nvarchar(5), MDOCUMENTO.fRegistro,8) AS fRegistro,  ' +
             		' MDOCUMENTO.nVenta, MDOCUMENTO.nVenta as nVenta1, vCOMPANIA.Descripcion AS tObservacion ' + 
             		' FROM MDOCUMENTO LEFT JOIN vCOMPANIA ON MDOCUMENTO.tClientePago = vCompania.Codigo  ' +
             		' LEFT JOIN dbo.TCAJA ON dbo.MDOCUMENTO.tCaja = dbo.TCAJA.tCaja ' + --CESAR SECTOR VENTA
--             		' WHERE MDOCUMENTO.tEstadoDocumento = '+@comilla+ '03'+@comilla+' and isnull(MDOCUMENTO.tClientePago,'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+' and  ' + @sBase 
					' WHERE isnull(MDOCUMENTO.tClientePago,'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+' and  ' + @sBase + ' AND ' + @xSectorV  --CESAR SECTOR VENTA  
		EXECUTE  sp_executesql @sql 
		end
		
	 delete from #DBTRANS where tGrupo='07' and tDocumento in (select distinct tdocumento from #DBTRANS where (tGrupo='01' or tGrupo='02' or tGrupo='03' or tGrupo='04' or tGrupo='05' or tGrupo='06'))
--PRINT @SQL


	if @flagReciboIngreso=1 
		begin
	  set @sql =  ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, nVenta1, nVenta2, tObservacion ) ' +
             		' SELECT '+@comilla+ '08'+@comilla+' AS tGrupo, '+@comilla+ 'ReciboS de Ingreso'+@comilla+' as Grupo, tTipoPago AS tSubGrupo, vTipoPago.Descripcion AS SubGrupo, '+@comilla+ ''+@comilla+' AS tDocumento, '+@comilla+ ''+@comilla+' AS tUsuario, '+@comilla+ ''+@comilla+' AS fFecha, '+@comilla+ ''+@comilla+' AS fPago,  ' +
		        ' SUM(dbo.vIngreso.nMonto) As nVenta, SUM(CASE WHEN dbo.vIngreso.tMoneda = '+@comilla+ '01'+@comilla+' THEN dbo.vIngreso.nMonto ELSE 0 END) As nVenta1,  ' +
	  	        ' SUM(CASE WHEN dbo.vIngreso.tMoneda = '+@comilla+ '02'+@comilla+' THEN dbo.vIngreso.nMonto ELSE 0 END) As nVenta2, '+@comilla+ ''+@comilla+' as tObservacion ' +
		        ' FROM dbo.vIngreso LEFT OUTER JOIN dbo.vTipoPago ON dbo.vIngreso.tTipoPago = dbo.vTipoPago.Codigo ' + 
	            ' WHERE dbo.vIngreso.lAnticipo=0 and dbo.vIngreso.tEstadoDocumento='+@comilla+ '01'+@comilla+' and isnull(dbo.vIngreso.tCaja,'+@comilla+ '0'+@comilla+')<>'+@comilla+ '0'+@comilla+' ' + @sCriterio + 
	            ' Group by tTipoPago, vTipoPago.Descripcion '
		EXECUTE  sp_executesql @sql 
		 delete from #DBTRANS where tGrupo='06' and isnull(nVenta,0)=0
		end
	else
		begin
		
		  set @sql =  'Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nTC, nVenta, nVenta1, nVenta2, tObservacion ) ' + 
	             ' SELECT '+@comilla+ '08'+@comilla+' AS tGrupo, '+@comilla+ 'ReciboS de Ingreso'+@comilla+' AS Grupo, tTipoPago AS tSubGrupo, vTipoPago.Descripcion AS SubGrupo, dbo.vIngreso.tRecibo,  ' +
        	     ' dbo.vIngreso.tUsuario AS tUsuario, CONVERT(nvarchar(8), dbo.vIngreso.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.vIngreso.fRegistro, 8) AS fRegistro, ' +
	             ' CONVERT(nvarchar(8), dbo.vIngreso.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.vIngreso.fRegistro, 8) AS fPago, dbo.vIngreso.nTipoCambio, dbo.vIngreso.nMonto As nVenta, ' +
	             ' CASE WHEN dbo.vIngreso.tMoneda = '+@comilla+ '01'+@comilla+' THEN dbo.vIngreso.nMonto ELSE 0 END As nVenta1, CASE WHEN dbo.vIngreso.tMoneda = '+@comilla+ '02'+@comilla+' THEN dbo.vIngreso.nMonto ELSE 0 END As nVenta2, '+@comilla+ 'Doc. Gen. : '+@comilla+' + dbo.vIngreso.tTurno + '+@comilla+ ' Obs: '+@comilla+' + ltrim(dbo.vIngreso.tDescripcion) AS tObservacion  ' +
	             ' FROM dbo.vIngreso LEFT OUTER JOIN dbo.vTipoPago ON dbo.vIngreso.tTipoPago = dbo.vTipoPago.Codigo  ' +
	             ' LEFT JOIN dbo.TCAJA ON dbo.vIngreso.tCaja = dbo.TCAJA.tCaja ' + --CESAR SECTOR VENTA
	             ' WHERE dbo.vIngreso.lAnticipo=0 and dbo.vIngreso.tEstadoDocumento='+@comilla+ '01'+@comilla+' and isnull(dbo.vIngreso.tCaja,'+@comilla+ '0'+@comilla+')<>'+@comilla+ '0'+@comilla+ @sCriterio + ' AND ' + @xSectorV --CESAR SECTOR VENTA
		EXECUTE  sp_executesql @sql 
		End
--PRINT @SQL 


	if @flagReciboAnticipo=1 -- recibos anticipo
		begin
      		set @sql =  ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, nVenta1, nVenta2, tObservacion ) ' +
            	 	' SELECT '+@comilla+ '09'+@comilla+' AS tGrupo, '+@comilla+ 'Recibos de Anticipos'+@comilla+' as Grupo, tTipoPago AS tSubGrupo, vTipoPago.Descripcion AS SubGrupo, '+@comilla+ ''+@comilla+' AS tDocumento, '+@comilla+ ''+@comilla+' AS tUsuario, '+@comilla+ ''+@comilla+' AS fFecha, '+@comilla+ ''+@comilla+' AS fPago, ' + 
            	 	' SUM(dbo.vIngreso.nMonto) As nVenta, SUM(CASE WHEN dbo.vIngreso.tMoneda = '+@comilla+ '01'+@comilla+' THEN dbo.vIngreso.nMonto ELSE 0 END) As nVenta1,  ' +
            	 	' SUM(CASE WHEN dbo.vIngreso.tMoneda = '+@comilla+ '02'+@comilla+' THEN dbo.vIngreso.nMonto ELSE 0 END) As nVenta2, '+@comilla+ ''+@comilla+' as tObservacion  ' +
	     		' FROM dbo.vIngreso LEFT OUTER JOIN dbo.vTipoPago ON dbo.vIngreso.tTipoPago = dbo.vTipoPago.Codigo ' +
	     		' WHERE dbo.vIngreso.lAnticipo=1 and dbo.vIngreso.tEstadoDocumento='+@comilla+ '01'+@comilla+' and  ' + @sCriterio + 
             		' Group by tTipoPago, vTipoPago.Descripcion '
		EXECUTE  sp_executesql @sql 
	 	delete from #DBTRANS where tGrupo='07' and isnull(nVenta,0)=0
		end
	else
		begin
		      set @sql =  ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nTC, nVenta, nVenta1, nVenta2, tObservacion )  ' +
             		' SELECT '+@comilla+ '09'+@comilla+' AS tGrupo, '+@comilla+ 'Recibos de Anticipos'+@comilla+' AS Grupo, tTipoPago AS tSubGrupo, vTipoPago.Descripcion AS SubGrupo, dbo.vIngreso.tRecibo,  ' +
             		' dbo.vIngreso.tUsuario AS tUsuario, CONVERT(nvarchar(8), dbo.vIngreso.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.vIngreso.fRegistro, 8) AS fRegistro, ' +
		        ' CONVERT(nvarchar(8), dbo.vIngreso.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.vIngreso.fRegistro, 8) AS fPago, dbo.vIngreso.nTipoCambio, ' + 
	               ' dbo.vIngreso.nMonto As nVenta, CASE WHEN dbo.vIngreso.tMoneda = '+@comilla+ '01'+@comilla+' THEN dbo.vIngreso.nMonto ELSE 0 END As nVenta1, ' + 
	               ' CASE WHEN dbo.vIngreso.tMoneda = '+@comilla+ '02'+@comilla+' THEN dbo.vIngreso.nMonto ELSE 0 END As nVenta2, ' +@comilla+ 'Doc. Gen. : '+@comilla+' + dbo.vIngreso.tTurno + '+@comilla+ ' Obs: '+@comilla+' + ltrim(dbo.vIngreso.tDescripcion) AS tObservacion ' + 
	               ' FROM dbo.vIngreso LEFT OUTER JOIN dbo.vTipoPago ON dbo.vIngreso.tTipoPago = dbo.vTipoPago.Codigo ' +
	               ' LEFT JOIN dbo.TCAJA ON dbo.vIngreso.tCaja = dbo.TCAJA.tCaja ' + --CESAR SECTOR VENTA 
	               ' WHERE dbo.vIngreso.lAnticipo=1 and dbo.vIngreso.tEstadoDocumento='+@comilla+ '01'+@comilla+' and isnull(dbo.vIngreso.tCaja,'+@comilla+ '0'+@comilla+')<>'+@comilla+ '0'+@comilla+' ' + ' and isnull(vIngreso.tCaja,'+@comilla+ '0'+@comilla+')<>'+@comilla+ '0'+@comilla+' ' + @sCriterio + ' AND ' + @xSectorV --CESAR
		EXECUTE  sp_executesql @sql 
		end
--PRINT @SQL
	if @flagReciboEgreso=1 --recibos de egreso
		begin 
		 set @sql =  ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, nVenta1, nVenta2, tObservacion ) ' + 
             		' SELECT '+@comilla+ '10'+@comilla+' AS tGrupo, '+@comilla+ 'Recibos de Egreso'+@comilla+' as Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, '+@comilla+ ''+@comilla+' AS tDocumento, '+@comilla+ ''+@comilla+' AS tUsuario, '+@comilla+ ''+@comilla+' AS fFecha, '+@comilla+ ''+@comilla+' AS fPago, ' +
             		' SUM(dbo.vEgreso.nMonto) As nVenta,  SUM(CASE WHEN dbo.vEgreso.tMoneda = '+@comilla+ '01'+@comilla+' THEN dbo.vEgreso.nMonto ELSE 0 END) As nVenta1, ' + 
             		' SUM(CASE WHEN dbo.vEgreso.tMoneda = '+@comilla+ '02'+@comilla+' THEN dbo.vEgreso.nMonto ELSE 0 END) As nVenta2, '+@comilla+ ''+@comilla+' as tObservacion ' +
             		' FROM dbo.vEgreso ' +
             		' WHERE dbo.vEgreso.tEstadoDocumento='+@comilla+ '01'+@comilla+' and ' + @sCriterio
		EXECUTE  sp_executesql @sql 
      		delete from #DBTRANS where tGrupo='08' and isnull(nVenta,0)=0
		end
	else
		begin 
		 set @sql =  ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nTC, nVenta, nVenta1, nVenta2, tObservacion ) ' + 
             		' SELECT '+@comilla+ '10'+@comilla+' AS tGrupo, '+@comilla+ 'Recibos de Egreso'+@comilla+' AS Grupo, dbo.vegreso.ttipoEgreso AS tSubGrupo, dbo.vegreso.tipoegreso AS SubGrupo, dbo.vEgreso.tRecibo, ' +
             		' dbo.vEgreso.tUsuario AS tUsuario, CONVERT(nvarchar(8), dbo.vEgreso.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.vEgreso.fRegistro, 8) AS fRegistro, '+
             		' CONVERT(nvarchar(8), dbo.vEgreso.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.vEgreso.fRegistro, 8) AS fPago, dbo.vEgreso.nTipoCambio, '+
             		' dbo.vEgreso.nMonto As nVenta, ' +
             		' CASE WHEN dbo.vEgreso.tMoneda = '+@comilla+ '01'+@comilla+' THEN dbo.vEgreso.nMonto ELSE 0 END As nVenta1, ' +
             		' CASE WHEN dbo.vEgreso.tMoneda = '+@comilla+ '02'+@comilla+' THEN dbo.vEgreso.nMonto ELSE 0 END As nVenta2, '+@comilla+ 'Doc. Gen. : '+@comilla+' + dbo.vEgreso.tTurno + '+@comilla+ ' Obs: '+@comilla+' + ltrim(dbo.vEgreso.tDescripcion) AS tObservacion ' +
             		' FROM dbo.vEgreso LEFT JOIN dbo.TCAJA ON dbo.vEgreso.tCaja = dbo.TCAJA.tCaja ' + --CESAR
             		' WHERE dbo.vEgreso.tEstadoDocumento='+@comilla+ '01'+@comilla+' AND ' + @xSectorV + ' AND isnull(dbo.vEgreso.tCaja,'+@comilla+ '0'+@comilla+')<>'+@comilla+ '0'+@comilla+' ' + ' and  isnull(dbo.vEgreso.tCaja,'+@comilla+ '0'+@comilla+')<>'+@comilla+ '0'+@comilla+' ' + @sCriterio --CESAR
		EXECUTE  sp_executesql @sql 
		end  
--PRINT @SQL

	--cortesias
	if @flagNoCortesia =1
		if @flagCortesia = 1
			begin
			   set     @sql = ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, nVenta1, tObservacion ) ' + 
                			' SELECT '+@comilla+ '11'+@comilla+' AS tGrupo, '+@comilla+ 'Cortesias'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, '+@comilla+ ''+@comilla+' AS tDocumento, '+@comilla+ ''+@comilla+' AS tUsuario, '+@comilla+ ''+@comilla+' AS fFecha, '+@comilla+ ''+@comilla+' AS fPago, ' + 
		        	        ' SUM(dbo.MDOCUMENTO.nVenta) AS nVenta, SUM(dbo.MDOCUMENTO.nVenta) AS nVenta1, '+@comilla+ ''+@comilla+' as tObservacion ' + 
	        		        ' From dbo.MDOCUMENTO WHERE dbo.MDOCUMENTO.tTipoDocumento ='+@comilla+ '00'+@comilla+ ' and dbo.mdocumento.testadodocumento <>'+@comilla+'04'+@comilla +' and  ' + @sBase 
				EXECUTE  sp_executesql @sql
		         	delete from #DBTRANS where tGrupo='09' and isnull(nVenta,0)=0
			end
		else
		
			begin
   		       	   set     @sql = 'Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, nVenta1, tObservacion ) ' + 
			                ' SELECT '+@comilla+ '11'+@comilla+' AS tGrupo, '+@comilla+ 'Cortesias'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, dbo.vCortesia.Descripcion AS SubGrupo, dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.tUsuarioAutoriza AS tUsuario, ' +
			                ' CONVERT(nvarchar(8), dbo.MDOCUMENTO.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.MDOCUMENTO.fRegistro, 8) AS fRegistro, CONVERT(nvarchar(8), dbo.MDOCUMENTO.fPago, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.MDOCUMENTO.fPago, 8) AS fPago, ' + 
			                ' dbo.MDOCUMENTO.nVenta AS nVenta, dbo.MDOCUMENTO.nVenta AS nVenta1, ' + 
			                ' dbo.MDOCUMENTO.tTurno + '+@comilla+ ' '+@comilla+' + ISNULL(dbo.vCortesia.Descripcion, N'+@comilla+ ''+@comilla+') AS tObservacion ' +
			                ' FROM dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vCortesia ON dbo.MDOCUMENTO.tCortesia = dbo.vCortesia.Codigo LEFT OUTER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo ' + 
			                ' LEFT JOIN dbo.TCAJA ON dbo.MDOCUMENTO.tCaja = dbo.TCAJA.tCaja ' + --CESAR 
			                ' WHERE dbo.MDOCUMENTO.tTipoDocumento ='+@comilla+ '00'+@comilla+' and dbo.mdocumento.testadodocumento<>'+@comilla+'04'+@comilla +' and ' + @sBase + ' AND ' + @xSectorV --CESAR
				EXECUTE  sp_executesql @sql
			end
--PRINT @SQL
	--cuentas corrientes
	if @flagCuentaCorriente=1 
		begin
		 set @sql = ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, nVenta, nVenta1, tObservacion ) ' + 
                		' SELECT '+@comilla+ '12'+@comilla+' AS tGrupo, '+@comilla+ 'Cuenta Corriente'+@comilla+' AS Grupo, '+@comilla+ '12'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, '+@comilla+ ''+@comilla+' AS tDocumento, '+@comilla+ ''+@comilla+' AS tUsuario, '+@comilla+ ''+@comilla+' AS fFecha, ' + 
               			' SUM(DPEDIDO.nVenta) AS nVenta, SUM(DPEDIDO.nVenta) AS nVenta1, '+@comilla+ ''+@comilla+' AS tObservacion ' + 
		                ' FROM dbo.MPEDIDO LEFT OUTER JOIN DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ' +
               			 ' WHERE ' + @yBase + ' AND (dbo.MPEDIDO.tEstadoPedido = N'+@comilla+ '04'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem <> N'+@comilla+ 'A'+@comilla+')'
		EXECUTE  sp_executesql @sql

    			  delete from #DBTRANS where tGrupo='10' and isnull(nVenta,0)=0
		end		
	else
		begin 
		 set @sql =' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento,tUsuario,fFecha,nVenta,nVenta1,tObservacion ) ' + 
             			' SELECT '+@comilla+ '12'+@comilla+' AS tGrupo, '+@comilla+ 'Cuenta Corriente'+@comilla+' AS Grupo, '+@comilla+ '12'+@comilla+' AS tSubGrupo,'+@comilla+ ' '+@comilla+' AS SubGrupo,MPEDIDO.tCodigoPedido AS tDocumento, ' +
             			' MAX(MPEDIDO.tUsuario) AS tUsuario,MAX(CONVERT(nvarchar(8),MPEDIDO.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), MPEDIDO.fRegistro, 8)) AS fRegistro, SUM(DPEDIDO.nVenta) AS nVenta1,SUM(DPEDIDO.nVenta) AS nVenta, (vCompania.tNomSoc) AS tObservacion ' +
             			' FROM dbo.MPEDIDO LEFT OUTER JOIN DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido RIGHT OUTER JOIN  vCompania ON dbo.MPEDIDO.tClienteCtaCte = dbo.vCompania.Codigo ' +
             			' LEFT JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + --CESAR 
             			' WHERE ' + @yBase + ' AND ' + @xSectorV + ' AND (dbo.MPEDIDO.tEstadoPedido <> N'+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem <> N'+@comilla+ 'A'+@comilla+')  and isnull(mpedido.tclientectacte,'+@comilla+ ' '+@comilla+')<> '+@comilla+ ' '+@comilla+ ' ' +
             			' GROUP BY dbo.vCompania.tNomSoc,dbo.MPEDIDO.tCodigoPedido , dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tClienteCtaCte '
		EXECUTE  sp_executesql @sql
		end
--PRINT @SQL
	if @flagAnulado =1 -- anulados
		begin
			set @sql =  ' insert into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, nVenta, tObservacion ) ' +
        			    ' SELECT '+@comilla+ '13'+@comilla+' AS tGrupo, '+@comilla+ 'Documentos Anulados'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, '+@comilla+ ''+@comilla+' AS tDocumento, '+@comilla+ ''+@comilla+' AS tUsuario, '+@comilla+ ''+@comilla+' AS fFecha, SUM(MDOCUMENTO.nVenta) as nVenta, '+@comilla+ ''+@comilla+' as tOBservacion  ' + 
 				    ' FROM MDOCUMENTO WHERE tEstadoDocumento = '+@comilla+ '04'+@comilla+' and ' + @sBase
		EXECUTE  sp_executesql @sql	
		delete from #DBTRANS where tGrupo=12 and isnull(nVenta,0)=0
		end
	else
		begin 
			set @sql =  ' insert into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, tObservacion ) ' + 
     	       			    ' SELECT '+@comilla+ '13'+@comilla+' as tGrupo, '+@comilla+ 'Documentos Anulados'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, MDOCUMENTO.tDocumento, MDOCUMENTO.tUsuarioAnulado,  convert(nvarchar(8), MDOCUMENTO.fRegistro,3) + '+@comilla+ ' '+@comilla+' + convert(nvarchar(5), MDOCUMENTO.fRegistro,8) AS fRegistro, convert(nvarchar(8), MDOCUMENTO.fRegistroAnulado,3) + '+@comilla+ ' '+@comilla+' + convert(nvarchar(5), MDOCUMENTO.fRegistroAnulado,8) AS fPago, ' +  
     	  			    ' MDOCUMENTO.nVenta, MDOCUMENTO.tObservacion  FROM MDOCUMENTO LEFT JOIN dbo.TCAJA ON dbo.MDOCUMENTO.tCaja = dbo.TCAJA.tCaja ' + --CESAR 
    				    ' WHERE tEstadoDocumento = '+@comilla+ '04'+@comilla+' and ' + @sBase + ' AND ' + @xSectorV
		EXECUTE  sp_executesql @sql	
		end
--PRINT @SQL
	if @flagPedidoOtroRango=1
				  --Inserta Pedidos facturados en otro rango
		begin
		      set @sql = ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, nVenta, nVenta1,tObservacion ) ' + 
		        	     ' SELECT '+@comilla+ '14'+@comilla+' AS tGrupo, '+@comilla+ 'Pedidos Facturados en otro Rango'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo,'+@comilla+ ' '+@comilla+' AS SubGrupo, '+@comilla+ ''+@comilla+' AS tDocumento,'+@comilla+ ''+@comilla+', '+@comilla+ ''+@comilla+', sum(T1.nVenta) as nVenta, sum(T1.nVenta) as nVenta2, '+@comilla+ ''+@comilla+
		             	     ' FROM (SELECT DISTINCT  dbo.MPEDIDO.tCodigoPedido, dbo.MPEDIDO.fFecha, dbo.DPEDIDO.nVenta, dbo.MPEDIDO.tUsuario, dbo.DPEDIDO.tDocumento, dbo.DPEDIDO.tItem FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO INNER JOIN dbo.DDOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DDOCUMENTO.tDocumento ON dbo.MPEDIDO.tCodigoPedido = dbo.DDOCUMENTO.tCodigoPedido '+
		        	     ' WHERE (' + @sbase + ' AND not (' + @yBase  + ')) and mdocumento.testadodocumento in ('+@comilla+ '02'+@comilla+','+@comilla+ '03'+@comilla+')    ) T1 '

		        	--     ' WHERE (' + @sbase + ' AND not (' + @yBase  + ')) and mdocumento.testadodocumento='+@comilla+ '02'+@comilla+' ) T1 '
			EXECUTE  sp_executesql @sql	
			delete from #DBTRANS where tGrupo='15' and isnull(nVenta,0)=0
		end	
	else 
		begin 
		      set @sql = ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, nVenta, nVenta1,tObservacion ) ' + 
             			 ' SELECT '+@comilla+ '14'+@comilla+' AS tGrupo, '+@comilla+ 'Pedidos Facturados en otro Rango'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo,'+@comilla+ ' '+@comilla+' AS SubGrupo, T1.tCodigoPedido AS tDocumento, T1.tUsuario, T1.fFecha, sum(T1.nVenta) as nVenta, sum(T1.nVenta) as nVenta2, T1.tDocumento ' + 
             			 ' FROM (SELECT DISTINCT  dbo.MPEDIDO.tCodigoPedido, dbo.MPEDIDO.fFecha, dbo.DPEDIDO.nVenta, dbo.MPEDIDO.tUsuario, dbo.DPEDIDO.tDocumento, dbo.DPEDIDO.tItem ' + 
			         ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO INNER JOIN dbo.DDOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DDOCUMENTO.tDocumento ON dbo.MPEDIDO.tCodigoPedido = dbo.DDOCUMENTO.tCodigoPedido ' + 
	     			 ' LEFT JOIN dbo.TCAJA ON dbo.MDOCUMENTO.tCaja = dbo.TCAJA.tCaja ' + --CESAR 
	     			 ' WHERE ' + @xSectorV + ' AND (' + @sbase + ' AND not (' + @yBase  + ')) and mdocumento.testadodocumento in ('+@comilla+ '02'+@comilla+','+@comilla+ '03'+@comilla+')  ) T1 '+
	     			 --' WHERE (' + @sbase + ' AND not (' + @yBase  + ')) and mdocumento.testadodocumento='+@comilla+ '02'+@comilla+'  or mdocumento.testadodocumento='+@comilla+ '03'+@comilla+'  ) T1 '+
             		 ' Group by T1.tcodigopedido, T1.tUsuario, T1.fFecha, T1.tDocumento '

			EXECUTE  sp_executesql @sql	
		end
--PRINT @SQL

		--Inserta Correlativo de Documentos
			set @sql = ' insert into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, fFecha, nVenta1, nVenta2, tObservacion ) ' + 
			           ' SELECT '+@comilla+ '15'+@comilla+' as tGrupo, '+@comilla+ 'Correlativo Documentos'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, min(tDocumento) as Minimo, max(tDocumento) as Maximo, ' + 
			           ' sum(case when tEstadoDocumento<>'+@comilla+ '04'+@comilla+' then 1 else 0 End) as Emitido, sum(case when tEstadoDocumento='+@comilla+ '04'+@comilla+' then 1 else 0 End) As Anulado,  vTipoDocumento.Descripcion as Documento '+ 
				       ' from MDOCUMENTO LEFT JOIN vTipoDocumento ON MDOCUMENTO.tTipoDocumento = vTipoDocumento.Codigo ' + 
				       ' LEFT JOIN dbo.TCAJA ON dbo.MDOCUMENTO.tCaja = dbo.TCAJA.tCaja ' + --CESAR 
			           ' where tTipoDocumento <>'+@comilla+ '00'+@comilla+' and isnull(dbo.MDOCUMENTO.tCaja,'+@comilla+ '0'+@comilla+')<>'+@comilla+ '0'+@comilla+' ' + @sCriterio + 'AND ' + @xSectorV +
			           ' Group by tTipoDocumento, vTipoDocumento.Descripcion, substring(tDocumento,2,5)  '
		EXECUTE  sp_executesql @sql	
--PRINT @SQL

		 set     @sql = 'Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, nVenta1, tObservacion ) ' + 
	                ' SELECT '+@comilla+ '16'+@comilla+' AS tGrupo, '+@comilla+ 'Consumos Facturado'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ' '+@comilla+' AS SubGrupo, dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.tUsuario AS tUsuario, ' +
	                ' CONVERT(nvarchar(8), dbo.MDOCUMENTO.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.MDOCUMENTO.fRegistro, 8) AS fRegistro, CONVERT(nvarchar(8), dbo.MDOCUMENTO.fPago, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.MDOCUMENTO.fPago, 8) AS fPago, ' + 
	                ' dbo.MDOCUMENTO.nVenta AS nVenta, dbo.MDOCUMENTO.nVenta AS nVenta1, ' + 
	                ' CASE WHEN dbo.MDOCUMENTO.tOBSERVACION IS NULL THEN '+@comilla+ ' '+@comilla+' ELSE dbo.MDOCUMENTO.tOBSERVACION END    AS tObservacion ' +
	                ' FROM dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vCortesia ON dbo.MDOCUMENTO.tCortesia = dbo.vCortesia.Codigo LEFT OUTER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo ' + 
	                ' LEFT JOIN dbo.TCAJA ON dbo.MDOCUMENTO.tCaja = dbo.TCAJA.tCaja ' + --CESAR 
	                ' WHERE  mdocumento.ttipodocumento in (select codigo from vtipodocumento where registroventa=0) and dbo.mdocumento.testadodocumento<>'+@comilla+'04'+@comilla +' and ' + @sBase + ' AND ' + @xSectorV
		EXECUTE  sp_executesql @sql

	--inserta consumos no facturados!!

		set @sql = ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, nVenta1, tObservacion ) ' +
     			   ' SELECT Distinct '+@comilla+ '17'+@comilla+' AS tGrupo, '+@comilla+ 'No Cobrado'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.tUsuarioAutoriza AS tUsuario, ' +
		           ' CONVERT(nvarchar(8), dbo.MDOCUMENTO.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.MDOCUMENTO.fRegistro, 8) AS fRegistro, CONVERT(nvarchar(8), dbo.MDOCUMENTO.fPago, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.MDOCUMENTO.fPago, 8) AS fPago, ' + 
		           ' dbo.MDOCUMENTO.nVenta AS nVenta, CASE WHEN tTipoDocumento = '+@comilla+ '00'+@comilla+' THEN 0 WHEN tEstadoDocumento = '+@comilla+ '04'+@comilla+' THEN 0 ELSE nventa END As nVenta1, dbo.vEstadoDocumento.Descripcion AS tObservacion ' +
		           ' FROM dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vCortesia ON dbo.MDOCUMENTO.tCortesia = dbo.vCortesia.Codigo LEFT OUTER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento  ' +
		           ' LEFT JOIN dbo.TCAJA ON dbo.MDOCUMENTO.tCaja = dbo.TCAJA.tCaja ' + --CESAR 
		           ' WHERE mdocumento.testadodocumento='+@comilla+ '01'+@comilla+ ' AND mdocumento.tTipodocumento<>'+@comilla+ '00'+@comilla+ ' and '+ @sBase  + 'AND ' + @xSectorV + ' and  mdocumento.ttipodocumento in (select codigo from vtipodocumento where registroventa=1) '
							
		EXECUTE  sp_executesql @sql


 
     	set @sql = ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, nVenta1, tObservacion ) ' +
     			   ' SELECT Distinct '+@comilla+ '18'+@comilla+' AS tGrupo, '+@comilla+ 'Cobrados de Otro Turno'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.tUsuarioAutoriza AS tUsuario, ' +
		           ' CONVERT(nvarchar(8), dbo.MDOCUMENTO.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.MDOCUMENTO.fRegistro, 8) AS fRegistro, CONVERT(nvarchar(8), dbo.MDOCUMENTO.fPago, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.MDOCUMENTO.fPago, 8) AS fPago, ' + 
		           ' dbo.MDOCUMENTO.nVenta AS nVenta, CASE WHEN tTipoDocumento = '+@comilla+ '00'+@comilla+' THEN 0 WHEN tEstadoDocumento = '+@comilla+ '04'+@comilla+' THEN 0 ELSE nventa END As nVenta1, dbo.vEstadoDocumento.Descripcion + CASE WHEN isnull(dbo.dPagoDocumento.tTurno,'+@comilla+ ''+@comilla+')='+@comilla+ ''+@comilla+' then '+@comilla+ ''+@comilla+' else '+@comilla+ '-'+@comilla+'+ dbo.dPagoDocumento.tTurno  END AS tObservacion ' +
		           ' FROM dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vCortesia ON dbo.MDOCUMENTO.tCortesia = dbo.vCortesia.Codigo LEFT OUTER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento  ' +		          
				   ' LEFT JOIN dbo.TCAJA ON dbo.MDOCUMENTO.tCaja = dbo.TCAJA.tCaja ' + --CESAR 
				   ' where isnull(DPAGODOCUMENTO.tDocumento,'+@comilla+ '0'+@comilla+' )<>'+@comilla+ '0'+@comilla+'  and '+ @xbase + ' AND ' + @xSectorV + ' and dpagodocumento.tdocumento not in 	( select tdocumento from mdocumento where tTipoDocumento<>'+@comilla+ '00'+@comilla+' and testadodocumento= '+@comilla+ '02'+@comilla+' and isnull(MDOCUMENTO.tCaja,'+@comilla+ '0'+@comilla+')<>'+@comilla+ '0'+@comilla+' and '+@sbase +'    )'

 
		EXECUTE  sp_executesql @sql
 
--     	set @sql = ' Insert Into #DBTRANS (tGrupo, Grupo, tSubGrupo, SubGrupo, tDocumento, tUsuario, fFecha, fPago, nVenta, nVenta1, tObservacion ) ' +
--     			   ' SELECT Distinct '+@comilla+ '19'+@comilla+' AS tGrupo, '+@comilla+ 'Cancelados en Otro Rango'+@comilla+' AS Grupo, '+@comilla+ '00'+@comilla+' AS tSubGrupo, '+@comilla+ ''+@comilla+' AS SubGrupo, dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.tUsuarioAutoriza AS tUsuario, ' +
--		           ' CONVERT(nvarchar(8), dbo.MDOCUMENTO.fRegistro, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.MDOCUMENTO.fRegistro, 8) AS fRegistro, CONVERT(nvarchar(8), dbo.MDOCUMENTO.fPago, 3) + '+@comilla+ ' '+@comilla+' + CONVERT(nvarchar(5), dbo.MDOCUMENTO.fPago, 8) AS fPago, ' + 
--		           ' dbo.MDOCUMENTO.nVenta AS nVenta, CASE WHEN tTipoDocumento = '+@comilla+ '00'+@comilla+' THEN 0 WHEN tEstadoDocumento = '+@comilla+ '04'+@comilla+' THEN 0 ELSE nventa END As nVenta1, dbo.vEstadoDocumento.Descripcion + CASE WHEN isnull(dbo.dPagoDocumento.tTurno,'+@comilla+ ''+@comilla+')='+@comilla+ ''+@comilla+' then '+@comilla+ ''+@comilla+' else '+@comilla+ '-'+@comilla+'+ dbo.dPagoDocumento.tTurno  END AS tObservacion ' +
--		           ' FROM dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vCortesia ON dbo.MDOCUMENTO.tCortesia = dbo.vCortesia.Codigo LEFT OUTER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento  ' +
--		           ' WHERE  mdocumento.testadodocumento='+@comilla+ '02'+@comilla+ ' AND mdocumento.tTipodocumento<>'+@comilla+ '00'+@comilla+ ' AND '+ @sBase +' and dpagodocumento.tdocumento not in (select tdocumento from dpagodocumento where '+@xbase +') '
-- 		EXECUTE  sp_executesql @sql
-- 

 
declare @Nro int
DECLARE @Va int
declare @documento nvarchar(350)
declare @ndocumento nvarchar(350)
declare @nMinimo nvarchar(350)
declare @nMaximo nvarchar(350)
declare @nEmitido nvarchar(350)
declare @nAnulado nvarchar(350)

declare @Minimo nvarchar(350)
declare @Maximo nvarchar(350)
declare @Emitido nvarchar(350)
declare @Anulado nvarchar(350)
set @nEmitido=''
set @nanulado=''
set @nMinimo=''
set @nMaximo=''
set @documento=''
set @va=1
set @ndocumento=''

create table #temp0(documento nvarchar(450) collate Modern_Spanish_CI_AS, minimo nvarchar(450) collate Modern_Spanish_CI_AS,maximo nvarchar(450) collate Modern_Spanish_CI_AS,emitido nvarchar(450) collate Modern_Spanish_CI_AS,anulado nvarchar(450) collate Modern_Spanish_CI_AS)
create table #temp1(documento nvarchar(450) collate Modern_Spanish_CI_AS, minimo nvarchar(450) collate Modern_Spanish_CI_AS,maximo nvarchar(450) collate Modern_Spanish_CI_AS,emitido nvarchar(450) collate Modern_Spanish_CI_AS,anulado nvarchar(450) collate Modern_Spanish_CI_AS)

insert into #temp0 select tObservacion as Documento, tDocumento as minimo, fFecha as Maximo, nVenta1 as Emitido, nVenta2 as Anulado from #dbtrans where tGrupo='15' order by tObservacion, tDocumento
--select * from #temp0

select @nro= count(*) from #temp0

WHILE  @Va<=@nro
	BEGIN
		insert into #temp1 select top 1 * from #temp0
		select top 1 @documento=documento,@MInimo=minimo,@Maximo=maximo,@Emitido=emitido,@Anulado=anulado from #temp1	
		set @ndocumento=@ndocumento + @documento+char(13)
		set @nMInimo=@nMInimo + @minimo+char(13)
		set @nMaximo=@nMaximo + @maximo+char(13)
		set @nEmitido=@nEmitido + @Emitido+char(13)
		set @nAnulado=@nAnulado+ @Anulado+char(13)
		set @Va=@Va+1
	    delete from #temp1
		delete from #temp0 where documento=@documento and minimo=@minimo and MAXIMO=@maximo
	END
declare @maxGrupo nvarchar(2)
--select @maxgrupo = max(tgrupo) from #dbtrans group by tgrupo order by max(tgrupo) desc
   select top 1 @maxgrupo=tgrupo from #dbtrans order by tgrupo desc
PRINT 'maximo ' + @MAXGRUPO
set @sql=' UPDATE #DBTRANS SET tTipoDocumento='+@comilla+ @NDocumento+@comilla+', tInicio='+@comilla+ @NMINIMO+@comilla+', tFinal='+@comilla+ @NmAXIMO+@comilla+', tEmitido='+@comilla+ @NEMITIDO+@comilla+', tAnulado='+@comilla+ @NANULADO+@comilla+' where tGrupo='+@comilla+@maxgrupo+@comilla
EXECUTE  sp_executesql @sql

UPDATE #DBTRANS SET total00=(Select  Sum(isnull(nVenta1,0)) From #dbtrans Where tGrupo='00')
UPDATE #DBTRANS SET total14=(Select  Sum(isnull(nVenta1,0)) From #dbtrans Where tGrupo='14')

update #dbtrans set totalNF=(select sum (isnull(nventa1,0)) from #dbtrans where  tGrupo='00' AND tdocumento in (select tdocumento from mdocumento inner join vtipodocumento on mdocumento.ttipodocumento=vtipodocumento.codigo where   vtipodocumento.registroventa<>1))

update #dbtrans set totalNF=0 where totalNF is null

--UPDATE #DBTRANS SET nventa1=0 ,nventa2=0 where tGrupo<>'15' and tdocumento in (select tdocumento from mdocumento inner join vtipodocumento on mdocumento.ttipodocumento=vtipodocumento.codigo where vtipodocumento.registroventa<>1)

if @flagtipo='1' --rsreportes
		SELECT * FROM #DBTRANS order by tGrupo, tSubGrupo, SubGrupo, tDocumento	

if @flagtipo='2'	--rssuma aplicar filter
		select tGrupo, sum(nVenta1) as nVenta1, sum(nVenta2) as nVenta2, sum(nVenta2*isnull(nTC,0)) as nVenta3 From  #DBTRANS Group by tGrupo
if @flagTipo='3' --3  tarjetas
		select tSubGrupo, SubGrupo, sum(nVenta1) as nVenta1, sum(nVenta2) as nVenta2 From  #DBTRANS where tGrupo='02' Group by tSubGrupo, SubGrupo
if @flagTipo='4' --ingreso efectivo, ingreso anticipo filter '08 ' 09
		select tGrupo, sum(nVenta1) as nVenta1, sum(nVenta2) as nVenta2, sum(nVenta2*isnull(nTC,0)) as nVenta3 From  #DBTRANS where tSubGrupo='01' Group by tGrupo
if @flagTipo='5' -- tipo de cancelacion
--		SELECT * FROM #DBTRANS where tgrupo='04' order by tGrupo, tSubGrupo, SubGrupo, tDocumento	 
		--select substring('0'+tsubgrupo,2,3) as codigo FROM #DBTRANS where tgrupo='04' order by tGrupo, tSubGrupo, SubGrupo, tDocumento	 
		select substring('0'+tsubgrupo,2,3) as codigo , sum(nVenta1) as Codigo1,sum(nVenta2) as Codigo2, sum(case when round(nVenta1,2) > round(nVenta,2) then nVenta1 - nVenta else 0 end) as diferencia from #DBTRANS  where tGrupo='04'  group by substring('0'+tsubgrupo,2,3) order by  sum(nVenta1)  desc-- letfGROUP BY TSUBGRUPO

END



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE [dbo].[spRep_LiquidacionOutPut]
@flagTurno as bit,
@flagDiaContable as bit,
@sTurno as nvarchar(20),
@sUsuario as nvarchar(20),
@sSectorVenta As nVarchar(50),
@finicio as smalldatetime,
@ffinal as smalldatetime,
@xFecha as smalldatetime,
@Ndolar as float output,
@xDOlar as float output,
@nOtroDoc as float output,
@nNoCobrado as float output,
@nNeto as float output,
@nImpuesto1 as float output,
@nImpuesto2 as float output,
@nImpuesto3 as float output,
@nVenta as float output,
@nDescuento as float output,
@nRecargo as float output,
@nCambio as float output,
@nAdulto as float output,
@nNino as float output,
@nAdulto2 as float output,
@nNino2 as float output,
@nAdulto3 as float output,
@nNino3 as float output,
@nAdulto4 as float output,
@nNino4 as float output,
@nAdulto5 as float output,
@nNino5 as float output,
@nPagadosEnOtro as float output

AS BEGIN


/*tipo de cambio*/
--select @nCambio=nVenta  from TTIPOCAMBIO where fFecha= @xfecha
select @nCambio=nVenta  from TTIPOCAMBIO where fFecha= DATEADD(dd, 0, DATEDIFF(dd, 0, @xfecha)) 

set @ncambio=isnull(@ncambio,0)
/*nneto, nimpuesto...nrecargo*/
if @flagTurno=0
	if @susuario=''
		 select @nNeto=isnull(sum(nNeto),0) , @nImpuesto1=isnull(sum(nPrecioImpuesto1),0) , @nImpuesto2=isnull(sum(nPrecioImpuesto2),0) , @nImpuesto3=isnull(sum(nPrecioImpuesto3),0) , @nVenta=isnull(sum(nVenta),0) , @nDescuento=isnull(sum(nDescuento),0) , @nRecargo=isnull(sum(nRecargo),0) 
        	 From mdocumento where tEstadoDocumento<>'04' and tTipoDocumento <>'00' and tturno=@sTurno  and mdocumento.ttipodocumento in(select codigo from vtipodocumento where registroventa=1)
	else
		 select @nNeto=isnull(sum(nNeto),0) , @nImpuesto1=isnull(sum(nPrecioImpuesto1),0) , @nImpuesto2=isnull(sum(nPrecioImpuesto2),0) , @nImpuesto3=isnull(sum(nPrecioImpuesto3),0) , @nVenta=isnull(sum(nVenta),0) , @nDescuento=isnull(sum(nDescuento),0) , @nRecargo=isnull(sum(nRecargo),0) 
        	 From mdocumento where tEstadoDocumento<>'04' and tTipoDocumento <>'00' and tturno=@sTurno  and tusuario=@susuario and mdocumento.ttipodocumento in(select codigo from vtipodocumento where registroventa=1)
else
	if @flagDiaContable=0
		begin
					if @susuario=''
						 select @nNeto=isnull(sum(m.nNeto),0) , @nImpuesto1=isnull(sum(m.nPrecioImpuesto1),0) , @nImpuesto2=isnull(sum(m.nPrecioImpuesto2),0) , @nImpuesto3=isnull(sum(m.nPrecioImpuesto3),0) , @nVenta=isnull(sum(m.nVenta),0) , @nDescuento=isnull(sum(m.nDescuento),0) , @nRecargo=isnull(sum(m.nRecargo),0) 
        					 From mdocumento m LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja  where m.tEstadoDocumento<>'04' and m.tTipoDocumento <>'00' And m.fregistro>=@finicio and m.fregistro<=@ffinal and m.ttipodocumento in(select codigo from vtipodocumento where registroventa=1) And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
					else
						 select @nNeto=isnull(sum(m.nNeto),0) , @nImpuesto1=isnull(sum(m.nPrecioImpuesto1),0) , @nImpuesto2=isnull(sum(m.nPrecioImpuesto2),0) , @nImpuesto3=isnull(sum(m.nPrecioImpuesto3),0) , @nVenta=isnull(sum(m.nVenta),0) , @nDescuento=isnull(sum(m.nDescuento),0) , @nRecargo=isnull(sum(m.nRecargo),0) 
        					 From mdocumento m LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja where m.tEstadoDocumento<>'04' and m.tTipoDocumento <>'00' And m.fregistro>=@finicio and m.fregistro<=@ffinal and m.tusuario=@susuario and m.ttipodocumento in(select codigo from vtipodocumento where registroventa=1) And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
		end
	else
		begin
					if @susuario=''
						 select @nNeto=isnull(sum(m.nNeto),0) , @nImpuesto1=isnull(sum(m.nPrecioImpuesto1),0) , @nImpuesto2=isnull(sum(m.nPrecioImpuesto2),0) , @nImpuesto3=isnull(sum(m.nPrecioImpuesto3),0) , @nVenta=isnull(sum(m.nVenta),0) , @nDescuento=isnull(sum(m.nDescuento),0) , @nRecargo=isnull(sum(m.nRecargo),0) 
        					 From mdocumento m LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja where m.tEstadoDocumento<>'04' and m.tTipoDocumento <>'00' And m.fdiaContable>=@finicio and fdiaContable<=@ffinal and m.ttipodocumento in(select codigo from vtipodocumento where registroventa=1) And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
					else
						 select @nNeto=isnull(sum(m.nNeto),0) , @nImpuesto1=isnull(sum(m.nPrecioImpuesto1),0) , @nImpuesto2=isnull(sum(m.nPrecioImpuesto2),0) , @nImpuesto3=isnull(sum(m.nPrecioImpuesto3),0) , @nVenta=isnull(sum(m.nVenta),0) , @nDescuento=isnull(sum(m.nDescuento),0) , @nRecargo=isnull(sum(m.nRecargo),0) 
        					 From mdocumento m LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja where m.tEstadoDocumento<>'04' and m.tTipoDocumento <>'00' And m.fdiaContable>=@finicio and m.fdiaContable<=@ffinal and m.tusuario=@susuario and m.ttipodocumento in(select codigo from vtipodocumento where registroventa=1) And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')

		end
/*notrodoc*/
if @flagTurno=0
	if @sUsuario=''
		begin
			select @nOtroDoc= ISNULL(sum(t1.nventa),0) From (select distinct dpagodocumento.tdocumento, nventa FROM dbo.MDOCUMENTO INNER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento 
	      		where isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0' and DPAGODOCUMENTO.tturno=@sTurno and dpagodocumento.tdocumento not in (select tdocumento from mdocumento where tTipoDocumento<>'00' and testadodocumento= '02' and isnull(MDOCUMENTO.tCaja,'0')<>'0' and MDOCUMENTO.tTurno =@sTurno  )) T1
		end
	else
		begin
			select @nOtroDoc= ISNULL(sum(t1.nventa),0) From (select distinct dpagodocumento.tdocumento, nventa FROM dbo.MDOCUMENTO INNER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento 
	      		where isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0' and DPAGODOCUMENTO.tturno=@sTurno And DPAGODOCUMENTO.tUsuario=@sUsuario and dpagodocumento.tdocumento not in (select tdocumento from mdocumento where tTipoDocumento<>'00' and testadodocumento= '02' and isnull(MDOCUMENTO.tCaja,'0')<>'0' and MDOCUMENTO.tTurno =@sTurno And MDOCUMENTO.tUsuario=@sUsuario )) T1
		end

else
	if @flagDiaContable=0
	begin
				if @sUsuario=''
					begin
						select @nOtroDoc= ISNULL(sum(t1.nventa),0) From (select distinct dpagodocumento.tdocumento, nventa FROM dbo.MDOCUMENTO INNER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja 
	      					where isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0' And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='') and DPAGODOCUMENTO.fregistro>=@Finicio and dpagodocumento.fregistro<=@ffinal and dpagodocumento.tdocumento not in (select tdocumento from mdocumento where tTipoDocumento<>'00' and testadodocumento= '02' and isnull(MDOCUMENTO.tCaja,'0')<>'0' and MDOCUMENTO.fregistro >=@finicio and mdocumento.fregistro<=@ffinal  )) T1 
					end
				else
					begin
						select @nOtroDoc= ISNULL(sum(t1.nventa),0) From (select distinct dpagodocumento.tdocumento, nventa FROM dbo.MDOCUMENTO INNER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja 
	      					where isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0' And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='') and DPAGODOCUMENTO.fregistro>=@Finicio and dpagodocumento.fregistro<=@ffinal And DPAGODOCUMENTO.tUsuario=@sUsuario and dpagodocumento.tdocumento not in (select tdocumento from mdocumento where tTipoDocumento<>'00' and testadodocumento= '02' and isnull(MDOCUMENTO.tCaja,'0')<>'0' and MDOCUMENTO.fregistro >=@finicio and mdocumento.fregistro<=@ffinal And MDOCUMENTO.tUsuario=@sUsuario   )) T1 
					end
	end
	else
	begin
				if @sUsuario=''
					begin
						select @nOtroDoc= ISNULL(sum(t1.nventa),0) From (select distinct dpagodocumento.tdocumento, nventa FROM dbo.MDOCUMENTO INNER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja 
	      					where isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0' And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='') and DPAGODOCUMENTO.fdiaContable>=@Finicio and dpagodocumento.fdiaContable<=@ffinal and dpagodocumento.tdocumento not in (select tdocumento from mdocumento where tTipoDocumento<>'00' and testadodocumento= '02' and isnull(MDOCUMENTO.tCaja,'0')<>'0' and MDOCUMENTO.fdiaContable >=@finicio and mdocumento.fdiaContable<=@ffinal  )) T1 
					end
				else
					begin
						select @nOtroDoc= ISNULL(sum(t1.nventa),0) From (select distinct dpagodocumento.tdocumento, nventa FROM dbo.MDOCUMENTO INNER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja 
	      					where isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0' And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='') and DPAGODOCUMENTO.fdiaContable>=@Finicio and dpagodocumento.fdiaContable<=@ffinal And DPAGODOCUMENTO.tUsuario=@sUsuario and dpagodocumento.tdocumento not in (select tdocumento from mdocumento where tTipoDocumento<>'00' and testadodocumento= '02' and isnull(MDOCUMENTO.tCaja,'0')<>'0' and MDOCUMENTO.fdiaContable >=@finicio and mdocumento.fdiaContable<=@ffinal And MDOCUMENTO.tUsuario=@sUsuario   )) T1 
					end


	end

/*nDolar xDolar*/
if @flagTurno=0
	if @sUsuario=''
	begin
		select @nDolar=isnull(sum(nDolar),0) , @xDolar= isnull(sum(nDolar * nTipoCambio),0)  from dpagodocumento where tTipopago= '01' and tMoneda='02'  and isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0' and DPAGODOCUMENTO.tturno=@sTurno
	end
	else
		select @nDolar=isnull(sum(nDolar),0) , @xDolar= isnull(sum(nDolar * nTipoCambio),0)  from dpagodocumento where tTipopago= '01' and tMoneda='02'  and isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0' and DPAGODOCUMENTO.tturno=@sTurno And DPAGODOCUMENTO.tUsuario=@sUsuario
	
else
	if @flagDiaContable=0
	begin
			if @susuario=''
				begin
					select @nDolar=isnull(sum(nDolar),0) , @xDolar= isnull(sum(d.nDolar * d.nTipoCambio),0)  from dpagodocumento d LEFT JOIN dbo.MDOCUMENTO m ON d.tDocumento = m.tDocumento LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja  where d.tTipopago= '01' and d.tMoneda='02'  and isnull(d.tDocumento,'0')<>'0' and d.fregistro>=@Finicio and d.fregistro<=@ffinal And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
				end
			else
				begin
					select @nDolar=isnull(sum(nDolar),0) , @xDolar= isnull(sum(d.nDolar * d.nTipoCambio),0)  from dpagodocumento d LEFT JOIN dbo.MDOCUMENTO m ON d.tDocumento = m.tDocumento LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja  where d.tTipopago= '01' and d.tMoneda='02'  and isnull(d.tDocumento,'0')<>'0' and d.fregistro>=@Finicio and d.fregistro<=@ffinal And d.tUsuario=@sUsuario And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
				end

	end
	else
	begin
			if @susuario=''
				begin
					select @nDolar=isnull(sum(nDolar),0) , @xDolar= isnull(sum(d.nDolar * d.nTipoCambio),0)  from dpagodocumento d LEFT JOIN dbo.MDOCUMENTO m ON d.tDocumento = m.tDocumento LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja  where d.tTipopago= '01' and d.tMoneda='02'  and isnull(d.tDocumento,'0')<>'0' and d.fdiaContable>=@Finicio and d.fdiaContable<=@ffinal And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
				end
			else
				begin
					select @nDolar=isnull(sum(nDolar),0) , @xDolar= isnull(sum(d.nDolar * d.nTipoCambio),0)  from dpagodocumento d LEFT JOIN dbo.MDOCUMENTO m ON d.tDocumento = m.tDocumento LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja  where d.tTipopago= '01' and d.tMoneda='02'  and isnull(d.tDocumento,'0')<>'0' and d.fdiaContable>=@Finicio and d.fdiaContable<=@ffinal And d.tUsuario=@sUsuario And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
				end


	end
/*no cobrado*/
if @flagTurno=0
	 select @nNoCobrado=isnull(sum(nVenta),0)  from MDOCUMENTO where tEstadoDocumento= '01' and  tTurno =@sTurno and mdocumento.ttipodocumento in (select codigo from vtipodocumento where registroventa=1)
else
	if @flagDiaContable=0
	begin	
	 select @nNoCobrado=isnull(sum(m.nVenta),0)  from MDOCUMENTO m LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja  where m.tEstadoDocumento= '01' And m.fregistro >=@fINICIO AND m.fRegistro <=@FFINAL and m.ttipodocumento in (select codigo from vtipodocumento where registroventa=1) And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
	end
	else
	begin
	 select @nNoCobrado=isnull(sum(m.nVenta),0)  from MDOCUMENTO m LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja where m.tEstadoDocumento= '01' And m.fDiaContable >=@fINICIO AND m.fDiaContable <=@FFINAL and m.ttipodocumento in (select codigo from vtipodocumento where registroventa=1) And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
	end
 
/*ADULTO NIO*/
IF @flagTurno=0
	begin
	select @nAdulto=isnull(sum(nAdulto),0) , @nNino=isnull(sum(nNino),0) from MPEDIDO where MPEDIDO.tEstadoPedido <> '03' and MPEDIDO.tTipoPedido='01' and tturno=@sTurno
	
	select @nAdulto2=isnull(sum(nAdulto),0) , @nNino2=isnull(sum(nNino),0) from MPEDIDO where MPEDIDO.tEstadoPedido <> '03' and MPEDIDO.tTipoPedido='02' and tturno=@sTurno
	
	select @nAdulto3=isnull(sum(nAdulto),0) , @nNino3=isnull(sum(nNino),0) from MPEDIDO where MPEDIDO.tEstadoPedido <> '03' and MPEDIDO.tTipoPedido='03' and tturno=@sTurno
	
	select @nAdulto4=isnull(sum(nAdulto),0) , @nNino4=isnull(sum(nNino),0) from MPEDIDO where MPEDIDO.tEstadoPedido <> '03' and MPEDIDO.tTipoPedido='04' and tturno=@sTurno
	
	select @nAdulto5=isnull(sum(nAdulto),0) , @nNino5=isnull(sum(nNino),0) from MPEDIDO where MPEDIDO.tEstadoPedido <> '03' and MPEDIDO.tTipoPedido='05' and tturno=@sTurno
	
	end
else
	begin
		if @flagDiaContable=0
			begin
			select @nAdulto=isnull(sum(m.nAdulto),0) , @nNino=isnull(sum(m.nNino),0) from MPEDIDO m LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja  where m.tEstadoPedido <> '03'  and m.tTipoPedido='01' And m.fregistro >=@fINICIO AND m.fRegistro<=@FFINAL And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')	

			select @nAdulto2=isnull(sum(m.nAdulto),0) , @nNino2=isnull(sum(m.nNino),0) from MPEDIDO m LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja  where m.tEstadoPedido <> '03'  and m.tTipoPedido='02' And m.fregistro >=@fINICIO AND m.fRegistro<=@FFINAL And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')	
			
			select @nAdulto3=isnull(sum(m.nAdulto),0) , @nNino3=isnull(sum(m.nNino),0) from MPEDIDO m LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja  where m.tEstadoPedido <> '03'  and m.tTipoPedido='03' And m.fregistro >=@fINICIO AND m.fRegistro<=@FFINAL And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')	
			
			select @nAdulto4=isnull(sum(m.nAdulto),0) , @nNino4=isnull(sum(m.nNino),0) from MPEDIDO m LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja  where m.tEstadoPedido <> '03'  and m.tTipoPedido='04' And m.fregistro >=@fINICIO AND m.fRegistro<=@FFINAL And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')	
			
			select @nAdulto5=isnull(sum(m.nAdulto),0) , @nNino5=isnull(sum(m.nNino),0) from MPEDIDO m LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja  where m.tEstadoPedido <> '03'  and m.tTipoPedido='05' And m.fregistro >=@fINICIO AND m.fRegistro<=@FFINAL And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')	
			
			end
		else
			begin
			select @nAdulto=isnull(sum(m.nAdulto),0) , @nNino=isnull(sum(m.nNino),0) from MPEDIDO m LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja where m.tEstadoPedido <> '03'  and m.tTipoPedido='01' And m.fdiacontable >=@fINICIO AND m.fdiacontable<=@FFINAL And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
		    
			select @nAdulto2=isnull(sum(m.nAdulto),0) , @nNino2=isnull(sum(m.nNino),0) from MPEDIDO m LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja where m.tEstadoPedido <> '03'  and m.tTipoPedido='02' And m.fdiacontable >=@fINICIO AND m.fdiacontable<=@FFINAL And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
		    
			select @nAdulto3=isnull(sum(m.nAdulto),0) , @nNino3=isnull(sum(m.nNino),0) from MPEDIDO m LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja where m.tEstadoPedido <> '03'  and m.tTipoPedido='03' And m.fdiacontable >=@fINICIO AND m.fdiacontable<=@FFINAL And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
		    
			select @nAdulto4=isnull(sum(m.nAdulto),0) , @nNino4=isnull(sum(m.nNino),0) from MPEDIDO m LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja where m.tEstadoPedido <> '03'  and m.tTipoPedido='04' And m.fdiacontable >=@fINICIO AND m.fdiacontable<=@FFINAL And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
		    
			select @nAdulto5=isnull(sum(m.nAdulto),0) , @nNino5=isnull(sum(m.nNino),0) from MPEDIDO m LEFT JOIN dbo.TCAJA t ON m.tCaja = t.tCaja where m.tEstadoPedido <> '03'  and m.tTipoPedido='05' And m.fdiacontable >=@fINICIO AND m.fdiacontable<=@FFINAL And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
				
			end
	end

/*@nPagadosEnOtro*/
if @flagTurno=0
	if @sUsuario=''
		begin
			select @nPagadosEnOtro= ISNULL(sum(t1.nventa),0) From (select distinct dpagodocumento.tdocumento, nventa 
			FROM dbo.MDOCUMENTO INNER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento 
	      	where mdocumento.testadodocumento='02' AND mdocumento.tTipodocumento<>'00'
			and mdocumento.tturno=@sTurno and dpagodocumento.tdocumento 
			not in ( select tdocumento from dpagodocumento where dpagodocumento.tturno=@sTurno )) T1

			
		end
	else
		begin

			select @nPagadosEnOtro= ISNULL(sum(t1.nventa),0) From (select distinct dpagodocumento.tdocumento, nventa 
			FROM dbo.MDOCUMENTO INNER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento 
	      	where mdocumento.testadodocumento='02' AND mdocumento.tTipodocumento<>'00'
			and mdocumento.tturno=@sTurno  and MDOCUMENTO.tUsuario=@sUsuario and dpagodocumento.tdocumento 
			not in ( select tdocumento from dpagodocumento where dpagodocumento.tturno=@sTurno and   DPAGODOCUMENTO.tUsuario=@sUsuario)) T1

 		end

else
	if @flagDiaContable=0
	begin
			if @sUsuario=''
				begin
		 
					select @nPagadosEnOtro= ISNULL(sum(t1.nventa),0) From (select distinct dpagodocumento.tdocumento, nventa 
					FROM dbo.MDOCUMENTO INNER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja 
	      			where mdocumento.testadodocumento='02' AND mdocumento.tTipodocumento<>'00' And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
					and MDOCUMENTO.fregistro >=@finicio and mdocumento.fregistro<=@ffinal and dpagodocumento.tdocumento 
					not in ( select tdocumento from dpagodocumento where DPAGODOCUMENTO.fregistro>=@Finicio and dpagodocumento.fregistro<=@ffinal )) T1 




				end
			else
				begin
		 
					select @nPagadosEnOtro= ISNULL(sum(t1.nventa),0) From (select distinct dpagodocumento.tdocumento, nventa 
					FROM dbo.MDOCUMENTO INNER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja 
	      			where mdocumento.testadodocumento='02' AND mdocumento.tTipodocumento<>'00' And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
					and MDOCUMENTO.fregistro >=@finicio and mdocumento.fregistro<=@ffinal  and MDOCUMENTO.tUsuario=@sUsuario and dpagodocumento.tdocumento 
					not in ( select tdocumento from dpagodocumento where DPAGODOCUMENTO.fregistro>=@Finicio and dpagodocumento.fregistro<=@ffinal and   DPAGODOCUMENTO.tUsuario=@sUsuario)) T1

				end
	end
	else
	begin
			if @sUsuario=''
				begin
		 
					select @nPagadosEnOtro= ISNULL(sum(t1.nventa),0) From (select distinct dpagodocumento.tdocumento, nventa 
					FROM dbo.MDOCUMENTO INNER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja 
	      			where mdocumento.testadodocumento='02' AND mdocumento.tTipodocumento<>'00' And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
					and MDOCUMENTO.fdiaContable >=@finicio and mdocumento.fdiaContable<=@ffinal and dpagodocumento.tdocumento 
					not in ( select tdocumento from dpagodocumento where DPAGODOCUMENTO.fdiaContable>=@Finicio and dpagodocumento.fdiaContable<=@ffinal )) T1




				end
			else
				begin
		 
					select @nPagadosEnOtro= ISNULL(sum(t1.nventa),0) From (select distinct dpagodocumento.tdocumento, nventa 
					FROM dbo.MDOCUMENTO INNER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja 
	      			where mdocumento.testadodocumento='02' AND mdocumento.tTipodocumento<>'00' And (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
					and MDOCUMENTO.fdiaContable >=@finicio and mdocumento.fdiaContable<=@ffinal  and MDOCUMENTO.tUsuario=@sUsuario and dpagodocumento.tdocumento 
					not in ( select tdocumento from dpagodocumento where DPAGODOCUMENTO.fdiaContable>=@Finicio and dpagodocumento.fdiaContable<=@ffinal and   DPAGODOCUMENTO.tUsuario=@sUsuario)) T1

				end


	END

END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


CREATE PROCEDURE [dbo].[spRep_LiquidacionSuma]
@flagTurno as bit,
@flagDiaContable as bit,
@sTurno as nvarchar(30),
@sUsuario as nvarchar(30),
@finicio as smalldatetime,
@ffinal as smalldatetime,
@sSectorVenta as nvarchar(50)

AS BEGIN
set nocount on
  create table #suma (tDocumento nVarChar(20) collate Modern_Spanish_CI_AS, nNeto float, nImpuesto1 float, nImpuesto2 float, nImpuesto3 float, nVenta float, tTipoPedido nVarChar(2) collate Modern_Spanish_CI_AS,total00 float)

if @flagTurno=0
  if @sUsuario=''	
	BEGIN
	  insert #Suma (tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tTipoPedido) 
	  SELECT DISTINCT dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, dbo.MDOCUMENTO.nVenta, tTipoPedido 
	  FROM dbo.MPEDIDO INNER JOIN dbo.DDOCUMENTO ON dbo.MPEDIDO.tCodigoPedido = dbo.DDOCUMENTO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DDOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento 
	  where tEstadoDocumento<>'04' and tTipoDocumento<>'00' and isnull(MDOCUMENTO.tCaja,'0')<>'0' And MDOCUMENTO.tTurno = @sTurno and mdocumento.ttipodocumento in(select codigo from vtipodocumento where registroventa=1)

	  insert #Suma (tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tTipoPedido) 
	  SELECT DISTINCT dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, dbo.MDOCUMENTO.nVenta, 'XX'
	  FROM dbo.MPEDIDO INNER JOIN dbo.DDOCUMENTO ON dbo.MPEDIDO.tCodigoPedido = dbo.DDOCUMENTO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DDOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento 
	  where tEstadoDocumento<>'04' and tTipoDocumento<>'00' and isnull(MDOCUMENTO.tCaja,'0')<>'0' And MDOCUMENTO.tTurno = @sTurno and mdocumento.ttipodocumento in(select codigo from vtipodocumento where registroventa=0)
   END
  else
   BEGIN	
	 insert #Suma (tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tTipoPedido) 
	  SELECT DISTINCT dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, dbo.MDOCUMENTO.nVenta, tTipoPedido 
	  FROM dbo.MPEDIDO INNER JOIN dbo.DDOCUMENTO ON dbo.MPEDIDO.tCodigoPedido = dbo.DDOCUMENTO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DDOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento 
	  where tEstadoDocumento<>'04' and tTipoDocumento<>'00' and isnull(MDOCUMENTO.tCaja,'0')<>'0' And MDOCUMENTO.tTurno = @sTurno and  MDOCUMENTO.tUsuario=@sUsuario and mdocumento.ttipodocumento in(select codigo from vtipodocumento where registroventa=1)

	  insert #Suma (tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tTipoPedido) 
	  SELECT DISTINCT dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, dbo.MDOCUMENTO.nVenta, 'XX' 
	  FROM dbo.MPEDIDO INNER JOIN dbo.DDOCUMENTO ON dbo.MPEDIDO.tCodigoPedido = dbo.DDOCUMENTO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DDOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento 
	  where tEstadoDocumento<>'04' and tTipoDocumento<>'00' and isnull(MDOCUMENTO.tCaja,'0')<>'0' And MDOCUMENTO.tTurno = @sTurno and  MDOCUMENTO.tUsuario=@sUsuario and mdocumento.ttipodocumento in(select codigo from vtipodocumento where registroventa=0)
  END
else
  if @flagDiaContable=0		
  begin	
  if @sUsuario=''
	BEGIN
	  insert #Suma (tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tTipoPedido) 
	  SELECT DISTINCT dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, dbo.MDOCUMENTO.nVenta, dbo.MPEDIDO.tTipoPedido 
	  FROM dbo.MPEDIDO INNER JOIN dbo.DDOCUMENTO ON dbo.MPEDIDO.tCodigoPedido = dbo.DDOCUMENTO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DDOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja 
	  where tEstadoDocumento<>'04' and tTipoDocumento<>'00' and isnull(MDOCUMENTO.tCaja,'0')<>'0' And MDOCUMENTO.fregistro>=@finicio and mdocumento.fregistro<=@ffinal and mdocumento.ttipodocumento in(select codigo from vtipodocumento where registroventa=1) AND (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')

	  insert #Suma (tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tTipoPedido) 
	  SELECT DISTINCT dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, dbo.MDOCUMENTO.nVenta, 'XX'
	  FROM dbo.MPEDIDO INNER JOIN dbo.DDOCUMENTO ON dbo.MPEDIDO.tCodigoPedido = dbo.DDOCUMENTO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DDOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja 
	  where tEstadoDocumento<>'04' and tTipoDocumento<>'00' and isnull(MDOCUMENTO.tCaja,'0')<>'0' And MDOCUMENTO.fregistro>=@finicio and mdocumento.fregistro<=@ffinal and mdocumento.ttipodocumento in(select codigo from vtipodocumento where registroventa=0) AND (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
	END
  else
	BEGIN
	  insert #Suma (tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tTipoPedido) 
	  SELECT DISTINCT dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, dbo.MDOCUMENTO.nVenta, dbo.MPEDIDO.tTipoPedido 
	  FROM dbo.MPEDIDO INNER JOIN dbo.DDOCUMENTO ON dbo.MPEDIDO.tCodigoPedido = dbo.DDOCUMENTO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DDOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja 
	  where tEstadoDocumento<>'04' and tTipoDocumento<>'00' and isnull(MDOCUMENTO.tCaja,'0')<>'0' And MDOCUMENTO.fregistro>=@finicio and mdocumento.fregistro<=@ffinal and mdocumento.tusuario=@sUsuario and mdocumento.ttipodocumento in(select codigo from vtipodocumento where registroventa=1) AND (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
	  
	  insert #Suma (tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tTipoPedido) 
	  SELECT DISTINCT dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, dbo.MDOCUMENTO.nVenta, 'XX'
	  FROM dbo.MPEDIDO INNER JOIN dbo.DDOCUMENTO ON dbo.MPEDIDO.tCodigoPedido = dbo.DDOCUMENTO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DDOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja 
	  where tEstadoDocumento<>'04' and tTipoDocumento<>'00' and isnull(MDOCUMENTO.tCaja,'0')<>'0' And MDOCUMENTO.fregistro>=@finicio and mdocumento.fregistro<=@ffinal and mdocumento.tusuario=@sUsuario and mdocumento.ttipodocumento in(select codigo from vtipodocumento where registroventa=0) AND (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
	END
  end	
  else
  begin
	if @sUsuario=''
		BEGIN
		  insert #Suma (tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tTipoPedido) 
		  SELECT DISTINCT dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, dbo.MDOCUMENTO.nVenta, dbo.MPEDIDO.tTipoPedido 
		  FROM dbo.MPEDIDO INNER JOIN dbo.DDOCUMENTO ON dbo.MPEDIDO.tCodigoPedido = dbo.DDOCUMENTO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DDOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja
		  where tEstadoDocumento<>'04' and tTipoDocumento<>'00' and isnull(MDOCUMENTO.tCaja,'0')<>'0' And MDOCUMENTO.fdiaContable>=@finicio and mdocumento.fdiaContable<=@ffinal and mdocumento.ttipodocumento in(select codigo from vtipodocumento where registroventa=1) AND (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')

		  insert #Suma (tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tTipoPedido) 
		  SELECT DISTINCT dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, dbo.MDOCUMENTO.nVenta, 'XX'
		  FROM dbo.MPEDIDO INNER JOIN dbo.DDOCUMENTO ON dbo.MPEDIDO.tCodigoPedido = dbo.DDOCUMENTO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DDOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja
		  where tEstadoDocumento<>'04' and tTipoDocumento<>'00' and isnull(MDOCUMENTO.tCaja,'0')<>'0' And MDOCUMENTO.fdiaContable>=@finicio and mdocumento.fdiaContable<=@ffinal and mdocumento.ttipodocumento in(select codigo from vtipodocumento where registroventa=0) AND (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
		END
	  else
		BEGIN
		  insert #Suma (tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tTipoPedido) 
		  SELECT DISTINCT dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, dbo.MDOCUMENTO.nVenta, dbo.MPEDIDO.tTipoPedido 
		  FROM dbo.MPEDIDO INNER JOIN dbo.DDOCUMENTO ON dbo.MPEDIDO.tCodigoPedido = dbo.DDOCUMENTO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DDOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja 
		  where tEstadoDocumento<>'04' and tTipoDocumento<>'00' and isnull(MDOCUMENTO.tCaja,'0')<>'0' And MDOCUMENTO.fdiaContable>=@finicio and mdocumento.fdiaContable<=@ffinal and mdocumento.tusuario=@sUsuario and mdocumento.ttipodocumento in(select codigo from vtipodocumento where registroventa=1) AND (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='') 
		  
		  insert #Suma (tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tTipoPedido) 
		  SELECT DISTINCT dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, dbo.MDOCUMENTO.nVenta, 'XX'
		  FROM dbo.MPEDIDO INNER JOIN dbo.DDOCUMENTO ON dbo.MPEDIDO.tCodigoPedido = dbo.DDOCUMENTO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DDOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.TCAJA t ON dbo.MDOCUMENTO.tCaja = t.tCaja 
		  where tEstadoDocumento<>'04' and tTipoDocumento<>'00' and isnull(MDOCUMENTO.tCaja,'0')<>'0' And MDOCUMENTO.fdiaContable>=@finicio and mdocumento.fdiaContable<=@ffinal and mdocumento.tusuario=@sUsuario and mdocumento.ttipodocumento in(select codigo from vtipodocumento where registroventa=0) AND (t.tSectorVenta = @sSectorVenta OR @sSectorVenta='')
		END


  end	


	update #suma set total00=(select count(tdocumento) from #suma )

	select isnull(sum(nNeto),0) as nNeto, isnull(sum(nImpuesto1),0) as nImpuesto1, isnull(sum(nImpuesto2),0) as nImpuesto2, isnull(sum(nImpuesto3),0) as nImpuesto3, isnull(sum(nVenta),0) as nVenta, ttipopedido, isnull(count(tdocumento),0) as nTotalPromedio,isnull(total00,0) as total00 from #Suma group by ttipopedido,isnull(total00,0) 

END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE [dbo].[spRep_PaloteoInsumo]
@dbAlmacen as nvarchar(35),
@Slocal as nvarchar(50),
@Familia as nvarchar(100),
@SubFamilia as nvarchar(100),
@tCodigoProducto as nvarchar(15),
@Area as nvarchar(100),
@flagPlato as bit,
@flagCombo as bit,
@flagPropiedad as bit,
@flagPCombo as bit,
@flagTipo as bit, --controla que genera es...1 o 2
@flagTipoR as bit,
@finicio as smalldatetime,
@ffinal as smalldatetime,
@Insumo as nvarchar(1)
AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @comilla nvarchar(5)
declare @criterio nvarchar(40)
set @comilla=''''
if @Insumo='D'
	BEGIN
	set @criterio='  and vinsumo.lcontroldiario=1'
	END 
IF @Insumo='T'
	BEGIN
	set @criterio='  and vinsumo.lcontroldiario IS NOT NULL'
	END 

if @flagtipo=0  -- genera1
	begin
		CREATE TABLE #DBTRANS1 (Grupo nVarChar(100) collate Modern_Spanish_CI_AS, SubGrupo nVarChar(100) collate Modern_Spanish_CI_AS, tProducto nVarChar(7) collate Modern_Spanish_CI_AS, Producto nVarChar(150) collate Modern_Spanish_CI_AS, nCantidad Float, tcodigoPedido nVarChar(10) collate Modern_Spanish_CI_AS, tTipoProducto nVarChar(4) collate Modern_Spanish_CI_AS, Familia nVarChar(150) collate Modern_Spanish_CI_AS, SubFamilia nVarChar(150) collate Modern_Spanish_CI_AS, Insumo nVarChar(180) collate Modern_Spanish_CI_AS, UnidadSalida nVarChar(150) collate Modern_Spanish_CI_AS, nConsumo float, nPrecio float, tItem nVarChar(3) collate Modern_Spanish_CI_AS, tInsumo nVarChar(7) collate Modern_Spanish_CI_AS)
	end
else		--genera2
	begin
		CREATE TABLE #DBTRANS (Familia nVarChar(100) collate Modern_Spanish_CI_AS,SubFamilia nVarChar(100) collate Modern_Spanish_CI_AS,tDetallado nVarChar(150) collate Modern_Spanish_CI_AS,Descripcion nVarChar(150) collate Modern_Spanish_CI_AS,PV Float,Prop Float,Comb Float,PropC Float,Total Float,Equival nVarChar(150) collate Modern_Spanish_CI_AS,nFactor Float,UnidadEntrada nVarChar(150) collate Modern_Spanish_CI_AS,UnidadSalida nVarChar(150) collate Modern_Spanish_CI_AS,tPedido nVarChar(10) collate Modern_Spanish_CI_AS,tItem nVarChar(3) collate Modern_Spanish_CI_AS,tProducto nVarChar(7) collate Modern_Spanish_CI_AS,tInsumo nVarChar(7) collate Modern_Spanish_CI_AS)
	end

if @flagtipo=0 --genera 1
begin
	if @flagPlato=1
	--Inserta Platos Canal1
	  BEGIN	
	       set @sql=' Insert into #DBTRANS1  '+
			' SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'P'+@comilla+' AS tTipoProducto, VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado as Insumo, VINSUMO.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, DPEDIDO.tItem, vInsumo.tCodigoProducto as tinsumo '+
	                ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' +@dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido '+
					'LEFT JOIN ' + @dbAlmacen +'.dbo.vArea vA on DRV.tSubArea = vA.codigo AND vproducto.tEnlace = MRV.tRecetaVenta '+
	                ' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+'01'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem ='+@comilla+ 'N'+@comilla+' ) AND (dbo.MPEDIDO.tTipoPedido ='+@comilla+'01'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo ='+@comilla+ 'R'+@comilla+ ') AND DRV.lCanal1=1 and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and  vA.codigo like '+@comilla+@Area + '%'+@comilla  + @criterio

	       EXECUTE  sp_executesql @sql
		
		       --Inserta Platos Canal2
	       set @sql=' Insert into #DBTRANS1 SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'P'+@comilla+' AS tTipoProducto, VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado as Insumo, VINSUMO.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, DPEDIDO.tItem, vInsumo.tCodigoProducto as tinsumo '+
	                ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido '+
    				'LEFT JOIN ' + @dbAlmacen +'.dbo.vArea vA on DRV.tSubArea = vA.codigo AND vproducto.tEnlace = MRV.tRecetaVenta '+
					' WHERE MRV.tLocal='  +@comilla+ @sLocal +@comilla+   ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+'02'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+'02'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+ ') AND DRV.lCanal2=1 and MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like  '+@comilla+@Familia+'%'+@comilla+ 'and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and  vA.codigo like '+@comilla+@Area + '%'+@comilla + @criterio

	       EXECUTE  sp_executesql @sql

	       --Inserta Platos Canal3
	       set @sql=' Insert into #DBTRANS1  SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'P'+@comilla+'  AS tTipoProducto, VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado as Insumo, VINSUMO.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, DPEDIDO.tItem, vInsumo.tCodigoProducto as tinsumo '+	              
					' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN '+ @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido '+
					'LEFT JOIN ' + @dbAlmacen +'.dbo.vArea vA on DRV.tSubArea = vA.codigo AND vproducto.tEnlace = MRV.tRecetaVenta '+
	                ' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+'03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+'03'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND DRV.lCanal3=1 and MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like  '+@comilla+@Familia+'%'+@comilla+ 'and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and  vA.codigo like '+@comilla+@Area + '%'+@comilla + @criterio

	       EXECUTE  sp_executesql @sql

	       --Inserta Platos Canal4
	       set @sql=' Insert into #DBTRANS1  SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'P'+@comilla+' AS tTipoProducto, VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado  as Insumo, VINSUMO.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, DPEDIDO.tItem, vInsumo.tCodigoProducto as tinsumo  '+
	                ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN '+ @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido  '+
					'LEFT JOIN ' + @dbAlmacen +'.dbo.vArea vA on DRV.tSubArea = vA.codigo AND vproducto.tEnlace = MRV.tRecetaVenta '+
					' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '04'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+'04'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+'04'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND DRV.lCanal4=1 and MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like  '+@comilla+@Familia+'%'+@comilla+ 'and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and  vA.codigo like '+@comilla+@Area + '%'+@comilla  + @criterio
	       
	       EXECUTE  sp_executesql @sql

	     --Inserta Platos Canal5
	       set @sql=' Insert into #DBTRANS1 SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'P'+@comilla+' AS tTipoProducto, VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado as Insumo, VINSUMO.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, DPEDIDO.tItem, vInsumo.tCodigoProducto as tinsumo  '+
	                ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN '+ @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN '+ @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN '+ @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido '+
					'LEFT JOIN ' + @dbAlmacen +'.dbo.vArea vA on DRV.tSubArea = vA.codigo AND vproducto.tEnlace = MRV.tRecetaVenta '+
					' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '05'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+'05'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+'05'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND DRV.lCanal5=1 and MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like  '+@comilla+@Familia+'%'+@comilla+ 'and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and  vA.codigo like '+@comilla+@Area + '%'+@comilla + @criterio

	       EXECUTE  sp_executesql @sql	    

	       --Inserta Productos directos
	       set @sql=' Insert into #DBTRANS1 SELECT dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'P'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado as Insumo, vInsumo.UnidadSalida, vInsumo.nFactor as nConsumo, vInsumo.nPrecioPromedio / vInsumo.nFactor as nPrecio, '+@comilla+' '+@comilla+','++@comilla+' '+@comilla+ ' FROM dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto INNER JOIN '+ @dbAlmacen +'.dbo.vProducto vInsumo ON dbo.vProducto.tEnlace = vInsumo.tCodigoProducto RIGHT OUTER JOIN  dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido  ' +
					' INNER JOIN dbo.varea va on dbo.vproducto.tarea = va.codigo INNER JOIN '+ @dbAlmacen +'.dbo.varea vAl on val.codigo = vA.tvalor '+
					' WHERE(dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) and MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like  '+@comilla+@Familia+'%'+@comilla+ 'and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and  vAl.codigo like '+@comilla+@Area + '%'+@comilla + @criterio
               EXECUTE  sp_executesql @sql
     	 END

	if @flagCombo=1
		begin	
           --Inserta Platos Combos Canal1	
       	       set @sql=' Insert into #DBTRANS1    SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'C'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado, vInsumo.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, dbo.CPEDIDO.tItem, vInsumo.tCodigoProducto AS tinsumo  ' +
                        ' FROM  '+ @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN   '+ @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tLocal = DRV.tLocal AND MRV.tRecetaVenta = DRV.tRecetaVenta INNER JOIN   '+ @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN    dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN  dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace '+
						'LEFT JOIN '+ @dbAlmacen +'.DBO.VAREA VA ON DRV.tSubArea = VA.CODIGO '+
						'RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
	                    ' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+'01'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal1 = 1) AND MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like  '+@comilla+@Familia+'%'+@comilla+ 'and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vA.codigo like '+@comilla+@Area + '%'+@comilla + @criterio

	           EXECUTE  sp_executesql @sql

	       --Inserta Platos Combos Canal2
		       set @sql=' Insert into #DBTRANS1    SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'C'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado, vInsumo.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, dbo.CPEDIDO.tItem, vInsumo.tCodigoProducto AS tinsumo  ' +
                        ' FROM  '+ @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN   '+ @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tLocal = DRV.tLocal AND MRV.tRecetaVenta = DRV.tRecetaVenta INNER JOIN   '+ @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN    dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN  dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace '+
						'LEFT JOIN '+ @dbAlmacen +'.DBO.VAREA VA ON DRV.tSubArea = VA.CODIGO '+
						'RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
                        ' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+'02'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal2 = 1) AND MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like  '+@comilla+@Familia+'%'+@comilla+ 'and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vA.codigo like '+@comilla+@Area + '%'+@comilla + @criterio

       	       EXECUTE  sp_executesql @sql

            --Inserta Platos Combos Canal3
		        set @sql=' Insert into #DBTRANS1    SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'C'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado, vInsumo.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, dbo.CPEDIDO.tItem, vInsumo.tCodigoProducto AS tinsumo  ' +
                        ' FROM  '+ @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN   '+ @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tLocal = DRV.tLocal AND MRV.tRecetaVenta = DRV.tRecetaVenta INNER JOIN   '+ @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN    dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN  dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace '+ 
						'LEFT JOIN '+ @dbAlmacen +'.DBO.VAREA VA ON DRV.tSubArea = VA.CODIGO '+
						'RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
                        ' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '03'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal3 = 1) AND  MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like  '+@comilla+@Familia+'%'+@comilla+ 'and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vA.codigo like '+@comilla+@Area + '%'+@comilla  + @criterio

               EXECUTE  sp_executesql @sql

	      --Inserta Platos Combos Canal4
	            set @sql=' Insert into #DBTRANS1    SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'C'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado, vInsumo.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, dbo.CPEDIDO.tItem, vInsumo.tCodigoProducto AS tinsumo  ' +
                        ' FROM  '+ @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN   '+ @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tLocal = DRV.tLocal AND MRV.tRecetaVenta = DRV.tRecetaVenta INNER JOIN   '+ @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN    dbo.DPEDIDO INNER JOIN            dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN  dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace '+
						'LEFT JOIN '+ @dbAlmacen +'.DBO.VAREA VA ON DRV.tSubArea = VA.CODIGO '+
						'RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
                        ' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '04'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo =' +@comilla+ 'R'+@comilla+') AND (DRV.lCanal4 = 1) AND  MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like  '+@comilla+@Familia+'%'+@comilla+ 'and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vA.codigo like '+@comilla+@Area + '%'+@comilla + @criterio

	       EXECUTE  sp_executesql @sql

	      -- Inserta Platos Combos Canal5
       	        set @sql=' Insert into #DBTRANS1    SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'C'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado, vInsumo.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, dbo.CPEDIDO.tItem, vInsumo.tCodigoProducto AS tinsumo  ' +
                        ' FROM  '+ @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN   '+ @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tLocal = DRV.tLocal AND MRV.tRecetaVenta = DRV.tRecetaVenta INNER JOIN   '+ @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN    dbo.DPEDIDO INNER JOIN            dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN  dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace '+ 
						'LEFT JOIN '+ @dbAlmacen +'.DBO.VAREA VA ON DRV.tSubArea = VA.CODIGO '+
						'RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
                        ' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '05'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo =' +@comilla+ 'R'+@comilla+') AND (DRV.lCanal5 = 1) AND  MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like  '+@comilla+@Familia+'%'+@comilla+ 'and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vA.codigo like '+@comilla+@Area + '%'+@comilla + @criterio


               EXECUTE  sp_executesql @sql

              -- Inserta Productos directos de los Combos
               set @sql=' Insert into #DBTRANS1  SELECT dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.cPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+ 'C'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado as Insumo, vInsumo.UnidadSalida, vInsumo.nFactor as nConsumo, vInsumo.nPrecioPromedio / vInsumo.nFactor as nPrecio, '+@comilla+' '+@comilla+','++@comilla+' '+@comilla+  ' FROM '+
 						' dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.vProducto INNER JOIN '+ @dbAlmacen +'.dbo.vProducto vInsumo ON dbo.vProducto.tEnlace = vInsumo.tCodigoProducto ON  dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.varea va on dbo.vproducto.tarea = va.codigo ' +
						--' LEFT JOIN '+ @dbAlmacen+'.dbo.tsubstock tsub on vinsumo.tcodigoproducto = tsub.tcodigoproducto left join '+ @dbAlmacen+'.dbo.varea vA on tsub.tcodigosubarea = vA.codigo '+
                        ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like  '+@comilla+@Familia+'%'+@comilla+ 'and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and va.tValor like '+@comilla+@Area + '%'+@comilla + @criterio
       	       EXECUTE  sp_executesql @sql

	      end
 	if @flagPropiedad=1
		begin
			--'Inserta Platos Propiedades
			 set @sql=' Insert into #DBTRANS1  SELECT dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.tResumido + '+@comilla+ '('+@comilla+'+ MRV.tDescripcion + '+@comilla+ ')'+@comilla+'  AS Producto, dbo.DPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+ 'X'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado as Insumo, vInsumo.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, '+@comilla+' '+@comilla+','+@comilla+' '+@comilla+ ' FROM '+
				  ' dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN '+ @dbAlmacen +'.dbo.MRECETAPROPIEDAD MRV INNER JOIN '+ @dbAlmacen +'.dbo.DRECETAPROPIEDAD DRV ON MRV.tLocal = DRV.tLocal AND MRV.tRecetaPropiedad = DRV.tRecetaPropiedad INNER JOIN '+ @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad = MRV.tCodigoPropiedad '+
					'LEFT JOIN '+ @dbAlmacen +'.DBO.VAREA VA ON MRV.TCODIGOAREA = VA.CODIGO '+
					'RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
  		                  ' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+' and (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND  (dbo.vProducto.lCombinacion = 0) and MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like  '+@comilla+@Familia+'%'+@comilla+ 'and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vA.CODIGO like '+@comilla+@Area + '%'+@comilla + @criterio
			EXECUTE  sp_executesql @sql
			--print @sql
			--Inserta Productos directos de las Propiedades
        		set @sql= ' Insert into #DBTRANS1 SELECT dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion + '+@comilla+ '('+@comilla+'+ vInsumo.tResumido + '+@comilla+ ')'+@comilla+'  AS Producto, dbo.DPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+ 'X'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado as Insumo, vInsumo.UnidadSalida, vInsumo.nFactor AS nConsumo, vInsumo.nPrecioPromedio / vInsumo.nFactor AS nPrecio, '+@comilla+' '+@comilla+','++@comilla+' '+@comilla+ ' FROM '+
				  ' dbo.vProducto INNER JOIN dbo.DPEDIDO INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem INNER JOIN '+ @dbAlmacen +'.dbo.vProducto vInsumo ON dbo.TPRODUCTOPROPIEDAD.tEnlace = vInsumo.tCodigoProducto ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
	        		'LEFT JOIN '+ @dbAlmacen +'.dbo.tsubstock tsub on vinsumo.tcodigoproducto = tsub.tcodigoproducto left join '+ @dbAlmacen +'.dbo.varea vA on tsub.tcodigosubarea = vA.codigo INNER JOIN TPRODUCTOAREA tp on dbo.vProducto.Codigo = tp.tCodigoProducto INNER JOIN vArea avi on avi.Codigo = tp.tArea and avi.tValor = vA.Codigo '+  
					' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+')   AND (dbo.vProducto.lCombinacion = 0) AND tCodigoPropiedad <>'+@comilla+ '9999'+@comilla+' AND MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like  '+@comilla+@Familia+'%'+@comilla+ 'and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vA.Codigo like '+@comilla+@Area + '%'+@comilla + @criterio
			EXECUTE  sp_executesql @sql
			--print @sql
		end 
	if @flagPCombo=1
		begin
		 	--Inserta Propiedades de los Combos
       			set @sql= ' Insert into #DBTRANS1 SELECT dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion + '+@comilla+ '('+@comilla+' + MRV.tDescripcion + '+@comilla+ ')'+@comilla+' AS Producto, dbo.CPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+ 'Y'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado as Insumo, vInsumo.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, '+@comilla+' '+@comilla+','+@comilla+' '+@comilla+
               			  ' FROM '+ @dbAlmacen +'.dbo.MRECETAPROPIEDAD MRV INNER JOIN '+ @dbAlmacen +'.dbo.DRECETAPROPIEDAD DRV ON MRV.tRecetaPropiedad = DRV.tRecetaPropiedad INNER JOIN '+ @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.TCOMBOPROPIEDAD INNER JOIN dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON dbo.TCOMBOPROPIEDAD.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.TCOMBOPROPIEDAD.tItem = dbo.CPEDIDO.tItem AND dbo.TCOMBOPROPIEDAD.tItemCombo = dbo.CPEDIDO.tItemCombo ON MRV.tRecetaPropiedad = dbo.TCOMBOPROPIEDAD.tEnlace'+
							' LEFT JOIN '+ @dbAlmacen +'.DBO.VAREA VA ON MRV.TCODIGOAREA = VA.CODIGO '+
						  ' RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
						' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+' and (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+')  AND (dbo.vProducto.lCombinacion = 0) and MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like  '+@comilla+@Familia+'%'+@comilla+ 'and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vA.Codigo like '+@comilla+@Area + '%'+@comilla + @criterio

       			EXECUTE  sp_executesql @sql
			--print @sql
			
		       --Inserta Productos directos de las Propiedades de los combos
		       set @sql= ' Insert into #DBTRANS1  SELECT dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion + '+@comilla+ '('+@comilla+' + vInsumo.tResumido + '+@comilla+ ')'+@comilla+' AS Producto, dbo.DPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+ 'Y'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado as Insumo, vInsumo.UnidadSalida, vInsumo.nFactor as nConsumo, vInsumo.nPrecioPromedio / vInsumo.nFactor as nPrecio, '+@comilla+' '+@comilla+','+@comilla+' '+@comilla+ 
		                 ' FROM dbo.vProducto INNER JOIN '+ @dbAlmacen +'.dbo.vProducto vInsumo INNER JOIN dbo.DPEDIDO INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem ON vInsumo.tCodigoProducto = dbo.TCOMBOPROPIEDAD.tEnlace ON  dbo.vProducto.Codigo = dbo.TCOMBOPROPIEDAD.tProducto '+
						' LEFT JOIN '+ @dbAlmacen+'.dbo.tsubstock tsub on vinsumo.tcodigoproducto = tsub.tcodigoproducto left join '+ @dbAlmacen+'.dbo.varea vA on tsub.tcodigosubarea = vA.codigo '+
						' RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
		                 ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND tCodigoPropiedad <>'+@comilla+ '9999'+@comilla+' AND MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like  '+@comilla+@Familia+'%'+@comilla+ 'and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vA.Codigo like '+@comilla+@Area + '%'+@comilla + @criterio

		       EXECUTE  sp_executesql @sql
       
--print @sql
		end

	   --Quita los Sin de las Propiedades
	   delete from #DBTRANS1 where tcodigoPedido + tItem + tProducto + tInsumo in (
           select TPRODUCTOPROPIEDAD.tCodigoPedido + tItem + tProducto + tEnlace FROM dbo.MPEDIDO INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.MPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido 
	   where TPRODUCTOPROPIEDAD.tCodigoPropiedad='9999' and  dbo.MPEDIDO.tEstadoPedido <> '03' and fFecha >= (LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108)) and fFecha <= (LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' ' + convert(varchar(24),@ffinal,108)) )

	  --Quita los Sin de las Propiedades Combos
	    delete from #DBTRANS1 where tcodigoPedido + tItem + tProducto + tInsumo in ( 
	    select TCOMBOPROPIEDAD.tCodigoPedido + tItem + tProducto + tEnlace FROM dbo.MPEDIDO INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.MPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido 
	    where TCOMBOPROPIEDAD.tCodigoPropiedad='9999' and  dbo.MPEDIDO.tEstadoPedido <> '03' and fFecha >= (LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108)) and fFecha <= (LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' ' + convert(varchar(24),@ffinal,108)))
	
	 --consulta final
	if @flagTipoR=0 
		begin
			 SELECT Familia, SubFamilia, Insumo, UnidadSalida, Grupo, SubGrupo, Producto, nCantidad, tcodigoPedido, tTipoProducto, nConsumo, nPrecio, nConsumo * nCantidad AS nTotalConsumo, nCantidad * nConsumo * nPrecio AS nTotalPrecio From #DBTRANS1 ORDER BY Familia, SubFamilia, Insumo, Grupo, SubGrupo, Producto, tcodigoPedido
		end
	else
		begin
			SELECT Familia, SubFamilia, Insumo, UnidadSalida, Grupo, SubGrupo, Producto, SUM(nCantidad) AS Cantidad, AVG(nConsumo) AS nConsumo, AVG(nPrecio) AS nPrecio, SUM(nConsumo * nCantidad) AS nTotalConsumo, SUM(nPrecio * nConsumo * nCantidad) AS nTotalPrecio From #DBTRANS1 GROUP BY Familia, SubFamilia, Insumo, UnidadSalida, Grupo, SubGrupo, Producto
		end

end
	


if @flagtipo=1 --genera 2
	begin
		if @flagPlato=1
			begin
				 -- Inserta Platos Canal1
                set @sql=' Insert into #DBTRANS SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, dbo.DPEDIDO.nCantidad*DRV.nCantidad AS PV, 0 as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				   	 ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = DRV.tSubArea ' +
				         ' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+ '01'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '01'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND DRV.lCanal1=1 and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and Area.codigo like '+@comilla+@Area + '%'+@comilla + @criterio

				EXECUTE  sp_executesql @sql

				-- Inserta Platos Canal2
				set @sql=' Insert into #DBTRANS SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, dbo.DPEDIDO.nCantidad*DRV.nCantidad AS PV, 0 as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				     	 ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = DRV.tSubArea '+
				         ' WHERE  MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+ '02'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '02'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND DRV.lCanal2=1 and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and Area.codigo like '+@comilla+@Area + '%'+@comilla  + @criterio
				     
				EXECUTE  sp_executesql @sql

				-- Inserta Platos Canal3
				set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, dbo.DPEDIDO.nCantidad*DRV.nCantidad AS PV, 0 as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				        ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = DRV.tSubArea ' +
				      	' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '03'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND DRV.lCanal3=1 and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and Area.codigo like '+@comilla+@Area + '%'+@comilla + @criterio
				      
				EXECUTE  sp_executesql @sql
				
				-- Inserta Platos Canal4
				set @sql=' Insert into #DBTRANS SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, dbo.DPEDIDO.nCantidad*DRV.nCantidad AS PV, 0 as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				        ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = DRV.tSubArea ' +
				        ' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '04'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+ '04'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '04'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND DRV.lCanal4=1 and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and Area.codigo like '+@comilla+@Area + '%'+@comilla + @criterio
				      
				EXECUTE  sp_executesql @sql
				
				-- Inserta Platos Canal5
				set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, dbo.DPEDIDO.nCantidad*DRV.nCantidad AS PV, 0 as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				        ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = DRV.tSubArea ' +
				        ' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '05'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+ '05'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '05'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND DRV.lCanal5=1 and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and Area.codigo like '+@comilla+@Area + '%'+@comilla + @criterio
				EXECUTE  sp_executesql @sql

	       --Inserta Productos directos
--                 set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, dbo.DPEDIDO.nCantidad*DRV.nCantidad AS PV, 0 as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
--				       ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = MRV.tCodigoArea ' +
--				       ' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '05'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+ '05'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '05'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND DRV.lCanal5=1 and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and Area.codigo like '+@comilla+@Area + '%'+@comilla + @criterio

                 set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, dbo.DPEDIDO.nCantidad AS PV, 0 as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				       ' FROM dbo.DPEDIDO INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON dbo.vProducto.tEnlace = vInsumo.tCodigoProducto RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT JOIN dbo.vArea On dbo.vProducto.tArea = dbo.vArea.Codigo  ' +
				       ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+')  AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'D'+@comilla+') and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vArea.tValor like '+@comilla+@Area + '%'+@comilla + @criterio

               EXECUTE  sp_executesql @sql
     	 END
				


		IF @flagcombo=1
			begin
				 --Inserta Platos Combos Canal1
				set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, 0 AS PV, 0 as Prop,dbo.cPEDIDO.nCantidad*DRV.nCantidad as Comb,  0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				         ' FROM dbo.MPEDIDO LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN  dbo.vArea ON dbo.vProducto.tArea = dbo.vArea.Codigo LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.vArea AREA ON DRV.tSubArea= ARea.codigo ' +
				        ' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '01'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal1 = 1) AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and Area.codigo like '+@comilla+@Area + '%'+@comilla + @criterio


				EXECUTE  sp_executesql @sql
				   
				--Inserta Platos Combos Canal2
				set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion,0 AS PV, 0 as Prop,dbo.cPEDIDO.nCantidad*DRV.nCantidad as Comb,  0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				' FROM         dbo.MPEDIDO LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN  dbo.vArea ON dbo.vProducto.tArea = dbo.vArea.Codigo LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.vArea AREA ON DRV.tSubArea= ARea.codigo ' +
				        ' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '02'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal2 = 1) AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and Area.codigo like '+@comilla+@Area + '%'+@comilla + @criterio


				EXECUTE  sp_executesql @sql
				
				--Inserta Platos Combos Canal3
				set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, 0 AS PV, 0 as Prop,dbo.cPEDIDO.nCantidad*DRV.nCantidad as Comb,  0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				' FROM         dbo.MPEDIDO LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN  dbo.vArea ON dbo.vProducto.tArea = dbo.vArea.Codigo LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.vArea AREA ON DRV.tSubArea= ARea.codigo ' +
				' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '03'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal3 = 1) AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and Area.codigo like '+@comilla+@Area + '%'+@comilla + @criterio



				EXECUTE  sp_executesql @sql
				
				--Inserta Platos Combos Canal4
				set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, 0 AS PV, 0 as Prop,dbo.cPEDIDO.nCantidad*DRV.nCantidad as Comb,  0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				        ' FROM         dbo.MPEDIDO LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN  dbo.vArea ON dbo.vProducto.tArea = dbo.vArea.Codigo LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.vArea AREA ON DRV.tSubArea= ARea.codigo ' +
				        ' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '04'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal4 = 1) AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and Area.codigo like '+@comilla+@Area + '%'+@comilla + @criterio

				EXECUTE  sp_executesql @sql
				
				--Inserta Platos Combos Canal5
				set @sql=' Insert into #DBTRANS SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion,0 AS PV, 0 as Prop,dbo.cPEDIDO.nCantidad*DRV.nCantidad as Comb,  0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
					' FROM         dbo.MPEDIDO LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN  dbo.vArea ON dbo.vProducto.tArea = dbo.vArea.Codigo LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.vArea AREA ON DRV.tSubArea= ARea.codigo ' +
					' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '05'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal5 = 1) AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and Area.codigo like '+@comilla+@Area + '%'+@comilla + @criterio

				EXECUTE  sp_executesql @sql
				
				--Inserta Productos directos de los Combos
				set @sql=' Insert into #DBTRANS SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion,0 as Pv,0 as Prop, dbo.Cpedido.ncantidad * vinsumo.nfactor AS Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, '+@comilla+' '+@comilla+' as tItem, dbo.vProducto.Codigo AS tProducto, '+@comilla+' '+@comilla+' as tInsumo ' +
				        ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.vProducto INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON dbo.vProducto.tEnlace = vInsumo.tCodigoProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT JOIN dbo.vArea On dbo.vProducto.tArea = dbo.vArea.Codigo ' +
						--' LEFT JOIN '+ @dbAlmacen +'.dbo.tsubstock tsub on vinsumo.tcodigoproducto = tsub.tcodigoproducto left join '+ @dbAlmacen +'.dbo.varea vA on tsub.tcodigosubarea = vA.codigo '+  
				        ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vArea.tValor like '+@comilla+@Area + '%'+@comilla + @criterio
				EXECUTE  sp_executesql @sql
			end	     



--aqui 18062012
		if @flagPropiedad=1
			begin 
			       --Inserta Platos Propiedades
			       set @sql=' Insert into #DBTRANS SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion,  0 AS PV, dbo.DPEDIDO.nCantidad*DRV.nCantidad as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, '+@comilla+' '+@comilla+' as tItem, dbo.vProducto.Codigo AS tProducto, '+@comilla+' '+@comilla+' as tInsumo  ' +
			              	' FROM dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAPROPIEDAD MRV INNER JOIN '+ @dbAlmacen +'.dbo.DRECETAPROPIEDAD DRV ON MRV.tLocal = DRV.tLocal AND MRV.tRecetaPropiedad = DRV.tRecetaPropiedad INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad = MRV.tCodigoPropiedad RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT JOIN dbo.vArea On dbo.vProducto.tArea = dbo.vArea.Codigo LEFT JOIN '+ @dbAlmacen +'.DBO.VAREA VA ON MRV.TCODIGOAREA = VA.CODIGO ' +
			              	' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+')  AND (dbo.vProducto.lCombinacion = 0) and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and va.codigo like '+@comilla+@Area + '%'+@comilla + @criterio
			       EXECUTE  sp_executesql @sql
			    
			       --Inserta Productos directos de las Propiedades
			       set @sql=' Insert into #DBTRANS SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, 0 AS PV, dbo.DPEDIDO.nCantidad*DPEDIDO.nCantidad as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, '+@comilla+' '+@comilla+' as tItem, dbo.vProducto.Codigo AS tProducto, '+@comilla+' '+@comilla+' as tInsumo  ' +
			                ' FROM dbo.vProducto INNER JOIN dbo.DPEDIDO INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON dbo.TPRODUCTOPROPIEDAD.tEnlace = vInsumo.tCodigoProducto ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT JOIN dbo.vArea On dbo.vProducto.tArea = dbo.vArea.Codigo ' +
							'LEFT JOIN '+ @dbAlmacen +'.dbo.tsubstock tsub on vinsumo.tcodigoproducto = tsub.tcodigoproducto left join '+ @dbAlmacen +'.dbo.varea vA on tsub.tcodigosubarea = vA.codigo INNER JOIN TPRODUCTOAREA tp on dbo.vProducto.Codigo = tp.tCodigoProducto INNER JOIN vArea avi on avi.Codigo = tp.tArea and avi.tValor = vA.Codigo '+  
			                ' WHERE  (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+')  AND (dbo.vProducto.lCombinacion = 0) AND tCodigoPropiedad <>'+@comilla+ '9999'+@comilla+' AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vProducto.Area like '+@comilla+@Area + '%'+@comilla + @criterio
			       EXECUTE  sp_executesql @sql			

			end 
		if @flagPCombo=1
			begin
			
			       --Inserta Propiedades de los Combos
			       set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, 0 AS PV,0 as Prop, 0 as Comb,  dbo.CPEDIDO.nCantidad*DRV.nCantidad as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, '+@comilla+' '+@comilla+' as tItem, dbo.vProducto.Codigo AS tProducto, '+@comilla+' '+@comilla+' as tInsumo   ' + 
			                ' FROM ' + @dbAlmacen +'.dbo.MRECETAPROPIEDAD MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAPROPIEDAD DRV ON MRV.tRecetaPropiedad = DRV.tRecetaPropiedad INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.TCOMBOPROPIEDAD INNER JOIN dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON dbo.TCOMBOPROPIEDAD.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.TCOMBOPROPIEDAD.tItem = dbo.CPEDIDO.tItem AND dbo.TCOMBOPROPIEDAD.tItemCombo = dbo.CPEDIDO.tItemCombo ON MRV.tRecetaPropiedad = dbo.TCOMBOPROPIEDAD.tEnlace RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT JOIN dbo.vArea On dbo.vProducto.tArea = dbo.vArea.Codigo LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = dbo.vArea.tValor ' +
			                ' WHERE MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+')   AND (dbo.vProducto.lCombinacion = 0) and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vProducto.Area like '+@comilla+@Area + '%'+@comilla + @criterio
			       EXECUTE  sp_executesql @sql
			    
			       --Inserta Productos directos de las Propiedades de los combos
			       set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion,  0 AS PV,0 as Prop, 0 as Comb,  dbo.DPEDIDO.nCantidad*DPEDIDO.nCantidad as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, '+@comilla+' '+@comilla+' as tItem, dbo.vProducto.Codigo AS tProducto, '+@comilla+' '+@comilla+' as tInsumo  ' +
			                ' FROM dbo.vProducto INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo INNER JOIN dbo.DPEDIDO INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem ON vInsumo.tCodigoProducto = dbo.TCOMBOPROPIEDAD.tEnlace ON dbo.vProducto.Codigo = dbo.TCOMBOPROPIEDAD.tProducto RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT JOIN dbo.vArea On dbo.vProducto.tArea = dbo.vArea.Codigo ' +
							' LEFT JOIN '+ @dbAlmacen +'.dbo.tsubstock tsub on vinsumo.tcodigoproducto = tsub.tcodigoproducto left join '+ @dbAlmacen +'.dbo.varea vA on tsub.tcodigosubarea = vA.codigo '+  
			                ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND tCodigoPropiedad <>'+@comilla+ '9999'+@comilla+' AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vProducto.Area like '+@comilla+@Area + '%'+@comilla + @criterio
			       EXECUTE  sp_executesql @sql
		end 


		--Quita los Sin de las Propiedades
		delete from #DBTRANS where tPedido + tItem + tProducto + tInsumo in ( select TPRODUCTOPROPIEDAD.tCodigoPedido + tItem + tProducto + tEnlace FROM dbo.MPEDIDO INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.MPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido 
		where TPRODUCTOPROPIEDAD.tCodigoPropiedad='9999' and  dbo.MPEDIDO.tEstadoPedido <> '03' and fFecha >= (LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108)) and fFecha <= (LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' ' + convert(varchar(24),@ffinal,108)) )
		
		--Quita los Sin de las Propiedades Combos
		delete from #DBTRANS where tPedido + tItem + tProducto + tInsumo in ( select TCOMBOPROPIEDAD.tCodigoPedido + tItem + tProducto + tEnlace FROM dbo.MPEDIDO INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.MPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido 
		where TCOMBOPROPIEDAD.tCodigoPropiedad='9999' and  dbo.MPEDIDO.tEstadoPedido <> '03' and fFecha >= (LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108)) and fFecha <= (LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' ' + convert(varchar(24),@ffinal,108)) )

      		--consulta final
		SELECT Familia, SubFamilia, tDetallado, '', UnidadSalida, SUM(PV) as PV, Sum(Prop) as Prop, Sum(Comb) as Comb, Sum(PropC) as PropC, SUM(PV) + Sum(Prop) + Sum(Comb) + Sum(PropC) as Total, Convert(nvarchar,Convert(Int,((SUM(PV) + Sum(Prop) + Sum(Comb) + Sum(PropC))/nFactor))) + ' ' + UnidadEntrada + ' con ' + Convert(nvarchar,((SUM(PV) + Sum(Prop) + Sum(Comb) + Sum(PropC))-nFactor*Convert(Int,((SUM(PV) + Sum(Prop) + Sum(Comb) + Sum(PropC))/nFactor)))) + ' ' + UnidadSalida as Equival From #DBTRANS Group BY Familia, SubFamilia, tDetallado, nFactor, UnidadEntrada, UnidadSalida 
	end 
END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE [dbo].[spRep_PaloteoProduccion]
@flagFranjaHoraria as bit, -- 1 si es franja,  0  no es franja
@flagConPropiedades as bit,
@flagProduccion as bit,
@flagVenta as bit,
@flagCortesia as bit,
@flagCuentaCte as bit,
@flagCombinacion as bit,
@flagCargo as bit,
@flagPedidosFacturados as bit,
@flagPedidosFacturadosCortesia as bit,
@flagOpcionCom as bit, -- si se elige opcion de comparativo
@flagTurnoOFecha as bit,-- si selecciona un turno o rango d fecha
@flagPrecioCosto as bit , -- si selecciona precio costo
@flagSeleccion0 as bit,
@flagSeleccion1 as bit,
@flagSeleccion2 as bit,
@flagSeleccion3 as bit,
@flagSeleccion4 as bit,
@flagSeleccion5 as bit,
@flagSeleccion6 as bit,
@flagSeleccion7 as bit,
@turno as nvarchar(30),
@tSalon as nvarchar (30),  
@tTipoProducto as nvarchar(30),
@tMozo as nvarchar(30),
@tTipoPedido as nvarchar(30),
@tArea as nvarchar(30),
@tCaja as nvarchar(30),
@tUsuario as nvarchar(30),
@tUnidadNegocio as nvarchar(30),
@tGrupo as nvarchar(30),
@tSubGrupo as nvarchar(30),
@tCodigoProducto as nvarchar(30),
@tCodigoCliente as nvarchar(30),
@tCodigoTienda as nvarchar(30),
@tCodigoSectorVenta as nvarchar(30),
@sPrecio as nvarchar(400),
@sBoton2 as nvarchar(30),
@sBoton3 as nvarchar(30),
@sBoton4 as nvarchar(30),
@sBoton5 as nvarchar(30),
@finicio as smalldatetime,
@ffinal as smalldatetime,
@flagCFacturado as bit,
@flagDiaContable as bit,
@flagTipoEmision as bit,
@sPrecio1 as nvarchar(400)

AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @sqlP nvarchar(4000)
declare @Actualizaciones nvarchar(1000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(3000)
declare @sCriteriox nvarchar(3000)
declare @xCriterio nvarchar(3000)
declare @sCostoPropiedad nvarchar(2000)
declare @sCombo nvarchar(2000)
declare @sCostoComboPropiedad nvarchar(2000)
declare @sFiltro nvarchar(1000)
set @sfiltro=''
set @comilla=''''
	
	CREATE TABLE #DBTRANS (tLocal nVarChar(5) collate Modern_Spanish_CI_AS, local nVarChar(30) collate Modern_Spanish_CI_AS, Salon nVarChar(30) collate Modern_Spanish_CI_AS, tMesa nVarChar(3) collate Modern_Spanish_CI_AS, TipoProducto nVarChar(30) collate Modern_Spanish_CI_AS, Grupo nVarChar(50) collate Modern_Spanish_CI_AS, SubGrupo nVarChar(50) collate Modern_Spanish_CI_AS, Producto nVarChar(3500) collate Modern_Spanish_CI_AS, Cantidad Float, Venta Float, Pedido nVarchar(10) collate Modern_Spanish_CI_AS, Documento nVarChar(20) collate Modern_Spanish_CI_AS, Fecha DateTime, tTipoPedido nVarchar(2) collate Modern_Spanish_CI_AS, Area nVarChar(30) collate Modern_Spanish_CI_AS, tCodigoProducto nVarChar(7) collate Modern_Spanish_CI_AS, tItem nVarChar(3) collate Modern_Spanish_CI_AS, tItemCombo nVarChar(3) collate Modern_Spanish_CI_AS, Venta2 float, VentaN1 float, VentaN2 float)




							declare	@tlocal nVarchar(5)
									declare	@salon nVarchar(50)
									declare @tmesa nvarchar(10)
									declare @tipoProducto nVarchar(100)	
									declare @grupo nVarchar(100)	
									declare @subgrupo nVarchar(100)
									declare @Producto nVarchar(3500)
									declare @Propiedad nVarchar(3500)	
									declare @nCantidad	float
									declare @venta	float
									declare @tcodigoPediDo nVarchar(20)	
									declare @tcodigoPediDoV nVarchar(20)	
									declare @tdocumento nVarchar(20)	
									declare @fFecha	smalldatetime
									declare @tRTipoPedido nvarchar(4)
									declare @area	nvarchar(100)  
									declare @codigo nvarchar(20)   
									declare @codigoV nvarchar(20)   

									declare @tItem nVarchar(3)	
									declare @tItemV nVarchar(3)	
									declare @CostoProp float
									declare @costoPed float
									DECLARE @cantidadRegistro	bigint
									DECLARE @va	bigint
									set @va=0
									CREATE TABLE #DBTRANS0 (
										tlocal nVarchar(5)	collate Modern_Spanish_CI_AS,
										salon nVarchar(50) 	collate Modern_Spanish_CI_AS,
										tmesa nvarchar(10) 	collate Modern_Spanish_CI_AS,
										tipoProducto nVarchar(100)	collate Modern_Spanish_CI_AS,
										grupo nVarchar(100)	collate Modern_Spanish_CI_AS,
										subgrupo nVarchar(100)	collate Modern_Spanish_CI_AS,
										Producto nVarchar(3500)	collate Modern_Spanish_CI_AS,
										Propiedad nVarchar(3500)	collate Modern_Spanish_CI_AS,
										nCantidad	float,
										venta	float,
										tcodigoPediDo nVarchar(20)	collate Modern_Spanish_CI_AS,
										tdocumento nVarchar(20)	collate Modern_Spanish_CI_AS,
										fFecha	smalldatetime,
										tTipoPedido nvarchar(4) collate Modern_Spanish_CI_AS,
										area	nvarchar(100)  collate Modern_Spanish_CI_AS,
										codigo nvarchar(20)   collate Modern_Spanish_CI_AS,
										tItem nVarchar(3)	collate Modern_Spanish_CI_AS,
										CostoProp float,
										costoPed float)

									CREATE TABLE #DBTRANS2 (
										tlocal nVarchar(5)	collate Modern_Spanish_CI_AS,
										salon nVarchar(50) 	collate Modern_Spanish_CI_AS,
										tmesa nvarchar(10) 	collate Modern_Spanish_CI_AS,
										tipoProducto nVarchar(100)	collate Modern_Spanish_CI_AS,
										grupo nVarchar(100)	collate Modern_Spanish_CI_AS,
										subgrupo nVarchar(100)	collate Modern_Spanish_CI_AS,
										Producto nVarchar(3500)	collate Modern_Spanish_CI_AS,
 										nCantidad	float,
										venta	float,
										tcodigoPediDo nVarchar(20)	collate Modern_Spanish_CI_AS,
										tdocumento nVarchar(20)	collate Modern_Spanish_CI_AS,
										fFecha	smalldatetime,
										tTipoPedido nvarchar(4) collate Modern_Spanish_CI_AS,
										area	nvarchar(100)  collate Modern_Spanish_CI_AS,
										codigo nvarchar(20)   collate Modern_Spanish_CI_AS,
										tItem nVarchar(3)	collate Modern_Spanish_CI_AS,
										CostoProp float,
										costoPed float)



if @flagFranjaHoraria=0 
begin

				if @flagTurnoOFecha=0 
					begin
					set @sCriterio=' MPEDIDO.tTurno like ' + @comilla+@turno+'%'+@comilla
					set @sCriteriox=' MPEDIDO.tTurno like ' + @comilla+@turno+'%'+@comilla
					set @xCriterio=' MDOCUMENTO.tTurno like '+ @comilla+@turno+'%'+@comilla
					end
				else
					begin

					if @flagDiaContable=0
						begin	
						set @scriterio=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
						set @scriteriox=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
						set @xCriterio=' MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + '  and MDOCUMENTO.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
						end
					if @flagDiaContable=1
						begin
						set @scriterio=' MPEDIDO.fDiaContable >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO))) + @comilla +   ' and mpedido.fDiaContable <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL))) +   @comilla 
						set @scriteriox=' MPEDIDO.fDiaContable >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ @comilla +  ' and mpedido.fDiaContable <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL))) + @comilla 
						set @xCriterio=' MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ @comilla +  '  and MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL))) + @comilla 

						end



					end
					if @tsalon <>''
						SET @sCriterio=@sCriterio + ' and MPEDIDO.tSalon like ' + @comilla+@tsalon+'%'+@comilla
					if @ttipoProducto<>''
						SET @sCriterio=@sCriterio + ' and tTipoProducto like  ' + @comilla+@tTipoProducto+'%'+@comilla
					if @tmozo<>''
						SET @sCriterio=@sCriterio + ' and tMozo like  ' + @comilla+@tMozo+'%'+@comilla
					if @ttipoPedido<>''
						SET @sCriterio=@sCriterio + ' and MPEDIDO.tTipoPedido like  ' + @comilla+@tTipoPedido+'%'+@comilla
						SET @sCriteriox=@sCriteriox + ' and MPEDIDO.tTipoPedido like  ' + @comilla+@tTipoPedido+'%'+@comilla
					if @tarea<> ''
						SET @sCriterio=@sCriterio + ' and Area like  ' + @comilla+@tArea+'%'+@comilla
					if @tcaja <>''
						SET @sCriterio=@sCriterio + ' and MPEDIDO.tCaja  like ' + @comilla+@tCaja+'%'+@comilla
					if 	@tCodigoSectorVenta <>''
						set @sCriterio=@sCriterio + ' and MPEDIDO.tCaja in  (select tcaja from vsectorventacajar where vsectorventacajar.codigo like ' + @comilla+@tCodigoSectorVenta+'%'+@comilla + ')' 
					if @tusuario <>''
						SET @sCriterio=@sCriterio + ' and MPEDIDO.tUsuario  like ' + @comilla+@tUsuario+'%'+@comilla
					if @tUnidadNegocio<>''
						SET @sCriterio=@sCriterio + ' and DPEDIDO.tUnidadNegocio like ' + @comilla+@tUnidadNegocio+'%'+@comilla
					if @tgrupo <> ''
						SET @sCriterio=@sCriterio + ' and vProducto.Grupo like ' + @comilla+@tGrupo+'%'+@comilla
					if @tsubgrupo <> ''
						SET @sCriterio=@sCriterio + ' and subGrupo like ' + @comilla+@tSubGrupo+'%'+@comilla
					if @tcodigoproducto <> ''
						SET @sCriterio=@sCriterio + ' and DPEDIDO.tCodigoProducto like ' + @comilla+@tCodigoProducto+'%'+@comilla
					if @tcodigocliente <> ''
						set @sFiltro= ' and MDOCUMENTO.tCodigoCliente like ' + @comilla+@tCodigoCliente+'%'+@comilla
					--print @scriterio
					--print @sfiltro
				if @flagProduccion=1 --produccion
				begin
					if @flagOpcionCom=1

					  BEGIN	
							 if @flagconpropiedades=0
	      					 --CONSIDERANDO FILTRO DE CLIENTE
       						  set @sql =     'Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' + 
      										 'SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
	      		           					 'FROM  dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN  dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ' +
											 'where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and '+ @sCriterio +  @sFiltro                                                                                                                                                                               
							else
								set @sql =     ' Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' + 
      										 ' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
	      		           					 ' FROM dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN  dbo.vSalon RIGHT OUTER JOIN  dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa  ' +
											 ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+'AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and '+ @sCriterio +  @sFiltro                                                                                                                                                                               
					  end 
					else
					  BEGIN
	   					 --CONSIDERANDO FILTRO DE CLIENTE       
						if @flagconpropiedades=0       
							begin
								  set @sql=      'Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) '+
												' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' aS Venta, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido , dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem '+
												' FROM dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ' +
                								' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and '+ @sCriterio + @sFiltro 
							--	print @sql
							end
						else
							begin
								-- jala productos sin propiedades  y tambien productos con propiedades sin valor

							/*	set @SQL=' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) '+
										 ' SELECT   distinct  dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,'+  @sPrecio +' aS Venta, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido , dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
										' FROM         dbo.DPEDIDO LEFT OUTER JOIN dbo.vPropiedad INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.vPropiedad.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad ON                       dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN                      dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN                      dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN                      dbo.vSalon RIGHT OUTER JOIN                      dbo.TCAJA RIGHT OUTER JOIN                      dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON                       dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN                      dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa  '+
										' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' AND (dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad IS NULL or (vpropiedad.lstockmenos=0 and vpropiedad.lstockmas=0))  and '+ @sCriterio + @sFiltro
				*/
								set @SQL=' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) '+
			 							 ' SELECT   distinct  dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,'+  @sPrecio +' aS Venta, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido , dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
				 						 ' FROM         dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND  dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON  dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa  '+
										 ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' AND (dbo.vpaloteoproduccionpropiedades.tCodigoPropiedad IS NULL )  and '+ @sCriterio + @sFiltro
							end		 
       					  END
				 
					EXECUTE  sp_executesql @sql
				--print @sql
					  --Actualiza Costos de las Propiedades
					  set @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
                       						 ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       						 ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                     						 ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') AND ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

					  --Actualiza Costos de los Combos
					  set @sCombo = ' Update #DBTRANS set Venta = T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
          						' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
               						' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
									' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ' +
         							' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

					 --Actualiza Costos de los Combos de las Propiedades
					  set @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
											' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' + 
											' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
											' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @scriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ' +
											' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
				END 
					
				if @flagVenta=1 --venta
				begin
					if @flagOpcionCom=1
						begin
							if @flagConPropiedades=0
										set @sql=	' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
        	        									' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ', dbo.vProducto.Area,' + @sPrecio1 + ' ' +
                										' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
        	        									' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio + ' and ' + @xCriterio +  @sFiltro
							else
											set @sql=	' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
        	        									' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ', dbo.vProducto.Area,' + @sPrecio1 + ' ' +
														' FROM dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN  dbo.vSalon RIGHT OUTER JOIN  dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa  ' +
        	        									' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+')   AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio + ' and ' + @xCriterio +  @sFiltro
						EXECUTE  sp_executesql @sql
						end
					ELSE
						begin
						if @flagConPropiedades=0
										set @sql=    	' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )  ' +
               											' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' +@sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                										' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
                										' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado ='+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio + ' and ' + @xCriterio +  @sFiltro
						else
									/*	set @sql =   	' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )  ' +
               											' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' +@sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                										' FROM         dbo.vSalon RIGHT OUTER JOIN  dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND  dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON  dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
                										' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado ='+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') AND (dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad IS NULL) and ' + @sCriterio + ' and ' + @xCriterio +  @sFiltro*/
										set	@sql =   	' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )  ' +
               											' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' +@sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                										' FROM         dbo.vProducto RIGHT OUTER JOIN dbo.vPaloteoProduccionPropiedades RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vPaloteoProduccionPropiedades.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.vPaloteoProduccionPropiedades.tItem = dbo.DPEDIDO.tItem ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
                										' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado ='+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio + ' and ' + @xCriterio +  @sFiltro

						EXECUTE  sp_executesql @sql
							--print @sql
						end
					--  Actualiza Costos de las Propiedades
					set  @sCostoPropiedad =   'Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' + 
                      						  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       						  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
											  ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox  + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
					--  Actualiza Costos de los Combos
					set @sCombo =   ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
               						' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
									' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
          							' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + ' and ' + @xCriterio +  @sFiltro + 
									' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

					--Actualiza Costos de los Combos de las Propiedades
					set @sCostoComboPropiedad = 	' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                            						' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                          							' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+' ) and '+ @sCriteriox  +                          		' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2  ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem ' 
				end

				if @flagCortesia=1 --cortesia
				begin
					if @flagOpcionCom=1
					  BEGIN	
							if @flagconpropiedades=0		
								begin
									set @sql =  ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
												' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' +@sPrecio + ' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
												' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.tMesa.tCodigoMesa = dbo.MPEDIDO.tMesa ' +
												' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and ' + @sCriterio
								end
							else
								begin
		 							set @sql =  ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
												' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' +@sPrecio + ' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
												' FROM         dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa  ' +								
												' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+'  AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio
								end
						EXECUTE  sp_executesql @sql
					  END
					else
					  BEGIN
							if @flagconpropiedades=0
								begin
		 								 set @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
           											' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' +  @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
           											' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.tMesa.tCodigoMesa = dbo.MPEDIDO.tMesa ' + 
													' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and ' + @scriterio
								end
							else
								begin
										set @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
           											' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' +  @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
           											' FROM         dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ON  dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ' + 
													' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @scriterio
								end
						
						EXECUTE  sp_executesql @sql
						  END
						  --Actualiza Costos de las Propiedades
						set  @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
										' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
										' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and ' + @sCriteriox  + 
										' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

 						 --Actualiza Costos de los Combos
						set  @sCombo = ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
							   ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN  dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
							   ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and '+ @scriteriox + 
						   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

						 --Actualiza Costos de los Combos de las Propiedades
						set  @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
											 ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
											 ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+ ' and ' +  @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
				end 
				if @flagCuentaCte=1 --cuenta corriente
				begin
	if @flagOpcionCom=1
	  BEGIN	
		If @flagConPropiedades=0
			begin		
					 set     @sql = ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
									' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
                					' FROM dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ' +
									' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and '+ @scriterio --+ ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ')'	
			end 
		else
			begin
				set     @sql = ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
									' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' , dbo.vProducto.Area,' + @sPrecio1 + ' ' + 
                					' FROM         dbo.vPaloteoProduccionPropiedades RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vPaloteoProduccionPropiedades.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND  dbo.vPaloteoProduccionPropiedades.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido  ' +
									' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and '+ @scriterio --+ ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ')'	
			end
			EXECUTE  sp_executesql @sql
			
	  END
	else
	  BEGIN
		 IF @flagConPropiedades=0
				begin	
									 set     @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
               										' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                									' FROM dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ' +
                									' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and '+ @scriterio --+ ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ')'
				end 
		else
				begin
									 set     @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
               										' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' + 
                									' FROM         dbo.vPaloteoProduccionPropiedades RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vPaloteoProduccionPropiedades.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.vPaloteoProduccionPropiedades.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN  dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
                									' where         isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and '+ @scriterio --+ ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ')'

				end 	
			EXECUTE  sp_executesql @sql
			 
 	  END
					--Actualiza Costos de las Propiedades
						set  @sCostoPropiedad =    ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
             									   ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
												   ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ') ' + 
                        						   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
				             
					  --Actualiza Costos de los Combos
						set  @sCombo = 		   ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               								   ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               								   ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
               								   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

					  --Actualiza Costos de los Combos de las Propiedades
						set  @sCostoComboPropiedad =    ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             							' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             							' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
                             							' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
				END

				if @flagCombinacion=1 --combinacion CESAR
				begin
					if @flagOpcionCom=1
					  BEGIN	
						if @flagConPropiedades=0
								begin	
											set @sql = ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, tItemCombo, VentaN1, VentaN2) ' +
                										   ' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad AS Cantidad,' + @sPrecio + ' , dbo.vProducto.Area, dbo.CPEDIDO.tItemCombo,' + @sPrecio1 + ' ' + 
                										   ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem ON dbo.vProducto.Codigo = dbo.CPEDIDO.tProductoCombo ON dbo.MPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido ' +
                										   ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and ' + @sCriterio
								end
						else
								begin
												set @sql = ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, tItemCombo, VentaN1, VentaN2) ' +
                										   ' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad AS Cantidad,' + @sPrecio + ' , dbo.vProducto.Area, dbo.CPEDIDO.tItemCombo,' + @sPrecio1 + ' ' + 
                										   ' FROM         dbo.DPEDIDO RIGHT OUTER JOIN dbo.vPaloteoProduccionPropiedadesCombos RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.vPaloteoProduccionPropiedadesCombos.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.vPaloteoProduccionPropiedadesCombos.tItem = dbo.CPEDIDO.tItem AND dbo.vPaloteoProduccionPropiedadesCombos.tItemCombo = dbo.CPEDIDO.tItemCombo ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido  ' +
                										   ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND (dbo.vPaloteoProduccionPropiedadesCombos.tCodigoPropiedad IS NULL) and ' + @sCriterio
								end

							 
							EXECUTE  sp_executesql @sql
					  END
					else
					  BEGIN
						if @flagConPropiedades=0
								begin		

										set @sql= ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem, tItemCombo ) ' +
													  ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, ' + @sPrecio + '  AS Venta, dbo.CPEDIDO.tCodigoPedido AS Pedido, dbo.DPEDIDO.tDocumento AS Documento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo ' +
        											  ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem ON dbo.vProducto.Codigo = dbo.CPEDIDO.tProductoCombo ON dbo.MPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido ' +
                									  ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and ' + @sCriterio
								end
						else
								begin
										set @sql= ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem, tItemCombo ) ' +
													  ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, ' + @sPrecio + '  AS Venta, dbo.CPEDIDO.tCodigoPedido AS Pedido, dbo.DPEDIDO.tDocumento AS Documento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo ' +
        											  ' FROM         dbo.DPEDIDO RIGHT OUTER JOIN dbo.vPaloteoProduccionPropiedadesCombos RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.vPaloteoProduccionPropiedadesCombos.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND  dbo.vPaloteoProduccionPropiedadesCombos.tItem = dbo.CPEDIDO.tItem AND dbo.vPaloteoProduccionPropiedadesCombos.tItemCombo = dbo.CPEDIDO.tItemCombo ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
                									  ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+'  AND (dbo.vPaloteoProduccionPropiedadesCombos.tCodigoPropiedad IS NULL) and ' + @sCriterio
								end
							 
							EXECUTE  sp_executesql @sql
				 
					  END
					--Actualiza Costos de las Propiedades
						  SET @sCostoPropiedad = 'select 1'

      					--Actualiza Costos de los Combos
						  SET @sCombo = 'SELECT 1'
				      
					--Actualiza Costos de los Combos de las Propiedades
    						  set @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS costo ' +
                             	 					  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja  ' +
                             	 					  ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem and T1.tItemCombo = T2.tItemCombo '                     
				end

				if @flagCargo=1 --cargo
				begin
					if @flagOpcionCom=1
					  BEGIN
							IF @flagConPropiedades=0
								begin
									set @sql =    ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
         										  ' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
												  ' FROM dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ' +
													  ' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem= '+@comilla+'N'+@comilla + ' and ' + @sCriterio
								end
						  else
								begin
									set @sql =    ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
         										  ' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
												  ' FROM         dbo.vPaloteoProduccionPropiedades RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vPaloteoProduccionPropiedades.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.vPaloteoProduccionPropiedades.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN  dbo.vSalon RIGHT OUTER JOIN  dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
												  ' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem= '+@comilla+'N'+@comilla + ' AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL)  and ' + @sCriterio

								end

					  	
					  EXECUTE  sp_executesql @sql

					  END
					else
					  BEGIN
							if @flagConPropiedades=0
								begin

									set @sql =      'Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
                      									'SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + '  AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                     	 								'FROM dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ' +
			         	 								'where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem= '+@comilla+'N'+@comilla+' and ' + @sCriterio
								end	
							else
								begin
									set @sql =          ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
                      									' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + '  AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                     	 								' FROM         dbo.vPaloteoProduccionPropiedades RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vPaloteoProduccionPropiedades.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.vPaloteoProduccionPropiedades.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
			         	 								' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem= '+@comilla+'N'+@comilla+' AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio
								end
					   
					  EXECUTE  sp_executesql @sql
						  END
						  SET @sCostoPropiedad = 'select 1'

						  SET @sCostoComboPropiedad = 'SELECT 1'
					--Actualiza Costos  de los Combos
						  set @sCombo = ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
							  ' FROM dbo.CPEDIDO INNER JOIN  dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
							  ' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +
							  ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'	
				end	
					
				if @flagPedidosFacturados=1 --pedidos facturados  
				begin
					if @flagOpcionCom=1
					  BEGIN	
						 if @flagConPropiedades=0
								begin
									set @sql=       ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' + 
                									' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, '+ @sPrecio +' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
                									' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                									' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio +  @sFiltro
								end
						 else
								begin
									set @sql=       ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' + 
                									' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, '+ @sPrecio +' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
                									' FROM         dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN  dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN  dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                									' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio +  @sFiltro
 								end
						EXECUTE  sp_executesql @sql
							 
					  end
					else
					  BEGIN
						if @flagConPropiedades=0
								begin	
									set @sql=       'Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' + 
                									'SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  '+ @sPrecio +'  AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' + 
                									'FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                									'WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio + @sFiltro
								end 
						else
								begin
									set @sql=       ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' + 
                									' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  '+ @sPrecio +'  AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' + 
                									' FROM         dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON  dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN  dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                									' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+')  AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio + @sFiltro

								end
						EXECUTE  sp_executesql @sql
							
						  END
 						--Actualiza Costos de las Propiedades
  						SET    @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
											' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
											' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
											' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox +
											' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

  						--Actualiza Costos de los Combos xx
 						SET     @sCombo = ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
            							  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
             							  ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
               							  ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox +  @sFiltro +
               							  ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
					   /*T1.tCodigoProducto = T2.tCodigoProducto and*/
      						--Actualiza Costos de los Combos de las Propiedades
 						SET     @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             							' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             							' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' +  @sCriteriox +
                             							' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
				end
				if @flagPedidosFacturadosCortesia=1 --pedidos facturados como cortesia
				begin
					if @flagOpcionCom=1
					  BEGIN	
						if @flagConPropiedades=0
							begin				
								set	@sql =  ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
                										' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ', dbo.vProducto.Area,' + @sPrecio1 + ' ' + 
														' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
														' WHERE dbo.MDOCUMENTO.tCortesia <>'+@comilla+' '+@comilla+' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio +  @sFiltro
							end
						else
							begin
								set	@sql =  ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
                										' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ', dbo.vProducto.Area,' + @sPrecio1 + ' ' + 
														' FROM         dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja '  +
														' WHERE dbo.MDOCUMENTO.tCortesia <>'+@comilla+' '+@comilla+' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio +  @sFiltro

							end
							
							EXECUTE  sp_executesql @sql
							
					  end
					else
					  begin			
						if @flagConPropiedades=0
							begin	
								set     @sql =  ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
                								' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
												' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                								' WHERE dbo.MDOCUMENTO.tCortesia <>'+@comilla+' '+@comilla+' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio +  @sFiltro
							end
						else
							begin
								set     @sql =  ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
                								' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
												' FROM         dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +                				
												' WHERE dbo.MDOCUMENTO.tCortesia <>'+@comilla+' '+@comilla+' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio +  @sFiltro
							end
						EXECUTE  sp_executesql @sql
							
					  END

	 					--Actualiza Costos de las Propiedades
						set      @sCostoPropiedad = 	' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
                            					' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                        					' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                        					' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + 
                        					' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

      						--Actualiza Costos de los Combos xx
						set     @sCombo = 	' Update #DBTRANS  set Venta= T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
               							' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
               							' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
               							' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @scriteriox +  @sFiltro + 
               							' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
				      
      						--Actualiza Costos de los Combos de las Propiedades
						set     @sCostoComboPropiedad = 	' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
                             						' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             						' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             						' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + 
                             						' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
				end 
				/**/
				if (@flagPrecioCosto=1) or (@flagOpcionCom=1)
					begin
						IF @flagConPropiedades=0
							begin	
								 if upper(@sCostoPropiedad)<>'SELECT 1'
									begin
	 									EXECUTE  sp_executesql @sCostoPropiedad
									end  
							end
						if upper(@scombo)<>'SELECT 1'
							BEGIN
								EXECUTE  sp_executesql @sCombo
							END 
						IF upper(@scoSTOCOmbopropiedad)<>'SELECT 1'
							begin
								EXECUTE  sp_executesql @sCostoComboPropiedad		
							end 
					end


				if @flagConPropiedades=1
					begin
		

						if @flagProduccion=1 
							begin
									if @flagOpcionCom=1
										begin
										set @sprecio=' dbo.DPEDIDO.nPrecioNeto * dbo.DPEDIDO.nCantidad '
										end 
									SET @sqlP=  ' insert into #dbtrans0 ' + 
												' SELECT   distinct  dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
												' ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' +
												' FROM         dbo.DPEDIDO LEFT OUTER JOIN  dbo.vPropiedad RIGHT OUTER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.vPropiedad.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad ON  dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND  dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN  dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN  dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON  dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ' +
												' WHERE     (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1))  and '+ @sCriterio + @sFiltro  +
												' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
												' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
									print @sqlp
									EXECUTE  sp_executesql @sqlP

									select @cantidadRegistro= COUNT(*) from #dbtrans0

									while @va<@cantidadRegistro
										begin
											select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
														 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
														 @venta=venta,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
														 @tRtipopedido=ttipopedido,@area=area,@codigo=codigo,@titem=titem,@costoprop=costoprop,
														 @costoped=costoped
    										from #DBTRANS0 order by producto,tCodigoPedido,tItem
											if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
													update #dbtrans2
													set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
													where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
												end
											else
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
									 
													insert into #dbtrans2 
													select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
														 subgrupo,producto+' '+propiedad , ncantidad,venta,tcodigopedido, tdocumento,ffecha,
														 ttipopedido,area,codigo,titem,costoprop,costoped
													from #DBTRANS0 order by producto,tCodigoPedido,tItem
 												end 
													DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
													titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
													set @Va=@Va+1
										end 


											if (@flagPrecioCosto=1) or (@flagOpcionCom=1)
												begin
													  if (@flagOpcionCom=1)	
													   begin
																Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area)
																select tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,sum(ncantidad),sum(ncantidad * (costoprop+costoped)),sum(venta),area
																from #dbtrans2
																group by tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,area
														end
													   ELSE
													   begin
																

																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select					tLocal,  Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto, SUM(NCANTIDAD),sum(ncantidad * (costoprop+costoped)),   tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
													   end 	
												end	
											else
												begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																
												end	 
										  	

							end
						if @flagVenta=1
							begin
								 
									if @flagOpcionCom=1
									begin
									set @sprecio=' dbo.DPEDIDO.nPrecioNeto * dbo.DPEDIDO.nCantidad '
									end 
									SET @sqlP=  ' insert into #dbtrans0 ' + 
												' SELECT     dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
												' ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' +
												' FROM         dbo.vPropiedad RIGHT OUTER JOIN dbo.TPRODUCTOPROPIEDAD INNER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND  dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem ON  dbo.vPropiedad.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tSalon = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN  dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
												' WHERE  dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado ='+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1))  and '+ @sCriterio + @sFiltro  +
												' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
												' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
									 
									EXECUTE  sp_executesql @sqlP

									select @cantidadRegistro= COUNT(*) from #dbtrans0

									while @va<@cantidadRegistro
										begin
											select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
														 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
														 @venta=venta,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
														 @tRtipopedido=ttipopedido,@area=area,@codigo=codigo,@titem=titem,@costoprop=costoprop,
														 @costoped=costoped
    										from #DBTRANS0 order by producto,tCodigoPedido,tItem
											if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
													update #dbtrans2
													set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
													where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
												end
											else
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
									 
													insert into #dbtrans2 
													select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
														 subgrupo,producto+' '+propiedad , ncantidad,venta,tcodigopedido, tdocumento,ffecha,
														 ttipopedido,area,codigo,titem,costoprop,costoped
													from #DBTRANS0 order by producto,tCodigoPedido,tItem
 												end 
													DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
													titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
													set @Va=@Va+1
										end 

											if (@flagPrecioCosto=1) or (@flagOpcionCom=1)
												begin
													  if (@flagOpcionCom=1)	
													   begin
																Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area)
																select tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,sum(ncantidad),sum(ncantidad * (costoprop+costoped)),sum(venta),area
																from #dbtrans2
																group by tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,area
														end
													   ELSE
													   begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select					tLocal,  Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto, SUM(NCANTIDAD),sum(ncantidad * (costoprop+costoped)),   tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
													   end 	
												end	
											else
												begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																
												end	 
										  	

							end 
						if @flagCortesia=1
							begin
									if @flagOpcionCom=1
									begin
									set @sprecio=' dbo.DPEDIDO.nPrecioNeto * dbo.DPEDIDO.nCantidad '
									end 
									SET @sqlP=  ' insert into #dbtrans0 ' + 
													' SELECT     dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
													' ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' +
													' FROM         dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem AND  dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido LEFT OUTER JOIN dbo.vPropiedad ON dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad = dbo.vPropiedad.Codigo RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa  ' +
													' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1))  and '+ @sCriterio + @sFiltro  +
													' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
													' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
									 
									EXECUTE  sp_executesql @sqlP

									select @cantidadRegistro= COUNT(*) from #dbtrans0

									while @va<@cantidadRegistro
										begin
											select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
														 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
														 @venta=venta,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
														 @tRtipopedido=ttipopedido,@area=area,@codigo=codigo,@titem=titem,@costoprop=costoprop,
														 @costoped=costoped
    										from #DBTRANS0 order by producto,tCodigoPedido,tItem
											if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
													update #dbtrans2
													set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
													where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
												end
											else
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
									 
													insert into #dbtrans2 
													select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
														 subgrupo,producto+' '+propiedad , ncantidad,venta,tcodigopedido, tdocumento,ffecha,
														 ttipopedido,area,codigo,titem,costoprop,costoped
													from #DBTRANS0 order by producto,tCodigoPedido,tItem
 												end 
													DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
													titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
													set @Va=@Va+1
										end 

											if (@flagPrecioCosto=1) or (@flagOpcionCom=1)
												begin
													  if (@flagOpcionCom=1)	
													   begin
																Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area)
																select tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,sum(ncantidad),sum(ncantidad * (costoprop+costoped)),sum(venta),area
																from #dbtrans2
																group by tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,area
														end
													 ELSE
													   begin
																
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select					tLocal,  Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto, SUM(NCANTIDAD),sum(ncantidad * (costoprop+costoped)),   tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
													   end 	
												end	
											else
												begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																
												end	 
							end
						if @flagCuentaCte=1
							begin
									if @flagOpcionCom=1
									begin
									set @sprecio=' dbo.DPEDIDO.nPrecioNeto * dbo.DPEDIDO.nCantidad '
									end 
										SET @sqlP=  ' insert into #dbtrans0 ' + 
													' SELECT     dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
													' ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' + 
													' FROM         dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.TPRODUCTOPROPIEDAD LEFT OUTER JOIN dbo.vPropiedad ON dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad = dbo.vPropiedad.Codigo ON  dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem ON  dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto RIGHT OUTER JOIN Dbo.MPEDIDO LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido   ' +
													' where         isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1)) and '+ @scriterio + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ')' +
													' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
													' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
									 
									EXECUTE  sp_executesql @sqlP

									select @cantidadRegistro= COUNT(*) from #dbtrans0

									while @va<@cantidadRegistro
										begin
											select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
														 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
														 @venta=venta,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
														 @tRtipopedido=ttipopedido,@area=area,@codigo=codigo,@titem=titem,@costoprop=costoprop,
														 @costoped=costoped
    										from #DBTRANS0 order by producto,tCodigoPedido,tItem
											if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
													update #dbtrans2
													set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
													where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
												end
											else
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
									 
													insert into #dbtrans2 
													select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
														 subgrupo,producto+' '+propiedad , ncantidad,venta,tcodigopedido, tdocumento,ffecha,
														 ttipopedido,area,codigo,titem,costoprop,costoped
													from #DBTRANS0 order by producto,tCodigoPedido,tItem
 												end 
													DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
													titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
													set @Va=@Va+1
										end 

											if (@flagPrecioCosto=1) or (@flagOpcionCom=1)
												begin
													  if (@flagOpcionCom=1)	
													   begin
																Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area)
																select tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,sum(ncantidad),sum(ncantidad * (costoprop+costoped)),sum(venta),area
																from #dbtrans2
																group by tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,area
														end
													 ELSE
													   begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select					tLocal,  Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto, SUM(NCANTIDAD),sum(ncantidad * (costoprop+costoped)),   tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
													   end 	
												end	
											else
												begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																
												end	 
							end
						IF @flagCombinacion=1
							begin
									if @flagOpcionCom=1
									begin
									set @sprecio=' dbo.CPEDIDO.nPrecioNeto  * dbo.CPEDIDO.nCantidad '
									end
									 
										set @sqlP= ' Insert into #DBTRANS0 ' +
  												   ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto,ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.CPEDIDO.nCantidad, ' + @sPrecio + '  AS Venta, dbo.CPEDIDO.tCodigoPedido AS Pedido, dbo.DPEDIDO.tDocumento AS Documento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo,  dbo.CPEDIDO.tItemCombo, ' +
												   ' ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0) AS CostoProp, ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0)  + ISNULL(dbo.CPEDIDO.nManoObra, 0) AS costoPed ' + 
        										   ' FROM         dbo.DPEDIDO RIGHT OUTER JOIN dbo.vPropiedad RIGHT OUTER JOIN dbo.TCOMBOPROPIEDAD LEFT OUTER JOIN dbo.CPEDIDO ON dbo.TCOMBOPROPIEDAD.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND  dbo.TCOMBOPROPIEDAD.tItem = dbo.CPEDIDO.tItem AND dbo.TCOMBOPROPIEDAD.tItemCombo = dbo.CPEDIDO.tItemCombo ON  dbo.vPropiedad.Codigo = dbo.TCOMBOPROPIEDAD.tCodigoPropiedad ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND Dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN  dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
												   ' WHERE MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1))   and ' + @sCriterio +	
												   ' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.CPEDIDO.nCantidad,  '+@sprecio+', dbo.CPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.CPEDIDO.tITEMCOMBO, ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0), dbo.CPEDIDO.nInsumo,  dbo.CPEDIDO.nGasto, dbo.CPEDIDO.nManoObra ' + 
												   ' ORDER BY dbo.vProducto.Descripcion,dbo.CPEDIDO.tCodigoPedido, dbo.CPEDIDO.tItemCOMBO '
				                				  
									EXECUTE  sp_executesql @sqlP

									select @cantidadRegistro= COUNT(*) from #dbtrans0

									while @va<@cantidadRegistro
										begin
											select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
														 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
														 @venta=venta,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
														 @tRtipopedido=ttipopedido,@area=area,@codigo=codigo,@titem=titem,@costoprop=costoprop,
														 @costoped=costoped
    										from #DBTRANS0 order by producto,tCodigoPedido,tItem
											if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
													update #dbtrans2
													set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
													where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
												end
											else
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
									 
													insert into #dbtrans2 
													select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
														 subgrupo,producto+' '+propiedad , ncantidad,venta,tcodigopedido, tdocumento,ffecha,
														 ttipopedido,area,codigo,titem,costoprop,costoped
													from #DBTRANS0 order by producto,tCodigoPedido,tItem
 												end 
													DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
													titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
													set @Va=@Va+1
										end 

											if (@flagPrecioCosto=1) or (@flagOpcionCom=1)
												begin
													  if (@flagOpcionCom=1)	
													   begin
																Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area)
																select tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,sum(ncantidad),sum(ncantidad * (costoprop+costoped)),sum(venta),area
																from #dbtrans2
																group by tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,area
																
														end
													ELSE
													   begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select					tLocal,  Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto, SUM(NCANTIDAD),sum(ncantidad * (costoprop+costoped)),   tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
													   end 	
												end	
											else
												begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																
												end	 

							end 
						if @flagCargo=1
							begin
									if @flagOpcionCom=1
									begin
									set @sprecio=' dbo.DPEDIDO.nPrecioNeto*dbo.DPEDIDO.nCantidad '
									end

										SET @sqlP=  ' insert into #dbtrans0 ' + 
													' SELECT     dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
													' ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' + 
													' FROM     dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN  dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.vPropiedad RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem ON dbo.vPropiedad.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad ON  dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido   ' +
													' where    MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem= '+@comilla+'N'+@comilla+'  AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1)) and '+ @scriterio +
													' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
													' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
									 
									EXECUTE  sp_executesql @sqlP

									select @cantidadRegistro= COUNT(*) from #dbtrans0

									while @va<@cantidadRegistro
										begin
											select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
														 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
														 @venta=venta,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
														 @tRtipopedido=ttipopedido,@area=area,@codigo=codigo,@titem=titem,@costoprop=costoprop,
														 @costoped=costoped
    										from #DBTRANS0 order by producto,tCodigoPedido,tItem
											if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
													update #dbtrans2
													set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
													where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
												end
											else
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
									 
													insert into #dbtrans2 
													select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
														 subgrupo,producto+' '+propiedad , ncantidad,venta,tcodigopedido, tdocumento,ffecha,
														 ttipopedido,area,codigo,titem,costoprop,costoped
													from #DBTRANS0 order by producto,tCodigoPedido,tItem
 												end 
													DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
													titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
													set @Va=@Va+1
										end 

											if (@flagPrecioCosto=1) or (@flagOpcionCom=1)
												begin
													  if (@flagOpcionCom=1)	
													   begin
																Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area)
																select tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,sum(ncantidad),sum(ncantidad * (costoprop+costoped)),sum(venta),area
																from #dbtrans2
																group by tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,area
														end
													 ELSE
													   begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select					tLocal,  Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto, SUM(NCANTIDAD),sum(ncantidad * (costoprop+costoped)),   tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem

													   end 	
												end	
											else
												begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																
												end	 
							end
						if @flagPedidosFacturados=1 --pedidos facturados 
							begin
									if @flagOpcionCom=1
									begin
									set @sprecio=' dbo.DPEDIDO.nPrecioNeto*dbo.DPEDIDO.nCantidad '
									end
									SET @sqlP=  ' insert into #dbtrans0 ' + 
												' SELECT     dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
												' ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' +
												' FROM         dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.vPropiedad RIGHT OUTER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.vPropiedad.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad LEFT OUTER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND  dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
												' WHERE  dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado ='+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1))  and '+ @sCriterio + @sFiltro  +
												' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
												' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
											 --	print @sqlp
									EXECUTE  sp_executesql @sqlP

									select @cantidadRegistro= COUNT(*) from #dbtrans0
									--print @cantidadregistro
									while @va<@cantidadRegistro
										begin
											select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
														 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
														 @venta=venta,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
														 @tRtipopedido=ttipopedido,@area=area,@codigo=codigo,@titem=titem,@costoprop=costoprop,
														 @costoped=costoped
    										from #DBTRANS0 order by producto,tCodigoPedido,tItem
											if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
													update #dbtrans2
													set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
													where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
												end
											else
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
									 
													insert into #dbtrans2 
													select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
														 subgrupo,producto+' '+propiedad , ncantidad,venta,tcodigopedido, tdocumento,ffecha,
														 ttipopedido,area,codigo,titem,costoprop,costoped
													from #DBTRANS0 order by producto,tCodigoPedido,tItem
 												end 
													DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
													titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
													set @Va=@Va+1
										end 
											

											if (@flagPrecioCosto=1) or (@flagOpcionCom=1)
												begin
													  if (@flagOpcionCom=1)	
													   begin
														
																--SELECT * INTO ANTES FROM #DBTRANS
																Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2 , Area)
																select tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,sum(ncantidad),sum(ncantidad * (ISNULL(costoprop,0)+ISNULL(costoped,0))) AS VENTA,sum(venta) AS VENTA2,area
																from #dbtrans2
																group by tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,area
														
														end
													 ELSE 
													   begin

																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select	tLocal,  Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto, SUM(NCANTIDAD),sum(ncantidad * (costoprop+costoped)),   tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																
													   end 	
												end	
											else
												begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																
												end	 
										  	
							end 
						if @flagPedidosFacturadosCortesia=1
							begin
									if @flagOpcionCom=1
									begin
									set @sprecio=' dbo.DPEDIDO.nPrecioNeto*dbo.DPEDIDO.nCantidad '
									end
									SET @sqlP=  ' insert into #dbtrans0 ' + 
												' SELECT     dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
												' ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' +
												' FROM         dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN  dbo.DPEDIDO RIGHT OUTER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vPropiedad ON dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad = dbo.vPropiedad.Codigo LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN  dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
												' WHERE  dbo.MDOCUMENTO.tCortesia <>'+@comilla+' '+@comilla+' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+')  AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1))  and '+ @sCriterio + @sFiltro  +
												' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
												' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
												
									EXECUTE  sp_executesql @sqlP

									select @cantidadRegistro= COUNT(*) from #dbtrans0

									while @va<@cantidadRegistro
										begin
											select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
														 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
														 @venta=venta,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
														 @tRtipopedido=ttipopedido,@area=area,@codigo=codigo,@titem=titem,@costoprop=costoprop,
														 @costoped=costoped
    										from #DBTRANS0 order by producto,tCodigoPedido,tItem
											if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
													update #dbtrans2
													set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
													where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
												end
											else
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
									 
													insert into #dbtrans2 
													select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
														 subgrupo,producto+' '+propiedad , ncantidad,venta,tcodigopedido, tdocumento,ffecha,
														 ttipopedido,area,codigo,titem,costoprop,costoped
													from #DBTRANS0 order by producto,tCodigoPedido,tItem
 												end 
													DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
													titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
													set @Va=@Va+1
										end 

											if (@flagPrecioCosto=1) or (@flagOpcionCom=1)
												begin
													  if (@flagOpcionCom=1)	
													   begin
																Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area)
																select tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,sum(ncantidad),sum(ncantidad * (costoprop+costoped)),sum(venta),area
																from #dbtrans2
																group by tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,area
														end
														ELSE 
													   begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select					tLocal,  Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto, SUM(NCANTIDAD),sum(ncantidad * (costoprop+costoped)),   tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
													   end 	
												end	
											else
												begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																
												end	 

							end 
					end
end


--franja horaria
if @flagFranjaHoraria=1
begin
declare @numdias int
declare @contaDias int
declare @finicial as datetime
set @numdias=(select   DATEDIFF ( day , @finicio,@ffinal))
 
set @contaDias=0
set @finicial=@finicio
while (@contadias<=@numdias)
	begin
	print @contadias
	set @finicio=(select dateadd(day,@contadias,@finicial))	
	set @ffinal= (select  cast(convert(nvarchar,@finicio,112)   + ' '  + CONVERT(VARCHAR,@ffinal,108) as datetime))
	print 'inicio'
	print @finicio
	print 'final'
	print   @ffinal
	print ' zxzzzzz '
	
				if @flagTurnoOFecha=0 
					begin
					set @sCriterio=' MPEDIDO.tTurno like ' + @comilla+@turno+'%'+@comilla
					set @sCriteriox=' MPEDIDO.tTurno like ' + @comilla+@turno+'%'+@comilla
					set @xCriterio=' MDOCUMENTO.tTurno like '+ @comilla+@turno+'%'+@comilla
					end
				else
					begin
					set @scriterio=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
					set @scriteriox=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
					set @xCriterio=' MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + '  and MDOCUMENTO.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
					print @scriterio
					print @scriteriox
					print @xcriterio
					end
					if @tsalon <>''
						SET @sCriterio=@sCriterio + ' and MPEDIDO.tSalon like ' + @comilla+@tsalon+'%'+@comilla
					if @ttipoProducto<>''
						SET @sCriterio=@sCriterio + ' and tTipoProducto like  ' + @comilla+@tTipoProducto+'%'+@comilla
					if @tmozo<>''
						SET @sCriterio=@sCriterio + ' and tMozo like  ' + @comilla+@tMozo+'%'+@comilla
					if @ttipoPedido<>''
						SET @sCriterio=@sCriterio + ' and MPEDIDO.tTipoPedido like  ' + @comilla+@tTipoPedido+'%'+@comilla
						SET @sCriteriox=@sCriteriox + ' and MPEDIDO.tTipoPedido like  ' + @comilla+@tTipoPedido+'%'+@comilla
					if @tarea<> ''
						SET @sCriterio=@sCriterio + ' and Area like  ' + @comilla+@tArea+'%'+@comilla
					if @tcaja <>''
						SET @sCriterio=@sCriterio + ' and MPEDIDO.tCaja  like ' + @comilla+@tCaja+'%'+@comilla
					if 	@tCodigoSectorVenta <>''
						set @sCriterio=@sCriterio + ' and MPEDIDO.tCaja in  (select tcaja from vsectorventacajar where vsectorventacajar.codigo like ' + @comilla+@tCodigoSectorVenta+'%'+@comilla + ')' 
					if @tusuario <>''
						SET @sCriterio=@sCriterio + ' and MPEDIDO.tUsuario  like ' + @comilla+@tUsuario+'%'+@comilla
					if @tUnidadNegocio<>''
						SET @sCriterio=@sCriterio + ' and DPEDIDO.tUnidadNegocio like ' + @comilla+@tUnidadNegocio+'%'+@comilla
					if @tgrupo <> ''
						SET @sCriterio=@sCriterio + ' and vProducto.Grupo like ' + @comilla+@tGrupo+'%'+@comilla
					if @tsubgrupo <> ''
						SET @sCriterio=@sCriterio + ' and subGrupo like ' + @comilla+@tSubGrupo+'%'+@comilla
					if @tcodigoproducto <> ''
						SET @sCriterio=@sCriterio + ' and DPEDIDO.tCodigoProducto like ' + @comilla+@tCodigoProducto+'%'+@comilla
					if @tcodigocliente <> ''
						set @sFiltro= ' and MDOCUMENTO.tCodigoCliente like ' + @comilla+@tCodigoCliente+'%'+@comilla
					--print @scriterio
					--print @sfiltro
				if @flagProduccion=1 --produccion
				begin
					if @flagOpcionCom=1

					  BEGIN	
							 if @flagconpropiedades=0
	      					 --CONSIDERANDO FILTRO DE CLIENTE
       						  set @sql =     'Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' + 
      										 'SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
	      		           					 'FROM  dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN  dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ' +
											 'where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and '+ @sCriterio +  @sFiltro                                                                                                                                                                               
							else
								set @sql =     ' Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' + 
      										 ' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
	      		           					 ' FROM dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN  dbo.vSalon RIGHT OUTER JOIN  dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa  ' +
											 ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+'AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and '+ @sCriterio +  @sFiltro                                                                                                                                                                               
					  end 
					else
					  BEGIN
	   					 --CONSIDERANDO FILTRO DE CLIENTE       
						if @flagconpropiedades=0       
							begin
								  set @sql=      'Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) '+
												' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' aS Venta, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido , dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem '+
												' FROM dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ' +
                								' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and '+ @sCriterio + @sFiltro 
								
							end
						else
							begin
								-- jala productos sin propiedades  y tambien productos con propiedades sin valor

							/*	set @SQL=' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) '+
										 ' SELECT   distinct  dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,'+  @sPrecio +' aS Venta, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido , dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
										' FROM         dbo.DPEDIDO LEFT OUTER JOIN dbo.vPropiedad INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.vPropiedad.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad ON                       dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN                      dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN                      dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN                      dbo.vSalon RIGHT OUTER JOIN                      dbo.TCAJA RIGHT OUTER JOIN                      dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON                       dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN                      dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa  '+
										' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' AND (dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad IS NULL or (vpropiedad.lstockmenos=0 and vpropiedad.lstockmas=0))  and '+ @sCriterio + @sFiltro
				*/
								set @SQL=' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) '+
			 							 ' SELECT   distinct  dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,'+  @sPrecio +' aS Venta, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido , dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
				 						 ' FROM         dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND  dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON  dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa  '+
										 ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' AND (dbo.vpaloteoproduccionpropiedades.tCodigoPropiedad IS NULL )  and '+ @sCriterio + @sFiltro
							end		 
       					  END
				 
					EXECUTE  sp_executesql @sql
				--print @sql
					  --Actualiza Costos de las Propiedades
					  set @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
                       						 ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       						 ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                     						 ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') AND ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

					  --Actualiza Costos de los Combos
					  set @sCombo = ' Update #DBTRANS set Venta = T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
          						' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
               						' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
									' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ' +
         							' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

					 --Actualiza Costos de los Combos de las Propiedades
					  set @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
											' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' + 
											' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
											' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @scriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ' +
											' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
				END 
					
				if @flagVenta=1 --venta
				begin
					if @flagOpcionCom=1
						begin
							if @flagConPropiedades=0
										set @sql=	' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
        	        									' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ', dbo.vProducto.Area,' + @sPrecio1 + ' ' +
                										' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
        	        									' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio + ' and ' + @xCriterio +  @sFiltro
							else
											set @sql=	' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
        	        									' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ', dbo.vProducto.Area,' + @sPrecio1 + ' ' +
														' FROM dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN  dbo.vSalon RIGHT OUTER JOIN  dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa  ' +
        	        									' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+')   AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio + ' and ' + @xCriterio +  @sFiltro
						EXECUTE  sp_executesql @sql
						end
					ELSE
						begin
						if @flagConPropiedades=0
										set @sql=    	' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )  ' +
               											' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' +@sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                										' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
                										' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado ='+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio + ' and ' + @xCriterio +  @sFiltro
						else
									/*	set @sql =   	' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )  ' +
               											' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' +@sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                										' FROM         dbo.vSalon RIGHT OUTER JOIN  dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND  dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON  dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
                										' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado ='+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') AND (dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad IS NULL) and ' + @sCriterio + ' and ' + @xCriterio +  @sFiltro*/
										set	@sql =   	' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )  ' +
               											' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' +@sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                										' FROM         dbo.vProducto RIGHT OUTER JOIN dbo.vPaloteoProduccionPropiedades RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vPaloteoProduccionPropiedades.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.vPaloteoProduccionPropiedades.tItem = dbo.DPEDIDO.tItem ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
                										' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado ='+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio + ' and ' + @xCriterio +  @sFiltro

						EXECUTE  sp_executesql @sql
							--print @sql
						end
					--  Actualiza Costos de las Propiedades
					set  @sCostoPropiedad =   'Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' + 
                      						  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       						  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
											  ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox  + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
					--  Actualiza Costos de los Combos
					set @sCombo =   ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
               						' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
									' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
          							' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + ' and ' + @xCriterio +  @sFiltro + 
									' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

					--Actualiza Costos de los Combos de las Propiedades
					set @sCostoComboPropiedad = 	' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                            						' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                          							' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+' ) and '+ @sCriteriox  +                          		' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2  ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem ' 
				end

				if @flagCortesia=1 --cortesia
				begin
					if @flagOpcionCom=1
					  BEGIN	
							if @flagconpropiedades=0		
								begin
									set @sql =  ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
												' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' +@sPrecio + ' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
												' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.tMesa.tCodigoMesa = dbo.MPEDIDO.tMesa ' +
												' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and ' + @sCriterio
								end
							else
								begin
		 							set @sql =  ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
												' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' +@sPrecio + ' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
												' FROM         dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa  ' +								
												' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+'  AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio
								end
						EXECUTE  sp_executesql @sql
					  END
					else
					  BEGIN
							if @flagconpropiedades=0
								begin
		 								 set @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
           											' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' +  @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
           											' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.tMesa.tCodigoMesa = dbo.MPEDIDO.tMesa ' + 
													' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and ' + @scriterio
								end
							else
								begin
										set @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
           											' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' +  @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
           											' FROM         dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ON  dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ' + 
													' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @scriterio
								end
						
						EXECUTE  sp_executesql @sql
						  END
						  --Actualiza Costos de las Propiedades
						set  @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
										' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
										' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and ' + @sCriteriox  + 
										' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

 						 --Actualiza Costos de los Combos
						set  @sCombo = ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
							   ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN  dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
							   ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and '+ @scriteriox + 
						   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

						 --Actualiza Costos de los Combos de las Propiedades
						set  @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
											 ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
											 ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+ ' and ' +  @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
				end 
				if @flagCuentaCte=1 --cuenta corriente
				begin
					if @flagOpcionCom=1
					  BEGIN	
						If @flagConPropiedades=0
							begin		
									 set     @sql = ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
													' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
                									' FROM dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ' +
													' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and '+ @scriterio + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ')'	
							end 
						else
							begin
								set     @sql = ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
													' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' , dbo.vProducto.Area,' + @sPrecio1 + ' ' + 
                									' FROM         dbo.vPaloteoProduccionPropiedades RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vPaloteoProduccionPropiedades.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND  dbo.vPaloteoProduccionPropiedades.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido  ' +
													' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and '+ @scriterio + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ')'	
							end
							EXECUTE  sp_executesql @sql
							
					  END
					else
					  BEGIN
						 IF @flagConPropiedades=0
								begin	
													 set     @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
               														' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                													' FROM dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ' +
                													' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and '+ @scriterio + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ')'
								end 
						else
								begin
													 set     @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
               														' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' + 
                													' FROM         dbo.vPaloteoProduccionPropiedades RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vPaloteoProduccionPropiedades.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.vPaloteoProduccionPropiedades.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN  dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
                													' where         isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and '+ @scriterio + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ')'

								end 	
							EXECUTE  sp_executesql @sql
							 
 					  END
					--Actualiza Costos de las Propiedades
						set  @sCostoPropiedad =    ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
             									   ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
												   ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ') ' + 
                        						   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
				             
					  --Actualiza Costos de los Combos
						set  @sCombo = 		   ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               								   ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               								   ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
               								   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

					  --Actualiza Costos de los Combos de las Propiedades
						set  @sCostoComboPropiedad =    ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             							' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             							' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
                             							' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
				END

				if @flagCombinacion=1 --combinacion
				begin
					if @flagOpcionCom=1
					  BEGIN	
						if @flagConPropiedades=0
								begin	
											set @sql = ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
                										   ' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,' + @sPrecio + ' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
                										   ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem ON dbo.vProducto.Codigo = dbo.CPEDIDO.tProductoCombo ON dbo.MPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido ' +
                										   ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and ' + @sCriterio
								end
						else
								begin
												set @sql = ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
                										   ' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,' + @sPrecio + ' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
                										   ' FROM         dbo.DPEDIDO RIGHT OUTER JOIN dbo.vPaloteoProduccionPropiedadesCombos RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.vPaloteoProduccionPropiedadesCombos.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.vPaloteoProduccionPropiedadesCombos.tItem = dbo.CPEDIDO.tItem AND dbo.vPaloteoProduccionPropiedadesCombos.tItemCombo = dbo.CPEDIDO.tItemCombo ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido  ' +
                										   ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND (dbo.vPaloteoProduccionPropiedadesCombos.tCodigoPropiedad IS NULL) and ' + @sCriterio
								end

							 
							EXECUTE  sp_executesql @sql
					  END
					else
					  BEGIN
						if @flagConPropiedades=0
								begin		

										set @sql= ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem, tItemCombo ) ' +
													  ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, ' + @sPrecio + '  AS Venta, dbo.CPEDIDO.tCodigoPedido AS Pedido, dbo.DPEDIDO.tDocumento AS Documento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo ' +
        											  ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem ON dbo.vProducto.Codigo = dbo.CPEDIDO.tProductoCombo ON dbo.MPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido ' +
                									  ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and ' + @sCriterio
								end
						else
								begin
										set @sql= ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem, tItemCombo ) ' +
													  ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, ' + @sPrecio + '  AS Venta, dbo.CPEDIDO.tCodigoPedido AS Pedido, dbo.DPEDIDO.tDocumento AS Documento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo ' +
        											  ' FROM         dbo.DPEDIDO RIGHT OUTER JOIN dbo.vPaloteoProduccionPropiedadesCombos RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.vPaloteoProduccionPropiedadesCombos.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND  dbo.vPaloteoProduccionPropiedadesCombos.tItem = dbo.CPEDIDO.tItem AND dbo.vPaloteoProduccionPropiedadesCombos.tItemCombo = dbo.CPEDIDO.tItemCombo ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
                									  ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+'  AND (dbo.vPaloteoProduccionPropiedadesCombos.tCodigoPropiedad IS NULL) and ' + @sCriterio
								end
							 
							EXECUTE  sp_executesql @sql
				 
					  END
					--Actualiza Costos de las Propiedades
						  SET @sCostoPropiedad = 'select 1'

      					--Actualiza Costos de los Combos
						  SET @sCombo = 'SELECT 1'
				      
					--Actualiza Costos de los Combos de las Propiedades
    						  set @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             	 					  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja  ' +
                             	 					  ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem and T1.tItemCombo = T2.tItemCombo '                     
				end

				if @flagCargo=1 --cargo
				begin
					if @flagOpcionCom=1
					  BEGIN
							IF @flagConPropiedades=0
								begin
									set @sql =    ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
         										  ' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
												  ' FROM dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ' +
													  ' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem= '+@comilla+'N'+@comilla + ' and ' + @sCriterio
								end
						  else
								begin
									set @sql =    ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
         										  ' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
												  ' FROM         dbo.vPaloteoProduccionPropiedades RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vPaloteoProduccionPropiedades.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.vPaloteoProduccionPropiedades.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN  dbo.vSalon RIGHT OUTER JOIN  dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
												  ' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem= '+@comilla+'N'+@comilla + ' AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL)  and ' + @sCriterio

								end

					  	
					  EXECUTE  sp_executesql @sql

					  END
					else
					  BEGIN
							if @flagConPropiedades=0
								begin

									set @sql =      'Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
                      									'SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + '  AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                     	 								'FROM dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ' +
			         	 								'where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem= '+@comilla+'N'+@comilla+' and ' + @sCriterio
								end	
							else
								begin
									set @sql =          ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
                      									' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + '  AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                     	 								' FROM         dbo.vPaloteoProduccionPropiedades RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vPaloteoProduccionPropiedades.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.vPaloteoProduccionPropiedades.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
			         	 								' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem= '+@comilla+'N'+@comilla+' AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio
								end
					   
					  EXECUTE  sp_executesql @sql
						  END
						  SET @sCostoPropiedad = 'select 1'

						  SET @sCostoComboPropiedad = 'SELECT 1'
					--Actualiza Costos  de los Combos
						  set @sCombo = ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
							  ' FROM dbo.CPEDIDO INNER JOIN  dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
							  ' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +
							  ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'	
				end	
					
				if @flagPedidosFacturados=1 --pedidos facturados  
				begin
					if @flagOpcionCom=1
					  BEGIN	
						 if @flagConPropiedades=0
								begin
									set @sql=       ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' + 
                									' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, '+ @sPrecio +' , dbo.vProducto.Area,' + @sPrecio1 + ' ' + 
                									' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                									' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio +  @sFiltro
								end
						 else
								begin
									set @sql=       ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' + 
                									' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, '+ @sPrecio +' , dbo.vProducto.Area,' + @sPrecio1 + ' ' +
                									' FROM         dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN  dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN  dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                									' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio +  @sFiltro
 								end
						EXECUTE  sp_executesql @sql
							 
					  end
					else
					  BEGIN
						if @flagConPropiedades=0
								begin	
									set @sql=       'Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' + 
                									'SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  '+ @sPrecio +'  AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' + 
                									'FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                									'WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio + @sFiltro
								end 
						else
								begin
									set @sql=       ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' + 
                									' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  '+ @sPrecio +'  AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' + 
                									' FROM         dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON  dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN  dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                									' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+')  AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio + @sFiltro

								end
						EXECUTE  sp_executesql @sql
							
						  END
 						--Actualiza Costos de las Propiedades
  						SET    @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
											' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
											' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
											' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox +
											' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

  						--Actualiza Costos de los Combos xx
 						SET     @sCombo = ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
            							  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
             							  ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
               							  ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox +  @sFiltro +
               							  ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
					   /*T1.tCodigoProducto = T2.tCodigoProducto and*/
      						--Actualiza Costos de los Combos de las Propiedades
 						SET     @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             							' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             							' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' +  @sCriteriox +
                             							' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
				end
				if @flagPedidosFacturadosCortesia=1 --pedidos facturados como cortesia
				begin
					if @flagOpcionCom=1
					  BEGIN	
						if @flagConPropiedades=0
							begin				
								set	@sql =  ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
                										' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ', dbo.vProducto.Area,' + @sPrecio1 + ' ' +
														' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
														' WHERE dbo.MDOCUMENTO.tCortesia <>'+@comilla+' '+@comilla+' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio +  @sFiltro
							end
						else
							begin
								set	@sql =  ' Insert into #DBTRANS (PEDIDO,TITEM,TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area, VentaN1, VentaN2) ' +
                										' SELECT MPEDIDO.TCODIGOPEDIDO, DPEDIDO.TITEM,dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ', dbo.vProducto.Area,' + @sPrecio1 + ' ' +
														' FROM         dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja '  +
														' WHERE dbo.MDOCUMENTO.tCortesia <>'+@comilla+' '+@comilla+' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio +  @sFiltro

							end
							
							EXECUTE  sp_executesql @sql
							
					  end
					else
					  begin			
						if @flagConPropiedades=0
							begin	
								set     @sql =  ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
                								' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
												' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                								' WHERE dbo.MDOCUMENTO.tCortesia <>'+@comilla+' '+@comilla+' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio +  @sFiltro
							end
						else
							begin
								set     @sql =  ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
                								' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
												' FROM         dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +                				
												' WHERE dbo.MDOCUMENTO.tCortesia <>'+@comilla+' '+@comilla+' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio +  @sFiltro
							end
						EXECUTE  sp_executesql @sql
							
					  END

	 					--Actualiza Costos de las Propiedades
						set      @sCostoPropiedad = 	' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
                            					' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                        					' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                        					' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + 
                        					' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

      						--Actualiza Costos de los Combos xx
						set     @sCombo = 	' Update #DBTRANS  set Venta= T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
               							' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
               							' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
               							' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @scriteriox +  @sFiltro + 
               							' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
				      
      						--Actualiza Costos de los Combos de las Propiedades
						set     @sCostoComboPropiedad = 	' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
                             						' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             						' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             						' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + 
                             						' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
				end 
				/**/
				if (@flagPrecioCosto=1) or (@flagOpcionCom=1)
					begin
						IF @flagConPropiedades=0
							begin	
								 if upper(@sCostoPropiedad)<>'SELECT 1'
									begin
	 									EXECUTE  sp_executesql @sCostoPropiedad
									end  
							end
						if upper(@scombo)<>'SELECT 1'
							BEGIN
								EXECUTE  sp_executesql @sCombo
							END 
						IF upper(@scoSTOCOmbopropiedad)<>'SELECT 1'
							begin
								EXECUTE  sp_executesql @sCostoComboPropiedad		
							end 
					end


				if @flagConPropiedades=1
					begin
		

						if @flagProduccion=1 
							begin
									if @flagOpcionCom=1
										begin
										set @sprecio=' dbo.DPEDIDO.nPrecioNeto * dbo.DPEDIDO.nCantidad '
										end 
									SET @sqlP=  ' insert into #dbtrans0 ' + 
												' SELECT   distinct  dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
												' ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' +
												' FROM         dbo.DPEDIDO LEFT OUTER JOIN  dbo.vPropiedad RIGHT OUTER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.vPropiedad.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad ON  dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND  dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN  dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN  dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON  dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ' +
												' WHERE     (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1))  and '+ @sCriterio + @sFiltro  +
												' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
												' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
									print @sqlp
									EXECUTE  sp_executesql @sqlP

									select @cantidadRegistro= COUNT(*) from #dbtrans0

									while @va<@cantidadRegistro
										begin
											select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
														 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
														 @venta=venta,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
														 @tRtipopedido=ttipopedido,@area=area,@codigo=codigo,@titem=titem,@costoprop=costoprop,
														 @costoped=costoped
    										from #DBTRANS0 order by producto,tCodigoPedido,tItem
											if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
													update #dbtrans2
													set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
													where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
												end
											else
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
									 
													insert into #dbtrans2 
													select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
														 subgrupo,producto+' '+propiedad , ncantidad,venta,tcodigopedido, tdocumento,ffecha,
														 ttipopedido,area,codigo,titem,costoprop,costoped
													from #DBTRANS0 order by producto,tCodigoPedido,tItem
 												end 
													DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
													titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
													set @Va=@Va+1
										end 


											if (@flagPrecioCosto=1) or (@flagOpcionCom=1)
												begin
													  if (@flagOpcionCom=1)	
													   begin
																Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area)
																select tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,sum(ncantidad),sum(ncantidad * (costoprop+costoped)),sum(venta),area
																from #dbtrans2
																group by tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,area
														end
													   ELSE
													   begin
																

																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select					tLocal,  Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto, SUM(NCANTIDAD),sum(ncantidad * (costoprop+costoped)),   tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
													   end 	
												end	
											else
												begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																
												end	 
										  	

							end
						if @flagVenta=1
							begin
								 
									if @flagOpcionCom=1
									begin
									set @sprecio=' dbo.DPEDIDO.nPrecioNeto * dbo.DPEDIDO.nCantidad '
									end 
									SET @sqlP=  ' insert into #dbtrans0 ' + 
												' SELECT     dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
												' ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' +
												' FROM         dbo.vPropiedad RIGHT OUTER JOIN dbo.TPRODUCTOPROPIEDAD INNER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND  dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem ON  dbo.vPropiedad.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tSalon = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN  dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
												' WHERE  dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado ='+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1))  and '+ @sCriterio + @sFiltro  +
												' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
												' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
									 
									EXECUTE  sp_executesql @sqlP

									select @cantidadRegistro= COUNT(*) from #dbtrans0

									while @va<@cantidadRegistro
										begin
											select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
														 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
														 @venta=venta,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
														 @tRtipopedido=ttipopedido,@area=area,@codigo=codigo,@titem=titem,@costoprop=costoprop,
														 @costoped=costoped
    										from #DBTRANS0 order by producto,tCodigoPedido,tItem
											if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
													update #dbtrans2
													set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
													where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
												end
											else
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
									 
													insert into #dbtrans2 
													select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
														 subgrupo,producto+' '+propiedad , ncantidad,venta,tcodigopedido, tdocumento,ffecha,
														 ttipopedido,area,codigo,titem,costoprop,costoped
													from #DBTRANS0 order by producto,tCodigoPedido,tItem
 												end 
													DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
													titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
													set @Va=@Va+1
										end 

											if (@flagPrecioCosto=1) or (@flagOpcionCom=1)
												begin
													  if (@flagOpcionCom=1)	
													   begin
																Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area)
																select tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,sum(ncantidad),sum(ncantidad * (costoprop+costoped)),sum(venta),area
																from #dbtrans2
																group by tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,area
														end
													   ELSE
													   begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select					tLocal,  Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto, SUM(NCANTIDAD),sum(ncantidad * (costoprop+costoped)),   tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
													   end 	
												end	
											else
												begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																
												end	 
										  	

							end 
						if @flagCortesia=1
							begin
									if @flagOpcionCom=1
									begin
									set @sprecio=' dbo.DPEDIDO.nPrecioNeto * dbo.DPEDIDO.nCantidad '
									end 
									SET @sqlP=  ' insert into #dbtrans0 ' + 
													' SELECT     dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
													' ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' +
													' FROM         dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem AND  dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido LEFT OUTER JOIN dbo.vPropiedad ON dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad = dbo.vPropiedad.Codigo RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa  ' +
													' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1))  and '+ @sCriterio + @sFiltro  +
													' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
													' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
									 
									EXECUTE  sp_executesql @sqlP

									select @cantidadRegistro= COUNT(*) from #dbtrans0

									while @va<@cantidadRegistro
										begin
											select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
														 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
														 @venta=venta,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
														 @tRtipopedido=ttipopedido,@area=area,@codigo=codigo,@titem=titem,@costoprop=costoprop,
														 @costoped=costoped
    										from #DBTRANS0 order by producto,tCodigoPedido,tItem
											if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
													update #dbtrans2
													set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
													where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
												end
											else
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
									 
													insert into #dbtrans2 
													select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
														 subgrupo,producto+' '+propiedad , ncantidad,venta,tcodigopedido, tdocumento,ffecha,
														 ttipopedido,area,codigo,titem,costoprop,costoped
													from #DBTRANS0 order by producto,tCodigoPedido,tItem
 												end 
													DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
													titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
													set @Va=@Va+1
										end 

											if (@flagPrecioCosto=1) or (@flagOpcionCom=1)
												begin
													  if (@flagOpcionCom=1)	
													   begin
																Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area)
																select tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,sum(ncantidad),sum(ncantidad * (costoprop+costoped)),sum(venta),area
																from #dbtrans2
																group by tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,area
														end
													 ELSE
													   begin
																
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select					tLocal,  Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto, SUM(NCANTIDAD),sum(ncantidad * (costoprop+costoped)),   tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
													   end 	
												end	
											else
												begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																
												end	 
							end
						if @flagCuentaCte=1
							begin
									if @flagOpcionCom=1
									begin
									set @sprecio=' dbo.DPEDIDO.nPrecioNeto * dbo.DPEDIDO.nCantidad '
									end 
										SET @sqlP=  ' insert into #dbtrans0 ' + 
													' SELECT     dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
													' ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' + 
													' FROM         dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.TPRODUCTOPROPIEDAD LEFT OUTER JOIN dbo.vPropiedad ON dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad = dbo.vPropiedad.Codigo ON  dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem ON  dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto RIGHT OUTER JOIN Dbo.MPEDIDO LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido   ' +
													' where         isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1)) and '+ @scriterio + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ')' +
													' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
													' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
									 
									EXECUTE  sp_executesql @sqlP

									select @cantidadRegistro= COUNT(*) from #dbtrans0

									while @va<@cantidadRegistro
										begin
											select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
														 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
														 @venta=venta,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
														 @tRtipopedido=ttipopedido,@area=area,@codigo=codigo,@titem=titem,@costoprop=costoprop,
														 @costoped=costoped
    										from #DBTRANS0 order by producto,tCodigoPedido,tItem
											if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
													update #dbtrans2
													set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
													where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
												end
											else
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
									 
													insert into #dbtrans2 
													select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
														 subgrupo,producto+' '+propiedad , ncantidad,venta,tcodigopedido, tdocumento,ffecha,
														 ttipopedido,area,codigo,titem,costoprop,costoped
													from #DBTRANS0 order by producto,tCodigoPedido,tItem
 												end 
													DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
													titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
													set @Va=@Va+1
										end 

											if (@flagPrecioCosto=1) or (@flagOpcionCom=1)
												begin
													  if (@flagOpcionCom=1)	
													   begin
																Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area)
																select tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,sum(ncantidad),sum(ncantidad * (costoprop+costoped)),sum(venta),area
																from #dbtrans2
																group by tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,area
														end
													 ELSE
													   begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select					tLocal,  Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto, SUM(NCANTIDAD),sum(ncantidad * (costoprop+costoped)),   tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
													   end 	
												end	
											else
												begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																
												end	 
							end
						IF @flagCombinacion=1
							begin
									if @flagOpcionCom=1
									begin
									set @sprecio=' dbo.CPEDIDO.nPrecioNeto  * dbo.DPEDIDO.nCantidad '
									end
									 
										set @sqlP= ' Insert into #DBTRANS0 ' +
  												   ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto,ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.CPEDIDO.nCantidad, ' + @sPrecio + '  AS Venta, dbo.CPEDIDO.tCodigoPedido AS Pedido, dbo.DPEDIDO.tDocumento AS Documento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo,  dbo.CPEDIDO.tItemCombo, ' +
												   ' ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0) AS CostoProp, ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0)  + ISNULL(dbo.CPEDIDO.nManoObra, 0) AS costoPed ' + 
        										   ' FROM         dbo.DPEDIDO RIGHT OUTER JOIN dbo.vPropiedad RIGHT OUTER JOIN dbo.TCOMBOPROPIEDAD LEFT OUTER JOIN dbo.CPEDIDO ON dbo.TCOMBOPROPIEDAD.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND  dbo.TCOMBOPROPIEDAD.tItem = dbo.CPEDIDO.tItem AND dbo.TCOMBOPROPIEDAD.tItemCombo = dbo.CPEDIDO.tItemCombo ON  dbo.vPropiedad.Codigo = dbo.TCOMBOPROPIEDAD.tCodigoPropiedad ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND Dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN  dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
												   ' WHERE MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1))   and ' + @sCriterio +	
												   ' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.CPEDIDO.nCantidad,  '+@sprecio+', dbo.CPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.CPEDIDO.tITEMCOMBO, ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0), dbo.CPEDIDO.nInsumo,  dbo.CPEDIDO.nGasto, dbo.CPEDIDO.nManoObra ' + 
												   ' ORDER BY dbo.vProducto.Descripcion,dbo.CPEDIDO.tCodigoPedido, dbo.CPEDIDO.tItemCOMBO '
				                				  
									EXECUTE  sp_executesql @sqlP

									select @cantidadRegistro= COUNT(*) from #dbtrans0

									while @va<@cantidadRegistro
										begin
											select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
														 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
														 @venta=venta,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
														 @tRtipopedido=ttipopedido,@area=area,@codigo=codigo,@titem=titem,@costoprop=costoprop,
														 @costoped=costoped
    										from #DBTRANS0 order by producto,tCodigoPedido,tItem
											if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
													update #dbtrans2
													set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
													where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
												end
											else
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
									 
													insert into #dbtrans2 
													select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
														 subgrupo,producto+' '+propiedad , ncantidad,venta,tcodigopedido, tdocumento,ffecha,
														 ttipopedido,area,codigo,titem,costoprop,costoped
													from #DBTRANS0 order by producto,tCodigoPedido,tItem
 												end 
													DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
													titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
													set @Va=@Va+1
										end 

											if (@flagPrecioCosto=1) or (@flagOpcionCom=1)
												begin
													  if (@flagOpcionCom=1)	
													   begin
																Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area)
																select tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,sum(ncantidad),sum(ncantidad * (costoprop+costoped)),sum(venta),area
																from #dbtrans2
																group by tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,area
																
														end
													ELSE
													   begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select					tLocal,  Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto, SUM(NCANTIDAD),sum(ncantidad * (costoprop+costoped)),   tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
													   end 	
												end	
											else
												begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																
												end	 

							end 
						if @flagCargo=1
							begin
									if @flagOpcionCom=1
									begin
									set @sprecio=' dbo.DPEDIDO.nPrecioNeto*dbo.DPEDIDO.nCantidad '
									end

										SET @sqlP=  ' insert into #dbtrans0 ' + 
													' SELECT     dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
													' ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' + 
													' FROM     dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN  dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.vPropiedad RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem ON dbo.vPropiedad.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad ON  dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido   ' +
													' where    MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem= '+@comilla+'N'+@comilla+'  AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1)) and '+ @scriterio +
													' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
													' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
									 
									EXECUTE  sp_executesql @sqlP

									select @cantidadRegistro= COUNT(*) from #dbtrans0

									while @va<@cantidadRegistro
										begin
											select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
														 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
														 @venta=venta,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
														 @tRtipopedido=ttipopedido,@area=area,@codigo=codigo,@titem=titem,@costoprop=costoprop,
														 @costoped=costoped
    										from #DBTRANS0 order by producto,tCodigoPedido,tItem
											if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
													update #dbtrans2
													set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
													where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
												end
											else
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
									 
													insert into #dbtrans2 
													select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
														 subgrupo,producto+' '+propiedad , ncantidad,venta,tcodigopedido, tdocumento,ffecha,
														 ttipopedido,area,codigo,titem,costoprop,costoped
													from #DBTRANS0 order by producto,tCodigoPedido,tItem
 												end 
													DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
													titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
													set @Va=@Va+1
										end 

											if (@flagPrecioCosto=1) or (@flagOpcionCom=1)
												begin
													  if (@flagOpcionCom=1)	
													   begin
																Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area)
																select tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,sum(ncantidad),sum(ncantidad * (costoprop+costoped)),sum(venta),area
																from #dbtrans2
																group by tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,area
														end
													 ELSE
													   begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select					tLocal,  Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto, SUM(NCANTIDAD),sum(ncantidad * (costoprop+costoped)),   tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem

													   end 	
												end	
											else
												begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																
												end	 
							end
						if @flagPedidosFacturados=1 --pedidos facturados 
							begin
									if @flagOpcionCom=1
									begin
									set @sprecio=' dbo.DPEDIDO.nPrecioNeto*dbo.DPEDIDO.nCantidad '
									end
									SET @sqlP=  ' insert into #dbtrans0 ' + 
												' SELECT     dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
												' ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' +
												' FROM         dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.vPropiedad RIGHT OUTER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.vPropiedad.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad LEFT OUTER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND  dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
												' WHERE  dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado ='+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1))  and '+ @sCriterio + @sFiltro  +
												' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
												' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
											 --	print @sqlp
									EXECUTE  sp_executesql @sqlP

									select @cantidadRegistro= COUNT(*) from #dbtrans0
									--print @cantidadregistro
									while @va<@cantidadRegistro
										begin
											select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
														 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
														 @venta=venta,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
														 @tRtipopedido=ttipopedido,@area=area,@codigo=codigo,@titem=titem,@costoprop=costoprop,
														 @costoped=costoped
    										from #DBTRANS0 order by producto,tCodigoPedido,tItem
											if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
													update #dbtrans2
													set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
													where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
												end
											else
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
									 
													insert into #dbtrans2 
													select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
														 subgrupo,producto+' '+propiedad , ncantidad,venta,tcodigopedido, tdocumento,ffecha,
														 ttipopedido,area,codigo,titem,costoprop,costoped
													from #DBTRANS0 order by producto,tCodigoPedido,tItem
 												end 
													DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
													titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
													set @Va=@Va+1
										end 
											

											if (@flagPrecioCosto=1) or (@flagOpcionCom=1)
												begin
													  if (@flagOpcionCom=1)	
													   begin
														
																--SELECT * INTO ANTES FROM #DBTRANS
																Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2 , Area)
																select tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,sum(ncantidad),sum(ncantidad * (ISNULL(costoprop,0)+ISNULL(costoped,0))) AS VENTA,sum(venta) AS VENTA2,area
																from #dbtrans2
																group by tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,area
														
														end
													 ELSE 
													   begin

																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select	tLocal,  Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto, SUM(NCANTIDAD),sum(ncantidad * (costoprop+costoped)),   tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																
													   end 	
												end	
											else
												begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																
												end	 
										  	
							end 
						if @flagPedidosFacturadosCortesia=1
							begin
									if @flagOpcionCom=1
									begin
									set @sprecio=' dbo.DPEDIDO.nPrecioNeto*dbo.DPEDIDO.nCantidad '
									end
									SET @sqlP=  ' insert into #dbtrans0 ' + 
												' SELECT     dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
												' ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' +
												' FROM         dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN  dbo.DPEDIDO RIGHT OUTER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vPropiedad ON dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad = dbo.vPropiedad.Codigo LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN  dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
												' WHERE  dbo.MDOCUMENTO.tCortesia <>'+@comilla+' '+@comilla+' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+')  AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1))  and '+ @sCriterio + @sFiltro  +
												' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
												' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
												
									EXECUTE  sp_executesql @sqlP

									select @cantidadRegistro= COUNT(*) from #dbtrans0

									while @va<@cantidadRegistro
										begin
											select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
														 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
														 @venta=venta,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
														 @tRtipopedido=ttipopedido,@area=area,@codigo=codigo,@titem=titem,@costoprop=costoprop,
														 @costoped=costoped
    										from #DBTRANS0 order by producto,tCodigoPedido,tItem
											if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
													update #dbtrans2
													set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
													where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
												end
											else
												begin
													set @codigoV=@codigo
													set @tcodigoPediDoV=@tcodigoPediDo
													set @tItemV=@tItem
									 
													insert into #dbtrans2 
													select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
														 subgrupo,producto+' '+propiedad , ncantidad,venta,tcodigopedido, tdocumento,ffecha,
														 ttipopedido,area,codigo,titem,costoprop,costoped
													from #DBTRANS0 order by producto,tCodigoPedido,tItem
 												end 
													DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
													titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
													set @Va=@Va+1
										end 

											if (@flagPrecioCosto=1) or (@flagOpcionCom=1)
												begin
													  if (@flagOpcionCom=1)	
													   begin
																Insert into #DBTRANS (PEDIDO, TITEM, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Venta2, Area)
																select tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,sum(ncantidad),sum(ncantidad * (costoprop+costoped)),sum(venta),area
																from #dbtrans2
																group by tcodigopedido,titem,tipoproducto,grupo,subgrupo,producto,area
														end
														ELSE 
													   begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select					tLocal,  Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto, SUM(NCANTIDAD),sum(ncantidad * (costoprop+costoped)),   tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
													   end 	
												end	
											else
												begin
																insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
																select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																From #DBTRANS2 
																Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
																
												end	 

							end 
					end





		set @contadias=@contadias+1
	end 
end 
/**/

/**/




set @Actualizaciones = 'update #DBTRANS set Salon = '+@comilla+'Sin Salon'+@comilla+' where isnull(Salon,'+@comilla+'0'+@comilla+') = '+@comilla+'0'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+ @comilla+@sBoton2 +@comilla+ ' where tTipoPedido ='+@comilla+'02'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+ @comilla+@sBoton3 +@comilla+  ' where tTipoPedido ='+@comilla+'03'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+ @comilla+@sBoton4 +@comilla+ ' where tTipoPedido ='+@comilla+'04'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+ @comilla+@sBoton5 +@comilla+  ' where tTipoPedido ='+@comilla+'05'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Local = vLocal.Descripcion FROM #DBTRANS INNER JOIN dbo.vLocal ON dbo.#DBTRANS.tLocal = dbo.vLocal.Codigo '
EXEC sp_executesql @Actualizaciones
/**/



if @flagSeleccion0 =1
	begin 
	select Local, Salon, TipoProducto, Grupo, SubGrupo, Producto, sum(Cantidad) as Cantidad, sum(Venta) as Venta From #DBTRANS group by Local, Salon, TipoProducto, Grupo, SubGrupo, Producto 
	end
if @flagSeleccion1  =1
	begin  
	select max(Local) as Local , max(Salon) as Salon, max(TipoProducto) as TipoProducto, Grupo, SubGrupo, Producto, sum(Cantidad) as Cantidad, sum(Venta) as Venta From #DBTRANS group by Grupo, SubGrupo, Producto
	end
if @flagSeleccion2  =1
	begin 
	select Local, Salon, Grupo, SubGrupo, Producto, Pedido, Fecha, Cantidad, Venta, Documento From #DBTRANS order by Grupo, SubGrupo, Producto, Pedido 
	end
if @flagSeleccion3  =1
	begin 
	select Area, TipoProducto, Grupo, SubGrupo, Producto, Sum(Cantidad) as Cantidad, Sum(Venta) as Venta From #DBTRANS WHERE Venta IS NOT NULL GROUP BY Area, TipoProducto, Grupo, SubGrupo, Producto order by Area, Grupo, SubGrupo, Producto
	end
if @flagSeleccion4  =1
	begin 
	select Descripcion as Area, TipoProducto, Grupo, SubGrupo, Producto,  Sum(Cantidad) as Cantidad, Sum(Venta) as Venta From #DBTRANS LEFT OUTER JOIN vTipoPedido ON tTipoPedido = vTipoPedido.Codigo GROUP BY Descripcion, TipoProducto, Grupo, SubGrupo, Producto order by Grupo,SubGrupo,Producto
	end
if @flagSeleccion5  =1
	begin 
	select max(Local) as Local , max(Salon) as Salon, max(TipoProducto) as TipoProducto, max(Grupo) as Grupo, max(SubGrupo) as SubGrupo, Producto, sum(Cantidad) as Cantidad, sum(Venta) as Venta From #DBTRANS group by Producto order by Grupo,SubGrupo,Producto
	end
if @flagSeleccion6  =1
	begin 
	 SELECT dbo.vSUBGRUPO.tAgrupacion as Area, TipoProducto, #DBTRANS.Grupo, SubGrupo, Producto, Sum(Cantidad) as Cantidad, Sum(Venta) as Venta  FROM #DBTRANS LEFT OUTER JOIN dbo.vSubGrupo ON dbo.#DBTRANS.Grupo = dbo.vSubGrupo.Grupo AND dbo.#DBTRANS.SubGrupo = dbo.vSubGrupo.Descripcion  GROUP BY dbo.vSUBGRUPO.tAgrupacion, TipoProducto, #DBTRANS.Grupo, SubGrupo, Producto  order by dbo.vSUBGRUPO.tAgrupacion, #DBTRANS.Grupo, SubGrupo, Producto
	end
IF @flagSeleccion7  =1
	IF @flagTipoEmision = 1
		BEGIN 
			select Descripcion as Area, TipoProducto, Grupo, SubGrupo, Producto, Sum(Cantidad) as Cantidad, Sum(Venta2) as Venta2, 
				   Sum(Venta) as Venta, MAX(VentaN1) As VentaN1, MAX(VentaN2) As VentaN2 
			From #DBTRANS LEFT OUTER JOIN vTipoPedido ON tTipoPedido = vTipoPedido.Codigo 
			GROUP BY Descripcion, TipoProducto, Grupo, SubGrupo, Producto order by   Grupo,SubGrupo,Producto	
		END

	ELSE
		BEGIN 
			select Descripcion as Area, TipoProducto, Grupo, SubGrupo, Producto, Sum(Cantidad) as Cantidad, Sum(Venta2) as Venta2,
					Sum(Venta) as Venta, MAX(VentaN1) As VentaN1, MAX(VentaN2) As VentaN2 
			From #DBTRANS LEFT OUTER JOIN vTipoPedido ON tTipoPedido = vTipoPedido.Codigo 
			GROUP BY Descripcion, TipoProducto, Grupo, SubGrupo, Producto order by   Grupo,SubGrupo,Producto	
		END
END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE spRep_PaloteoPropiedad
@flagOrigenProduccion as bit,
@flagOrigenVenta as bit,
@flagOrigenCortesia as bit,
@flagOrigenCuentaCorriente as bit,
@flagOrigenCombinacion as bit,
@flagOrigenCargos as bit,
@flagOrigenPedidosFacturados as bit,
@flagTurnoOFecha as bit,
@flagOpcion1 as bit,
@flagOpcion2 as bit,
@flagOpcion3 as bit,
@flagOpcion4 as bit,
@dbAlmacen as nvarchar(35),
@turno as nvarchar(30),
@tOperador as nvarchar(30),
@tUnidadNegocio as nvarchar(30),
@tMozo as nvarchar(30),
@tTipoPedido as nvarchar(30),
@tArea as nvarchar(30),
@tCaja as nvarchar(30),
@tGrupo as nvarchar(30),
@tSubGrupo as nvarchar(30),
@tCodigoProducto as nvarchar(30),
@tcodigoPropiedad as nvarchar(30),
@finicio as smalldatetime,
@ffinal as smalldatetime,
@lAlmacen as bit
AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @xSql nvarchar(2000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(1800)
declare @xCriterio nvarchar(1800)
declare @nOpe float
set @comilla=''''
		CREATE TABLE #DBTRANS (Codigo nVarChar(7) collate Modern_Spanish_CI_AS, Grupo nVarChar(50) collate Modern_Spanish_CI_AS, SubGrupo nVarChar(50) collate Modern_Spanish_CI_AS, Producto nVarChar(100) collate Modern_Spanish_CI_AS, Operador nVarChar(50) collate Modern_Spanish_CI_AS, Propiedad nVarChar(50) collate Modern_Spanish_CI_AS, Cantidad Float, Venta Float, Pedido nVarchar(10) collate Modern_Spanish_CI_AS, Documento nVarChar(20) collate Modern_Spanish_CI_AS, Fecha DateTime, Area nVarChar(30) collate Modern_Spanish_CI_AS, tCodigoProducto nVarChar(7) collate Modern_Spanish_CI_AS, nCantidadTotal float)


if @flagTurnoOFecha=0 
	begin
	set @sCriterio=' MPEDIDO.tTurno like ' + @comilla+@turno+'%'+@comilla
	set @xCriterio=' MDOCUMENTO.tTurno like '+ @comilla+@turno+'%'+@comilla
	end
else
	begin
	set @scriterio=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @xCriterio=' MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + '  and MDOCUMENTO.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	end
	
	if @toperador<>''
		SET @sCriterio=@sCriterio + ' and vOperador.Codigo like ' + @comilla+@tOperador+'%'+@comilla	
	if @tunidadnegocio<>''
		SET @sCriterio=@sCriterio + ' and DPEDIDO.tUnidadNegocio like ' + @comilla+@tUnidadNegocio+'%'+@comilla	
	if @tmozo<>''
		SET @sCriterio=@sCriterio + ' and tMozo like  ' + @comilla+@tMozo+'%'+@comilla
	if @ttipopedido<>''
		SET @sCriterio=@sCriterio + ' and MPEDIDO.tTipoPedido like  ' + @comilla+@tTipoPedido+'%'+@comilla
	if @tarea<>''
		SET @sCriterio=@sCriterio + ' and Area like  ' + @comilla+@tArea+'%'+@comilla
	if @tcaja<>''
		SET @sCriterio=@sCriterio + ' and MPEDIDO.tCaja  like ' + @comilla+@tCaja+'%'+@comilla
	if @tgrupo<>''
		SET @sCriterio=@sCriterio + ' and vProducto.Grupo like ' + @comilla+@tGrupo+'%'+@comilla
	if @tSubgrupo<>''
		SET @sCriterio=@sCriterio + ' and subGrupo like ' + @comilla+@tSubGrupo+'%'+@comilla
	if @tcodigoproducto<>''
		SET @sCriterio=@sCriterio + ' and DPEDIDO.tCodigoProducto like ' + @comilla+@tCodigoProducto+'%'+@comilla
	if @tcodigopropiedad<>''
		SET @sCriterio=@sCriterio + ' and TPRODUCTOPROPIEDAD.tCodigoPropiedad like ' + @comilla+@tCodigoPropiedad+'%'+@comilla

if @lAlmacen=1 
	begin
		 CREATE TABLE #DBOPE(Codigo nVarChar(10) collate Modern_Spanish_CI_AS, Descripcion nVarChar(70) collate Modern_Spanish_CI_AS)
		 SET @sql='insert into #DBOPE select Codigo, Descripcion from vOperador where lStockMenos=1'
		 EXECUTE  sp_executesql @sql
		 select @nOpe =COUNT(*) from #DBOPE
		IF @nOpe <=0 
			begin
			set @xSql = ' select tCodigoPropiedad as Codigo, TPROPIEDAD.tDetallado as Propiedad, tProducto, TPROPIEDAD.tOperador, nPrecio, tEnlace,nInsumo, nGasto, nManoObra, toperador.tDetallado AS Operador, tArea ' + 
            			    ' FROM dbo.TPROPIEDAD LEFT OUTER JOIN dbo.TOPERADOR ON dbo.TPROPIEDAD.tOperador = dbo.TOPERADOR.tOperador Where TPROPIEDAD.lActivo = 1 And IsNull(TOPERADOR.lStockMenos, 0) <> 1'
			end
		else
			begin
			set @xSql = ' select tCodigoPropiedad as Codigo, TPROPIEDAD.tDetallado as Propiedad, tProducto, TOPERADOR.tOperador as tOperador, TOPERADOR.tDetallado as Operador, nPrecio, tEnlace, nInsumo, nGasto, nManoObra, tArea ' +
				    ' FROM dbo.TPROPIEDAD LEFT OUTER JOIN dbo.TOPERADOR ON dbo.TPROPIEDAD.tOperador = dbo.TOPERADOR.tOperador  ' +
                   		    ' Where TPROPIEDAD.lActivo = 1 And IsNull(TOPERADOR.lStockMenos, 0) <> 1 union ' + 
			            ' select '+@comilla+'9999'+@comilla+' , tDetallado as Propiedad, tCodigoPlato as tProducto, (select TOP 1 codigo from #DBOPE) as tOperador,  (select TOP 1 Descripcion from #DBOPE)  as Operador, 0, ' + @dbAlmacen + '.dbo.DRECETAVENTA.tCodigoProducto as tEnlace, nCantidad * nPrecio as nInsumo, 0, 0, '+@comilla+'000'+ @comilla +
 			            ' FROM ' + @dbAlmacen + '.dbo.DRECETAVENTA INNER JOIN ' + @dbAlmacen + '.dbo.MRECETAVENTA ON ' + @dbAlmacen + '.dbo.DRECETAVENTA.tLocal = ' + @dbAlmacen + '.dbo.MRECETAVENTA.tLocal AND ' + @dbAlmacen + '.dbo.DRECETAVENTA.tRecetaVenta = ' + @dbAlmacen + '.dbo.MRECETAVENTA.tRecetaVenta INNER JOIN ' + @dbAlmacen + '.dbo.TPRODUCTO ON ' + @dbAlmacen + '.dbo.DRECETAVENTA.tCodigoProducto = ' + @dbAlmacen + '.dbo.TPRODUCTO.tCodigoProducto ' +
			            ' Where lNoDescargo = 1'
			end
	end
else
	begin
	set @xSql = 	' select tCodigoPropiedad as Codigo, TPROPIEDAD.tDetallado as Propiedad, tProducto, TPROPIEDAD.tOperador, nPrecio, tEnlace, nInsumo, nGasto, nManoObra, toperador.tDetallado AS Operador, tArea ' +
            		' FROM dbo.TPROPIEDAD LEFT OUTER JOIN dbo.TOPERADOR ON dbo.TPROPIEDAD.tOperador = dbo.TOPERADOR.tOperador ' +
            		' Where TPROPIEDAD.lActivo = 1 And IsNull(TOPERADOR.lStockMenos, 0) <> 1'
	end
if @flagOrigenProduccion=1 
	-- produccion
	begin
	SET @sql=' insert into #DBTRANS SELECT dbo.vproducto.Codigo, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.vOperador.Descripcion AS Operador, T1.Propiedad, dbo.DPEDIDO.nCantidad AS Cantidad,  dbo.TPRODUCTOPROPIEDAD.nInsumo + dbo.TPRODUCTOPROPIEDAD.nGasto + dbo.TPRODUCTOPROPIEDAD.nManoObra AS nVenta, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, vArea.Descripcion AS Area, T1.Codigo, 0 ' +
		 ' FROM dbo.MPEDIDO RIGHT OUTER JOIN dbo.vOperador RIGHT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN ( ' + @xSql + ' ) T1 INNER JOIN dbo.TPRODUCTOPROPIEDAD ON T1.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad AND T1.tProducto = dbo.TPRODUCTOPROPIEDAD.tProducto AND T1.tEnlace COLLATE Modern_Spanish_CI_AS = dbo.TPRODUCTOPROPIEDAD.tEnlace RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem AND dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON dbo.vOperador.Codigo = T1.tOperador LEFT OUTER JOIN (SELECT     Codigo, Descripcion From dbo.vArea Union SELECT   '+@comilla+'000'+@comilla+', '+@comilla+'Sin Area'+@comilla+') vArea ON T1.tArea = vArea.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ' +
		 ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriterio
	end

if @flagOrigenVenta=1
	begin
	--Venta
      	set @sql= 	' insert into #DBTRANS  ' +
             	 	' SELECT dbo.vproducto.Codigo, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.vOperador.Descripcion AS Operador, T1.Propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, dbo.TPRODUCTOPROPIEDAD.nInsumo + dbo.TPRODUCTOPROPIEDAD.nGasto + dbo.TPRODUCTOPROPIEDAD.nManoObra AS nVenta, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, vArea.Descripcion AS Area, T1.Codigo, 0  ' +
                  	' FROM dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja RIGHT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN ( ' + @xSql + ' ) T1 INNER JOIN dbo.TPRODUCTOPROPIEDAD ON T1.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad AND T1.tProducto = dbo.TPRODUCTOPROPIEDAD.tProducto AND T1.tEnlace COLLATE Modern_Spanish_CI_AS = dbo.TPRODUCTOPROPIEDAD.tEnlace RIGHT OUTER JOIN dbo.MDOCUMENTO INNER JOIN dbo.DPEDIDO ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento ON dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem AND dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN dbo.vOperador ON T1.tOperador = dbo.vOperador.Codigo LEFT OUTER JOIN (SELECT Codigo, Descripcion From dbo.vArea Union SELECT  '+@comilla+'000'+@comilla+', '+@comilla+'Sin Area'+@comilla+') vArea ON T1.tArea = vArea.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ' +
    	          	' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and  ' + @sCriterio + '  and ' + @xCriterio
	end

if @flagOrigenCortesia=1
	begin
   	--Cortesia
      	set @sql= 	' insert into #DBTRANS  ' +
       	 	  	' SELECT dbo.vproducto.Codigo, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.vOperador.Descripcion AS Operador, T1.Propiedad, dbo.DPEDIDO.nCantidad AS Cantidad,  dbo.TPRODUCTOPROPIEDAD.nInsumo + dbo.TPRODUCTOPROPIEDAD.nGasto + dbo.TPRODUCTOPROPIEDAD.nManoObra AS nVenta, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, vArea.Descripcion AS Area, T1.Codigo, 0  ' +
             	  	' FROM dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja RIGHT OUTER JOIN dbo.vOperador RIGHT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN ( ' + @xSql + ' ) T1 INNER JOIN dbo.TPRODUCTOPROPIEDAD ON T1.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad AND T1.tProducto = dbo.TPRODUCTOPROPIEDAD.tProducto AND T1.tEnlace COLLATE Modern_Spanish_CI_AS = dbo.TPRODUCTOPROPIEDAD.tEnlace RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem AND dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON dbo.vOperador.Codigo = T1.tOperador LEFT OUTER JOIN (SELECT Codigo, Descripcion From dbo.vArea Union SELECT '+@comilla+'000'+@comilla+', '+@comilla+'Sin Area'+@comilla+') vArea ON T1.tArea = vArea.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido  ' +
            	  	' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and  ' + @sCriterio
	end

if @flagOrigenCuentaCorriente=1
	begin
	--Cuentas Corrientes
     	set @sql=    	' insert into #DBTRANS  ' +
             		' SELECT dbo.vproducto.Codigo, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.vOperador.Descripcion AS Operador, T1.Propiedad, dbo.DPEDIDO.nCantidad AS Cantidad,  dbo.TPRODUCTOPROPIEDAD.nInsumo + dbo.TPRODUCTOPROPIEDAD.nGasto + dbo.TPRODUCTOPROPIEDAD.nManoObra AS nVenta, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, vArea.Descripcion AS Area, T1.Codigo, 0  ' +
             		' FROM dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja RIGHT OUTER JOIN dbo.vOperador RIGHT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN ( ' + @xSql + ' ) T1 INNER JOIN dbo.TPRODUCTOPROPIEDAD ON T1.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad AND T1.tProducto = dbo.TPRODUCTOPROPIEDAD.tProducto AND T1.tEnlace COLLATE Modern_Spanish_CI_AS = dbo.TPRODUCTOPROPIEDAD.tEnlace RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem AND dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON dbo.vOperador.Codigo = T1.tOperador LEFT OUTER JOIN (SELECT Codigo, Descripcion From dbo.vArea Union SELECT '+@comilla+'000'+@comilla+', '+@comilla+'Sin Area'+@comilla+') vArea ON T1.tArea = vArea.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido  ' +
             		' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and  ' + @sCriterio + ' and dbo.DPEDIDO.tCodigoPedido not in  (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and '+  @xCriterio  + ')'
	end

if @flagOrigenCombinacion=1
	begin
	--Combinacion
     /*	set @sql=    	' insert into #DBTRANS  ' +
        	    	' SELECT dbo.vproducto.Codigo, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.vOperador.Descripcion AS Operador, T1.Propiedad, dbo.CPEDIDO.nCantidad AS Cantidad, dbo.TCOMBOPROPIEDAD.nInsumo + dbo.TCOMBOPROPIEDAD.nGasto + dbo.TCOMBOPROPIEDAD.nManoObra AS nVenta, dbo.CPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, vArea.Descripcion AS Area, T1.Codigo, 0  ' +
             	     	' FROM dbo.vOperador RIGHT OUTER JOIN ( ' + @xSql + ' ) T1 RIGHT OUTER JOIN dbo.TCOMBOPROPIEDAD RIGHT OUTER JOIN dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem ON dbo.TCOMBOPROPIEDAD.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.TCOMBOPROPIEDAD.tItem = dbo.CPEDIDO.tItem AND dbo.TCOMBOPROPIEDAD.tItemCombo = dbo.CPEDIDO.tItemCombo ON T1.tEnlace COLLATE Modern_Spanish_CI_AS = dbo.TCOMBOPROPIEDAD.tEnlace AND T1.tProducto COLLATE Modern_Spanish_CI_AS = dbo.TCOMBOPROPIEDAD.tProducto AND T1.Codigo COLLATE Modern_Spanish_CI_AS = dbo.TCOMBOPROPIEDAD.tCodigoPropiedad LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ON dbo.vOperador.Codigo = T1.tOperador LEFT OUTER JOIN  ' +
             		' (SELECT Codigo, Descripcion From dbo.vArea Union SELECT '+@comilla+'000'+@comilla+', '+@comilla+'Sin Area'+@comilla+') vArea ON T1.tArea = vArea.Codigo  ' +
             		' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and  ' + @sCriterio*/
		set @sql=	' insert into #DBTRANS  ' +
        	    	' SELECT dbo.vproducto.Codigo, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.vOperador.Descripcion AS Operador, T1.Propiedad, dbo.CPEDIDO.nCantidad AS Cantidad, dbo.TCOMBOPROPIEDAD.nInsumo + dbo.TCOMBOPROPIEDAD.nGasto + dbo.TCOMBOPROPIEDAD.nManoObra AS nVenta, dbo.CPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, vArea.Descripcion AS Area, T1.Codigo, 0  ' +
             	     	' FROM  dbo.MPEDIDO LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja RIGHT OUTER JOIN dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN dbo.TCOMBOPROPIEDAD  ON  dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND  dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN ( ' + @xSql + ' ) T1 ON dbo.TCOMBOPROPIEDAD.tEnlace = T1.tEnlace COLLATE Modern_Spanish_CI_AS AND  dbo.TCOMBOPROPIEDAD.tProducto = T1.tProducto COLLATE Modern_Spanish_CI_AS AND dbo.TCOMBOPROPIEDAD.tCodigoPropiedad = T1.Codigo COLLATE Modern_Spanish_CI_AS LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vOperador ON T1.tOperador = dbo.vOperador.Codigo LEFT OUTER JOIN ' +
	                ' (SELECT     Codigo, Descripcion FROM dbo.vArea UNION SELECT     '+@comilla+'000'+@comilla+', '+@comilla+'Sin Area'+@comilla+') vArea ON T1.tArea = vArea.Codigo ' +
             		' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and  ' + @sCriterio

	end

if @flagOrigenCargos=1
	begin
   	--Cargos
      	set @sql= 	' insert into #DBTRANS  ' +
             		' SELECT dbo.vproducto.Codigo, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.vOperador.Descripcion AS Operador, T1.Propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, dbo.TPRODUCTOPROPIEDAD.nInsumo + dbo.TPRODUCTOPROPIEDAD.nGasto + dbo.TPRODUCTOPROPIEDAD.nManoObra AS nVenta, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, vArea.Descripcion AS Area, T1.Codigo, 0  ' +
             		' FROM dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja RIGHT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN ( ' + @xSql + ' ) T1 INNER JOIN dbo.TPRODUCTOPROPIEDAD ON T1.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad AND T1.tProducto = dbo.TPRODUCTOPROPIEDAD.tProducto AND T1.tEnlace COLLATE Modern_Spanish_CI_AS = dbo.TPRODUCTOPROPIEDAD.tEnlace RIGHT OUTER JOIN dbo.MDOCUMENTO INNER JOIN dbo.DPEDIDO ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento ON dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem AND dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN dbo.vOperador ON T1.tOperador = dbo.vOperador.Codigo LEFT OUTER JOIN (SELECT Codigo, Descripcion From dbo.vArea Union SELECT '+@comilla+'000'+@comilla+', '+@comilla+'Sin Area'+@comilla+') vArea ON T1.tArea = vArea.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido  ' +
             		' where MPEDIDO.tEstadoPedido ='+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and  ' + @sCriterio + '  and ' + @xCriterio
	end

if @flagOrigenPedidosFacturados=1
	begin
   	--Pedidos Facturados

      	set @sql= 	' insert into #DBTRANS  ' +
             		' SELECT dbo.vproducto.Codigo, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.vOperador.Descripcion AS Operador, T1.Propiedad, dbo.DPEDIDO.nCantidad AS Cantidad,  dbo.TPRODUCTOPROPIEDAD.nInsumo + dbo.TPRODUCTOPROPIEDAD.nGasto + dbo.TPRODUCTOPROPIEDAD.nManoObra AS nVenta, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, vArea.Descripcion AS Area, T1.Codigo, 0  ' +
             		' FROM dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja RIGHT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN ( ' + @xSql + ' ) T1 INNER JOIN dbo.TPRODUCTOPROPIEDAD ON T1.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad AND T1.tProducto = dbo.TPRODUCTOPROPIEDAD.tProducto AND T1.tEnlace COLLATE Modern_Spanish_CI_AS = dbo.TPRODUCTOPROPIEDAD.tEnlace RIGHT OUTER JOIN dbo.MDOCUMENTO INNER JOIN dbo.DPEDIDO ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento ON dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem AND dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN dbo.vOperador ON T1.tOperador = dbo.vOperador.Codigo LEFT OUTER JOIN (SELECT Codigo, Descripcion From dbo.vArea Union SELECT '+@comilla+'000'+@comilla+', '+@comilla+'Sin Area'+@comilla+') vArea ON T1.tArea = vArea.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido  ' +
             		' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and  ' + @sCriterio + '  and ' + @xCriterio
	end
 EXECUTE  sp_executesql @sql
  print @sql

/**/
/**/
if @flagOpcion1=1
	begin
	set @sql=    ' UPDATE #DBTRANS set nCantidadTotal = T1.nCantidadTotal  ' +
                     ' FROM (SELECT dbo.DPEDIDO.tCodigoProducto AS Codigo, SUM(dbo.DPEDIDO.nCantidad) AS nCantidadTotal '+
	             ' FROM dbo.TPROPIEDAD INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.TPROPIEDAD.tCodigoPropiedad = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad     AND 
                      dbo.TPROPIEDAD.tProducto = dbo.TPRODUCTOPROPIEDAD.tProducto  INNER JOIN dbo.vOperador ON dbo.TPROPIEDAD.tOperador = dbo.vOperador.Codigo RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
                     ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and '+ @sCriterio + ' GROUP BY dbo.DPEDIDO.tCodigoProducto) as T1 where T1.Codigo = #DBTRANS.Codigo '

	 EXECUTE  sp_executesql @sql
 	--print @sql
	

		Select Grupo, SubGrupo, Producto, Operador, case when isnull(Propiedad,'')='' then '(sin propiedad)' else Propiedad End , sum(Cantidad) as Cantidad, avg(Venta) as Venta, sum(Cantidad*Venta) as total, avg(nCantidadTotal) as ncantidadtotal From #DBTRANS Group by Grupo, SubGrupo, Producto, Operador, Propiedad
	end

if @flagOpcion2=1
	begin
		select Area, Operador, Propiedad, sum(Cantidad) as Cantidad, AVG(Venta) as Venta, sum(Cantidad*Venta) as Total From #DBTRANS Group by Area, Operador, Propiedad
	end

if @flagOpcion3=1
	begin
		select Operador, Propiedad, Pedido, Producto, Fecha, Cantidad, Venta, Documento  From #DBTRANS Order by Operador, Propiedad, Pedido
	end

if @flagOpcion4=1
	begin
		select Operador, Propiedad, sum(Cantidad) as Cantidad, AVG(Venta) as Venta, sum(Cantidad*Venta) as Total From #DBTRANS Group by Operador, Propiedad order by Operador, Propiedad
	end
END

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


CREATE PROCEDURE spRep_PaloteoSubProd
@flagTurno as bit,
@tTurno as nvarchar(30),
@tLocal as nvarchar(30),
@tSalon as nvarchar(30),
@tipoProd as nvarchar(30),
@tmozo as nvarchar(30),
@ttipoPedido as nvarchar(30),
@tarea as nvarchar(30),
@tcaja as nvarchar(30),
@tcodigoproducto as nvarchar(30),
@tcodigocliente as nvarchar(30),
@sBoton2 as nvarchar(30),
@sBoton3 as nvarchar(30),
@sBoton4 as nvarchar(30),
@sBoton5 as nvarchar(30),
@fInicio as smalldatetime,
@fFinal as smalldatetime

AS BEGIN
set nocount on
	create table #DBTRANS (tLocal nVarChar(30) collate Modern_Spanish_CI_AS, Local nVarChar(30) collate Modern_Spanish_CI_AS, Salon nVarChar(30) collate Modern_Spanish_CI_AS, tMesa nVarChar(3) collate Modern_Spanish_CI_AS, TipoProducto nVarChar(30) collate Modern_Spanish_CI_AS, Grupo nVarChar(50) collate Modern_Spanish_CI_AS, SubGrupo nVarChar(50) collate Modern_Spanish_CI_AS, Producto nVarChar(50) collate Modern_Spanish_CI_AS, Cantidad Float, Venta Float, Pedido nVarchar(10) collate Modern_Spanish_CI_AS, Documento nVarChar(20) collate Modern_Spanish_CI_AS, Fecha DateTime, tTipoPedido nVarchar(2) collate Modern_Spanish_CI_AS, Area nVarChar(30) collate Modern_Spanish_CI_AS, subProducto nvarchar(60) collate Modern_Spanish_CI_AS, cantprod Float)

	if @flagTurno=0 
		begin
			Insert into #DBTRANS (tLocal, Salon, tMesa, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido,subproducto,cantprod ) 
			SELECT dbo.vSalon.local,dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vproductoxProducto.tdetallado AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 0 AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido,dbo.vproductoxproducto.producto as subproducto,dpedido.ncantidad*dbo.vproductoxproducto.ncantidad as  cantProd 
            		FROM         dbo.MPEDIDO INNER JOIN  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vPRODUCTOXPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.vPRODUCTOXPRODUCTO.tSubProducto INNER JOIN dbo.vProducto ON dbo.vPRODUCTOXPRODUCTO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento
        	    	where MPEDIDO.tEstadoPedido <> '03' and DPEDIDO.tEstadoItem='N' and MPEDIDO.tTurno like @tturno+'%' and vSalon.tLocal like @tlocal+'%' and MPEDIDO.tSalon like @tsalon+'%' and tTipoProducto like @tipoprod+'%' and tMozo like @tmozo+'%' and MPEDIDO.tTipoPedido like @ttipopedido+'%' and Area like @tarea+'%' and MPEDIDO.tCaja like @tcaja+'%' and Vproductoxproducto.tCodigoProducto like @tcodigoProducto+'%' and MDOCUMENTO.tCodigoCliente like @tcodigocliente+'%'
		        Order by Local, Salon,Producto,subproducto 
		end
	else
		begin
			Insert into #DBTRANS (tLocal, Salon, tMesa, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido,subproducto,cantprod ) 
			SELECT dbo.vSalon.local,dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vproductoxProducto.tdetallado AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 0 AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido,vproductoxproducto.producto as subproducto,dpedido.ncantidad*vproductoxproducto.ncantidad as  cantProd 
            		FROM         dbo.MPEDIDO INNER JOIN  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vPRODUCTOXPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.vPRODUCTOXPRODUCTO.tSubProducto INNER JOIN dbo.vProducto ON dbo.vPRODUCTOXPRODUCTO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento
        	    	where MPEDIDO.tEstadoPedido <> '03' and DPEDIDO.tEstadoItem='N' and MPEDIDO.fRegistro >=@fInicio and MPEDIDO.fRegistro <= @ffinal and vSalon.tLocal like @tlocal+'%' and MPEDIDO.tSalon like @tsalon+'%' and tTipoProducto like @tipoprod+'%' and tMozo like @tmozo+'%' and MPEDIDO.tTipoPedido like @ttipopedido+'%' and Area like @tarea+'%' and MPEDIDO.tCaja like @tcaja+'%' and Vproductoxproducto.tCodigoProducto like @tcodigoProducto+'%' and MDOCUMENTO.tCodigoCliente like @tcodigocliente+'%'
		        Order by Local, Salon,Producto,subproducto
		end
	   update #DBTRANS set Salon = 'Resumen'
	   update #DBTRANS set Salon =@sBoton2  where tTipoPedido ='02'
	   update #DBTRANS set Salon =@sBoton3  where tTipoPedido ='03'
	   update #DBTRANS set Salon =@sBoton4  where tTipoPedido ='04'
	   update #DBTRANS set Salon =@sBoton5  where tTipoPedido ='05'
	   update #DBTRANS set Salon = 'Sin Salon' where isnull(Salon,'0') = '0'

	   select tLocal as local, Salon, Producto,subproducto,sum(cantidad) as Cantidad, sum(Cantprod) as cantprod,sum(venta) as venta From #DBTRANS group by tLocal, Salon, Producto,subproducto
END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


CREATE PROCEDURE [dbo].[spRep_Pedido]
@flagFranjaHoraria as bit,
@flagTipo as bit,
@flagTurnoFecha as bit,
@tturno as nvarchar(30),
@tlocal as nvarchar(30),
@tSalon as nvarchar(30),
@tTipoPedido as nvarchar(30),
@tEstadoPedido as nvarchar(30),
@tcaja as nvarchar(30),
@nAdulto as int,
@nPrecuenta as int,
@nEnvio as int,
@fInicio as smalldatetime,
@fFinal as smalldatetime

AS BEGIN

set nocount on
declare @sql as nvarchar(4000)
declare @sCriterio as nvarchar(2000)
declare @comilla nvarchar(5)
set @comilla=''''






if @flagFranjaHoraria=0 
begin


if @flagTurnoFecha=0 
	begin
	set @sCriterio=' MPEDIDO.tTurno like ' + @comilla+@tturno+'%'+@comilla

	end
else
	begin
	set @scriterio=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@ffinal)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	end

	if @tlocal<>''
		set @scriterio = @scriterio + ' and vSalon.tLocal like ' +  @comilla+@tlocal+'%'+@comilla
	if @tsalon <> ''
		set @scriterio = @scriterio + ' and MPEDIDO.tSalon like  ' +  @comilla+@tSalon+'%'+@comilla
	if @ttipopedido<>''
		set @scriterio = @scriterio + ' and MPEDIDO.tTipoPedido like  ' +  @comilla+@tTipoPedido+'%'+@comilla
	if @testadopedido<>''
		set @scriterio = @scriterio + ' and tEstadoPedido like  ' +  @comilla+@tEstadoPedido+'%'+@comilla
	if @tcaja<>''
		set @scriterio = @scriterio + ' and tcaja like ' +  @comilla+@tCaja+'%'+@comilla
	if @nadulto <> 0 
		set @scriterio = @scriterio + ' and nAdulto >= ' +ltrim(str(@nAdulto))
	if @nprecuenta<>0
		set @scriterio = @scriterio + ' and nPrecuenta  >= ' +ltrim(str(@nPrecuenta))
	if @nenvio <>0
		set @scriterio = @scriterio + ' and nEnvio >=' + ltrim(str(@nEnvio))
if @flagTipo=1  --detallado
	begin
		set @sql = ' SELECT dbo.MPEDIDO.tCodigoPedido, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tCaja, dbo.MPEDIDO.tUsuario, dbo.MPEDIDO.tTurno, dbo.vTipoPedido.Descripcion AS TipoPedido, dbo.vEstadoPedido.Descripcion AS EstadoPedido, dbo.TMESA.tDetallado AS Mesa, dbo.MPEDIDO.tObservacion, dbo.vMozo.Descripcion AS Mozo, dbo.MPEDIDO.nAdulto, dbo.MPEDIDO.nPrecuenta, dbo.MPEDIDO.tusuarioAnulado, dbo.TDELIVERY.tTelefono, dbo.DPEDIDO.tItem, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad, dbo.DPEDIDO.nVenta AS nVenta, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.tDocumento AS Documento, dbo.DPEDIDO.nEnvio ' + 
		           ' FROM dbo.vSalon RIGHT OUTER JOIN dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON  dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TDELIVERY ON dbo.MPEDIDO.tClienteDelivery = dbo.TDELIVERY.tCodigoDelivery LEFT OUTER JOIN dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo LEFT OUTER JOIN dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo LEFT OUTER JOIN dbo.vEstadoPedido ON dbo.MPEDIDO.tEstadoPedido = dbo.vEstadoPedido.Codigo ' +
		           ' WHERE ' +  @sCriterio	
		execute sp_executesql @sql
		--print @sql
	end
else		-- resumido
	begin
		set @sql = ' SELECT dbo.MPEDIDO.tCodigoPedido, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tCaja, dbo.MPEDIDO.tUsuario, dbo.MPEDIDO.tTurno, dbo.vTipoPedido.Descripcion AS TipoPedido, dbo.vEstadoPedido.Descripcion AS EstadoPedido, dbo.TMESA.tDetallado AS Mesa,   dbo.MPEDIDO.tObservacion, dbo.vMozo.Descripcion AS Mozo, dbo.MPEDIDO.nAdulto, dbo.MPEDIDO.nPreCuenta, dbo.MPEDIDO.tusuarioAnulado, dbo.TDELIVERY.tTelefono, SUM(dbo.DPEDIDO.nVenta) AS nVenta, MAX(dbo.DPEDIDO.tDocumento) AS Documento ' +
             		   ' FROM dbo.TDELIVERY RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TDELIVERY.tCodigoDelivery = dbo.MPEDIDO.tClienteDelivery LEFT OUTER JOIN dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo LEFT OUTER JOIN dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo LEFT OUTER JOIN dbo.vEstadoPedido ON dbo.MPEDIDO.tEstadoPedido = dbo.vEstadoPedido.Codigo ' +
	  	           ' where '  + @sCriterio +
		           ' GROUP BY dbo.MPEDIDO.tCodigoPedido, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tCaja, dbo.MPEDIDO.tUsuario, dbo.MPEDIDO.tTurno, dbo.vTipoPedido.Descripcion, dbo.vEstadoPedido.Descripcion, dbo.TMESA.tDetallado, dbo.MPEDIDO.tObservacion, dbo.vMozo.Descripcion,  dbo.MPEDIDO.nAdulto , dbo.MPEDIDO.nPreCuenta, dbo.MPEDIDO.tusuarioAnulado, dbo.TDELIVERY.tTelefono '
		execute sp_executesql @sql
		--print @sql
	end


end

if @flagFranjaHoraria=1 
begin

declare @numdias int
declare @contaDias int
declare @finicial as datetime
set @numdias=(select   DATEDIFF ( day , @finicio,@ffinal))
set @contaDias=0
set @finicial=@finicio

	if @flagTipo=1 -- DETALLADO
		begin
		
			CREATE TABLE #DBTRANSD (tCodigoPedido nVarChar(15) collate Modern_Spanish_CI_AS, ffecha datetime, tCaja nVarChar(3) collate Modern_Spanish_CI_AS, tUsuario nVarChar(50) collate Modern_Spanish_CI_AS, tTurno nVarChar(15) collate Modern_Spanish_CI_AS, TipoPedido nVarChar(100) collate Modern_Spanish_CI_AS, EstadoPedido nVarChar(50) collate Modern_Spanish_CI_AS, Mesa nVarChar(30) collate Modern_Spanish_CI_AS,tObservacion nVarChar(100) collate Modern_Spanish_CI_AS,Mozo nVarChar(100) collate Modern_Spanish_CI_AS, nAdulto Float, nPrecuenta Float, tUsuarioAnulado nVarchar(50) collate Modern_Spanish_CI_AS, tTelefono nVarChar(30) collate Modern_Spanish_CI_AS,tItem nVarChar(3) collate Modern_Spanish_CI_AS,Producto nVarChar(200) collate Modern_Spanish_CI_AS, nCantidad float, nVenta   float,  fEnvio DateTime, Documento nVarchar(30) collate Modern_Spanish_CI_AS, nEnvio float )
		end 
	ELSE --resumido
		BEGIN
			CREATE TABLE #DBTRANSR (tCodigoPedido nVarChar(15) collate Modern_Spanish_CI_AS, ffecha datetime, tCaja nVarChar(3) collate Modern_Spanish_CI_AS, tUsuario nVarChar(50) collate Modern_Spanish_CI_AS, tTurno nVarChar(15) collate Modern_Spanish_CI_AS, TipoPedido nVarChar(100) collate Modern_Spanish_CI_AS, EstadoPedido nVarChar(50) collate Modern_Spanish_CI_AS, Mesa nVarChar(30) collate Modern_Spanish_CI_AS,tObservacion nVarChar(100) collate Modern_Spanish_CI_AS,Mozo nVarChar(100) collate Modern_Spanish_CI_AS, nAdulto Float, nPrecuenta Float, tUsuarioAnulado nVarchar(50) collate Modern_Spanish_CI_AS, tTelefono nVarChar(30) collate Modern_Spanish_CI_AS,  nVenta   float,    Documento nVarchar(30) collate Modern_Spanish_CI_AS )

		end

		

while (@contadias<=@numdias)
	begin

					print @contadias
					set @finicio=(select dateadd(day,@contadias,@finicial))	
					set @ffinal= (select  cast(convert(nvarchar,@finicio,112)   + ' '  + CONVERT(VARCHAR,@ffinal,108) as datetime))
					print 'inicio'
					print @finicio
					print 'final'
					print   @ffinal
					print ' zxzzzzz '


					if @flagTurnoFecha=0 
						begin
						set @sCriterio=' MPEDIDO.tTurno like ' + @comilla+@tturno+'%'+@comilla

						end
					else
						begin
						set @scriterio=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@ffinal)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
						end

						if @tlocal<>''
							set @scriterio = @scriterio + ' and vSalon.tLocal like ' +  @comilla+@tlocal+'%'+@comilla
						if @tsalon <> ''
							set @scriterio = @scriterio + ' and MPEDIDO.tSalon like  ' +  @comilla+@tSalon+'%'+@comilla
						if @ttipopedido<>''
							set @scriterio = @scriterio + ' and MPEDIDO.tTipoPedido like  ' +  @comilla+@tTipoPedido+'%'+@comilla
						if @testadopedido<>''
							set @scriterio = @scriterio + ' and tEstadoPedido like  ' +  @comilla+@tEstadoPedido+'%'+@comilla
						if @tcaja<>''
							set @scriterio = @scriterio + ' and tcaja like ' +  @comilla+@tCaja+'%'+@comilla
						if @nadulto <> 0 
							set @scriterio = @scriterio + ' and nAdulto >= ' +ltrim(str(@nAdulto))
						if @nprecuenta<>0
							set @scriterio = @scriterio + ' and nPrecuenta  >= ' +ltrim(str(@nPrecuenta))
						if @nenvio <>0
							set @scriterio = @scriterio + ' and nEnvio >=' + ltrim(str(@nEnvio))
					if @flagTipo=1  --detallado
						begin
							set @sql = ' Insert into #DBTRANSD  SELECT dbo.MPEDIDO.tCodigoPedido, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tCaja, dbo.MPEDIDO.tUsuario, dbo.MPEDIDO.tTurno, dbo.vTipoPedido.Descripcion AS TipoPedido, dbo.vEstadoPedido.Descripcion AS EstadoPedido, dbo.TMESA.tDetallado AS Mesa, dbo.MPEDIDO.tObservacion, dbo.vMozo.Descripcion AS Mozo, dbo.MPEDIDO.nAdulto, dbo.MPEDIDO.nPrecuenta, dbo.MPEDIDO.tusuarioAnulado, dbo.TDELIVERY.tTelefono, dbo.DPEDIDO.tItem, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad, dbo.DPEDIDO.nVenta AS nVenta, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.tDocumento AS Documento, dbo.DPEDIDO.nEnvio ' + 
									   ' FROM dbo.vSalon RIGHT OUTER JOIN dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON  dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TDELIVERY ON dbo.MPEDIDO.tClienteDelivery = dbo.TDELIVERY.tCodigoDelivery LEFT OUTER JOIN dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo LEFT OUTER JOIN dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo LEFT OUTER JOIN dbo.vEstadoPedido ON dbo.MPEDIDO.tEstadoPedido = dbo.vEstadoPedido.Codigo ' +
									   ' WHERE ' +  @sCriterio	
							execute sp_executesql @sql
							--print @sql
						end
					else		-- resumido
						begin
							set @sql = ' Insert into #DBTRANSR SELECT dbo.MPEDIDO.tCodigoPedido, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tCaja, dbo.MPEDIDO.tUsuario, dbo.MPEDIDO.tTurno, dbo.vTipoPedido.Descripcion AS TipoPedido, dbo.vEstadoPedido.Descripcion AS EstadoPedido, dbo.TMESA.tDetallado AS Mesa,   dbo.MPEDIDO.tObservacion, dbo.vMozo.Descripcion AS Mozo, dbo.MPEDIDO.nAdulto, dbo.MPEDIDO.nPreCuenta, dbo.MPEDIDO.tusuarioAnulado, dbo.TDELIVERY.tTelefono, SUM(dbo.DPEDIDO.nVenta) AS nVenta, MAX(dbo.DPEDIDO.tDocumento) AS Documento ' +
             							   ' FROM dbo.TDELIVERY RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TDELIVERY.tCodigoDelivery = dbo.MPEDIDO.tClienteDelivery LEFT OUTER JOIN dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo LEFT OUTER JOIN dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo LEFT OUTER JOIN dbo.vEstadoPedido ON dbo.MPEDIDO.tEstadoPedido = dbo.vEstadoPedido.Codigo ' +
	  								   ' where '  + @sCriterio +
									   ' GROUP BY dbo.MPEDIDO.tCodigoPedido, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tCaja, dbo.MPEDIDO.tUsuario, dbo.MPEDIDO.tTurno, dbo.vTipoPedido.Descripcion, dbo.vEstadoPedido.Descripcion, dbo.TMESA.tDetallado, dbo.MPEDIDO.tObservacion, dbo.vMozo.Descripcion,  dbo.MPEDIDO.nAdulto , dbo.MPEDIDO.nPreCuenta, dbo.MPEDIDO.tusuarioAnulado, dbo.TDELIVERY.tTelefono '
							execute sp_executesql @sql
							--print @sql
						end








set @contadias=@contadias+1
	end 


	if @flagTipo=1 -- DETALLADO
		begin
		
			SELECT * FROM #DBTRANSD ORDER BY tCodigoPedido 
		end 
	ELSE --resumido
		BEGIN
			SELECT * FROM #DBTRANSR ORDER BY tCodigoPedido 

		end




 

end






END





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


CREATE PROCEDURE spRep_Propina
@fInicio as smalldatetime,
@fFinal as smalldatetime

AS BEGIN
set nocount on

SELECT DISTINCT ISNULL(dbo.MPEDIDO.tMozo, N'') AS tMozo,isnull(dbo.mpedido.tmotorizado,N'')as tmotorizado, ISNULL(dbo.TTARJETACREDITO.tDetallado, N'') AS tDetallado,dbo.DPAGODOCUMENTO.nPropina AS Propina, dbo.DPAGODOCUMENTO.tDocumento, dbo.DPAGODOCUMENTO.fRegistro, dbo.DPAGODOCUMENTO.tCorrelativo, 
dbo.mpedido.ttipopedido,(case when dbo.mpedido.ttipopedido='02' then  vMotorizado.descripcion else vmozo.descripcion end) as Trabajador,dbo.vtipopedido.descripcion as TipoPedido,dbo.ttarjetacredito.nfactorretencion 
From dbo.MPEDIDO LEFT OUTER JOIN dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo left outer join dbo.vmotorizado on dbo.mpedido.tmotorizado=dbo.vmotorizado.Codigo left outer join dbo.vtipopedido on dbo.mpedido.ttipopedido=dbo.vtipopedido.Codigo RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido 
RIGHT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento LEFT OUTER JOIN dbo.TTARJETACREDITO ON dbo.DPAGODOCUMENTO.tTarjeta = dbo.TTARJETACREDITO.tCodigoTarjeta  
WHERE (((DPAGODOCUMENTO.nPropina)>0) AND ((DPAGODOCUMENTO.tTipoPago)='02'))  and dpagodocumento.fregistro >= @fInicio and dpagodocumento.fregistro <= @ffinal
order by 1,3,6
END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO 
SET ANSI_NULLS ON 
GO

CREATE PROCEDURE [dbo].[spRep_PaloteoOferta]
@flagTipoReporte as nvarchar(1),
@flagTurnoFecha as bit,
@flagAutoManual as bit,
@sOferta as nvarchar(10),
@sTipoPedido as nvarchar(10),
@sMozo as nvarchar(10),
@sArea as nvarchar(10),
@sCaja as nvarchar(10),
@sUNegocio as nvarchar(10),
@sGrupo as nvarchar(10),
@sSubGrupo as nvarchar(10),
@sTurno as nvarchar(20),
@finicio as smalldatetime,
@ffinal as smalldatetime
AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @comilla nvarchar(5)
declare @scriterio nvarchar(2000)

set @comilla=''''

CREATE TABLE #DBTRANS (tOferta nVarchar(10)collate Modern_Spanish_CI_AS, tNombre nvarchar(200)collate Modern_Spanish_CI_AS,
                       tCodigoProducto nVarchar(10)collate Modern_Spanish_CI_AS, Grupo nVarchar(50)collate Modern_Spanish_CI_AS, SubGrupo nVarchar(50)collate Modern_Spanish_CI_AS,
                       tDetallado nvarchar(100)collate Modern_Spanish_CI_AS, Usuario nvarchar(50)collate Modern_Spanish_CI_AS, decuento Float, venta Float, oficial Float, nCantidad Float, tCodigoPedido nVarchar(50)collate Modern_Spanish_CI_AS)


if @flagTurnoFecha=1
	begin
		set @scriterio=' and dpedido.fregistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And dPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla 
	end
else
	begin
		set @scriterio=' and mpedido.tturno ='+@comilla +@sturno+@comilla
	end
if @flagAutoManual=1

	set @scriterio=@scriterio + ' and toferta.lautomatica=1 ' 
ELSE
	set @scriterio=@scriterio + ' and toferta.lautomatica=0 ' 
if @sOferta <>''
	begin
	set @scriterio=@scriterio + ' and toferta.TOFERTA= '+@comilla +@sOferta+@comilla
	end
if @stipoPedido<>''
	begin
	set @scriterio=@scriterio + ' and mpedido.ttipopedido='+@comilla +@stipoPedido+@comilla
	end
if @sMozo<>'' -- USUARIO QUE AUTORIZA

	begin
		set @scriterio=@scriterio + ' and dpedido.TAUTORIZAOFERTA= ' + @comilla+@smozo+@comilla
	end
if @sArea<>'' -- USUARIO QUE AUTORIZA
	begin
		set @scriterio=@scriterio + ' and dpedido.TArea= ' + @comilla+@sarea+@comilla
	end
if @sCaja<>''
	begin
		set @scriterio=@scriterio + ' and mpedido.tcaja= ' + @comilla+@scaja+@comilla
	end

if @sUNegocio<>''
	begin
		set @scriterio=@scriterio + ' and dpedido.tunidadnegocio= ' + @comilla+@sUNegocio+@comilla
	end

if @sGrupo <>''
	begin
		set @scriterio=@scriterio + ' and dpedido.tcodigogrupo= ' + @comilla+@sGrupo+@comilla
	end
if @sSubGrupo <> ''
	begin
		set @scriterio=@scriterio + ' and dpedido.tcodigosubgrupo= ' + @comilla+@sSubGrupo+@comilla
	end

if @flagTipoReporte='1'
	begin
	set @sql= ' SELECT DISTINCT dbo.DPEDIDO.tOferta, dbo.TOFERTA.tNombre+ '+@COMILLA+ ' ' +@COMILLA+' + (case when toferta.nratio>0 then LTRIM(toferta.NRATIO) + '+@COMILLA+ '%' +@COMILLA+' ELSE CASE WHEN toferta.NMONTO<>0 THEN + '+@COMILLA+ 'MONTO: ' +@COMILLA+'+LTRIM(toferta.NMONTO) ELSE CASE WHEN toferta.NPRECIO<>0 THEN + '+@COMILLA+ 'PRECIO: ' +@COMILLA+'+ LTRIM(toferta.NPRECIO) ELSE '+@COMILLA+ '' +@COMILLA+' END END END ) AS Oferta , dbo.MPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, dbo.TGRUPO.tResumido AS Grupo, dbo.TSUBGRUPO.tResumido AS SubGrupo,  dbo.TPRODUCTO.tResumido AS Producto, dbo.DPEDIDO.fregistro, dbo.TOFERTA.lAutomatica, dbo.DPEDIDO.tAUTORIZAOFERTA AS TUSUARIO, dbo.DPEDIDO.nCantidad, dbo.DPEDIDO.nDescuento * dbo.DPEDIDO.nCantidad, dbo.DPEDIDO.nPrecioVenta*dbo.DPEDIDO.nCantidad, dbo.DPEDIDO.nPrecioOficial *dbo.DPEDIDO.nCantidad ' +
		  ' FROM         dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN   dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN dbo.TGRUPO ON dbo.TPRODUCTO.tGrupo = dbo.TGRUPO.tCodigoGrupo INNER JOIN dbo.TSUBGRUPO ON dbo.TPRODUCTO.tSubGrupo = dbo.TSUBGRUPO.tCodigoSubgrupo LEFT OUTER JOIN dbo.TOFERTA ON dbo.DPEDIDO.tOferta = dbo.TOFERTA.tOferta ' + 
		  ' WHERE     (dbo.DPEDIDO.tOferta IS NOT NULL) AND (dbo.TOFERTA.tNombre IS NOT NULL) and  DPEDIDO.TESTADOITEM='+@COMILLA+'N'+@COMILLA + ' AND DPEDIDO.tfacturado='+@comilla+'P'+@comilla + @scriterio +
		  ' ORDER BY dbo.TOFERTA.tNombre+ '+@COMILLA+ ' ' +@COMILLA+' + (case when toferta.nratio>0 then LTRIM(toferta.NRATIO) + '+@COMILLA+ '%' +@COMILLA+' ELSE CASE WHEN toferta.NMONTO<>0 THEN + '+@COMILLA+ 'MONTO: ' +@COMILLA+'+LTRIM(toferta.NMONTO) ELSE CASE WHEN toferta.NPRECIO<>0 THEN + '+@COMILLA+ 'PRECIO: ' +@COMILLA+'+ LTRIM(toferta.NPRECIO) ELSE '+@COMILLA+ '' +@COMILLA+' END END END ) ,   producto, dbo.DPEDIDO.fregistro '
	end
	
if @flagTipoReporte='2'
	begin
	-- set @sql= ' SELECT DISTINCT dbo.TOFERTA.tOferta, dbo.TOFERTA.tNombre + '+@COMILLA+ ' ' +@COMILLA+'+ (case when toferta.nratio>0 then LTRIM(toferta.NRATIO) + '+@COMILLA+ '%' +@COMILLA+' ELSE CASE WHEN toferta.NMONTO<>0 THEN + '+@COMILLA+ 'MONTO: ' +@COMILLA+'+LTRIM(toferta.NMONTO) ELSE CASE WHEN toferta.NPRECIO<>0 THEN + '+@COMILLA+ 'PRECIO: ' +@COMILLA+'+ LTRIM(toferta.NPRECIO) ELSE '+@COMILLA+ '' +@COMILLA+' END END END ), dbo.TPRODUCTO.tCodigoProducto, dbo.TGRUPO.tResumido AS Grupo, dbo.TSUBGRUPO.tResumido AS SubGrupo, dbo.TPRODUCTO.tDetallado, dbo.DPEDIDO.tAutorizaOferta AS Usuario, SUM(dbo.DPEDIDO.nDescuento*dbo.dpedido.ncantidad)  AS descuento, SUM(dbo.DPEDIDO.nPrecioVenta*dbo.dpedido.ncantidad) AS venta, SUM(dbo.DPEDIDO.nPrecioOficial*dbo.dpedido.ncantidad)  AS oficial,sum(dbo.dpedido.ncantidad) as nCantidad '+  
	--	  ' FROM   dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN dbo.TOFERTA ON dbo.DPEDIDO.tOferta = dbo.TOFERTA.tOferta   INNER JOIN dbo.TGRUPO ON dbo.TPRODUCTO.tGrupo = dbo.TGRUPO.tCodigoGrupo INNER JOIN dbo.TSUBGRUPO ON dbo.TPRODUCTO.tSubGrupo = dbo.TSUBGRUPO.tCodigoSubgrupo  ' + 
	--	  ' WHERE     (dbo.DPEDIDO.tOferta IS NOT NULL) AND (dbo.TOFERTA.tNombre IS NOT NULL)  and DPEDIDO.TESTADOITEM='+@COMILLA+'N'+@COMILLA +' AND DPEDIDO.tfacturado='+@comilla+'P'+@comilla +  @scriterio + 
    --    ' GROUP BY dbo.TPRODUCTO.tDetallado, dbo.TPRODUCTO.tCodigoProducto, dbo.TOFERTA.tOferta, dbo.TOFERTA.tNombre,dbo.TOFERTA.nmonto,dbo.TOFERTA.nprecio,dbo.TOFERTA.nratio, dbo.DPEDIDO.tAutorizaOferta,  dbo.TGRUPO.tResumido, dbo.TSUBGRUPO.tResumido ' +
	--	  ' ORDER BY dbo.TOFERTA.tNombre+ '+@COMILLA+ ' ' +@COMILLA+' + (case when toferta.nratio>0 then LTRIM(toferta.NRATIO) + '+@COMILLA+ '%' +@COMILLA+' ELSE CASE WHEN toferta.NMONTO<>0 THEN + '+@COMILLA+ 'MONTO: ' +@COMILLA+'+LTRIM(toferta.NMONTO) ELSE CASE WHEN toferta.NPRECIO<>0 THEN + '+@COMILLA+ 'PRECIO: ' +@COMILLA+'+ LTRIM(toferta.NPRECIO) ELSE '+@COMILLA+ '' +@COMILLA+' END END END ), dbo.TPRODUCTO.tCodigoProducto '
	-- end
	set @sql= ' INSERT INTO #DBTRANS SELECT  dbo.TOFERTA.tOferta, dbo.TOFERTA.tNombre + '+@COMILLA+ ' ' +@COMILLA+'+ (case when toferta.nratio>0 then LTRIM(toferta.NRATIO) + '+@COMILLA+ '%' +@COMILLA+' ELSE CASE WHEN toferta.NMONTO<>0 THEN + '+@COMILLA+ 'MONTO: ' +@COMILLA+'+LTRIM(toferta.NMONTO) ELSE CASE WHEN toferta.NPRECIO<>0 THEN + '+@COMILLA+ 'PRECIO: ' +@COMILLA+'+ LTRIM(toferta.NPRECIO) ELSE '+@COMILLA+ '' +@COMILLA+' END END END ), dbo.TPRODUCTO.tCodigoProducto, dbo.TGRUPO.tResumido AS Grupo, dbo.TSUBGRUPO.tResumido AS SubGrupo, dbo.TPRODUCTO.tDetallado, dbo.DPEDIDO.tAutorizaOferta AS Usuario, dbo.DPEDIDO.nDescuento*dbo.dpedido.ncantidad  AS descuento, dbo.DPEDIDO.nPrecioVenta*dbo.dpedido.ncantidad AS venta, dbo.DPEDIDO.nPrecioOficial*dbo.dpedido.ncantidad  AS oficial,dbo.dpedido.ncantidad as nCantidad, dbo.MPEDIDO.tCodigoPedido ' +  
		  ' FROM   dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN dbo.TOFERTA ON dbo.DPEDIDO.tOferta = dbo.TOFERTA.tOferta   INNER JOIN dbo.TGRUPO ON dbo.TPRODUCTO.tGrupo = dbo.TGRUPO.tCodigoGrupo INNER JOIN dbo.TSUBGRUPO ON dbo.TPRODUCTO.tSubGrupo = dbo.TSUBGRUPO.tCodigoSubgrupo  ' + 
		  ' WHERE     (dbo.DPEDIDO.tOferta IS NOT NULL) AND (dbo.TOFERTA.tNombre IS NOT NULL)  and DPEDIDO.TESTADOITEM='+@COMILLA+'N'+@COMILLA +' AND DPEDIDO.tfacturado='+@comilla+'P'+@comilla +  @scriterio + 
          ' GROUP BY dbo.DPEDIDO.titem, dbo.TPRODUCTO.tDetallado, dbo.TPRODUCTO.tCodigoProducto, dbo.TOFERTA.tOferta, dbo.TOFERTA.tNombre,dbo.TOFERTA.nmonto,dbo.TOFERTA.nprecio,dbo.TOFERTA.nratio, dbo.DPEDIDO.tAutorizaOferta,  dbo.TGRUPO.tResumido, dbo.TSUBGRUPO.tResumido, dbo.DPEDIDO.nDescuento,dbo.DPEDIDO.ncantidad, dbo.DPEDIDO.nPrecioVenta,  dbo.DPEDIDO.nPrecioOficial, dbo.MPEDIDO.tCodigoPedido ' 
		  --' ORDER BY dbo.TOFERTA.tNombre+ '+@COMILLA+ ' ' +@COMILLA+' + (case when toferta.nratio>0 then LTRIM(toferta.NRATIO) + '+@COMILLA+ '%' +@COMILLA+' ELSE CASE WHEN toferta.NMONTO<>0 THEN + '+@COMILLA+ 'MONTO: ' +@COMILLA+'+LTRIM(toferta.NMONTO) ELSE CASE WHEN toferta.NPRECIO<>0 THEN + '+@COMILLA+ 'PRECIO: ' +@COMILLA+'+ LTRIM(toferta.NPRECIO) ELSE '+@COMILLA+ '' +@COMILLA+' END END END ), dbo.TPRODUCTO.tCodigoProducto '
	EXECUTE  sp_executesql @sql
	
	set @sql= ' SELECT DISTINCT tOferta,tNombre,tCodigoProducto,Grupo,SubGrupo , tDetallado ,Usuario, SUM(decuento) AS descuento, SUM(venta) AS venta, SUM(oficial) AS oficial , SUM(nCantidad) AS nCantidad  FROM #DBTRANS ' +
      ' GROUP BY tOferta,tNombre,tCodigoProducto,Grupo,SubGrupo , tDetallado ,Usuario '
	      	      
	end


if @flagTipoReporte='3'
	begin
	--set @sql=' SELECT dbo.TPRODUCTO.tCodigoProducto AS codigo, dbo.TPRODUCTO.tDetallado AS Producto,dbo.toferta.toferta , dbo.TOFERTA.tNombre + '+@COMILLA+ ' ' +@COMILLA+'+ (case when toferta.nratio>0 then LTRIM(toferta.NRATIO) + '+@COMILLA+ '%' +@COMILLA+' ELSE CASE WHEN toferta.NMONTO<>0 THEN + '+@COMILLA+ 'MONTO: ' +@COMILLA+'+LTRIM(toferta.NMONTO) ELSE CASE WHEN toferta.NPRECIO<>0 THEN + '+@COMILLA+ 'PRECIO: ' +@COMILLA+'+ LTRIM(toferta.NPRECIO) ELSE '+@COMILLA+ '' +@COMILLA+' END END END ) AS Oferta,   dbo.DPEDIDO.tCodigoPedido AS Pedido, dbo.DPEDIDO.nCantidad AS Cantidad, dbo.DPEDIDO.nDescuento*dbo.DPEDIDO.nCantidad  AS Descuento, dbo.DPEDIDO.nPrecioVenta*dbo.DPEDIDO.nCantidad AS Venta, dbo.DPEDIDO.nPrecioOficial*dbo.DPEDIDO.nCantidad AS Oficial, dbo.DPEDIDO.tAutorizaOferta as usuario, dbo.DPEDIDO.fregistro ' + 
	--	 ' FROM         dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto LEFT OUTER JOIN dbo.TOFERTA ON dbo.DPEDIDO.tOferta = dbo.TOFERTA.tOferta ' + 
	--	 ' WHERE     (dbo.DPEDIDO.tOferta IS NOT NULL) AND (dbo.TOFERTA.tNombre IS NOT NULL) and dpedido.testadoitem='+@comilla+'N'+@COMILLA+ ' AND DPEDIDO.tfacturado='+@comilla+'P'+@comilla + @scriterio + 
	--	 ' ORDER BY dbo.TPRODUCTO.tDetallado,dbo.TOFERTA.tNombre+ '+@COMILLA+ ' ' +@COMILLA+' + (case when toferta.nratio>0 then LTRIM(toferta.NRATIO) + '+@COMILLA+ '%' +@COMILLA+' ELSE CASE WHEN toferta.NMONTO<>0 THEN + '+@COMILLA+ 'MONTO: ' +@COMILLA+'+LTRIM(toferta.NMONTO) ELSE CASE WHEN toferta.NPRECIO<>0 THEN + '+@COMILLA+ 'PRECIO: ' +@COMILLA+'+ LTRIM(toferta.NPRECIO) ELSE '+@COMILLA+ '' +@COMILLA+' END END END ), dbo.DPEDIDO.fregistro ' 
	--end
	set @sql=' SELECT dbo.TPRODUCTO.tCodigoProducto AS codigo, dbo.TPRODUCTO.tDetallado AS Producto,dbo.toferta.toferta , dbo.TOFERTA.tNombre + '+@COMILLA+ ' ' +@COMILLA+'+ (case when toferta.nratio>0 then LTRIM(toferta.NRATIO) + '+@COMILLA+ '%' +@COMILLA+' ELSE CASE WHEN toferta.NMONTO<>0 THEN + '+@COMILLA+ 'MONTO: ' +@COMILLA+'+LTRIM(toferta.NMONTO) ELSE CASE WHEN toferta.NPRECIO<>0 THEN + '+@COMILLA+ 'PRECIO: ' +@COMILLA+'+ LTRIM(toferta.NPRECIO) ELSE '+@COMILLA+ '' +@COMILLA+' END END END ) AS Oferta,   dbo.DPEDIDO.tCodigoPedido AS Pedido, dbo.DPEDIDO.nCantidad AS Cantidad, dbo.DPEDIDO.nDescuento*dbo.DPEDIDO.nCantidad  AS Descuento, dbo.DPEDIDO.nPrecioVenta*dbo.DPEDIDO.nCantidad AS Venta, dbo.DPEDIDO.nPrecioOficial*dbo.DPEDIDO.nCantidad AS Oficial, dbo.DPEDIDO.tAutorizaOferta as usuario, dbo.DPEDIDO.fregistro ' + 
		 ' FROM         dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto LEFT OUTER JOIN dbo.TOFERTA ON dbo.DPEDIDO.tOferta = dbo.TOFERTA.tOferta ' + 
		 ' WHERE     (dbo.DPEDIDO.tOferta IS NOT NULL) AND (dbo.TOFERTA.tNombre IS NOT NULL) and dpedido.testadoitem='+@comilla+'N'+@COMILLA+ ' AND DPEDIDO.tfacturado='+@comilla+'P'+@comilla + @scriterio + 
		 ' GROUP BY dbo.TPRODUCTO.tCodigoProducto,dbo.TPRODUCTO.tDetallado,dbo.TOFERTA.tOferta, dbo.TOFERTA.tNombre,dbo.TOFERTA.nmonto,dbo.TOFERTA.nprecio,dbo.TOFERTA.nratio, dbo.DPEDIDO.tAutorizaOferta, dbo.DPEDIDO.nDescuento,dbo.DPEDIDO.ncantidad, dbo.DPEDIDO.nPrecioVenta,  dbo.DPEDIDO.nPrecioOficial,dbo.DPEDIDO.fregistro,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem ' +
		 ' ORDER BY dbo.TPRODUCTO.tDetallado,dbo.TOFERTA.tNombre+ '+@COMILLA+ ' ' +@COMILLA+' + (case when toferta.nratio>0 then LTRIM(toferta.NRATIO) + '+@COMILLA+ '%' +@COMILLA+' ELSE CASE WHEN toferta.NMONTO<>0 THEN + '+@COMILLA+ 'MONTO: ' +@COMILLA+'+LTRIM(toferta.NMONTO) ELSE CASE WHEN toferta.NPRECIO<>0 THEN + '+@COMILLA+ 'PRECIO: ' +@COMILLA+'+ LTRIM(toferta.NPRECIO) ELSE '+@COMILLA+ '' +@COMILLA+' END END END ), dbo.DPEDIDO.fregistro, dbo.DPEDIDO.tItem ' 
	end

	
EXECUTE  sp_executesql @sql
--print @sql
END

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE [dbo].[spRep_AnaliticoMotorizado]
@flagProduccion as bit,
@flagVenta as bit,
@flagCortesia as bit,
@flagCuentaCte as bit,
@flagPedidosFacturados as bit,
@flagCombinacion as bit,
@flagCargo as bit,
@flagOpcion as bit, -- 1=detallado 0=resumido
@flagTurnoOFecha as bit,-- si selecciona un turno o rango d fecha
@tTipoProducto as nvarchar(30),
@tMotorizado as nvarchar(30),
@tGrupo as nvarchar(30),
@tSubGrupo as nvarchar(30),
@tcodigoProducto as nvarchar(30),
@turno as nvarchar(30),
@sPrecio as nvarchar(200),
@finicio as smalldatetime,
@ffinal as smalldatetime

AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(2000)
declare @sCriterioP nvarchar(2000)
declare @xCriterio nvarchar(2000)

DECLARE @tCanalVenta nvarchar(10)

set @comilla=''''
	
	CREATE TABLE #DBTRANS (Motorizado nVarChar(80) collate Modern_Spanish_CI_AS, TipoProducto nVarChar(80) collate Modern_Spanish_CI_AS, Grupo nVarChar(80) collate Modern_Spanish_CI_AS, SubGrupo nVarChar(80) collate Modern_Spanish_CI_AS, Producto nVarChar(150) collate Modern_Spanish_CI_AS, Cantidad Float, Venta Float, nPedidos Float,Comision float)

if @flagTurnoOFecha=0 
	begin
	set @sCriterio =' MPEDIDO.tTurno like ' + @comilla+@turno+'%'+@comilla
	set @xCriterio =' MDOCUMENTO.tTurno like '+ @comilla+@turno+'%'+@comilla
	set @sCriterioP =' MPEDIDO.tTurno like ' + @comilla+@turno+'%'+@comilla
	end
else
	begin
	set @scriterio =' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @xCriterio =' MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + '  and MDOCUMENTO.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @scriterioP =' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	end

	if @ttipoProducto<>''
		SET @sCriterio=@sCriterio + ' and vProducto.TipoProducto like  ' + @comilla+@tTipoProducto+'%'+@comilla
	if @tMotorizado<>''
		SET @sCriterio=@sCriterio + ' and MPEDIDO.tMotorizado like  ' + @comilla+@tMotorizado+'%'+@comilla
	if @tgrupo <> ''
		SET @sCriterio=@sCriterio + ' and vProducto.Grupo like ' + @comilla+@tGrupo+'%'+@comilla
	if @tsubgrupo <> ''
		SET @sCriterio=@sCriterio + ' and subGrupo like ' + @comilla+@tSubGrupo+'%'+@comilla
	if @tcodigoProducto <> ''
		SET @sCriterio=@sCriterio + ' and DPEDIDO.tCodigoProducto like ' + @comilla+@tcodigoProducto+'%'+@comilla

	--print @scriterio
	--print @sfiltro
	
	SELECT @tCanalVenta = tCodigoCanalVenta FROM TCANALVENTA WHERE lCanalDelivery = 1


if @flagProduccion=1 --produccion
begin
	--Produccion
       set @sql= ' Insert into #DBTRANS (Motorizado, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, nPedidos,Comision ) ' +
                 ' SELECT dbo.vMotorizado.Descripcion AS Motorizado, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, A.Pedidos, ' + @sPrecio + ' * (isnull(dbo.Vmotorizado.nvalor,0)/100) as Comision  ' +
                 ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vMotorizado ON dbo.MPEDIDO.tMotorizado = dbo.vMotorizado.Codigo RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' +
                 ' LEFT OUTER JOIN (select max(tMotorizado) as tMotorizado, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and MPEDIDO.tTipoPedido=' + @tCanalVenta + ' and ' + @sCriteriop + ' group by tMotorizado) AS A ON A.tMotorizado=dbo.mPedido.tMotorizado ' +
	             ' where dbo.MPEDIDO.tTipoPedido=' + @tCanalVenta + ' and MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+ 'N'+@comilla+' and ' + @scriterio
    
END 
	
if @flagVenta=1 --venta
begin
   --Ventas
       set @sql= ' Insert into #DBTRANS (Motorizado, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, nPedidos,comision ) ' +
                 ' SELECT dbo.vMotorizado.Descripcion AS Motorizado, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, A.Pedidos,' + @sPrecio + ' * (isnull(dbo.Vmotorizado.nvalor,0)/100) as Comision ' +
                 ' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vMotorizado ON dbo.MPEDIDO.tMotorizado = dbo.vMotorizado.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN ' +
                 ' (SELECT MAX(tMotorizado) AS tMotorizado, isnull(COUNT(dbo.mPedido.tCodigoPedido), 0) AS Pedidos From MPEDIDO WHERE MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND MPEDIDO.tTipoPedido = ' + @tCanalVenta + ' and ' + @sCriteriop + ' GROUP BY tMotorizado) A ON A.tMotorizado = dbo.MPEDIDO.tMotorizado ' +
                 ' WHERE dbo.MPEDIDO.tTipoPedido=' + @tCanalVenta + ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sCriterio + ' and ' + @xCriterio
    
end

if @flagCortesia=1 --cortesia
begin
  --  Cortesias
       set @sql= ' Insert into #DBTRANS (Motorizado, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, nPedidos,comision ) ' +
                 ' SELECT dbo.vMotorizado.Descripcion AS Motorizado, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, A.Pedidos,' + @sPrecio + ' * (isnull(dbo.Vmotorizado.nvalor,0)/100) as Comision ' +
                 ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vMotorizado ON dbo.MPEDIDO.tMotorizado = dbo.vMotorizado.Codigo RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' +
                 ' LEFT OUTER JOIN (select max(tMotorizado) as tMotorizado, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and MPEDIDO.tTipoPedido=' + @tCanalVenta + ' and ' +@sCriteriop + ' group by tMotorizado) AS A ON A.tMotorizado=dbo.mPedido.tMotorizado ' +
                 ' WHERE dbo.MPEDIDO.tTipoPedido=' + @tCanalVenta + ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' and ' + @sCriterio
    
end 


if @flagCuentaCte=1 --cuenta corriente
begin
   --Cuentas Corrientes
       set @sql= ' Insert into #DBTRANS (Motorizado, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, nPedidos,comision ) ' +
                 ' SELECT dbo.vMotorizado.Descripcion AS Motorizado, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, A.Pedidos,' + @sPrecio + ' * (isnull(dbo.Vmotorizado.nvalor,0)/100) as Comision ' +
                 ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vMotorizado ON dbo.MPEDIDO.tMotorizado = dbo.vMotorizado.Codigo RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' +
                 ' LEFT OUTER JOIN (select max(tMotorizado) as tMotorizado, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and MPEDIDO.tTipoPedido=' + @tCanalVenta + ' and ' + @sCriteriop +  ' group by tMotorizado) AS A ON A.tMotorizado=dbo.mPedido.tMotorizado ' +
              	 ' where dbo.MPEDIDO.tTipoPedido=' + @tCanalVenta + ' and MPEDIDO.tEstadoPedido = '+@comilla+ '04'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+ 'N'+@comilla+' and ' + @sCriterio
       
END

if @flagCombinacion=1 --combinacion
begin
 
	SET @SQL= ' Insert into #DBTRANS (Motorizado, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, nPedidos,comision ) ' +
                 ' SELECT dbo.vMotorizado.Descripcion AS Motorizado, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, ' + @sPrecio + ' AS Venta, A.Pedidos,' + @sPrecio + ' * (isnull(dbo.Vmotorizado.nvalor,0)/100) as Comision ' +
                 ' FROM         dbo.vProducto RIGHT OUTER JOIN  dbo.vMotorizado RIGHT OUTER JOIN dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem ON Dbo.vMotorizado.Codigo = dbo.MPEDIDO.tMotorizado LEFT OUTER JOIN  ' + 
		' (select max(tMotorizado) as tMotorizado, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and MPEDIDO.tTipoPedido=' + @tCanalVenta + ' and ' + @sCriteriop + ' group by tMotorizado)  A ON dbo.MPEDIDO.tMotorizado = A.tMotorizado ON dbo.vProducto.Codigo = dbo.CPEDIDO.tProductocombo	 ' +
                 ' where dbo.MPEDIDO.tTipoPedido=' + @tCanalVenta + ' and MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and ' + @sCriterio

end

if @flagCargo=1 --cargo
begin
	   
   --Cargos
       set @sql= ' Insert into #DBTRANS (Motorizado, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, nPedidos,comision ) ' +
                 ' SELECT dbo.vMotorizado.Descripcion AS Motorizado, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, A.Pedidos,' + @sPrecio + ' * (isnull(dbo.Vmotorizado.nvalor,0)/100) as Comision ' +
                 ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vMotorizado ON dbo.MPEDIDO.tMotorizado = dbo.vMotorizado.Codigo RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' +
                 ' LEFT OUTER JOIN (select max(tMotorizado) as tMotorizado, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and MPEDIDO.tTipoPedido=' + @tCanalVenta + ' and  ' +@sCriteriop + ' group by tMotorizado) AS A ON A.tMotorizado=dbo.mPedido.tMotorizado ' +
                 ' where dbo.MPEDIDO.tTipoPedido=' + @tCanalVenta + ' and MPEDIDO.tEstadoPedido = '+@comilla+ '05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+ 'N'+@comilla+' and ' +@sCriterio
   
end	
	
if @flagPedidosFacturados=1 --pedidos facturados
begin
  --Pedidos facturados
       set @sql= ' Insert into #DBTRANS (Motorizado, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, nPedidos,comision ) ' +
                 ' SELECT dbo.vMotorizado.Descripcion AS Motorizado, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, A.Pedidos,' + @sPrecio + ' * (isnull(dbo.Vmotorizado.nvalor,0)/100) as Comision ' +
                 ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vMotorizado ON dbo.MPEDIDO.tMotorizado = dbo.vMotorizado.Codigo RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' +
                 ' LEFT OUTER JOIN (select max(tMotorizado) as tMotorizado, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and MPEDIDO.tTipoPedido=' + @tCanalVenta + ' and ' + @sCriteriop + ' group by tMotorizado) AS A ON A.tMotorizado=dbo.mPedido.tMotorizado ' +
                 ' WHERE dbo.MPEDIDO.tTipoPedido=' + @tCanalVenta + ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' +@sCriterio
   
end

 --print @sql
EXEC sp_executesql @sql

SELECT Motorizado, TipoProducto, Grupo, SubGrupo, Producto, SUM(Cantidad) AS Cantidad, round(SUM(Venta),2) AS Ventas, max(nPedidos) as nPedidos , round(sum(comision),2) as Comision
From #DBTRANS Group By Motorizado, Grupo, SubGrupo, Producto, TipoProducto


END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE [dbo].[spRep_AnaliticoMozo]
@flagProduccion as bit,
@flagVenta as bit,
@flagCortesia as bit,
@flagCuentaCte as bit,
@flagPedidosFacturados as bit,
@flagCombinacion as bit,
@flagCargo as bit,
@flagOpcion as bit, -- 1=detallado 0=resumido
@flagTurnoOFecha as bit,-- si selecciona un turno o rango d fecha
@tTipoProducto as nvarchar(30),
@tTipoPedido as nvarchar(30),
@tMozo as nvarchar(30),
@tGrupo as nvarchar(30),
@tSubGrupo as nvarchar(30),
@tcodigoProducto as nvarchar(30),
@turno as nvarchar(30),
@comensales as nvarchar(200),
@finicio as smalldatetime,
@ffinal as smalldatetime,
@sPrecio as nvarchar(150)
AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(2000)
declare @sCriterioM nvarchar(2000)
declare @xCriterio nvarchar(2000)

set @comilla=''''
	
	CREATE TABLE #DBTRANS (Mozo nVarChar(80) collate Modern_Spanish_CI_AS, TipoProducto nVarChar(80) collate Modern_Spanish_CI_AS, Grupo nVarChar(80) collate Modern_Spanish_CI_AS, SubGrupo nVarChar(80) collate Modern_Spanish_CI_AS, Producto nVarChar(150) collate Modern_Spanish_CI_AS, Cantidad Float, Venta Float, nComenzales Float, nPedidos Float)

if @flagTurnoOFecha=0 
	begin
	set @sCriterio =' MPEDIDO.tTurno like ' + @comilla+@turno+'%'+@comilla
	set @xCriterio =' MDOCUMENTO.tTurno like '+ @comilla+@turno+'%'+@comilla
	set @sCriterioM=' MPEDIDO.tTurno like ' + @comilla+@turno+'%'+@comilla
	end
else
	begin
	set @scriterio =' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @xCriterio =' MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + '  and MDOCUMENTO.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @scriterioM=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	end

	if @ttipoProducto<>''
		SET @sCriterio=@sCriterio + ' and vProducto.TipoProducto like  ' + @comilla+@tTipoProducto+'%'+@comilla
	if @tMozo<>''
		SET @sCriterio=@sCriterio + ' and dPEDIDO.tMozod like  ' + @comilla+@tMozo+'%'+@comilla
	if @ttipoPedido<>''
		SET @sCriterio=@sCriterio + ' and MPEDIDO.tTipoPedido like  ' + @comilla+@tTipoPedido+'%'+@comilla
	if @tgrupo <> ''
		SET @sCriterio=@sCriterio + ' and vProducto.Grupo like ' + @comilla+@tGrupo+'%'+@comilla
	if @tsubgrupo <> ''
		SET @sCriterio=@sCriterio + ' and subGrupo like ' + @comilla+@tSubGrupo+'%'+@comilla
	if @tcodigoProducto <> ''
		SET @sCriterio=@sCriterio + ' and DPEDIDO.tCodigoProducto like ' + @comilla+@tcodigoProducto+'%'+@comilla

	 --print @scriterio
	--print @sfiltro


if @flagProduccion=1 --produccion
begin
	--Produccion
	set @sql =  ' Insert into #DBTRANS (Mozo, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, ncomenzales, nPedidos )  ' +
        	    ' SELECT dbo.vMozo.Descripcion AS MOZO, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, ' + @comensales + ' , A.Pedidos ' + 
	            ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo  RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido  LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo  ' + 
	            ' LEFT OUTER JOIN (select max(tMozo) as tMozo, isnull(sum(dbo.mPedido.nAdulto),0) as Adultos, isnull(sum(dbo.mPedido.nNino),0) as Ninos, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and ' +  @sCriterioM + ' group by tMozo) AS a ON A.tMozo=dbo.mPedido.tMozo  ' +
	            ' where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+ 'N'+@comilla+' and ' + @sCriterio
END 
	
if @flagVenta=1 --venta
begin
   --Ventas
	set @sql =  ' Insert into #DBTRANS (Mozo, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, ncomenzales, nPedidos )  ' +
        	    ' SELECT dbo.vMozo.Descripcion AS MOZO, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, isnull(A.Adultos,0) as ncomenzales , A.Pedidos  ' +
	            ' FROM dbo.MDOCUMENTO INNER JOIN   dbo.DPEDIDO ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN  dbo.MPEDIDO LEFT OUTER JOIN  dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo right OUTER JOIN  ' +
	            ' ( SELECT MAX(tMozo) AS tMozo, ISNULL(SUM(nAdulto), 0) AS Adultos, ISNULL(SUM(nNino), 0) AS Ninos, ISNULL(COUNT(tCodigoPedido), 0) AS Pedidos From dbo.MPEDIDO WHERE tCodigoPedido IN (SELECT dbo.MPEDIDO.tCodigoPedido FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento  ' +
	            ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sCriterioM + ' and '+ @xCriterio + ' GROUP BY dbo.MPEDIDO.tCodigoPedido ) Group by tMozo) AS A ON A.tMozo=dbo.mPedido.tMozo  ' +
	            ' where dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sCriterio + ' and ' + @xCriterio
 
end

if @flagCortesia=1 --cortesia
begin
  --Cortesias
	set @sql =  ' Insert into #DBTRANS (Mozo, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, ncomenzales, nPedidos )  ' +
        	    ' SELECT dbo.vMozo.Descripcion AS MOZO, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, isnull(A.Adultos,0) as ncomenzales , A.Pedidos  ' +
	            ' FROM dbo.MDOCUMENTO INNER JOIN   dbo.DPEDIDO ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN  dbo.MPEDIDO LEFT OUTER JOIN  dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN  ' +
	            ' ( SELECT MAX(tMozo) AS tMozo, ISNULL(SUM(nAdulto), 0) AS Adultos, ISNULL(SUM(nNino), 0) AS Ninos, ISNULL(COUNT(tCodigoPedido), 0) AS Pedidos From dbo.MPEDIDO WHERE tCodigoPedido IN (SELECT dbo.MPEDIDO.tCodigoPedido FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento  ' +
	            ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' and ' + @sCriterioM + ' GROUP BY dbo.MPEDIDO.tCodigoPedido ) Group by tMozo) AS A ON A.tMozo=dbo.mPedido.tMozo  ' +
        	    ' where dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' and ' + @sCriterio
     
end 


if @flagCuentaCte=1 --cuenta corriente
begin
   --Cuentas Corrientes
	set @sql =  ' Insert into #DBTRANS (Mozo, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, ncomenzales, nPedidos )  ' +
        	    ' SELECT dbo.vMozo.Descripcion AS MOZO, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta,'+@comensales + ', A.Pedidos  ' +
	            ' FROM dbo.MPEDIDO  LEFT OUTER JOIN dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo  RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido   LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo  ' +
	            ' LEFT OUTER JOIN (select max(tMozo) as tMozo, isnull(sum(dbo.mPedido.nAdulto),0) as Adultos, isnull(sum(dbo.mPedido.nNino),0) as Ninos, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido = '+@comilla+ '04'+@comilla+' and ' + @sCriterioM + ' group by tMozo) AS a ON A.tMozo=dbo.mPedido.tMozo  ' +
	            ' where MPEDIDO.tEstadoPedido = '+@comilla+ '04'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+ 'N'+@comilla+' and ' +  @sCriterio
 
END

if @flagCombinacion=1 --combinacion
begin
   --Combinacion
	set @sql =  ' Insert into #DBTRANS (Mozo, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, ncomenzales, nPedidos )  ' +
        	    ' SELECT dbo.vMozo.Descripcion AS Mozo, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, ' + @sPrecio + ' AS Venta, '+@comensales + ', A.Pedidos  ' +
	            ' FROM dbo.MPEDIDO  LEFT OUTER JOIN dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo  RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido  LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProducto = dbo.vProducto.Codigo  ' +
	            ' LEFT OUTER JOIN (select max(tMozo) as tMozo, isnull(sum(dbo.mPedido.nAdulto),0) as Adultos, isnull(sum(dbo.mPedido.nNino),0) as Ninos, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and ' + @sCriterioM + ' group by tMozo) AS a ON A.tMozo=dbo.mPedido.tMozo  ' +
	            ' RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido   where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and ' + @sCriterio
end

if @flagCargo=1 --cargo
begin
	   
   --Cargos
	set @sql =  ' Insert into #DBTRANS (Mozo, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, ncomenzales, nPedidos )  ' +
    	       	    ' SELECT dbo.vMozo.Descripcion AS MOZO, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, '+@comensales+ ' , A.Pedidos  ' +
      	   	    ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo  RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido  LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo  ' +
     	       	    ' LEFT OUTER JOIN (select max(tMozo) as tMozo, isnull(sum(dbo.mPedido.nAdulto),0) as Adultos, isnull(sum(dbo.mPedido.nNino),0) as Ninos, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido = '+@comilla+ '05'+@comilla+' and ' + @sCriterioM +  ' group by tMozo) AS a ON A.tMozo=dbo.mPedido.tMozo  ' +
     	            ' where MPEDIDO.tEstadoPedido ='+@comilla+ '05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+ 'N'+@comilla+' and ' + @sCriterio

end	
	
if @flagPedidosFacturados=1 --pedidos facturados
begin
       
   --Pedidos Facturados
	set @sql =  ' Insert into #DBTRANS (Mozo, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, ncomenzales, nPedidos )  ' +
           		' SELECT dbo.vMozo.Descripcion AS MOZO, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, isnull(A.Adultos,0) as ncomenzales , A.Pedidos  ' +
            		' FROM dbo.MDOCUMENTO INNER JOIN   dbo.DPEDIDO ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN  dbo.MPEDIDO LEFT OUTER JOIN  dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN  ' +
	                ' ( SELECT MAX(tMozo) AS tMozo, ISNULL(SUM(nAdulto), 0) AS Adultos, ISNULL(SUM(nNino), 0) AS Ninos, ISNULL(COUNT(tCodigoPedido), 0) AS Pedidos From dbo.MPEDIDO WHERE tCodigoPedido IN (SELECT dbo.MPEDIDO.tCodigoPedido FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento  ' +
	                ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sCriterioM + ' GROUP BY dbo.MPEDIDO.tCodigoPedido ) Group by tMozo) AS A ON A.tMozo=dbo.mPedido.tMozo  ' +
                        ' where dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sCriterio

end

 print @sql
EXEC sp_executesql @sql

  SELECT Mozo, TipoProducto, Grupo, SubGrupo, Producto, SUM(Cantidad) AS Cantidad, SUM(Venta) AS Ventas, max(nComenzales) as nComenzales, max(nPedidos) as nPedidos
  From #dbtrans Group By Mozo, Grupo, SubGrupo, Producto, TipoProducto

/**/


END

GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE [dbo].[spRep_Cancelacion] 
@flagTipo as bit,
@tCliente as nvarchar(20),
@tTipoDoc as nvarchar(20),
@sOrden as nvarchar(140),
@finicio as smalldatetime,
@ffinal as smalldatetime,
@diaContable as bit

AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(1000)
declare @xCriterio nvarchar(1000)
set @sql=''
set @sCriterio=''
set @xCriterio=''
set @comilla=''''

	CREATE TABLE #DBTRANS (tDocumento varchar(20) collate Modern_Spanish_CI_AS, fRegistro datetime, nEfectivoSoles float, nVenta float, nEfectivoMN float, nEfectivoME float, nTarjeta float, nPropina float, nCheque float, nOtro float, nPunto float, nCortesia float, nCobrar float, tEstadoDocumento Varchar(2) collate Modern_Spanish_CI_AS)
if @sOrden='Correlativo'
	begin
	set @sOrden= ' #dbtrans.tdocumento '
	end
else if @sOrden='Montos'
	begin
	set @sOrden= ' #dbtrans.nventa'
	end 
else if @sOrden='Fechas'
	begin
	set @sOrden= ' year(#DBTRANS.fregistro), month(#DBTRANS.fregistro), day(#DBTRANS.fregistro), #DBTRANS.tdocumento '
	end
else
	begin
	set @sOrden= ' #dbtrans.tdocumento '
	end	

if @tcliente <>''
	begin
	set @sCriterio=' and tcodigocliente = '+@comilla+@tcliente+@comilla
	set @xCriterio=' and tcodigocliente = '+@comilla+@tcliente+@comilla
	end
if @tTipoDoc<>''
	begin
	set @sCriterio=@scriterio+ ' and ttipodocumento='+@comilla+@ttipodoc+@comilla
	set @xCriterio=@xcriterio+ ' and codigo='+@comilla+@ttipodoc+@comilla

	end

If @DiaContable=0
BEGIN

  --Inserta Documentos
  set @sql = ' insert into #DBTRANS (tDocumento, fRegistro, nEfectivoSoles, nVenta, nEfectivoMN, nEfectivoME, nTarjeta, nPropina, nCheque, nOtro, nPunto, nCortesia, nCobrar, tEstadoDocumento)  ' +
             ' SELECT MDOCUMENTO.tDocumento, fRegistro, (T1.nEfectivoME * T1.nTipoCambio) as nEfectivoSoles, nVenta, T1.nEfectivoMN, T1.nEfectivoME, T1.nTarjeta, T1.nPropina, T1.nCheque, T1.nOtro, T1.nPunto, 0, 0, tEstadoDocumento  ' +
	     ' FROM dbo.MDOCUMENTO LEFT OUTER JOIN (select tDocumento, nTipoCambio, sum(case when tTipoPago='+@comilla+ '01'+@comilla+' and tMoneda='+@comilla+ '01'+@comilla+' then nMonto else 0 end) as nEfectivoMN, sum(case when tTipoPago='+@comilla+ '01'+@comilla+' and tMoneda='+@comilla+ '02'+@comilla+' then nMonto else 0 end) as nEfectivoME, '+
             ' sum(case when tTipoPago='+@comilla+ '02'+@comilla+' then nMonto else 0 end) as nTarjeta, sum(case when tTipoPago='+@comilla+ '02'+@comilla+' then nPropina else 0 end) as nPropina, sum(case when tTipoPago='+@comilla+ '03'+@comilla+' then nMonto else 0 end) as nCheque, '+
             ' sum(case when tTipoPago='+@comilla+ '04'+@comilla+' then nMonto else 0 end) as nOtro, sum(case when tTipoPago='+@comilla+ '05'+@comilla+' then nMonto else 0 end) as nPunto from dpagodocumento group by tDocumento, nTipoCambio) as T1 ON dbo.MDOCUMENTO.tDocumento = T1.tDocumento where tTipoDocumento <> '+@comilla+ '00'+@comilla+' and (tEstadoDocumento='+@comilla+ '02'+@comilla+' or tEstadoDocumento='+@comilla+ '03'+@comilla+')and ' + 
	     ' fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and fRegistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + @sCriterio
	
  EXEC sp_executesql @sql

   
	set @sql= ' update #DBTRANS set nCortesia = MDOCUMENTO.nVenta FROM MDOCUMENTO where MDOCUMENTO.tDocumento = #DBTRANS.tDocumento and MDOCUMENTO.tEstadoDocumento='+@comilla+ '02'+@comilla+' and tCortesia<>'+@comilla+ ''+@comilla+' and  MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + @sCriterio
	 EXEC sp_executesql @sql
	set @sql= ' update #DBTRANS set nCobrar = MDOCUMENTO.nVenta FROM MDOCUMENTO where MDOCUMENTO.tDocumento = #DBTRANS.tDocumento and MDOCUMENTO.tEstadoDocumento='+@comilla+ '03'+@comilla+' and  MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + @sCriterio
	 EXEC sp_executesql @sql
	set @sql= ' update #DBTRANS set nEfectivoMN = 0 where isnull(nEfectivoMN,0)=0'
	 EXEC sp_executesql @sql
	set @sql= ' update #DBTRANS set nEfectivoME = 0 where isnull(nEfectivoME,0)=0'
	 EXEC sp_executesql @sql
	set @sql= ' update #DBTRANS set nTarjeta = 0 where isnull(nTarjeta,0)=0'
	 EXEC sp_executesql @sql
	set @sql= ' update #DBTRANS set nPropina = 0 where isnull(nPropina,0)=0'
	 EXEC sp_executesql @sql
	set @sql= ' update #DBTRANS set nCheque = 0 where isnull(nCheque,0)=0'
	 EXEC sp_executesql @sql
	set @sql= ' update #DBTRANS set nOtro = 0 where isnull(nOtro,0)=0'
	 EXEC sp_executesql @sql
	set @sql= ' update #DBTRANS set nPunto = 0 where isnull(nPunto,0)=0'
	 EXEC sp_executesql @sql
            
IF @flagTipo=1
	begin
	set @sql= ' SELECT tDocumento, fRegistro, nEfectivoSoles, nVenta, nEfectivoMN, nEfectivoME, nTarjeta, nPropina, nCheque, nOtro, nPunto, nCortesia, nCobrar, vEstadoDocumento.Descripcion as Estado ' +
          ' FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vEstadoDocumento ON dbo.#DBTRANS.tEstadoDocumento = dbo.vEstadoDocumento.Codigo ' +
          ' Order by '+  @sOrden   
	end
ELSE
	begin
	set @sql= 'select sum(nVenta) as Venta, sum(nEfectivoMN) as nEfectivoMN, sum(nEfectivoME) as nEfectivoME, sum(nCheque) as nCheque, sum(nPunto) As nPunto, sum(nEfectivoSoles) as nEfectivoSoles From #dbtrans '
	end


 EXEC sp_executesql @sql
end






-------------------------DIA CONTABLE
If @DiaContable=1
BEGIN

  --Inserta Documentos
  set @sql = ' insert into #DBTRANS (tDocumento, fRegistro, nEfectivoSoles, nVenta, nEfectivoMN, nEfectivoME, nTarjeta, nPropina, nCheque, nOtro, nPunto, nCortesia, nCobrar, tEstadoDocumento)  ' +
             ' SELECT MDOCUMENTO.tDocumento, fRegistro, (T1.nEfectivoME * T1.nTipoCambio) as nEfectivoSoles, nVenta, T1.nEfectivoMN, T1.nEfectivoME, T1.nTarjeta, T1.nPropina, T1.nCheque, T1.nOtro, T1.nPunto, 0, 0, tEstadoDocumento  ' +
	     ' FROM dbo.MDOCUMENTO LEFT OUTER JOIN (select tDocumento, nTipoCambio, sum(case when tTipoPago='+@comilla+ '01'+@comilla+' and tMoneda='+@comilla+ '01'+@comilla+' then nMonto else 0 end) as nEfectivoMN, sum(case when tTipoPago='+@comilla+ '01'+@comilla+' and tMoneda='+@comilla+ '02'+@comilla+' then nMonto else 0 end) as nEfectivoME, '+
             ' sum(case when tTipoPago='+@comilla+ '02'+@comilla+' then nMonto else 0 end) as nTarjeta, sum(case when tTipoPago='+@comilla+ '02'+@comilla+' then nPropina else 0 end) as nPropina, sum(case when tTipoPago='+@comilla+ '03'+@comilla+' then nMonto else 0 end) as nCheque, '+
             ' sum(case when tTipoPago='+@comilla+ '04'+@comilla+' then nMonto else 0 end) as nOtro, sum(case when tTipoPago='+@comilla+ '05'+@comilla+' then nMonto else 0 end) as nPunto from dpagodocumento group by tDocumento, nTipoCambio) as T1 ON dbo.MDOCUMENTO.tDocumento = T1.tDocumento where tTipoDocumento <> '+@comilla+ '00'+@comilla+' and (tEstadoDocumento='+@comilla+ '02'+@comilla+' or tEstadoDocumento='+@comilla+ '03'+@comilla+')and ' + 
  	     ' fDiaContable >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and fDiaContable <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + @sCriterio
	
  EXEC sp_executesql @sql

   
	set @sql= ' update #DBTRANS set nCortesia = MDOCUMENTO.nVenta FROM MDOCUMENTO where MDOCUMENTO.tDocumento = #DBTRANS.tDocumento and MDOCUMENTO.tEstadoDocumento='+@comilla+ '02'+@comilla+' and tCortesia<>'+@comilla+ ''+@comilla+' and  MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + @sCriterio
	 EXEC sp_executesql @sql
	set @sql= ' update #DBTRANS set nCobrar = MDOCUMENTO.nVenta FROM MDOCUMENTO where MDOCUMENTO.tDocumento = #DBTRANS.tDocumento and MDOCUMENTO.tEstadoDocumento='+@comilla+ '03'+@comilla+' and  MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + @sCriterio
	 EXEC sp_executesql @sql
	set @sql= ' update #DBTRANS set nEfectivoMN = 0 where isnull(nEfectivoMN,0)=0'
	 EXEC sp_executesql @sql
	set @sql= ' update #DBTRANS set nEfectivoME = 0 where isnull(nEfectivoME,0)=0'
	 EXEC sp_executesql @sql
	set @sql= ' update #DBTRANS set nTarjeta = 0 where isnull(nTarjeta,0)=0'
	 EXEC sp_executesql @sql
	set @sql= ' update #DBTRANS set nPropina = 0 where isnull(nPropina,0)=0'
	 EXEC sp_executesql @sql
	set @sql= ' update #DBTRANS set nCheque = 0 where isnull(nCheque,0)=0'
	 EXEC sp_executesql @sql
	set @sql= ' update #DBTRANS set nOtro = 0 where isnull(nOtro,0)=0'
	 EXEC sp_executesql @sql
	set @sql= ' update #DBTRANS set nPunto = 0 where isnull(nPunto,0)=0'
	 EXEC sp_executesql @sql
            
IF @flagTipo=1
	begin
	set @sql= ' SELECT tDocumento, fRegistro, nEfectivoSoles, nVenta, nEfectivoMN, nEfectivoME, nTarjeta, nPropina, nCheque, nOtro, nPunto, nCortesia, nCobrar, vEstadoDocumento.Descripcion as Estado ' +
          ' FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vEstadoDocumento ON dbo.#DBTRANS.tEstadoDocumento = dbo.vEstadoDocumento.Codigo ' +
          ' Order by '+  @sOrden   
	end
ELSE
	begin
	set @sql= 'select sum(nVenta) as Venta, sum(nEfectivoMN) as nEfectivoMN, sum(nEfectivoME) as nEfectivoME, sum(nCheque) as nCheque, sum(nPunto) As nPunto, sum(nEfectivoSoles) as nEfectivoSoles From #dbtrans '
	end


 EXEC sp_executesql @sql
end

END






GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE [dbo].[spRep_CobranzaFecha]
@flagTIPOREPORTE AS BIT,
@flagValor as bit,
@sPrefijo as nvarchar(40),
@sAno as nvarchar(4),
@sMes as nvarchar(4),
@sFechaPedido as nvarchar(400),
@sFechaDocumento as nvarchar(400),
@sFecha as nvarchar(400),
@dHour as float

AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(1000)
set @sql=''
set @scriterio=''
set @comilla=''''

IF @flagTIPOREPORTE=1
BEGIN
	CREATE TABLE #DBTRANS (Dia int, nMN float, nME float, nVuelto float, nMNE float, nTC1 float, nTC2 float, nTC3 float, nTC4 float, nTCX float, nCH float, nOTR float, nPT float, nPR float, nCortesia float, nDiferencia float, n000 float, nRI float, nNC float)
			if @flagValor=1
				begin
				set @sql=     ' insert into #DBTRANS ' +
			              ' select (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) as dia, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '01'+@comilla+' and tMoneda='+@comilla+ '01'+@comilla+' then nMonto else 0 end) as nMN, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '01'+@comilla+' and tMoneda='+@comilla+ '02'+@comilla+' then nDolar else 0 end) as nME, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '01'+@comilla+' and tMoneda='+@comilla+ '02'+@comilla+' then (nDolar-nMonto)*nTipoCambio else 0 end) as nVuelto, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '01'+@comilla+' and tMoneda='+@comilla+ '02'+@comilla+' then (nMonto*nTipoCambio) else 0 end) as nMNE, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '02'+@comilla+' and tTarjeta='+@comilla+ '01'+@comilla+' then nMonto else 0 end) as nTC1, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '02'+@comilla+' and tTarjeta='+@comilla+ '02'+@comilla+' then nMonto else 0 end) as nTC2, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '02'+@comilla+' and tTarjeta='+@comilla+ '03'+@comilla+' then nMonto else 0 end) as nTC3, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '02'+@comilla+' and tTarjeta='+@comilla+ '04'+@comilla+' then nMonto else 0 end) as nTC4, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '02'+@comilla+' and (tTarjeta='+@comilla+ '05'+@comilla+' or tTarjeta='+@comilla+ '06'+@comilla+' or tTarjeta='+@comilla+ '07'+@comilla+' or tTarjeta='+@comilla+ '08'+@comilla+') then nMonto else 0 end) as nTCX, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '03'+@comilla+' then nMonto else 0 end) as nCH, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '04'+@comilla+' and (tOtroTipoPago<>'+@comilla+ '000'+@comilla+' or tOtroTipoPago<>'+@comilla+ '001'+@comilla+' or tOtroTipoPago<>'+@comilla+ '002'+@comilla+') then nMonto else 0 end) as nOTR, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '05'+@comilla+' then nMonto else 0 end) as nPT, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '02'+@comilla+' then DPAGODOCUMENTO.nPropina else 0 end) as nPR, 0, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '04'+@comilla+' then case when round(nMonto,2) > round(nVenta,2) then nMonto - nVenta else 0 end else 0 end) as nDiferencia, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '04'+@comilla+' and tOtroTipoPago ='+@comilla+ '000'+@comilla+' then nMonto else 0 end) as n000, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '04'+@comilla+' and tOtroTipoPago ='+@comilla+ '001'+@comilla+' then nMonto else 0 end) as nRI, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '04'+@comilla+' and tOtroTipoPago ='+@comilla+ '002'+@comilla+' then nMonto else 0 end) as nNC ' + 
			              ' FROM dbo.DPAGODOCUMENTO INNER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo' + 
			              ' Where dbo.DPAGODOCUMENTO.tDocumento in (SELECT DISTINCT dbo.MDOCUMENTO.tDocumento FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sFechaPedido + ' )' + 'and  dbo.vTipoDocumento.RegistroVenta<> 0' +
			              ' group by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end), tTipoPago, tMoneda, tTarjeta ' + 
			              ' order by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end), tTipoPago, tMoneda, tTarjeta ' 
			     	  EXECUTE sp_executesql @sql
			       
			   	set @sql = ' update #DBTRANS set nCortesia = T1.nMonto FROM ' + 
			              ' (select (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + '  then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end) as dia, sum(nVenta) as nMonto ' + 
			              ' From mdocumento where isnull(tCortesia,'+@comilla+ ''+@comilla+')<>'+@comilla+ ''+@comilla+' and tTipoDocumento<>'+@comilla+ '00'+@comilla+' and tEstadoDocumento='+@comilla+ '02'+@comilla+' and ' + @sFechaDocumento + 
			              ' group by (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + '  then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end)) as T1 ' + 
			              ' where #DBTRANS.Dia = T1.Dia and nMN <> 0'
			       	EXECUTE sp_executesql @sql
			 
				end
			
			else
				begin
			
				set @sql    = ' insert into #DBTRANS ' + 
			              ' select (case when DATEPART(hh,'+ @sPrefijo + 'fregistro) >= ' +ltrim(str(@dHour)) + ' then day('+ @sPrefijo + 'fRegistro) else day(dateadd(day, -1, '+ @sPrefijo + 'fRegistro))  end) as dia, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '01'+@comilla+' and tMoneda='+@comilla+ '01'+@comilla+' then nMonto else 0 end) as nMN, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '01'+@comilla+' and tMoneda='+@comilla+ '02'+@comilla+' then nDolar else 0 end) as nME, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '01'+@comilla+' and tMoneda='+@comilla+ '02'+@comilla+' then (nDolar-nMonto)*nTipoCambio else 0 end) as nVuelto, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '01'+@comilla+' and tMoneda='+@comilla+ '02'+@comilla+' then (nMonto*nTipoCambio) else 0 end) as nMNE, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '02'+@comilla+' and tTarjeta='+@comilla+ '01'+@comilla+' then nMonto else 0 end) as nTC1, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '02'+@comilla+' and tTarjeta='+@comilla+ '02'+@comilla+' then nMonto else 0 end) as nTC2, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '02'+@comilla+' and tTarjeta='+@comilla+ '03'+@comilla+' then nMonto else 0 end) as nTC3, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '02'+@comilla+' and tTarjeta='+@comilla+ '04'+@comilla+' then nMonto else 0 end) as nTC4, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '02'+@comilla+' and (tTarjeta='+@comilla+ '05'+@comilla+' or tTarjeta='+@comilla+ '06'+@comilla+' or tTarjeta='+@comilla+ '07'+@comilla+' or tTarjeta='+@comilla+ '08'+@comilla+') then nMonto else 0 end) as nTCX, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '03'+@comilla+' then nMonto else 0 end) as nCH, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '04'+@comilla+' and (tOtroTipoPago<>'+@comilla+ '000'+@comilla+' or tOtroTipoPago<>'+@comilla+ '001'+@comilla+' or tOtroTipoPago<>'+@comilla+ '002'+@comilla+') then nMonto else 0 end) as nOTR, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '05'+@comilla+' then nMonto else 0 end) as nPT, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '02'+@comilla+' then DPAGODOCUMENTO.nPropina else 0 end) as nPR, 0, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '04'+@comilla+' then case when round(nMonto,2) > round(nVenta,2) then nMonto - nVenta else 0 end else 0 end) as nDiferencia, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '04'+@comilla+' and tOtroTipoPago ='+@comilla+ '000'+@comilla+' then nMonto else 0 end) as n000, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '04'+@comilla+' and tOtroTipoPago ='+@comilla+ '001'+@comilla+' then nMonto else 0 end) as nRI, ' + 
			              ' sum(case when tTipoPago='+@comilla+ '04'+@comilla+' and tOtroTipoPago ='+@comilla+ '002'+@comilla+' then nMonto else 0 end) as nNC ' + 
			              ' FROM dbo.DPAGODOCUMENTO INNER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo' +
			              ' Where ' + @sFecha + 'and  dbo.vTipoDocumento.RegistroVenta<> 0' +
			              ' group by (case when DATEPART(hh,'+ @sPrefijo + 'fregistro) >= ' +ltrim(str(@dHour)) + ' then day('+ @sPrefijo + 'fRegistro) else day(dateadd(day, -1, '+ @sPrefijo + 'fRegistro))  end), tTipoPago, tMoneda, tTarjeta ' + 
			              ' order by (case when DATEPART(hh,'+ @sPrefijo + 'fregistro) >= ' +ltrim(str(@dHour)) + ' then day('+ @sPrefijo + 'fRegistro) else day(dateadd(day, -1, '+ @sPrefijo + 'fRegistro))  end), tTipoPago, tMoneda, tTarjeta '
			   	 EXECUTE sp_executesql @sql
			       
				set @sql = 'update #DBTRANS set nCortesia = T1.nMonto FROM ' + 
			              '(select (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + ' then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end) as dia, sum(nVenta) as nMonto ' + 
			              'From mdocumento where isnull(tCortesia,'+@comilla+ ''+@comilla+')<>'+@comilla+ ''+@comilla+' and tTipoDocumento<>'+@comilla+ '00'+@comilla+' and tEstadoDocumento='+@comilla+ '02'+@comilla+' and ' + @sFechaDocumento  + 
			              'group by (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + ' then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end)) as T1 ' + 
			              'where #DBTRANS.Dia = T1.Dia and nMN <> 0'
			    	EXECUTE sp_executesql @sql
				end
			   set  @sql = ' select Dia, sum(nMN)-sum(nVuelto) as nMN, sum(nME) as ME, sum(nTC1) as nTC1, sum(nTC2) as nTC2, sum(nTC3) as nTC3, sum(nTC4) as nTC4, sum(nTCX) as nTCX, sum(nCH) as nCH, sum(nOTR) as nOTR, sum(nPT) as nPT, sum(nPR) as nPR, sum(nCortesia) as nCortesia, sum(nDiferencia) as nDiferencia, cast('+@comilla+@sAno+'/'+ @sMes +'/'+@comilla+'+ltrim(str(Dia)) as smalldatetime) as Fecha, sum(nMN+nMNE+nTC1+nTC2+nTC3+nTC4+nTCX+nCH+nOTR+nPT+nCortesia-nDiferencia) as nVenta, sum(n000), sum(nRI), sum(nNC) from #DBTRANS Group by Dia'
				--print @sql
			    EXECUTE sp_executesql @sql
END
ELSE
	BEGIN
	CREATE TABLE #DBTRANS1 (Dia int,grupo nvarchar(300) collate Modern_Spanish_CI_AS, monto  float)
	if @flagVALOR=1
				BEGIN		
					--EFECTIVO SOLES
					set @sql=     ' insert into #DBTRANS1 ' +
					              ' select (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) as dia,'+@COMILLA+'Efect MN'+@COMILLA + 
						      ' , sum(case when tTipoPago='+@comilla+ '01'+@comilla+' and tMoneda='+@comilla+ '01'+@comilla+' then nMonto else 0 end) - ' + 
				                      ' (sum(case when tTipoPago='+@comilla+ '01'+@comilla+' and tMoneda='+@comilla+ '02'+@comilla+' then (nDolar-nMonto)*nTipoCambio else 0 end)) as mONTO ' + 
					              ' FROM dbo.DPAGODOCUMENTO INNER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo' +
					              ' Where dbo.DPAGODOCUMENTO.tDocumento in (SELECT DISTINCT dbo.MDOCUMENTO.tDocumento FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sFechaPedido + ' )' + 'and  dbo.vTipoDocumento.RegistroVenta<> 0' +
						      ' group by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' + 
					              ' order by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' 
					--EFECTIVO DOLARES	
			     	  EXECUTE sp_executesql @sql

					set @sql=     ' insert into #DBTRANS1 ' +
					              ' select (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) as dia,'+@COMILLA+'Efect ME'+@COMILLA + 
						      ' , sum(case when tTipoPago='+@comilla+ '01'+@comilla+' and tMoneda='+@comilla+ '02'+@comilla+' then nDolar * isnull(ntipocambio,0) else 0 end) as  mONTO ' + 
					              ' FROM dbo.DPAGODOCUMENTO INNER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo' + 
					              ' Where dbo.DPAGODOCUMENTO.tDocumento in (SELECT DISTINCT dbo.MDOCUMENTO.tDocumento FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sFechaPedido + ' )' + 'and  dbo.vTipoDocumento.RegistroVenta<> 0' +
						      ' group by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' + 
					              ' order by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' 
			  	  EXECUTE sp_executesql @sql

					-- TARJETAS
						
					set @sql=     ' insert into #DBTRANS1 ' +
					              ' select (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) as dia,'+@COMILLA+'T '+@COMILLA +'+DBO.TTARJETACREDITO.TRESUMIDO, '+ 
					              ' sum(case when tTipoPago='+@comilla+ '02'+@comilla+' then nMonto else 0 end) AS mONTO ' + 
 						      ' FROM         dbo.DPAGODOCUMENTO INNER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento INNER JOIN dbo.TTARJETACREDITO ON dbo.DPAGODOCUMENTO.tTarjeta = dbo.TTARJETACREDITO.tCodigoTarjeta LEFT JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo' +
					              ' Where dbo.DPAGODOCUMENTO.tDocumento in (SELECT DISTINCT dbo.MDOCUMENTO.tDocumento FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sFechaPedido + ' )' + 'and  dbo.vTipoDocumento.RegistroVenta<> 0' +
						      ' group by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end),'+@COMILLA+'T '+@COMILLA +'+DBO.TTARJETACREDITO.TRESUMIDO ' + 
					              ' order by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end),'+@COMILLA+'T '+@COMILLA +'+DBO.TTARJETACREDITO.TRESUMIDO '
				  EXECUTE sp_executesql @sql

					--cheques
					set @sql=     ' insert into #DBTRANS1 ' +
					              ' select (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) as dia,'+@COMILLA+'Cheq/Dep'+@COMILLA + 
						      ' , sum(case when tTipoPago='+@comilla+ '03'+@comilla+' then nMonto else 0 end) mONTO ' + 
					              ' FROM dbo.DPAGODOCUMENTO INNER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo' + 
					              ' Where dbo.DPAGODOCUMENTO.tDocumento in (SELECT DISTINCT dbo.MDOCUMENTO.tDocumento FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sFechaPedido + ' )' + 'and  dbo.vTipoDocumento.RegistroVenta<> 0' +
						      ' group by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' + 
					              ' order by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' 

					  EXECUTE sp_executesql @sql
					 --otros tipos de pago
					set @sql=     ' insert into #DBTRANS1 ' +
					              ' select (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) as dia, '+ @comilla+'O '+ @comilla+'+dbo.vTipoCancelacion.TRESUMIDO, '+ 
					              ' sum(case when tTipoPago='+@comilla+ '04'+@comilla+'  then nMonto else 0 end) as MONTO ' +
 						      ' FROM dbo.DPAGODOCUMENTO INNER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento INNER JOIN dbo.vTipoCancelacion ON dbo.DPAGODOCUMENTO.tOtroTipoPago = dbo.vTipoCancelacion.Codigo LEFT JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo' +
					              ' Where dbo.DPAGODOCUMENTO.tDocumento in (SELECT DISTINCT dbo.MDOCUMENTO.tDocumento FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sFechaPedido + ' )' + 'and  dbo.vTipoDocumento.RegistroVenta<> 0' +
						      ' group by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end),'+ @comilla+'O '+ @comilla+'+dbo.vTipoCancelacion.TRESUMIDO ' + 
					              ' order by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end),'+ @comilla+'O '+ @comilla+'+dbo.vTipoCancelacion.TRESUMIDO ' 
					 EXECUTE sp_executesql @sql
					-- PUNTOS
					set @sql=     ' insert into #DBTRANS1 ' +
					              ' select (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) as dia,'+@COMILLA+'Puntos'+@COMILLA + 
						      ' , sum(case when tTipoPago='+@comilla+ '05'+@comilla+' then nMonto else 0 end) as mONTO ' + 
					              ' FROM dbo.DPAGODOCUMENTO INNER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo' +
					              ' Where dbo.DPAGODOCUMENTO.tDocumento in (SELECT DISTINCT dbo.MDOCUMENTO.tDocumento FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sFechaPedido + ' )' + 'and  dbo.vTipoDocumento.RegistroVenta<> 0' +
						      ' group by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' + 
					              ' order by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' 
					  EXECUTE sp_executesql @sql
				
					--PROPINAS
					set @sql=     ' insert into #DBTRANS1 ' +
					              ' select (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) as dia,'+@COMILLA+'Propina'+@COMILLA + 
						      ' , sum(case when tTipoPago='+@comilla+ '02'+@comilla+' then DPAGODOCUMENTO.nPropina else 0 end) as mONTO ' + 
					              ' FROM dbo.DPAGODOCUMENTO INNER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo' +
					              ' Where dbo.DPAGODOCUMENTO.tDocumento in (SELECT DISTINCT dbo.MDOCUMENTO.tDocumento FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sFechaPedido + ' )' + 'and  dbo.vTipoDocumento.RegistroVenta<> 0' +
						      ' group by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' + 
					              ' order by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' 
					  EXECUTE sp_executesql @sql

					--CORTESIAS
					set @sql=     ' insert into #DBTRANS1 ' +
					              ' select (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + '  then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end) as dia,'+@COMILLA+'Cortesia'+@COMILLA + ', sum(nVenta) as Monto ' + 
					              ' From mdocumento where isnull(tCortesia,'+@comilla+ ''+@comilla+')<>'+@comilla+ ''+@comilla+' and tTipoDocumento<>'+@comilla+ '00'+@comilla+' and tEstadoDocumento='+@comilla+ '02'+@comilla+' and ' + @sFechaDocumento + 
					              ' group by (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + '  then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end) ' 
					  EXECUTE sp_executesql @sql

		/*			print @sql
					print '1'*/
			
			   --            ' sum(case when tTipoPago='+@comilla+ '04'+@comilla+' and tOtroTipoPago ='+@comilla+ '000'+@comilla+' then nMonto else 0 end) as n000, ' + 
			   --           ' sum(case when tTipoPago='+@comilla+ '04'+@comilla+' and tOtroTipoPago ='+@comilla+ '001'+@comilla+' then nMonto else 0 end) as nRI, ' + 
			   --           ' sum(case when tTipoPago='+@comilla+ '04'+@comilla+' and tOtroTipoPago ='+@comilla+ '002'+@comilla+' then nMonto else 0 end) as nNC ' + 


					SELECT * FROM #DBTRANS1
				end 

	else
					BEGIN		
					--EFECTIVO SOLES
					set @sql=     ' insert into #DBTRANS1 ' +
					              ' select (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) as dia,'+@COMILLA+'Efect MN'+@COMILLA + 
						      ' , sum(case when tTipoPago='+@comilla+ '01'+@comilla+' and tMoneda='+@comilla+ '01'+@comilla+' then nMonto else 0 end) - ' + 
				                      ' (sum(case when tTipoPago='+@comilla+ '01'+@comilla+' and tMoneda='+@comilla+ '02'+@comilla+' then (nDolar-nMonto)*nTipoCambio else 0 end)) as mONTO ' + 
					              ' FROM dbo.DPAGODOCUMENTO INNER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo' + 
					              ' Where  ' + @sFecha + 'and  dbo.vTipoDocumento.RegistroVenta<> 0' +
						      ' group by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' + 
					              ' order by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' 
					
				

			     	  EXECUTE sp_executesql @sql
					--EFECTIVO DOLARES	
					set @sql=     ' insert into #DBTRANS1 ' +
					              ' select (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) as dia,'+@COMILLA+'Efect ME'+@COMILLA + 
						      ' , sum(case when tTipoPago='+@comilla+ '01'+@comilla+' and tMoneda='+@comilla+ '02'+@comilla+' then nDolar* isnull(ntipocambio,0) else 0 end) as  mONTO ' + 
					              ' FROM dbo.DPAGODOCUMENTO INNER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo' +
					              ' Where  ' + @sFecha + 'and  dbo.vTipoDocumento.RegistroVenta<> 0' +
						      ' group by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' + 
					              ' order by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' 

			  	  EXECUTE sp_executesql @sql

					-- TARJETAS
						
					set @sql=     ' insert into #DBTRANS1 ' +
					              ' select (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) as dia,'+@COMILLA+'T '+@COMILLA +'+DBO.TTARJETACREDITO.TRESUMIDO, '+ 
					              ' sum(case when tTipoPago='+@comilla+ '02'+@comilla+' then nMonto else 0 end) AS mONTO ' + 
 						      ' FROM         dbo.DPAGODOCUMENTO INNER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento INNER JOIN dbo.TTARJETACREDITO ON dbo.DPAGODOCUMENTO.tTarjeta = dbo.TTARJETACREDITO.tCodigoTarjeta LEFT JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo' +
					              ' Where  ' + @sFecha + 'and  dbo.vTipoDocumento.RegistroVenta<> 0' +
						      ' group by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end),'+@COMILLA+'T '+@COMILLA +'+DBO.TTARJETACREDITO.TRESUMIDO ' + 
					              ' order by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end),'+@COMILLA+'T '+@COMILLA +'+DBO.TTARJETACREDITO.TRESUMIDO ' 

				  EXECUTE sp_executesql @sql

					--cheques
					set @sql=     ' insert into #DBTRANS1 ' +
					              ' select (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) as dia,'+@COMILLA+'Cheq/Dep'+@COMILLA + 
						      ' , sum(case when tTipoPago='+@comilla+ '03'+@comilla+' then nMonto else 0 end) mONTO ' + 
					              ' FROM dbo.DPAGODOCUMENTO INNER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo' + 
					              ' Where  ' + @sFecha + 'and  dbo.vTipoDocumento.RegistroVenta<> 0' +
						      ' group by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' + 
					              ' order by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' 

					  EXECUTE sp_executesql @sql
					 --otros tipos de pago
					set @sql=     ' insert into #DBTRANS1 ' +
					              ' select (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) as dia,'+ @comilla+'O '+ @comilla+'+dbo.vTipoCancelacion.TRESUMIDO, '+ 
					              ' sum(case when tTipoPago='+@comilla+ '04'+@comilla+'  then nMonto else 0 end) as MONTO ' +
 						      ' FROM dbo.DPAGODOCUMENTO INNER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento INNER JOIN dbo.vTipoCancelacion ON dbo.DPAGODOCUMENTO.tOtroTipoPago = dbo.vTipoCancelacion.Codigo LEFT JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo' +
					              ' Where  ' + @sFecha + 'and  dbo.vTipoDocumento.RegistroVenta<> 0' +
						      ' group by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end),'+ @comilla+'O '+ @comilla+'+dbo.vTipoCancelacion.TRESUMIDO ' + 
					              ' order by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end),'+ @comilla+'O '+ @comilla+'+dbo.vTipoCancelacion.TRESUMIDO ' 
					--print @sql
--					print ' 1 '
					 EXECUTE sp_executesql @sql
					-- PUNTOS
					set @sql=     ' insert into #DBTRANS1 ' +
					              ' select (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) as dia,'+@COMILLA+'Puntos'+@COMILLA + 
						      ' , sum(case when tTipoPago='+@comilla+ '05'+@comilla+' then nMonto else 0 end) as mONTO ' + 
					              ' FROM dbo.DPAGODOCUMENTO INNER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo' + 
					              ' Where  ' + @sFecha ++ 'and  dbo.vTipoDocumento.RegistroVenta<> 0' +
						      ' group by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' + 
					              ' order by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' 
					  EXECUTE sp_executesql @sql
				
					--PROPINAS
					set @sql=     ' insert into #DBTRANS1 ' +
					              ' select (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) as dia,'+@COMILLA+'Propina'+@COMILLA + 
						      ' , sum(case when tTipoPago='+@comilla+ '02'+@comilla+' then DPAGODOCUMENTO.nPropina else 0 end) as mONTO ' + 
					              ' FROM dbo.DPAGODOCUMENTO INNER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo' +
					              ' Where  ' + @sFecha + 'and  dbo.vTipoDocumento.RegistroVenta<> 0' +
						      ' group by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' + 
					              ' order by (case when DATEPART(hh,' + @sPrefijo + ' fregistro) >= ' +ltrim(str(@dHour)) + '  then day(' + @sPrefijo + ' fRegistro) else day(dateadd(day, -1, ' + @sPrefijo + ' fRegistro))  end) ' 
					  EXECUTE sp_executesql @sql
					
					--CORTESIAS
					set @sql=     ' insert into #DBTRANS1 ' +
					              ' select (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + ' then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end) as dia,'+@COMILLA+'Cortesia'+@COMILLA + ', sum(nVenta) as Monto ' + 
					              ' From mdocumento where isnull(tCortesia,'+@comilla+ ''+@comilla+')<>'+@comilla+ ''+@comilla+' and tTipoDocumento<>'+@comilla+ '00'+@comilla+' and tEstadoDocumento='+@comilla+ '02'+@comilla+' and ' + @sFechaDocumento  + 
					              ' group by (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + ' then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end) ' 
					  EXECUTE sp_executesql @sql

					--print @sql
					--print '1'

					SELECT * FROM #DBTRANS1
				end 
	END 
END  

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE spRep_PaloteoComparativo
@flagTurnoOFecha as bit,
@flagTipoValor as bit,
@tTipoProducto as nvarchar(20),
@tAreaProduccion as nvarchar(50),
@tGrupo as nvarchar(50),
@tSubGrupo as nvarchar(50),
@tCodigoProducto as nvarchar(20),
@tTurno as nvarchar(20),
@finicio as smalldatetime,
@ffinal as smalldatetime,
@flagNFacturado as bit
AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(1000)
declare @xCriterio nvarchar(1000)
declare @sPrecio nvarchar(100)
set @sql=''
set @scriterio=''
set @xCriterio=''
set @comilla=''''

	CREATE TABLE #DBTRANS (Codigo nVarChar(7) collate Modern_Spanish_CI_AS, Grupo nVarChar(50) collate Modern_Spanish_CI_AS, SubGrupo nVarChar(50) collate Modern_Spanish_CI_AS, Producto nVarChar(100) collate Modern_Spanish_CI_AS, Valor float, Produccion float, Venta float, Cortesia float, CtaCte float, Canal1 Float, Canal2 float, Canal3 float, Canal4 float, Canal5 float)

if @flagTurnoOFecha=0 
	begin
	set @sCriterio=' MPEDIDO.tTurno like ' + @comilla+@tturno+'%'+@comilla
	
	end
else
	begin
	set @scriterio=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	end


if @tTipoProducto <>''
	begin
	set @scriterio=@scriterio + ' and tTipoProducto like ' +@comilla+@ttipoproducto+'%'+@comilla
	end

if @tAreaProduccion<>''
	begin
	set @scriterio=@scriterio + ' and Area like ' +@comilla+@tareaproduccion+'%'+@comilla
	end
if @tGrupo <> ''
	begin
	set @scriterio=@scriterio + ' and vProducto.Grupo like ' +@comilla+@tgrupo+'%'+@comilla
	end

if @tSubGrupo<>''
	begin
	set @scriterio=@scriterio + ' and  subGrupo like ' +@comilla+@tsubgrupo+'%'+@comilla
	end

if @tCodigoProducto<>''
	begin
	set @scriterio=@scriterio + ' and DPEDIDO.tCodigoProducto like ' +@comilla+@tcodigoproducto+'%'+@comilla
	end

/*empieza*/
--inserta datos del producto
set @sql= ' Insert into #DBTRANS (Codigo, Grupo, SubGrupo, Producto, Valor, Produccion, Venta, Cortesia, CtaCte, Canal1, Canal2, Canal3, Canal4, Canal5 ) ' +
          'SELECT Codigo, Grupo, SubGrupo, Descripcion, 0,0,0,0,0,0,0,0,0,0 From vProducto '
EXECUTE sp_executesql @sql
--produccion
set @sql= ' Update #DBTRANS set Produccion=T1.Total From ' +
          ' (SELECT DPEDIDO.tCodigoProducto as Codigo, Sum(DPEDIDO.nCantidad) as Total FROM dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
          ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and  ' + @scriterio + ' GROUP BY DPEDIDO.tCodigoProducto) as T1 ' +
          ' Where #DBTRANS.Codigo = T1.Codigo'
EXECUTE sp_executesql @sql

--VENTA
if @flagNFacturado=0    
	begin
			IF @flagTipoValor=1 
			begin
				set @sPrecio = 'dbo.DPEDIDO.nPrecioVenta * dbo.DPEDIDO.nCantidad'
				end
			Else
			begin
				set @sPrecio = 'dbo.DPEDIDO.nPrecioNeto * dbo.DPEDIDO.nCantidad'
			end
    end 
if @flagNFacturado=1
	begin
			IF @flagTipoValor=1 
				begin
 					set @sPrecio = 'case when dpedido.lregistroventa=0 then 0 else dbo.DPEDIDO.nPrecioVenta * dbo.DPEDIDO.nCantidad end '
				end
			Else
				begin
					set @sPrecio = 'case when dpedido.lregistroventa=0 then 0 else dbo.DPEDIDO.nPrecioNeto * dbo.DPEDIDO.nCantidad end '
					 
				end
		 
	end
set  @sql =' Update #DBTRANS set Venta=T1.Total, Valor= T1.Valor From ' +
           ' (SELECT DPEDIDO.tCodigoProducto as Codigo, Sum(DPEDIDO.nCantidad) as Total, sum(' + @sPrecio + ') as Valor FROM dbo.DPEDIDO LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido  ' +
           ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and '+ @scriterio +' GROUP BY DPEDIDO.tCodigoProducto) as T1 '+
           ' Where #DBTRANS.Codigo = T1.Codigo '
EXECUTE sp_executesql @sql

  --Cortesia
    set @sql = ' Update #DBTRANS set Cortesia=T1.Total From ' + 
	       ' (SELECT DPEDIDO.tCodigoProducto as Codigo, Sum(DPEDIDO.nCantidad) as Total FROM dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
               ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and ' + @sCriterio + '  GROUP BY DPEDIDO.tCodigoProducto) as T1 ' + 
               ' Where #DBTRANS.Codigo = T1.Codigo '
    EXECUTE sp_executesql @sql
                     
  --Cuentas Corrientes
    set @sql = ' Update #DBTRANS set CtaCte=T1.Total From ' +
	       ' (SELECT DPEDIDO.tCodigoProducto as Codigo, Sum(DPEDIDO.nCantidad) as Total FROM dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
               ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+''+@comilla+')<>'+@comilla+''+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and  ' + @sCriterio + '  GROUP BY DPEDIDO.tCodigoProducto) as T1 ' + 
               ' Where #DBTRANS.Codigo = T1.Codigo '
    EXECUTE sp_executesql @sql
      
    --Canal1
    set @sql = ' Update #DBTRANS set Canal1=T1.Total From ' + 
	       ' (SELECT DPEDIDO.tCodigoProducto as Codigo, Sum(DPEDIDO.nCantidad) as Total FROM dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
               ' Where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and MPEDIDO.tTipoPedido='+@comilla+'01'+@comilla+' and  ' + @sCriterio + '  GROUP BY DPEDIDO.tCodigoProducto) as T1 ' + 
               ' Where #DBTRANS.Codigo = T1.Codigo '
    EXECUTE sp_executesql @sql

  --Canal2
    set @sql= ' Update #DBTRANS set Canal2=T1.Total From ' + 
              ' (SELECT DPEDIDO.tCodigoProducto as Codigo, Sum(DPEDIDO.nCantidad) as Total FROM dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
              ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and MPEDIDO.tTipoPedido='+@comilla+'02'+@comilla+' and ' + @sCriterio + '  GROUP BY DPEDIDO.tCodigoProducto) as T1 ' + 
              ' Where #DBTRANS.Codigo = T1.Codigo '
    EXECUTE sp_executesql @sql

  --Canal3
    set @sql=   ' Update #DBTRANS  set Canal3=T1.Total  From ' + 
           	' (SELECT DPEDIDO.tCodigoProducto as Codigo, Sum(DPEDIDO.nCantidad) as Total FROM dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
        	' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and MPEDIDO.tTipoPedido='+@comilla+'03'+@comilla+' and ' + @sCriterio + '  GROUP BY DPEDIDO.tCodigoProducto) as T1 ' + 
	   	' Where #DBTRANS.Codigo = T1.Codigo'
    EXECUTE sp_executesql @sql

  --Canal4
    set @sql= ' Update #DBTRANS  set Canal4=T1.Total  From ' + 
           	' (SELECT DPEDIDO.tCodigoProducto as Codigo, Sum(DPEDIDO.nCantidad) as Total FROM dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
	        ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and MPEDIDO.tTipoPedido='+@comilla+'04'+@comilla+' and ' + @sCriterio + '  GROUP BY DPEDIDO.tCodigoProducto) as T1 ' + 
                ' Where #DBTRANS.Codigo = T1.Codigo'
    EXECUTE sp_executesql @sql

   --Canal5
    set @sql= ' Update #DBTRANS  set Canal5=T1.Total  From ' + 
              ' (SELECT DPEDIDO.tCodigoProducto as Codigo, Sum(DPEDIDO.nCantidad) as Total FROM dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
              ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and MPEDIDO.tTipoPedido='+@comilla+'05'+@comilla+' and ' + @sCriterio + '  GROUP BY DPEDIDO.tCodigoProducto) as T1 ' + 
              ' Where #DBTRANS.Codigo = T1.Codigo'
    EXECUTE sp_executesql @sql

set @sql=''
SET @sql = ' select Codigo, Grupo, SubGrupo, Producto, Valor, Produccion, Venta, Cortesia, CtaCte, Canal1, Canal2, Canal3, Canal4, Canal5  ' +
           ' From #DBTRANS  where Produccion > 0 order by Grupo, subGrupo, Producto'
    EXECUTE sp_executesql @sql

END

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE spRep_PrincipalCliente
@flagTipo as bit,
@sMonto as float, 
@SCliente as nvarchar(20),
@fInicio as smalldatetime,
@fFinal as smalldatetime

AS BEGIN
set nocount on
DECLARE @sql as nvarchar(4000)
DECLARE @Filtro as nvarchar(200)
declare @comilla nvarchar(5)
set @comilla=''''

if @sCliente<>''
	set @Filtro='MDOCUMENTO.tCodigoCliente='+@comilla+@scliente+@comilla+ ' and '
else
	set @filtro=''

if @flagTipo=1
	begin
 	set @sql =  ' SELECT dbo.MDOCUMENTO.tCodigoCliente, dbo.TCLIENTE.tEmpresa, dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.fRegistro, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, dbo.MDOCUMENTO.nVenta ' +
        	    ' FROM dbo.MDOCUMENTO LEFT OUTER JOIN dbo.TCLIENTE ON dbo.MDOCUMENTO.tCodigoCliente = dbo.TCLIENTE.tCodigoCliente ' +
            	    ' Where MDOCUMENTO.tCodigoCliente in ( SELECT tCodigoCliente FROM dbo.MDOCUMENTO WHERE '+@Filtro+ ' tTipoDocumento <> '+@comilla+ '00'+@comilla+' AND tEstadoDocumento <> '+@comilla+ '04'+@comilla+' AND ISNULL(tCodigoCliente,  '+@comilla+ '0'+@comilla+') <>  '+@comilla+ '0'+@comilla+' AND tCodigoCliente <> '+@comilla+ ''+@comilla+'  and MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@ffinal)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ' GROUP BY tCodigoCliente HAVING SUM(nNeto) >= '+ ltrim(str(@sMonto)) + ') ' +
                    ' and '+ @Filtro +' tTipoDocumento <> '+@comilla+ '00'+@comilla+' AND tEstadoDocumento <> '+@comilla+ '04'+@comilla+' AND ISNULL(MDOCUMENTO.tCodigoCliente,  '+@comilla+ '0'+@comilla+') <>  '+@comilla+ '0'+@comilla+' AND MDOCUMENTO.tCodigoCliente <> '+@comilla+ ''+@comilla+' and  MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@ffinal)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + 
	            ' order by dbo.TCLIENTE.tEmpresa, dbo.MDOCUMENTO.tDocumento '
	end
else
	begin
	set @sql =  ' SELECT  dbo.TCLIENTE.tCodigoCliente, dbo.TCLIENTE.tEmpresa, COUNT(dbo.MDOCUMENTO.tDocumento) AS Cantidad, SUM(dbo.MDOCUMENTO.nNeto) AS nNeto, SUM(dbo.MDOCUMENTO.nPrecioImpuesto1) AS nPrecioImpuesto1, SUM(dbo.MDOCUMENTO.nPrecioImpuesto2) AS nPrecioImpuesto2, SUM(dbo.MDOCUMENTO.nPrecioImpuesto3) AS nPrecioImpuesto3, SUM(dbo.MDOCUMENTO.nVenta) AS nVenta '+
                    ' FROM dbo.MDOCUMENTO INNER JOIN dbo.TCLIENTE ON dbo.MDOCUMENTO.tCodigoCliente = dbo.TCLIENTE.tCodigoCliente ' +
                    ' WHERE  ' + @filtro + ' MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@ffinal)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ' and dbo.MDOCUMENTO.tTipoDocumento <> '+@comilla+ '00'+@comilla+' AND dbo.MDOCUMENTO.tEstadoDocumento <> '+@comilla+ '04'+@comilla+' AND (dbo.MDOCUMENTO.tCodigoCliente <> '+@comilla+ ''+@comilla+' OR ISNULL(dbo.MDOCUMENTO.tCodigoCliente,  '+@comilla+ '0'+@comilla+') <>  '+@comilla+ '0'+@comilla+') ' + 
             	    ' GROUP BY dbo.TCLIENTE.tCodigoCliente, dbo.TCLIENTE.tEmpresa ' +
                    ' HAVING SUM(dbo.MDOCUMENTO.nNeto) >= '+ltrim(str(@sMonto))  + ' order by dbo.TCLIENTE.tEmpresa'
	end

    		EXECUTE  sp_executesql @sql
		print @sql
END

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE spRep_Ranking
@flagFranjaHoraria as bit,
@flagProduccion as bit,
@flagVenta as bit,
@flagCortesia as bit,
@flagCuentaCte as bit,
@flagPedidosFacturados as bit,
@flagCombinacion as bit,
@flagCargo as bit,
@flagOpcion as bit, -- 1=detallado 0=resumido
@flagTurnoOFecha as bit,-- si selecciona un turno o rango d fecha
@flagVVenta as bit,
@flagVNeto as bit,
@flagVCosto as bit,
@tSalon as nvarchar (30),  
@tTipoProducto as nvarchar(30),
@tTipoPedido as nvarchar(30),
@tGrupo as nvarchar(30),
@tSubGrupo as nvarchar(30),
@turno as nvarchar(30),
@sPrecio as nvarchar(200),
@sOrden as nvarchar(200),
@sBoton2 as nvarchar(30),
@sBoton3 as nvarchar(30),
@sBoton4 as nvarchar(30),
@sBoton5 as nvarchar(30),
@finicio as smalldatetime,
@ffinal as smalldatetime,
@tCaja as nvarchar(30)

AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @Actualizaciones nvarchar(1000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(3000)
declare @sCriteriox nvarchar(3000)
declare @xCriterio nvarchar(3000)
declare @sCostoPropiedad nvarchar(2000)
declare @sCombo nvarchar(2000)
declare @sCostoComboPropiedad nvarchar(2000)
declare @sFiltro nvarchar(1000)

set @comilla=''''
	
 CREATE TABLE #DBTRANS (tLocal nVarChar(3) collate Modern_Spanish_CI_AS, Local nVarChar(30) collate Modern_Spanish_CI_AS, Salon nVarChar(30) collate Modern_Spanish_CI_AS, tMesa nVarChar(3) collate Modern_Spanish_CI_AS, TipoProducto nVarChar(30) collate Modern_Spanish_CI_AS, Grupo nVarChar(50) collate Modern_Spanish_CI_AS, SubGrupo nVarChar(50) collate Modern_Spanish_CI_AS, Producto nVarChar(50) collate Modern_Spanish_CI_AS, Cantidad Float, Venta Float, Pedido nVarchar(10) collate Modern_Spanish_CI_AS, Documento nVarChar(20) collate Modern_Spanish_CI_AS, Fecha DateTime, tTipoPedido nVarchar(2) collate Modern_Spanish_CI_AS, tCodigoProducto nVarchar(7) collate Modern_Spanish_CI_AS, tItem nVarchar(3) collate Modern_Spanish_CI_AS)

IF @flagFranjaHoraria =0
BEGIN
if @flagTurnoOFecha=0 
	begin
	set @sCriterio=' MPEDIDO.tTurno like ' + @comilla+@turno+'%'+@comilla
	set @sCriteriox=' MPEDIDO.tTurno like ' + @comilla+@turno+'%'+@comilla
	set @xCriterio=' MDOCUMENTO.tTurno like '+ @comilla+@turno+'%'+@comilla
	end
else
	begin
	set @scriterio=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @scriteriox=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @xCriterio=' MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + '  and MDOCUMENTO.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla

	end


	if @tsalon <>''
		SET @sCriterio=@sCriterio + ' and MPEDIDO.tSalon like ' + @comilla+@tsalon+'%'+@comilla
	if @ttipoProducto<>''
		SET @sCriterio=@sCriterio + ' and TipoProducto like  ' + @comilla+@tTipoProducto+'%'+@comilla
		--SET @sCriteriox=@sCriteriox + ' and TipoProducto like  ' + @comilla+@tTipoProducto+'%'+@comilla
	if @ttipoPedido<>''
		SET @sCriterio=@sCriterio + ' and MPEDIDO.tTipoPedido like  ' + @comilla+@tTipoPedido+'%'+@comilla
	if @tgrupo <> ''
		SET @sCriterio=@sCriterio + ' and Grupo like ' + @comilla+@tGrupo+'%'+@comilla
	if @tsubgrupo <> ''
		SET @sCriterio=@sCriterio + ' and subGrupo like ' + @comilla+@tSubGrupo+'%'+@comilla
	if @tCaja <> ''
		SET @sCriterio=@sCriterio + ' and Mpedido.tcaja like ' + @comilla+@tcaja+'%'+@comilla
	-- print @scriterio
	--print @sfiltro


if @flagProduccion=1 --produccion
begin
	SET  @sql= ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem ) ' +
        	   ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
	           ' FROM  dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ' +
	           ' where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+ 'N'+@comilla+' and '+  @sCriterio

		  --Actualiza Costos de las Propiedades
	  set @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
                       		 ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       		 ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                     		 ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') AND ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	  --Actualiza Costos de los Combos
	  set @sCombo = ' Update #DBTRANS set Venta = T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
          		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
               		' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
	                ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ' +
         	        ' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

	 --Actualiza Costos de los Combos de las Propiedades
	  set @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
                            ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' + 
                            ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                            ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @scriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ' +
                            ' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

END 
	
if @flagVenta=1 --venta
begin
  set @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
             ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
             ' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento  ' +
             ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sCriterio + ' and ' + @xCriterio
             
 	--  Actualiza Costos de las Propiedades
	set  @sCostoPropiedad =   'Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' + 
                      		  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       		  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
	                          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox  + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	--  Actualiza Costos de los Combos
	set @sCombo =   ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
               		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
	                ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
          	        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + ' and ' + @xCriterio +
	                ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
	
	--Actualiza Costos de los Combos de las Propiedades
	set @sCostoComboPropiedad = 	' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                            		' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                          	        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+' ) and '+ @sCriteriox  +
                           		' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2  ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem ' 

end

if @flagCortesia=1 --cortesia
begin
  SET @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
             ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, '+ @sPrecio+' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
             ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento  ' +
             ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' and ' +@sCriterio

      --Actualiza Costos de las Propiedades
	set  @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                        ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and ' + @sCriteriox  + 
                        ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

 	     --Actualiza Costos de los Combos
		set  @sCombo = ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN  dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and '+ @scriteriox + 
	       ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	     --Actualiza Costos de los Combos de las Propiedades
		set  @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+ ' and ' +  @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
end 
if @flagCuentaCte=1 --cuenta corriente
begin
	set @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
           ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
           ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.TMESA  ' + 
	   ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+''+@comilla+')<>'+@comilla+''+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriterio + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and '+ @xCriterio + ')'
      
	--Actualiza Costos de las Propiedades
		set  @sCostoPropiedad =    ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
             			           ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
		                           ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ') ' + 
                        		   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
             
      --Actualiza Costos de los Combos
		set  @sCombo = 		   ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               				   ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               				   ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
               				   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

      --Actualiza Costos de los Combos de las Propiedades
		set  @sCostoComboPropiedad =    ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             			' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             			' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
                             			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

END

if @flagCombinacion=1 --combinacion
begin
	set @sql =  ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem ) ' + 
             ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad,  ' + @sPrecio +' AS Venta, dbo.CPEDIDO.tCodigoPedido AS Pedido, dbo.DPEDIDO.tDocumento AS Documento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
             ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.TMESA  ' +
             ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and ' + @sCriterio
      
	--Actualiza Costos de las Propiedades
	      SET @sCostoPropiedad = 'select 1'

      	--Actualiza Costos de los Combos
	      SET @sCombo = 'SELECT 1'
      
	--Actualiza Costos de los Combos de las Propiedades
    	      set @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             	 	  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja  ' +
                             	 	  ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem and T1.tItemCombo = T2.tItemCombo '                     

end

if @flagCargo=1 --cargo
begin
	set  @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
            ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, '+ @Sprecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' + 
            ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.TMESA ' +
            ' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriterio
            
	      SET @sCostoPropiedad = 'select 1'

	      SET @sCostoComboPropiedad = 'SELECT 1'
		--Actualiza Costos  de los Combos
	      set @sCombo = ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
              ' FROM dbo.CPEDIDO INNER JOIN  dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
              ' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +
              ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'	

end	
	
if @flagPedidosFacturados=1 --pedidos facturados
begin
set   @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' + 
             ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' +@sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
             ' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento  ' +
             ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio

	      --Actualiza Costos de las Propiedades
  		SET    @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
                            ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                            ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                            ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox +
                            ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

  		--Actualiza Costos de los Combos xx
 		SET     @sCombo = ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
            			  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
             			  ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
               			  ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + 
               			  ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
      
      		--Actualiza Costos de los Combos de las Propiedades
 		SET     @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             			' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             			' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' +  @sCriteriox +
                             			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

end
--print @sql
EXEC sp_executesql @sql

if @flagVCosto=1
	begin
	EXEC sp_executesql @sCombo
	end


update #DBTRANS set tLocal =  vSalon.tLocal FROM #DBTRANS INNER JOIN dbo.TMESA ON dbo.#DBTRANS.tMesa = dbo.TMESA.tCodigoMesa INNER JOIN dbo.vSalon ON dbo.TMESA.tSalon = dbo.vSalon.Codigo 

if @flagVCosto=1
	begin
	EXEC sp_executesql @sCostoPropiedad
	EXEC sp_executesql @sCombo
	EXEC sp_executesql @sCostoComboPropiedad
	end


set @Actualizaciones = 'update #DBTRANS set Salon = '+@comilla+'Sin Salon'+@comilla+' where isnull(Salon,'+@comilla+'0'+@comilla+') = '+@comilla+'0'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+@comilla+ @sBoton2 + @comilla+' where tTipoPedido ='+@comilla+'02'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+ @comilla+@sBoton3 +@comilla+ ' where tTipoPedido ='+@comilla+'03'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+@comilla+ @sBoton4 +@comilla+ ' where tTipoPedido ='+@comilla+'04'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+ @comilla+@sBoton5+@comilla + ' where tTipoPedido ='+@comilla+'05'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Local = vLocal.Descripcion FROM #DBTRANS INNER JOIN dbo.vLocal ON dbo.#DBTRANS.tLocal = dbo.vLocal.Codigo '
EXEC sp_executesql @Actualizaciones

/**/
if @flagOpcion=1
	begin
	set @sql=   ' SELECT [Local], Max(Salon), TipoProducto, Grupo, SubGrupo, Producto, SUM(Cantidad) AS Cantidad, SUM(Venta) AS Ventas  ' +
             	    ' From #DBTRANS GROUP BY [Local], TipoProducto, Grupo, SubGrupo, Producto ' +
		    ' Order by ' + @sOrden
       end
ELSE
	begin
	set @sql=   ' SELECT Producto, SUM(Cantidad) AS Cantidad, SUM(Venta) AS Ventas From #DBTRANS GROUP BY Producto Order by ' + @sOrden
	end
/**/
EXEC sp_executesql @sql

END
IF @flagFranjaHoraria=1
BEGIN
declare @numdias int
declare @contaDias int
declare @finicial as datetime
set @numdias=(select   DATEDIFF ( day , @finicio,@ffinal))
 
set @contaDias=0
set @finicial=@finicio
while (@contadias<=@numdias)
	begin
	print @contadias
	set @finicio=(select dateadd(day,@contadias,@finicial))	
	set @ffinal= (select  cast(convert(nvarchar,@finicio,112)   + ' '  + CONVERT(VARCHAR,@ffinal,108) as datetime))
	print 'inicio'
	print @finicio
	print 'final'
	print   @ffinal
	print ' zxzzzzz '

if @flagTurnoOFecha=0 
	begin
	set @sCriterio=' MPEDIDO.tTurno like ' + @comilla+@turno+'%'+@comilla
	set @sCriteriox=' MPEDIDO.tTurno like ' + @comilla+@turno+'%'+@comilla
	set @xCriterio=' MDOCUMENTO.tTurno like '+ @comilla+@turno+'%'+@comilla
	end
else
	begin
	set @scriterio=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @scriteriox=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @xCriterio=' MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + '  and MDOCUMENTO.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla

	end


	if @tsalon <>''
		SET @sCriterio=@sCriterio + ' and MPEDIDO.tSalon like ' + @comilla+@tsalon+'%'+@comilla
	if @ttipoProducto<>''
		SET @sCriterio=@sCriterio + ' and TipoProducto like  ' + @comilla+@tTipoProducto+'%'+@comilla
		--SET @sCriteriox=@sCriteriox + ' and TipoProducto like  ' + @comilla+@tTipoProducto+'%'+@comilla
	if @ttipoPedido<>''
		SET @sCriterio=@sCriterio + ' and MPEDIDO.tTipoPedido like  ' + @comilla+@tTipoPedido+'%'+@comilla
	if @tgrupo <> ''
		SET @sCriterio=@sCriterio + ' and Grupo like ' + @comilla+@tGrupo+'%'+@comilla
	if @tsubgrupo <> ''
		SET @sCriterio=@sCriterio + ' and subGrupo like ' + @comilla+@tSubGrupo+'%'+@comilla
	if @tCaja <> ''
		SET @sCriterio=@sCriterio + ' and Mpedido.tcaja like ' + @comilla+@tcaja+'%'+@comilla
	-- print @scriterio
	--print @sfiltro


if @flagProduccion=1 --produccion
begin
	SET  @sql= ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem ) ' +
        	   ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
	           ' FROM  dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ' +
	           ' where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+ 'N'+@comilla+' and '+  @sCriterio

		  --Actualiza Costos de las Propiedades
	  set @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
                       		 ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       		 ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                     		 ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') AND ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	  --Actualiza Costos de los Combos
	  set @sCombo = ' Update #DBTRANS set Venta = T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
          		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
               		' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
	                ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ' +
         	        ' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

	 --Actualiza Costos de los Combos de las Propiedades
	  set @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
                            ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' + 
                            ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                            ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @scriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ' +
                            ' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

END 
	
if @flagVenta=1 --venta
begin
  set @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
             ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
             ' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento  ' +
             ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sCriterio + ' and ' + @xCriterio
             
 	--  Actualiza Costos de las Propiedades
	set  @sCostoPropiedad =   'Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' + 
                      		  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       		  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
	                          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox  + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	--  Actualiza Costos de los Combos
	set @sCombo =   ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
               		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
	                ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
          	        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + ' and ' + @xCriterio +
	                ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
	
	--Actualiza Costos de los Combos de las Propiedades
	set @sCostoComboPropiedad = 	' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                            		' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                          	        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+' ) and '+ @sCriteriox  +
                           		' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2  ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem ' 

end

if @flagCortesia=1 --cortesia
begin
  SET @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
             ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, '+ @sPrecio+' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
             ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento  ' +
             ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' and ' +@sCriterio

      --Actualiza Costos de las Propiedades
	set  @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                        ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and ' + @sCriteriox  + 
                        ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

 	     --Actualiza Costos de los Combos
		set  @sCombo = ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN  dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and '+ @scriteriox + 
	       ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	     --Actualiza Costos de los Combos de las Propiedades
		set  @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+ ' and ' +  @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
end 
if @flagCuentaCte=1 --cuenta corriente
begin
	set @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
           ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
           ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.TMESA  ' + 
	   ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+''+@comilla+')<>'+@comilla+''+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriterio + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and '+ @xCriterio + ')'
      
	--Actualiza Costos de las Propiedades
		set  @sCostoPropiedad =    ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
             			           ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
		                           ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ') ' + 
                        		   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
             
      --Actualiza Costos de los Combos
		set  @sCombo = 		   ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               				   ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               				   ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
               				   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

      --Actualiza Costos de los Combos de las Propiedades
		set  @sCostoComboPropiedad =    ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             			' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             			' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
                             			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

END

if @flagCombinacion=1 --combinacion
begin
	set @sql =  ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem ) ' + 
             ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad,  ' + @sPrecio +' AS Venta, dbo.CPEDIDO.tCodigoPedido AS Pedido, dbo.DPEDIDO.tDocumento AS Documento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
             ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.TMESA  ' +
             ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and ' + @sCriterio
      
	--Actualiza Costos de las Propiedades
	      SET @sCostoPropiedad = 'select 1'

      	--Actualiza Costos de los Combos
	      SET @sCombo = 'SELECT 1'
      
	--Actualiza Costos de los Combos de las Propiedades
    	      set @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             	 	  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja  ' +
                             	 	  ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem and T1.tItemCombo = T2.tItemCombo '                     

end

if @flagCargo=1 --cargo
begin
	set  @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
            ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, '+ @Sprecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' + 
            ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.TMESA ' +
            ' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriterio
            
	      SET @sCostoPropiedad = 'select 1'

	      SET @sCostoComboPropiedad = 'SELECT 1'
		--Actualiza Costos  de los Combos
	      set @sCombo = ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
              ' FROM dbo.CPEDIDO INNER JOIN  dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
              ' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +
              ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'	

end	
	
if @flagPedidosFacturados=1 --pedidos facturados
begin
set   @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' + 
             ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' +@sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
             ' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento  ' +
             ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio

	      --Actualiza Costos de las Propiedades
  		SET    @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
                            ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                            ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                            ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox +
                            ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

  		--Actualiza Costos de los Combos xx
 		SET     @sCombo = ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
            			  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
             			  ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
               			  ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + 
               			  ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
      
      		--Actualiza Costos de los Combos de las Propiedades
 		SET     @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             			' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             			' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' +  @sCriteriox +
                             			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

end
--print @sql
EXEC sp_executesql @sql

if @flagVCosto=1
	begin
	EXEC sp_executesql @sCombo
	end


update #DBTRANS set tLocal =  vSalon.tLocal FROM #DBTRANS INNER JOIN dbo.TMESA ON dbo.#DBTRANS.tMesa = dbo.TMESA.tCodigoMesa INNER JOIN dbo.vSalon ON dbo.TMESA.tSalon = dbo.vSalon.Codigo 

if @flagVCosto=1
	begin
	EXEC sp_executesql @sCostoPropiedad
	EXEC sp_executesql @sCombo
	EXEC sp_executesql @sCostoComboPropiedad
	end
		set @contadias=@contadias+1
	end 

set @Actualizaciones = 'update #DBTRANS set Salon = '+@comilla+'Sin Salon'+@comilla+' where isnull(Salon,'+@comilla+'0'+@comilla+') = '+@comilla+'0'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+@comilla+ @sBoton2 + @comilla+' where tTipoPedido ='+@comilla+'02'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+ @comilla+@sBoton3 +@comilla+ ' where tTipoPedido ='+@comilla+'03'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+@comilla+ @sBoton4 +@comilla+ ' where tTipoPedido ='+@comilla+'04'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+ @comilla+@sBoton5+@comilla + ' where tTipoPedido ='+@comilla+'05'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Local = vLocal.Descripcion FROM #DBTRANS INNER JOIN dbo.vLocal ON dbo.#DBTRANS.tLocal = dbo.vLocal.Codigo '
EXEC sp_executesql @Actualizaciones

/**/
if @flagOpcion=1
	begin
	set @sql=   ' SELECT [Local], Max(Salon), TipoProducto, Grupo, SubGrupo, Producto, SUM(Cantidad) AS Cantidad, SUM(Venta) AS Ventas  ' +
             	    ' From #DBTRANS GROUP BY [Local], TipoProducto, Grupo, SubGrupo, Producto ' +
		    ' Order by ' + @sOrden
       end
ELSE
	begin
	set @sql=   ' SELECT Producto, SUM(Cantidad) AS Cantidad, SUM(Venta) AS Ventas From #DBTRANS GROUP BY Producto Order by ' + @sOrden
	end
/**/
EXEC sp_executesql @sql

END

END




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



CREATE PROCEDURE [dbo].[spRep_RegVenta]
@flagTipo as bit, 
@flagRegVenta as bit, 
@flagCorrelativo as bit,
@flagEstado as bit,
@flagAgrupado as bit,
@flagRedondeo as bit,
@tCliente as nvarchar(20),
@tTipoDoc as nvarchar(20),
@tEstadoDoc as nvarchar(20),
@tCaja as nvarchar(5),
@sOrden as nvarchar(140),
@finicio as smalldatetime,
@ffinal as smalldatetime,
@sAno AS NVARCHAR(4),
@sMES AS NVARCHAR(4),
@sFecha AS NVARCHAR(300),
@sFecha2 AS NVARCHAR(300),
@dHour as float,
@flagAnoMes as bit,
@diaContable as bit,
@tTipoPago as nvarchar(20)
AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(1000)
declare @xCriterio nvarchar(1000)
declare @xOrden nvarchar(140)
declare @sNC nvarchar(10)
declare @sTipoPago nvarchar(1000)
set @sql=''
set @scriterio=''
set @xCriterio=''
set @comilla=''''
set @sTipoPago=''

if @sOrden='Correlativo'
	begin
	set @sOrden= ' #dbtrans.tdocumento '
	set @xOrden= ' #dbtrans1.tdocumento '
 
	end
else if @sOrden='Montos'
	begin
	set @sOrden= ' #dbtrans.nventa'
	set @xOrden= ' #dbtrans1.nventa'

	end 
else if @sOrden='Fechas'
	begin
	set @sOrden= ' year(#DBTRANS.fregistro), month(#DBTRANS.fregistro), day(#DBTRANS.fregistro), #DBTRANS.tdocumento '
	set @xOrden= ' year(#DBTRANS1.fregistro), month(#DBTRANS1.fregistro), day(#DBTRANS1.fregistro), #DBTRANS1.tdocumento '
	end
else
	begin
	set @sOrden= ' #dbtrans.tdocumento '
	set @xOrden= ' #dbtrans1.tdocumento '
	end	
if @tcliente <>'' 
	begin
	  set @scriterio=@scriterio + ' and tcodigocliente like '+@comilla+@tcliente+'%'+@comilla
	  set @xcriterio=@xcriterio + ' and tcodigocliente like '+@comilla+@tcliente+'%'+@comilla

	end

if @tTipoDoc<>''
	begin
	  set @scriterio=@scriterio + ' and ttipodocumento like '+@comilla+@ttipodoc+'%'+@comilla
	 if @flagTipo=0 
		begin
			set @xcriterio=@xcriterio + ' and codigo like '+@comilla+@ttipodoc+'%'+@comilla
		end
	if @flagTipo=1
		begin
			set @xcriterio=@xcriterio + ' and vtipodocumento.codigo like '+@comilla+@ttipodoc+'%'+@comilla
		end
	
	end
if @tEstadoDoc<>''
	begin
	  set @scriterio=@scriterio + ' and mdocumento.testadodocumento like '+@comilla+@testadodoc+'%'+@comilla
	  set @xcriterio=@xcriterio + ' and mnotacredito.testadodocumento like '+@comilla+@testadodoc+'%'+@comilla

	end
	
if @tTipoPago<>''
	begin
--	  set @scriterio=@scriterio + ' AND vtipopago.Codigo like '+@comilla+@tTipoPago+'%'+@comilla
    set @sTipoPago='WHERE #dbtrans.TipoPago = '+@comilla+ @tTipoPago +@comilla+''
	end


if @tCaja<>''
	begin
	  set @scriterio=@scriterio + ' and mdocumento.tcaja like '+@comilla+@tcaja+'%'+@comilla
	  set @xcriterio=@xcriterio + ' and mnotacredito.tcaja like '+@comilla+@tcaja+'%'+@comilla

	end
	CREATE TABLE #DBT (tDocumento varchar(20) collate Modern_Spanish_CI_AS, Cantidad Int) 
	CREATE TABLE #TEMP (fRegistro datetime, tDocumento varchar(20) collate Modern_Spanish_CI_AS, tCodigoCliente nVarchar(5) collate Modern_Spanish_CI_AS, nNeto float, nImpuesto1 float, nImpuesto2 float, nImpuesto3 float, nVenta float, nRecargo float, nDescuento float, tEstadoDocumento varchar(2) collate Modern_Spanish_CI_AS, tTipoDocumento varchar(100) collate Modern_Spanish_CI_AS, TipoPago varchar(50) collate Modern_Spanish_CI_AS, tTemporal varchar(20) collate Modern_Spanish_CI_AS,nNetoSuma float, nImpuestoSuma1 float, nImpuestoSuma2 float, nImpuestoSuma3 float, nVentaSuma float, nRecargoSuma float, nDescuentoSuma float)
	CREATE TABLE #DBTRANS (fRegistro datetime, tDocumento varchar(20) collate Modern_Spanish_CI_AS, tCodigoCliente nVarchar(5) collate Modern_Spanish_CI_AS, nNeto float, nImpuesto1 float, nImpuesto2 float, nImpuesto3 float, nVenta float, nRecargo float, nDescuento float, tEstadoDocumento varchar(2) collate Modern_Spanish_CI_AS, tTipoDocumento varchar(100) collate Modern_Spanish_CI_AS, TipoPago varchar(50) collate Modern_Spanish_CI_AS, tTemporal varchar(20) collate Modern_Spanish_CI_AS,nNetoSuma float, nImpuestoSuma1 float, nImpuestoSuma2 float, nImpuestoSuma3 float, nVentaSuma float, nRecargoSuma float, nDescuentoSuma float)
	CREATE TABLE #DBTRANS1 (fRegistro datetime, tDocumento varchar(20) collate Modern_Spanish_CI_AS, tCodigoCliente nVarchar(5) collate Modern_Spanish_CI_AS, nNeto float, nImpuesto1 float, nImpuesto2 float, nImpuesto3 float, nVenta float, nRecargo float, nDescuento float, tEstadoDocumento varchar(2) collate Modern_Spanish_CI_AS, tTipoDocumento varchar(100) collate Modern_Spanish_CI_AS, TipoPago varchar(50) collate Modern_Spanish_CI_AS, tTemporal varchar(20) collate Modern_Spanish_CI_AS,nNetoSuma float, nImpuestoSuma1 float, nImpuestoSuma2 float, nImpuestoSuma3 float, nVentaSuma float, nRecargoSuma float, nDescuentoSuma float)
	CREATE TABLE #DBTRANS2 (fRegistro datetime, tDocumento varchar(20) collate Modern_Spanish_CI_AS, tCodigoCliente nVarchar(5) collate Modern_Spanish_CI_AS, nNeto float, nImpuesto1 float, nImpuesto2 float, nImpuesto3 float, nVenta float, nRecargo float, nDescuento float, tEstadoDocumento varchar(2) collate Modern_Spanish_CI_AS, tTipoDocumento varchar(100) collate Modern_Spanish_CI_AS, TipoPago varchar(50) collate Modern_Spanish_CI_AS, tTemporal varchar(20) collate Modern_Spanish_CI_AS,nNetoSuma float, nImpuestoSuma1 float, nImpuestoSuma2 float, nImpuestoSuma3 float, nVentaSuma float, nRecargoSuma float, nDescuentoSuma float)
	CREATE TABLE #DBTRANST  (
								tTipoDocumento nvarchar(3) collate Modern_Spanish_CI_AS,
								tSerie nvarchar(20) collate Modern_Spanish_CI_AS,
								tNumero nvarchar(20) collate Modern_Spanish_CI_AS,
								tNumero2 nvarchar(20) collate Modern_Spanish_CI_AS,
								fRegistro nvarchar(30) collate Modern_Spanish_CI_AS,
								tRuc nvarchar(20) collate Modern_Spanish_CI_AS,
								tRazonSocial nvarchar(250) collate Modern_Spanish_CI_AS ,
								tDireccion nvarchar(250)  collate Modern_Spanish_CI_AS, 
								nNeto float, 
								nImpuesto1 float, 
								nImpuesto2 float, 
								nImpuesto3 float, 
								nVenta float, 
								nRecargo float, 
								nDescuento float, 
								tEstado nvarchar(30)  collate Modern_Spanish_CI_AS, 
								tcodigoestado nvarchar(10)  collate Modern_Spanish_CI_AS, 
								tcodigoCliente nvarchar(10)  collate Modern_Spanish_CI_AS )
		
                          declare @nNeto As float
						  declare @nImpuesto1 As float
						  declare @nImpuesto2 As float
						  declare @nImpuesto3 As float
						  declare @nVenta As float
						  declare @nRecargo As float
						  declare @nDescuento As float
						  declare @tdocumento as nvarchar(20)
						  declare @Numero as float
						  declare @incre as float

If @diaContable=0
BEGIN

if @flaganomes=1 
begin 

/**/
--inserta documentos
					if @flagRedondeo=1
					 begin
						if @flagRegVenta=1 
							begin
 							set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago)  ' +
            							  ' select (case when DATEPART(hh,mdocumento.fregistro) >= ' +ltrim(str(@dHour)) + ' then  mdocumento.fRegistro  else   dateadd(day, -1, mdocumento.fRegistro)  end), dbo.MDOCUMENTO.tDocumento as tDocumento, tCodigoCliente, ROUND(nNeto, 2) as Nneto, ROUND(nPrecioImpuesto1, 2) as nImpuesto1, ROUND(nPrecioImpuesto2, 2) as nImpuesto2, ROUND(nPrecioImpuesto3, 2) as nImpuesto3, ROUND(nVenta, 2) as nVenta, ROUND(nRecargo, 2) as nRecargo, ROUND(nDescuento, 2) as ndescuento, tEstadoDocumento, tTipoDocumento, UPPER(dbo.vTipoPago.Descripcion) As TipoPago From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo LEFT JOIN dbo.DPAGODOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoPago ON dbo.vTipoPago.Codigo = dbo.DPAGODOCUMENTO.tTipoPago  ' +
            							  ' where  '+@SFECHA+ ' AND  RegistroVenta=1 and tTipoDocumento <> '+@comilla+ '00'+@comilla+ @sCriterio  + ' order by dbo.MDOCUMENTO.tdocumento'

							end

						if @flagRegVenta=0
							begin

 							set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago)  ' +
            							  ' select (case when DATEPART(hh,mdocumento.fregistro) >= ' +ltrim(str(@dHour)) + ' then  mdocumento.fRegistro  else   dateadd(day, -1, mdocumento.fRegistro)  end), dbo.MDOCUMENTO.tDocumento as tDocumento, tCodigoCliente, ROUND(nNeto, 2) as Nneto, ROUND(nPrecioImpuesto1, 2) as nImpuesto1, ROUND(nPrecioImpuesto2, 2) as nImpuesto2, ROUND(nPrecioImpuesto3, 2) as nImpuesto3, ROUND(nVenta, 2) as nVenta, ROUND(nRecargo, 2) as nRecargo, ROUND(nDescuento, 2) as ndescuento, tEstadoDocumento, tTipoDocumento, UPPER(dbo.vTipoPago.Descripcion) As TipoPago From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo LEFT JOIN dbo.DPAGODOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoPago ON dbo.vTipoPago.Codigo = dbo.DPAGODOCUMENTO.tTipoPago  ' +
            							  ' where  '+@SFECHA+ '   and tTipoDocumento <> '+@comilla+ '00'+@comilla+ @sCriterio  + ' order by dbo.MDOCUMENTO.tdocumento'

							end
					end
					if @flagRedondeo=0
				    begin
						if @flagRegVenta=1	
							begin
							
      							set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago) ' +
              							  ' select (case when DATEPART(hh,mdocumento.fregistro) >= ' +ltrim(str(@dHour)) + ' then  mdocumento.fRegistro  else   dateadd(day, -1, mdocumento.fRegistro)  end), dbo.MDOCUMENTO.tDocumento as tDocumento, tCodigoCliente, nNeto, nPrecioImpuesto1 as nImpuesto1, nPrecioImpuesto2 as nImpuesto2, nPrecioImpuesto3 as nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, UPPER(dbo.vTipoPago.Descripcion) As TipoPago From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo LEFT JOIN dbo.DPAGODOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoPago ON dbo.vTipoPago.Codigo = dbo.DPAGODOCUMENTO.tTipoPago  ' +
              							  ' where  '+ @SFECHA+' AND RegistroVenta=1  and tTipoDocumento <> '+@comilla+ '00'+@comilla + @sCriterio + ' order by dbo.MDOCUMENTO.tdocumento'

							end
						if @flagRegVenta=0
							begin
      							set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago) ' +
              							  ' select (case when DATEPART(hh,mdocumento.fregistro) >= ' +ltrim(str(@dHour)) + ' then  mdocumento.fRegistro  else   dateadd(day, -1, mdocumento.fRegistro)  end), dbo.MDOCUMENTO.tDocumento as tDocumento, tCodigoCliente, nNeto, nPrecioImpuesto1 as nImpuesto1, nPrecioImpuesto2 as nImpuesto2, nPrecioImpuesto3 as nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, UPPER(dbo.vTipoPago.Descripcion) As TipoPago From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo LEFT JOIN dbo.DPAGODOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoPago ON dbo.vTipoPago.Codigo = dbo.DPAGODOCUMENTO.tTipoPago  ' +
              							  ' where ' +@SFECHA+' and tTipoDocumento <> '+@comilla+ '00'+@comilla + @sCriterio + ' order by dbo.MDOCUMENTO.tdocumento'

							end 
					end
					 print @sql
					EXEC sp_executesql @sql
                    Set @sql = ' update #DBTRANS  set TipoPago = '+@comilla+ 'Cortesia'+@comilla+' Where tEstadoDocumento='+@comilla+ '02'+@comilla+' AND TipoPago IS NULL'
					EXEC sp_executesql @sql
					Set @sql = ' update #DBTRANS  set TipoPago = '+@comilla+ ''+@comilla+' Where tEstadoDocumento='+@comilla+ '01'+@comilla+' OR tEstadoDocumento='+@comilla+ '03'+@comilla+' OR tEstadoDocumento='+@comilla+ '04'+@comilla+''    
					EXEC sp_executesql @sql

                 If @tTipoPago = ''
                   BEGIN
							--inserta nota de creditos
							if @flagRedondeo=1
								begin
	  								set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tEstadoDocumento, tTipoDocumento, TipoPago, tTemporal)  ' + 
             									  ' SELECT (case when DATEPART(hh,MNOTACREDITO.fFecha) >= ' +ltrim(str(@dHour)) + ' then  MNOTACREDITO.fFecha  else   dateadd(day, -1, MNOTACREDITO.fFecha)  end)  AS fRegistro, substring(dbo.MNOTACREDITO.tNotaCredito,1,1)+substring(dbo.MNOTACREDITO.tNotaCredito,4,3)+substring(dbo.MNOTACREDITO.tNotaCredito,9,7) AS tDocumento, ROUND(dbo.MNOTACREDITO.nNeto, 2) as nneto, ROUND(dbo.MNOTACREDITO.nImpuesto1, 2) as nimpuesto1, ROUND(dbo.MNOTACREDITO.nImpuesto2, 2) as nimpuesto2, ROUND(dbo.MNOTACREDITO.nImpuesto3, 2) as nimpuesto3, ROUND(dbo.MNOTACREDITO.nVenta, 2) as nventa,  ' + 
            										  ' dbo.MNOTACREDITO.tEstadoDocumento, dbo.vTipoDocumento.Codigo AS tTipoDocumento, '+@comilla+ ' '+@comilla+' As TipoPago, dbo.MNOTACREDITO.tDocumento AS tTemporal  ' + 
   											  ' FROM dbo.MNOTACREDITO LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.MNOTACREDITO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vTipoDocumento ON SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 1, 1) = dbo.vTipoDocumento.Prefijo  ' + 
											  ' where  ' +@SFECHA2 +  @xCriterio + ' order by tdocumento'
								end
							else
								begin
 									set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tEstadoDocumento, tTipoDocumento, TipoPago, tTemporal)  ' + 
												  ' SELECT (case when DATEPART(hh,MNOTACREDITO.fFecha) >= ' +ltrim(str(@dHour)) + ' then  MNOTACREDITO.fFecha  else   dateadd(day, -1, MNOTACREDITO.fFecha)  end)  AS fRegistro, substring(dbo.MNOTACREDITO.tNotaCredito,1,1)+substring(dbo.MNOTACREDITO.tNotaCredito,4,3)+substring(dbo.MNOTACREDITO.tNotaCredito,9,7) AS tDocumento, dbo.MNOTACREDITO.nNeto, dbo.MNOTACREDITO.nImpuesto1, dbo.MNOTACREDITO.nImpuesto2, dbo.MNOTACREDITO.nImpuesto3, dbo.MNOTACREDITO.nVenta,  ' + 
												  ' dbo.MNOTACREDITO.tEstadoDocumento, dbo.vTipoDocumento.Codigo AS tTipoDocumento, '+@comilla+ ' '+@comilla+' As TipoPago, dbo.MNOTACREDITO.tDocumento AS tTemporal  ' + 
												  ' FROM dbo.MNOTACREDITO LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.MNOTACREDITO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vTipoDocumento ON SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 1, 1) = dbo.vTipoDocumento.Prefijo  ' + 
												  ' where  ' +@SFECHA2 + @xCriterio + ' order by tdocumento'
								end
					END	
					
				    PRINT @sql
					EXEC sp_executesql @sql
					
					--CESAR--
						Set @sql= ' INSERT INTO #DBT (tDocumento,Cantidad) Select tdocumento, COUNT(distinct TipoPago) As Cantidad From #DBTRANS GROUP BY tdocumento '	
						EXEC sp_executesql @sql
						Set @sql= ' Insert into #TEMP (tDocumento, fRegistro, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago, tTemporal, nNetoSuma, nImpuestoSuma1, nImpuestoSuma2, nImpuestoSuma3, nVentaSuma, nRecargoSuma, nDescuentoSuma) ' + 
								  ' SELECT DISTINCT dbo.#DBTRANS.tDocumento, dbo.#DBTRANS.fRegistro,dbo.#DBTRANS.tCodigoCliente, dbo.#DBTRANS.nNeto, dbo.#DBTRANS.nImpuesto1,dbo.#DBTRANS.nImpuesto2,dbo.#DBTRANS.nImpuesto3,dbo.#DBTRANS.nVenta,dbo.#DBTRANS.nRecargo,dbo.#DBTRANS.nDescuento,dbo.#DBTRANS.tEstadoDocumento,dbo.#DBTRANS.tTipoDocumento, ' +
								  ' CASE WHEN #DBT.cantidad=1 THEN dbo.#DBTRANS.TipoPago ELSE '+@comilla+ 'VARIOS'+@comilla+' END As TipoPago,dbo.#DBTRANS.tTemporal,dbo.#DBTRANS.nNetoSuma,dbo.#DBTRANS.nImpuestoSuma1,dbo.#DBTRANS.nImpuestoSuma2,dbo.#DBTRANS.nImpuestoSuma3,dbo.#DBTRANS.nVentaSuma,dbo.#DBTRANS.nRecargoSuma,dbo.#DBTRANS.nDescuentoSuma ' +
								  ' FROM dbo.#DBTRANS INNER JOIN #DBT ON dbo.#DBTRANS.tDocumento= #DBT.tDocumento ' + 
								  ' GROUP BY dbo.#DBTRANS.tDocumento, #DBT.cantidad,dbo.#DBTRANS.fRegistro,dbo.#DBTRANS.tCodigoCliente,dbo.#DBTRANS.nNeto, dbo.#DBTRANS.nImpuesto1,dbo.#DBTRANS.nImpuesto2,dbo.#DBTRANS.nImpuesto3,dbo.#DBTRANS.nVenta,dbo.#DBTRANS.nRecargo,dbo.#DBTRANS.nDescuento,dbo.#DBTRANS.tEstadoDocumento,dbo.#DBTRANS.tTipoDocumento,dbo.#DBTRANS.TipoPago,dbo.#DBTRANS.tTemporal,dbo.#DBTRANS.nNetoSuma,dbo.#DBTRANS.nImpuestoSuma1,dbo.#DBTRANS.nImpuestoSuma2,dbo.#DBTRANS.nImpuestoSuma3,dbo.#DBTRANS.nVentaSuma,dbo.#DBTRANS.nRecargoSuma,dbo.#DBTRANS.nDescuentoSuma '
						EXEC sp_executesql @sql	
						Set @sql = 'DELETE FROM #DBTRANS '				
						EXEC sp_executesql @sql
						Set @sql = 'INSERT INTO #DBTRANS SELECT * FROM #TEMP '
                    	EXEC sp_executesql @sql
                    
					select @sNc= Codigo from vTipoDocumento where Prefijo='N'

					--Se pone en negativo las notas de crdito
					SET @sql= ' update #DBTRANS set nNeto = nNeto * -1 , nImpuesto1 = nImpuesto1 * -1, nImpuesto2 = nImpuesto2 * -1, nImpuesto3 = nImpuesto3 * -1, nVenta = nVenta * -1 where tTipoDocumento='+@comilla+@sNC+@comilla+ ' and tEstadoDocumento<>'+@comilla+'04'+@comilla
					EXEC sp_executesql @sql
					set @sql= ' update #DBTRANS set tCodigoCliente = dbo.MDOCUMENTO.tCodigoCliente FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.#DBTRANS.tTemporal = dbo.MDOCUMENTO.tDocumento where #DBTRANS.tTipoDocumento='+@comilla+@sNC+@comilla
					EXEC sp_executesql @sql
					   
					--se Pone en cero los anulados
					set @sql= ' update #DBTRANS set nNeto = 0, nImpuesto1 = 0, nImpuesto2 = 0, nImpuesto3 = 0, nVenta = 0, nRecargo = 0, nDescuento = 0 where tEstadoDocumento='+@comilla+'04'+@comilla
					EXEC sp_executesql @sql

					SET @SQL='INSERT INTO #DBTRANS1 SELECT * FROM #DBTRANS ORDER BY ' + @SORDEN
					EXEC sp_executesql @sql
					DELETE FROM #DBTRANS
					SET @SQL='INSERT INTO #DBTRANS SELECT * FROM #DBTRANS1 ORDER BY ' + @XORDEN
					EXEC sp_executesql @sql
					DELETE FROM #DBTRANS1
					set @sql=''
					

					
						set @sql = ' select convert(smalldatetime,ltrim(str(year(fRegistro))) + '+@comilla+ '/'+@comilla+' + ltrim(str(month(fRegistro))) + '+@comilla+ '/'+@comilla+' + ltrim(str(day(fRegistro)))) as Fecha, vTipoDocumento.Sunat, ' +
      							   ' Min(tDocumento) as Minimo, Max(tDocumento) as Maximo, sum(nNeto) as Neto, sum(nImpuesto1) as Impuesto1, sum(nImpuesto2) as Impuesto2 , sum(nImpuesto3) as Impuesto3, sum(nVenta) as Venta, sum(nRecargo-nDescuento) as Descuento ' +
      								   ' from #DBTRANS LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.#DBTRANS.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + @sTipoPago + ' ' +
       							   ' Group by convert(smalldatetime,ltrim(str(year(fRegistro))) + '+@comilla+ '/'+@comilla+' + ltrim(str(month(fRegistro))) + '+@comilla+ '/'+@comilla+' + ltrim(str(day(fRegistro)))), vTipoDocumento.Sunat '
 
				


					--print len(@sql)
					EXEC sp_executesql @sql

end

---------------------------------- REGISTRO DE VENTAS CORRELATIVO DOCUMENTOS --

if @flaganomes=0
begin
if @flagTipo=0
	begin
--inserta documentos
					if @flagRedondeo=1
					 begin
						if @flagRegVenta=1 
							begin
 							set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago)  ' +
            						  ' select dbo.MDOCUMENTO.fRegistro, dbo.MDOCUMENTO.tDocumento as tDocumento, tCodigoCliente, ROUND(nNeto, 2) as Nneto, ROUND(nPrecioImpuesto1, 2) as nImpuesto1, ROUND(nPrecioImpuesto2, 2) as nImpuesto2, ROUND(nPrecioImpuesto3, 2) as nImpuesto3, ROUND(nVenta, 2) as nVenta, ROUND(nRecargo, 2) as nRecargo, ROUND(nDescuento, 2) as ndescuento, tEstadoDocumento, tTipoDocumento, UPPER(dbo.vTipoPago.Descripcion) As TipoPago From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo LEFT JOIN dbo.DPAGODOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoPago ON dbo.vTipoPago.Codigo = dbo.DPAGODOCUMENTO.tTipoPago  ' +
            						  ' where RegistroVenta=1 and dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ' and tTipoDocumento <> '+@comilla+ '00'+@comilla+ @sCriterio  + ' order by dbo.MDOCUMENTO.tdocumento'	
							
							end

						if @flagRegVenta=0
							begin

 							set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago)  ' +
            						  ' select dbo.MDOCUMENTO.fRegistro, dbo.MDOCUMENTO.tDocumento as tDocumento, tCodigoCliente, ROUND(nNeto, 2) as Nneto, ROUND(nPrecioImpuesto1, 2) as nImpuesto1, ROUND(nPrecioImpuesto2, 2) as nImpuesto2, ROUND(nPrecioImpuesto3, 2) as nImpuesto3, ROUND(nVenta, 2) as nVenta, ROUND(nRecargo, 2) as nRecargo, ROUND(nDescuento, 2) as ndescuento, tEstadoDocumento, tTipoDocumento, UPPER(dbo.vTipoPago.Descripcion) As TipoPago From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo LEFT JOIN dbo.DPAGODOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoPago ON dbo.vTipoPago.Codigo = dbo.DPAGODOCUMENTO.tTipoPago  ' +
            						  ' where dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ' and tTipoDocumento <> '+@comilla+ '00'+@comilla+ @sCriterio  + ' order by dbo.MDOCUMENTO.tdocumento'

							end
					end
					if @flagRedondeo=0
				    begin
						if @flagRegVenta=1	
							begin
							
      							set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago) ' +
              							  ' select dbo.MDOCUMENTO.fRegistro, dbo.MDOCUMENTO.tDocumento as tDocumento, tCodigoCliente, nNeto, nPrecioImpuesto1 as nImpuesto1, nPrecioImpuesto2 as nImpuesto2, nPrecioImpuesto3 as nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, UPPER(dbo.vTipoPago.Descripcion) As TipoPago From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo LEFT JOIN dbo.DPAGODOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoPago ON dbo.vTipoPago.Codigo = dbo.DPAGODOCUMENTO.tTipoPago  ' +
              							  ' where RegistroVenta=1 and dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ' and tTipoDocumento <> '+@comilla+ '00'+@comilla + @sCriterio + ' order by dbo.MDOCUMENTO.tdocumento'

							end
						if @flagRegVenta=0
							begin
      							set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago) ' +
              							  ' select dbo.MDOCUMENTO.fRegistro, dbo.MDOCUMENTO.tDocumento as tDocumento, tCodigoCliente, nNeto, nPrecioImpuesto1 as nImpuesto1, nPrecioImpuesto2 as nImpuesto2, nPrecioImpuesto3 as nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, UPPER(dbo.vTipoPago.Descripcion) As TipoPago From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo LEFT JOIN dbo.DPAGODOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoPago ON dbo.vTipoPago.Codigo = dbo.DPAGODOCUMENTO.tTipoPago  ' +
              							  ' where dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ' and tTipoDocumento <> '+@comilla+ '00'+@comilla + @sCriterio + ' order by dbo.MDOCUMENTO.tDocumento'

							end 
					end
					--print @sql
					EXEC sp_executesql @sql
                    Set @sql = ' update #DBTRANS  set TipoPago = '+@comilla+ 'CORTESIA'+@comilla+' Where tEstadoDocumento='+@comilla+ '02'+@comilla+' AND TipoPago IS NULL'
					EXEC sp_executesql @sql
					Set @sql = ' update #DBTRANS  set TipoPago = '+@comilla+ ''+@comilla+' Where tEstadoDocumento='+@comilla+ '01'+@comilla+' OR tEstadoDocumento='+@comilla+ '03'+@comilla+' OR tEstadoDocumento='+@comilla+ '04'+@comilla+''    
					EXEC sp_executesql @sql	


                 If @tTipoPago = ''
                   BEGIN
						--inserta nota de creditos
						if @flagRedondeo=1
							begin
	  							set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tEstadoDocumento, tTipoDocumento, TipoPago, tTemporal)  ' + 
             								  ' SELECT dbo.MNOTACREDITO.fFecha AS fRegistro, substring(dbo.MNOTACREDITO.tNotaCredito,1,1)+substring(dbo.MNOTACREDITO.tNotaCredito,4,3)+substring(dbo.MNOTACREDITO.tNotaCredito,9,7) AS tDocumento, ROUND(dbo.MNOTACREDITO.nNeto, 2) as nneto, ROUND(dbo.MNOTACREDITO.nImpuesto1, 2) as nimpuesto1, ROUND(dbo.MNOTACREDITO.nImpuesto2, 2) as nimpuesto2, ROUND(dbo.MNOTACREDITO.nImpuesto3, 2) as nimpuesto3, ROUND(dbo.MNOTACREDITO.nVenta, 2) as nventa,  ' + 
            									  ' dbo.MNOTACREDITO.tEstadoDocumento, dbo.vTipoDocumento.Codigo AS tTipoDocumento, '+@comilla+ ' '+@comilla+' As TipoPago, dbo.MNOTACREDITO.tDocumento AS tTemporal  ' + 
   										  ' FROM dbo.MNOTACREDITO LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.MNOTACREDITO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vTipoDocumento ON SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 1, 1) = dbo.vTipoDocumento.Prefijo  ' + 
										  ' where MNOTACREDITO.fFecha >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and MNOTACREDITO.fFecha <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + @xCriterio + ' order by tdocumento'
							end
						else
							begin
 								set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tEstadoDocumento, tTipoDocumento, TipoPago, tTemporal)  ' + 
											  ' SELECT dbo.MNOTACREDITO.fFecha AS fRegistro, substring(dbo.MNOTACREDITO.tNotaCredito,1,1)+substring(dbo.MNOTACREDITO.tNotaCredito,4,3)+substring(dbo.MNOTACREDITO.tNotaCredito,9,7) AS tDocumento, dbo.MNOTACREDITO.nNeto, dbo.MNOTACREDITO.nImpuesto1, dbo.MNOTACREDITO.nImpuesto2, dbo.MNOTACREDITO.nImpuesto3, dbo.MNOTACREDITO.nVenta,  ' + 
											  ' dbo.MNOTACREDITO.tEstadoDocumento, dbo.vTipoDocumento.Codigo AS tTipoDocumento, '+@comilla+ ' '+@comilla+' As TipoPago, dbo.MNOTACREDITO.tDocumento AS tTemporal  ' + 
											  ' FROM dbo.MNOTACREDITO LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.MNOTACREDITO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vTipoDocumento ON SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 1, 1) = dbo.vTipoDocumento.Prefijo  ' + 
											  ' where MNOTACREDITO.fFecha >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and MNOTACREDITO.fFecha <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + @xCriterio + ' order by tdocumento'
							end
						
					END
					
					PRINT @sql
					EXEC sp_executesql @sql
					
						--CESAR--
						Set @sql= ' INSERT INTO #DBT (tDocumento,Cantidad) Select tdocumento, COUNT(distinct TipoPago) As Cantidad From #DBTRANS GROUP BY tdocumento '	
						EXEC sp_executesql @sql
						Set @sql= ' Insert into #TEMP (tDocumento, fRegistro, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago, tTemporal, nNetoSuma, nImpuestoSuma1, nImpuestoSuma2, nImpuestoSuma3, nVentaSuma, nRecargoSuma, nDescuentoSuma) ' + 
								  ' SELECT DISTINCT dbo.#DBTRANS.tDocumento, dbo.#DBTRANS.fRegistro,dbo.#DBTRANS.tCodigoCliente, dbo.#DBTRANS.nNeto, dbo.#DBTRANS.nImpuesto1,dbo.#DBTRANS.nImpuesto2,dbo.#DBTRANS.nImpuesto3,dbo.#DBTRANS.nVenta,dbo.#DBTRANS.nRecargo,dbo.#DBTRANS.nDescuento,dbo.#DBTRANS.tEstadoDocumento,dbo.#DBTRANS.tTipoDocumento, ' +
								  ' CASE WHEN #DBT.Cantidad=1 THEN dbo.#DBTRANS.TipoPago ELSE '+@comilla+ 'VARIOS'+@comilla+' END As TipoPago,dbo.#DBTRANS.tTemporal,dbo.#DBTRANS.nNetoSuma,dbo.#DBTRANS.nImpuestoSuma1,dbo.#DBTRANS.nImpuestoSuma2,dbo.#DBTRANS.nImpuestoSuma3,dbo.#DBTRANS.nVentaSuma,dbo.#DBTRANS.nRecargoSuma,dbo.#DBTRANS.nDescuentoSuma ' +
								  ' FROM dbo.#DBTRANS INNER JOIN #DBT ON dbo.#DBTRANS.tDocumento= #DBT.tDocumento ' + 
								  ' GROUP BY dbo.#DBTRANS.tDocumento, #DBT.cantidad,dbo.#DBTRANS.fRegistro,dbo.#DBTRANS.tCodigoCliente,dbo.#DBTRANS.nNeto, dbo.#DBTRANS.nImpuesto1,dbo.#DBTRANS.nImpuesto2,dbo.#DBTRANS.nImpuesto3,dbo.#DBTRANS.nVenta,dbo.#DBTRANS.nRecargo,dbo.#DBTRANS.nDescuento,dbo.#DBTRANS.tEstadoDocumento,dbo.#DBTRANS.tTipoDocumento,dbo.#DBTRANS.TipoPago,dbo.#DBTRANS.tTemporal,dbo.#DBTRANS.nNetoSuma,dbo.#DBTRANS.nImpuestoSuma1,dbo.#DBTRANS.nImpuestoSuma2,dbo.#DBTRANS.nImpuestoSuma3,dbo.#DBTRANS.nVentaSuma,dbo.#DBTRANS.nRecargoSuma,dbo.#DBTRANS.nDescuentoSuma '
						EXEC sp_executesql @sql	
						Set @sql = 'DELETE FROM #DBTRANS '				
						EXEC sp_executesql @sql
						Set @sql = 'INSERT INTO #DBTRANS SELECT * FROM #TEMP '
                    	EXEC sp_executesql @sql
                    	
                    

					select @sNc= Codigo from vTipoDocumento where Prefijo='N'

					--Se pone en negativo las notas de crdito
					SET @sql= ' update #DBTRANS set nNeto = nNeto * -1 , nImpuesto1 = nImpuesto1 * -1, nImpuesto2 = nImpuesto2 * -1, nImpuesto3 = nImpuesto3 * -1, nVenta = nVenta * -1 where tTipoDocumento='+@comilla+@sNC+@comilla+ ' and tEstadoDocumento<>'+@comilla+'04'+@comilla
					EXEC sp_executesql @sql
					set @sql= ' update #DBTRANS set tCodigoCliente = dbo.MDOCUMENTO.tCodigoCliente FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.#DBTRANS.tTemporal = dbo.MDOCUMENTO.tDocumento where #DBTRANS.tTipoDocumento='+@comilla+@sNC+@comilla
					EXEC sp_executesql @sql
					   
					--se Pone en cero los anulados
					set @sql= ' update #DBTRANS set nNeto = 0, nImpuesto1 = 0, nImpuesto2 = 0, nImpuesto3 = 0, nVenta = 0, nRecargo = 0, nDescuento = 0 where tEstadoDocumento='+@comilla+'04'+@comilla
					EXEC sp_executesql @sql

					SET @SQL='INSERT INTO #DBTRANS1 SELECT * FROM #DBTRANS ORDER BY ' + @SORDEN
					EXEC sp_executesql @sql
					DELETE FROM #DBTRANS
					SET @SQL='INSERT INTO #DBTRANS SELECT * FROM #DBTRANS1 ORDER BY ' + @XORDEN
					EXEC sp_executesql @sql
					DELETE FROM #DBTRANS1
					set @sql=''
					if @flagCorrelativo=1 
					begin
						  
						  set @numero=0
						  set @incre=0
						  set @nNeto=0
						  set @nImpuesto1=0
						  set @nImpuesto2=0
						  set @nImpuesto3=0
						  set @nVenta=0
						  set @nRecargo=0
						  set @nDescuento= 0		
						  select @numero=count(*) from #dbtrans
						if @numero<>0
							begin
										set @sql=' insert into #dbtrans1 select * from #dbtrans order by '+@sorden
										EXEC sp_executesql @sql
										delete from #dbtrans
										set @sql=' insert into #dbtrans2 select top 1 * from #dbtrans1 order by ' + @xOrden
										EXEC sp_executesql @sql

										select @tdocumento=tdocumento from #dbtrans2
										set @sql=' delete from #dbtrans1 where tdocumento='+@comilla+@tdocumento+@comilla
										EXEC sp_executesql @sql
											set @sql=' update #dbtrans2 set nNetosuma = ' +ltrim(cast(@nNeto as nvarchar)) + ', nimpuestosuma1 =' +ltrim(cast(@nIMpuesto1 as nvarchar)) + ', nimpuestosuma2='+ltrim(cast(@nimpuesto2 as nvarchar))+',nImpuestosuma3='+ltrim(cast(@nimpuesto3 as nvarchar)) +
												 ', nVentaSuma ='+ltrim(cast(@nVenta as nvarchar))+',nrecargoSuma='+ltrim(cast(@nRecargo as nvarchar))+',ndescuentosuma='+ltrim(cast(@nDescuento as nvarchar))+ ' where tdocumento='+@comilla+@tdocumento+@comilla
										EXEC sp_executesql @sql
										insert into #dbtrans select * from #dbtrans2

										select @nneto=@nneto+ isnull(nneto,0),@nimpuesto1=@nimpuesto1+isnull(nimpuesto1,0),@nimpuesto2=@nimpuesto2+isnull(nimpuesto2,0),@nimpuesto3=@nimpuesto3+isnull(nimpuesto3,0),@nventa=@nventa+isnull(nventa,0),@nrecargo=@nrecargo+isnull(nrecargo,0),@ndescuento=@ndescuento+ isnull(ndescuento,0) from #dbtrans2				 		

										SET @SQL='DELETE FROM #DBTRANS2 WHERE TDOCUMENTO='+@COMILLA+@Tdocumento+@comilla
										exec sp_executesql @sql

										select @numero=count(*) from #dbtrans1
										while @incre<=@numero
											begin
												set @sql=' insert into #dbtrans2 select top 1 * from #dbtrans1 order by '+@xorden
												EXEC sp_executesql @sql
												select @tdocumento=tdocumento from #dbtrans2
												set @sql=' delete from #dbtrans1 where tdocumento='+@comilla+@tdocumento+@comilla
												EXEC sp_executesql @sql
  												set @sql=' update #dbtrans2 set nNetosuma = ' +ltrim(cast(@nneto as nvarchar)) + ', nimpuestosuma1 =' +ltrim(cast(@nIMpuesto1 as nvarchar)) + ', nimpuestosuma2='+ltrim(cast(@nimpuesto2 as nvarchar))+',nImpuestosuma3='+ltrim(cast(@nimpuesto3 as nvarchar)) +
												 ', nVentaSuma ='+ltrim(cast(@nVenta as nvarchar))+',nrecargoSuma='+ltrim(cast(@nRecargo as nvarchar))+',ndescuentosuma='+ltrim(cast(@nDescuento as nvarchar))+ ' where tdocumento='+@comilla+@tdocumento+@comilla
												EXEC sp_executesql @sql
												insert into #dbtrans select * from #dbtrans2
												 select @nneto=@nneto+isnull(nneto,0),@nimpuesto1=@nimpuesto1+isnull(nimpuesto1,0),@nimpuesto2=@nimpuesto2+isnull(nimpuesto2,0),@nimpuesto3=@nimpuesto3+ isnull(nimpuesto3,0),@nventa=@nventa+ isnull(nventa,0),@nrecargo=@nrecargo+isnull(nrecargo,0),@ndescuento=@ndescuento+isnull(ndescuento,0) from #dbtrans2				 		
												SET @SQL='DELETE FROM #DBTRANS2 WHERE TDOCUMENTO='+@COMILLA+@Tdocumento+@comilla
												exec sp_executesql @sql
												set @incre=@incre+1
											end
									SET @SQL='INSERT INTO #DBTRANS1 SELECT * FROM #DBTRANS ORDER BY ' + @SORDEN
									EXEC sp_executesql @sql
									DELETE FROM #DBTRANS
									SET @SQL='INSERT INTO #DBTRANS SELECT * FROM #DBTRANS1 ORDER BY ' + @XORDEN
									EXEC sp_executesql @sql
									DELETE FROM #DBTRANS1
							end
						
						--- CORRELATIVO DOCUMENTO RV-----
						 set @sql = ' SELECT dbo.#DBTRANS.tDocumento, dbo.#DBTRANS.fRegistro As fFecha, dbo.vCliente.tIdentidad, dbo.vCliente.Descripcion, dbo.#DBTRANS.nNeto, dbo.#DBTRANS.nImpuesto1, dbo.#DBTRANS.nImpuesto2, dbo.#DBTRANS.nImpuesto3, dbo.#DBTRANS.nVenta, ' +
        						    ' dbo.#DBTRANS.nRecargo, dbo.#DBTRANS.nDescuento, dbo.#DBTRANS.TipoPago As TipoPago, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.vTipoDocumento.Sunat, dbo.#DBTRANS.nNetoSuma, dbo.#DBTRANS.nImpuestoSuma1, dbo.#DBTRANS.nImpuestoSuma2, dbo.#DBTRANS.nImpuestoSuma3, dbo.#DBTRANS.nVentaSuma, ' +
								    ' dbo.#DBTRANS.nRecargoSuma, dbo.#DBTRANS.nDescuentoSuma FROM dbo.#DBTRANS LEFT JOIN dbo.vTipoDocumento ON dbo.#DBTRANS.tTipoDocumento = dbo.vTipoDocumento.Codigo LEFT OUTER JOIN ' +
								    ' dbo.vEstadoDocumento ON dbo.#DBTRANS.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.tCodigoCliente = dbo.vCliente.Codigo ' + @sTipoPago + ' order by '+@sorden 
	 
					   end          

					if @flagEstado=1
						begin
						--set @sql=  ' SELECT dbo.vEstadoDocumento.Descripcion as Estado, dbo.#DBTRANS.tTipoDocumento as Tipo, COUNT(dbo.#DBTRANS.tDocumento) AS Cantidad, SUM(dbo.#DBTRANS.nNeto) AS Neto, SUM(dbo.#DBTRANS.nImpuesto1) AS Impuesto1,  ' +
  				--				   ' SUM(dbo.#DBTRANS.nImpuesto2) AS Impuesto2, SUM(dbo.#DBTRANS.nImpuesto3) AS Impuesto3, SUM(dbo.#DBTRANS.nVenta) AS Venta, SUM(dbo.#DBTRANS.nRecargo - dbo.#DBTRANS.nDescuento) As Descuento   ' +
      -- 							   ' FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vEstadoDocumento ON dbo.#DBTRANS.tEstadoDocumento = dbo.vEstadoDocumento.Codigo ' + @sTipoPago + ' GROUP BY dbo.vEstadoDocumento.Descripcion, dbo.#DBTRANS.tTipoDocumento '
							   
						--end
						
						set @sql=  ' SELECT dbo.vEstadoDocumento.Descripcion as Estado, dbo.vTipoDocumento.Descripcion as Tipo, COUNT(dbo.#DBTRANS.tDocumento) AS Cantidad, SUM(dbo.#DBTRANS.nNeto) AS Neto, SUM(dbo.#DBTRANS.nImpuesto1) AS Impuesto1,  ' +
  								   ' SUM(dbo.#DBTRANS.nImpuesto2) AS Impuesto2, SUM(dbo.#DBTRANS.nImpuesto3) AS Impuesto3, SUM(dbo.#DBTRANS.nVenta) AS Venta, SUM(dbo.#DBTRANS.nRecargo - dbo.#DBTRANS.nDescuento) As Descuento   ' +
       							   ' FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vEstadoDocumento ON dbo.#DBTRANS.tEstadoDocumento = dbo.vEstadoDocumento.Codigo ' + @sTipoPago + ' LEFT JOIN dbo.vTipoDocumento ON dbo.#DBTRANS.tTipoDocumento = dbo.vTipoDocumento.Codigo GROUP BY dbo.vEstadoDocumento.Descripcion, dbo.vTipoDocumento.Descripcion '
							   
						end

					if @flagAgrupado=1
						begin
						set @sql = ' select convert(smalldatetime,ltrim(str(year(fRegistro))) + '+@comilla+ '/'+@comilla+' + ltrim(str(month(fRegistro))) + '+@comilla+ '/'+@comilla+' + ltrim(str(day(fRegistro)))) as Fecha, vTipoDocumento.Sunat, ' +
      							   ' Min(tDocumento) as Minimo, Max(tDocumento) as Maximo, sum(nNeto) as Neto, sum(nImpuesto1) as Impuesto1, sum(nImpuesto2) as Impuesto2 , sum(nImpuesto3) as Impuesto3, sum(nVenta) as Venta, sum(nRecargo-nDescuento) as Descuento ' +
      								   ' from #DBTRANS LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.#DBTRANS.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + @sTipoPago + ' ' +
       							   ' Group by convert(smalldatetime,ltrim(str(year(fRegistro))) + '+@comilla+ '/'+@comilla+' + ltrim(str(month(fRegistro))) + '+@comilla+ '/'+@comilla+' + ltrim(str(day(fRegistro)))), vTipoDocumento.Sunat '
						end

					--print len(@sql)
					EXEC sp_executesql @sql


	end 
if @flagTipo=1
	begin
--inserta documentos
				if @flagRedondeo=1
						begin
						if @flagRegVenta=1 
							begin
											-- tickets con ruc y facturas detallados
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+', CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') AS Ruc, ISNULL(dbo.vCliente.Descripcion, N'+@comilla+ ''+@comilla+') AS Razon, ISNULL(dbo.vCliente.tDireccion, N'+@comilla+ ''+@comilla+') AS Direccion, round(dbo.MDOCUMENTO.nNeto,2) nneto,  round(dbo.MDOCUMENTO.nPrecioImpuesto1,2) nImpuesto1, round(dbo.MDOCUMENTO.nPrecioImpuesto2,2) nImpuesto2, round(dbo.MDOCUMENTO.nPrecioImpuesto3,2) nImpuesto3, round(dbo.MDOCUMENTO.nVenta,2) nVenta, round(dbo.MDOCUMENTO.nRecargo,2) nRecargo, round(dbo.MDOCUMENTO.nDescuento,2) nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, N'+@comilla+ ''+@comilla+') AS tCodigoCliente ' +
														  ' FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE  (dbo.vTipoDocumento.RegistroVenta = 1) AND (dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND (dbo.MDOCUMENTO.tEstadoDocumento <>'+@comilla+ '04'+@comilla+') AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) > 0) ' +@sCriterio +
														  '	ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro '
											EXEC sp_executesql @sql

											-- tickets sin ruc y boletas acumuladas
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT    dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) as tDocumento, max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))  AS tDocumento2, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, '+@comilla+ ''+@comilla+' AS Ruc, '+@comilla+ ''+@comilla+' AS Razon, '+@comilla+ ''+@comilla+' AS Direccion, SUM(round(dbo.MDOCUMENTO.nNeto,2)) AS nneto, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto1, 2)) AS nImpuesto1, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto2, 2)) AS nImpuesto2, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto3, 2)) AS nImpuesto3, SUM(ROUND(dbo.MDOCUMENTO.nVenta, 2)) AS nVenta, SUM(ROUND(dbo.MDOCUMENTO.nRecargo, 2)) AS nRecargo, SUM(ROUND(dbo.MDOCUMENTO.nDescuento, 2)) AS nDescuento, '+@comilla+ ''+@comilla+', '+@comilla+ ''+@comilla+', '+@comilla+ ''+@comilla+' AS tCodigoCliente ' + 
														  ' FROM   dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE     (dbo.vTipoDocumento.RegistroVenta = 1) AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') = '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) < 11) AND (dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND  (dbo.vTipoDocumento.Sunat <> '+@comilla+ '01'+@comilla+') AND (dbo.MDOCUMENTO.tEstadoDocumento <> '+@comilla+ '04'+@comilla+') ' + @sCriterio +
														  ' GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) ' + 
														  ' ORDER BY dbo.vTipoDocumento.Sunat, Serie, dbo.MDOCUMENTO.fRegistro '
											EXEC sp_executesql @sql

											-- ANULADOS CON RUC detallados
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero, tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+', CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') AS Ruc, ISNULL(dbo.vCliente.Descripcion, N'+@comilla+ ''+@comilla+') AS Razon, ISNULL(dbo.vCliente.tDireccion, N'+@comilla+ ''+@comilla+') AS Direccion, round(dbo.MDOCUMENTO.nNeto,2) nNeto,  round(dbo.MDOCUMENTO.nPrecioImpuesto1,2) nImpuesto1, round(dbo.MDOCUMENTO.nPrecioImpuesto2,2) nImpuesto2, round(dbo.MDOCUMENTO.nPrecioImpuesto3,2) nImpuesto3, round(dbo.MDOCUMENTO.nVenta,2) nVenta, round(dbo.MDOCUMENTO.nRecargo,2) nRecargo, round(dbo.MDOCUMENTO.nDescuento,2) nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, N'+@comilla+ ''+@comilla+') AS tCodigoCliente ' +
														  ' FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE  (dbo.vTipoDocumento.RegistroVenta = 1) AND (dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND (dbo.MDOCUMENTO.tEstadoDocumento = N'+@comilla+ '04'+@comilla+') AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) >0) ' + @sCriterio +
														  '	ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro '

											--print @sql
											EXEC sp_executesql @sql
						
											-- ANULADOS SIN RUC resumidos
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero, tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) '+
														  ' SELECT  dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) as tDocumento, max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))   AS tDocumento2, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, '+@comilla+ ''+@comilla+' AS Ruc, '+@comilla+ ''+@comilla+' AS Razon, '+@comilla+ ''+@comilla+' AS Direccion, SUM(round(dbo.MDOCUMENTO.nNeto,2)) AS NNETO, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto1, 2)) AS nImpuesto1, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto2, 2)) AS nImpuesto2, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto3, 2)) AS nImpuesto3, SUM(ROUND(dbo.MDOCUMENTO.nVenta, 2)) AS nVenta, SUM(ROUND(dbo.MDOCUMENTO.nRecargo, 2)) AS nRecargo, SUM(ROUND(dbo.MDOCUMENTO.nDescuento, 2)) AS nDescuento, '+@comilla+ ''+@comilla+', '+@comilla+ '04'+@comilla+', '+@comilla+ ''+@comilla+' AS tCodigoCliente ' +
														  ' FROM         dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE     (dbo.vTipoDocumento.RegistroVenta = 1) AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') = '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) < 11) AND  (dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND  (dbo.MDOCUMENTO.tEstadoDocumento = N'+@comilla+ '04'+@comilla+') ' + @sCriterio +
														  ' GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103),  dbo.vEstadoDocumento.Descripcion ' + 
														  ' ORDER BY dbo.vTipoDocumento.Sunat, Serie, dbo.MDOCUMENTO.fRegistro	'
											--print @sql
											EXEC sp_executesql @sql		
								
						 end	

						if @flagRegVenta=0
							begin
											-- tickets con ruc y facturas detallados
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero, tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+', CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') AS Ruc, ISNULL(dbo.vCliente.Descripcion, N'+@comilla+ ''+@comilla+') AS Razon, ISNULL(dbo.vCliente.tDireccion, N'+@comilla+ ''+@comilla+') AS Direccion, round(dbo.MDOCUMENTO.nNeto,2) nneto,  round(dbo.MDOCUMENTO.nPrecioImpuesto1,2) nImpuesto1, round(dbo.MDOCUMENTO.nPrecioImpuesto2,2) nImpuesto2, round(dbo.MDOCUMENTO.nPrecioImpuesto3,2) nImpuesto3, round(dbo.MDOCUMENTO.nVenta,2) nVenta, round(dbo.MDOCUMENTO.nRecargo,2) nRecargo, round(dbo.MDOCUMENTO.nDescuento,2) nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, N'+@comilla+ ''+@comilla+') AS tCodigoCliente ' +
														  ' FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE   (dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND (dbo.MDOCUMENTO.tEstadoDocumento <>'+@comilla+ '04'+@comilla+') AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) >0) ' + @sCriterio +
														  '	ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro '
											EXEC sp_executesql @sql

											-- tickets sin ruc y boletas acumuladas
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero, tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT    dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) as tDocumento, max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))  AS tDocumento2, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, '+@comilla+ ''+@comilla+' AS Ruc, '+@comilla+ ''+@comilla+' AS Razon, '+@comilla+ ''+@comilla+' AS Direccion, SUM(round(dbo.MDOCUMENTO.nNeto,2)) AS nneto, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto1, 2)) AS nImpuesto1, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto2, 2)) AS nImpuesto2, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto3, 2)) AS nImpuesto3, SUM(ROUND(dbo.MDOCUMENTO.nVenta, 2)) AS nVenta, SUM(ROUND(dbo.MDOCUMENTO.nRecargo, 2)) AS nRecargo, SUM(ROUND(dbo.MDOCUMENTO.nDescuento, 2)) AS nDescuento, '+@comilla+ ''+@comilla+', '+@comilla+ ''+@comilla+', '+@comilla+ ''+@comilla+' AS tCodigoCliente ' + 
														  ' FROM   dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE      (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') = '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) < 11) AND   (dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND  (dbo.vTipoDocumento.Sunat <> '+@comilla+ '01'+@comilla+') AND (dbo.MDOCUMENTO.tEstadoDocumento <> '+@comilla+ '04'+@comilla+') ' +  @sCriterio + 
														  ' GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) ' + 
														  ' ORDER BY dbo.vTipoDocumento.Sunat, Serie, dbo.MDOCUMENTO.fRegistro '
											EXEC sp_executesql @sql

											-- ANULADOS CON RUC detallados
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+', CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') AS Ruc, ISNULL(dbo.vCliente.Descripcion, N'+@comilla+ ''+@comilla+') AS Razon, ISNULL(dbo.vCliente.tDireccion, N'+@comilla+ ''+@comilla+') AS Direccion, round(dbo.MDOCUMENTO.nNeto,2) nneto,  round(dbo.MDOCUMENTO.nPrecioImpuesto1,2) nImpuesto1, round(dbo.MDOCUMENTO.nPrecioImpuesto2,2) nImpuesto2, round(dbo.MDOCUMENTO.nPrecioImpuesto3,2) nImpuesto3, round(dbo.MDOCUMENTO.nVenta,2) nVenta, round(dbo.MDOCUMENTO.nRecargo,2) nRecargo, round(dbo.MDOCUMENTO.nDescuento,2) nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, N'+@comilla+ ''+@comilla+') AS tCodigoCliente ' +
														  ' FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE   (dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND (dbo.MDOCUMENTO.tEstadoDocumento = N'+@comilla+ '04'+@comilla+') AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) >0) ' + @sCriterio +
														  '	ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro '

											--print @sql
											EXEC sp_executesql @sql
						
											-- ANULADOS SIN RUC resumidos
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) '+
														  ' SELECT  dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) as tDocumento, max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))  AS tDocumento2, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, '+@comilla+ ''+@comilla+' AS Ruc, '+@comilla+ ''+@comilla+' AS Razon, '+@comilla+ ''+@comilla+' AS Direccion, SUM(round(dbo.MDOCUMENTO.nNeto,2)) AS NNETO, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto1, 2)) AS nImpuesto1, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto2, 2)) AS nImpuesto2, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto3, 2)) AS nImpuesto3, SUM(ROUND(dbo.MDOCUMENTO.nVenta, 2)) AS nVenta, SUM(ROUND(dbo.MDOCUMENTO.nRecargo, 2)) AS nRecargo, SUM(ROUND(dbo.MDOCUMENTO.nDescuento, 2)) AS nDescuento, '+@comilla+ ''+@comilla+', '+@comilla+ '04'+@comilla+', '+@comilla+ ''+@comilla+' AS tCodigoCliente ' +
														  ' FROM         dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE    (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') = '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) < 11) AND  (dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND  (dbo.MDOCUMENTO.tEstadoDocumento = N'+@comilla+ '04'+@comilla+') ' + @sCriterio +
														  ' GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103),  dbo.vEstadoDocumento.Descripcion, dbo.MDOCUMENTO.tEstadoDocumento ' + 
														  ' ORDER BY dbo.vTipoDocumento.Sunat, Serie, dbo.MDOCUMENTO.fRegistro	'
											--print @sql
											EXEC sp_executesql @sql		
										
							end
					end 
					if @flagRedondeo=0
					    begin
						if @flagRegVenta=1	
							begin
										-- tickets con ruc y facturas detallados aqui
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+', CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') AS Ruc, ISNULL(dbo.vCliente.Descripcion, N'+@comilla+ ''+@comilla+') AS Razon, ISNULL(dbo.vCliente.tDireccion, N'+@comilla+ ''+@comilla+') AS Direccion, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1 as  nImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2 nImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3 nImpuesto3, dbo.MDOCUMENTO.nVenta nVenta, dbo.MDOCUMENTO.nRecargo as nRecargo, dbo.MDOCUMENTO.nDescuento as nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, N'+@comilla+ ''+@comilla+') AS tCodigoCliente ' +
														  ' FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE  (dbo.vTipoDocumento.RegistroVenta = 1) AND (dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND (dbo.MDOCUMENTO.tEstadoDocumento <>'+@comilla+ '04'+@comilla+') AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) >0) ' + @sCriterio +																                                  
														  '	ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro '
											EXEC sp_executesql @sql

											-- tickets sin ruc y boletas acumuladas
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT    dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) as tDocumento, max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))  AS tDocumento2, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, '+@comilla+ ''+@comilla+' AS Ruc, '+@comilla+ ''+@comilla+' AS Razon, '+@comilla+ ''+@comilla+' AS Direccion, SUM(dbo.MDOCUMENTO.nNeto) AS nneto, SUM(dbo.MDOCUMENTO.nPrecioImpuesto1) AS nImpuesto1, SUM(dbo.MDOCUMENTO.nPrecioImpuesto2) AS nImpuesto2, SUM(dbo.MDOCUMENTO.nPrecioImpuesto3) AS nImpuesto3, SUM(dbo.MDOCUMENTO.nVenta) AS nVenta, SUM(dbo.MDOCUMENTO.nRecargo) AS nRecargo, SUM(dbo.MDOCUMENTO.nDescuento) AS nDescuento, '+@comilla+ ''+@comilla+', '+@comilla+ ''+@comilla+', '+@comilla+ ''+@comilla+' AS tCodigoCliente ' + 
														  ' FROM   dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE     (dbo.vTipoDocumento.RegistroVenta = 1) AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') = '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) < 11) AND   (dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND  (dbo.vTipoDocumento.Sunat <> '+@comilla+ '01'+@comilla+') AND (dbo.MDOCUMENTO.tEstadoDocumento <> '+@comilla+ '04'+@comilla+') ' + @sCriterio +
														  ' GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) ' + 
														  ' ORDER BY dbo.vTipoDocumento.Sunat, Serie, dbo.MDOCUMENTO.fRegistro '
											
											EXEC sp_executesql @sql

											-- ANULADOS CON RUC detallados
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+', CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') AS Ruc, ISNULL(dbo.vCliente.Descripcion, N'+@comilla+ ''+@comilla+') AS Razon, ISNULL(dbo.vCliente.tDireccion, N'+@comilla+ ''+@comilla+') AS Direccion, dbo.MDOCUMENTO.nNeto,  dbo.MDOCUMENTO.nPrecioImpuesto1 as  nImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2 as  nImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3 as  nImpuesto3, dbo.MDOCUMENTO.nVenta as nVenta, dbo.MDOCUMENTO.nRecargo as nRecargo, dbo.MDOCUMENTO.nDescuento as nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, N'+@comilla+ ''+@comilla+') AS tCodigoCliente ' +
														  ' FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE  (dbo.vTipoDocumento.RegistroVenta = 1) AND (dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND (dbo.MDOCUMENTO.tEstadoDocumento = N'+@comilla+ '04'+@comilla+') AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) >0) ' + @sCriterio +
														  '	ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro '

											
											EXEC sp_executesql @sql
						
											-- ANULADOS SIN RUC resumidos
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) '+
														  ' SELECT  dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) as tDocumento, max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) AS tDocumento2, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, '+@comilla+ ''+@comilla+' AS Ruc, '+@comilla+ ''+@comilla+' AS Razon, '+@comilla+ ''+@comilla+' AS Direccion, SUM(dbo.MDOCUMENTO.nNeto) AS NNETO, SUM(dbo.MDOCUMENTO.nPrecioImpuesto1) AS nImpuesto1, SUM(dbo.MDOCUMENTO.nPrecioImpuesto2) AS nImpuesto2, SUM(dbo.MDOCUMENTO.nPrecioImpuesto3) AS nImpuesto3, SUM(dbo.MDOCUMENTO.nVenta) AS nVenta, SUM(dbo.MDOCUMENTO.nRecargo) AS nRecargo, SUM(dbo.MDOCUMENTO.nDescuento) AS nDescuento, '+@comilla+ ''+@comilla+', '+@comilla+ '04'+@comilla+', '+@comilla+ ''+@comilla+' AS tCodigoCliente ' +
														  ' FROM         dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE     (dbo.vTipoDocumento.RegistroVenta = 1) AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') = '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) < 11) AND  (dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND  (dbo.MDOCUMENTO.tEstadoDocumento = N'+@comilla+ '04'+@comilla+') ' + @sCriterio +
														  ' GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103),  dbo.vEstadoDocumento.Descripcion ' + 
														  ' ORDER BY dbo.vTipoDocumento.Sunat, Serie, dbo.MDOCUMENTO.fRegistro	'
											--print @sql
											EXEC sp_executesql @sql		

													
							end
						if @flagRegVenta=0 
							begin
														-- tickets con ruc y facturas detallados
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+', CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') AS Ruc, ISNULL(dbo.vCliente.Descripcion, N'+@comilla+ ''+@comilla+') AS Razon, ISNULL(dbo.vCliente.tDireccion, N'+@comilla+ ''+@comilla+') AS Direccion, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1 as  nImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2 nImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3 nImpuesto3, dbo.MDOCUMENTO.nVenta nVenta, dbo.MDOCUMENTO.nRecargo as nRecargo, dbo.MDOCUMENTO.nDescuento as nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, N'+@comilla+ ''+@comilla+') AS tCodigoCliente ' +
														  ' FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE   (dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND (dbo.MDOCUMENTO.tEstadoDocumento <>'+@comilla+ '04'+@comilla+') AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) >0) ' + @sCriterio +
														  '	ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro '
											
											EXEC sp_executesql @sql

											-- tickets sin ruc y boletas acumuladas
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT    dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie,min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) as tDocumento, max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))  AS tDocumento2, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, '+@comilla+ ''+@comilla+' AS Ruc, '+@comilla+ ''+@comilla+' AS Razon, '+@comilla+ ''+@comilla+' AS Direccion, SUM(dbo.MDOCUMENTO.nNeto) AS nneto, SUM(dbo.MDOCUMENTO.nPrecioImpuesto1) AS nImpuesto1, SUM(dbo.MDOCUMENTO.nPrecioImpuesto2) AS nImpuesto2, SUM(dbo.MDOCUMENTO.nPrecioImpuesto3) AS nImpuesto3, SUM(dbo.MDOCUMENTO.nVenta) AS nVenta, SUM(dbo.MDOCUMENTO.nRecargo) AS nRecargo, SUM(dbo.MDOCUMENTO.nDescuento) AS nDescuento, '+@comilla+ ''+@comilla+', '+@comilla+ ''+@comilla+', '+@comilla+ ''+@comilla+' AS tCodigoCliente ' + 
														  ' FROM   dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE     (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') = '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) < 11) AND   (dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND  (dbo.vTipoDocumento.Sunat <> '+@comilla+ '01'+@comilla+') AND (dbo.MDOCUMENTO.tEstadoDocumento <> '+@comilla+ '04'+@comilla+') ' + @sCriterio + 
														  ' GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) ' + 
														  ' ORDER BY dbo.vTipoDocumento.Sunat, Serie, dbo.MDOCUMENTO.fRegistro '
											
											EXEC sp_executesql @sql

											-- ANULADOS CON RUC detallados
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+', CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') AS Ruc, ISNULL(dbo.vCliente.Descripcion, N'+@comilla+ ''+@comilla+') AS Razon, ISNULL(dbo.vCliente.tDireccion, N'+@comilla+ ''+@comilla+') AS Direccion, dbo.MDOCUMENTO.nNeto,  dbo.MDOCUMENTO.nPrecioImpuesto1 as  nImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2 as  nImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3 as  nImpuesto3, dbo.MDOCUMENTO.nVenta as nVenta, dbo.MDOCUMENTO.nRecargo as nRecargo, dbo.MDOCUMENTO.nDescuento as nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, N'+@comilla+ ''+@comilla+') AS tCodigoCliente ' +
														  ' FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE   (dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND (dbo.MDOCUMENTO.tEstadoDocumento = N'+@comilla+ '04'+@comilla+') AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) >0) ' + @sCriterio + 
														  '	ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro '

											
											EXEC sp_executesql @sql
						
											-- ANULADOS SIN RUC resumidos
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) '+
														  ' SELECT  dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) as tDocumento, max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) AS tDocumento2, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, '+@comilla+ ''+@comilla+' AS Ruc, '+@comilla+ ''+@comilla+' AS Razon, '+@comilla+ ''+@comilla+' AS Direccion, SUM(dbo.MDOCUMENTO.nNeto) AS NNETO, SUM(dbo.MDOCUMENTO.nPrecioImpuesto1) AS nImpuesto1, SUM(dbo.MDOCUMENTO.nPrecioImpuesto2) AS nImpuesto2, SUM(dbo.MDOCUMENTO.nPrecioImpuesto3) AS nImpuesto3, SUM(dbo.MDOCUMENTO.nVenta) AS nVenta, SUM(dbo.MDOCUMENTO.nRecargo) AS nRecargo, SUM(dbo.MDOCUMENTO.nDescuento) AS nDescuento, '+@comilla+ ''+@comilla+', '+@comilla+ '04'+@comilla+', '+@comilla+ ''+@comilla+' AS tCodigoCliente ' +
														  ' FROM         dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE     (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') = '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) < 11) AND  (dbo.MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fRegistro <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND  (dbo.MDOCUMENTO.tEstadoDocumento = N'+@comilla+ '04'+@comilla+') ' + @sCriterio + 
														  ' GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103),  dbo.vEstadoDocumento.Descripcion ' + 
														  ' ORDER BY dbo.vTipoDocumento.Sunat, Serie, dbo.MDOCUMENTO.fRegistro	'
											
											EXEC sp_executesql @sql		

							end 
						 end
						--INSERTAR NOTA DE CREDITOS
						IF @flagRedondeo=1
							begin
								set @sql= ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero, tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) '+
										  ' SELECT dbo.vTipoDocumento.Sunat AS tTipodocumento, SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 4, 3) AS serie, SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+' , CONVERT(NVARCHAR, dbo.MNOTACREDITO.fFecha, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, '+@comilla+ ''+@comilla+') AS ruc, ISNULL(dbo.vCliente.Descripcion, '+@comilla+ ''+@comilla+') AS razon, ISNULL(dbo.vCliente.tDireccion, '+@comilla+ ''+@comilla+') AS direccion, round(dbo.MNOTACREDITO.nNeto,2) as nneto, round(dbo.MNOTACREDITO.nImpuesto1,2) as nimpuesto1, round(dbo.MNOTACREDITO.nImpuesto2,2) as nImpuesto2, round(dbo.MNOTACREDITO.nImpuesto3,2) as nImpuesto3, round(dbo.MNOTACREDITO.nVenta,2) as nVenta,0 as nrecargo,0 as ndescuento, dbo.vEstadoDocumento.Descripcion AS estado, dbo.MNOTACREDITO.tEstadoDocumento AS testadodocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, '+@comilla+ ''+@comilla+' ) AS tcodigocliente ' + 
										  ' FROM         dbo.vEstadoDocumento RIGHT OUTER JOIN dbo.MNOTACREDITO ON dbo.vEstadoDocumento.Codigo = dbo.MNOTACREDITO.tEstadoDocumento LEFT OUTER JOIN  dbo.vCliente RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.vCliente.Codigo = dbo.MDOCUMENTO.tCodigoCliente ON dbo.MNOTACREDITO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vTipoDocumento ON SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 1, 1) = dbo.vTipoDocumento.Prefijo ' + 
										  ' WHERE     (dbo.MNOTACREDITO.fFecha >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MNOTACREDITO.fFecha <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ' ) ' + @xCriterio + 
										  ' ORDER BY dbo.MNOTACREDITO.fFecha, dbo.MNOTACREDITO.tNotaCredito'
								EXEC sp_executesql @sql		

							end
						if @flagRedondeo=0
							begin
								set @sql= ' inserT into #DBTRANST (tTipoDocumento ,					tSerie ,											tNumero ,											tNumero2,			fRegistro ,													tRuc ,																tRazonSocial  ,															tDireccion ,														 nNeto ,					 nImpuesto1 ,										nImpuesto2 ,								 nImpuesto3 ,					nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) '+
										  ' SELECT dbo.vTipoDocumento.Sunat AS tTipodocumento, SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 4, 3) AS serie, SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+', CONVERT(NVARCHAR, dbo.MNOTACREDITO.fFecha, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, '+@comilla+ ''+@comilla+') AS ruc, ISNULL(dbo.vCliente.Descripcion, '+@comilla+ ''+@comilla+') AS razon, ISNULL(dbo.vCliente.tDireccion, '+@comilla+ ''+@comilla+') AS direccion,dbo.MNOTACREDITO.nNeto as nneto,  dbo.MNOTACREDITO.nImpuesto1  as nimpuesto1,  dbo.MNOTACREDITO.nImpuesto2  as nImpuesto2,  dbo.MNOTACREDITO.nImpuesto3  as nImpuesto3, dbo.MNOTACREDITO.nVenta  as nVenta,0 as nrecargo,0 as ndescuento, dbo.vEstadoDocumento.Descripcion AS estado, dbo.MNOTACREDITO.tEstadoDocumento AS testadodocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, '+@comilla+ ''+@comilla+' ) AS tcodigocliente ' + 
										  ' FROM         dbo.vEstadoDocumento RIGHT OUTER JOIN dbo.MNOTACREDITO ON dbo.vEstadoDocumento.Codigo = dbo.MNOTACREDITO.tEstadoDocumento LEFT OUTER JOIN  dbo.vCliente RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.vCliente.Codigo = dbo.MDOCUMENTO.tCodigoCliente ON dbo.MNOTACREDITO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vTipoDocumento ON SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 1, 1) = dbo.vTipoDocumento.Prefijo ' + 
										  ' WHERE     (dbo.MNOTACREDITO.fFecha >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MNOTACREDITO.fFecha <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ' ) ' + @xCriterio +
										  ' ORDER BY dbo.MNOTACREDITO.fFecha, dbo.MNOTACREDITO.tNotaCredito'
								EXEC sp_executesql @sql		

							end
					--se Pone en cero los anulados
					set @sql= ' update #DBTRANST set nNeto = 0, nImpuesto1 = 0, nImpuesto2 = 0, nImpuesto3 = 0, nVenta = 0, nRecargo = 0, nDescuento = 0 where tcodigoEstado='+@comilla+'04'+@comilla		
					EXEC sp_executesql @sql		

					--Se pone en negativo las notas de crdito
					
					SET @sql= ' update #DBTRANST set nNeto = nNeto * -1 , nImpuesto1 = nImpuesto1 * -1, nImpuesto2 = nImpuesto2 * -1, nImpuesto3 = nImpuesto3 * -1, nVenta = nVenta * -1 where tTipoDocumento='+@comilla+'07'+@comilla+ ' and tCODIGOEstado<>'+@comilla+'04'+@comilla

					EXEC sp_executesql @sql

				--	print @sql
				
					SET @sql=' select tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,ltrim(tRuc) as truc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente from #DBTRANST ' + 
							 ' order by substring(fRegistro,7,4),substring(fRegistro,4,2),substring(fRegistro,1,2), ttipodocumento, tserie '
					EXEC sp_executesql @sql

	end 
  end
end


---DIACONTABLE

If @diaContable=1
BEGIN

if @flaganomes=1 
begin 

--inserta documentos
					if @flagRedondeo=1
					 begin
						if @flagRegVenta=1 
							begin
 							set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago)  ' +
            							  ' select (case when DATEPART(hh,mdocumento.fregistro) >= ' +ltrim(str(@dHour)) + ' then  mdocumento.fRegistro  else   dateadd(day, -1, mdocumento.fRegistro)  end), substring(dbo.MDOCUMENTO.tDocumento,1,1)+substring(dbo.MDOCUMENTO.tDocumento,4,3)+substring(dbo.MDOCUMENTO.tDocumento,9,7) as tDocumento, tCodigoCliente, ROUND(nNeto, 2) as Nneto, ROUND(nPrecioImpuesto1, 2) as nImpuesto1, ROUND(nPrecioImpuesto2, 2) as nImpuesto2, ROUND(nPrecioImpuesto3, 2) as nImpuesto3, ROUND(nVenta, 2) as nVenta, ROUND(nRecargo, 2) as nRecargo, ROUND(nDescuento, 2) as ndescuento, tEstadoDocumento, tTipoDocumento, UPPER(dbo.vTipoPago.Descripcion) As TipoPago From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo LEFT JOIN dbo.DPAGODOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoPago ON dbo.vTipoPago.Codigo = dbo.DPAGODOCUMENTO.tTipoPago  ' +
            							  ' where  '+@SFECHA+ ' AND  RegistroVenta=1 and tTipoDocumento <> '+@comilla+ '00'+@comilla+ @sCriterio  + ' order by dbo.MDOCUMENTO.tdocumento'

							end

						if @flagRegVenta=0
							begin

 							set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago)  ' +
            							  ' select (case when DATEPART(hh,mdocumento.fregistro) >= ' +ltrim(str(@dHour)) + ' then  mdocumento.fRegistro  else   dateadd(day, -1, mdocumento.fRegistro)  end), substring(dbo.MDOCUMENTO.tDocumento,1,1)+substring(dbo.MDOCUMENTO.tDocumento,4,3)+substring(dbo.MDOCUMENTO.tDocumento,9,7) as tDocumento, tCodigoCliente, ROUND(nNeto, 2) as Nneto, ROUND(nPrecioImpuesto1, 2) as nImpuesto1, ROUND(nPrecioImpuesto2, 2) as nImpuesto2, ROUND(nPrecioImpuesto3, 2) as nImpuesto3, ROUND(nVenta, 2) as nVenta, ROUND(nRecargo, 2) as nRecargo, ROUND(nDescuento, 2) as ndescuento, tEstadoDocumento, tTipoDocumento, UPPER(dbo.vTipoPago.Descripcion) As TipoPago From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo LEFT JOIN dbo.DPAGODOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoPago ON dbo.vTipoPago.Codigo = dbo.DPAGODOCUMENTO.tTipoPago  ' +
            							  ' where  '+@SFECHA+ '   and tTipoDocumento <> '+@comilla+ '00'+@comilla+ @sCriterio  + ' order by dbo.MDOCUMENTO.tdocumento'

							end
					end
					if @flagRedondeo=0
				    begin
						if @flagRegVenta=1	
							begin
							
      							set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago) ' +
              							  ' select (case when DATEPART(hh,mdocumento.fregistro) >= ' +ltrim(str(@dHour)) + ' then  mdocumento.fRegistro  else   dateadd(day, -1, mdocumento.fRegistro)  end), substring(dbo.MDOCUMENTO.tDocumento,1,1)+substring(dbo.MDOCUMENTO.tDocumento,4,3)+substring(dbo.MDOCUMENTO.tDocumento,9,7) as tDocumento, tCodigoCliente, nNeto, nPrecioImpuesto1 as nImpuesto1, nPrecioImpuesto2 as nImpuesto2, nPrecioImpuesto3 as nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, UPPER(dbo.vTipoPago.Descripcion) As TipoPago From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo LEFT JOIN dbo.DPAGODOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoPago ON dbo.vTipoPago.Codigo = dbo.DPAGODOCUMENTO.tTipoPago  ' +
              							  ' where  '+ @SFECHA+' AND RegistroVenta=1  and tTipoDocumento <> '+@comilla+ '00'+@comilla + @sCriterio + ' order by dbo.MDOCUMENTO.tdocumento'

							end
						if @flagRegVenta=0
							begin
      							set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago) ' +
              							  ' select (case when DATEPART(hh,mdocumento.fregistro) >= ' +ltrim(str(@dHour)) + ' then  mdocumento.fRegistro  else   dateadd(day, -1, mdocumento.fRegistro)  end), substring(tDocumento,1,1)+substring(tDocumento,4,3)+substring(tDocumento,9,7) as tDocumento, tCodigoCliente, nNeto, nPrecioImpuesto1 as nImpuesto1, nPrecioImpuesto2 as nImpuesto2, nPrecioImpuesto3 as nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, UPPER(dbo.vTipoPago.Descripcion) As TipoPago From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo LEFT JOIN dbo.DPAGODOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoPago ON dbo.vTipoPago.Codigo = dbo.DPAGODOCUMENTO.tTipoPago  ' +
              							  ' where ' +@SFECHA+' and tTipoDocumento <> '+@comilla+ '00'+@comilla + @sCriterio + ' order by dbo.MDOCUMENTO.tdocumento'

							end 
					end
					 print @sql
					EXEC sp_executesql @sql
                    Set @sql = ' update #DBTRANS  set TipoPago = '+@comilla+ 'Cortesia'+@comilla+' Where tEstadoDocumento='+@comilla+ '02'+@comilla+' AND TipoPago IS NULL'
					EXEC sp_executesql @sql
					Set @sql = ' update #DBTRANS  set TipoPago = '+@comilla+ ''+@comilla+' Where tEstadoDocumento='+@comilla+ '01'+@comilla+' OR tEstadoDocumento='+@comilla+ '03'+@comilla+' OR tEstadoDocumento='+@comilla+ '04'+@comilla+''    
					EXEC sp_executesql @sql

                 If @tTipoPago = ''
                   BEGIN
						--inserta nota de creditos
						if @flagRedondeo=1
							begin
  								set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tEstadoDocumento, tTipoDocumento, tTemporal)  ' + 
         									  ' SELECT (case when DATEPART(hh,MNOTACREDITO.fRegistro) >= ' +ltrim(str(@dHour)) + ' then  MNOTACREDITO.fRegistro  else   dateadd(day, -1, MNOTACREDITO.fRegistro)  end)  AS fRegistro, substring(dbo.MNOTACREDITO.tNotaCredito,1,1)+substring(dbo.MNOTACREDITO.tNotaCredito,4,3)+substring(dbo.MNOTACREDITO.tNotaCredito,9,7) AS tDocumento, ROUND(dbo.MNOTACREDITO.nNeto, 2) as nneto, ROUND(dbo.MNOTACREDITO.nImpuesto1, 2) as nimpuesto1, ROUND(dbo.MNOTACREDITO.nImpuesto2, 2) as nimpuesto2, ROUND(dbo.MNOTACREDITO.nImpuesto3, 2) as nimpuesto3, ROUND(dbo.MNOTACREDITO.nVenta, 2) as nventa,  ' + 
        										  ' dbo.MNOTACREDITO.tEstadoDocumento, dbo.vTipoDocumento.Codigo AS tTipoDocumento, dbo.MNOTACREDITO.tDocumento AS tTemporal  ' + 
										  ' FROM dbo.MNOTACREDITO LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.MNOTACREDITO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vTipoDocumento ON SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 1, 1) = dbo.vTipoDocumento.Prefijo  ' + 
										  ' where  ' +@SFECHA2 +  @xCriterio + ' order by tdocumento'
							end
						else
							begin
								set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tEstadoDocumento, tTipoDocumento, tTemporal)  ' + 
											  ' SELECT (case when DATEPART(hh,MNOTACREDITO.fRegistro) >= ' +ltrim(str(@dHour)) + ' then  MNOTACREDITO.fRegistro  else   dateadd(day, -1, MNOTACREDITO.fRegistro)  end)  AS fRegistro, substring(dbo.MNOTACREDITO.tNotaCredito,1,1)+substring(dbo.MNOTACREDITO.tNotaCredito,4,3)+substring(dbo.MNOTACREDITO.tNotaCredito,9,7) AS tDocumento, dbo.MNOTACREDITO.nNeto, dbo.MNOTACREDITO.nImpuesto1, dbo.MNOTACREDITO.nImpuesto2, dbo.MNOTACREDITO.nImpuesto3, dbo.MNOTACREDITO.nVenta,  ' + 
											  ' dbo.MNOTACREDITO.tEstadoDocumento, dbo.vTipoDocumento.Codigo AS tTipoDocumento, dbo.MNOTACREDITO.tDocumento AS tTemporal  ' + 
											  ' FROM dbo.MNOTACREDITO LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.MNOTACREDITO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vTipoDocumento ON SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 1, 1) = dbo.vTipoDocumento.Prefijo  ' + 
											  ' where  ' +@SFECHA2 + @xCriterio + ' order by tdocumento'
							end
					END
				    PRINT @sql
					EXEC sp_executesql @sql

					--CESAR--
						Set @sql= ' INSERT INTO #DBT (tDocumento,Cantidad) Select tdocumento, COUNT(distinct TipoPago) As Cantidad From #DBTRANS GROUP BY tdocumento '	
						EXEC sp_executesql @sql
						Set @sql= ' Insert into #TEMP (tDocumento, fRegistro, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago, tTemporal, nNetoSuma, nImpuestoSuma1, nImpuestoSuma2, nImpuestoSuma3, nVentaSuma, nRecargoSuma, nDescuentoSuma) ' + 
								  ' SELECT DISTINCT dbo.#DBTRANS.tDocumento, dbo.#DBTRANS.fRegistro,dbo.#DBTRANS.tCodigoCliente, dbo.#DBTRANS.nNeto, dbo.#DBTRANS.nImpuesto1,dbo.#DBTRANS.nImpuesto2,dbo.#DBTRANS.nImpuesto3,dbo.#DBTRANS.nVenta,dbo.#DBTRANS.nRecargo,dbo.#DBTRANS.nDescuento,dbo.#DBTRANS.tEstadoDocumento,dbo.#DBTRANS.tTipoDocumento, ' +
								  ' CASE WHEN #DBT.cantidad=1 THEN dbo.#DBTRANS.TipoPago ELSE '+@comilla+ 'VARIOS'+@comilla+' END As TipoPago,dbo.#DBTRANS.tTemporal,dbo.#DBTRANS.nNetoSuma,dbo.#DBTRANS.nImpuestoSuma1,dbo.#DBTRANS.nImpuestoSuma2,dbo.#DBTRANS.nImpuestoSuma3,dbo.#DBTRANS.nVentaSuma,dbo.#DBTRANS.nRecargoSuma,dbo.#DBTRANS.nDescuentoSuma ' +
								  ' FROM dbo.#DBTRANS INNER JOIN #DBT ON dbo.#DBTRANS.tDocumento= #DBT.tDocumento ' + 
								  ' GROUP BY dbo.#DBTRANS.tDocumento, #DBT.cantidad,dbo.#DBTRANS.fRegistro,dbo.#DBTRANS.tCodigoCliente,dbo.#DBTRANS.nNeto, dbo.#DBTRANS.nImpuesto1,dbo.#DBTRANS.nImpuesto2,dbo.#DBTRANS.nImpuesto3,dbo.#DBTRANS.nVenta,dbo.#DBTRANS.nRecargo,dbo.#DBTRANS.nDescuento,dbo.#DBTRANS.tEstadoDocumento,dbo.#DBTRANS.tTipoDocumento,dbo.#DBTRANS.TipoPago,dbo.#DBTRANS.tTemporal,dbo.#DBTRANS.nNetoSuma,dbo.#DBTRANS.nImpuestoSuma1,dbo.#DBTRANS.nImpuestoSuma2,dbo.#DBTRANS.nImpuestoSuma3,dbo.#DBTRANS.nVentaSuma,dbo.#DBTRANS.nRecargoSuma,dbo.#DBTRANS.nDescuentoSuma '
						EXEC sp_executesql @sql	
						Set @sql = 'DELETE FROM #DBTRANS '				
						EXEC sp_executesql @sql
						Set @sql = 'INSERT INTO #DBTRANS SELECT * FROM #TEMP '
                    	EXEC sp_executesql @sql


					select @sNc= Codigo from vTipoDocumento where Prefijo='N'

					--Se pone en negativo las notas de crdito
					SET @sql= ' update #DBTRANS set nNeto = nNeto * -1 , nImpuesto1 = nImpuesto1 * -1, nImpuesto2 = nImpuesto2 * -1, nImpuesto3 = nImpuesto3 * -1, nVenta = nVenta * -1 where tTipoDocumento='+@comilla+@sNC+@comilla+ ' and tEstadoDocumento<>'+@comilla+'04'+@comilla
					EXEC sp_executesql @sql
					set @sql= ' update #DBTRANS set tCodigoCliente = dbo.MDOCUMENTO.tCodigoCliente FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.#DBTRANS.tTemporal = dbo.MDOCUMENTO.tDocumento where #DBTRANS.tTipoDocumento='+@comilla+@sNC+@comilla
					EXEC sp_executesql @sql
					   
					--se Pone en cero los anulados
					set @sql= ' update #DBTRANS set nNeto = 0, nImpuesto1 = 0, nImpuesto2 = 0, nImpuesto3 = 0, nVenta = 0, nRecargo = 0, nDescuento = 0 where tEstadoDocumento='+@comilla+'04'+@comilla
					EXEC sp_executesql @sql

					SET @SQL='INSERT INTO #DBTRANS1 SELECT * FROM #DBTRANS ORDER BY ' + @SORDEN
					EXEC sp_executesql @sql
					DELETE FROM #DBTRANS
					SET @SQL='INSERT INTO #DBTRANS SELECT * FROM #DBTRANS1 ORDER BY ' + @XORDEN
					EXEC sp_executesql @sql
					DELETE FROM #DBTRANS1
					set @sql=''
					

					
						set @sql = ' select convert(smalldatetime,ltrim(str(year(fRegistro))) + '+@comilla+ '/'+@comilla+' + ltrim(str(month(fRegistro))) + '+@comilla+ '/'+@comilla+' + ltrim(str(day(fRegistro)))) as Fecha, vTipoDocumento.Sunat, ' +
      							   ' Min(tDocumento) as Minimo, Max(tDocumento) as Maximo, sum(nNeto) as Neto, sum(nImpuesto1) as Impuesto1, sum(nImpuesto2) as Impuesto2 , sum(nImpuesto3) as Impuesto3, sum(nVenta) as Venta, sum(nRecargo-nDescuento) as Descuento ' +
      								   ' from #DBTRANS LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.#DBTRANS.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + @sTipoPago + ' ' +
       							   ' Group by convert(smalldatetime,ltrim(str(year(fRegistro))) + '+@comilla+ '/'+@comilla+' + ltrim(str(month(fRegistro))) + '+@comilla+ '/'+@comilla+' + ltrim(str(day(fRegistro)))), vTipoDocumento.Sunat '
 
				


					--print len(@sql)
					EXEC sp_executesql @sql

end


---------------------------------- REGISTRO DE VENTAS CORRELATIVO DOCUMENTOS --

if @flaganomes=0
begin
if @flagTipo=0
	begin
--inserta documentos
					if @flagRedondeo=1
					 begin
						if @flagRegVenta=1 
							begin
 							set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago)  ' +
            						  ' select dbo.MDOCUMENTO.fRegistro, substring(dbo.MDOCUMENTO.tDocumento,1,1)+substring(dbo.MDOCUMENTO.tDocumento,4,3)+substring(dbo.MDOCUMENTO.tDocumento,9,7) as tDocumento, tCodigoCliente, ROUND(nNeto, 2) as Nneto, ROUND(nPrecioImpuesto1, 2) as nImpuesto1, ROUND(nPrecioImpuesto2, 2) as nImpuesto2, ROUND(nPrecioImpuesto3, 2) as nImpuesto3, ROUND(nVenta, 2) as nVenta, ROUND(nRecargo, 2) as nRecargo, ROUND(nDescuento, 2) as ndescuento, tEstadoDocumento, tTipoDocumento, UPPER(dbo.vTipoPago.Descripcion) As TipoPago From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo LEFT JOIN dbo.DPAGODOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoPago ON dbo.vTipoPago.Codigo = dbo.DPAGODOCUMENTO.tTipoPago  ' +
            						  ' where RegistroVenta=1 and dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ' and tTipoDocumento <> '+@comilla+ '00'+@comilla+ @sCriterio  + ' order by dbo.MDOCUMENTO.tdocumento'	
							
							end

						if @flagRegVenta=0
							begin

 							set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago)  ' +
            						  ' select dbo.MDOCUMENTO.fRegistro, substring(dbo.MDOCUMENTO.tDocumento,1,1)+substring(dbo.MDOCUMENTO.tDocumento,4,3)+substring(dbo.MDOCUMENTO.tDocumento,9,7) as tDocumento, tCodigoCliente, ROUND(nNeto, 2) as Nneto, ROUND(nPrecioImpuesto1, 2) as nImpuesto1, ROUND(nPrecioImpuesto2, 2) as nImpuesto2, ROUND(nPrecioImpuesto3, 2) as nImpuesto3, ROUND(nVenta, 2) as nVenta, ROUND(nRecargo, 2) as nRecargo, ROUND(nDescuento, 2) as ndescuento, tEstadoDocumento, tTipoDocumento, UPPER(dbo.vTipoPago.Descripcion) As TipoPago From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo LEFT JOIN dbo.DPAGODOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoPago ON dbo.vTipoPago.Codigo = dbo.DPAGODOCUMENTO.tTipoPago  ' +
            						  ' where dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ' and tTipoDocumento <> '+@comilla+ '00'+@comilla+ @sCriterio  + ' order by dbo.MDOCUMENTO.tdocumento'

							end
					end
					if @flagRedondeo=0
				    begin
						if @flagRegVenta=1	
							begin
							
      							set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago) ' +
              							  ' select dbo.MDOCUMENTO.fRegistro, substring(dbo.MDOCUMENTO.tDocumento,1,1)+substring(dbo.MDOCUMENTO.tDocumento,4,3)+substring(dbo.MDOCUMENTO.tDocumento,9,7) as tDocumento, tCodigoCliente, nNeto, nPrecioImpuesto1 as nImpuesto1, nPrecioImpuesto2 as nImpuesto2, nPrecioImpuesto3 as nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, UPPER(dbo.vTipoPago.Descripcion) As TipoPago From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo LEFT JOIN dbo.DPAGODOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoPago ON dbo.vTipoPago.Codigo = dbo.DPAGODOCUMENTO.tTipoPago  ' +
              							  ' where RegistroVenta=1 and dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ' and tTipoDocumento <> '+@comilla+ '00'+@comilla + @sCriterio + ' order by dbo.MDOCUMENTO.tdocumento'

							end
						if @flagRegVenta=0
							begin
      							set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago) ' +
              							  ' select dbo.MDOCUMENTO.fRegistro, substring(dbo.MDOCUMENTO.tDocumento,1,1)+substring(dbo.MDOCUMENTO.tDocumento,4,3)+substring(dbo.MDOCUMENTO.tDocumento,9,7) as tDocumento, tCodigoCliente, nNeto, nPrecioImpuesto1 as nImpuesto1, nPrecioImpuesto2 as nImpuesto2, nPrecioImpuesto3 as nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, UPPER(dbo.vTipoPago.Descripcion) As TipoPago From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo LEFT JOIN dbo.DPAGODOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT JOIN dbo.vTipoPago ON dbo.vTipoPago.Codigo = dbo.DPAGODOCUMENTO.tTipoPago  ' +
              							  ' where dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ' and tTipoDocumento <> '+@comilla+ '00'+@comilla + @sCriterio + ' order by dbo.MDOCUMENTO.tDocumento'

							end 
					end
					--print @sql
					EXEC sp_executesql @sql
                    Set @sql = ' update #DBTRANS  set TipoPago = '+@comilla+ 'CORTESIA'+@comilla+' Where tEstadoDocumento='+@comilla+ '02'+@comilla+' AND TipoPago IS NULL'
					EXEC sp_executesql @sql
					Set @sql = ' update #DBTRANS  set TipoPago = '+@comilla+ ''+@comilla+' Where tEstadoDocumento='+@comilla+ '01'+@comilla+' OR tEstadoDocumento='+@comilla+ '03'+@comilla+' OR tEstadoDocumento='+@comilla+ '04'+@comilla+''    
					EXEC sp_executesql @sql	

                 If @tTipoPago = ''
                   BEGIN
					--inserta nota de creditos
					if @flagRedondeo=1
						begin
	  							set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tEstadoDocumento, tTipoDocumento, TipoPago, tTemporal)  ' + 
             								  ' SELECT dbo.MNOTACREDITO.fFecha AS fRegistro, substring(dbo.MNOTACREDITO.tNotaCredito,1,1)+substring(dbo.MNOTACREDITO.tNotaCredito,4,3)+substring(dbo.MNOTACREDITO.tNotaCredito,9,7) AS tDocumento, ROUND(dbo.MNOTACREDITO.nNeto, 2) as nneto, ROUND(dbo.MNOTACREDITO.nImpuesto1, 2) as nimpuesto1, ROUND(dbo.MNOTACREDITO.nImpuesto2, 2) as nimpuesto2, ROUND(dbo.MNOTACREDITO.nImpuesto3, 2) as nimpuesto3, ROUND(dbo.MNOTACREDITO.nVenta, 2) as nventa,  ' + 
            									  ' dbo.MNOTACREDITO.tEstadoDocumento, dbo.vTipoDocumento.Codigo AS tTipoDocumento, '+@comilla+ ' '+@comilla+' As TipoPago, dbo.MNOTACREDITO.tDocumento AS tTemporal  ' + 
   										  ' FROM dbo.MNOTACREDITO LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.MNOTACREDITO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vTipoDocumento ON SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 1, 1) = dbo.vTipoDocumento.Prefijo  ' + 
										  ' where MNOTACREDITO.fDiaContable >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and MNOTACREDITO.fDiaContable <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + @xCriterio + ' order by tdocumento'
							end
					else
						begin
 								set @sql= ' Insert into #DBTRANS (fRegistro, tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tEstadoDocumento, tTipoDocumento, TipoPago, tTemporal)  ' + 
											  ' SELECT dbo.MNOTACREDITO.fFecha AS fRegistro, substring(dbo.MNOTACREDITO.tNotaCredito,1,1)+substring(dbo.MNOTACREDITO.tNotaCredito,4,3)+substring(dbo.MNOTACREDITO.tNotaCredito,9,7) AS tDocumento, dbo.MNOTACREDITO.nNeto, dbo.MNOTACREDITO.nImpuesto1, dbo.MNOTACREDITO.nImpuesto2, dbo.MNOTACREDITO.nImpuesto3, dbo.MNOTACREDITO.nVenta,  ' + 
											  ' dbo.MNOTACREDITO.tEstadoDocumento, dbo.vTipoDocumento.Codigo AS tTipoDocumento, '+@comilla+ ' '+@comilla+' As TipoPago, dbo.MNOTACREDITO.tDocumento AS tTemporal  ' + 
											  ' FROM dbo.MNOTACREDITO LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.MNOTACREDITO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vTipoDocumento ON SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 1, 1) = dbo.vTipoDocumento.Prefijo  ' + 
											  ' where MNOTACREDITO.fDiaContable >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and MNOTACREDITO.fDiaContable <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + @xCriterio + ' order by tdocumento'
							end
					END
					PRINT @sql
					EXEC sp_executesql @sql

						--CESAR--
						Set @sql= ' INSERT INTO #DBT (tDocumento,Cantidad) Select tdocumento, COUNT(distinct TipoPago) As Cantidad From #DBTRANS GROUP BY tdocumento '	
						EXEC sp_executesql @sql
						Set @sql= ' Insert into #TEMP (tDocumento, fRegistro, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento, TipoPago, tTemporal, nNetoSuma, nImpuestoSuma1, nImpuestoSuma2, nImpuestoSuma3, nVentaSuma, nRecargoSuma, nDescuentoSuma) ' + 
								  ' SELECT DISTINCT dbo.#DBTRANS.tDocumento, dbo.#DBTRANS.fRegistro,dbo.#DBTRANS.tCodigoCliente, dbo.#DBTRANS.nNeto, dbo.#DBTRANS.nImpuesto1,dbo.#DBTRANS.nImpuesto2,dbo.#DBTRANS.nImpuesto3,dbo.#DBTRANS.nVenta,dbo.#DBTRANS.nRecargo,dbo.#DBTRANS.nDescuento,dbo.#DBTRANS.tEstadoDocumento,dbo.#DBTRANS.tTipoDocumento, ' +
								  ' CASE WHEN #DBT.Cantidad=1 THEN dbo.#DBTRANS.TipoPago ELSE '+@comilla+ 'VARIOS'+@comilla+' END As TipoPago,dbo.#DBTRANS.tTemporal,dbo.#DBTRANS.nNetoSuma,dbo.#DBTRANS.nImpuestoSuma1,dbo.#DBTRANS.nImpuestoSuma2,dbo.#DBTRANS.nImpuestoSuma3,dbo.#DBTRANS.nVentaSuma,dbo.#DBTRANS.nRecargoSuma,dbo.#DBTRANS.nDescuentoSuma ' +
								  ' FROM dbo.#DBTRANS INNER JOIN #DBT ON dbo.#DBTRANS.tDocumento= #DBT.tDocumento ' + 
								  ' GROUP BY dbo.#DBTRANS.tDocumento, #DBT.cantidad,dbo.#DBTRANS.fRegistro,dbo.#DBTRANS.tCodigoCliente,dbo.#DBTRANS.nNeto, dbo.#DBTRANS.nImpuesto1,dbo.#DBTRANS.nImpuesto2,dbo.#DBTRANS.nImpuesto3,dbo.#DBTRANS.nVenta,dbo.#DBTRANS.nRecargo,dbo.#DBTRANS.nDescuento,dbo.#DBTRANS.tEstadoDocumento,dbo.#DBTRANS.tTipoDocumento,dbo.#DBTRANS.TipoPago,dbo.#DBTRANS.tTemporal,dbo.#DBTRANS.nNetoSuma,dbo.#DBTRANS.nImpuestoSuma1,dbo.#DBTRANS.nImpuestoSuma2,dbo.#DBTRANS.nImpuestoSuma3,dbo.#DBTRANS.nVentaSuma,dbo.#DBTRANS.nRecargoSuma,dbo.#DBTRANS.nDescuentoSuma '
						EXEC sp_executesql @sql	
						Set @sql = 'DELETE FROM #DBTRANS '				
						EXEC sp_executesql @sql
						Set @sql = 'INSERT INTO #DBTRANS SELECT * FROM #TEMP '
                    	EXEC sp_executesql @sql

					select @sNc= Codigo from vTipoDocumento where Prefijo='N'

					--Se pone en negativo las notas de crdito
					SET @sql= ' update #DBTRANS set nNeto = nNeto * -1 , nImpuesto1 = nImpuesto1 * -1, nImpuesto2 = nImpuesto2 * -1, nImpuesto3 = nImpuesto3 * -1, nVenta = nVenta * -1 where tTipoDocumento='+@comilla+@sNC+@comilla+ ' and tEstadoDocumento<>'+@comilla+'04'+@comilla
					EXEC sp_executesql @sql
					set @sql= ' update #DBTRANS set tCodigoCliente = dbo.MDOCUMENTO.tCodigoCliente FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.#DBTRANS.tTemporal = dbo.MDOCUMENTO.tDocumento where #DBTRANS.tTipoDocumento='+@comilla+@sNC+@comilla
					EXEC sp_executesql @sql
					   
					--se Pone en cero los anulados
					set @sql= ' update #DBTRANS set nNeto = 0, nImpuesto1 = 0, nImpuesto2 = 0, nImpuesto3 = 0, nVenta = 0, nRecargo = 0, nDescuento = 0 where tEstadoDocumento='+@comilla+'04'+@comilla
					EXEC sp_executesql @sql

					SET @SQL='INSERT INTO #DBTRANS1 SELECT * FROM #DBTRANS ORDER BY ' + @SORDEN
					EXEC sp_executesql @sql
					DELETE FROM #DBTRANS
					SET @SQL='INSERT INTO #DBTRANS SELECT * FROM #DBTRANS1 ORDER BY ' + @XORDEN
					EXEC sp_executesql @sql
					DELETE FROM #DBTRANS1
					set @sql=''
					if @flagCorrelativo=1 
					begin
						  
						  set @numero=0
						  set @incre=0
						  set @nNeto=0
						  set @nImpuesto1=0
						  set @nImpuesto2=0
						  set @nImpuesto3=0
						  set @nVenta=0
						  set @nRecargo=0
						  set @nDescuento= 0		
						  select @numero=count(*) from #dbtrans
						if @numero<>0
							begin
										set @sql=' insert into #dbtrans1 select * from #dbtrans order by '+@sorden
										EXEC sp_executesql @sql
										delete from #dbtrans
										set @sql=' insert into #dbtrans2 select top 1 * from #dbtrans1 order by ' + @xOrden
										EXEC sp_executesql @sql

										select @tdocumento=tdocumento from #dbtrans2
										set @sql=' delete from #dbtrans1 where tdocumento='+@comilla+@tdocumento+@comilla
										EXEC sp_executesql @sql
											set @sql=' update #dbtrans2 set nNetosuma = ' +ltrim(cast(@nNeto as nvarchar)) + ', nimpuestosuma1 =' +ltrim(cast(@nIMpuesto1 as nvarchar)) + ', nimpuestosuma2='+ltrim(cast(@nimpuesto2 as nvarchar))+',nImpuestosuma3='+ltrim(cast(@nimpuesto3 as nvarchar)) +
												 ', nVentaSuma ='+ltrim(cast(@nVenta as nvarchar))+',nrecargoSuma='+ltrim(cast(@nRecargo as nvarchar))+',ndescuentosuma='+ltrim(cast(@nDescuento as nvarchar))+ ' where tdocumento='+@comilla+@tdocumento+@comilla
										EXEC sp_executesql @sql
										insert into #dbtrans select * from #dbtrans2

										select @nneto=@nneto+ isnull(nneto,0),@nimpuesto1=@nimpuesto1+isnull(nimpuesto1,0),@nimpuesto2=@nimpuesto2+isnull(nimpuesto2,0),@nimpuesto3=@nimpuesto3+isnull(nimpuesto3,0),@nventa=@nventa+isnull(nventa,0),@nrecargo=@nrecargo+isnull(nrecargo,0),@ndescuento=@ndescuento+ isnull(ndescuento,0) from #dbtrans2				 		

										SET @SQL='DELETE FROM #DBTRANS2 WHERE TDOCUMENTO='+@COMILLA+@Tdocumento+@comilla
										exec sp_executesql @sql

										select @numero=count(*) from #dbtrans1
										while @incre<=@numero
											begin
												set @sql=' insert into #dbtrans2 select top 1 * from #dbtrans1 order by '+@xorden
												EXEC sp_executesql @sql
												select @tdocumento=tdocumento from #dbtrans2
												set @sql=' delete from #dbtrans1 where tdocumento='+@comilla+@tdocumento+@comilla
												EXEC sp_executesql @sql
  												set @sql=' update #dbtrans2 set nNetosuma = ' +ltrim(cast(@nneto as nvarchar)) + ', nimpuestosuma1 =' +ltrim(cast(@nIMpuesto1 as nvarchar)) + ', nimpuestosuma2='+ltrim(cast(@nimpuesto2 as nvarchar))+',nImpuestosuma3='+ltrim(cast(@nimpuesto3 as nvarchar)) +
												 ', nVentaSuma ='+ltrim(cast(@nVenta as nvarchar))+',nrecargoSuma='+ltrim(cast(@nRecargo as nvarchar))+',ndescuentosuma='+ltrim(cast(@nDescuento as nvarchar))+ ' where tdocumento='+@comilla+@tdocumento+@comilla
												EXEC sp_executesql @sql
												insert into #dbtrans select * from #dbtrans2
												 select @nneto=@nneto+isnull(nneto,0),@nimpuesto1=@nimpuesto1+isnull(nimpuesto1,0),@nimpuesto2=@nimpuesto2+isnull(nimpuesto2,0),@nimpuesto3=@nimpuesto3+ isnull(nimpuesto3,0),@nventa=@nventa+ isnull(nventa,0),@nrecargo=@nrecargo+isnull(nrecargo,0),@ndescuento=@ndescuento+isnull(ndescuento,0) from #dbtrans2				 		
												SET @SQL='DELETE FROM #DBTRANS2 WHERE TDOCUMENTO='+@COMILLA+@Tdocumento+@comilla
												exec sp_executesql @sql
												set @incre=@incre+1
											end
									SET @SQL='INSERT INTO #DBTRANS1 SELECT * FROM #DBTRANS ORDER BY ' + @SORDEN
									EXEC sp_executesql @sql
									DELETE FROM #DBTRANS
									SET @SQL='INSERT INTO #DBTRANS SELECT * FROM #DBTRANS1 ORDER BY ' + @XORDEN
									EXEC sp_executesql @sql
									DELETE FROM #DBTRANS1
							end
						--set @sql='select * from #dbtrans '
						
						--- CORRELATIVO DOCUMENTO RV-----
						 set @sql = ' SELECT dbo.#DBTRANS.tDocumento, dbo.#DBTRANS.fRegistro As fFecha, dbo.vCliente.tIdentidad, dbo.vCliente.Descripcion, dbo.#DBTRANS.nNeto, dbo.#DBTRANS.nImpuesto1, dbo.#DBTRANS.nImpuesto2, dbo.#DBTRANS.nImpuesto3, dbo.#DBTRANS.nVenta, ' +
        						    ' dbo.#DBTRANS.nRecargo, dbo.#DBTRANS.nDescuento, dbo.#DBTRANS.TipoPago As TipoPago, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.vTipoDocumento.Sunat, dbo.#DBTRANS.nNetoSuma, dbo.#DBTRANS.nImpuestoSuma1, dbo.#DBTRANS.nImpuestoSuma2, dbo.#DBTRANS.nImpuestoSuma3, dbo.#DBTRANS.nVentaSuma, ' +
								    ' dbo.#DBTRANS.nRecargoSuma, dbo.#DBTRANS.nDescuentoSuma FROM dbo.#DBTRANS LEFT JOIN dbo.vTipoDocumento ON dbo.#DBTRANS.tTipoDocumento = dbo.vTipoDocumento.Codigo LEFT OUTER JOIN ' +
								    ' dbo.vEstadoDocumento ON dbo.#DBTRANS.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.tCodigoCliente = dbo.vCliente.Codigo ' + @sTipoPago + ' order by '+@sorden 
	 
					   end                 

					if @flagEstado=1
						begin
						--set @sql=  ' SELECT dbo.vEstadoDocumento.Descripcion as Estado, dbo.#DBTRANS.tTipoDocumento as Tipo, COUNT(dbo.#DBTRANS.tDocumento) AS Cantidad, SUM(dbo.#DBTRANS.nNeto) AS Neto, SUM(dbo.#DBTRANS.nImpuesto1) AS Impuesto1,  ' +
  				--				   ' SUM(dbo.#DBTRANS.nImpuesto2) AS Impuesto2, SUM(dbo.#DBTRANS.nImpuesto3) AS Impuesto3, SUM(dbo.#DBTRANS.nVenta) AS Venta, SUM(dbo.#DBTRANS.nRecargo - dbo.#DBTRANS.nDescuento) As Descuento   ' +
      -- 							   ' FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vEstadoDocumento ON dbo.#DBTRANS.tEstadoDocumento = dbo.vEstadoDocumento.Codigo ' + @sTipoPago + ' GROUP BY dbo.vEstadoDocumento.Descripcion, dbo.#DBTRANS.tTipoDocumento '
							   
						--end
						set @sql=  ' SELECT dbo.vEstadoDocumento.Descripcion as Estado, dbo.vTipoDocumento.Descripcion as Tipo, COUNT(dbo.#DBTRANS.tDocumento) AS Cantidad, SUM(dbo.#DBTRANS.nNeto) AS Neto, SUM(dbo.#DBTRANS.nImpuesto1) AS Impuesto1,  ' +
  								   ' SUM(dbo.#DBTRANS.nImpuesto2) AS Impuesto2, SUM(dbo.#DBTRANS.nImpuesto3) AS Impuesto3, SUM(dbo.#DBTRANS.nVenta) AS Venta, SUM(dbo.#DBTRANS.nRecargo - dbo.#DBTRANS.nDescuento) As Descuento   ' +
       							   ' FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vEstadoDocumento ON dbo.#DBTRANS.tEstadoDocumento = dbo.vEstadoDocumento.Codigo ' + @sTipoPago + ' LEFT JOIN dbo.vTipoDocumento ON dbo.#DBTRANS.tTipoDocumento = dbo.vTipoDocumento.Codigo GROUP BY dbo.vEstadoDocumento.Descripcion, dbo.vTipoDocumento.Descripcion '							   
						end

					if @flagAgrupado=1
						begin
						set @sql = ' select convert(smalldatetime,ltrim(str(year(fRegistro))) + '+@comilla+ '/'+@comilla+' + ltrim(str(month(fRegistro))) + '+@comilla+ '/'+@comilla+' + ltrim(str(day(fRegistro)))) as Fecha, vTipoDocumento.Sunat, ' +
      							   ' Min(tDocumento) as Minimo, Max(tDocumento) as Maximo, sum(nNeto) as Neto, sum(nImpuesto1) as Impuesto1, sum(nImpuesto2) as Impuesto2 , sum(nImpuesto3) as Impuesto3, sum(nVenta) as Venta, sum(nRecargo-nDescuento) as Descuento ' +
      								   ' from #DBTRANS LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.#DBTRANS.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + @sTipoPago + ' ' +
       							   ' Group by convert(smalldatetime,ltrim(str(year(fRegistro))) + '+@comilla+ '/'+@comilla+' + ltrim(str(month(fRegistro))) + '+@comilla+ '/'+@comilla+' + ltrim(str(day(fRegistro)))), vTipoDocumento.Sunat '
						end

					--print len(@sql)
					EXEC sp_executesql @sql


	end 
if @flagTipo=1
	begin

--inserta documentos
				if @flagRedondeo=1
						begin
						if @flagRegVenta=1 
							begin
											-- tickets con ruc y facturas detallados
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+', CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') AS Ruc, ISNULL(dbo.vCliente.Descripcion, N'+@comilla+ ''+@comilla+') AS Razon, ISNULL(dbo.vCliente.tDireccion, N'+@comilla+ ''+@comilla+') AS Direccion, round(dbo.MDOCUMENTO.nNeto,2) nneto,  round(dbo.MDOCUMENTO.nPrecioImpuesto1,2) nImpuesto1, round(dbo.MDOCUMENTO.nPrecioImpuesto2,2) nImpuesto2, round(dbo.MDOCUMENTO.nPrecioImpuesto3,2) nImpuesto3, round(dbo.MDOCUMENTO.nVenta,2) nVenta, round(dbo.MDOCUMENTO.nRecargo,2) nRecargo, round(dbo.MDOCUMENTO.nDescuento,2) nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, N'+@comilla+ ''+@comilla+') AS tCodigoCliente ' +
														  ' FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE  (dbo.vTipoDocumento.RegistroVenta = 1) AND (dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND (dbo.MDOCUMENTO.tEstadoDocumento <>'+@comilla+ '04'+@comilla+') AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) > 0) ' +@sCriterio +
														  '	ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro '
											EXEC sp_executesql @sql

											-- tickets sin ruc y boletas acumuladas
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT    dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) as tDocumento, max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))  AS tDocumento2, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) AS FREGISTRO, '+@comilla+ ''+@comilla+' AS Ruc, '+@comilla+ ''+@comilla+' AS Razon, '+@comilla+ ''+@comilla+' AS Direccion, SUM(round(dbo.MDOCUMENTO.nNeto,2)) AS nneto, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto1, 2)) AS nImpuesto1, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto2, 2)) AS nImpuesto2, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto3, 2)) AS nImpuesto3, SUM(ROUND(dbo.MDOCUMENTO.nVenta, 2)) AS nVenta, SUM(ROUND(dbo.MDOCUMENTO.nRecargo, 2)) AS nRecargo, SUM(ROUND(dbo.MDOCUMENTO.nDescuento, 2)) AS nDescuento, '+@comilla+ ''+@comilla+', '+@comilla+ ''+@comilla+', '+@comilla+ ''+@comilla+' AS tCodigoCliente ' + 
														  ' FROM   dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE     (dbo.vTipoDocumento.RegistroVenta = 1) AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') = '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) < 11) AND (dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND  (dbo.vTipoDocumento.Sunat <> '+@comilla+ '01'+@comilla+') AND (dbo.MDOCUMENTO.tEstadoDocumento <> '+@comilla+ '04'+@comilla+') ' + @sCriterio +
														  ' GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) ' + 
														  ' ORDER BY dbo.vTipoDocumento.Sunat, Serie, dbo.MDOCUMENTO.fRegistro '
											EXEC sp_executesql @sql

											-- ANULADOS CON RUC detallados
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero, tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+', CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') AS Ruc, ISNULL(dbo.vCliente.Descripcion, N'+@comilla+ ''+@comilla+') AS Razon, ISNULL(dbo.vCliente.tDireccion, N'+@comilla+ ''+@comilla+') AS Direccion, round(dbo.MDOCUMENTO.nNeto,2) nNeto,  round(dbo.MDOCUMENTO.nPrecioImpuesto1,2) nImpuesto1, round(dbo.MDOCUMENTO.nPrecioImpuesto2,2) nImpuesto2, round(dbo.MDOCUMENTO.nPrecioImpuesto3,2) nImpuesto3, round(dbo.MDOCUMENTO.nVenta,2) nVenta, round(dbo.MDOCUMENTO.nRecargo,2) nRecargo, round(dbo.MDOCUMENTO.nDescuento,2) nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, N'+@comilla+ ''+@comilla+') AS tCodigoCliente ' +
														  ' FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE  (dbo.vTipoDocumento.RegistroVenta = 1) AND (dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND (dbo.MDOCUMENTO.tEstadoDocumento = N'+@comilla+ '04'+@comilla+') AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) >0) ' + @sCriterio +
														  '	ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro '

											--print @sql
											EXEC sp_executesql @sql
						
											-- ANULADOS SIN RUC resumidos
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero, tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) '+
														  ' SELECT  dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) as tDocumento, max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))   AS tDocumento2, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) AS FREGISTRO, '+@comilla+ ''+@comilla+' AS Ruc, '+@comilla+ ''+@comilla+' AS Razon, '+@comilla+ ''+@comilla+' AS Direccion, SUM(round(dbo.MDOCUMENTO.nNeto,2)) AS NNETO, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto1, 2)) AS nImpuesto1, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto2, 2)) AS nImpuesto2, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto3, 2)) AS nImpuesto3, SUM(ROUND(dbo.MDOCUMENTO.nVenta, 2)) AS nVenta, SUM(ROUND(dbo.MDOCUMENTO.nRecargo, 2)) AS nRecargo, SUM(ROUND(dbo.MDOCUMENTO.nDescuento, 2)) AS nDescuento, '+@comilla+ ''+@comilla+', '+@comilla+ '04'+@comilla+', '+@comilla+ ''+@comilla+' AS tCodigoCliente ' +
														  ' FROM         dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE     (dbo.vTipoDocumento.RegistroVenta = 1) AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') = '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) < 11) AND  (dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND  (dbo.MDOCUMENTO.tEstadoDocumento = N'+@comilla+ '04'+@comilla+') ' + @sCriterio +
														  ' GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103),  dbo.vEstadoDocumento.Descripcion ' + 
														  ' ORDER BY dbo.vTipoDocumento.Sunat, Serie, dbo.MDOCUMENTO.fRegistro	'
											--print @sql
											EXEC sp_executesql @sql		
								
						 end	

						if @flagRegVenta=0
							begin
											-- tickets con ruc y facturas detallados
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero, tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+', CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') AS Ruc, ISNULL(dbo.vCliente.Descripcion, N'+@comilla+ ''+@comilla+') AS Razon, ISNULL(dbo.vCliente.tDireccion, N'+@comilla+ ''+@comilla+') AS Direccion, round(dbo.MDOCUMENTO.nNeto,2) nneto,  round(dbo.MDOCUMENTO.nPrecioImpuesto1,2) nImpuesto1, round(dbo.MDOCUMENTO.nPrecioImpuesto2,2) nImpuesto2, round(dbo.MDOCUMENTO.nPrecioImpuesto3,2) nImpuesto3, round(dbo.MDOCUMENTO.nVenta,2) nVenta, round(dbo.MDOCUMENTO.nRecargo,2) nRecargo, round(dbo.MDOCUMENTO.nDescuento,2) nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, N'+@comilla+ ''+@comilla+') AS tCodigoCliente ' +
														  ' FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE   (dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND (dbo.MDOCUMENTO.tEstadoDocumento <>'+@comilla+ '04'+@comilla+') AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) >0) ' + @sCriterio +
														  '	ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro '
											EXEC sp_executesql @sql

											-- tickets sin ruc y boletas acumuladas
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero, tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT    dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) as tDocumento, max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))  AS tDocumento2, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) AS FREGISTRO, '+@comilla+ ''+@comilla+' AS Ruc, '+@comilla+ ''+@comilla+' AS Razon, '+@comilla+ ''+@comilla+' AS Direccion, SUM(round(dbo.MDOCUMENTO.nNeto,2)) AS nneto, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto1, 2)) AS nImpuesto1, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto2, 2)) AS nImpuesto2, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto3, 2)) AS nImpuesto3, SUM(ROUND(dbo.MDOCUMENTO.nVenta, 2)) AS nVenta, SUM(ROUND(dbo.MDOCUMENTO.nRecargo, 2)) AS nRecargo, SUM(ROUND(dbo.MDOCUMENTO.nDescuento, 2)) AS nDescuento, '+@comilla+ ''+@comilla+', '+@comilla+ ''+@comilla+', '+@comilla+ ''+@comilla+' AS tCodigoCliente ' + 
														  ' FROM   dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE      (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') = '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) < 11) AND   (dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND  (dbo.vTipoDocumento.Sunat <> '+@comilla+ '01'+@comilla+') AND (dbo.MDOCUMENTO.tEstadoDocumento <> '+@comilla+ '04'+@comilla+') ' +  @sCriterio + 
														  ' GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) ' + 
														  ' ORDER BY dbo.vTipoDocumento.Sunat, Serie, dbo.MDOCUMENTO.fRegistro '
											EXEC sp_executesql @sql

											-- ANULADOS CON RUC detallados
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+', CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') AS Ruc, ISNULL(dbo.vCliente.Descripcion, N'+@comilla+ ''+@comilla+') AS Razon, ISNULL(dbo.vCliente.tDireccion, N'+@comilla+ ''+@comilla+') AS Direccion, round(dbo.MDOCUMENTO.nNeto,2) nneto,  round(dbo.MDOCUMENTO.nPrecioImpuesto1,2) nImpuesto1, round(dbo.MDOCUMENTO.nPrecioImpuesto2,2) nImpuesto2, round(dbo.MDOCUMENTO.nPrecioImpuesto3,2) nImpuesto3, round(dbo.MDOCUMENTO.nVenta,2) nVenta, round(dbo.MDOCUMENTO.nRecargo,2) nRecargo, round(dbo.MDOCUMENTO.nDescuento,2) nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, N'+@comilla+ ''+@comilla+') AS tCodigoCliente ' +
														  ' FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE   (dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND (dbo.MDOCUMENTO.tEstadoDocumento = N'+@comilla+ '04'+@comilla+') AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) >0) ' + @sCriterio +
														  '	ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro '

											--print @sql
											EXEC sp_executesql @sql
						
											-- ANULADOS SIN RUC resumidos
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) '+
														  ' SELECT  dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) as tDocumento, max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))  AS tDocumento2, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) AS FREGISTRO, '+@comilla+ ''+@comilla+' AS Ruc, '+@comilla+ ''+@comilla+' AS Razon, '+@comilla+ ''+@comilla+' AS Direccion, SUM(round(dbo.MDOCUMENTO.nNeto,2)) AS NNETO, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto1, 2)) AS nImpuesto1, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto2, 2)) AS nImpuesto2, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto3, 2)) AS nImpuesto3, SUM(ROUND(dbo.MDOCUMENTO.nVenta, 2)) AS nVenta, SUM(ROUND(dbo.MDOCUMENTO.nRecargo, 2)) AS nRecargo, SUM(ROUND(dbo.MDOCUMENTO.nDescuento, 2)) AS nDescuento, '+@comilla+ ''+@comilla+', '+@comilla+ '04'+@comilla+', '+@comilla+ ''+@comilla+' AS tCodigoCliente ' +
														  ' FROM         dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE    (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') = '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) < 11) AND  (dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND  (dbo.MDOCUMENTO.tEstadoDocumento = N'+@comilla+ '04'+@comilla+') ' + @sCriterio +
														  ' GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103),  dbo.vEstadoDocumento.Descripcion, dbo.MDOCUMENTO.tEstadoDocumento ' + 
														  ' ORDER BY dbo.vTipoDocumento.Sunat, Serie, dbo.MDOCUMENTO.fRegistro	'
											--print @sql
											EXEC sp_executesql @sql		
										
							end
					end 
					if @flagRedondeo=0
					    begin
						if @flagRegVenta=1	
							begin
										-- tickets con ruc y facturas detallados aqui
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+', CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') AS Ruc, ISNULL(dbo.vCliente.Descripcion, N'+@comilla+ ''+@comilla+') AS Razon, ISNULL(dbo.vCliente.tDireccion, N'+@comilla+ ''+@comilla+') AS Direccion, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1 as  nImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2 nImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3 nImpuesto3, dbo.MDOCUMENTO.nVenta nVenta, dbo.MDOCUMENTO.nRecargo as nRecargo, dbo.MDOCUMENTO.nDescuento as nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, N'+@comilla+ ''+@comilla+') AS tCodigoCliente ' +
														  ' FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE  (dbo.vTipoDocumento.RegistroVenta = 1) AND (dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND (dbo.MDOCUMENTO.tEstadoDocumento <>'+@comilla+ '04'+@comilla+') AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) >0) ' + @sCriterio +																                                  
														  '	ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro '
											EXEC sp_executesql @sql

											-- tickets sin ruc y boletas acumuladas
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT    dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) as tDocumento, max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))  AS tDocumento2, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) AS FREGISTRO, '+@comilla+ ''+@comilla+' AS Ruc, '+@comilla+ ''+@comilla+' AS Razon, '+@comilla+ ''+@comilla+' AS Direccion, SUM(dbo.MDOCUMENTO.nNeto) AS nneto, SUM(dbo.MDOCUMENTO.nPrecioImpuesto1) AS nImpuesto1, SUM(dbo.MDOCUMENTO.nPrecioImpuesto2) AS nImpuesto2, SUM(dbo.MDOCUMENTO.nPrecioImpuesto3) AS nImpuesto3, SUM(dbo.MDOCUMENTO.nVenta) AS nVenta, SUM(dbo.MDOCUMENTO.nRecargo) AS nRecargo, SUM(dbo.MDOCUMENTO.nDescuento) AS nDescuento, '+@comilla+ ''+@comilla+', '+@comilla+ ''+@comilla+', '+@comilla+ ''+@comilla+' AS tCodigoCliente ' + 
														  ' FROM   dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE     (dbo.vTipoDocumento.RegistroVenta = 1) AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') = '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) < 11) AND   (dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND  (dbo.vTipoDocumento.Sunat <> '+@comilla+ '01'+@comilla+') AND (dbo.MDOCUMENTO.tEstadoDocumento <> '+@comilla+ '04'+@comilla+') ' + @sCriterio +
														  ' GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) ' + 
														  ' ORDER BY dbo.vTipoDocumento.Sunat, Serie, dbo.MDOCUMENTO.fRegistro '
											
											EXEC sp_executesql @sql

											-- ANULADOS CON RUC detallados
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+', CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') AS Ruc, ISNULL(dbo.vCliente.Descripcion, N'+@comilla+ ''+@comilla+') AS Razon, ISNULL(dbo.vCliente.tDireccion, N'+@comilla+ ''+@comilla+') AS Direccion, dbo.MDOCUMENTO.nNeto,  dbo.MDOCUMENTO.nPrecioImpuesto1 as  nImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2 as  nImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3 as  nImpuesto3, dbo.MDOCUMENTO.nVenta as nVenta, dbo.MDOCUMENTO.nRecargo as nRecargo, dbo.MDOCUMENTO.nDescuento as nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, N'+@comilla+ ''+@comilla+') AS tCodigoCliente ' +
														  ' FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE  (dbo.vTipoDocumento.RegistroVenta = 1) AND (dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND (dbo.MDOCUMENTO.tEstadoDocumento = N'+@comilla+ '04'+@comilla+') AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) >0) ' + @sCriterio +
														  '	ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro '

											
											EXEC sp_executesql @sql
						
											-- ANULADOS SIN RUC resumidos
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) '+
														  ' SELECT  dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) as tDocumento, max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) AS tDocumento2, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) AS FREGISTRO, '+@comilla+ ''+@comilla+' AS Ruc, '+@comilla+ ''+@comilla+' AS Razon, '+@comilla+ ''+@comilla+' AS Direccion, SUM(dbo.MDOCUMENTO.nNeto) AS NNETO, SUM(dbo.MDOCUMENTO.nPrecioImpuesto1) AS nImpuesto1, SUM(dbo.MDOCUMENTO.nPrecioImpuesto2) AS nImpuesto2, SUM(dbo.MDOCUMENTO.nPrecioImpuesto3) AS nImpuesto3, SUM(dbo.MDOCUMENTO.nVenta) AS nVenta, SUM(dbo.MDOCUMENTO.nRecargo) AS nRecargo, SUM(dbo.MDOCUMENTO.nDescuento) AS nDescuento, '+@comilla+ ''+@comilla+', '+@comilla+ '04'+@comilla+', '+@comilla+ ''+@comilla+' AS tCodigoCliente ' +
														  ' FROM         dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE     (dbo.vTipoDocumento.RegistroVenta = 1) AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') = '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) < 11) AND  (dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND  (dbo.MDOCUMENTO.tEstadoDocumento = N'+@comilla+ '04'+@comilla+') ' + @sCriterio +
														  ' GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103),  dbo.vEstadoDocumento.Descripcion ' + 
														  ' ORDER BY dbo.vTipoDocumento.Sunat, Serie, dbo.MDOCUMENTO.fRegistro	'
											--print @sql
											EXEC sp_executesql @sql		

													
							end
						if @flagRegVenta=0 
							begin
														-- tickets con ruc y facturas detallados
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+', CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') AS Ruc, ISNULL(dbo.vCliente.Descripcion, N'+@comilla+ ''+@comilla+') AS Razon, ISNULL(dbo.vCliente.tDireccion, N'+@comilla+ ''+@comilla+') AS Direccion, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1 as  nImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2 nImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3 nImpuesto3, dbo.MDOCUMENTO.nVenta nVenta, dbo.MDOCUMENTO.nRecargo as nRecargo, dbo.MDOCUMENTO.nDescuento as nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, N'+@comilla+ ''+@comilla+') AS tCodigoCliente ' +
														  ' FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE   (dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND (dbo.MDOCUMENTO.tEstadoDocumento <>'+@comilla+ '04'+@comilla+') AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) >0) ' + @sCriterio +
														  '	ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro '
											
											EXEC sp_executesql @sql

											-- tickets sin ruc y boletas acumuladas
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT    dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie,min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) as tDocumento, max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))  AS tDocumento2, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) AS FREGISTRO, '+@comilla+ ''+@comilla+' AS Ruc, '+@comilla+ ''+@comilla+' AS Razon, '+@comilla+ ''+@comilla+' AS Direccion, SUM(dbo.MDOCUMENTO.nNeto) AS nneto, SUM(dbo.MDOCUMENTO.nPrecioImpuesto1) AS nImpuesto1, SUM(dbo.MDOCUMENTO.nPrecioImpuesto2) AS nImpuesto2, SUM(dbo.MDOCUMENTO.nPrecioImpuesto3) AS nImpuesto3, SUM(dbo.MDOCUMENTO.nVenta) AS nVenta, SUM(dbo.MDOCUMENTO.nRecargo) AS nRecargo, SUM(dbo.MDOCUMENTO.nDescuento) AS nDescuento, '+@comilla+ ''+@comilla+', '+@comilla+ ''+@comilla+', '+@comilla+ ''+@comilla+' AS tCodigoCliente ' + 
														  ' FROM   dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE     (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') = '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) < 11) AND   (dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND  (dbo.vTipoDocumento.Sunat <> '+@comilla+ '01'+@comilla+') AND (dbo.MDOCUMENTO.tEstadoDocumento <> '+@comilla+ '04'+@comilla+') ' + @sCriterio + 
														  ' GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) ' + 
														  ' ORDER BY dbo.vTipoDocumento.Sunat, Serie, dbo.MDOCUMENTO.fRegistro '
											
											EXEC sp_executesql @sql

											-- ANULADOS CON RUC detallados
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) ' +
														  ' SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+', CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') AS Ruc, ISNULL(dbo.vCliente.Descripcion, N'+@comilla+ ''+@comilla+') AS Razon, ISNULL(dbo.vCliente.tDireccion, N'+@comilla+ ''+@comilla+') AS Direccion, dbo.MDOCUMENTO.nNeto,  dbo.MDOCUMENTO.nPrecioImpuesto1 as  nImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2 as  nImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3 as  nImpuesto3, dbo.MDOCUMENTO.nVenta as nVenta, dbo.MDOCUMENTO.nRecargo as nRecargo, dbo.MDOCUMENTO.nDescuento as nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, N'+@comilla+ ''+@comilla+') AS tCodigoCliente ' +
														  ' FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE   (dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND (dbo.MDOCUMENTO.tEstadoDocumento = N'+@comilla+ '04'+@comilla+') AND (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') <> '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) >0) ' + @sCriterio + 
														  '	ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro '

											
											EXEC sp_executesql @sql
						
											-- ANULADOS SIN RUC resumidos
											set @sql=	  ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) '+
														  ' SELECT  dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) as tDocumento, max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) AS tDocumento2, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103) AS FREGISTRO, '+@comilla+ ''+@comilla+' AS Ruc, '+@comilla+ ''+@comilla+' AS Razon, '+@comilla+ ''+@comilla+' AS Direccion, SUM(dbo.MDOCUMENTO.nNeto) AS NNETO, SUM(dbo.MDOCUMENTO.nPrecioImpuesto1) AS nImpuesto1, SUM(dbo.MDOCUMENTO.nPrecioImpuesto2) AS nImpuesto2, SUM(dbo.MDOCUMENTO.nPrecioImpuesto3) AS nImpuesto3, SUM(dbo.MDOCUMENTO.nVenta) AS nVenta, SUM(dbo.MDOCUMENTO.nRecargo) AS nRecargo, SUM(dbo.MDOCUMENTO.nDescuento) AS nDescuento, '+@comilla+ ''+@comilla+', '+@comilla+ '04'+@comilla+', '+@comilla+ ''+@comilla+' AS tCodigoCliente ' +
														  ' FROM         dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo ' + 
														  ' WHERE     (ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+') = '+@comilla+ ''+@comilla+') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, N'+@comilla+ ''+@comilla+')) < 11) AND  (dbo.MDOCUMENTO.fDiaContable >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MDOCUMENTO.fDiaContable <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ') AND  (dbo.MDOCUMENTO.tEstadoDocumento = N'+@comilla+ '04'+@comilla+') ' + @sCriterio + 
														  ' GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fDiaContable, 103),  dbo.vEstadoDocumento.Descripcion ' + 
														  ' ORDER BY dbo.vTipoDocumento.Sunat, Serie, dbo.MDOCUMENTO.fRegistro	'
											
											EXEC sp_executesql @sql		

							end 
						 end
						--INSERTAR NOTA DE CREDITOS
						IF @flagRedondeo=1
							begin
								set @sql= ' inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero, tNumero2, fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) '+
										  ' SELECT dbo.vTipoDocumento.Sunat AS tTipodocumento, SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 4, 3) AS serie, SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+' , CONVERT(NVARCHAR, dbo.MNOTACREDITO.fDiaContable, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, '+@comilla+ ''+@comilla+') AS ruc, ISNULL(dbo.vCliente.Descripcion, '+@comilla+ ''+@comilla+') AS razon, ISNULL(dbo.vCliente.tDireccion, '+@comilla+ ''+@comilla+') AS direccion, round(dbo.MNOTACREDITO.nNeto,2) as nneto, round(dbo.MNOTACREDITO.nImpuesto1,2) as nimpuesto1, round(dbo.MNOTACREDITO.nImpuesto2,2) as nImpuesto2, round(dbo.MNOTACREDITO.nImpuesto3,2) as nImpuesto3, round(dbo.MNOTACREDITO.nVenta,2) as nVenta,0 as nrecargo,0 as ndescuento, dbo.vEstadoDocumento.Descripcion AS estado, dbo.MNOTACREDITO.tEstadoDocumento AS testadodocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, '+@comilla+ ''+@comilla+' ) AS tcodigocliente ' + 
										  ' FROM         dbo.vEstadoDocumento RIGHT OUTER JOIN dbo.MNOTACREDITO ON dbo.vEstadoDocumento.Codigo = dbo.MNOTACREDITO.tEstadoDocumento LEFT OUTER JOIN  dbo.vCliente RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.vCliente.Codigo = dbo.MDOCUMENTO.tCodigoCliente ON dbo.MNOTACREDITO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vTipoDocumento ON SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 1, 1) = dbo.vTipoDocumento.Prefijo ' + 
										  ' WHERE     (dbo.MNOTACREDITO.fDiaContable >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MNOTACREDITO.fDiaContable <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ' ) ' + @xCriterio + 
										  ' ORDER BY dbo.MNOTACREDITO.fFecha, dbo.MNOTACREDITO.tNotaCredito'
								EXEC sp_executesql @sql		

							end
						if @flagRedondeo=0
							begin
								set @sql= ' inserT into #DBTRANST (tTipoDocumento ,					tSerie ,											tNumero ,											tNumero2,			fRegistro ,													tRuc ,																tRazonSocial  ,															tDireccion ,														 nNeto ,					 nImpuesto1 ,										nImpuesto2 ,								 nImpuesto3 ,					nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) '+
										  ' SELECT dbo.vTipoDocumento.Sunat AS tTipodocumento, SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 4, 3) AS serie, SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 9, 7) AS tDocumento, '+@comilla+ ''+@comilla+', CONVERT(NVARCHAR, dbo.MNOTACREDITO.fDiaContable, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, '+@comilla+ ''+@comilla+') AS ruc, ISNULL(dbo.vCliente.Descripcion, '+@comilla+ ''+@comilla+') AS razon, ISNULL(dbo.vCliente.tDireccion, '+@comilla+ ''+@comilla+') AS direccion,dbo.MNOTACREDITO.nNeto as nneto,  dbo.MNOTACREDITO.nImpuesto1  as nimpuesto1,  dbo.MNOTACREDITO.nImpuesto2  as nImpuesto2,  dbo.MNOTACREDITO.nImpuesto3  as nImpuesto3, dbo.MNOTACREDITO.nVenta  as nVenta,0 as nrecargo,0 as ndescuento, dbo.vEstadoDocumento.Descripcion AS estado, dbo.MNOTACREDITO.tEstadoDocumento AS testadodocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, '+@comilla+ ''+@comilla+' ) AS tcodigocliente ' + 
										  ' FROM         dbo.vEstadoDocumento RIGHT OUTER JOIN dbo.MNOTACREDITO ON dbo.vEstadoDocumento.Codigo = dbo.MNOTACREDITO.tEstadoDocumento LEFT OUTER JOIN  dbo.vCliente RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.vCliente.Codigo = dbo.MDOCUMENTO.tCodigoCliente ON dbo.MNOTACREDITO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vTipoDocumento ON SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 1, 1) = dbo.vTipoDocumento.Prefijo ' + 
										  ' WHERE     (dbo.MNOTACREDITO.fDiaContable >= '+ @comilla + LTRIM(STR(month(@FINICIO)))+'/'+LTRIM(STR(day(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ') AND (dbo.MNOTACREDITO.fDiaContable <= ' +@comilla + LTRIM(STR(month(@FFINAL)))+'/'+LTRIM(STR(day(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla + ' ) ' + @xCriterio +
										  ' ORDER BY dbo.MNOTACREDITO.fFecha, dbo.MNOTACREDITO.tNotaCredito'
								EXEC sp_executesql @sql		

							end
					--se Pone en cero los anulados
					set @sql= ' update #DBTRANST set nNeto = 0, nImpuesto1 = 0, nImpuesto2 = 0, nImpuesto3 = 0, nVenta = 0, nRecargo = 0, nDescuento = 0 where tcodigoEstado='+@comilla+'04'+@comilla		
					EXEC sp_executesql @sql		

					--Se pone en negativo las notas de crdito
					
					SET @sql= ' update #DBTRANST set nNeto = nNeto * -1 , nImpuesto1 = nImpuesto1 * -1, nImpuesto2 = nImpuesto2 * -1, nImpuesto3 = nImpuesto3 * -1, nVenta = nVenta * -1 where tTipoDocumento='+@comilla+'07'+@comilla+ ' and tCODIGOEstado<>'+@comilla+'04'+@comilla

					EXEC sp_executesql @sql

				--	print @sql
				
					SET @sql=' select tTipoDocumento ,tSerie ,tNumero , tNumero2, fRegistro ,ltrim(tRuc) as truc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente from #DBTRANST ' + 
							 ' order by substring(fRegistro,7,4),substring(fRegistro,4,2),substring(fRegistro,1,2), ttipodocumento, tserie '
					EXEC sp_executesql @sql

	 end 
   end
 end

END



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE spRep_RepClieFrecuentes
@flagDetaxClie as bit,
@flagConsoxClie as bit,
@flagConsoxZona as bit,
@flagNuevxClie as bit,
@flagDetaxDia as bit,
@flagMonto as bit,
@flagTurnoOFecha as bit,-- si selecciona un turno o rango d fecha
@tTipoPedido as nvarchar(30),
@tTipoCliente as nvarchar(30),
@tMotorizado as nvarchar(30),
@tCliente as nvarchar(30),
@tZona as nvarchar(30),
@tGrupo as nvarchar(30),
@tSubGrupo as nvarchar(30),
@tcodigoProducto as nvarchar(30),
@tMonto as float,
@sOrden as nvarchar(50),
@xOrden as nvarchar(50),
@turno as nvarchar(20),
@finicio as smalldatetime,
@ffinal as smalldatetime

AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(1000)
declare @xCriterio nvarchar(1000)
declare @sCriterio1 nvarchar(1000)
declare @sCriterio2 nvarchar(1000)
declare @xMonto1 nvarchar(1000)
declare @xMonto2 nvarchar(1000)

set @sql=''
set @scriterio=''
set @xCriterio=''
set @sCriterio1=''
set @sCriterio2=''
set @xMonto1=''
set @xMonto2=''

set @comilla=''''

if @flagTurnoOFecha=0 
	begin
	set @sCriterio =' MPEDIDO.tTurno like ' + @comilla+@turno+'%'+@comilla
	set @xCriterio =' MPEDIDO.tTurno like ' + @comilla+@turno+'%'+@comilla
	end
else
	begin
	set @scriterio =' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @xCriterio =' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	end

if @tTipoPedido<>''
	begin
	set @scriterio= @scriterio + ' and MPEDIDO.tTipoPedido like ' + @comilla+@ttipoPedido+'%'+@comilla
	set @xcriterio= @xcriterio + ' and MPEDIDO.tTipoPedido like ' + @comilla+@ttipoPedido+'%'+@comilla
	end

if @tTipoCliente<>''
	begin
	set @scriterio1=' and vDelivery.tTipoCliente like '+@comilla+@ttipoCliente+'%'+@comilla
	end
if @tMotorizado<>''
	begin
	set @scriterio=@scriterio + ' and MPEDIDO.tMotorizado like ' + @comilla+@tmotorizado+'%'+@comilla
	set @xcriterio=@xcriterio + ' and MPEDIDO.tMotorizado like ' + @comilla+@tmotorizado+'%'+@comilla
	end
if @tCliente<>''
	begin
	set @sCriterio=@scriterio + ' and MPEDIDO.tClienteDelivery like ' +@comilla+@tcliente+'%'+@comilla
	set @xCriterio=@xCriterio + ' and MPEDIDO.tClienteDelivery like ' +@comilla+@tcliente+'%'+@comilla

	end
if @flagMonto=0
	begin
	set @xMonto1= ' and Monto >= ' +ltrim(str(@tmonto))
	set @xMonto2= ' HAVING SUM(dbo.DPEDIDO.nVenta) >= '+ltrim(str(@tmonto))
	end

if @tZona <>''
	begin
	set @sCriterio = @sCriterio+ ' and vDelivery.Zona like ' + @comilla+@tzona+'%'+@comilla
	end
if @tGrupo<>''
	begin
	set @sCriterio2=@scriterio2 + ' and vProducto.Grupo like ' + @comilla+@tGrupo+'%'+@comilla
	end
if @tSubGrupo<>''
	begin
	set @sCriterio2=@scriterio2 + ' and subGrupo like ' + @comilla+@tsubGrupo+'%'+@comilla
	end
if @tcodigoProducto<> ''
	begin
	set @sCriterio2=@scriterio2 + ' and DPEDIDO.tCodigoProducto like ' + @comilla+@tcodigoProducto+'%'+@comilla
	end
	 --print @scriterio
	--print @sfiltro

if @flagDetaxClie=1	
	begin
--0
	  set @sql= ' SELECT dbo.vDelivery.Codigo, ISNULL(dbo.vDelivery.tApellido, N'+@comilla+ ''+@comilla+') + '+@comilla+ ' '+@comilla+' + ISNULL(dbo.vDelivery.tNombre, N'+@comilla+ ''+@comilla+') AS Cliente, dbo.vDelivery.tTelefono, dbo.vDelivery.tDireccion as Direccion, dbo.vDelivery.Zona, dbo.vProducto.Descripcion AS Producto, AVG(dbo.DPEDIDO.nPrecioVenta) AS Precio,  ' +
          ' SUM(dbo.DPEDIDO.nCantidad) AS Cantidad, SUM(dbo.DPEDIDO.nVenta) AS Venta, T1.Pedido, T1.Monto,max(vDelivery.tTipoCliente) as tTipoCliente, Max(vTipoClienteFrecuente.Descripcion) as TipoCliente ' +
          ' FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vDelivery ON dbo.MPEDIDO.tClienteDelivery = dbo.vDelivery.Codigo LEFT OUTER JOIN ' +
          ' (SELECT dbo.MPEDIDO.tClienteDelivery, COUNT(DISTINCT dbo.MPEDIDO.tCodigoPedido) AS Pedido, SUM(dbo.DPEDIDO.nVenta) AS Monto FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido  ' +
          ' where MPEDIDO.tEstadoPedido<>'+@comilla+ '03'+@comilla+' and DPEDIDO.tEstadoItem<>'+@comilla+ 'A'+@comilla+'  and  ' + @xCriterio  +
          ' GROUP BY dbo.MPEDIDO.tClienteDelivery) AS T1 ON dbo.vDelivery.Codigo = T1.tClienteDelivery LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo left outer join vTipoClienteFrecuente  ' +
          ' on vdelivery.tTipoCliente=vTipoClienteFrecuente.Codigo where MPEDIDO.tEstadoPedido<>'+@comilla+ '03'+@comilla+' and DPEDIDO.tEstadoItem<>'+@comilla+ 'A'+@comilla+' and MPEDIDO.tClienteDelivery <> '+@comilla+ ''+@comilla+' and isnull(vdelivery.codigo,'+@comilla+ ''+@comilla+')<>'+@comilla+ ''+@comilla+' and isnull(vdelivery.codigo,'+@comilla+ ''+@comilla+')<>'+@comilla+ ''+@comilla+' and ' + @sCriterio + @xMonto1 + @scriterio1 + @sCriterio2 +
          ' GROUP BY ISNULL(dbo.vDelivery.tApellido, N'+@comilla+ ''+@comilla+') + '+@comilla+ ' '+@comilla+' + ISNULL(dbo.vDelivery.tNombre, N'+@comilla+ ''+@comilla+'), dbo.vDelivery.Codigo,  dbo.vDelivery.tTelefono, dbo.vDelivery.tDireccion, dbo.vDelivery.Zona , dbo.vProducto.Descripcion, T1.Pedido, T1.Monto  ORDER BY ' + @sOrden

	end
if @flagConsoxClie=1
	begin
	--1
	   set @sql = ' SELECT ISNULL(dbo.vDelivery.tApellido, N'+@comilla+ ''+@comilla+') + '+@comilla+ ' '+@comilla+' + ISNULL(dbo.vDelivery.tNombre, N'+@comilla+ ''+@comilla+') AS Grupo, COUNT(DISTINCT dbo.MPEDIDO.tCodigoPedido) AS Pedido, SUM(dbo.DPEDIDO.nCantidad) AS Cantidad, SUM(dbo.DPEDIDO.nVenta) AS Monto,  ' +
           ' MIN(dbo.MPEDIDO.fRegistro) AS FechaPedido, MIN(dbo.vDelivery.fRegistro) AS FechaDelivery,max(vDelivery.tTipoCliente) as tTipoCliente, Max(vTipoClienteFrecuente.Descripcion) as TipoCliente, MAX(vDelivery.tTelefono)   ' +
           ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vDelivery ON dbo.MPEDIDO.tClienteDelivery = dbo.vDelivery.Codigo left outer join vTipoClienteFrecuente  ' +
           ' on vdelivery.tTipoCliente=vTipoClienteFrecuente.Codigo ' + 
           ' where MPEDIDO.tEstadoPedido<>'+@comilla+ '03'+@comilla+' and DPEDIDO.tEstadoItem<>'+@comilla+ 'A'+@comilla+' and MPEDIDO.tClienteDelivery <> '+@comilla+ ''+@comilla+' and isnull(vdelivery.codigo,'+@comilla+ ''+@comilla+')<>'+@comilla+ ''+@comilla+' and  ' + @sCriterio + @scriterio1  +
           ' GROUP BY ISNULL(dbo.vDelivery.tApellido, N'+@comilla+ ''+@comilla+') + '+@comilla+ ' '+@comilla+' + ISNULL(dbo.vDelivery.tNombre, N'+@comilla+ ''+@comilla+')  ' + @xMonto2 + ' ORDER BY ' + @xOrden
  
  
	end
if @flagConsoxZona =1
	begin
--2
	   set @sql = ' SELECT dbo.vDelivery.Zona as Grupo, COUNT(DISTINCT dbo.MPEDIDO.tCodigoPedido) AS Pedido, SUM(dbo.DPEDIDO.nCantidad) AS Cantidad, SUM(dbo.DPEDIDO.nVenta) AS Monto, MIN(dbo.MPEDIDO.fRegistro) AS FechaPedido, MIN(dbo.vDelivery.fRegistro) AS FechaDelivery  ' +
           ' FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vDelivery ON dbo.MPEDIDO.tClienteDelivery = dbo.vDelivery.Codigo  ' +
           ' where MPEDIDO.tEstadoPedido<>'+@comilla+ '03'+@comilla+' and DPEDIDO.tEstadoItem<>'+@comilla+ 'A'+@comilla+' and  MPEDIDO.tClienteDelivery <> '+@comilla+ ''+@comilla+' and isnull(vdelivery.codigo,'+@comilla+ ''+@comilla+')<>'+@comilla+ ''+@comilla+' and ' + @sCriterio +
           ' GROUP BY dbo.vDelivery.Zona ' + @xMonto2 + ' ORDER BY ' + @xOrden
  

	end
if @flagDetaxDia =1
	begin
--3
	   set @sql = ' SELECT mpedido.fregistro,dbo.vDelivery.Codigo, ISNULL(dbo.vDelivery.tApellido, N'+@comilla+ ''+@comilla+') + '+@comilla+ ' '+@comilla+' + ISNULL(dbo.vDelivery.tNombre, N'+@comilla+ ''+@comilla+') AS Cliente, dbo.vDelivery.tTelefono, dbo.vDelivery.tDireccion as Direccion, dbo.vDelivery.Zona, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nPrecioVenta AS Precio,  ' +
           ' dbo.DPEDIDO.nCantidad AS Cantidad, dbo.DPEDIDO.nVenta Venta,vDelivery.tTipoCliente tTipoCliente, vTipoClienteFrecuente.Descripcion as TipoCliente  ' +
           ' FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vDelivery ON dbo.MPEDIDO.tClienteDelivery = dbo.vDelivery.Codigo LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo  ' +
           ' left outer join vTipoClienteFrecuente on vdelivery.tTipoCliente=vTipoClienteFrecuente.Codigo  ' +
           ' where MPEDIDO.tEstadoPedido<>'+@comilla+ '03'+@comilla+' and DPEDIDO.tEstadoItem<>'+@comilla+ 'A'+@comilla+' and  MPEDIDO.tClienteDelivery <> '+@comilla+ ''+@comilla+' and isnull(vdelivery.codigo,'+@comilla+ ''+@comilla+')<>'+@comilla+ ''+@comilla+' and  ' + @sCriterio + @xMonto1 + @scriterio1 + @sCriterio2 +
           ' order by mpedido.ttipocliente,mpedido.fregistro,cliente '
  

	end
if @flagNuevxClie =1
	begin
--4
	   set @sql = ' SELECT ISNULL(dbo.vDelivery.tApellido, N'+@comilla+ ''+@comilla+') + '+@comilla+ ' '+@comilla+' + ISNULL(dbo.vDelivery.tNombre, N'+@comilla+ ''+@comilla+') AS Grupo, COUNT(DISTINCT dbo.MPEDIDO.tCodigoPedido) AS Pedido, SUM(dbo.DPEDIDO.nCantidad) AS Cantidad, SUM(dbo.DPEDIDO.nVenta) AS Monto, ' +
           ' MIN(dbo.MPEDIDO.fRegistro) AS FechaPedido, MIN(dbo.vDelivery.fRegistro) AS FechaDelivery,max(vDelivery.tTipoCliente) as tTipoCliente, Max(vTipoClienteFrecuente.Descripcion) as TipoCliente, MAX(vDelivery.tTelefono)   ' +
           ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vDelivery ON dbo.MPEDIDO.tClienteDelivery = dbo.vDelivery.Codigo  ' +
           ' left outer join vTipoClienteFrecuente on vdelivery.tTipoCliente=vTipoClienteFrecuente.Codigo ' +
           ' where MPEDIDO.tEstadoPedido<>'+@comilla+ '03'+@comilla+' and DPEDIDO.tEstadoItem<>'+@comilla+ 'A'+@comilla+' and  MPEDIDO.tClienteDelivery <> '+@comilla+ ''+@comilla+' and isnull(vdelivery.codigo,'+@comilla+ ''+@comilla+')<>'+@comilla+ ''+@comilla+' and  ' + @sCriterio + @scriterio1 + ' And convert(varchar(10), dbo.MPEDIDO.fRegistro,111) = convert(varchar(10), dbo.vDelivery.fRegistro,111)  ' +
           ' GROUP BY ISNULL(dbo.vDelivery.tApellido, N'+@comilla+ ''+@comilla+') + '+@comilla+ ' '+@comilla+' + ISNULL(dbo.vDelivery.tNombre, N'+@comilla+ ''+@comilla+') ' + @xMonto2 + ' ORDER BY  ' + @xOrden
  

	end
 --print @sql
EXEC sp_executesql @sql
/**/


END

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE spRep_ResultadoOperativo
@flagTurnoOFecha as bit,
@flagVista as   bit,
@tLocal as nvarchar(20),
@tTipoProducto as nvarchar(20),
@tTipoPedido as nvarchar(20),
@tAreaProduccion as nvarchar(50),
@tGrupo as nvarchar(50),
@tSubGrupo as nvarchar(50),
@tCodigoProducto as nvarchar(20),
@tTurno as nvarchar(20),
@finicio as smalldatetime,
@ffinal as smalldatetime,
@flagFacturado as bit

AS BEGIN

set nocount on

declare @sql nvarchar(4000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(1000)
declare @xCriterio nvarchar(1000)

DECLARE @cantidadRegistro	bigint
DECLARE @va	bigint	
declare @codigoProducto	nvarchar(15)
declare @codigoPedido	nvarchar(15)
declare @item	nvarchar(15)
DECLARE @Propiedad	nvarchar(3500)
declare @ValorVenta	float
DECLARE	@nInsumo	float
DECLARE @nCantidad	float
DECLARE	@nGasto		float
DECLARE	@nMObra		float
DECLARE	@tCosto		float
DECLARE	@VentaTotal	float

declare @codigoProductoV	nvarchar(15)
declare @codigoPedidoV	nvarchar(15)
declare @itemV	nvarchar(15)
DECLARE @PropiedadV	nvarchar(3500)
declare @insertado	int
set @cantidadRegistro=0
SET @insertado=0
SET @VA=0
SET @codigoProductoV	=''
SET @codigoPedidoV	=''
SET @itemV	 =''
SET @PropiedadV	=''
SET @ncantidad	=0
set @sql=''
set @scriterio=''
set @comilla=''''
		CREATE TABLE #DBTRANSR (Codigo nVarChar(7) collate Modern_Spanish_CI_AS, Grupo nVarChar(40) collate Modern_Spanish_CI_AS, SubGrupo nVarChar(40) collate Modern_Spanish_CI_AS, Producto nVarChar(80) collate Modern_Spanish_CI_AS ,valorVenta Float, Insumo Float, Gasto Float, MObra Float, Cantidad Float, VentaTotal Float, nCortesia Float, Cortesia Float)
		
		if @flagTurnoOFecha=0 
			begin
			set @sCriterio=' MPEDIDO.tTurno = ' + @comilla+@tturno+@comilla
			end
		else
			begin
			set @scriterio=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
			end
		IF @tlocal<>''
			begin
			set @scriterio=@scriterio+ ' and vsalon.tlocal= '+@comilla+@tlocal+@comilla
			end
		if @tTipoProducto<>''
			begin
			set @scriterio=@scriterio+ ' and vproducto.ttipoproducto= '+@comilla+@tTipoProducto+@comilla
			end
		if @tTipoPedido<>''
			begin
			set @scriterio=@scriterio+ ' and mpedido.ttipopedido= '+@comilla+@tTipoPedido+@comilla
			end
		if @tAreaProduccion<>''
			begin
			set @scriterio=@scriterio + ' and dpedido.tArea = ' +@comilla+@tareaproduccion+@comilla
			end
		if @tGrupo <> ''
			begin
			set @scriterio=@scriterio + ' and vProducto.Grupo = ' +@comilla+@tgrupo+@comilla
			end
		
		if @tSubGrupo<>''
			begin
			set @scriterio=@scriterio + ' and  subGrupo = ' +@comilla+@tsubgrupo+@comilla
			end
		
		if @tCodigoProducto<>''
			begin
			set @scriterio=@scriterio + ' and DPEDIDO.tCodigoProducto = ' +@comilla+@tcodigoproducto+@comilla
			end
		--Inserta los Datos del Producto
		SET @sql= ' Insert into #DBTRANSR (Codigo, Grupo, SubGrupo, Producto, ValorVenta, Insumo, Gasto, MObra, Cantidad, VentaTotal, nCortesia, Cortesia )' + 
		          ' SELECT Codigo, Grupo, SubGrupo, Descripcion AS Producto, 0 as ValorVenta, 0 as Insumo, 0 as Gasto, 0 as MObra, 0 as Cantidad, 0 as VentaTotal, 0 as nCortesia, 0 as Cortesia ' + 
		          ' From vProducto ' 
		 EXECUTE  sp_executesql @sql
			         

if @flagVista=1
	begin
	if @flagFacturado=0 
		begin
			--Actualiza Valores de la Venta
			SET @sql= ' Update #DBTRANSR set ValorVenta=T1.ValorVenta, Insumo=T1.Insumo, Gasto=T1.Gasto, MObra=T1.Mobra, Cantidad=T1.Cantidad, VentaTotal=T1.VentaTotal From ' + 
			          ' (SELECT dbo.DPEDIDO.tCodigoProducto AS Codigo, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nPrecioNeto) / sum(dbo.dpedido.ncantidad) AS ValorVenta, ' + 
			          ' sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nInsumo) AS Insumo, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nGasto) AS Gasto, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nManoObra) AS MObra, ' + 
			          ' SUM(dbo.DPEDIDO.nCantidad) AS Cantidad, SUM(dbo.DPEDIDO.nCantidad * dbo.DPEDIDO.nPrecioNeto) As VentaTotal ' + 
			          ' FROM dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
			          ' WHERE (tFacturado = N'+@comilla+ 'P'+@comilla+' OR tFacturado = N'+@comilla+ 'F'+@comilla+') AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @SCRITERIO + 
			          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo'
   		    EXECUTE  sp_executesql @sql
			         
			--Actualiza Valores de la Venta con Propiedades
			SET @sql= ' Update #DBTRANSR  set Insumo=#DBTRANSR.Insumo + T1.Insumo, Gasto=#DBTRANSR.Gasto + T1.Gasto, MObra=#DBTRANSR.MObra + T1.Mobra  From ' + 
			          ' (SELECT     dbo.DPEDIDO.tCodigoProducto AS Codigo, SUM(dbo.DPEDIDO.nCantidad * dbo.TPRODUCTOPROPIEDAD.nInsumo) AS Insumo, SUM(dbo.DPEDIDO.nCantidad * dbo.TPRODUCTOPROPIEDAD.nGasto) AS Gasto, SUM(dbo.DPEDIDO.nCantidad * dbo.TPRODUCTOPROPIEDAD.nManoObra) AS MObra ' + 
			          ' FROM dbo.TPRODUCTOPROPIEDAD INNER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
			          ' WHERE (tFacturado = N'+@comilla+ 'P'+@comilla+' OR tFacturado = N'+@comilla+ 'F'+@comilla+') AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @SCRITERIO + 
			          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo'
			EXECUTE  sp_executesql @sql	                
			
			--enero 2011
			   --Actualiza Combos
			SET @sql= ' Update #DBTRANSR  set Insumo=T2.Insumo , Gasto=T2.Gasto , MObra=T2.Obra   FROM #DBTRANSR as T1 INNER JOIN ' + 
			          ' (SELECT dbo.DPEDIDO.tCodigoProducto, SUM(dbo.CPEDIDO.nInsumo*dbo.CPEDIDO.nCantidad) AS Insumo, SUM(dbo.CPEDIDO.nGasto*dbo.CPEDIDO.nCantidad) AS Gasto, SUM(dbo.CPEDIDO.nManoObra*dbo.CPEDIDO.nCantidad) AS Obra ' + 
			          ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' + 
			          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.DPEDIDO.tFacturado <> '+@comilla+ 'C'+@comilla+' AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @sCriterio +
			          ' GROUP BY dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.Codigo = T2.tCodigoProducto '
			EXECUTE  sp_executesql @sql
			                  
			   --Actualiza Combos con Propiedades
			SET @sql= ' Update #DBTRANSR  set Insumo=t1.insumo+T2.Insumo, Gasto=t1.gasto+T2.Gasto, MObra=t1.mobra+T2.Obra  FROM #DBTRANSR as T1 INNER JOIN ' + 
			          ' (SELECT dbo.DPEDIDO.tCodigoProducto, SUM(dbo.TCOMBOPROPIEDAD.nInsumo * dbo.CPEDIDO.nCantidad) AS Insumo, SUM(dbo.TCOMBOPROPIEDAD.nGasto * dbo.CPEDIDO.nCantidad) AS Gasto, SUM(dbo.TCOMBOPROPIEDAD.nManoObra * dbo.CPEDIDO.nCantidad) AS Obra ' + 
			          ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' + 
			          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.DPEDIDO.tFacturado <> '+@comilla+ 'C'+@comilla+' AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @sCriterio +
			          ' GROUP BY dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.Codigo = T2.tCodigoProducto '
			   EXECUTE  sp_executesql @sql
			
				
			    --Actualiza Cortesias
			 SET @sql=' Update #DBTRANSR set ValorVenta = T1.ValorVenta, Cortesia= (T1.Insumo + T1.Gasto + T1.MObra) , nCortesia= T1.Cantidad  From ' + 
			          ' (SELECT dbo.DPEDIDO.tCodigoProducto AS Codigo, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nPrecioNeto) / sum(dbo.dpedido.ncantidad) AS ValorVenta, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nInsumo) AS Insumo, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nGasto) AS Gasto, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nManoObra) AS MObra, SUM(dbo.DPEDIDO.nCantidad) AS Cantidad ' + 
			          ' FROM dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
			          ' WHERE tFacturado = '+@comilla+ 'C'+@comilla+' AND tEstadoItem = N'+@comilla+ 'N'+@comilla+' and ' + @SCRITERIO + 
			          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo '
			   EXECUTE  sp_executesql @sql
			      
			  --Actualiza Cortesias con Propiedades
			SET @sql= ' Update #DBTRANSR  set Cortesia=#DBTRANSR.Cortesia + T1.Insumo + T1.Gasto + T1.MObra  From ' + 
			          ' (SELECT dbo.DPEDIDO.tCodigoProducto AS Codigo, SUM(dbo.DPEDIDO.nCantidad * dbo.TPRODUCTOPROPIEDAD.nInsumo) AS Insumo, SUM(dbo.DPEDIDO.nCantidad * dbo.TPRODUCTOPROPIEDAD.nGasto) AS Gasto, SUM(dbo.DPEDIDO.nCantidad * dbo.TPRODUCTOPROPIEDAD.nManoObra) AS MObra ' + 
			          ' FROM dbo.TPRODUCTOPROPIEDAD INNER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
			          ' WHERE tFacturado = '+@comilla+ 'C'+@comilla+' AND tEstadoItem = N'+@comilla+ 'N'+@comilla+' and ' + @SCRITERIO + 
			          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo '
			   EXECUTE  sp_executesql @sql
			                  
			   --Actualiza Combos de Cortesias
			  SET @sql= ' Update #DBTRANSR  set Cortesia= Cortesia + T2.Insumo + T2.Gasto + T2.Obra  FROM #DBTRANSR as T1 INNER JOIN ' + 
			          ' (SELECT dbo.DPEDIDO.tCodigoProducto, SUM(dbo.CPEDIDO.nInsumo*dbo.CPEDIDO.nCantidad) AS Insumo, SUM(dbo.CPEDIDO.nGasto*dbo.CPEDIDO.nCantidad) AS Gasto, SUM(dbo.CPEDIDO.nManoObra*dbo.CPEDIDO.nCantidad) AS Obra ' + 
			          ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' + 
			          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @sCriterio +
			          ' GROUP BY dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.Codigo = T2.tCodigoProducto '
			   EXECUTE  sp_executesql @sql
			                  
			   --Actualiza Combos de Cortesias con Propiedades
			    SET @sql=' Update #DBTRANSR  set Cortesia = Cortesia + T2.Insumo + T2.Gasto + T2.Obra  FROM #DBTRANSR as T1 INNER JOIN ' + 
			          ' (SELECT dbo.DPEDIDO.tCodigoProducto, SUM(dbo.TCOMBOPROPIEDAD.nInsumo * dbo.CPEDIDO.nCantidad) AS Insumo, SUM(dbo.TCOMBOPROPIEDAD.nGasto * dbo.CPEDIDO.nCantidad) AS Gasto, SUM(dbo.TCOMBOPROPIEDAD.nManoObra * dbo.CPEDIDO.nCantidad) AS Obra ' + 
			          ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' + 
			          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @sCriterio +
			          ' GROUP BY dbo.DPEDIDO.tCodigoProducto) as T2   ON T1.Codigo = T2.tCodigoProducto ' 
			
			   EXECUTE  sp_executesql @sql
			                        
			   --Borra los ceros
			  delete from #DBTRANSR where (Cantidad <=0 or isnull(Cantidad,'0')='0') and nCortesia<=0
			
			--    Toma el Reporte
			   SET @sql = ' SELECT Codigo, Grupo, SubGrupo, Producto, ValorVenta, CASE when Cantidad=0 then 0 else Insumo/Cantidad END as Insumo, CASE when Cantidad=0 then 0 else Gasto/Cantidad END as Gasto, '+
			              ' CASE when Cantidad=0 then 0 else MOBRA/Cantidad END as MObra, CASE when Cantidad=0 then 0 else (Insumo + Gasto + MObra)/Cantidad END AS Costo, CASE when ValorVenta = 0 then 0 else CASE when Cantidad=0 then 0 else (Insumo + Gasto + MObra)/Cantidad END * 100 / ValorVenta end AS PCosto, ' +
			              ' ValorVenta - (CASE when Cantidad=0 then 0 else (Insumo + Gasto + MObra)/Cantidad END) AS Utilidad, CASE when valorventa = 0 then 0 else (ValorVenta - (CASE when Cantidad=0 then 0 else (Insumo + Gasto + MObra)/Cantidad END)) * 100 / ValorVenta end AS pUtilidad, Cantidad, VentaTotal, nCortesia, ' +
			              ' CASE when nCortesia = 0  then 0 else CASE when nCortesia=0 then 0 else Cortesia/nCortesia END END as Cortesia, ((ValorVenta - (CASE when nCortesia=0 then 0 else (Insumo + Gasto + MObra)/nCortesia END)) * Cantidad) - Cortesia as Utilidad  ' +
			              ' From #DBTRANSR order by Grupo, SubGrupo, Producto '
				EXECUTE  sp_executesql @sql
		end
	 if @flagFacturado=1 
		begin   
			print '1'
		    --Actualiza Valores de la Venta
			SET @sql= ' Update #DBTRANSR set ValorVenta=T1.ValorVenta, Insumo=T1.Insumo, Gasto=T1.Gasto, MObra=T1.Mobra, Cantidad=T1.Cantidad, VentaTotal=T1.VentaTotal From ' + 
			          ' (SELECT dbo.DPEDIDO.tCodigoProducto AS Codigo, sum(dbo.dpedido.ncantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.DPEDIDO.nPrecioNeto end )) / sum(dbo.dpedido.ncantidad) AS ValorVenta, ' + 
			          ' sum(dbo.dpedido.ncantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.DPEDIDO.nInsumo end )) AS Insumo, sum(dbo.dpedido.ncantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.DPEDIDO.nGasto end )) AS Gasto, sum(dbo.dpedido.ncantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.DPEDIDO.nManoObra end)) AS MObra, ' + 
			          ' SUM(dbo.DPEDIDO.nCantidad) AS Cantidad, SUM(dbo.DPEDIDO.nCantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.DPEDIDO.nPrecioNeto end )) As VentaTotal ' + 
			          ' FROM dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
			          ' WHERE (tFacturado = N'+@comilla+ 'P'+@comilla+' OR tFacturado = N'+@comilla+ 'F'+@comilla+') AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @SCRITERIO + 
			          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo'
   		    EXECUTE  sp_executesql @sql
			print @sql
			print '2'			         
			--Actualiza Valores de la Venta con Propiedades
			SET @sql= ' Update #DBTRANSR  set Insumo=#DBTRANSR.Insumo + T1.Insumo, Gasto=#DBTRANSR.Gasto + T1.Gasto, MObra=#DBTRANSR.MObra + T1.Mobra  From ' + 
			          ' (SELECT     dbo.DPEDIDO.tCodigoProducto AS Codigo, SUM(dbo.DPEDIDO.nCantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.TPRODUCTOPROPIEDAD.nInsumo end )) AS Insumo, SUM(dbo.DPEDIDO.nCantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.TPRODUCTOPROPIEDAD.nGasto end )) AS Gasto, SUM(dbo.DPEDIDO.nCantidad * ( case when dpedido.lregistroventa=0 then 0 else dbo.TPRODUCTOPROPIEDAD.nManoObra end )) AS MObra ' + 
			          ' FROM dbo.TPRODUCTOPROPIEDAD INNER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
			          ' WHERE (tFacturado = N'+@comilla+ 'P'+@comilla+' OR tFacturado = N'+@comilla+ 'F'+@comilla+') AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @SCRITERIO + 
			          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo'
			EXECUTE  sp_executesql @sql	                
			print '3'
			--enero 2011
			   --Actualiza Combos
			SET @sql= ' Update #DBTRANSR  set Insumo=T2.Insumo , Gasto=T2.Gasto , MObra=T2.Obra   FROM #DBTRANSR as T1 INNER JOIN ' + 
			          ' (SELECT dbo.DPEDIDO.tCodigoProducto, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.CPEDIDO.nInsumo end )* dbo.CPEDIDO.nCantidad) AS Insumo, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.CPEDIDO.nGasto end)*dbo.CPEDIDO.nCantidad) AS Gasto, SUM(( case when dpedido.lregistroventa=0 then 0 else dbo.CPEDIDO.nManoObra end ) *dbo.CPEDIDO.nCantidad) AS Obra ' + 
			          ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' + 
			          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.DPEDIDO.tFacturado <> '+@comilla+ 'C'+@comilla+' AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @sCriterio +
			          ' GROUP BY dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.Codigo = T2.tCodigoProducto '
			EXECUTE  sp_executesql @sql
			        print '4'    
			   --Actualiza Combos con Propiedades
			SET @sql= ' Update #DBTRANSR  set Insumo=t1.insumo+T2.Insumo, Gasto=t1.gasto+T2.Gasto, MObra=t1.mobra+T2.Obra  FROM #DBTRANSR as T1 INNER JOIN ' + 
			          ' (SELECT dbo.DPEDIDO.tCodigoProducto, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.TCOMBOPROPIEDAD.nInsumo end) * dbo.CPEDIDO.nCantidad) AS Insumo, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.TCOMBOPROPIEDAD.nGasto end) * dbo.CPEDIDO.nCantidad) AS Gasto, SUM( (case when dpedido.lregistroventa=0 then 0 else dbo.TCOMBOPROPIEDAD.nManoObra end) * dbo.CPEDIDO.nCantidad) AS Obra ' + 
			          ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' + 
			          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.DPEDIDO.tFacturado <> '+@comilla+ 'C'+@comilla+' AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @sCriterio +
			          ' GROUP BY dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.Codigo = T2.tCodigoProducto '
			   EXECUTE  sp_executesql @sql
			
				      		print '5'	    
			    --Actualiza Cortesias
			 SET @sql=' Update #DBTRANSR set ValorVenta = T1.ValorVenta, Cortesia= (T1.Insumo + T1.Gasto + T1.MObra) , nCortesia= T1.Cantidad  From ' + 
			          ' (SELECT dbo.DPEDIDO.tCodigoProducto AS Codigo, sum(dbo.dpedido.ncantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.DPEDIDO.nPrecioNeto end )) / sum(dbo.dpedido.ncantidad) AS ValorVenta, sum(dbo.dpedido.ncantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.DPEDIDO.nInsumo end )) AS Insumo, sum(dbo.dpedido.ncantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.DPEDIDO.nGasto end)) AS Gasto, sum(dbo.dpedido.ncantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.DPEDIDO.nManoObra end)) AS MObra, SUM(dbo.DPEDIDO.nCantidad) AS Cantidad ' + 
			          ' FROM dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
			          ' WHERE tFacturado = '+@comilla+ 'C'+@comilla+' AND tEstadoItem = N'+@comilla+ 'N'+@comilla+' and ' + @SCRITERIO + 
			          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo '
			   EXECUTE  sp_executesql @sql
			      	---ok	
				print '6'
			  --Actualiza Cortesias con Propiedades
			SET @sql= ' Update #DBTRANSR  set Cortesia=#DBTRANSR.Cortesia + T1.Insumo + T1.Gasto + T1.MObra  From ' + 
			          ' (SELECT dbo.DPEDIDO.tCodigoProducto AS Codigo, SUM(dbo.DPEDIDO.nCantidad * (case when dpedido.lregistroventa=0 then 0 else  dbo.TPRODUCTOPROPIEDAD.nInsumo end)) AS Insumo, SUM(dbo.DPEDIDO.nCantidad * (case when dpedido.lregistroventa=0 then 0 else  dbo.TPRODUCTOPROPIEDAD.nGasto end)) AS Gasto, SUM(dbo.DPEDIDO.nCantidad * (case when dpedido.lregistroventa=0 then 0 else  dbo.TPRODUCTOPROPIEDAD.nManoObra end)) AS MObra ' + 
			          ' FROM dbo.TPRODUCTOPROPIEDAD INNER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
			          ' WHERE tFacturado = '+@comilla+ 'C'+@comilla+' AND tEstadoItem = N'+@comilla+ 'N'+@comilla+' and ' + @SCRITERIO + 
			          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo '
			   EXECUTE  sp_executesql @sql
			            print '7'      
			   --Actualiza Combos de Cortesias
			  SET @sql= ' Update #DBTRANSR  set Cortesia= Cortesia + T2.Insumo + T2.Gasto + T2.Obra  FROM #DBTRANSR as T1 INNER JOIN ' + 
			          ' (SELECT dbo.DPEDIDO.tCodigoProducto, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.CPEDIDO.nInsumo end )*dbo.CPEDIDO.nCantidad) AS Insumo, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.CPEDIDO.nGasto end)*dbo.CPEDIDO.nCantidad) AS Gasto, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.CPEDIDO.nManoObra end)*dbo.CPEDIDO.nCantidad) AS Obra ' + 
			          ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' + 
			          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @sCriterio +
			          ' GROUP BY dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.Codigo = T2.tCodigoProducto '
			   EXECUTE  sp_executesql @sql
			                  print '8'
			   --Actualiza Combos de Cortesias con Propiedades
			    SET @sql=' Update #DBTRANSR  set Cortesia = Cortesia + T2.Insumo + T2.Gasto + T2.Obra  FROM #DBTRANSR as T1 INNER JOIN ' + 
			          ' (SELECT dbo.DPEDIDO.tCodigoProducto, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.TCOMBOPROPIEDAD.nInsumo end) * dbo.CPEDIDO.nCantidad) AS Insumo, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.TCOMBOPROPIEDAD.nGasto end) * dbo.CPEDIDO.nCantidad) AS Gasto, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.TCOMBOPROPIEDAD.nManoObra end) * dbo.CPEDIDO.nCantidad) AS Obra ' + 
			          ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' + 
			          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @sCriterio +
			          ' GROUP BY dbo.DPEDIDO.tCodigoProducto) as T2   ON T1.Codigo = T2.tCodigoProducto ' 
			
			   EXECUTE  sp_executesql @sql
			                        
			   --Borra los ceros
			  delete from #DBTRANSR where (Cantidad <=0 or isnull(Cantidad,'0')='0') and nCortesia<=0
			
			--    Toma el Reporte
			   SET @sql = ' SELECT Codigo, Grupo, SubGrupo, Producto, ValorVenta, CASE when Cantidad=0 then 0 else Insumo/Cantidad END as Insumo, CASE when Cantidad=0 then 0 else Gasto/Cantidad END as Gasto, '+
			              ' CASE when Cantidad=0 then 0 else MOBRA/Cantidad END as MObra, CASE when Cantidad=0 then 0 else (Insumo + Gasto + MObra)/Cantidad END AS Costo, CASE when ValorVenta = 0 then 0 else CASE when Cantidad=0 then 0 else (Insumo + Gasto + MObra)/Cantidad END * 100 / ValorVenta end AS PCosto, ' +
			              ' ValorVenta - (CASE when Cantidad=0 then 0 else (Insumo + Gasto + MObra)/Cantidad END) AS Utilidad, CASE when valorventa = 0 then 0 else (ValorVenta - (CASE when Cantidad=0 then 0 else (Insumo + Gasto + MObra)/Cantidad END)) * 100 / ValorVenta end AS pUtilidad, Cantidad, VentaTotal, nCortesia, ' +
			              ' CASE when nCortesia = 0  then 0 else CASE when nCortesia=0 then 0 else Cortesia/nCortesia END END as Cortesia, ((ValorVenta - (CASE when nCortesia=0 then 0 else (Insumo + Gasto + MObra)/nCortesia END)) * Cantidad) - Cortesia as Utilidad  ' +
			              ' From #DBTRANSR order by Grupo, SubGrupo, Producto '
				EXECUTE  sp_executesql @sql
				print 'fin'
		end 
	end
else
	begin
		
		CREATE TABLE #DBTRANS0 (
			tProducto nVarchar(10)	collate Modern_Spanish_CI_AS,
			tcodigoPediDo nVarchar(15)	collate Modern_Spanish_CI_AS,
			tItem nVarchar(3)	collate Modern_Spanish_CI_AS,
			ncantidad	float,
			Propiedad nVarChar(3500)	collate Modern_Spanish_CI_AS,
			valorventa	float,
			nInsumo	float,
			nGasto	float,
			nMObra	float,
			tCosto	float,
			ventatotal float )
		
		 create table #DBTRANS2 (
			tProducto nVarchar(10)	collate Modern_Spanish_CI_AS,
			tcodigopedido nVarchar(15)	collate Modern_Spanish_CI_AS,
			ncantidad	float,
			titem	nvarchar(3) collate Modern_Spanish_CI_AS,
			Propiedad nVarChar(3500)	collate Modern_Spanish_CI_AS,
			valorventa	float,
			nInsumo	float,
			nGasto	float,
			nMObra	float,
			tCosto	float,
			ventatotal float )
	if @flagFacturado=0 
		begin 	
		           
		--Actualiza Valores de la Venta
		
				-- con todo y propiedades
				/*
				SET @sql= ' Update #DBTRANSR set ValorVenta=T1.ValorVenta, Insumo=T1.Insumo, Gasto=T1.Gasto, MObra=T1.Mobra, Cantidad=T1.Cantidad, VentaTotal=T1.VentaTotal From ' + 
				          ' (SELECT dbo.DPEDIDO.tCodigoProducto AS Codigo, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nPrecioNeto) / sum(dbo.dpedido.ncantidad) AS ValorVenta, ' + 
				          ' sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nInsumo) AS Insumo, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nGasto) AS Gasto, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nManoObra) AS MObra, ' + 
				          ' SUM(dbo.DPEDIDO.nCantidad) AS Cantidad, SUM(dbo.DPEDIDO.nCantidad * dbo.DPEDIDO.nPrecioNeto) As VentaTotal ' + 
				          ' FROM dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
				          ' WHERE (tFacturado = N'+@comilla+ 'P'+@comilla+' OR tFacturado = N'+@comilla+ 'F'+@comilla+') AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @SCRITERIO + 
				          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo'
				   EXECUTE  sp_executesql @sql
				*/
				--sin propieades
				/*SET @sql= ' Update #DBTRANSR set ValorVenta=T1.ValorVenta, Insumo=T1.Insumo, Gasto=T1.Gasto, MObra=T1.Mobra, Cantidad=T1.Cantidad, VentaTotal=T1.VentaTotal From ' + 
				          ' (SELECT dbo.DPEDIDO.tCodigoProducto AS Codigo, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nPrecioNeto) / sum(dbo.dpedido.ncantidad) AS ValorVenta, ' + 
				          ' sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nInsumo) AS Insumo, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nGasto) AS Gasto, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nManoObra) AS MObra, ' + 
				          ' SUM(dbo.DPEDIDO.nCantidad) AS Cantidad, SUM(dbo.DPEDIDO.nCantidad * dbo.DPEDIDO.nPrecioNeto) As VentaTotal ' + 
				          ' FROM  dbo.TPRODUCTOPROPIEDAD RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
				          ' WHERE (tFacturado = N'+@comilla+ 'P'+@comilla+' OR tFacturado = N'+@comilla+ 'F'+@comilla+') AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') AND (dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad IS NULL) and ' + @SCRITERIO + 
				          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo'
*/
				SET @sql= ' Update #DBTRANSR set ValorVenta=T1.ValorVenta, Insumo=T1.Insumo, Gasto=T1.Gasto, MObra=T1.Mobra, Cantidad=T1.Cantidad, VentaTotal=T1.VentaTotal From ' + 
				          ' (SELECT dbo.DPEDIDO.tCodigoProducto AS Codigo, sum(dbo.dpedido.ncantidad *  dbo.DPEDIDO.nPrecioNeto  ) / sum(dbo.dpedido.ncantidad) AS ValorVenta, ' + 
				          ' sum(dbo.dpedido.ncantidad *  dbo.DPEDIDO.nInsumo  ) AS Insumo, sum(dbo.dpedido.ncantidad *  dbo.DPEDIDO.nGasto  ) AS Gasto, sum(dbo.dpedido.ncantidad *   dbo.DPEDIDO.nManoObra  ) AS MObra, ' + 
				          ' SUM(dbo.DPEDIDO.nCantidad) AS Cantidad, SUM(dbo.DPEDIDO.nCantidad *   dbo.DPEDIDO.nPrecioNeto  ) As VentaTotal ' + 
				          ' FROM         dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
				          ' WHERE (tFacturado = N'+@comilla+ 'P'+@comilla+' OR tFacturado = N'+@comilla+ 'F'+@comilla+') AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @SCRITERIO + 
				          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo'
				--print @sql
				   EXECUTE  sp_executesql @sql
		         
		 
		
		--Actualiza Valores de la Venta con Propiedades
		
				-- ya no va propiedades
				/*SET @sql= ' Update #DBTRANSR  set Insumo=#DBTRANSR.Insumo + T1.Insumo, Gasto=#DBTRANSR.Gasto + T1.Gasto, MObra=#DBTRANSR.MObra + T1.Mobra  From ' + 
				          ' (SELECT     dbo.DPEDIDO.tCodigoProducto AS Codigo, SUM(dbo.DPEDIDO.nCantidad * dbo.TPRODUCTOPROPIEDAD.nInsumo) AS Insumo, SUM(dbo.DPEDIDO.nCantidad * dbo.TPRODUCTOPROPIEDAD.nGasto) AS Gasto, SUM(dbo.DPEDIDO.nCantidad * dbo.TPRODUCTOPROPIEDAD.nManoObra) AS MObra ' + 
				          ' FROM dbo.TPRODUCTOPROPIEDAD INNER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
				          ' WHERE (tFacturado = N'+@comilla+ 'P'+@comilla+' OR tFacturado = N'+@comilla+ 'F'+@comilla+') AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @SCRITERIO + 
				          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo'
				   EXECUTE  sp_executesql @sql
				  */                
		
		
		--enero 2011
		--Actualiza Combos
				SET @sql= ' Update #DBTRANSR  set Insumo=T2.Insumo , Gasto=T2.Gasto , MObra=T2.Obra   FROM #DBTRANSR as T1 INNER JOIN ' + 
				          ' (SELECT dbo.DPEDIDO.tCodigoProducto, SUM(dbo.CPEDIDO.nInsumo*dbo.CPEDIDO.nCantidad) AS Insumo, SUM(dbo.CPEDIDO.nGasto*dbo.CPEDIDO.nCantidad) AS Gasto, SUM(dbo.CPEDIDO.nManoObra*dbo.CPEDIDO.nCantidad) AS Obra ' + 
				          ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' + 
				          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.DPEDIDO.tFacturado <> '+@comilla+ 'C'+@comilla+' AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @sCriterio +
				          ' GROUP BY dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.Codigo = T2.tCodigoProducto '
				   EXECUTE  sp_executesql @sql
				                  
		--Actualiza Combos con Propiedades
				SET @sql= ' Update #DBTRANSR  set Insumo=t1.insumo+T2.Insumo, Gasto=t1.gasto+T2.Gasto, MObra=t1.mobra+T2.Obra  FROM #DBTRANSR as T1 INNER JOIN ' + 
				          ' (SELECT dbo.DPEDIDO.tCodigoProducto, SUM(dbo.TCOMBOPROPIEDAD.nInsumo * dbo.CPEDIDO.nCantidad) AS Insumo, SUM(dbo.TCOMBOPROPIEDAD.nGasto * dbo.CPEDIDO.nCantidad) AS Gasto, SUM(dbo.TCOMBOPROPIEDAD.nManoObra * dbo.CPEDIDO.nCantidad) AS Obra ' + 
				          ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' + 
				          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.DPEDIDO.tFacturado <> '+@comilla+ 'C'+@comilla+' AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @sCriterio +
				          ' GROUP BY dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.Codigo = T2.tCodigoProducto '
				   EXECUTE  sp_executesql @sql
				
		                  
		--Actualiza Cortesias
				 SET @sql=' Update #DBTRANSR set ValorVenta = T1.ValorVenta, Cortesia= (T1.Insumo + T1.Gasto + T1.MObra) , nCortesia= T1.Cantidad  From ' + 
				          ' (SELECT dbo.DPEDIDO.tCodigoProducto AS Codigo, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nPrecioNeto) / sum(dbo.dpedido.ncantidad) AS ValorVenta, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nInsumo) AS Insumo, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nGasto) AS Gasto, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nManoObra) AS MObra, SUM(dbo.DPEDIDO.nCantidad) AS Cantidad ' + 
				          ' FROM dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
				          ' WHERE tFacturado = '+@comilla+ 'C'+@comilla+' AND tEstadoItem = N'+@comilla+ 'N'+@comilla+' and ' + @SCRITERIO + 
				          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo '
				   EXECUTE  sp_executesql @sql
				      
		--Actualiza Cortesias con Propiedades
				SET @sql= ' Update #DBTRANSR  set Cortesia=#DBTRANSR.Cortesia + T1.Insumo + T1.Gasto + T1.MObra  From ' + 
				          ' (SELECT dbo.DPEDIDO.tCodigoProducto AS Codigo, SUM(dbo.DPEDIDO.nCantidad * dbo.TPRODUCTOPROPIEDAD.nInsumo) AS Insumo, SUM(dbo.DPEDIDO.nCantidad * dbo.TPRODUCTOPROPIEDAD.nGasto) AS Gasto, SUM(dbo.DPEDIDO.nCantidad * dbo.TPRODUCTOPROPIEDAD.nManoObra) AS MObra ' + 
				          ' FROM dbo.TPRODUCTOPROPIEDAD INNER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
				          ' WHERE tFacturado = '+@comilla+ 'C'+@comilla+' AND tEstadoItem = N'+@comilla+ 'N'+@comilla+' and ' + @SCRITERIO + 
				          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo '
				   EXECUTE  sp_executesql @sql
				                  
		--Actualiza Combos de Cortesias
				  SET @sql= ' Update #DBTRANSR  set Cortesia= Cortesia + T2.Insumo + T2.Gasto + T2.Obra  FROM #DBTRANSR as T1 INNER JOIN ' + 
				          ' (SELECT dbo.DPEDIDO.tCodigoProducto, SUM(dbo.CPEDIDO.nInsumo*dbo.CPEDIDO.nCantidad) AS Insumo, SUM(dbo.CPEDIDO.nGasto*dbo.CPEDIDO.nCantidad) AS Gasto, SUM(dbo.CPEDIDO.nManoObra*dbo.CPEDIDO.nCantidad) AS Obra ' + 
				          ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' + 
				          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @sCriterio +
				          ' GROUP BY dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.Codigo = T2.tCodigoProducto '
				   EXECUTE  sp_executesql @sql
				                  
		--Actualiza Combos de Cortesias con Propiedades
				    SET @sql=' Update #DBTRANSR  set Cortesia = Cortesia + T2.Insumo + T2.Gasto + T2.Obra  FROM #DBTRANSR as T1 INNER JOIN ' + 
				          ' (SELECT dbo.DPEDIDO.tCodigoProducto, SUM(dbo.TCOMBOPROPIEDAD.nInsumo * dbo.CPEDIDO.nCantidad) AS Insumo, SUM(dbo.TCOMBOPROPIEDAD.nGasto * dbo.CPEDIDO.nCantidad) AS Gasto, SUM(dbo.TCOMBOPROPIEDAD.nManoObra * dbo.CPEDIDO.nCantidad) AS Obra ' + 
				          ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' + 
				          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @sCriterio +
				          ' GROUP BY dbo.DPEDIDO.tCodigoProducto) as T2   ON T1.Codigo = T2.tCodigoProducto ' 
				
				   EXECUTE  sp_executesql @sql
				
		                        
		   --Borra los ceros
		  delete from #DBTRANSR where (Cantidad <=0 or isnull(Cantidad,'0')='0') and nCortesia<=0
		
		
		--PROPIEDADES
/*
	 	set @sql=' insert into #dbtrans0   ' +
		 	 ' SELECT   	dbo.TPRODUCTOPROPIEDAD.tProducto, dbo.TPRODUCTOPROPIEDAD.tCodigoPedido, dbo.TPRODUCTOPROPIEDAD.tItem, isnull(dbo.DPEDIDO.nCantidad,0) as ncantidad,ISNULL(dbo.vPropiedad.Operador+ '+@comilla+ ' '+@comilla+'+ dbo.vPropiedad.Descripcion, '+@comilla+ '*'+@comilla+') AS Propiedad, dbo.dpedido.nprecioneto nvalorventa, ISNULL(DBO.DPEDIDO.NINSUMO,0)+ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) AS ninsumo,  ISNULL(DBO.DPEDIDO.NGASTO,0)+ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) AS ngasto,  ISNULL(DBO.DPEDIDO.NMANOOBRA,0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS mObra, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS Tcosto,dbo.DPEDIDO.nCantidad * dbo.DPEDIDO.nPrecioNeto As VentaTotal ' +
	 		 ' FROM           dbo.TPRODUCTOPROPIEDAD INNER JOIN dbo.vProducto ON dbo.TPRODUCTOPROPIEDAD.tProducto = dbo.vProducto.Codigo INNER JOIN  dbo.MPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN dbo.vPropiedad ON dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad = dbo.vPropiedad.Codigo ' + 
			 ' WHERE 	dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and (dbo.DPEDIDO.tFacturado = N'+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = N'+@comilla+ 'F'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = N'+@comilla+ 'N'+@comilla+') and  ' + 
					' (isnull(tproductopropiedad.ninsumo,0)+isnull(tproductopropiedad.ngasto,0)+isnull(tproductopropiedad.nmanoobra,0))<>0 AND ' + @scriterio +
			 ' ORDER BY 	dbo.TPRODUCTOPROPIEDAD.tProducto,dbo.TPRODUCTOPROPIEDAD.tCodigoPedido, dbo.TPRODUCTOPROPIEDAD.tItem '
*/

	 	set @sql=' insert into #dbtrans0   ' +
		 	 ' SELECT   	dbo.TPRODUCTOPROPIEDAD.tProducto, dbo.TPRODUCTOPROPIEDAD.tCodigoPedido, dbo.TPRODUCTOPROPIEDAD.tItem, isnull(dbo.DPEDIDO.nCantidad,0) as ncantidad,ISNULL(dbo.vPropiedad.Operador+ '+@comilla+ ' '+@comilla+'+ dbo.vPropiedad.Descripcion, '+@comilla+ '*'+@comilla+') AS Propiedad, dbo.dpedido.nprecioneto nvalorventa, ISNULL(DBO.DPEDIDO.NINSUMO,0)+ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) AS ninsumo,  ISNULL(DBO.DPEDIDO.NGASTO,0)+ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) AS ngasto,  ISNULL(DBO.DPEDIDO.NMANOOBRA,0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS mObra, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS Tcosto,dbo.DPEDIDO.nCantidad * dbo.DPEDIDO.nPrecioNeto As VentaTotal ' +
	 		 ' FROM           dbo.TPRODUCTOPROPIEDAD INNER JOIN dbo.vProducto ON dbo.TPRODUCTOPROPIEDAD.tProducto = dbo.vProducto.Codigo INNER JOIN  dbo.MPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN dbo.vPropiedad ON dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad = dbo.vPropiedad.Codigo ' + 
			 ' WHERE 	dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and (dbo.DPEDIDO.tFacturado = N'+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = N'+@comilla+ 'F'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = N'+@comilla+ 'N'+@comilla+') and  ' + 
					' ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1)) AND ' + @scriterio +
			 ' ORDER BY 	dbo.TPRODUCTOPROPIEDAD.tProducto,dbo.TPRODUCTOPROPIEDAD.tCodigoPedido, dbo.TPRODUCTOPROPIEDAD.tItem '


	--	print @sql
		EXECUTE  sp_executesql @sql
		
	END
if @flagFacturado=1 
		begin 

		--Actualiza Valores de la Venta
		
				-- con todo y propiedades
				/*
				SET @sql= ' Update #DBTRANSR set ValorVenta=T1.ValorVenta, Insumo=T1.Insumo, Gasto=T1.Gasto, MObra=T1.Mobra, Cantidad=T1.Cantidad, VentaTotal=T1.VentaTotal From ' + 
				          ' (SELECT dbo.DPEDIDO.tCodigoProducto AS Codigo, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nPrecioNeto) / sum(dbo.dpedido.ncantidad) AS ValorVenta, ' + 
				          ' sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nInsumo) AS Insumo, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nGasto) AS Gasto, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nManoObra) AS MObra, ' + 
				          ' SUM(dbo.DPEDIDO.nCantidad) AS Cantidad, SUM(dbo.DPEDIDO.nCantidad * dbo.DPEDIDO.nPrecioNeto) As VentaTotal ' + 
				          ' FROM dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
				          ' WHERE (tFacturado = N'+@comilla+ 'P'+@comilla+' OR tFacturado = N'+@comilla+ 'F'+@comilla+') AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @SCRITERIO + 
				          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo'
				   EXECUTE  sp_executesql @sql
				*/
				--sin propieades
				/*SET @sql= ' Update #DBTRANSR set ValorVenta=T1.ValorVenta, Insumo=T1.Insumo, Gasto=T1.Gasto, MObra=T1.Mobra, Cantidad=T1.Cantidad, VentaTotal=T1.VentaTotal From ' + 
				          ' (SELECT dbo.DPEDIDO.tCodigoProducto AS Codigo, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nPrecioNeto) / sum(dbo.dpedido.ncantidad) AS ValorVenta, ' + 
				          ' sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nInsumo) AS Insumo, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nGasto) AS Gasto, sum(dbo.dpedido.ncantidad * dbo.DPEDIDO.nManoObra) AS MObra, ' + 
				          ' SUM(dbo.DPEDIDO.nCantidad) AS Cantidad, SUM(dbo.DPEDIDO.nCantidad * dbo.DPEDIDO.nPrecioNeto) As VentaTotal ' + 
				          ' FROM  dbo.TPRODUCTOPROPIEDAD RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
				          ' WHERE (tFacturado = N'+@comilla+ 'P'+@comilla+' OR tFacturado = N'+@comilla+ 'F'+@comilla+') AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') AND (dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad IS NULL) and ' + @SCRITERIO + 
				          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo'
*/
				SET @sql= ' Update #DBTRANSR set ValorVenta=T1.ValorVenta, Insumo=T1.Insumo, Gasto=T1.Gasto, MObra=T1.Mobra, Cantidad=T1.Cantidad, VentaTotal=T1.VentaTotal From ' + 
				          ' (SELECT dbo.DPEDIDO.tCodigoProducto AS Codigo, sum(dbo.dpedido.ncantidad *  (case when dpedido.lregistroventa=0 then 0 else dbo.DPEDIDO.nPrecioNeto END) ) / sum(dbo.dpedido.ncantidad) AS ValorVenta, ' + 
				          ' sum(dbo.dpedido.ncantidad *  (case when dpedido.lregistroventa=0 then 0 else dbo.DPEDIDO.nInsumo END )) AS Insumo, sum(dbo.dpedido.ncantidad * (case when dpedido.lregistroventa=0 then 0 else  dbo.DPEDIDO.nGasto END ) ) AS Gasto, sum(dbo.dpedido.ncantidad * (case when dpedido.lregistroventa=0 then 0 else   dbo.DPEDIDO.nManoObra END) ) AS MObra, ' + 
				          ' SUM(dbo.DPEDIDO.nCantidad) AS Cantidad, SUM(dbo.DPEDIDO.nCantidad *  (case when dpedido.lregistroventa=0 then 0 else  dbo.DPEDIDO.nPrecioNeto END) ) As VentaTotal ' + 
				          ' FROM         dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
				          ' WHERE (tFacturado = N'+@comilla+ 'P'+@comilla+' OR tFacturado = N'+@comilla+ 'F'+@comilla+') AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @SCRITERIO + 
				          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo'
				--print @sql
				   EXECUTE  sp_executesql @sql
		         
		 
		
		--Actualiza Valores de la Venta con Propiedades
		
				-- ya no va propiedades
				/*SET @sql= ' Update #DBTRANSR  set Insumo=#DBTRANSR.Insumo + T1.Insumo, Gasto=#DBTRANSR.Gasto + T1.Gasto, MObra=#DBTRANSR.MObra + T1.Mobra  From ' + 
				          ' (SELECT     dbo.DPEDIDO.tCodigoProducto AS Codigo, SUM(dbo.DPEDIDO.nCantidad * dbo.TPRODUCTOPROPIEDAD.nInsumo) AS Insumo, SUM(dbo.DPEDIDO.nCantidad * dbo.TPRODUCTOPROPIEDAD.nGasto) AS Gasto, SUM(dbo.DPEDIDO.nCantidad * dbo.TPRODUCTOPROPIEDAD.nManoObra) AS MObra ' + 
				          ' FROM dbo.TPRODUCTOPROPIEDAD INNER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
				          ' WHERE (tFacturado = N'+@comilla+ 'P'+@comilla+' OR tFacturado = N'+@comilla+ 'F'+@comilla+') AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @SCRITERIO + 
				          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo'
				   EXECUTE  sp_executesql @sql
				  */                
		
		
		--enero 2011
		--Actualiza Combos
				SET @sql= ' Update #DBTRANSR  set Insumo=T2.Insumo , Gasto=T2.Gasto , MObra=T2.Obra   FROM #DBTRANSR as T1 INNER JOIN ' + 
				          ' (SELECT dbo.DPEDIDO.tCodigoProducto, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.CPEDIDO.nInsumo END) *dbo.CPEDIDO.nCantidad) AS Insumo, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.CPEDIDO.nGasto END)*dbo.CPEDIDO.nCantidad) AS Gasto, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.CPEDIDO.nManoObra END)*dbo.CPEDIDO.nCantidad) AS Obra ' + 
				          ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' + 
				          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.DPEDIDO.tFacturado <> '+@comilla+ 'C'+@comilla+' AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @sCriterio +
				          ' GROUP BY dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.Codigo = T2.tCodigoProducto '
				   EXECUTE  sp_executesql @sql
				                  
		--Actualiza Combos con Propiedades
				SET @sql= ' Update #DBTRANSR  set Insumo=t1.insumo+T2.Insumo, Gasto=t1.gasto+T2.Gasto, MObra=t1.mobra+T2.Obra  FROM #DBTRANSR as T1 INNER JOIN ' + 
				          ' (SELECT dbo.DPEDIDO.tCodigoProducto, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.TCOMBOPROPIEDAD.nInsumo END) * dbo.CPEDIDO.nCantidad) AS Insumo, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.TCOMBOPROPIEDAD.nGasto END) * dbo.CPEDIDO.nCantidad) AS Gasto, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.TCOMBOPROPIEDAD.nManoObra END) * dbo.CPEDIDO.nCantidad) AS Obra ' + 
				          ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' + 
				          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.DPEDIDO.tFacturado <> '+@comilla+ 'C'+@comilla+' AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @sCriterio +
				          ' GROUP BY dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.Codigo = T2.tCodigoProducto '
				   EXECUTE  sp_executesql @sql
				
		                  
		--Actualiza Cortesias
				 SET @sql=' Update #DBTRANSR set ValorVenta = T1.ValorVenta, Cortesia= (T1.Insumo + T1.Gasto + T1.MObra) , nCortesia= T1.Cantidad  From ' + 
				          ' (SELECT dbo.DPEDIDO.tCodigoProducto AS Codigo, sum(dbo.dpedido.ncantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.DPEDIDO.nPrecioNeto END)) / sum(dbo.dpedido.ncantidad) AS ValorVenta, sum(dbo.dpedido.ncantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.DPEDIDO.nInsumo END)) AS Insumo, sum(dbo.dpedido.ncantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.DPEDIDO.nGasto END)) AS Gasto, sum(dbo.dpedido.ncantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.DPEDIDO.nManoObra END)) AS MObra, SUM(dbo.DPEDIDO.nCantidad) AS Cantidad ' + 
				          ' FROM dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
				          ' WHERE tFacturado = '+@comilla+ 'C'+@comilla+' AND tEstadoItem = N'+@comilla+ 'N'+@comilla+' and ' + @SCRITERIO + 
				          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo '
				   EXECUTE  sp_executesql @sql
				      
		--Actualiza Cortesias con Propiedades
				SET @sql= ' Update #DBTRANSR  set Cortesia=#DBTRANSR.Cortesia + T1.Insumo + T1.Gasto + T1.MObra  From ' + 
				          ' (SELECT dbo.DPEDIDO.tCodigoProducto AS Codigo, SUM(dbo.DPEDIDO.nCantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.TPRODUCTOPROPIEDAD.nInsumo END)) AS Insumo, SUM(dbo.DPEDIDO.nCantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.TPRODUCTOPROPIEDAD.nGasto END)) AS Gasto, SUM(dbo.DPEDIDO.nCantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.TPRODUCTOPROPIEDAD.nManoObra END)) AS MObra ' + 
				          ' FROM dbo.TPRODUCTOPROPIEDAD INNER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' + 
				          ' WHERE tFacturado = '+@comilla+ 'C'+@comilla+' AND tEstadoItem = N'+@comilla+ 'N'+@comilla+' and ' + @SCRITERIO + 
				          ' GROUP BY tCodigoProducto) AS T1  Where #DBTRANSR.Codigo = T1.Codigo '
				   EXECUTE  sp_executesql @sql
				                  
		--Actualiza Combos de Cortesias
				  SET @sql= ' Update #DBTRANSR  set Cortesia= Cortesia + T2.Insumo + T2.Gasto + T2.Obra  FROM #DBTRANSR as T1 INNER JOIN ' + 
				          ' (SELECT dbo.DPEDIDO.tCodigoProducto, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.CPEDIDO.nInsumo END)*dbo.CPEDIDO.nCantidad) AS Insumo, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.CPEDIDO.nGasto END)*dbo.CPEDIDO.nCantidad) AS Gasto, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.CPEDIDO.nManoObra END) *dbo.CPEDIDO.nCantidad) AS Obra ' + 
				          ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' + 
				          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @sCriterio +
				          ' GROUP BY dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.Codigo = T2.tCodigoProducto '
				   EXECUTE  sp_executesql @sql
				                  
		--Actualiza Combos de Cortesias con Propiedades
				    SET @sql=' Update #DBTRANSR  set Cortesia = Cortesia + T2.Insumo + T2.Gasto + T2.Obra  FROM #DBTRANSR as T1 INNER JOIN ' + 
				          ' (SELECT dbo.DPEDIDO.tCodigoProducto, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.TCOMBOPROPIEDAD.nInsumo END) * dbo.CPEDIDO.nCantidad) AS Insumo, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.TCOMBOPROPIEDAD.nGasto END) * dbo.CPEDIDO.nCantidad) AS Gasto, SUM((case when dpedido.lregistroventa=0 then 0 else dbo.TCOMBOPROPIEDAD.nManoObra END) * dbo.CPEDIDO.nCantidad) AS Obra ' + 
				          ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' + 
				          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' AND (tEstadoItem = N'+@comilla+ 'N'+@comilla+') and ' + @sCriterio +
				          ' GROUP BY dbo.DPEDIDO.tCodigoProducto) as T2   ON T1.Codigo = T2.tCodigoProducto ' 
				
				   EXECUTE  sp_executesql @sql
				
		                        
		   --Borra los ceros
		  delete from #DBTRANSR where (Cantidad <=0 or isnull(Cantidad,'0')='0') and nCortesia<=0
		
		
		--PROPIEDADES
/*
	 	set @sql=' insert into #dbtrans0   ' +
		 	 ' SELECT   	dbo.TPRODUCTOPROPIEDAD.tProducto, dbo.TPRODUCTOPROPIEDAD.tCodigoPedido, dbo.TPRODUCTOPROPIEDAD.tItem, isnull(dbo.DPEDIDO.nCantidad,0) as ncantidad,ISNULL(dbo.vPropiedad.Operador+ '+@comilla+ ' '+@comilla+'+ dbo.vPropiedad.Descripcion, '+@comilla+ '*'+@comilla+') AS Propiedad, dbo.dpedido.nprecioneto nvalorventa, ISNULL(DBO.DPEDIDO.NINSUMO,0)+ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) AS ninsumo,  ISNULL(DBO.DPEDIDO.NGASTO,0)+ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) AS ngasto,  ISNULL(DBO.DPEDIDO.NMANOOBRA,0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS mObra, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) AS Tcosto,dbo.DPEDIDO.nCantidad * dbo.DPEDIDO.nPrecioNeto As VentaTotal ' +
	 		 ' FROM           dbo.TPRODUCTOPROPIEDAD INNER JOIN dbo.vProducto ON dbo.TPRODUCTOPROPIEDAD.tProducto = dbo.vProducto.Codigo INNER JOIN  dbo.MPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN dbo.vPropiedad ON dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad = dbo.vPropiedad.Codigo ' + 
			 ' WHERE 	dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and (dbo.DPEDIDO.tFacturado = N'+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = N'+@comilla+ 'F'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = N'+@comilla+ 'N'+@comilla+') and  ' + 
					' (isnull(tproductopropiedad.ninsumo,0)+isnull(tproductopropiedad.ngasto,0)+isnull(tproductopropiedad.nmanoobra,0))<>0 AND ' + @scriterio +
			 ' ORDER BY 	dbo.TPRODUCTOPROPIEDAD.tProducto,dbo.TPRODUCTOPROPIEDAD.tCodigoPedido, dbo.TPRODUCTOPROPIEDAD.tItem '
*/

	 	set @sql=' insert into #dbtrans0   ' +
		 	 ' SELECT   	dbo.TPRODUCTOPROPIEDAD.tProducto, dbo.TPRODUCTOPROPIEDAD.tCodigoPedido, dbo.TPRODUCTOPROPIEDAD.tItem, isnull(dbo.DPEDIDO.nCantidad,0) as ncantidad,ISNULL(dbo.vPropiedad.Operador+ '+@comilla+ ' '+@comilla+'+ dbo.vPropiedad.Descripcion, '+@comilla+ '*'+@comilla+') AS Propiedad, (case when dpedido.lregistroventa=0 then 0 else dbo.dpedido.nprecioneto END) nvalorventa,(case when dpedido.lregistroventa=0 then 0 else  ISNULL(DBO.DPEDIDO.NINSUMO,0)+ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) END) AS ninsumo, (case when dpedido.lregistroventa=0 then 0 else  ISNULL(DBO.DPEDIDO.NGASTO,0)+ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) END) AS ngasto,(case when dpedido.lregistroventa=0 then 0 else   ISNULL(DBO.DPEDIDO.NMANOOBRA,0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) END) AS mObra,(case when dpedido.lregistroventa=0 then 0 else  ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0) END) AS Tcosto,dbo.DPEDIDO.nCantidad * (case when dpedido.lregistroventa=0 then 0 else dbo.DPEDIDO.nPrecioNeto END) As VentaTotal ' +
	 		 ' FROM           dbo.TPRODUCTOPROPIEDAD INNER JOIN dbo.vProducto ON dbo.TPRODUCTOPROPIEDAD.tProducto = dbo.vProducto.Codigo INNER JOIN  dbo.MPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN dbo.vPropiedad ON dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad = dbo.vPropiedad.Codigo ' + 
			 ' WHERE 	dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and (dbo.DPEDIDO.tFacturado = N'+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = N'+@comilla+ 'F'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = N'+@comilla+ 'N'+@comilla+') and  ' + 
					' ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1)) AND ' + @scriterio +
			 ' ORDER BY 	dbo.TPRODUCTOPROPIEDAD.tProducto,dbo.TPRODUCTOPROPIEDAD.tCodigoPedido, dbo.TPRODUCTOPROPIEDAD.tItem '

	--	print @sql
		EXECUTE  sp_executesql @sql
		

		END


		select @cantidadRegistro= COUNT(*) from #dbtrans0
		while @va<@cantidadRegistro
			begin
				select top 1 @codigoProducto=tproducto, @codigopedido=tcodigoPedido,@item=tItem,@propiedad=Propiedad,@valorventa=valorventa,
					     @nInsumo=nInsumo,@nGasto=nGasto,@nMObra=nMObra,@tCosto=tcosto,@ncantidad=ncantidad,@ventatotal=ventatotal from #DBTRANS0 order by 1,2,3
				if @codigoProductoV=@codigoproducto and @codigoPedidoV=@codigoPedido and @itemV=@item 
					begin
						set @codigoproductov=@codigoproducto
						set @codigopedidoV=@codigoPedido
						set @itemv=@item
						update #dbtrans2
						set propiedad=propiedad + '/'+@propiedad, ninsumo=ninsumo+@ninsumo,ngasto=ngasto+@ngasto,
						    nmobra=nmobra+@nmobra, tcosto=tcosto+@tcosto,ncantidad=ncantidad,valorventa=valorventa,ventatotal=ventatotal+@ventatotal
						where tproducto=@codigoproducto	 and titem=@item and tcodigopedido=@codigopedido
					end
				else
					begin
								set @codigoproductov=@codigoproducto
								set @codigopedidoV=@codigoPedido
								set @itemv=@item
						
						insert into #dbtrans2 
						select top 1  tproducto,tcodigopedido,ncantidad,titem, Propiedad,valorventa,nInsumo,nGasto,nMObra,tcosto,ventatotal 
						from #DBTRANS0 where tproducto=@codigoproducto and tcodigopedido=@codigopedidov and titem=@item and propiedad=@propiedad
						order by 1,2,3
					end 
						DELETE FROM #DBTRANS0 WHERE tproducto=@codigoproducto and tcodigopedido=@codigopedido and
									    titem=@item and propiedad=@propiedad	AND ninsumo=@ninsumo
						set @Va=@Va+1
			end 
		-- tomareporte


			SELECT Codigo, Grupo, SubGrupo, Producto, 
			ValorVenta, CASE when Cantidad=0 then 0 else Insumo/Cantidad END as Insumo, 
			CASE when Cantidad=0 then 0 else Gasto/Cantidad END as Gasto, CASE when Cantidad=0 then 0 else MOBRA/Cantidad END as MObra, 
			CASE when Cantidad=0 then 0 else (Insumo + Gasto + MObra)/Cantidad END AS Costo, 
			CASE when ValorVenta = 0 then 0 else CASE when Cantidad=0 then 0 else (Insumo + Gasto + MObra)/Cantidad END * 100 / ValorVenta end AS PCosto,
			ValorVenta - (CASE when Cantidad=0 then 0 else (Insumo + Gasto + MObra)/Cantidad END) AS Utilidad, CASE when valorventa = 0 then 0 else (ValorVenta - (CASE when Cantidad=0 then 0 else (Insumo + Gasto + MObra)/Cantidad END)) * 100 / ValorVenta end AS pUtilidad, 
			Cantidad, VentaTotal, nCortesia, 
			CASE when nCortesia = 0  then 0 else CASE when nCortesia=0 then 0 else Cortesia/nCortesia END END as Cortesia, 
			((ValorVenta - (CASE when nCortesia=0 then 0 else (Insumo + Gasto + MObra)/nCortesia END)) * Cantidad) - Cortesia as Utilidad  
			From #DBTRANSr 
			union all
			select tproducto,vproducto.grupo,vproducto.subgrupo,vproducto.tresumido+ ' ' + propiedad ,
			sum(#dbtrans2.valorventa)/sum(#dbtrans2.ncantidad) as valorventa, sum( #dbtrans2.ninsumo)/sum( #dbtrans2.ncantidad), 
			sum( #dbtrans2.ngasto)/sum( #dbtrans2.ncantidad) ngasto, sum( #dbtrans2.nmobra)/sum( #dbtrans2.ncantidad) nmobra, 
			sum( #dbtrans2.ninsumo)+sum( #dbtrans2.ngasto) + sum( #dbtrans2.nmobra)/ sum( #dbtrans2.ncantidad) ,
			CASE when sum(#dbtrans2.valorventa) = 0 then 0 else CASE when sum(#dbtrans2.ncantidad)=0 then 0 else (sum(#dbtrans2.nInsumo) + sum(#dbtrans2.nGasto) + sum(#dbtrans2.nMObra))/sum(#dbtrans2.nCantidad) END * 100 / sum(#dbtrans2.valorventa) end AS PCosto,
			sum(#dbtrans2.ventatotal) - (CASE when sum( #dbtrans2.ncantidad)=0 then 0 else (sum( #dbtrans2.ninsumo) + sum( #dbtrans2.ngasto) +  sum( #dbtrans2.nmobra))/sum( #dbtrans2.ncantidad) END) AS Utilidad, CASE when sum(#dbtrans2.ventatotal) = 0 then 0 else (sum(#dbtrans2.ventatotal) - (CASE when sum( #dbtrans2.ncantidad)=0 then 0 else (sum( #dbtrans2.ninsumo) + sum( #dbtrans2.ngasto) +  sum( #dbtrans2.nmobra))/sum( #dbtrans2.ncantidad) END)) * 100 / sum(#dbtrans2.ventatotal) end AS pUtilidad, 
			sum( #dbtrans2.ncantidad) ,sum(#dbtrans2.ventatotal) ,0,0,
			((sum(#dbtrans2.valorventa) - (CASE when 0=0 then 0 else 0 END)) * sum( #dbtrans2.ncantidad)) - 0 as Utilidad  
			from #dbtrans2 inner join vproducto on #dbtrans2.tproducto =vproducto.codigo
			group by tproducto,vproducto.grupo,vproducto.subgrupo,vproducto.tresumido+ ' ' + propiedad
			order by 1,2,3,4

	end
END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE [dbo].[spRep_TiempoDelivery] 
@tEmpacador as nvarchar(20),
@tMotorizado as nvarchar(20),
@finicio as smalldatetime,
@ffinal as smalldatetime,
@tipo as nvarchar(1)

AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(3000)
DECLARE @CanalVenta nvarchar(10)
set @comilla=''''
    
    SET @CanalVenta = ''
    SELECT @CanalVenta = tCodigoCanalVenta FROM TCANALVENTA WHERE lCanalDelivery = 1

	set @scriterio=' and  MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	if @tEmpacador <>''
		SET @sCriterio=@sCriterio + ' and mpedido.tempacador like ' + @comilla+@tEmpacador+'%'+@comilla
	if @tMotorizado<>''
		SET @sCriterio=@sCriterio + ' and MPEDIDO.tmotorizado like  ' + @comilla+@tMotorizado+'%'+@comilla
	
	if @tipo='T'
		BEGIN
		set @sql= ' SELECT dbo.MPEDIDO.tCodigoPedido AS pedido, convert(nVarchar,dbo.MPEDIDO.fRegistro,120) as fRegistro, convert(nvarchar,dbo.MPEDIDO.fEmpacador,8) AS fEmpacador, ISNULL(DATEDIFF(minute, dbo.MPEDIDO.fRegistro, dbo.MPEDIDO.fEmpacador), 0) AS nEmpacador, convert(nvarchar,dbo.MPEDIDO.fAsignacion,8) AS fMotorizado, ISNULL(DATEDIFF(minute, dbo.MPEDIDO.fEmpacador, dbo.MPEDIDO.fAsignacion), 0) AS nMotorizado, convert(nvarchar,dbo.MPEDIDO.fSalida,8) as fSalida,  ' +
		          ' ISNULL(DATEDIFF(minute, dbo.MPEDIDO.fRegistro, dbo.MPEDIDO.fSalida), 0) AS nSalida, convert(nvarchar,dbo.MPEDIDO.fLlegada,8) as fLlegada, ISNULL(DATEDIFF(minute, dbo.MPEDIDO.fSalida, dbo.MPEDIDO.fLlegada), 0) AS nLlegada, dbo.vZona.Descripcion AS Zona, dbo.TDELIVERY.tDireccion AS Referencia, dbo.TDELIVERY.tTelefono, dbo.vMotorizado.Descripcion AS Motorizado, dbo.TDELIVERY.tApellido + '+@comilla+ ', '+@comilla+' + isnull(dbo.TDELIVERY.tNombre, '+@comilla+'Nombre'+@comilla+') AS Cliente  ' +
		          ' FROM dbo.MPEDIDO INNER JOIN dbo.TDELIVERY ON dbo.MPEDIDO.tClienteDelivery = dbo.TDELIVERY.tCodigoDelivery LEFT OUTER JOIN dbo.vMotorizado ON dbo.MPEDIDO.tMotorizado = dbo.vMotorizado.Codigo LEFT OUTER JOIN dbo.vZona ON dbo.TDELIVERY.tZona = dbo.vZona.Codigo  ' +
		          ' where mpedido.testadopedido<>'+@comilla+ '03'+@comilla+' and mpedido.tTipoPedido='+@comilla+ @CanalVenta +@comilla + @sCriterio +
		          ' order by mpedido.tcodigopedido '
			print @sql
			EXEC sp_executesql @sql
		end
	if @tipo='C'
		BEGin
		CREATE TABLE #DBTRANS (Pedido nVarChar(15) collate Modern_Spanish_CI_AS, 
							   fregistroCd datetime ,
							   fregistro nvarchar(30) ,
							   nRecepcion int,
							   fSalida nvarchar(30) ,
							   fEntrega nvarchar(30) ,
							   nEnvio int,
							   fPago nvarchar(30) ,
							   nTotal int,
							   Zona nVarChar(250) collate Modern_Spanish_CI_AS, 
							   Referencia nVarChar(250) collate Modern_Spanish_CI_AS, 
							   Ttelefono nVarChar(50) collate Modern_Spanish_CI_AS,
							   Motorizado nVarChar(150) collate Modern_Spanish_CI_AS, 
							   Cliente nvarchar(200) collate Modern_Spanish_CI_AS)

		set @sql= ' insert into #dbtrans '  + 
				  ' SELECT dbo.MPEDIDO.tCodigoPedido AS pedido,  convert(datetime,isnull(dbo.MPEDIDO.fRegistroCD,mpedido.fregistro),120)  as fRegistroCD, convert(nvarchar,dbo.MPEDIDO.fRegistro,120)  AS fRegistro, ISNULL(DATEDIFF(minute, dbo.MPEDIDO.fRegistroCD, dbo.MPEDIDO.fRegistro), 0) AS nRecepcion,  convert(nvarchar, (SELECT MAX(DISTINCT dbo.MDOCUMENTO.fRegistro) FROM  dbo.DPAGODOCUMENTO INNER JOIN dbo.DPEDIDO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento INNER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento WHERE     (dbo.DPEDIDO.tCodigoPedido =  dbo.MPEDIDO.tCodigoPedido) GROUP BY dbo.MDOCUMENTO.fRegistro) ,120) as fSalida, convert(nvarchar,dbo.MPEDIDO.fEntregaClienteCD,120) AS fEntrega, 0 AS nEnvio, ' +
				  '	CONVERT(nvarchar,(SELECT     MAX(DISTINCT dbo.DPAGODOCUMENTO.fRegistro)   FROM dbo.DPAGODOCUMENTO INNER JOIN dbo.DPEDIDO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento WHERE      (dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido)),120) AS fPago, 0 AS Total, dbo.vZona.Descripcion AS Zona,  dbo.TDELIVERY.tDireccion AS Referencia, dbo.TDELIVERY.tTelefono, dbo.vMotorizado.Descripcion AS Motorizado, dbo.TDELIVERY.tApellido + '+@comilla+ ', '+@comilla+' + isnull(dbo.TDELIVERY.tNombre, '+@comilla+'Nombre'+@comilla+') AS Cliente    ' +
				  '	FROM dbo.MPEDIDO INNER JOIN dbo.TDELIVERY ON dbo.MPEDIDO.tClienteDelivery = dbo.TDELIVERY.tCodigoDelivery LEFT OUTER JOIN dbo.vMotorizado ON dbo.MPEDIDO.tMotorizado = dbo.vMotorizado.Codigo  LEFT OUTER JOIN dbo.vZona ON dbo.TDELIVERY.tZona = dbo.vZona.Codigo   ' +
		          ' where mpedido.testadopedido<>'+@comilla+ '03'+@comilla+' and mpedido.tTipoPedido='+@comilla+ @CanalVenta +@comilla +@sCriterio +
		          ' order by mpedido.tcodigopedido '
		
			print @sql
			 EXEC sp_executesql @sql
				select pedido ,convert(nvarchar,   fregistroCd  ,120) as fregistroCd  ,convert(nvarchar,fregistro,108) fregistro , nRecepcion , convert(nvarchar,fSalida,108)  fSalida,convert(nvarchar,fEntrega,108)  fEntrega  ,ISNULL(DATEDIFF(minute, convert(datetime, fsalida,120), convert(datetime, fEntrega,120)), 0) AS nEnvio ,
							 convert(nvarchar,fPago,108)  fPago , ISNULL(DATEDIFF(minute, convert(datetime,fregistrocd,120), convert(datetime,fEntrega,120)), 0) AS nTotal,	   Zona , Referencia , Ttelefono, Motorizado , Cliente 
				from #dbtrans
				order by pedido
		end
END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



CREATE PROCEDURE [dbo].[spRep_TiempoSalon]

@flagTurnoOFecha as bit,-- si selecciona un turno o rango d fecha
@tLocal as nvarchar(20),
@tSalon as nvarchar(20),
@tTurno as nvarchar(20),
@finicio as smalldatetime,
@ffinal as smalldatetime

AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @Actualizaciones nvarchar(1000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(3000)
declare @xCriterio nvarchar(3000)

set @comilla=''''

if @flagTurnoOFecha=0 
	begin
	set @sCriterio='  MPEDIDO.tTurno like ' + @comilla+@tturno+'%'+@comilla
	set @xCriterio='  MPEDIDO.tTurno like ' + @comilla+@tturno+'%'+@comilla
	end
else
	begin
	set @scriterio='  MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @xcriterio='  MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	end

	if @tlocal <>''
		SET @xCriterio=@sCriterio + ' and vSalon.tLocal like ' + @comilla+@tlocal+'%'+@comilla
	if @tSalon<>''
		SET @sCriterio=@sCriterio + ' and MPEDIDO.tSalon like  ' + @comilla+@tSalon+'%'+@comilla
	
	-- print @scriterio
	--print @sfiltro

		set @sql=  ' SELECT dbo.MPEDIDO.tCodigoPedido AS tCodigoPedido, dbo.MPEDIDO.tSalon, dbo.vSalon.Descripcion AS Salon, dbo.TMESA.tDetallado, dbo.MPEDIDO.nAdulto, dbo.MPEDIDO.fRegistro, dbo.MPEDIDO.fRegCuenta, T1.tDocumento AS tDocumento, T1.FechaDocumento AS FechaDocumento, T1.FechaPago AS FechaPago, ' +
          		   ' isnull(DateDiff(Minute, isnull(dbo.MPEDIDO.fRegistro,0), isnull(T1.FechaDocumento,0)),0) As nT1, isnull(DateDiff(Minute, isnull(dbo.MPEDIDO.fRegistro,0), isnull(T1.FechaPago,0)),0) As nT2 FROM dbo.MPEDIDO INNER JOIN (SELECT DISTINCT dbo.DPEDIDO.tCodigoPedido, dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.fRegistro AS FechaDocumento, dbo.DPAGODOCUMENTO.fRegistro AS FechaPago ' +
          		   ' FROM dbo.DPEDIDO INNER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento INNER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
         		   ' WHERE dbo.MPEDIDO.testadopedido <> '+@comilla+ '03'+@comilla+'  AND ' + @sCriterio + ' ) T1 ON dbo.MPEDIDO.tCodigoPedido = T1.tCodigoPedido INNER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa INNER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ' +
		           ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND ' + @xCriterio + ' order by dbo.MPEDIDO.fRegistro '

EXEC sp_executesql @sql

END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE [dbo].[spRep_VentaCompMensual]
@sPrecio as nvarchar(100),  
@sAno1 as nvarchar(4),  
@sAno2 as nvarchar(4),  
@sMes as nvarchar(4),  
@sTipo1 as nvarchar(4),  
@sTipo2 as nvarchar(4),  
@sTipo3 as nvarchar(4),  
@sFecha1 as nvarchar(400),  
@sFecha2 as nvarchar(400),  
@dHour as float,
@Opcion as nvarchar(10)  
  
AS BEGIN  
  
set nocount on  
declare @sql nvarchar(4000)  
declare @comilla nvarchar(5)  
set @sql=''  
set @comilla=''''  
    
 if (@sAno1 % 4) =0  
 begin  
  if @sMes='02'  
   begin  
   set @sFecha2 ='dbo.MPEDIDO.fRegistro >= DATEADD(HH,0, '+@comilla+@sAno2+'/02/01'') and dbo.MPEDIDO.fRegistro <= DATEADD(HH,24, '+@comilla+@sAno2+'/02/28'')'  
   end  
 end   
   
 CREATE TABLE #DBTRANS (Dia int, tTipoPedido nvarchar(2) collate Modern_Spanish_CI_AS, vSalon Float, vDelivery Float, vLlevar Float, Fecha datetime, nAdulto Int, nTicketD Int, nTicketLL Int)  
  
 CREATE TABLE #DBTRANS1 ( Dia int, vSalon Float, vDelivery Float, vLlevar Float, Fecha Datetime, nAdulto Int, nTicketD Int, nTicketLL Int,  vSalonA Float, vDeliveryA Float, vLlevarA Float, FechaA datetime, nAdultoA Int, nTicketDA Int, nTicketLLA Int)  
  
        create table #DBTRANS2 ( Dia int, vSalonA Float, vDeliveryA Float, vLlevarA Float, FechaA datetime, nAdultoA Int, nTicketDA Int, nTicketLLA Int)  
 --Inserta Ao Actual  
  
if @stipo1=''  
   set @stipo1= @comilla+''+@comilla  
if @stipo2=''  
   set @stipo2= @comilla+''+@comilla  
if @stipo3=''  
   set @stipo3= @comilla+''+@comilla  
   
   
IF @Opcion = 'VENTA'
BEGIN
  
    set @sql=' INSERT INTO #DBTRANS  select (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end) as dia, MPEDIDO.tTipoPedido,  ' +   
           ' (case when mpedido.ttipopedido=' + @sTipo1 +' then sum(' + @sPrecio + ' ) else 0 end) AS vSalon,  ' +   
           ' (case when mpedido.ttipopedido=' + @sTipo2 +' then Sum(' + @sPrecio + ' ) else 0 end) AS vDelivery,  ' +   
           ' (case when mpedido.ttipopedido=' + @sTipo3 +' then Sum(' + @sPrecio + ' ) else 0 end) AS vLlevar,  ' +   
           ' max(Mpedido.fRegistro) as Fecha,  0 as nAdulto,  0 as nTicketD,  0 as nTicketLL  ' +   
           ' FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN     dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento  ' +   
           ' Where mpedido.testadopedido<>'+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sFecha1 +   
           ' group by (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end), Mpedido.ttipopedido  ' +   
           ' order by (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end) '  
--PRINT len(@SQL)  
       EXECUTE sp_executesql @sql  
  
   set @sql= ' update #DBTRANS set Fecha ='+@comilla+@sAno1+'/'+ @sMes +'/'+@comilla+'+ltrim(str(Dia)) '  
       EXECUTE sp_executesql @sql      
  
    set @sql=' update #DBTRANS 
				set 
					nAdulto= T1.nAdulto, 
					nTicketD=T1.nTicketD , 
					nTicketll= T1.nTicketLL   
				from #DBTRANS,  ' +   
           ' (select (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + ' then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end) as dia, tTipoPedido,  ' +   
           ' (case when mpedido.ttipopedido= ' + @sTipo1 +' then count(mPedido.tCodigoPedido) else 0 end) nAdulto,   (case when mpedido.ttipopedido=' + @sTipo2 +'  then count(mPedido.tCodigoPedido) else 0 end) nTicketD,  ' +   
           ' (case when mpedido.ttipopedido= ' + @sTipo3 +' then count(mPedido.tCodigoPedido) else 0 end) nTicketLL    from mpedido  ' +   
           ' Where mpedido.testadopedido<>'+@comilla+ '03'+@comilla+' and ' + @sFecha1 +   
           ' group by  (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + ' then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end), Mpedido.ttipopedido) T1  ' +   
           ' WHERE #DBTRANS.Dia = T1.dia and  #DBTRANS.tTipoPedido = T1.tTipoPedido '  
    EXECUTE sp_executesql @sql  
    --PRINT len(@SQL)  
    set @sql='INSERT INTO #DBTRANS1 
				select 
					dia, 
					sum(vsalon) as vsalon,
					sum(vdelivery) as vdelivery,
					sum(vllevar) as vllevar, 
					convert(datetime, ' + @comilla + @sAno1 + '/' + @sMes + '/' + @comilla + '+ltrim(str(Dia))) as Fecha, 
					sum(nAdulto) as nAdulto,
					sum(nTicketD) as nTicketD,
					Sum(nTicketLL) as nTicketLL,  
					0 as vsalonA, 
					0 as vDeliveryA,
					0 as vLlevarA, 					
					' + @comilla + 'fechaA' + @comilla +' = CASE When ((((' + @sAno1 + ' % 4 = 0) AND (' + @sAno1 + ' % 100 <> 0)) OR ((' + @sAno1 + ' % 100 = 0) AND (' + @sAno1 + ' % 400 = 0))) AND (' + @sMes + ' = ' + @comilla +'02' + @comilla +') AND (Dia = ' + @comilla +'29' + @comilla +')) THEN NULL ELSE convert(datetime, ' + @comilla + @sAno2 + '/' + @sMes + '/' + @comilla + '+ltrim(str(Dia))) END,
					0 as nAdultoA, 
					0 as nTicketDA,
					0 as nTicketLLA 
				From #DBTRANS group by dia '  
       EXECUTE sp_executesql @sql  
    --PRINT len(@SQL)  
      
    --Inserta Ao Anterior  
    set @sql=' delete from #DBTRANS '   
    EXECUTE sp_executesql @sql  
    set @sql=' INSERT INTO #DBTRANS select (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end) as dia, MPEDIDO.tTipoPedido,  ' +   
           ' (case when mpedido.ttipopedido=' + @sTipo1 +' then sum(' + @sPrecio + ' ) else 0 end) vSalon,  ' +   
           ' (case when mpedido.ttipopedido=' + @sTipo2 +' then Sum(' + @sPrecio + ' ) else 0 end) vDelivery,  ' +   
           ' (case when mpedido.ttipopedido=' + @sTipo3 +' then Sum(' + @sPrecio + ' ) else 0 end) vLlevar,  ' +   
           ' max(mPedido.fRegistro) as Fecha,   0 nAdulto,   0 nTicketD,   0 nTicketLL  ' +   
           ' FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN     dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento  ' +   
           ' Where mpedido.testadopedido<>'+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sFecha2 +   
           ' group by (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end), Mpedido.ttipopedido  ' +   
           ' order by (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end) '   
    EXECUTE sp_executesql @sql  
--PRINT len(@SQL)  
   set @sql= ' update #DBTRANS set Fecha ='+@comilla+@sAno2+'/'+ @sMes +'/'+@comilla+'+ltrim(str(Dia)) '  
    EXECUTE sp_executesql @sql  
      
    set @sql='update #DBTRANS set nAdulto= T1.nAdulto, nTicketD=T1.nTicketD , nTicketll= T1.nTicketLL   from #DBTRANS,  ' +   
           ' (select (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + ' then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end) as dia, tTipoPedido,  ' +   
           ' (case when mpedido.ttipopedido=' + @sTipo1 +' then count(mPedido.tCodigoPedido) else 0 end) nAdulto,  ' +   
           ' (case when mpedido.ttipopedido=' + @sTipo2 +' then count(mPedido.tCodigoPedido) else 0 end) nTicketD,  ' +   
           ' (case when mpedido.ttipopedido=' + @sTipo3 +' then count(mPedido.tCodigoPedido) else 0 end) nTicketLL  from mpedido  ' +   
           ' Where mpedido.testadopedido<>'+@comilla+ '03'+@comilla+' and ' + @sFecha2 +   
           ' group by (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + ' then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end), Mpedido.ttipopedido) T1  ' +   
           ' WHERE #DBTRANS.Dia = T1.dia and  #DBTRANS.tTipoPedido = T1.tTipoPedido '  
        EXECUTE sp_executesql @sql  
        --PRINT len(@SQL)  
    set @sql=' INSERT INTO #DbTRANS2 select dia, sum(vsalon) as vsalonA,sum(vdelivery) as vdeliveryA, sum(vllevar) as vllevarA, max(fecha) as FechaA,sum(nAdulto) as nAdultoA,sum(nTicketD) as nTicketDA,Sum(nTicketLL) as nTicketLLA   ' +   
            'From #DBTRANS group by dia ORDER BY DIA '   
    EXECUTE sp_executesql @sql  
--PRINT len(@SQL)  
declare @Cant as integer  
declare @inc as integer  
declare @nDia as integer  
declare @vSalonA as float  
declare @vDeliveryA as float  
declare @vLlevarA as float  
declare @FechaA as datetime  
declare @nAdultoA as float  
declare @nTicketDA as float  
declare @nTicketLLA as float  
  
set @inc=1  
select @cant=count(*) from #dbtrans2  
while @inc<=@cant  
 begin  
  select top 1 @ndia=dia,@vsalona=vsalona,@vdeliverya=vdeliverya,@vllevara=vllevara,@fechaa=fechaa,@nadultoa=nadultoa,@nticketda=nticketda,  
    @nticketlla=nticketlla from #dbtrans2  
  update #dbtrans1 set vsalona=@vsalona,vdeliverya=@vdeliverya,vllevara=@vllevara,fechaa=@fechaa,nadultoa=@nadultoa,  
     nticketda=@nticketda,nticketlla=@nticketlla where dia=@ndia  
  delete from #dbtrans2 where dia=@ndia  
      
 set @inc=@inc+1  
 end  
  
select Dia,Fecha,FechaA,vSalon,vDelivery,vLlevar,vSalonA,vDeliveryA,vLLevarA,nadulto,nticketD,nticketLL,nadultoA,nticketDA,nTicketLLA from #dbtrans1  

END




IF @Opcion= 'PAX'
BEGIN

    set @sql=' INSERT INTO #DBTRANS  select (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end) as dia, MPEDIDO.tTipoPedido,  ' +   
           ' (case when mpedido.ttipopedido=' + @sTipo1 +' then sum(' + @sPrecio + ' ) else 0 end) AS vSalon,  ' +   
           ' (case when mpedido.ttipopedido=' + @sTipo2 +' then Sum(' + @sPrecio + ' ) else 0 end) AS vDelivery,  ' +   
           ' (case when mpedido.ttipopedido=' + @sTipo3 +' then Sum(' + @sPrecio + ' ) else 0 end) AS vLlevar,  ' +   
           ' max(Mpedido.fRegistro) as Fecha,  0 as nAdulto,  0 as nTicketD,  0 as nTicketLL  ' +   
           ' FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN     dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento  ' +   
           ' Where mpedido.testadopedido<>'+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sFecha1 +   
           ' group by (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end), Mpedido.ttipopedido  ' +   
           ' order by (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end) '  
--PRINT len(@SQL)  
       EXECUTE sp_executesql @sql  
  
   set @sql= ' update #DBTRANS set Fecha ='+@comilla+@sAno1+'/'+ @sMes +'/'+@comilla+'+ltrim(str(Dia)) '  
       EXECUTE sp_executesql @sql      
  print '1'
    set @sql=' update #DBTRANS 
				set 
					nAdulto= T1.nAdulto, 
					nTicketD=T1.nTicketD , 
					nTicketll= T1.nTicketLL   
				from #DBTRANS,  ' +   
           ' (select (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + ' then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end) as dia, tTipoPedido,  ' +   
           ' (case when mpedido.ttipopedido= ' + @sTipo1 +' then sum(nadulto) else 0 end) nAdulto,   (case when mpedido.ttipopedido=' + @sTipo2 +'  then sum(nadulto) else 0 end) nTicketD,  ' +   
           ' (case when mpedido.ttipopedido= ' + @sTipo3 +' then sum(nadulto) else 0 end) nTicketLL    from mpedido  ' +   
           ' Where mpedido.testadopedido<>'+@comilla+ '03'+@comilla+' and ' + @sFecha1 +   
           ' group by  (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + ' then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end), Mpedido.ttipopedido) T1  ' +   
           ' WHERE #DBTRANS.Dia = T1.dia and  #DBTRANS.tTipoPedido = T1.tTipoPedido '  
    EXECUTE sp_executesql @sql  
    --PRINT len(@SQL)  
    print '2'
    set @sql='INSERT INTO #DBTRANS1 
				select 
					dia, 
					sum(vsalon) as vsalon,
					sum(vdelivery) as vdelivery,
					sum(vllevar) as vllevar, 
					convert(datetime, ' + @comilla + @sAno1 + '/' + @sMes + '/' + @comilla + '+ltrim(str(Dia))) as Fecha, 
					sum(nAdulto) as nAdulto,
					sum(nTicketD) as nTicketD,
					Sum(nTicketLL) as nTicketLL,  
					0 as vsalonA, 
					0 as vDeliveryA,
					0 as vLlevarA, 					
					' + @comilla + 'fechaA' + @comilla +' = CASE When ((((' + @sAno1 + ' % 4 = 0) AND (' + @sAno1 + ' % 100 <> 0)) OR ((' + @sAno1 + ' % 100 = 0) AND (' + @sAno1 + ' % 400 = 0))) AND (' + @sMes + ' = ' + @comilla +'02' + @comilla +') AND (Dia = ' + @comilla +'29' + @comilla +')) THEN NULL ELSE convert(datetime, ' + @comilla + @sAno2 + '/' + @sMes + '/' + @comilla + '+ltrim(str(Dia))) END,
					0 as nAdultoA, 
					0 as nTicketDA,
					0 as nTicketLLA 
				From #DBTRANS group by dia '  
       EXECUTE sp_executesql @sql  
    --PRINT len(@SQL)  
      print '3'
    --Inserta Ao Anterior  
    set @sql=' delete from #DBTRANS '   
    EXECUTE sp_executesql @sql  
    set @sql=' INSERT INTO #DBTRANS select (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end) as dia, MPEDIDO.tTipoPedido,  ' +   
           ' (case when mpedido.ttipopedido=' + @sTipo1 +' then sum(' + @sPrecio + ' ) else 0 end) vSalon,  ' +   
           ' (case when mpedido.ttipopedido=' + @sTipo2 +' then Sum(' + @sPrecio + ' ) else 0 end) vDelivery,  ' +   
           ' (case when mpedido.ttipopedido=' + @sTipo3 +' then Sum(' + @sPrecio + ' ) else 0 end) vLlevar,  ' +   
           ' max(mPedido.fRegistro) as Fecha,   0 nAdulto,   0 nTicketD,   0 nTicketLL  ' +   
           ' FROM dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN     dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento  ' +   
           ' Where mpedido.testadopedido<>'+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sFecha2 +   
           ' group by (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end), Mpedido.ttipopedido  ' +   
           ' order by (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end) '   
    EXECUTE sp_executesql @sql  
--PRINT len(@SQL)  
   set @sql= ' update #DBTRANS set Fecha ='+@comilla+@sAno2+'/'+ @sMes +'/'+@comilla+'+ltrim(str(Dia)) '  
    EXECUTE sp_executesql @sql  
      
    set @sql='update #DBTRANS set nAdulto= T1.nAdulto, nTicketD=T1.nTicketD , nTicketll= T1.nTicketLL   from #DBTRANS,  ' +   
           ' (select (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + ' then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end) as dia, tTipoPedido,  ' +   
           ' (case when mpedido.ttipopedido=' + @sTipo1 +' then sum(nadulto) else 0 end) nAdulto,  ' +   
           ' (case when mpedido.ttipopedido=' + @sTipo2 +' then sum(nadulto) else 0 end) nTicketD,  ' +   
           ' (case when mpedido.ttipopedido=' + @sTipo3 +' then sum(nadulto) else 0 end) nTicketLL  from mpedido  ' +   
           ' Where mpedido.testadopedido<>'+@comilla+ '03'+@comilla+' and ' + @sFecha2 +   
           ' group by (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + ' then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end), Mpedido.ttipopedido) T1  ' +   
           ' WHERE #DBTRANS.Dia = T1.dia and  #DBTRANS.tTipoPedido = T1.tTipoPedido '  
        EXECUTE sp_executesql @sql  
        --PRINT len(@SQL)  
    set @sql=' INSERT INTO #DbTRANS2 select dia, sum(vsalon) as vsalonA,sum(vdelivery) as vdeliveryA, sum(vllevar) as vllevarA, max(fecha) as FechaA,sum(nAdulto) as nAdultoA,sum(nTicketD) as nTicketDA,Sum(nTicketLL) as nTicketLLA   ' +   
            'From #DBTRANS group by dia ORDER BY DIA '   
    EXECUTE sp_executesql @sql  
--PRINT len(@SQL)  
  
set @inc=1  
select @cant=count(*) from #dbtrans2  
while @inc<=@cant  
 begin  
  select top 1 @ndia=dia,@vsalona=vsalona,@vdeliverya=vdeliverya,@vllevara=vllevara,@fechaa=fechaa,@nadultoa=nadultoa,@nticketda=nticketda,  
    @nticketlla=nticketlla from #dbtrans2  
  update #dbtrans1 set vsalona=@vsalona,vdeliverya=@vdeliverya,vllevara=@vllevara,fechaa=@fechaa,nadultoa=@nadultoa,  
     nticketda=@nticketda,nticketlla=@nticketlla where dia=@ndia  
  delete from #dbtrans2 where dia=@ndia  
      
 set @inc=@inc+1  
 end  
  
select Dia,Fecha,FechaA,vSalon,vDelivery,vLlevar,vSalonA,vDeliveryA,vLLevarA,nadulto,nticketD,nticketLL,nadultoA,nticketDA,nTicketLLA from #dbtrans1  


END


END  
  

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE PROCEDURE [dbo].[spRep_VentaFecha]
@sPrecio as nvarchar(120),
@sAno as nvarchar(4),
@sMes as nvarchar(4),
@sFecha as nvarchar(400),
@dHour as float

AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @comilla nvarchar(5)
set @sql=''
set @comilla=''''

	CREATE TABLE #DBTRANS (Dia int, Salon Float, Delivery Float, Llevar Float, Canal4 Float, Canal5 Float, Venta float, Cantidad Int, Pax Int, TipoPedido nVarchar(3) collate Modern_Spanish_CI_AS)

    set @sql= ' insert #DBTRANS select (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end) as dia, ' + 
              ' (case when mpedido.ttipopedido='+@comilla+ '01'+@comilla+' then sum(' + @sPrecio + ') else 0 end) as Salon, ' + 
	      ' (case when mpedido.ttipopedido='+@comilla+ '02'+@comilla+' then Sum(' + @sPrecio + ') else 0 end) as Delivery, ' + 
              ' (case when mpedido.ttipopedido='+@comilla+ '03'+@comilla+' then Sum(' + @sPrecio + ') else 0 end) as Llevar, ' + 
  	      ' (case when mpedido.ttipopedido='+@comilla+ '04'+@comilla+' then Sum(' + @sPrecio + ') else 0 end) as Canal4, ' + 
      	      ' (case when mpedido.ttipopedido='+@comilla+ '05'+@comilla+' then Sum(' + @sPrecio + ') else 0 end) as Canal5, ' + 
     	      ' sum(' + @sPrecio + ') as Venta,  0, 0,  MPEDIDO.tTipoPedido ' + 
     	      ' FROM dbo.DPEDIDO INNER JOIN  dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN   dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' + 
     	      ' Where mdocumento.testadodocumento<>'+@comilla+ '04'+@comilla+' AND mpedido.testadopedido<>'+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sFecha + 
     	      ' group by (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end), Mpedido.ttipopedido ' + 
     	      ' order by (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end)' 

    EXECUTE sp_executesql @sql
                
    set @sql= 'update #DBTRANS set Cantidad= T1.nC1 + T1.nC2 + T1.nC3 + T1.nC4 + T1.nC5, Pax=T1.nAdulto + T1.nAdulto2 + T1.nAdulto3 + T1.nAdulto4 + T1.nAdulto5  from mpedido, ' + 
           ' (select (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + ' then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end) as dia, ' + 
           ' (case when mpedido.ttipopedido='+@comilla+ '01'+@comilla+' then sum(nadulto) else 0 end) nAdulto, ' + 
           ' (case when mpedido.ttipopedido='+@comilla+ '01'+@comilla+' then count(mPedido.tCodigoPedido) else 0 end) nC1, ' + 
           ' (case when mpedido.ttipopedido='+@comilla+ '02'+@comilla+' then count(mPedido.tCodigoPedido) else 0 end) nC2, ' + 
           ' (case when mpedido.ttipopedido='+@comilla+ '02'+@comilla+' then sum(nadulto) else 0 end) nAdulto2, ' +
           ' (case when mpedido.ttipopedido='+@comilla+ '03'+@comilla+' then count(mPedido.tCodigoPedido) else 0 end) nC3, ' + 
           ' (case when mpedido.ttipopedido='+@comilla+ '03'+@comilla+' then sum(nadulto) else 0 end) nAdulto3, ' +
           ' (case when mpedido.ttipopedido='+@comilla+ '04'+@comilla+' then count(mPedido.tCodigoPedido) else 0 end) nC4, ' + 
           ' (case when mpedido.ttipopedido='+@comilla+ '04'+@comilla+' then sum(nadulto) else 0 end) nAdulto4, ' +
           ' (case when mpedido.ttipopedido='+@comilla+ '05'+@comilla+' then count(mPedido.tCodigoPedido) else 0 end) nC5, ' +
           ' (case when mpedido.ttipopedido='+@comilla+ '05'+@comilla+' then sum(nadulto) else 0 end) nAdulto5,   tTipoPedido   from mpedido ' + 
           ' Where mpedido.testadopedido<>'+@comilla+ '03'+@comilla+' and ' + @sFecha + 
           ' group by (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + ' then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end), Mpedido.ttipopedido) T1 ' + 
           ' WHERE #DBTRANS.Dia = T1.dia and  #DBTRANS.TipoPedido = T1.tTipoPedido' 
 EXECUTE sp_executesql @sql
        
    set @sql= 'select Dia, sum(Salon), sum(Delivery), sum(Llevar), sum(Canal4), sum(Canal5), sum(Venta), sum(Cantidad), sum(Pax), '+@comilla+@sAno+'/'+ @sMes +'/'+@comilla+'+ltrim(str(Dia)) as Fecha from #DBTRANS Group by Dia' 
 EXECUTE sp_executesql @sql    
	--print @sql
    EXECUTE sp_executesql @sql

END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE FUNCTION CreaTabla (@Flag CHAR(3), @Date DATETIME)
RETURNS VARCHAR(20)
--WITH EXECUTE AS CALLER
AS
BEGIN
     DECLARE @Tabla VARCHAR(20);
     SET @Tabla = 'TMP' + @Flag + 
		  CAST(YEAR(@Date) AS CHAR(4)) + 
		 (CASE WHEN LEN(MONTH(@Date))=1 THEN '0' + CAST(MONTH(@Date) AS CHAR(1)) ELSE CAST(MONTH(@Date) AS CHAR(2)) END) + 
		 (CASE WHEN LEN(DAY(@Date))=1 THEN '0' + CAST(DAY(@Date) AS CHAR(1)) ELSE CAST(DAY(@Date) AS CHAR(2)) END) + 
	          CAST(DATEPART(HOUR, @Date) AS VARCHAR(2)) + CAST(DATEPART(MINUTE, @Date) AS VARCHAR(2)) + CAST(DATEPART(SECOND, @Date) AS VARCHAR(2))
     RETURN(@Tabla)
END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON 
GO

create PROCEDURE [dbo].[sp_ActualizaTablas]
@sServidor  as nVarChar(50),
@sBaseDato as nVarchar(50),
@sParametro as nVarchar(100)

AS 

BEGIN



DECLARE @isql as nvarchar(4000)
DECLARE @NombreTabla	NVARCHAR(100)


if substring(@sParametro,1,1)='1'
Begin
	/**/
	SET @NombreTabla = dbo.CreaTabla('001', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TGRUPOACCESO'
	EXECUTE sp_executesql @Isql
	
	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TGRUPOACCESO
		SET @Isql = 'INSERT INTO TGRUPOACCESO SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

	/**/
	SET @NombreTabla = dbo.CreaTabla('002', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TGRUPOUSUARIO'
	EXECUTE sp_executesql @Isql
	
	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TGRUPOUSUARIO
		SET @Isql = 'INSERT INTO TGRUPOUSUARIO SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

	/**/
	SET @NombreTabla = dbo.CreaTabla('003', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TACCESO'
	EXECUTE sp_executesql @Isql
	
	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TACCESO
		SET @Isql = 'INSERT INTO TACCESO SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
end

if substring(@sParametro,2,1)='1'
Begin
	/**/
	SET @NombreTabla = dbo.CreaTabla('004', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TCAJA'
	EXECUTE sp_executesql @Isql
	
	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TCAJA
		SET @Isql = 'INSERT INTO TCAJA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

	/**/
	SET @NombreTabla = dbo.CreaTabla('005', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TAREAIMPRESORA'
	EXECUTE sp_executesql @Isql
	
	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TAREAIMPRESORA
		SET @Isql = 'INSERT INTO TAREAIMPRESORA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

	/**/
end

if substring(@sParametro,3,1)='1'
Begin
	--Trae el Nombre de la tabla Temporal
	SET @NombreTabla = dbo.CreaTabla('006', GETDATE())
	--Asigna los valores de la central al Temporal
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TCLIENTE'
	EXECUTE sp_executesql @Isql
	--Verifica si hay registros para realizar la copia
	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TCLIENTE
		SET @Isql = 'INSERT INTO TCLIENTE SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	--Elimina el Temporal
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
end


--if substring(@sParametro,4,1)='1'
--Begin
--	SET @isql=''
----   delete from TCOMPANIA
--  -- set @isql = 'insert into TCOMPANIA ' + 
--  --             'SELECT * FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TCOMPANIA'
--  -- EXECUTE  sp_executesql @isql
--end

/*SI O SI PASA LAS CUENTAS CORRIENTES*/

	/**/

	--SET @NombreTabla = dbo.CreaTabla('007', GETDATE())
	--SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''TIPOCTACTE'''
	--EXECUTE sp_executesql @Isql

	--SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	--IF @@ROWCOUNT > 0
	--BEGIN
	--	delete from TTABLA WHERE TTABLA='TIPOCTACTE'
	--	SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	--END
	--SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

	--/**/

	--SET @NombreTabla = dbo.CreaTabla('008', GETDATE())
	--SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''SUBTIPOCTACTE'''
	--EXECUTE sp_executesql @Isql

	--SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	--IF @@ROWCOUNT > 0
	--BEGIN
	--	delete from TTABLA WHERE TTABLA='SUBTIPOCTACTE'
	--	SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	--END
	--SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

	--/**/
	--SET @NombreTabla = dbo.CreaTabla('009', GETDATE())
	--SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TCOMPANIA'
	--EXECUTE sp_executesql @Isql
	
	--SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	--IF @@ROWCOUNT > 0
	--BEGIN
 -- 		delete from TCOMPANIA
	--	SET @Isql = 'INSERT INTO TCOMPANIA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	--END
	--SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

--if substring(@sParametro,4,1)='1'
--Begin
--	--SET @NombreTabla = dbo.CreaTabla('010', GETDATE())
--	--SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TDELIVERY'
--	--EXECUTE sp_executesql @Isql
	
--	--SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
--	--IF @@ROWCOUNT > 0
--	--BEGIN
-- -- 		delete from TDELIVERY
--	--	SET @Isql = 'INSERT INTO TDELIVERY SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
--	--END
--	--SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
--end

if substring(@sParametro,5,1)='1'
Begin

/**/
	SET @NombreTabla = dbo.CreaTabla('011', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TGRUPO'
	EXECUTE sp_executesql @Isql
	
	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TGRUPO
		SET @Isql = 'INSERT INTO TGRUPO SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

/**/
	SET @NombreTabla = dbo.CreaTabla('012', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TSUBGRUPO'
	EXECUTE sp_executesql @Isql
	
	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TSUBGRUPO
		SET @Isql = 'INSERT INTO TSUBGRUPO SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
end

if substring(@sParametro,6,1)='1'
Begin
	SET @NombreTabla = dbo.CreaTabla('013', GETDATE())

	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TIMPRESORA'
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TIMPRESORA
		SET @Isql = 'INSERT INTO TIMPRESORA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
end

 


if substring(@sParametro,7,1)='1'
Begin
	SET @NombreTabla = dbo.CreaTabla('015', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TMENSAJE'
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TMENSAJE
		SET @Isql = 'INSERT INTO TMENSAJE SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
END


if substring(@sParametro,8,1)='1'
Begin

	SET @NombreTabla = dbo.CreaTabla('016', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''SALON'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='SALON'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)


/**/
	SET @NombreTabla = dbo.CreaTabla('017', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TMESA'
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TMESA
		SET @Isql = 'INSERT INTO TMESA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

END


if substring(@sParametro,9,1)='1'
Begin
	SET @NombreTabla = dbo.CreaTabla('018', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TMOTIVODESCUENTO'
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TMOTIVODESCUENTO
		SET @Isql = 'INSERT INTO TMOTIVODESCUENTO SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
end

if substring(@sParametro,10,1)='1'
Begin
	SET @NombreTabla = dbo.CreaTabla('019', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TOFERTA'
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TOFERTA
		SET @Isql = 'INSERT INTO TOFERTA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
end

if substring(@sParametro,11,1)='1'
Begin
	SET @NombreTabla = dbo.CreaTabla('020', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TOPERADOR'
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TOPERADOR
		SET @Isql = 'INSERT INTO TOPERADOR SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
end

if substring(@sParametro,12,1)='1'
begin
	SET @NombreTabla = dbo.CreaTabla('021', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TPARAMETRO'
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TPARAMETRO
		SET @Isql = 'INSERT INTO TPARAMETRO SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
end 

if substring(@sParametro,13,1)='1'
Begin


	SET @NombreTabla = dbo.CreaTabla('022', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TPRODUCTO'
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TPRODUCTO
		SET @Isql = 'INSERT INTO TPRODUCTO SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

/**/
	SET @NombreTabla = dbo.CreaTabla('023', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TPRODUCTOAREA'
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TPRODUCTOAREA
		SET @Isql = 'INSERT INTO TPRODUCTOAREA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
/**/
	SET @NombreTabla = dbo.CreaTabla('024', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TCOMBO'
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TCOMBO
		SET @Isql = 'INSERT INTO TCOMBO SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

END

if substring(@sParametro,14,1)='1'
Begin
	SET @NombreTabla = dbo.CreaTabla('025', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TPROPIEDAD'
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TPROPIEDAD
		SET @Isql = 'INSERT INTO TPROPIEDAD SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

END


--if substring(@sParametro,15,1)='1'
--Begin
--	SET @NombreTabla = dbo.CreaTabla('026', GETDATE())
--	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TPRODUCTOXPRODUCTO'
--	EXECUTE sp_executesql @Isql

--	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
--	IF @@ROWCOUNT > 0
--	BEGIN
--  		delete from TPRODUCTOXPRODUCTO
--		SET @Isql = 'INSERT INTO TPRODUCTOXPRODUCTO SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
--	END
--	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

--END

if substring(@sParametro,16,1)='1'
Begin
	SET @NombreTabla = dbo.CreaTabla('027', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTARJETACREDITO'
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TTARJETACREDITO
		SET @Isql = 'INSERT INTO TTARJETACREDITO SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
END


if substring(@sParametro,17,1)='1'
Begin
	SET @NombreTabla = dbo.CreaTabla('028', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTIPOCAMBIO'
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TTIPOCAMBIO
		SET @Isql = 'INSERT INTO TTIPOCAMBIO SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

END

if substring(@sParametro,18,1)='1'
Begin
	SET @NombreTabla = dbo.CreaTabla('029', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TUSUARIO'
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from TUSUARIO
		SET @Isql = 'INSERT INTO TUSUARIO SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

END


/*TTABLA*/

if substring(@sParametro,19,1)='1'
Begin

	SET @NombreTabla = dbo.CreaTabla('030', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''ETIQUETA'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='ETIQUETA'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
/**/
	SET @NombreTabla = dbo.CreaTabla('031', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''CAJARAPIDA'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='CAJARAPIDA'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

END


if substring(@sParametro,20,1)='1'
Begin

	SET @NombreTabla = dbo.CreaTabla('032', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''CORTESIA'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='CORTESIA'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
END


if substring(@sParametro,21,1)='1'
Begin

	SET @NombreTabla = dbo.CreaTabla('033', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''DISTRITO'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='DISTRITO'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
END

if substring(@sParametro,22,1)='1'
Begin
	SET @NombreTabla = dbo.CreaTabla('034', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''MOTIVOELIMINACION'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='MOTIVOELIMINACION'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
END


if substring(@sParametro,23,1)='1'
Begin

	SET @NombreTabla = dbo.CreaTabla('035', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''MOZO'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='MOZO'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

END

if substring(@sParametro,24,1)='1'
Begin

	SET @NombreTabla = dbo.CreaTabla('036', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''MOTORIZADO'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='MOTORIZADO'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

END

if substring(@sParametro,25,1)='1'
Begin
	SET @isql=''
/*
   delete from TTABLA WHERE TTABLA='TIPOCTACTE'
   delete from TTABLA WHERE TTABLA='SUBTIPOCTACTE'
   
   set @isql = 'insert into TTABLA ' + 
               'SELECT * FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''TIPOCTACTE'''
   EXECUTE  sp_executesql @isql

   set @isql = 'insert into TTABLA ' + 
               'SELECT * FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''SUBTIPOCTACTE'''
   EXECUTE  sp_executesql @isql
*/
END

if substring(@sParametro,26,1)='1'
Begin


	SET @NombreTabla = dbo.CreaTabla('038', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''TIPOCANCELACION'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='TIPOCANCELACION'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

END

if substring(@sParametro,27,1)='1'
Begin

	SET @NombreTabla = dbo.CreaTabla('039', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''TIPOCLIENTEFRECUENTE'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='TIPOCLIENTEFRECUENTE'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

END

if substring(@sParametro,28,1)='1'
Begin

	SET @NombreTabla = dbo.CreaTabla('040', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''TIPODOCUMENTO'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='TIPODOCUMENTO'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

END

if substring(@sParametro,29,1)='1'
Begin

	SET @NombreTabla = dbo.CreaTabla('041', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''TIPOIDENTIDAD'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='TIPOIDENTIDAD'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

END

if substring(@sParametro,30,1)='1'
Begin

	SET @NombreTabla = dbo.CreaTabla('042', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''TIPOPRODUCTO'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='TIPOPRODUCTO'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

END

if substring(@sParametro,31,1)='1'
Begin
	SET @NombreTabla = dbo.CreaTabla('043', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''UNIDADNEGOCIO'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='UNIDADNEGOCIO'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
END

if substring(@sParametro,32,1)='1'
Begin
	SET @NombreTabla = dbo.CreaTabla('044', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''TIPOPAGO'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='TIPOPAGO'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
END

if substring(@sParametro,33,1)='1'
Begin

	SET @NombreTabla = dbo.CreaTabla('045', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''EMPACADOR'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='EMPACADOR'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

END


if substring(@sParametro,34,1)='1'
Begin

	SET @NombreTabla = dbo.CreaTabla('046', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''ZONA'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='ZONA'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
END


if substring(@sParametro,35,1)='1'
Begin
	SET @NombreTabla = dbo.CreaTabla('047', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''AREA'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='AREA'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
END

if substring(@sParametro,36,1)='1'
Begin
	SET @NombreTabla = dbo.CreaTabla('048', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.mcierre'
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from mcierre
		SET @Isql = 'INSERT INTO mcierre SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
END

if substring(@sParametro,37,1)='1'
Begin
	SET @NombreTabla = dbo.CreaTabla('049', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''SUCURSAL'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='SUCURSAL'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
END



if substring(@sParametro,38,1)='1'
Begin
	SET @NombreTabla = dbo.CreaTabla('050', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TINSUMO'
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
  		delete from mcierre
		SET @Isql = 'INSERT INTO TINSUMO SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
END

if substring(@sParametro,39,1)="1" 
Begin

	SET @NombreTabla = dbo.CreaTabla('051', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''MAITRE'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='MAITRE'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

END

if substring(@sParametro,40,1)="1" 
Begin

	SET @NombreTabla = dbo.CreaTabla('052', GETDATE())
	SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.TTABLA WHERE TTABLA=''ESTADOFRECUENTE'''
	EXECUTE sp_executesql @Isql

	SET @Isql = 'SELECT TOP 10 * FROM ' + @NombreTabla; EXEC (@Isql)
	IF @@ROWCOUNT > 0
	BEGIN
		delete from TTABLA WHERE TTABLA='ESTADOFRECUENTE'
		SET @Isql = 'INSERT INTO TTABLA SELECT * FROM ' + @NombreTabla; EXECUTE sp_executesql @Isql
	END
	SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)

END



END






GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


--exec sprep_analiticomotorizadointegrado '1','0','0','0','0','0','0','2011/02/01','2011/02/09 23:59 '
CREATE PROCEDURE spRep_AnaliticoMotorizadoIntegrado
@flagProduccion as bit,
@flagVenta as bit,
@flagCortesia as bit,
@flagCuentaCte as bit,
@flagPedidosFacturados as bit,
@flagCombinacion as bit,
@flagCargo as bit,
@sPrecio as nvarchar(150),
@finicio as smalldatetime,
@ffinal as smalldatetime

AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(2000)
declare @sCriterioP nvarchar(2000)
declare @xCriterio nvarchar(2000)

set @comilla=''''
	
	CREATE TABLE #DBTRANS (Motorizado nVarChar(150) collate Modern_Spanish_CI_AS, TipoProducto nVarChar(150) collate Modern_Spanish_CI_AS, Grupo nVarChar(150) collate Modern_Spanish_CI_AS, SubGrupo nVarChar(150) collate Modern_Spanish_CI_AS, Producto nVarChar(150) collate Modern_Spanish_CI_AS, Cantidad Float, Venta Float, nPedidos Float,tcodigopedido nvarchar(15) collate Modern_Spanish_CI_AS,Comision float )

	 set @scriterio =' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @xCriterio =' MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + '  and MDOCUMENTO.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @scriterioP =' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	


if @flagProduccion=1 --produccion
begin
	--Produccion
       set @sql= ' Insert into #DBTRANS (Motorizado, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, nPedidos,tcodigopedido,Comision ) ' +
                 ' SELECT dbo.vMotorizado.Descripcion AS Motorizado, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, A.Pedidos,dbo.dpedido.tcodigopedido, ' + @sPrecio + ' * (isnull(dbo.Vmotorizado.nvalor,0)/100) as Comision  ' +
                 ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vMotorizado ON dbo.MPEDIDO.tMotorizado = dbo.vMotorizado.Codigo RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' +
                 ' LEFT OUTER JOIN (select max(tMotorizado) as tMotorizado, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and MPEDIDO.tTipoPedido='+@comilla+ '02'+@comilla+' and ' + @sCriteriop + ' group by tMotorizado) AS A ON A.tMotorizado=dbo.mPedido.tMotorizado ' +
	         ' where dbo.MPEDIDO.tTipoPedido='+@comilla+ '02'+@comilla+' and MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+ 'N'+@comilla+' and ' + @scriterio
    
END 
	
if @flagVenta=1 --venta
begin
   --Ventas
       set @sql= ' Insert into #DBTRANS (Motorizado, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, nPedidos,tcodigopedido,comision ) ' +
                 ' SELECT dbo.vMotorizado.Descripcion AS Motorizado, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, A.Pedidos,dbo.dpedido.tcodigopedido,' + @sPrecio + ' * (isnull(dbo.Vmotorizado.nvalor,0)/100) as Comision ' +
                 ' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vMotorizado ON dbo.MPEDIDO.tMotorizado = dbo.vMotorizado.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN ' +
                 ' (SELECT MAX(tMotorizado) AS tMotorizado, isnull(COUNT(dbo.mPedido.tCodigoPedido), 0) AS Pedidos From MPEDIDO WHERE MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND MPEDIDO.tTipoPedido = '+@comilla+ '02'+@comilla+' and ' + @sCriteriop + ' GROUP BY tMotorizado) A ON A.tMotorizado = dbo.MPEDIDO.tMotorizado ' +
                 ' WHERE dbo.MPEDIDO.tTipoPedido='+@comilla+ '02'+@comilla+' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sCriterio + ' and ' + @xCriterio
    
end

if @flagCortesia=1 --cortesia
begin
  --  Cortesias
       set @sql= ' Insert into #DBTRANS (Motorizado, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, nPedidos,tcodigopedido,comision ) ' +
                 ' SELECT dbo.vMotorizado.Descripcion AS Motorizado, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, A.Pedidos,dbo.dpedido.tcodigopedido,' + @sPrecio + ' * (isnull(dbo.Vmotorizado.nvalor,0)/100) as Comision ' +
                 ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vMotorizado ON dbo.MPEDIDO.tMotorizado = dbo.vMotorizado.Codigo RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' +
                 ' LEFT OUTER JOIN (select max(tMotorizado) as tMotorizado, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and MPEDIDO.tTipoPedido='+@comilla+ '02'+@comilla+' and ' +@sCriteriop + ' group by tMotorizado) AS A ON A.tMotorizado=dbo.mPedido.tMotorizado ' +
                 ' WHERE dbo.MPEDIDO.tTipoPedido='+@comilla+ '02'+@comilla+' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' and ' + @sCriterio
    
end 


if @flagCuentaCte=1 --cuenta corriente
begin
   --Cuentas Corrientes
       set @sql= ' Insert into #DBTRANS (Motorizado, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, nPedidos,tcodigopedido,comision ) ' +
                 ' SELECT dbo.vMotorizado.Descripcion AS Motorizado, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, A.Pedidos,dbo.dpedido.tcodigopedido,' + @sPrecio + ' * (isnull(dbo.Vmotorizado.nvalor,0)/100) as Comision ' +
                 ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vMotorizado ON dbo.MPEDIDO.tMotorizado = dbo.vMotorizado.Codigo RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' +
                 ' LEFT OUTER JOIN (select max(tMotorizado) as tMotorizado, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and MPEDIDO.tTipoPedido='+@comilla+ '02'+@comilla+' and ' + @sCriteriop +  ' group by tMotorizado) AS A ON A.tMotorizado=dbo.mPedido.tMotorizado ' +
              	 ' where dbo.MPEDIDO.tTipoPedido='+@comilla+ '02'+@comilla+' and MPEDIDO.tEstadoPedido = '+@comilla+ '04'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+ 'N'+@comilla+' and ' + @sCriterio
       
END

if @flagCombinacion=1 --combinacion
begin
  --Combinacion
/*       set @sql= ' Insert into #DBTRANS (Motorizado, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, nPedidos,comision ) ' +
                 ' SELECT dbo.vMotorizado.Descripcion AS Motorizado, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, ' + @sPrecio + ' AS Venta, A.Pedidos,' + @sPrecio + ' * (isnull(dbo.Vmotorizado.nvalor,0)/100) as Comision ' +
                 ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vMotorizado ON dbo.MPEDIDO.tMotorizado = dbo.vMotorizado.Codigo RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProducto = dbo.vProducto.Codigo ' +
              	 ' LEFT OUTER JOIN (select max(tMotorizado) as tMotorizado, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and MPEDIDO.tTipoPedido='+@comilla+ '02'+@comilla+' and ' + @sCriteriop + ' group by tMotorizado) AS A ON A.tMotorizado=dbo.mPedido.tMotorizado ' +
                 ' where dbo.MPEDIDO.tTipoPedido='+@comilla+ '02'+@comilla+' and MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and ' + @sCriterio

*/
	SET @SQL= ' Insert into #DBTRANS (Motorizado, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, nPedidos,tcodigopedido,comision ) ' +
                 ' SELECT dbo.vMotorizado.Descripcion AS Motorizado, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, ' + @sPrecio + ' AS Venta, A.Pedidos,dbo.dpedido.tcodigopedido,' + @sPrecio + ' * (isnull(dbo.Vmotorizado.nvalor,0)/100) as Comision ' +
                 ' FROM         dbo.vProducto RIGHT OUTER JOIN  dbo.vMotorizado RIGHT OUTER JOIN dbo.MPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem ON Dbo.vMotorizado.Codigo = dbo.MPEDIDO.tMotorizado LEFT OUTER JOIN  ' + 
		' (select max(tMotorizado) as tMotorizado, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and MPEDIDO.tTipoPedido='+@comilla+ '02'+@comilla+' and ' + @sCriteriop + ' group by tMotorizado)  A ON dbo.MPEDIDO.tMotorizado = A.tMotorizado ON dbo.vProducto.Codigo = dbo.CPEDIDO.tProductocombo	 ' +
                 ' where dbo.MPEDIDO.tTipoPedido='+@comilla+ '02'+@comilla+' and MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and ' + @sCriterio

end

if @flagCargo=1 --cargo
begin
	   
   --Cargos
       set @sql= ' Insert into #DBTRANS (Motorizado, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, nPedidos,tcodigopedido,comision ) ' +
                 ' SELECT dbo.vMotorizado.Descripcion AS Motorizado, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, A.Pedidos,dbo.dpedido.tcodigopedido,' + @sPrecio + ' * (isnull(dbo.Vmotorizado.nvalor,0)/100) as Comision ' +
                 ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vMotorizado ON dbo.MPEDIDO.tMotorizado = dbo.vMotorizado.Codigo RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' +
                 ' LEFT OUTER JOIN (select max(tMotorizado) as tMotorizado, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and MPEDIDO.tTipoPedido='+@comilla+ '02'+@comilla+' and  ' +@sCriteriop + ' group by tMotorizado) AS A ON A.tMotorizado=dbo.mPedido.tMotorizado ' +
                 ' where dbo.MPEDIDO.tTipoPedido='+@comilla+ '02'+@comilla+' and MPEDIDO.tEstadoPedido = '+@comilla+ '05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+ 'N'+@comilla+' and ' +@sCriterio
   
end	
	
if @flagPedidosFacturados=1 --pedidos facturados
begin
  --Pedidos facturados
       set @sql= ' Insert into #DBTRANS (Motorizado, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, nPedidos,tcodigopedido,comision ) ' +
                 ' SELECT dbo.vMotorizado.Descripcion AS Motorizado, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta, A.Pedidos,dbo.dpedido.tcodigopedido,' + @sPrecio + ' * (isnull(dbo.Vmotorizado.nvalor,0)/100) as Comision ' +
                 ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vMotorizado ON dbo.MPEDIDO.tMotorizado = dbo.vMotorizado.Codigo RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ' +
                 ' LEFT OUTER JOIN (select max(tMotorizado) as tMotorizado, isnull(count(dbo.mPedido.tCodigoPedido),0) as Pedidos from mpedido where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and MPEDIDO.tTipoPedido='+@comilla+ '02'+@comilla+' and ' + @sCriteriop + ' group by tMotorizado) AS A ON A.tMotorizado=dbo.mPedido.tMotorizado ' +
                 ' WHERE dbo.MPEDIDO.tTipoPedido='+@comilla+ '02'+@comilla+' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' +@sCriterio
   
end

EXEC sp_executesql @sql

SELECT Motorizado, TipoProducto, Grupo, SubGrupo, Producto,tcodigopedido, SUM(Cantidad) AS Cantidad, SUM(Venta) AS Ventas, max(nPedidos) as nPedidos  ,round(sum(comision),2) as Comision
From #DBTRANS Group By Motorizado, Grupo, SubGrupo, Producto, TipoProducto,tcodigopedido
/**/


END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO



CREATE PROCEDURE spRep_CtaCteIntegrado
@flagTipo as nvarchar(2),
@fInicio as smalldatetime,
@fFinal as smalldatetime

AS BEGIN
set nocount on 

--exec sprep_ctacteintegrado '2','Jan 1 2010','Feb 15 2011'
/*if @flagTipo='1'   -- consolidado
	begin
		 SELECT dbo.vCompania.Descripcion, dbo.vCompania.Identidad, dbo.vCompania.nConsumo AS Consumo, dbo.vCompania.nLinea AS Linea, dbo.vCompania.nSaldo AS Saldo, dbo.vSalon.[Local] AS Local, MIN(dbo.MPEDIDO.fFecha) AS Fecha, SUM(dbo.DPEDIDO.nVenta) AS Suma , dbo.MPEDIDO.tClienteCtaCte AS tClienteCtaCte,tTipoCtaCte,tsubTipoCtaCte ,testadopedido
            	 FROM dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido RIGHT OUTER JOIN dbo.vCompania ON dbo.MPEDIDO.tClienteCtaCte = dbo.vCompania.Codigo 
		 WHERE isnull(tClienteCtaCte,' ')<>' ' and tEstadoPedido<>'03' AND (dbo.DPEDIDO.tEstadoItem <> 'A') AND MPEDIDO.fRegistro >=@finicio and mpedido.fregistro<@ffinal
 		 GROUP BY dbo.vCompania.Descripcion, dbo.vCompania.Identidad, dbo.vSalon.[Local], dbo.vCompania.nConsumo, dbo.vCompania.nLinea, dbo.vCompania.nSaldo , dbo.MPEDIDO.tClienteCtaCte,tTipoCtaCte,tsubTipoCtaCte ,testadopedido
	end 
*/
if @flagTipo='0'   -- detallado
	begin
         	 SELECT     dbo.vCompania.Descripcion, dbo.vCompania.Identidad, dbo.vCompania.nConsumo, dbo.vCompania.nLinea, dbo.vCompania.nSaldo, 
                      dbo.MPEDIDO.tCodigoPedido, dbo.MPEDIDO.fFecha, dbo.vSalon.[Local] AS [Local], dbo.vEstadoPedido.tResumido AS testadopedido, 
                      dbo.DPEDIDO.nVenta AS nVenta, dbo.MPEDIDO.tClienteCtaCte AS tClienteCtaCte, dbo.vProducto.tResumido AS Producto, dbo.DPEDIDO.nCantidad, 
                      dbo.DPEDIDO.tDocumento, dbo.vCompania.tTipoCtaCte, dbo.vCompania.tSubTipoCtaCte
		FROM         dbo.vSalon RIGHT OUTER JOIN
                      dbo.vEstadoPedido INNER JOIN
                      dbo.MPEDIDO ON dbo.vEstadoPedido.Codigo = dbo.MPEDIDO.tEstadoPedido ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN
                      dbo.vProducto RIGHT OUTER JOIN
                      dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON 
                      dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido RIGHT OUTER JOIN
                      dbo.vCompania ON dbo.MPEDIDO.tClienteCtaCte = dbo.vCompania.Codigo
			WHERE     (ISNULL(dbo.MPEDIDO.tClienteCtaCte, ' ') <> ' ') AND (dbo.DPEDIDO.tEstadoItem <> 'A')AND MPEDIDO.fRegistro >=@finicio and mpedido.fregistro<@ffinal

	end 

if @flagTipo='2'   -- resumido
	begin
         	/*SELECT dbo.vCompania.Descripcion, dbo.vCompania.Identidad, dbo.vCompania.nConsumo, dbo.vCompania.nLinea, dbo.vCompania.nSaldo, dbo.MPEDIDO.tCodigoPedido, dbo.MPEDIDO.fFecha, dbo.vSalon.Local AS Local, tEstadoPedido,  dbo.DPEDIDO.tDocumento, SUM(dbo.DPEDIDO.nVenta) AS nVenta, max(dbo.MPEDIDO.tClienteCtaCte) AS tClienteCtaCte ,dbo.DPEDIDO.tDocumento,tTipoCtaCte,tsubTipoCtaCte 
           	FROM dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido RIGHT OUTER JOIN dbo.vCompania ON dbo.MPEDIDO.tClienteCtaCte = dbo.vCompania.Codigo 
   		WHERE isnull(tClienteCtaCte,' ')<>' ' and tEstadoPedido<> '03' AND (dbo.DPEDIDO.tEstadoItem <> 'A') AND MPEDIDO.fRegistro >=@finicio and mpedido.fregistro<@ffinal
		GROUP BY dbo.vCompania.Descripcion, dbo.vCompania.Identidad, dbo.vCompania.nConsumo, dbo.vCompania.nLinea, dbo.vCompania.nSaldo, dbo.MPEDIDO.tCodigoPedido , dbo.MPEDIDO.fFecha, dbo.vSalon.Local, tEstadoPedido, dbo.DPEDIDO.tDocumento ,tTipoCtaCte,tsubTipoCtaCte 
*/
		SELECT     dbo.vCompania.Descripcion, dbo.vCompania.Identidad, dbo.vCompania.nConsumo, dbo.vCompania.nLinea, dbo.vCompania.nSaldo, 
                      dbo.MPEDIDO.tCodigoPedido, dbo.MPEDIDO.fFecha, dbo.vSalon.[Local] AS [Local], dbo.DPEDIDO.tDocumento, 
                      dbo.vEstadoPedido.tResumido AS testadopedido, SUM(dbo.DPEDIDO.nVenta) AS nVenta, MAX(dbo.MPEDIDO.tClienteCtaCte) AS tClienteCtaCte, 
                      dbo.DPEDIDO.tDocumento AS Expr1, dbo.vCompania.tTipoCtaCte, dbo.vCompania.tSubTipoCtaCte
		FROM         dbo.vEstadoPedido INNER JOIN
			dbo.MPEDIDO ON dbo.vEstadoPedido.Codigo = dbo.MPEDIDO.tEstadoPedido LEFT OUTER JOIN
                      dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido RIGHT OUTER JOIN
                      dbo.vCompania ON dbo.MPEDIDO.tClienteCtaCte = dbo.vCompania.Codigo
		WHERE isnull(tClienteCtaCte,' ')<>' ' and tEstadoPedido<> '03' AND (dbo.DPEDIDO.tEstadoItem <> 'A') AND MPEDIDO.fRegistro >=@finicio and mpedido.fregistro<@ffinal
		GROUP BY dbo.vCompania.Descripcion, dbo.vCompania.Identidad, dbo.vCompania.nConsumo, dbo.vCompania.nLinea, dbo.vCompania.nSaldo, 
                      dbo.MPEDIDO.tCodigoPedido, dbo.MPEDIDO.fFecha, dbo.vSalon.[Local], dbo.DPEDIDO.tDocumento, dbo.vCompania.tTipoCtaCte, 
                      dbo.vCompania.tSubTipoCtaCte, dbo.vEstadoPedido.tResumido

	end 

END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

CREATE PROCEDURE [dbo].[spRep_FormaPagoIntegrado] 
@fRegistroi as smalldatetime ,          
@fRegistrof as smalldatetime ,
@flagPromedio as bit -- 1 valor neto 0 valor venta
AS              
BEGIN
set nocount on
		CREATE TABLE #DBTRANS (Etiqueta nvarchar(50) collate Modern_Spanish_CI_AS, Grupo nVarChar(200) collate Modern_Spanish_CI_AS, nVenta1 Float)
		create table #suma (tDocumento nVarChar(15) collate Modern_Spanish_CI_AS, nNeto float, nImpuesto1 float, nImpuesto2 float, nImpuesto3 float, nVenta float, tTipoPedido nVarChar(2) collate Modern_Spanish_CI_AS,total00 float,NTOTALPROMEDIO FLOAT)
		CREATE TABLE #suma1 (TTIPOPEDIDO nvarchar(50) collate Modern_Spanish_CI_AS, NNETO FLOAT, nVenta  Float,NTOTALPROMEDIO FLOAT)


insert into #DBTRANS  select              
 'CONTADO','Ef  Soles' AS Grupo,  0+(	SELECT 	
		ISNULL(SUM( CASE WHEN dPag.tMoneda = '01' THEN dPag.nMonto ELSE 0 END),0) +
		ISNULL(SUM((CASE WHEN dPag.tMoneda = '02' THEN dPag.nMonto ELSE 0 END)*(dPag.nTipoCambio)),0)
	FROM 
		dbo.DPAGODOCUMENTO as dPag
	WHERE 
		dPag.tTipoPago='01' 
		and isnull(dPag.tDocumento,'0')<>'0' 
	 	And ((dPag.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))-
-- - nEgresoN
(SELECT 	
	ISNULL(SUM(CASE WHEN vEgr.tMoneda = '01' THEN vEgr.nMonto ELSE 0 END),0)
FROM 
	dbo.vEgreso as vEgr
WHERE 
	vEgr.tEstadoDocumento='01' 
	and isnull(vEgr.tCaja,'0')<>'0' 
	And ((vEgr.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))+          
+
(SELECT 
	ISNULL(SUM(CASE WHEN vIng.tMoneda = '01' THEN vIng.nMonto ELSE 0 END),0) + 
	ISNULL(SUM((CASE WHEN vIng.tMoneda = '02' THEN vIng.nMonto ELSE 0 END)*(vIng.nTipoCambio)),0)
FROM 
	dbo.vIngreso as vIng
WHERE 
	vIng.lAnticipo=0 
	and vIng.tEstadoDocumento='01' 
	and isnull(vIng.tCaja,'0')<>'0' 
	and vIng.tTipoPago ='01' 
	And ((vIng.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))+         
+
--  + nIngresoAN + xIngresoAE
(SELECT 	
	ISNULL(SUM(CASE WHEN vIng.tMoneda = '01' THEN vIng.nMonto ELSE 0 END),0)+
	ISNULL(SUM((CASE WHEN vIng.tMoneda = '02' THEN vIng.nMonto ELSE 0 END)*isnull((vIng.nTipoCambio),0)),0)
FROM 
	dbo.vIngreso as vIng
WHERE 
	vIng.lAnticipo=1 
	and vIng.tEstadoDocumento='01' 
	and isnull(vIng.tCaja,'0')<>'0' 
	And vIng.tTipoPago = '01'
	And ((vIng.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))-
-- - xDolar
(select 
	ISNULL(SUM(dPag.nDolar * dPag.nTipoCambio),0) as xSuma 
from 
	dpagodocumento as dPag
where 
	dPag.tTipopago='01' 
	and dPag.tMoneda='02' 
	and isnull(dPag.tDocumento,'0')<>'0' 
 	And ((dPag.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))          

AS nVenta1      
FROM             
 dbo.MDOCUMENTO             
 LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento             
WHERE             
  dbo.DPAGODOCUMENTO.tTipoPago='01'             
 and isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'             
 And ((DPAGODOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof)           
  OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))          
--FONDOS-Efectivo Dolares--------------------------------------------------------------------------------------------------------            
UNION        
SELECT
 'CONTADO','Ef Dolares' AS Grupo,          
 	SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '02' THEN dbo.DPAGODOCUMENTO.nDolar*dbo.DPAGODOCUMENTO.nTipoCambio ELSE 0 END) 

	- (	SELECT ISNULL(SUM(CASE WHEN dbo.vEgreso.tMoneda = '02' THEN dbo.vEgreso.nMonto ELSE 0 END),0) As nVenta2
		FROM 	dbo.vEgreso 
		WHERE 	dbo.vEgreso.tEstadoDocumento='01' 
			and isnull(tCaja,'0')<>'0' 
	 		And ((dbo.vEgreso.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL)))
As nVenta1    
FROM             
 	dbo.MDOCUMENTO             
 	LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento             
WHERE             
 	dbo.DPAGODOCUMENTO.tTipoPago='01'             
 	And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'             
 	And ((DPAGODOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof) OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))
--FONDOS-Tarjeta de Credito--------------------------------------------------------------------------------------------------------            
UNION            
SELECT  'CREDITO',           
 'Ta Cre '+ dbo.TTARJETACREDITO.tResumido AS Grupo,         
 SUM(dbo.DPAGODOCUMENTO.nMonto) as nVenta1      
FROM             
 dbo.TTARJETACREDITO             
 RIGHT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.TTARJETACREDITO.tCodigoTarjeta = dbo.DPAGODOCUMENTO.tTarjeta             
 RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento             
WHERE             
 dbo.DPAGODOCUMENTO.tTipoPago='02'             
 and isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'             
 And ((DPAGODOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof)           
  OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))          
 GROUP BY 'Ta Cre '+dbo.TTARJETACREDITO.tResumido        
--FONDOS-Cheques/Depositos--------------------------------------------------------------------------------------------------------            
UNION            
SELECT  'CREDITO',           
 'Cheq/Depos' AS Grupo,      
 ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '01' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END)+     
 SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '02' THEN dbo.DPAGODOCUMENTO.nMonto*dbo.DPAGODOCUMENTO.nTipoCambio ELSE 0 END),0) As nVenta1
FROM             
 dbo.MDOCUMENTO             
 LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento             
WHERE             
 dbo.DPAGODOCUMENTO.tTipoPago='03'      
 And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'             
 And ((DPAGODOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof)           
  OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))           
--FONDOS-Otros Pagos--------------------------------------------------------------------------------------------------------            
UNION            
SELECT             'CREDITO',
 'Ot Pagos: '+ dbo.dpagodocumento.totrotipopago AS Grupo,        
 ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '01' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END),0)+
 ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '02' THEN dbo.DPAGODOCUMENTO.nMonto*dbo.DPAGODOCUMENTO.nTipoCambio ELSE 0 END),0) As nVenta1      
FROM             
 dbo.MDOCUMENTO             
 LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento             
WHERE             
 dbo.DPAGODOCUMENTO.tTipoPago='04'      
 And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'             
 And ((DPAGODOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof)           
  OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))           
group by  'Ot Pagos: '+dbo.dpagodocumento.totrotipopago
--FONDOS-Puntos--------------------------------------------------------------------------------------------------------            
UNION            
SELECT             'CREDITO',
 'Puntos' AS Grupo,        
 ISNULL(SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '01' THEN dbo.DPAGODOCUMENTO.nMonto ELSE 0 END)+     
 SUM(CASE WHEN dbo.DPAGODOCUMENTO.tMoneda = '02' THEN dbo.DPAGODOCUMENTO.nMonto*dbo.DPAGODOCUMENTO.nTipoCambio ELSE 0 END),0) As nVenta1        
FROM             
 dbo.MDOCUMENTO             
 LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento             
WHERE             
 dbo.DPAGODOCUMENTO.tTipoPago='05'      
 And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'             
 And ((DPAGODOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof)           
  OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))           
union
SELECT             'PROPINA',
 'Propina' AS Grupo,        
 ISNULL(sum(dbo.DPAGODOCUMENTO.nPropina),0) As nVenta1        
FROM             
 dbo.MDOCUMENTO             
 LEFT OUTER JOIN dbo.DPAGODOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DPAGODOCUMENTO.tDocumento             
WHERE             
 dbo.DPAGODOCUMENTO.tTipoPago='02'      
 And isnull(DPAGODOCUMENTO.tDocumento,'0')<>'0'             
 And ((DPAGODOCUMENTO.fRegistro BETWEEN @fRegistroi AND @fRegistrof)           
  OR (@fRegistroi IS NULL AND @fRegistrof IS NULL))      

BEGIN
update #DBTRANS set Grupo='Ot Pagos: '+ isnull((select tresumido from vtipocancelacion where codigo=substring(#DBTRANS.grupo,len(#DBTRANS.grupo)-2,3)),'') where #DBTRANS.grupo like 'Ot Pagos%'
END 

			INSERT #DBTRANS
			 SELECT 'DOCUMENTOS' as tGrupo,  vTipoDocumento.Descripcion + '  EMITIDO' as Documento ,
			sum(case when tEstadoDocumento<> '04'  then 1 else 0 End) as Emitido 
			from MDOCUMENTO LEFT JOIN vTipoDocumento ON MDOCUMENTO.tTipoDocumento = vTipoDocumento.Codigo 
			where tTipoDocumento <> '00' AND ISNULL(TCAJA,'0')<>'0' And MDOCUMENTO.fregistro>=@fRegistroi and mdocumento.fregistro<=@fRegistrof  -- and ' + @sCriterio + '
			Group by tTipoDocumento, vTipoDocumento.Descripcion, substring(tDocumento,2,5)  
			INSERT #DBTRANS
			SELECT 'DOCUMENTOS' as tGrupo,  vTipoDocumento.Descripcion + ' ANULADO' as Documento , 
			sum(case when tEstadoDocumento= '04'  then 1 else 0 End) As Anulado
			from MDOCUMENTO LEFT JOIN vTipoDocumento ON MDOCUMENTO.tTipoDocumento = vTipoDocumento.Codigo 
			where tTipoDocumento <> '00' AND ISNULL(TCAJA,'0')<>'0' And MDOCUMENTO.fregistro>=@fRegistroi and mdocumento.fregistro<=@fRegistrof 
			Group by tTipoDocumento, vTipoDocumento.Descripcion, substring(tDocumento,2,5)  
			ORDER BY 2 

			insert #Suma (tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tTipoPedido) 
		    SELECT DISTINCT dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, dbo.MDOCUMENTO.nVenta, tTipoPedido 
		    FROM dbo.MPEDIDO INNER JOIN dbo.DDOCUMENTO ON dbo.MPEDIDO.tCodigoPedido = dbo.DDOCUMENTO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DDOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento 
		    where tEstadoDocumento<>'04' and tTipoDocumento<>'00' and isnull(MDOCUMENTO.tCaja,'0')<>'0' And MDOCUMENTO.fregistro>=@fRegistroi and mdocumento.fregistro<=@fRegistrof  and mdocumento.ttipodocumento in(select codigo from vtipodocumento where registroventa=1)

		    insert #Suma (tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tTipoPedido) 
		    SELECT DISTINCT dbo.MDOCUMENTO.tDocumento, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3, dbo.MDOCUMENTO.nVenta, 'XX'
		    FROM dbo.MPEDIDO INNER JOIN dbo.DDOCUMENTO ON dbo.MPEDIDO.tCodigoPedido = dbo.DDOCUMENTO.tCodigoPedido RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DDOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento 
		    where tEstadoDocumento<>'04' and tTipoDocumento<>'00' and isnull(MDOCUMENTO.tCaja,'0')<>'0' And MDOCUMENTO.fregistro>=@fRegistroi and mdocumento.fregistro<=@fRegistrof and mdocumento.ttipodocumento in(select codigo from vtipodocumento where registroventa=0)

			update #suma set total00=(select count(tdocumento) from #suma )
			
			UPDATE #SUMA SET NTOTALPROMEDIO= (SELECT isnull(count(tdocumento),0) FROM #SUMA)

			INSERT #SUMA1
	 		select TTIPOPEDIDO,isnull(sum(nNeto),0) as nNeto,  isnull(sum(nVenta),0) as nVenta,   isnull(count(tdocumento),0) as nTotalPromedio 
			 from #Suma group by ttipopedido,isnull(total00,0) 


			if @flagPromedio=0
			begin
				INSERT #DBTRANS
				select 'PROMEDIO DOC', isnull(v.Descripcion,''),  round(nventa/case when ntotalpromedio=0 then 1 else ntotalpromedio end,2)
				from #suma1 inner join vtipopedido V on #suma1.ttipopedido=V.codigo
				WHERE #SUMA1.TTIPOPEDIDO<>'XX'

				INSERT #DBTRANS
				select 'PROMEDIO DOC', 'CONSUMO FACTURADO',  round(nventa/case when ntotalpromedio=0 then 1 else ntotalpromedio end,2)
				from #suma1 inner join vtipopedido V on #suma1.ttipopedido=V.codigo
				WHERE #SUMA1.TTIPOPEDIDO='XX'
			end
			else
			begin
				INSERT #DBTRANS
				select 'PROMEDIO DOC', isnull(v.Descripcion,''),  round(nneto/case when ntotalpromedio=0 then 1 else ntotalpromedio end,2)
				from #suma1 inner join vtipopedido  V on #suma1.ttipopedido=V.codigo
				WHERE #SUMA1.TTIPOPEDIDO<>'XX'

				INSERT #DBTRANS
				select 'PROMEDIO DOC', 'CONSUMO FACTURADO',  round(nneto/case when ntotalpromedio=0 then 1 else ntotalpromedio end,2)
				from #suma1 inner join vtipopedido  V on #suma1.ttipopedido=V.codigo
				WHERE #SUMA1.TTIPOPEDIDO='XX'
			end
		DECLARE @NADULTO FLOAT

		select @nAdulto=isnull(sum(nAdulto),0)   from MPEDIDO where MPEDIDO.tEstadoPedido <> '03'  And fregistro >=@FREGISTROI AND FREGISTRO<=@FREGISTROF

		if @flagPromedio=0
			begin
				INSERT #DBTRANS
				select 'TICKET PROM', 'TICKET PROMEDIO (ADULTOS)', round(nventa/case when @NADULTO=0 then 1 else @nadulto end ,2)
				FROM #SUMA1
				WHERE TTIPOPEDIDO='01'
			END
		ELSE
			BEGIN
				INSERT #DBTRANS
				select 'TICKET PROM', 'TICKET PROMEDIO (ADULTOS)', round(nneto/case when @NADULTO=0 then 1 else @nadulto end ,2)
				FROM #SUMA1
				WHERE TTIPOPEDIDO='01'
			END

	 INSERT #dbtrans
	 SELECT 'VENTA','VENTA TOTAL',(SELECT ROUND(SUM(NVENTA1),2 ) FROM #DBTRANS WHERE ETIQUETA IN ('CONTADO','CREDITO','PROPINA'))

	 SELECT * FROM #DBTRANS ORDER BY 1,2

END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

CREATE PROCEDURE [dbo].[spRep_PaloteoInsumoIntegrado]
@dbAlmacen as nvarchar(50),
@flagPlato as bit,
@flagCombo as bit,
@flagPropiedad as bit,
@flagPCombo as bit,
@flagTipo as bit, --controla que genera es...1 o 2
@finicio as smalldatetime,
@ffinal as smalldatetime
AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @comilla nvarchar(5)
set @comilla=''''
if @flagtipo=0  -- genera1
	begin
		CREATE TABLE #DBTRANS1 (Grupo nVarChar(100) collate Modern_Spanish_CI_AS, SubGrupo nVarChar(100) collate Modern_Spanish_CI_AS, tProducto nVarChar(7) collate Modern_Spanish_CI_AS, Producto nVarChar(150) collate Modern_Spanish_CI_AS, nCantidad Float, tcodigoPedido nVarChar(10) collate Modern_Spanish_CI_AS, tTipoProducto nVarChar(4) collate Modern_Spanish_CI_AS, Familia nVarChar(150) collate Modern_Spanish_CI_AS, SubFamilia nVarChar(150) collate Modern_Spanish_CI_AS, Insumo nVarChar(180) collate Modern_Spanish_CI_AS, UnidadSalida nVarChar(150) collate Modern_Spanish_CI_AS, nConsumo float, nPrecio float, tItem nVarChar(3) collate Modern_Spanish_CI_AS, tInsumo nVarChar(7) collate Modern_Spanish_CI_AS)
	end
else		--genera2
	begin
		CREATE TABLE #DBTRANS (Familia nVarChar(100) collate Modern_Spanish_CI_AS,SubFamilia nVarChar(100) collate Modern_Spanish_CI_AS,tDetallado nVarChar(150) collate Modern_Spanish_CI_AS,Descripcion nVarChar(150) collate Modern_Spanish_CI_AS,PV Float,Prop Float,Comb Float,PropC Float,Total Float,Equival nVarChar(150) collate Modern_Spanish_CI_AS,nFactor Float,nPrecio float, UnidadEntrada nVarChar(150) collate Modern_Spanish_CI_AS,UnidadSalida nVarChar(150) collate Modern_Spanish_CI_AS,tPedido nVarChar(10) collate Modern_Spanish_CI_AS,tItem nVarChar(3) collate Modern_Spanish_CI_AS,tProducto nVarChar(7) collate Modern_Spanish_CI_AS,tInsumo nVarChar(7) collate Modern_Spanish_CI_AS)
	end

if @flagtipo=0 --genera 1
begin
	if @flagPlato=1
	--Inserta Platos Canal1
	  BEGIN	
	       set @sql=' Insert into #DBTRANS1  '+
			' SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'P'+@comilla+' AS tTipoProducto, VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado as Insumo, VINSUMO.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, DPEDIDO.tItem, vInsumo.tCodigoProducto as tinsumo '+
	                ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' +@dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido '+
	                ' WHERE  dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+'01'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem ='+@comilla+ 'N'+@comilla+' ) AND (dbo.MPEDIDO.tTipoPedido ='+@comilla+'01'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo ='+@comilla+ 'R'+@comilla+ ') AND DRV.lCanal1=1 and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla
		--print @sql
	       EXECUTE  sp_executesql @sql
		       --Inserta Platos Canal2
	       set @sql=' Insert into #DBTRANS1 SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'P'+@comilla+' AS tTipoProducto, VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado as Insumo, VINSUMO.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, DPEDIDO.tItem, vInsumo.tCodigoProducto as tinsumo '+
	                ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido '+
	                ' WHERE  dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+'02'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+'02'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+ ') AND DRV.lCanal2=1 and MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla
		--print @sql
	       EXECUTE  sp_executesql @sql

	       --Inserta Platos Canal3
	       set @sql=' Insert into #DBTRANS1  SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'P'+@comilla+'  AS tTipoProducto, VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado as Insumo, VINSUMO.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, DPEDIDO.tItem, vInsumo.tCodigoProducto as tinsumo '+	              
			' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN '+ @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido '+
	                ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+'03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+'03'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND DRV.lCanal3=1 and MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla
--print @sql
	       EXECUTE  sp_executesql @sql

	       --Inserta Platos Canal4
	       set @sql=' Insert into #DBTRANS1  SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'P'+@comilla+' AS tTipoProducto, VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado  as Insumo, VINSUMO.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, DPEDIDO.tItem, vInsumo.tCodigoProducto as tinsumo  '+
	                ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN '+ @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido  '+
	                ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '04'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+'04'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+'04'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND DRV.lCanal4=1 and MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla
		--print @sql	       
	       EXECUTE  sp_executesql @sql

	     --Inserta Platos Canal5
	       set @sql=' Insert into #DBTRANS1 SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'P'+@comilla+' AS tTipoProducto, VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado as Insumo, VINSUMO.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, DPEDIDO.tItem, vInsumo.tCodigoProducto as tinsumo  '+
	                ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN '+ @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN '+ @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN '+ @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido '+
	                ' WHERE  dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '05'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+'05'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+'05'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND DRV.lCanal5=1 and MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla
	      -- print @sql
	       EXECUTE  sp_executesql @sql	    

	       --Inserta Productos directos
	       set @sql=' Insert into #DBTRANS1 SELECT dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'P'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado as Insumo, vInsumo.UnidadSalida, vInsumo.nFactor as nConsumo, vInsumo.nPrecioPromedio / vInsumo.nFactor as nPrecio, '+@comilla+' '+@comilla+','++@comilla+' '+@comilla+ ' FROM dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto INNER JOIN '+ @dbAlmacen +'.dbo.vProducto vInsumo ON dbo.vProducto.tEnlace = vInsumo.tCodigoProducto RIGHT OUTER JOIN  dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido  ' +
			' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) and MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla 
	      -- print @sql
               EXECUTE  sp_executesql @sql
     	 END

	if @flagCombo=1
		begin		

		--Inserta Platos Combos Canal1
       	          set @sql=' Insert into #DBTRANS1    SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'C'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado, vInsumo.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, dbo.CPEDIDO.tItem, vInsumo.tCodigoProducto AS tinsumo  ' +
                        ' FROM  '+ @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN   '+ @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tLocal = DRV.tLocal AND MRV.tRecetaVenta = DRV.tRecetaVenta INNER JOIN   '+ @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN    dbo.DPEDIDO INNER JOIN            dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN  dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
	                ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+'01'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal1 = 1) AND MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla
	       EXECUTE  sp_executesql @sql
		--print @sql
	       --Inserta Platos Combos Canal2

		set @sql=' Insert into #DBTRANS1    SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'C'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado, vInsumo.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, dbo.CPEDIDO.tItem, vInsumo.tCodigoProducto AS tinsumo  ' +
                        ' FROM  '+ @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN   '+ @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tLocal = DRV.tLocal AND MRV.tRecetaVenta = DRV.tRecetaVenta INNER JOIN   '+ @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN    dbo.DPEDIDO INNER JOIN            dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN  dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
                        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+'02'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal2 = 1) AND MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla 

       	       EXECUTE  sp_executesql @sql
--print @sql
              --Inserta Platos Combos Canal3

		 set @sql=' Insert into #DBTRANS1    SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'C'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado, vInsumo.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, dbo.CPEDIDO.tItem, vInsumo.tCodigoProducto AS tinsumo  ' +
                        ' FROM  '+ @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN   '+ @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tLocal = DRV.tLocal AND MRV.tRecetaVenta = DRV.tRecetaVenta INNER JOIN   '+ @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN    dbo.DPEDIDO INNER JOIN            dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN  dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
                        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '03'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal3 = 1) AND  MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla


               EXECUTE  sp_executesql @sql
		--print @sql

	 set @sql=' Insert into #DBTRANS1    SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'C'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado, vInsumo.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, dbo.CPEDIDO.tItem, vInsumo.tCodigoProducto AS tinsumo  ' +
                        ' FROM  '+ @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN   '+ @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tLocal = DRV.tLocal AND MRV.tRecetaVenta = DRV.tRecetaVenta INNER JOIN   '+ @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN    dbo.DPEDIDO INNER JOIN            dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN  dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
                        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '04'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo =' +@comilla+ 'R'+@comilla+') AND (DRV.lCanal4 = 1) AND  MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla


	       EXECUTE  sp_executesql @sql
--print @sql
	      -- Inserta Platos Combos Canal5

  	set @sql=' Insert into #DBTRANS1    SELECT  dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+'C'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado, vInsumo.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, dbo.CPEDIDO.tItem, vInsumo.tCodigoProducto AS tinsumo  ' +
                        ' FROM  '+ @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN   '+ @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tLocal = DRV.tLocal AND MRV.tRecetaVenta = DRV.tRecetaVenta INNER JOIN   '+ @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN    dbo.DPEDIDO INNER JOIN            dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN  dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
                        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '05'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo =' +@comilla+ 'R'+@comilla+') AND (DRV.lCanal5 = 1) AND  MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla


               EXECUTE  sp_executesql @sql
--print @sql
              -- Inserta Productos directos de los Combos
               set @sql=' Insert into #DBTRANS1  SELECT dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion AS Producto, dbo.cPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+ 'C'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado as Insumo, vInsumo.UnidadSalida, vInsumo.nFactor as nConsumo, vInsumo.nPrecioPromedio / vInsumo.nFactor as nPrecio, '+@comilla+' '+@comilla+','++@comilla+' '+@comilla+  ' FROM '+
 			' dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.vProducto INNER JOIN '+ @dbAlmacen +'.dbo.vProducto vInsumo ON dbo.vProducto.tEnlace = vInsumo.tCodigoProducto ON  dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido '+
                        ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla
       	       EXECUTE  sp_executesql @sql

--print @sql
		end
 	if @flagPropiedad=1
		begin
			--'Inserta Platos Propiedades
			 set @sql=' Insert into #DBTRANS1  SELECT dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.tResumido + '+@comilla+ '('+@comilla+'+ MRV.tDescripcion + '+@comilla+ ')'+@comilla+'  AS Producto, dbo.DPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+ 'X'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado as Insumo, vInsumo.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, '+@comilla+' '+@comilla+','+@comilla+' '+@comilla+ ' FROM '+
				  ' dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN '+ @dbAlmacen +'.dbo.MRECETAPROPIEDAD MRV INNER JOIN '+ @dbAlmacen +'.dbo.DRECETAPROPIEDAD DRV ON MRV.tLocal = DRV.tLocal AND MRV.tRecetaPropiedad = DRV.tRecetaPropiedad INNER JOIN '+ @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad = MRV.tCodigoPropiedad RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
  		                  ' WHERE  (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND   (dbo.vProducto.lCombinacion = 0) and MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla
			EXECUTE  sp_executesql @sql
			--print @sql
			--Inserta Productos directos de las Propiedades
        		set @sql= ' Insert into #DBTRANS1 SELECT dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion + '+@comilla+ '('+@comilla+'+ vInsumo.tResumido + '+@comilla+ ')'+@comilla+'  AS Producto, dbo.DPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+ 'X'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado as Insumo, vInsumo.UnidadSalida, vInsumo.nFactor AS nConsumo, vInsumo.nPrecioPromedio / vInsumo.nFactor AS nPrecio, '+@comilla+' '+@comilla+','++@comilla+' '+@comilla+ ' FROM '+
				  ' dbo.vProducto INNER JOIN dbo.DPEDIDO INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem INNER JOIN '+ @dbAlmacen +'.dbo.vProducto vInsumo ON dbo.TPRODUCTOPROPIEDAD.tEnlace = vInsumo.tCodigoProducto ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
	        		  ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND   (dbo.vProducto.lCombinacion = 0) AND tCodigoPropiedad <>'+@comilla+ '9999'+@comilla+' AND MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla
			EXECUTE  sp_executesql @sql
			--print @sql
		end 
	if @flagPCombo=1
		begin
		 	--Inserta Propiedades de los Combos
       			set @sql= ' Insert into #DBTRANS1 SELECT dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion + '+@comilla+ '('+@comilla+' + MRV.tDescripcion + '+@comilla+ ')'+@comilla+' AS Producto, dbo.CPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+ 'Y'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado as Insumo, vInsumo.UnidadSalida, DRV.nCantidad AS nConsumo, DRV.nPrecio, '+@comilla+' '+@comilla+','+@comilla+' '+@comilla+
               			  ' FROM '+ @dbAlmacen +'.dbo.MRECETAPROPIEDAD MRV INNER JOIN '+ @dbAlmacen +'.dbo.DRECETAPROPIEDAD DRV ON MRV.tRecetaPropiedad = DRV.tRecetaPropiedad INNER JOIN '+ @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.TCOMBOPROPIEDAD INNER JOIN dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON dbo.TCOMBOPROPIEDAD.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.TCOMBOPROPIEDAD.tItem = dbo.CPEDIDO.tItem AND dbo.TCOMBOPROPIEDAD.tItemCombo = dbo.CPEDIDO.tItemCombo ON MRV.tRecetaPropiedad = dbo.TCOMBOPROPIEDAD.tEnlace RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
 			          ' WHERE  (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+')   AND (dbo.vProducto.lCombinacion = 0) and MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla

       			EXECUTE  sp_executesql @sql
			--print @sql
			
		       --Inserta Productos directos de las Propiedades de los combos
		       set @sql= ' Insert into #DBTRANS1  SELECT dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Codigo AS tProducto, dbo.vProducto.Descripcion + '+@comilla+ '('+@comilla+' + vInsumo.tResumido + '+@comilla+ ')'+@comilla+' AS Producto, dbo.DPEDIDO.nCantidad, dbo.MPEDIDO.tCodigoPedido, '+@comilla+ 'Y'+@comilla+' AS tTipoProducto, vInsumo.Familia, vInsumo.SubFamilia, vInsumo.tDetallado as Insumo, vInsumo.UnidadSalida, vInsumo.nFactor as nConsumo, vInsumo.nPrecioPromedio / vInsumo.nFactor as nPrecio, '+@comilla+' '+@comilla+','+@comilla+' '+@comilla+ 
		                 ' FROM dbo.vProducto INNER JOIN '+ @dbAlmacen +'.dbo.vProducto vInsumo INNER JOIN dbo.DPEDIDO INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem ON vInsumo.tCodigoProducto = dbo.TCOMBOPROPIEDAD.tEnlace ON  dbo.vProducto.Codigo = dbo.TCOMBOPROPIEDAD.tProducto RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
		                 ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND tCodigoPropiedad <>'+@comilla+ '9999'+@comilla+' AND MPEDIDO.fRegistro >= '+@comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108) + @comilla+' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla

		       EXECUTE  sp_executesql @sql
       
		end

	   --Quita los Sin de las Propiedades

	   delete from #DBTRANS1 where tcodigoPedido + tItem + tProducto + tInsumo in (
           select TPRODUCTOPROPIEDAD.tCodigoPedido + tItem + tProducto + tEnlace FROM dbo.MPEDIDO INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.MPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido 
	   where TPRODUCTOPROPIEDAD.tCodigoPropiedad='9999' and  dbo.MPEDIDO.tEstadoPedido <> '03' and fFecha >= (LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108)) and fFecha <= (LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' ' + convert(varchar(24),@ffinal,108)) )

	  --Quita los Sin de las Propiedades Combos
	    delete from #DBTRANS1 where tcodigoPedido + tItem + tProducto + tInsumo in ( 
	    select TCOMBOPROPIEDAD.tCodigoPedido + tItem + tProducto + tEnlace FROM dbo.MPEDIDO INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.MPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido 
	    where TCOMBOPROPIEDAD.tCodigoPropiedad='9999' and  dbo.MPEDIDO.tEstadoPedido <> '03' and fFecha >= (LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108)) and fFecha <= (LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' ' + convert(varchar(24),@ffinal,108)))
	
	
--			SELECT  Insumo , UnidadSalida, Grupo, SubGrupo, Producto, SUM(nCantidad) AS Cantidad, AVG(nConsumo) AS nConsumo, AVG(nPrecio) AS nPrecio, SUM(nConsumo * nCantidad) AS nTotalConsumo, SUM(nPrecio * nConsumo * nCantidad) AS nTotalPrecio From #DBTRANS1 GROUP BY Familia, SubFamilia, Insumo, UnidadSalida, Grupo, SubGrupo, Producto
--			SELECT  familia, subfamilia,substring(Insumo+ ' - ' + UnidadSalida,1,255)   as tdetallado,  SUM(nConsumo * nCantidad) AS TotalConsumo, SUM(nPrecio * nConsumo * nCantidad) AS nPrecio From #DBTRANS1 where insumo is not null GROUP BY familia,subfamilia,Insumo,UnidadSalida order by 1
			SELECT  familia, subfamilia,unidadsalida,Insumo as tdetallado,  SUM(nConsumo * nCantidad) AS TotalConsumo, SUM(nPrecio * nConsumo * nCantidad) AS nPrecio From #DBTRANS1 where insumo is not null GROUP BY familia,subfamilia,Insumo,UnidadSalida order by 1

end
	

if @flagtipo=1 --genera 2
	begin
		if @flagPlato=1
			begin
				 -- Inserta Platos Canal1
				--Familia nVarChar(50),SubFamilia nVarChar(50),tDetallado nVarChar(50),Descripcion nVarChar(50),PV Float,Prop Float,Comb Float,PropC Float,Total Float,Equival nVarChar(50),nFactor Float,UnidadEntrada nVarChar(50),UnidadSalida nVarChar(50),tPedido nVarChar(10),tItem nVarChar(3),tProducto nVarChar(7),tInsumo nVarChar(7
				set @sql=' Insert into #DBTRANS SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, dbo.DPEDIDO.nCantidad*DRV.nCantidad AS PV, 0 as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor,DRV.nprecio, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				   	 ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = MRV.tCodigoArea ' +
				         ' WHERE vInsumo.lControlDiario = 1  and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+ '01'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '01'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND DRV.lCanal1=1 and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla

				EXECUTE  sp_executesql @sql

				-- Inserta Platos Canal2
				set @sql=' Insert into #DBTRANS SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, dbo.DPEDIDO.nCantidad*DRV.nCantidad AS PV, 0 as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor,DRV.nprecio, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				     	 ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = MRV.tCodigoArea '+
				         ' WHERE vInsumo.lControlDiario = 1 and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+ '02'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '02'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND DRV.lCanal2=1 and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla
				     
				EXECUTE  sp_executesql @sql

				-- Inserta Platos Canal3
				set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, dbo.DPEDIDO.nCantidad*DRV.nCantidad AS PV, 0 as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor,DRV.nprecio, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				        ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = MRV.tCodigoArea ' +
				      	' WHERE vInsumo.lControlDiario = 1 and  dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '03'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND DRV.lCanal3=1 and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla 
	
				EXECUTE  sp_executesql @sql
				
				-- Inserta Platos Canal4
				set @sql=' Insert into #DBTRANS SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, dbo.DPEDIDO.nCantidad*DRV.nCantidad AS PV, 0 as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor,DRV.nprecio, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				        ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = MRV.tCodigoArea ' +
				        ' WHERE vInsumo.lControlDiario = 1 and  dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '04'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+ '04'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '04'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND DRV.lCanal4=1 and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla
				      
				EXECUTE  sp_executesql @sql
				
				-- Inserta Platos Canal5
				set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, dbo.DPEDIDO.nCantidad*DRV.nCantidad AS PV, 0 as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor,DRV.nprecio, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				        ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = MRV.tCodigoArea ' +
				        ' WHERE vInsumo.lControlDiario = 1 and  dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '05'+@comilla+' and dbo.MPEDIDO.tTipoPedido='+@comilla+ '05'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '05'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND DRV.lCanal5=1 and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla 
				EXECUTE  sp_executesql @sql
				
				--Inserta Productos directos
				set @sql=' Insert into #DBTRANS SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, dbo.DPEDIDO.nCantidad*vinsumo.nfactor AS PV, 0 as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor,vInsumo.nPrecioPromedio / vInsumo.nFactor as nPrecio, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, '+@comilla+' '+@comilla+' as tItem, dbo.vProducto.Codigo AS tProducto, '+@comilla+' '+@comilla+' as tInsumo ' +
				        ' FROM dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON dbo.vProducto.tEnlace = vInsumo.tCodigoProducto RIGHT OUTER JOIN  dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT JOIN dbo.vArea On dbo.vProducto.tArea = dbo.vArea.Codigo LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = dbo.vArea.tValor ' +
				        ' WHERE vInsumo.lControlDiario = 1 and (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla 
				EXECUTE  sp_executesql @sql
			end



		IF @flagcombo=1
			begin
				 --Inserta Platos Combos Canal1
				--set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, 0 AS PV, dbo.DPEDIDO.nCantidad*DRV.nCantidad as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				--        ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.CPEDIDO ON MRV.tCodigoPlato = dbo.CPEDIDO.tProductoCombo INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem ON dbo.vProducto.Codigo = dbo.CPEDIDO.tProductoCombo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT JOIN dbo.vArea On dbo.vProducto.tArea = dbo.vArea.Codigo LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = dbo.vArea.tValor  '+
				--        ' WHERE vInsumo.lControlDiario = 1 and MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '01'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal1 = 1) AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vProducto.Area like '+@comilla+@Area + '%'+@comilla 
				       

				set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, 0 AS PV, 0 as Prop,dbo.cPEDIDO.nCantidad*DRV.nCantidad as Comb,  0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor,DRV.nprecio, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				         ' FROM         dbo.MPEDIDO LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN  dbo.vArea ON dbo.vProducto.tArea = dbo.vArea.Codigo LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.vArea AREA ON AREA.Codigo = dbo.vArea.tValor ' +
				        ' WHERE vInsumo.lControlDiario = 1 and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '01'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal1 = 1) AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla 
				EXECUTE  sp_executesql @sql
				   
				--Inserta Platos Combos Canal2
				--set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, 0 AS PV, dbo.DPEDIDO.nCantidad*DRV.nCantidad as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				--        ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.CPEDIDO ON MRV.tCodigoPlato = dbo.CPEDIDO.tProductoCombo INNER JOIN  dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem ON dbo.vProducto.Codigo = dbo.CPEDIDO.tProductoCombo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = MRV.tCodigoArea ' +
				--        ' WHERE vInsumo.lControlDiario = 1 and MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '02'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal2 = 1) AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vProducto.Area like '+@comilla+@Area + '%'+@comilla 

				set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion,0 AS PV, 0 as Prop,dbo.cPEDIDO.nCantidad*DRV.nCantidad as Comb,  0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor,DRV.nprecio, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				' FROM         dbo.MPEDIDO LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN  dbo.vArea ON dbo.vProducto.tArea = dbo.vArea.Codigo LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.vArea AREA ON AREA.Codigo = dbo.vArea.tValor ' +
				        ' WHERE vInsumo.lControlDiario = 1 and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '02'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal2 = 1) AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla




				EXECUTE  sp_executesql @sql
				
				--Inserta Platos Combos Canal3
				--set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, 0 AS PV, dbo.DPEDIDO.nCantidad*DRV.nCantidad as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				--        ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.CPEDIDO ON MRV.tCodigoPlato = dbo.CPEDIDO.tProductoCombo INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem ON dbo.vProducto.Codigo = dbo.CPEDIDO.tProductoCombo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = MRV.tCodigoArea ' +
				--       ' WHERE vInsumo.lControlDiario = 1 and MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '03'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal3 = 1) AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vProducto.Area like '+@comilla+@Area + '%'+@comilla 
				      
				set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, 0 AS PV, 0 as Prop,dbo.cPEDIDO.nCantidad*DRV.nCantidad as Comb,  0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor,DRV.nprecio, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				        ' FROM         dbo.MPEDIDO LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN  dbo.vArea ON dbo.vProducto.tArea = dbo.vArea.Codigo LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.vArea AREA ON AREA.Codigo = dbo.vArea.tValor ' +
				        ' WHERE vInsumo.lControlDiario = 1 and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '03'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal3 = 1) AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla




				EXECUTE  sp_executesql @sql
				
				--Inserta Platos Combos Canal4
				--set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, 0 AS PV, dbo.DPEDIDO.nCantidad*DRV.nCantidad as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				--        ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.CPEDIDO ON MRV.tCodigoPlato = dbo.CPEDIDO.tProductoCombo INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem ON dbo.vProducto.Codigo = dbo.CPEDIDO.tProductoCombo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = MRV.tCodigoArea ' +
				--        ' WHERE vInsumo.lControlDiario = 1 and MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '04'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal4 = 1) AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vProducto.Area like '+@comilla+@Area + '%'+@comilla 
				      
				set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, 0 AS PV, 0 as Prop,dbo.cPEDIDO.nCantidad*DRV.nCantidad as Comb,  0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor,DRV.nprecio, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				        ' FROM         dbo.MPEDIDO LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN  dbo.vArea ON dbo.vProducto.tArea = dbo.vArea.Codigo LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.vArea AREA ON AREA.Codigo = dbo.vArea.tValor ' +
				        ' WHERE vInsumo.lControlDiario = 1  and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '04'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal4 = 1) AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla


				EXECUTE  sp_executesql @sql
				
				--Inserta Platos Combos Canal5
				--set @sql=' Insert into #DBTRANS SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, 0 AS PV, dbo.DPEDIDO.nCantidad*DRV.nCantidad as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				--        ' FROM dbo.MPEDIDO LEFT OUTER JOIN dbo.vProducto INNER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.CPEDIDO ON MRV.tCodigoPlato = dbo.CPEDIDO.tProductoCombo INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem ON dbo.vProducto.Codigo = dbo.CPEDIDO.tProductoCombo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = MRV.tCodigoArea ' +
				--        ' WHERE vInsumo.lControlDiario = 1 and MRV.tLocal='+@comilla+ @sLocal +@comilla+ ' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '05'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal5 = 1) AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla+' and vInsumo.Familia like '+@comilla+@Familia+'%'+@comilla+ ' and vInsumo.SubFamilia like '+@comilla+@Subfamilia+'%'+@comilla+' and vInsumo.tCodigoProducto like '+@comilla+@tCodigoProducto +'%'+@comilla+' and vProducto.Area like '+@comilla+@Area + '%'+@comilla 
				      
				set @sql=' Insert into #DBTRANS SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion,0 AS PV, 0 as Prop,dbo.cPEDIDO.nCantidad*DRV.nCantidad as Comb,  0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor,DRV.nprecio, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, DPEDIDO.tItem as tItem, dbo.vProducto.Codigo AS tProducto, vInsumo.tCodigoProducto as tInsumo ' +
				        ' FROM         dbo.MPEDIDO LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAVENTA MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN  dbo.vArea ON dbo.vProducto.tArea = dbo.vArea.Codigo LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.vArea AREA ON AREA.Codigo = dbo.vArea.tValor ' +
				        ' WHERE vInsumo.lControlDiario = 1 and  dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.MPEDIDO.tTipoPedido = '+@comilla+ '05'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = '+@comilla+ 'R'+@comilla+') AND (DRV.lCanal5 = 1) AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla 



				EXECUTE  sp_executesql @sql
				
				--Inserta Productos directos de los Combos
				set @sql=' Insert into #DBTRANS SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion,0 as Pv,0 as Prop, dbo.Cpedido.ncantidad * vinsumo.nfactor AS Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor,vInsumo.nPrecioPromedio / vInsumo.nFactor as nPrecio, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, '+@comilla+' '+@comilla+' as tItem, dbo.vProducto.Codigo AS tProducto, '+@comilla+' '+@comilla+' as tInsumo ' +
				        ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.vProducto INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON dbo.vProducto.tEnlace = vInsumo.tCodigoProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT JOIN dbo.vArea On dbo.vProducto.tArea = dbo.vArea.Codigo LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = dbo.vArea.tValor ' +
				        ' WHERE vInsumo.lControlDiario = 1 and (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla 
				EXECUTE  sp_executesql @sql
			end	     




		if @flagPropiedad=1
			begin 
			       --Inserta Platos Propiedades
			       set @sql=' Insert into #DBTRANS SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion,  0 AS PV, dbo.DPEDIDO.nCantidad*DRV.nCantidad as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, DRV.nPrecio,VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, '+@comilla+' '+@comilla+' as tItem, dbo.vProducto.Codigo AS tProducto, '+@comilla+' '+@comilla+' as tInsumo  ' +
			              	' FROM dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN ' + @dbAlmacen +'.dbo.MRECETAPROPIEDAD MRV INNER JOIN '+ @dbAlmacen +'.dbo.DRECETAPROPIEDAD DRV ON MRV.tLocal = DRV.tLocal AND MRV.tRecetaPropiedad = DRV.tRecetaPropiedad INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad = MRV.tCodigoPropiedad RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT JOIN dbo.vArea On dbo.vProducto.tArea = dbo.vArea.Codigo LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = dbo.vArea.tValor ' +
			              	' WHERE vInsumo.lControlDiario = 1 and  (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+')   AND (dbo.vProducto.lCombinacion = 0) and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla
			       EXECUTE  sp_executesql @sql
			    
			       --Inserta Productos directos de las Propiedades
			       set @sql=' Insert into #DBTRANS SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, 0 AS PV, dbo.DPEDIDO.nCantidad*DPEDIDO.nCantidad as Prop, 0 as Comb, 0 as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor, vInsumo.nPrecioPromedio / vInsumo.nFactor AS nPrecio,VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, '+@comilla+' '+@comilla+' as tItem, dbo.vProducto.Codigo AS tProducto, '+@comilla+' '+@comilla+' as tInsumo  ' +
			                ' FROM dbo.vProducto INNER JOIN dbo.DPEDIDO INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON dbo.TPRODUCTOPROPIEDAD.tEnlace = vInsumo.tCodigoProducto ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT JOIN dbo.vArea On dbo.vProducto.tArea = dbo.vArea.Codigo LEFT JOIN ' + @dbAlmacen + '.dbo.vAREA as AREA ON AREA.Codigo = dbo.vArea.tValor  ' +
			                ' WHERE vInsumo.lControlDiario = 1 and (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+')   AND (dbo.vProducto.lCombinacion = 0) AND tCodigoPropiedad <>'+@comilla+ '9999'+@comilla+' AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla
			       EXECUTE  sp_executesql @sql			

			end 
		if @flagPCombo=1
			begin
			
			       --Inserta Propiedades de los Combos
			       set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion, 0 AS PV,0 as Prop, 0 as Comb,  dbo.DPEDIDO.nCantidad*DRV.nCantidad as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor,DRV.nPrecio, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, '+@comilla+' '+@comilla+' as tItem, dbo.vProducto.Codigo AS tProducto, '+@comilla+' '+@comilla+' as tInsumo   ' + 
			                ' FROM ' + @dbAlmacen +'.dbo.MRECETAPROPIEDAD MRV INNER JOIN ' + @dbAlmacen +'.dbo.DRECETAPROPIEDAD DRV ON MRV.tRecetaPropiedad = DRV.tRecetaPropiedad INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.TCOMBOPROPIEDAD INNER JOIN dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON dbo.TCOMBOPROPIEDAD.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.TCOMBOPROPIEDAD.tItem = dbo.CPEDIDO.tItem AND dbo.TCOMBOPROPIEDAD.tItemCombo = dbo.CPEDIDO.tItemCombo ON MRV.tRecetaPropiedad = dbo.TCOMBOPROPIEDAD.tEnlace RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT JOIN dbo.vArea On dbo.vProducto.tArea = dbo.vArea.Codigo LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = dbo.vArea.tValor ' +
			                ' WHERE vInsumo.lControlDiario = 1 and  (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+')   AND (dbo.vProducto.lCombinacion = 0) and MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla
			       EXECUTE  sp_executesql @sql
			    
			       --Inserta Productos directos de las Propiedades de los combos
			       set @sql=' Insert into #DBTRANS  SELECT  VINSUMO.Familia, VINSUMO.SubFamilia, VINSUMO.tDetallado,  dbo.vProducto.Descripcion,  0 AS PV,0 as Prop, 0 as Comb,  dbo.DPEDIDO.nCantidad*DPEDIDO.nCantidad as PropC, 0 as Total, 0 as Equival, vInsumo.nFactor,vInsumo.nPrecioPromedio / vInsumo.nFactor AS nPrecio, VINSUMO.UnidadEntrada, VINSUMO.UnidadSalida, dbo.MPEDIDO.tCodigoPedido as tPedido, '+@comilla+' '+@comilla+' as tItem, dbo.vProducto.Codigo AS tProducto, '+@comilla+' '+@comilla+' as tInsumo  ' +
			                ' FROM dbo.vProducto INNER JOIN ' + @dbAlmacen +'.dbo.vProducto vInsumo INNER JOIN dbo.DPEDIDO INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem ON vInsumo.tCodigoProducto = dbo.TCOMBOPROPIEDAD.tEnlace ON dbo.vProducto.Codigo = dbo.TCOMBOPROPIEDAD.tProducto RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT JOIN dbo.vArea On dbo.vProducto.tArea = dbo.vArea.Codigo LEFT JOIN ' + @dbAlmacen +'.dbo.vAREA as AREA ON AREA.Codigo = dbo.vArea.tValor ' +
			                ' WHERE vInsumo.lControlDiario = 1 and (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+') AND (dbo.vProducto.lCombinacion = 0) AND tCodigoPropiedad <>'+@comilla+ '9999'+@comilla+' AND MPEDIDO.fRegistro >= ' + @comilla + LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(8),@fInicio,108) + @comilla + ' And MPEDIDO.fRegistro <= '+@comilla + LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' '+convert(varchar(24),@ffinal,108) + @comilla
			       EXECUTE  sp_executesql @sql
		end 


		--Quita los Sin de las Propiedades
		delete from #DBTRANS where tPedido + tItem + tProducto + tInsumo in ( select TPRODUCTOPROPIEDAD.tCodigoPedido + tItem + tProducto + tEnlace FROM dbo.MPEDIDO INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.MPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido 
		where TPRODUCTOPROPIEDAD.tCodigoPropiedad='9999' and  dbo.MPEDIDO.tEstadoPedido <> '03' and fFecha >= (LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108)) and fFecha <= (LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' ' + convert(varchar(24),@ffinal,108)) )
		
		--Quita los Sin de las Propiedades Combos
		delete from #DBTRANS where tPedido + tItem + tProducto + tInsumo in ( select TCOMBOPROPIEDAD.tCodigoPedido + tItem + tProducto + tEnlace FROM dbo.MPEDIDO INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.MPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido 
		where TCOMBOPROPIEDAD.tCodigoPropiedad='9999' and  dbo.MPEDIDO.tEstadoPedido <> '03' and fFecha >= (LTRIM(STR(MONTH(@Finicio)))+'/'+LTRIM(STR(DAY(@Finicio)))+'/'+LTRIM(STR(YEAR(@Finicio)))+' '+convert(varchar(24),@fInicio,108)) and fFecha <= (LTRIM(STR(MONTH(@Ffinal)))+'/'+LTRIM(STR(DAY(@Ffinal)))+'/'+LTRIM(STR(YEAR(@Ffinal)))+' ' + convert(varchar(24),@ffinal,108)) )

      	--consulta final
		--SELECT Familia, SubFamilia, tDetallado, '', UnidadSalida, SUM(PV) as PV, Sum(Prop) as Prop, Sum(Comb) as Comb, Sum(PropC) as PropC, SUM(PV) + Sum(Prop) + Sum(Comb) + Sum(PropC) as nconsumo,(SUM(PV) + Sum(Prop) + Sum(Comb) + Sum(PropC))*nprecio as total,  Convert(nvarchar,Convert(Int,((SUM(PV) + Sum(Prop) + Sum(Comb) + Sum(PropC))/nFactor))) + ' ' + UnidadEntrada + ' con ' + Convert(nvarchar,((SUM(PV) + Sum(Prop) + Sum(Comb) + Sum(PropC))-nFactor*Convert(Int,((SUM(PV) + Sum(Prop) + Sum(Comb) + Sum(PropC))/nFactor)))) + ' ' + UnidadSalida as Equival From #DBTRANS Group BY Familia, SubFamilia, tDetallado, nFactor, UnidadEntrada, UnidadSalida ,nprecio
		--select familia,subfamilia,substring(tdetallado+' - ' +UnidadSalida,1,255) as tdetallado, SUM(PV) + Sum(Prop) + Sum(Comb) + Sum(PropC) as nconsumo,(SUM(PV) + Sum(Prop) + Sum(Comb) + Sum(PropC))*nprecio as total From #DBTRANS where tdetallado is not null Group BY  familia,subfamilia, tDetallado,UnidadSalida,   nprecio order by 1
		select familia,subfamilia,unidadsalida,tdetallado as tdetallado, SUM(PV) + Sum(Prop) + Sum(Comb) + Sum(PropC) as nconsumo,(SUM(PV) + Sum(Prop) + Sum(Comb) + Sum(PropC))*nprecio as total From #DBTRANS where tdetallado is not null Group BY  familia,subfamilia, tDetallado,UnidadSalida,   nprecio order by 1

	END 
	
END
		
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



--exec spRep_RankingProduccionIntegrado 1, 0, 0, 0, 0, 0, 0, 1, 1,  0, 0, '', '', '', '', 'dbo.DPEDIDO.nPrecioVenta * dbo.DPEDIDO.nCantidad', ' [Local], TipoProducto, SUM(Cantidad) DESC ', 'Delivery', 'Para Llevar', '', '', 'Sep  1 2010 12:00AM', 'Oct 25 2010 11:59PM'
CREATE PROCEDURE spRep_PaloteoVentaIntegrado
@flagPropiedades as bit,
@flagProduccion as bit,
@flagVenta as bit,
@flagCortesia as bit,
@flagCuentaCte as bit,
@flagPedidosFacturados as bit,
@flagCombinacion as bit, 
@flagCargo as bit,
@flagOpcion as bit, -- 1=detallado 0=resumido
@flagVVenta as bit,
@flagVNeto as bit,
@flagVCosto as bit,
@tTipoProducto as nvarchar(30),
@tTipoPedido as nvarchar(30),
@tGrupo as nvarchar(30),
@tSubGrupo as nvarchar(30),
@sPrecio as nvarchar(250),
@sNeto as nvarchar(250),
@sCosto as nvarchar(250),
@sOrden as nvarchar(200),
@sBoton2 as nvarchar(30),
@sBoton3 as nvarchar(30),
@sBoton4 as nvarchar(30),
@sBoton5 as nvarchar(30),
@finicio as smalldatetime,
@ffinal as smalldatetime

AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @sqlP nvarchar(4000)
declare @Actualizaciones nvarchar(1000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(3000)
declare @sCriteriox nvarchar(3000)
declare @xCriterio nvarchar(3000)
declare @sCostoPropiedad nvarchar(2000)
declare @sCombo nvarchar(2000)
declare @sCostoComboPropiedad nvarchar(2000)
declare @sCostoPropiedad2 nvarchar(2000)
declare @sCombo2 nvarchar(2000)
declare @sCostoComboPropiedad2 nvarchar(2000)

declare @sFiltro nvarchar(1000)

set @sCostoPropiedad2 =''
set @sCombo2 =''
set @sCostoComboPropiedad2=''

set @comilla=''''
	
	CREATE TABLE #DBTRANS (tLocal nVarChar(10) collate Modern_Spanish_CI_AS, Local nVarChar(50) collate Modern_Spanish_CI_AS, Salon nVarChar(50) collate Modern_Spanish_CI_AS, tMesa nVarChar(10) collate Modern_Spanish_CI_AS, TipoProducto nVarChar(50) collate Modern_Spanish_CI_AS, Grupo nVarChar(100) collate Modern_Spanish_CI_AS, SubGrupo nVarChar(100) collate Modern_Spanish_CI_AS, Producto nVarChar(3500) collate Modern_Spanish_CI_AS, Cantidad Float, Venta Float,neto float,costo float, Pedido nVarchar(15) collate Modern_Spanish_CI_AS, Documento nVarChar(25) collate Modern_Spanish_CI_AS, Fecha DateTime, tTipoPedido nVarchar(10) collate Modern_Spanish_CI_AS, tCodigoProducto nVarchar(10) collate Modern_Spanish_CI_AS, tItem nVarchar(5) collate Modern_Spanish_CI_AS)


	set @scriterio=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @scriteriox=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @xCriterio=' MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + '  and MDOCUMENTO.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla


	if @ttipoProducto<>''
		SET @sCriterio=@sCriterio + ' and TipoProducto like  ' + @comilla+@tTipoProducto+'%'+@comilla
	if @ttipoPedido<>''
		SET @sCriterio=@sCriterio + ' and MPEDIDO.tTipoPedido like  ' + @comilla+@tTipoPedido+'%'+@comilla
		SET @sCriteriox=@sCriteriox + ' and MPEDIDO.tTipoPedido like  ' + @comilla+@tTipoPedido+'%'+@comilla
	if @tgrupo <> ''
		SET @sCriterio=@sCriterio + ' and Grupo like ' + @comilla+@tGrupo+'%'+@comilla
	if @tsubgrupo <> ''
		SET @sCriterio=@sCriterio + ' and subGrupo like ' + @comilla+@tSubGrupo+'%'+@comilla
	-- print @scriterio
	--print @sfiltro
	

if @flagProduccion=1 --produccion
begin
	if @flagPropiedades=0
		begin	
			SET  @sql= ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem ) ' +
					   ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @sCosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
					   ' FROM  dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ' +
					   ' where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+ 'N'+@comilla+' and '+  @sCriterio
		end 
    else
		begin
			set @sql=' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem ) '+
			 			 ' SELECT   distinct  dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,'+  @sPrecio +' as Venta,' + @sNeto + ' AS Neto,' + @sCosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido , dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
				 		 ' FROM         dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND  dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON  dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa  '+
						 ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' AND (dbo.vpaloteoproduccionpropiedades.tCodigoPropiedad IS NULL )  and '+ @sCriterio 
		end 

	
 	--Actualiza Costos de loas propiedades
	 set @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
                       		 ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       		 ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                     		 ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') AND ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '


      --Actualiza Costos de los Combos

        set @sCombo = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
          		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
               		' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
	                ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ' +
         	        ' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
      --Actualiza Costos de los Combos de las Propiedades

	set @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
                            ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' + 
                            ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                            ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @scriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ' +
                            ' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

--Actualiza Costos de loas propiedades
	 set @sCostoPropiedad2 = ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN ' +
                       		 ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       		 ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                     		 ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') AND ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '


      --Actualiza Costos de los Combos

        set @sCombo2 = ' Update #DBTRANS set costo=t1.costo+t2.costo  FROM #DBTRANS as T1 INNER JOIN ' +
          		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
               		' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
	                ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ' +
         	        ' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
      --Actualiza Costos de los Combos de las Propiedades

	set @sCostoComboPropiedad2 = ' Update #DBTRANS set costo=t1.costo+t2.costo  FROM #DBTRANS as T1 INNER JOIN ' +
                            ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' + 
                            ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                            ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @scriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ' +
                            ' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
END 
	
if @flagVenta=1 --venta
begin
		if @flagPropiedades=0
			begin

				 set @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
							' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
							' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento  ' +
							' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sCriterio + ' and ' + @xCriterio
			end
		else
			begin
				set	@sql =  ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido,  tCodigoProducto, tItem )  ' +
               				' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' +@sPrecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido,   dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                			' FROM  dbo.vProducto RIGHT OUTER JOIN dbo.vPaloteoProduccionPropiedades RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vPaloteoProduccionPropiedades.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.vPaloteoProduccionPropiedades.tItem = dbo.DPEDIDO.tItem ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
                			' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado ='+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio + ' and ' + @xCriterio  
			end
	--  Actualiza Costos de las Propiedades
	set  @sCostoPropiedad =   'Update #DBTRANS set  Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' + 
                      		  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       		  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
	                          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox  + 
				  ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	--  Actualiza Costos de los Combos
	set @sCombo =   ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
               		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
	                ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
          	        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + ' and ' + @xCriterio +  
	                ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2  ON  T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	--Actualiza Costos de los Combos de las Propiedades
	set @sCostoComboPropiedad = 	' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                            		' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                          	        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+' ) and '+ @sCriteriox  +
                           		' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2  ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem ' 
	
	--  Actualiza Costos de las Propiedades
	set  @sCostoPropiedad2 =   'Update #DBTRANS set  costo=t1.costo+t2.costo  FROM #DBTRANS as T1 INNER JOIN ' + 
                      		  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       		  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
	                          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox  + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	--  Actualiza Costos de los Combos
	set @sCombo2 =   ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN ' +
               		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
	                ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
          	        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + ' and ' + @xCriterio +  
	                ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2  ON  T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
	
	--Actualiza Costos de los Combos de las Propiedades
	set @sCostoComboPropiedad2 = 	' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                            		' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                          	        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+' ) and '+ @sCriteriox  +
                           		' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2  ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem ' 

end

if @flagCortesia=1 --cortesia
begin
		if @flagPropiedades=0 
			begin
				SET @sql =	 ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
							 ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, '+ @sPrecio+' AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
							 ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento  ' +
							 ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' and ' +@sCriterio
			end
		else
			begin

				set @sql =   ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto, costo, Pedido, Documento, Fecha, tTipoPedido,  tCodigoProducto, tItem ) ' +
           					 ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, '+  @sPrecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido,   dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
           					 ' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ON  dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ' + 
							 ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @scriterio
			end



     --Actualiza Costos de las Propiedades
		set  @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' + 
			' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                        ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and ' + @sCriteriox  + 
                        ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '



 	     --Actualiza Costos de los Combos
		set  @sCombo = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN  dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and '+ @scriteriox + 
	       ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '


	     --Actualiza Costos de los Combos de las Propiedades
		set  @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+ ' and ' +  @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
     --Actualiza Costos de las Propiedades
		set  @sCostoPropiedad2 = ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                        ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and ' + @sCriteriox  + 
                        ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

 	     --Actualiza Costos de los Combos
		set  @sCombo2 = ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN  dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and '+ @scriteriox + 
	       ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	     --Actualiza Costos de los Combos de las Propiedades
		set  @sCostoComboPropiedad2 = ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+ ' and ' +  @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

end 
if @flagCuentaCte=1 --cuenta corriente
begin
		if @flagPropiedades=0 
			begin
				set @sql =  ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
							' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
							' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.TMESA  ' + 
							' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+''+@comilla+')<>'+@comilla+''+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriterio + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and '+ @xCriterio + ')'
			end
		else
			begin
				set @sql =  ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido,  tCodigoProducto, tItem ) ' +
               			    ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido,  dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' + 
                		    ' FROM   dbo.vPaloteoProduccionPropiedades RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vPaloteoProduccionPropiedades.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.vPaloteoProduccionPropiedades.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN  dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
                		    ' where  isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and '+ @scriterio + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ')'
			end
      
     --Actualiza Costos de las Propiedades
		set  @sCostoPropiedad =    ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
             			           ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
		                           ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ') ' + 
                        		   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
             
      --Actualiza Costos de los Combos
		set  @sCombo = 		   ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               				   ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               				   ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
               				   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

      --Actualiza Costos de los Combos de las Propiedades
		set  @sCostoComboPropiedad =    ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             			' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             			' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
                             			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

     --Actualiza Costos de las Propiedades
		set  @sCostoPropiedad2 =    ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
             			           ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
		                           ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ') ' + 
                        		   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
             
      --Actualiza Costos de los Combos
		set  @sCombo2 = 		   ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               				   ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               				   ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
               				   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

      --Actualiza Costos de los Combos de las Propiedades
		set  @sCostoComboPropiedad2 =    ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             			' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             			' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
                             			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
END

if @flagCombinacion=1 --combinacion
begin
		if @flagPropiedades=0
			begin
				set @sql =  ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem ) ' + 
						    ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad,  ' + @sPrecio +' AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.CPEDIDO.tCodigoPedido AS Pedido, dbo.DPEDIDO.tDocumento AS Documento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
							' FROM dbo.TMESA RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.TMESA  ' +
							' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and ' + @sCriterio
			end
		else
			begin
				set @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem  ) ' +
						   ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, ' + @sPrecio + '  AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.CPEDIDO.tCodigoPedido AS Pedido, dbo.DPEDIDO.tDocumento AS Documento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
        				   ' FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.vPaloteoProduccionPropiedadesCombos RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.vPaloteoProduccionPropiedadesCombos.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND  dbo.vPaloteoProduccionPropiedadesCombos.tItem = dbo.CPEDIDO.tItem AND dbo.vPaloteoProduccionPropiedadesCombos.tItemCombo = dbo.CPEDIDO.tItemCombo ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
                		   ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+'  AND  dbo.vProducto.Descripcion  IS NOT NULL AND (dbo.vPaloteoProduccionPropiedadesCombos.tCodigoPropiedad IS NULL) and ' + @sCriterio
			end

   

	--Actualiza Costos de las Propiedades
	      SET @sCostoPropiedad = 'SELECT 1'

      	--Actualiza Costos de los Combos
	      SET @sCombo = 'SELECT 1'
      
	--Actualiza Costos de los Combos de las Propiedades
    	      set @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             	 	  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja  ' +
                             	 	  ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem   '                     

	--Actualiza Costos de las Propiedades
	      SET @sCostoPropiedad2 = 'SELECT 1'

      	--Actualiza Costos de los Combos
	      SET @sCombo2 = 'SELECT 1'
      
	--Actualiza Costos de los Combos de las Propiedades
    	      set @sCostoComboPropiedad2 = ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             	 	  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja  ' +
                             	 	  ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem   '                     
end

if @flagCargo=1 --cargo
begin
		if @flagPropiedades=0
			begin
				set  @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
							' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, '+ @Sprecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' + 
							' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.TMESA ' +
							' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriterio
			end
		else
			begin
				set @sql =  ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido,  tCodigoProducto, tItem ) ' +
                      		' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + '  AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo,  dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                     		' FROM         dbo.vPaloteoProduccionPropiedades RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vPaloteoProduccionPropiedades.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.vPaloteoProduccionPropiedades.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
			         		' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem= '+@comilla+'N'+@comilla+' AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio
			end		

            
       --Actualiza Costos de los Combos
	      SET @sCostoPropiedad = 'SELECT 1'

	      SET @sCostoComboPropiedad = 'SELECT 1'
	--Actualiza Costos  de los Combos
	      set @sCombo = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
              ' FROM dbo.CPEDIDO INNER JOIN  dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
              ' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +
              ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'	
       --Actualiza Costos de los Combos
	      SET @sCostoPropiedad2 = 'SELECT 1'

	      SET @sCostoComboPropiedad2 = 'SELECT 1'
	--Actualiza Costos  de los Combos
	      set @sCombo2 = ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
              ' FROM dbo.CPEDIDO INNER JOIN  dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
              ' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +
              ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'	

end	
	

if @flagPedidosFacturados=1 --pedidos facturados
begin	
		if @flagPropiedades=0
			begin
			set   @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' + 
						 ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' +@sPrecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
						 ' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento  ' +
						 ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio
			end
		else
			begin
			 set @sql=   ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido,  tCodigoProducto, tItem ) ' + 
                	 	 ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  '+ @sPrecio +'  AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido,   dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' + 
                		 ' FROM         dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON  dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN  dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                		 ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+')  AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio  

			end		

  --Actualiza Costos de las Propiedades
  		SET    @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
                            ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                            ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                            ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox +
                            ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

  		--Actualiza Costos de los Combos xx
 		SET     @sCombo = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
            			  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
             			  ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
               			  ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + 
               			  ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON   T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
      
      		--Actualiza Costos de los Combos de las Propiedades
 		SET     @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             			' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             			' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' +  @sCriteriox +
                             			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
  --Actualiza Costos de las Propiedades
  		SET    @sCostoPropiedad2 = ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN ' +
                            ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                            ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                            ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox +
                            ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

  		--Actualiza Costos de los Combos xx
 		SET     @sCombo2 = ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN ' +
            			  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
             			  ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
               			  ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + 
               			  ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON   T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
      
      		--Actualiza Costos de los Combos de las Propiedades
 		SET     @sCostoComboPropiedad2 = ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             			' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             			' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' +  @sCriteriox +
                             			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
end

EXEC sp_executesql @sql
--PRINT @SQL

update #DBTRANS set tLocal =  vSalon.tLocal FROM #DBTRANS INNER JOIN dbo.TMESA ON dbo.#DBTRANS.tMesa = dbo.TMESA.tCodigoMesa INNER JOIN dbo.vSalon ON dbo.TMESA.tSalon = dbo.vSalon.Codigo 

	if @sCombo2!= 'SELECT 1'
		BEGIN
 			EXEC sp_executesql @sCombo2
		END 
	IF @sCostoComboPropiedad2!='SELECT 1'	
		BEGIN		
			EXEC sp_executesql @sCostoComboPropiedad2
		END
	IF @sCostoPropiedad2!='SELECT 1'	
		BEGIN		
			EXEC sp_executesql @sCostoPropiedad2
		END

		--EXEC sp_executesql @sCostoPropiedad2
if @flagVCosto=1
begin
	if @flagPropiedades=0
		begin
			IF @sCostoPropiedad!='SELECT 1'	
				BEGIN		
					EXEC sp_executesql @sCostoPropiedad
				END
		end

	if @sCombo!= 'SELECT 1'
		BEGIN
			EXEC sp_executesql @sCombo
		END 
	IF @sCostoComboPropiedad!='SELECT 1'	
		BEGIN		
			EXEC sp_executesql @sCostoComboPropiedad

		END
			--EXEC sp_executesql @sCombo
			--EXEC sp_executesql @sCostoComboPropiedad
end

--

if @flagPropiedades=1
	begin
					declare	@tlocal nVarchar(5)
					declare	@salon nVarchar(50)
					declare @tmesa nvarchar(10)
					declare @tipoProducto nVarchar(100)	
					declare @grupo nVarchar(100)	
					declare @subgrupo nVarchar(100)
					declare @Producto nVarchar(3500)
					declare @Propiedad nVarchar(3500)	
					declare @nCantidad	float
					declare @venta	float
					declare @neto	float
					declare @costo	float
					declare @tcodigoPediDo nVarchar(20)	
					declare @tcodigoPediDoV nVarchar(20)	
					declare @tdocumento nVarchar(20)	
					declare @fFecha	smalldatetime
					declare @tRTipoPedido nvarchar(4)
					declare @area	nvarchar(100)  
					declare @codigo nvarchar(20)   
					declare @codigoV nvarchar(20)   
					declare @tItem nVarchar(3)	
					declare @tItemV nVarchar(3)	
					declare @CostoProp float
					declare @costoPed float
					DECLARE @cantidadRegistro	bigint
					DECLARE @va	bigint
					set @va=0
					CREATE TABLE #DBTRANS0 (
						tlocal nVarchar(5)	collate Modern_Spanish_CI_AS,
						salon nVarchar(50) 	collate Modern_Spanish_CI_AS,
						tmesa nvarchar(10) 	collate Modern_Spanish_CI_AS,
						tipoProducto nVarchar(100)	collate Modern_Spanish_CI_AS,
						grupo nVarchar(100)	collate Modern_Spanish_CI_AS,
						subgrupo nVarchar(100)	collate Modern_Spanish_CI_AS,
						Producto nVarchar(3500)	collate Modern_Spanish_CI_AS,
						Propiedad nVarchar(3500)	collate Modern_Spanish_CI_AS,
						nCantidad	float,
						venta	float,
						neto	float,
						costo	float,
						tcodigoPediDo nVarchar(20)	collate Modern_Spanish_CI_AS,
						tdocumento nVarchar(20)	collate Modern_Spanish_CI_AS,
						fFecha	smalldatetime,
						tTipoPedido nvarchar(4) collate Modern_Spanish_CI_AS,
						codigo nvarchar(20)   collate Modern_Spanish_CI_AS,
						tItem nVarchar(3)	collate Modern_Spanish_CI_AS,
						CostoProp float,
						costoPed float)

					CREATE TABLE #DBTRANS2 (
						tlocal nVarchar(5)	collate Modern_Spanish_CI_AS,
						salon nVarchar(50) 	collate Modern_Spanish_CI_AS,
						tmesa nvarchar(10) 	collate Modern_Spanish_CI_AS,
						tipoProducto nVarchar(100)	collate Modern_Spanish_CI_AS,
						grupo nVarchar(100)	collate Modern_Spanish_CI_AS,
						subgrupo nVarchar(100)	collate Modern_Spanish_CI_AS,
						Producto nVarchar(3500)	collate Modern_Spanish_CI_AS,
 						nCantidad	float,
						venta	float,
						neto	float,
						costo	float,
						tcodigoPediDo nVarchar(20)	collate Modern_Spanish_CI_AS,
						tdocumento nVarchar(20)	collate Modern_Spanish_CI_AS,
						fFecha	smalldatetime,
						tTipoPedido nvarchar(4) collate Modern_Spanish_CI_AS,
						codigo nvarchar(20)   collate Modern_Spanish_CI_AS,
						tItem nVarchar(3)	collate Modern_Spanish_CI_AS,
						CostoProp float,
						costoPed float)

		if @flagProduccion=1 
			begin
					SET @sqlP=  ' insert into #dbtrans0 ' + 
								' SELECT   distinct  dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido,   dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
								' (ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0))* dbo.DPEDIDO.nCantidad  AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' +
								' FROM         dbo.DPEDIDO LEFT OUTER JOIN  dbo.vPropiedad RIGHT OUTER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.vPropiedad.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad ON  dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND  dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN  dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN  dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON  dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ' +
								' WHERE     (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1))  and '+ @sCriterio +  
								' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+',' + @sNeto + ',' + @scosto + ', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
								' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
				 --print @sqlp

					EXECUTE  sp_executesql @sqlP

					select @cantidadRegistro= COUNT(*) from #dbtrans0

					while @va<@cantidadRegistro
						begin
							select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
										 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
										 @venta=venta,@neto=neto,@costo=costo,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
										 @tRtipopedido=ttipopedido,@codigo=codigo,@titem=titem,@costoprop=costoprop,
										 @costoped=costoped
    						from #DBTRANS0 order by producto,tCodigoPedido,tItem
							if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
								begin
									set @codigoV=@codigo
									set @tcodigoPediDoV=@tcodigoPediDo
									set @tItemV=@tItem
									update #dbtrans2
									set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
									where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
								end
							else
								begin
									set @codigoV=@codigo
									set @tcodigoPediDoV=@tcodigoPediDo
									set @tItemV=@tItem
					 
									insert into #dbtrans2 
									select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
										 subgrupo,producto+' '+propiedad , ncantidad,venta,neto,costo,tcodigopedido, tdocumento,ffecha,
										 ttipopedido, codigo,titem,costoprop,costoped
									from #DBTRANS0 order by producto,tCodigoPedido,tItem
 								end 
									DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
									titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
									set @Va=@Va+1
						end 
							/*		 
												insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido,   tCodigoProducto, tItem )
												select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,sum(neto) as neto,sum(costo+COSTOPROP) as costo,tcodigopedido,tdocumento,ffecha,ttipopedido,  codigo,titem
												From #DBTRANS2 
												Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,codigo,titem
									 
							*/	
			end
		if @flagVenta=1
			begin
					SET @sqlP=  ' insert into #dbtrans0 ' + 
								' SELECT     dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido,  dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
								' (ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' +
								' FROM         dbo.vPropiedad RIGHT OUTER JOIN dbo.TPRODUCTOPROPIEDAD INNER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND  dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem ON  dbo.vPropiedad.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tSalon = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN  dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
								' WHERE  dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado ='+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1))  and '+ @sCriterio +
								' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,   '+@sprecio+',' + @sNeto + ',' + @scosto + ', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido,   dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
								' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '



					EXECUTE  sp_executesql @sqlP

					select @cantidadRegistro= COUNT(*) from #dbtrans0

					while @va<@cantidadRegistro
						begin
							select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
										 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
										 @venta=venta,@neto=neto,@costo=costo,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
										 @tRtipopedido=ttipopedido,@codigo=codigo,@titem=titem,@costoprop=costoprop,
										 @costoped=costoped
    						from #DBTRANS0 order by producto,tCodigoPedido,tItem
							if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
								begin
									set @codigoV=@codigo
									set @tcodigoPediDoV=@tcodigoPediDo
									set @tItemV=@tItem
									update #dbtrans2
									set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
									where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
								end
							else
								begin
									set @codigoV=@codigo
									set @tcodigoPediDoV=@tcodigoPediDo
									set @tItemV=@tItem
					 
									insert into #dbtrans2 
									select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
										 subgrupo,producto+' '+propiedad , ncantidad,venta,neto,costo,tcodigopedido, tdocumento,ffecha,
										 ttipopedido, codigo,titem,costoprop,costoped
									from #DBTRANS0 order by producto,tCodigoPedido,tItem
 								end 
									DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
									titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
									set @Va=@Va+1
						end 
/*
												insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido,   tCodigoProducto, tItem )
												select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,sum(neto) as neto,sum(costo+COSTOPROP) as costo,tcodigopedido,tdocumento,ffecha,ttipopedido,  codigo,titem
												From #DBTRANS2 
												Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,codigo,titem											
*/
			end 
		if @flagCortesia=1
			begin
					SET @sqlP=  ' insert into #dbtrans0 ' + 
									' SELECT     dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido,  dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
									' (ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' +
									' FROM         dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem AND  dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido LEFT OUTER JOIN dbo.vPropiedad ON dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad = dbo.vPropiedad.Codigo RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa  ' +
									' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1))  and '+ @sCriterio   +
									' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+',' + @sNeto + ',' + @scosto + ', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido,  dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
									' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
					 
					EXECUTE  sp_executesql @sqlP

					select @cantidadRegistro= COUNT(*) from #dbtrans0

					while @va<@cantidadRegistro
						begin
							select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
										 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
										 @venta=venta,@neto=neto,@costo=costo,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
										 @tRtipopedido=ttipopedido,@codigo=codigo,@titem=titem,@costoprop=costoprop,
										 @costoped=costoped
    						from #DBTRANS0 order by producto,tCodigoPedido,tItem
							if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
								begin
									set @codigoV=@codigo
									set @tcodigoPediDoV=@tcodigoPediDo
									set @tItemV=@tItem
									update #dbtrans2
									set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
									where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
								end
							else
								begin
									set @codigoV=@codigo
									set @tcodigoPediDoV=@tcodigoPediDo
									set @tItemV=@tItem
					 
									insert into #dbtrans2 
									select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
										 subgrupo,producto+' '+propiedad , ncantidad,venta,neto,costo,tcodigopedido, tdocumento,ffecha,
										 ttipopedido, codigo,titem,costoprop,costoped
									from #DBTRANS0 order by producto,tCodigoPedido,tItem
 								end 
									DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
									titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
									set @Va=@Va+1
						end 
/*
												insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
												select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
												From #DBTRANS2 
												Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
*/

			end
		if @flagCuentaCte=1
			begin
						SET @sqlP=  ' insert into #dbtrans0 ' + 
									' SELECT     dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido,   dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
									' (ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' + 
									' FROM         dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.TPRODUCTOPROPIEDAD LEFT OUTER JOIN dbo.vPropiedad ON dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad = dbo.vPropiedad.Codigo ON  dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem ON  dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto RIGHT OUTER JOIN Dbo.MPEDIDO LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido   ' +
									' where         isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1)) and '+ @scriterio + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ')' +
									' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+',' + @sNeto + ',' + @scosto + ', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido,  dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
									' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
					 
					EXECUTE  sp_executesql @sqlP

					select @cantidadRegistro= COUNT(*) from #dbtrans0

					while @va<@cantidadRegistro
						begin
							select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
										 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
										 @venta=venta,@neto=neto,@costo=costo,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
										 @tRtipopedido=ttipopedido,@codigo=codigo,@titem=titem,@costoprop=costoprop,
										 @costoped=costoped
    						from #DBTRANS0 order by producto,tCodigoPedido,tItem
							if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
								begin
									set @codigoV=@codigo
									set @tcodigoPediDoV=@tcodigoPediDo
									set @tItemV=@tItem
									update #dbtrans2
									set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
									where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
								end
							else
								begin
									set @codigoV=@codigo
									set @tcodigoPediDoV=@tcodigoPediDo
									set @tItemV=@tItem
					 
									insert into #dbtrans2 
									select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
										 subgrupo,producto+' '+propiedad , ncantidad,venta,neto,costo,tcodigopedido, tdocumento,ffecha,
										 ttipopedido, codigo,titem,costoprop,costoped
									from #DBTRANS0 order by producto,tCodigoPedido,tItem
 								end 
									DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
									titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
									set @Va=@Va+1
						end 
/*
												insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
												select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
												From #DBTRANS2 
												Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
*/
			end
		IF @flagCombinacion=1
			begin
					 
						set @sqlP= ' Insert into #DBTRANS0 ' +
  								   ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto,ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.CPEDIDO.nCantidad,'+@sprecio+' AS VENTA,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.CPEDIDO.tCodigoPedido AS Pedido, dbo.DPEDIDO.tDocumento AS Documento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido,   dbo.vProducto.Codigo,  dbo.CPEDIDO.tItemCombo, ' +
								   ' (ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.cPEDIDO.nCantidad AS CostoProp, ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0)  + ISNULL(dbo.CPEDIDO.nManoObra, 0) AS costoPed ' + 
        						   ' FROM         dbo.DPEDIDO RIGHT OUTER JOIN dbo.vPropiedad RIGHT OUTER JOIN dbo.TCOMBOPROPIEDAD LEFT OUTER JOIN dbo.CPEDIDO ON dbo.TCOMBOPROPIEDAD.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND  dbo.TCOMBOPROPIEDAD.tItem = dbo.CPEDIDO.tItem AND dbo.TCOMBOPROPIEDAD.tItemCombo = dbo.CPEDIDO.tItemCombo ON  dbo.vPropiedad.Codigo = dbo.TCOMBOPROPIEDAD.tCodigoPropiedad ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND Dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN  dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
								   ' WHERE MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1))   and ' + @sCriterio +	
								   ' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.CPEDIDO.nCantidad,  '+@sprecio+',' + @sNeto + ',' + @scosto + ', dbo.CPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido,  dbo.vProducto.Codigo, dbo.CPEDIDO.tITEMCOMBO, ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0), dbo.CPEDIDO.nInsumo,  dbo.CPEDIDO.nGasto, dbo.CPEDIDO.nManoObra ' + 
								   ' ORDER BY dbo.vProducto.Descripcion,dbo.CPEDIDO.tCodigoPedido, dbo.CPEDIDO.tItemCOMBO '
--                				  print @sqlp
					EXECUTE  sp_executesql @sqlP

					select @cantidadRegistro= COUNT(*) from #dbtrans0

					while @va<@cantidadRegistro
						begin
							select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
										 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
										 @venta=venta,@neto=neto,@costo=costo,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
										 @tRtipopedido=ttipopedido,@codigo=codigo,@titem=titem,@costoprop=costoprop,
										 @costoped=costoped
    						from #DBTRANS0 order by producto,tCodigoPedido,tItem
							if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
								begin
									set @codigoV=@codigo
									set @tcodigoPediDoV=@tcodigoPediDo
									set @tItemV=@tItem
									update #dbtrans2
									set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
									where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
								end
							else
								begin
									set @codigoV=@codigo
									set @tcodigoPediDoV=@tcodigoPediDo
									set @tItemV=@tItem
					 
									insert into #dbtrans2 
									select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
										 subgrupo,producto+' '+propiedad , ncantidad,venta,neto,costo,tcodigopedido, tdocumento,ffecha,
										 ttipopedido, codigo,titem,costoprop,costoped
									from #DBTRANS0 order by producto,tCodigoPedido,tItem
 								end 
									DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
									titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
									set @Va=@Va+1
						end 

								/*				insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
												select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
												From #DBTRANS2 
												Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
*/
			end 
		if @flagCargo=1
			begin
						SET @sqlP=  ' insert into #dbtrans0 ' + 
									' SELECT     dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido,  dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
									' (ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' + 
									' FROM     dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN  dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.vPropiedad RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem ON dbo.vPropiedad.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad ON  dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido   ' +
									' where    MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem= '+@comilla+'N'+@comilla+'  AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1)) and '+ @scriterio +
								    ' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+',' + @sNeto + ',' + @scosto + ', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido,   dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
									' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
					 
					EXECUTE  sp_executesql @sqlP

					select @cantidadRegistro= COUNT(*) from #dbtrans0

					while @va<@cantidadRegistro
						begin
							select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
										 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
										 @venta=venta,@neto=neto,@costo=costo,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
										 @tRtipopedido=ttipopedido,@codigo=codigo,@titem=titem,@costoprop=costoprop,
										 @costoped=costoped
    						from #DBTRANS0 order by producto,tCodigoPedido,tItem
							if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
								begin
									set @codigoV=@codigo
									set @tcodigoPediDoV=@tcodigoPediDo
									set @tItemV=@tItem
									update #dbtrans2
									set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
									where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
								end
							else
								begin
									set @codigoV=@codigo
									set @tcodigoPediDoV=@tcodigoPediDo
									set @tItemV=@tItem
					 
									insert into #dbtrans2 
									select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
										 subgrupo,producto+' '+propiedad , ncantidad,venta,neto,costo,tcodigopedido, tdocumento,ffecha,
										 ttipopedido, codigo,titem,costoprop,costoped
									from #DBTRANS0 order by producto,tCodigoPedido,tItem
 								end 
									DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
									titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
									set @Va=@Va+1
						end 
/*
												insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
												select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
												From #DBTRANS2 
												Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
*/
			end
		if @flagPedidosFacturados=1 --pedidos facturados 
			begin
					SET @sqlP=  ' insert into #dbtrans0 ' + 
								' SELECT     dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, Dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+')  AS propiedad, dbo.DPEDIDO.nCantidad AS Cantidad, '+@sprecio+' AS VENTA,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido,   dbo.vProducto.Codigo, dbo.DPEDIDO.tItem,  ' +
								' (ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad AS CostoProp, ISNULL(dbo.DPEDIDO.nInsumo, 0) + ISNULL(dbo.DPEDIDO.nGasto, 0)  + ISNULL(dbo.DPEDIDO.nManoObra, 0) AS costoPed ' +
								' FROM         dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.vPropiedad RIGHT OUTER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.vPropiedad.Codigo = dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad LEFT OUTER JOIN dbo.DPEDIDO ON dbo.TPRODUCTOPROPIEDAD.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND  dbo.TPRODUCTOPROPIEDAD.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
								' WHERE  dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado ='+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') AND ((vpropiedad.lstockmenos=1) or (vpropiedad.lstockmas=1))  and '+ @sCriterio  +
								' GROUP BY dbo.vSalon.tLocal, dbo.vSalon.Descripcion, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo,  dbo.vProducto.Descripcion, ISNULL(dbo.vPropiedad.Operador + '+@comilla+' '+@comilla+' + dbo.vPropiedad.tResumido, N'+@comilla+'*'+@comilla+'), dbo.DPEDIDO.nCantidad,  '+@sprecio+',' + @sNeto + ',' + @scosto + ', dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha,  dbo.MPEDIDO.tTipoPedido,   dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0)  + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0), dbo.DPEDIDO.nInsumo,  dbo.DPEDIDO.nGasto, dbo.DPEDIDO.nManoObra ' + 
								' ORDER BY dbo.vProducto.Descripcion,dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem '
							 --	print @sqlp
					EXECUTE  sp_executesql @sqlP

					select @cantidadRegistro= COUNT(*) from #dbtrans0
					--print @cantidadregistro
					while @va<@cantidadRegistro
						begin
							select top 1 @tlocal=tlocal, @salon=salon,@tmesa=tmesa,@tipoproducto=tipoproducto,@grupo=grupo,
										 @subgrupo=subgrupo,@producto=producto,@propiedad=propiedad,@ncantidad=ncantidad,
										 @venta=venta,@neto=neto,@costo=costo,@tcodigopedido=tcodigopedido, @tdocumento=tdocumento,@ffecha=ffecha,
										 @tRtipopedido=ttipopedido,@codigo=codigo,@titem=titem,@costoprop=costoprop,
										 @costoped=costoped
    						from #DBTRANS0 order by producto,tCodigoPedido,tItem
							if @codigoV=@codigo and @tcodigoPediDoV=@tcodigoPediDo and @tItemV=@tItem 
								begin
									set @codigoV=@codigo
									set @tcodigoPediDoV=@tcodigoPediDo
									set @tItemV=@tItem
									update #dbtrans2
									set producto=producto + '/'+@propiedad, costoprop=costoprop+@costoprop				    
									where codigo=@codigo	 and titem=@titem and tcodigopedido=@tcodigopedido
								end
							else
								begin
									set @codigoV=@codigo
									set @tcodigoPediDoV=@tcodigoPediDo
									set @tItemV=@tItem
					 
									insert into #dbtrans2 
									select top 1 tlocal, salon,tmesa,tipoproducto,grupo,
										 subgrupo,producto+' '+propiedad , ncantidad,venta,neto,costo,tcodigopedido, tdocumento,ffecha,
										 ttipopedido, codigo,titem,costoprop,costoped
									from #DBTRANS0 order by producto,tCodigoPedido,tItem
 								end 
									DELETE FROM #DBTRANS0 WHERE codigo=@codigo and tcodigopedido=@tcodigopedido and
									titem=@titem and propiedad=@propiedad	AND costoprop=@COSTOprop
									set @Va=@Va+1
						end 
							
/*
												insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )
												select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
												From #DBTRANS2 
												Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,area,codigo,titem
*/												
			end 

						insert into #dbtrans (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido,   tCodigoProducto, tItem )
						select tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,  sum(nCantidad)  , sum(venta) as Venta,sum(neto) as neto,sum(costo+costoprop) as costo,tcodigopedido,tdocumento,ffecha,ttipopedido,  codigo,titem
						From #DBTRANS2 
						Group by tLocal, Salon,tmesa, tipoproducto,grupo, SubGrupo, Producto,tcodigopedido,tdocumento,ffecha,ttipopedido,codigo,titem				 

	end

--


set @Actualizaciones = 'update #DBTRANS set Salon = '+@comilla+'Sin Salon'+@comilla+' where isnull(Salon,'+@comilla+'0'+@comilla+') = '+@comilla+'0'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+@comilla+ @sBoton2 + @comilla+' where tTipoPedido ='+@comilla+'02'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+ @comilla+@sBoton3 +@comilla+ ' where tTipoPedido ='+@comilla+'03'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+@comilla+ @sBoton4 +@comilla+ ' where tTipoPedido ='+@comilla+'04'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+ @comilla+@sBoton5+@comilla + ' where tTipoPedido ='+@comilla+'05'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Local = vLocal.Descripcion FROM #DBTRANS INNER JOIN dbo.vLocal ON dbo.#DBTRANS.tLocal = dbo.vLocal.Codigo '
EXEC sp_executesql @Actualizaciones

/**/

--select  right('00'+ ltrim(str(+day(fecha))),2)  + '/'+ right('00'+ltrim(str(month(fecha))),2)  +'/'+  ltrim(str(year(fecha))) as Dia, sum(venta) as venta from #DBTRANS group by right('00'+ ltrim(str(+day(fecha))),2) +'/'+right('00'+ltrim(str(month(fecha))),2) +'/'+ ltrim(str(year(fecha)))  

select tipoproducto, grupo,subgrupo,producto,sum(cantidad) as cantidad, sum(venta) as venta,sum(neto) as neto,sum(costo) as costo from #dbtrans group by tipoproducto, grupo,subgrupo,producto order by tipoproducto, grupo,subgrupo,producto


/**/
--EXEC sp_executesql @sql



END



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




CREATE PROCEDURE spRep_RankingIntegrado
@flagProduccion as bit,
@flagVenta as bit,
@flagCortesia as bit,
@flagCuentaCte as bit,
@flagPedidosFacturados as bit,
@flagCombinacion as bit,
@flagCargo as bit,
@flagOpcion as bit, -- 1=detallado 0=resumido
@flagVVenta as bit,
@flagVNeto as bit,
@flagVCosto as bit,
@tTipoProducto as nvarchar(30),
@tTipoPedido as nvarchar(30),
@tGrupo as nvarchar(30),
@tSubGrupo as nvarchar(30),
@sPrecio as nvarchar(300),
@sOrden as nvarchar(200),
@sBoton2 as nvarchar(30),
@sBoton3 as nvarchar(30),
@sBoton4 as nvarchar(30),
@sBoton5 as nvarchar(30),
@sNeto as nvarchar(300),
@sCosto as nvarchar(300),
@finicio as smalldatetime,
@ffinal as smalldatetime

AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @Actualizaciones nvarchar(1000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(3000)
declare @sCriteriox nvarchar(3000)
declare @xCriterio nvarchar(3000)
declare @sCostoPropiedad nvarchar(2000)
declare @sCombo nvarchar(2000)
declare @sCostoComboPropiedad nvarchar(2000)
declare @sCostoPropiedad2 nvarchar(2000)
declare @sCombo2 nvarchar(2000)
declare @sCostoComboPropiedad2 nvarchar(2000)

declare @sFiltro nvarchar(1000)

set @comilla=''''
	
	CREATE TABLE #DBTRANS (tLocal nVarChar(3) collate Modern_Spanish_CI_AS, Local nVarChar(30) collate Modern_Spanish_CI_AS, Salon nVarChar(30) collate Modern_Spanish_CI_AS, tMesa nVarChar(3) collate Modern_Spanish_CI_AS, TipoProducto nVarChar(50) collate Modern_Spanish_CI_AS, Grupo nVarChar(60) collate Modern_Spanish_CI_AS, SubGrupo nVarChar(60) collate Modern_Spanish_CI_AS, Producto nVarChar(150) collate Modern_Spanish_CI_AS, Cantidad Float, Venta Float, Neto float,costo float,Pedido nVarchar(15) collate Modern_Spanish_CI_AS, Documento nVarChar(20) collate Modern_Spanish_CI_AS, Fecha DateTime, tTipoPedido nVarchar(2) collate Modern_Spanish_CI_AS, tCodigoProducto nVarchar(7) collate Modern_Spanish_CI_AS, tItem nVarchar(3) collate Modern_Spanish_CI_AS)


	set @scriterio=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @xCriterio=' MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + '  and MDOCUMENTO.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
		set @scriteriox=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	if @ttipoProducto<>''
		SET @sCriterio=@sCriterio + ' and TipoProducto like  ' + @comilla+@tTipoProducto+'%'+@comilla
	if @ttipoPedido<>''
		SET @sCriterio=@sCriterio + ' and MPEDIDO.tTipoPedido like  ' + @comilla+@tTipoPedido+'%'+@comilla
		SET @sCriteriox=@sCriteriox + ' and MPEDIDO.tTipoPedido like  ' + @comilla+@tTipoPedido+'%'+@comilla
	if @tgrupo <> ''
		SET @sCriterio=@sCriterio + ' and Grupo like ' + @comilla+@tGrupo+'%'+@comilla
	if @tsubgrupo <> ''
		SET @sCriterio=@sCriterio + ' and subGrupo like ' + @comilla+@tSubGrupo+'%'+@comilla
	-- print @scriterio
	--print @sfiltro


if @flagProduccion=1 --produccion
begin
	SET  @sql= ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,Neto,Costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem ) ' +
        	   ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @sCosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
	           ' FROM  dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ' +
	           ' where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+ 'N'+@comilla+' and '+  @sCriterio

	  --Actualiza Costos de las Propiedades
	  set @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
                       		 ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       		 ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                     		 ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') AND ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	  --Actualiza Costos de los Combos
	  set @sCombo = ' Update #DBTRANS set Venta = Venta + T2.Costo   FROM #DBTRANS as T1 INNER JOIN ' +
          		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
               		' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
	                ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ' +
         	        ' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

	 --Actualiza Costos de los Combos de las Propiedades
	  set @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo   FROM #DBTRANS as T1 INNER JOIN ' +
                            ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' + 
                            ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                            ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @scriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ' +
                            ' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

	  --Actualiza Costos de las Propiedades
	  set @sCostoPropiedad2 = ' Update #DBTRANS set   costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN ' +
                       		 ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       		 ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                     		 ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') AND ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	  --Actualiza Costos de los Combos
	  set @sCombo2 = ' Update #DBTRANS set   costo=t1.costo+t2.costo  FROM #DBTRANS as T1 INNER JOIN ' +
          		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
               		' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
	                ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ' +
         	        ' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

	 --Actualiza Costos de los Combos de las Propiedades
	  set @sCostoComboPropiedad2 = ' Update #DBTRANS set  costo=t1.costo+t2.costo  FROM #DBTRANS as T1 INNER JOIN ' +
                            ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' + 
                            ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                            ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @scriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ' +
                            ' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'


END 
	
if @flagVenta=1 --venta
begin
  set @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,Neto,Costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
             ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @sCosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
             ' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento  ' +
             ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sCriterio + ' and ' + @xCriterio
             
	--  Actualiza Costos de las Propiedades
	set  @sCostoPropiedad =   'Update #DBTRANS set Venta = Venta + T2.Costo   FROM #DBTRANS as T1 INNER JOIN ' + 
                      		  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       		  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
	                          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox  + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	--  Actualiza Costos de los Combos
	set @sCombo =   ' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
               		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
	                ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
          	        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + ' and ' + @xCriterio +
	                ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2  ON  T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
	
	--Actualiza Costos de los Combos de las Propiedades
	set @sCostoComboPropiedad = 	' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                            		' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                          	        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+' ) and '+ @sCriteriox  +
                           		' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2  ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem ' 

	--  Actualiza Costos de las Propiedades
	set  @sCostoPropiedad2 =   'Update #DBTRANS set   costo=t1.costo+t2.costo  FROM #DBTRANS as T1 INNER JOIN ' + 
                      		  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       		  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
	                          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox  + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	--  Actualiza Costos de los Combos
	set @sCombo2 =   ' Update #DBTRANS set  costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN ' +
               		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
	                ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
          	        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + ' and ' + @xCriterio +
	                ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2  ON  T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
	
	--Actualiza Costos de los Combos de las Propiedades
	set @sCostoComboPropiedad2 = 	' Update #DBTRANS set  costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                            		' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                          	        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+' ) and '+ @sCriteriox  +
                           		' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2  ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem ' 

end

if @flagCortesia=1 --cortesia
begin
  SET @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,Neto,Costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
             ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, '+ @sPrecio+' AS Venta,' + @sNeto + ' AS Neto,' + @sCosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
             ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento  ' +
             ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' and ' +@sCriterio
        --Actualiza Costos de las Propiedades
		set  @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                        ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and ' + @sCriteriox  + 
                        ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

 	     --Actualiza Costos de los Combos
		set  @sCombo = ' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN  dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and '+ @scriteriox + 
	       ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	     --Actualiza Costos de los Combos de las Propiedades
		set  @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+ ' and ' +  @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

        --Actualiza Costos de las Propiedades
		set  @sCostoPropiedad2 = ' Update #DBTRANS set  costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                        ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and ' + @sCriteriox  + 
                        ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

 	     --Actualiza Costos de los Combos
		set  @sCombo2 = ' Update #DBTRANS set   costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN  dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and '+ @scriteriox + 
	       ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	     --Actualiza Costos de los Combos de las Propiedades
		set  @sCostoComboPropiedad2 = ' Update #DBTRANS set  costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+ ' and ' +  @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'


end 
if @flagCuentaCte=1 --cuenta corriente
begin
	set @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,Neto,Costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
           ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @sCosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
           ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.TMESA  ' + 
	   ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+''+@comilla+')<>'+@comilla+''+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriterio + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and '+ @xCriterio + ')'

	--Actualiza Costos de las Propiedades
		set  @sCostoPropiedad =    ' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
             			           ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
		                           ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ') ' + 
                        		   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
             
      --Actualiza Costos de los Combos
		set  @sCombo = 		   ' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               				   ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               				   ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
               				   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

      --Actualiza Costos de los Combos de las Propiedades
		set  @sCostoComboPropiedad =    ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             			' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             			' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
                             			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	--Actualiza Costos de las Propiedades
		set  @sCostoPropiedad2 =    ' Update #DBTRANS set  costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
             			           ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
		                           ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ') ' + 
                        		   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
             
      --Actualiza Costos de los Combos
		set  @sCombo2 = 		   ' Update #DBTRANS set   costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               				   ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               				   ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
               				   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

      --Actualiza Costos de los Combos de las Propiedades
		set  @sCostoComboPropiedad2 =    ' Update #DBTRANS set   costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             			' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             			' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
                             			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '


END

if @flagCombinacion=1 --combinacion
begin
	set @sql =  ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,Neto,Costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem ) ' + 
             ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad,  ' + @sPrecio +' AS Venta,' + @sNeto + ' AS Neto,' + @sCosto + ' AS Costo, dbo.CPEDIDO.tCodigoPedido AS Pedido, dbo.DPEDIDO.tDocumento AS Documento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
             ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.TMESA  ' +
             ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and ' + @sCriterio
      
   	--Actualiza Costos de las Propiedades
	      SET @sCostoPropiedad = 'select 1'

      	--Actualiza Costos de los Combos
	      SET @sCombo = 'SELECT 1'
      
	--Actualiza Costos de los Combos de las Propiedades
    	      set @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             	 	  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja  ' +
                             	 	  ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem and T1.tItemCombo = T2.tItemCombo '                     
   	--Actualiza Costos de las Propiedades
	      SET @sCostoPropiedad2 = 'select 1'

      	--Actualiza Costos de los Combos
	      SET @sCombo2 = 'SELECT 1'
      
	--Actualiza Costos de los Combos de las Propiedades
    	      set @sCostoComboPropiedad2 = ' Update #DBTRANS set   costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             	 	  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja  ' +
                             	 	  ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem and T1.tItemCombo = T2.tItemCombo '                     


end

if @flagCargo=1 --cargo
begin
	set  @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,Neto,Costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
            ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, '+ @Sprecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @sCosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' + 
            ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.TMESA ' +
            ' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriterio
            
           SET @sCostoPropiedad = 'select 1'

	      SET @sCostoComboPropiedad = 'SELECT 1'
	--Actualiza Costos  de los Combos
	      set @sCombo = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
              ' FROM dbo.CPEDIDO INNER JOIN  dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
              ' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +
              ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'	

           SET @sCostoPropiedad2 = 'select 1'

	      SET @sCostoComboPropiedad2 = 'SELECT 1'
	--Actualiza Costos  de los Combos
	      set @sCombo2 = ' Update #DBTRANS set   costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
              ' FROM dbo.CPEDIDO INNER JOIN  dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
              ' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +
              ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'	


end	
	
if @flagPedidosFacturados=1 --pedidos facturados
begin
set   @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,Neto,Costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' + 
             ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' +@sPrecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @sCosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
             ' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento  ' +
             ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio
             
  		--Actualiza Costos de las Propiedades
  		SET    @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
                            ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                            ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                            ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox +
                            ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

  		--Actualiza Costos de los Combos xx
 		SET     @sCombo = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
            			  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
             			  ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
               			  ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox+
               			  ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
      
      		--Actualiza Costos de los Combos de las Propiedades
 		SET     @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo   FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             			' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             			' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' +  @sCriteriox +
                             			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

 		--Actualiza Costos de las Propiedades
  		SET    @sCostoPropiedad2 = ' Update #DBTRANS set   costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN ' +
                            ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                            ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                            ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox +
                            ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

  		--Actualiza Costos de los Combos xx
 		SET     @sCombo2 = ' Update #DBTRANS set   costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN ' +
            			  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
             			  ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
               			  ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox+
               			  ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
      
      		--Actualiza Costos de los Combos de las Propiedades
 		SET     @sCostoComboPropiedad2 = ' Update #DBTRANS set   costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             			' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             			' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' +  @sCriteriox +
                             			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

end
--print @sql
EXEC sp_executesql @sql

--if @flagVCosto=1
	--begin
--	EXEC sp_executesql @sCombo
	--end


update #DBTRANS set tLocal =  vSalon.tLocal FROM #DBTRANS INNER JOIN dbo.TMESA ON dbo.#DBTRANS.tMesa = dbo.TMESA.tCodigoMesa INNER JOIN dbo.vSalon ON dbo.TMESA.tSalon = dbo.vSalon.Codigo 
	EXEC sp_executesql @sCostoPropiedad2
	EXEC sp_executesql @sCombo2
	EXEC sp_executesql @sCostoComboPropiedad2
if @flagVCosto=1
	begin
	EXEC sp_executesql @sCostoPropiedad
	EXEC sp_executesql @sCombo
	EXEC sp_executesql @sCostoComboPropiedad
	end

set @Actualizaciones = 'update #DBTRANS set Salon = '+@comilla+'Sin Salon'+@comilla+' where isnull(Salon,'+@comilla+'0'+@comilla+') = '+@comilla+'0'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+@comilla+ @sBoton2 + @comilla+' where tTipoPedido ='+@comilla+'02'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+ @comilla+@sBoton3 +@comilla+ ' where tTipoPedido ='+@comilla+'03'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+@comilla+ @sBoton4 +@comilla+ ' where tTipoPedido ='+@comilla+'04'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+ @comilla+@sBoton5+@comilla + ' where tTipoPedido ='+@comilla+'05'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Local = vLocal.Descripcion FROM #DBTRANS INNER JOIN dbo.vLocal ON dbo.#DBTRANS.tLocal = dbo.vLocal.Codigo '
EXEC sp_executesql @Actualizaciones
/*
set @sql=' select grupo,subgrupo , producto, sum(cantidad) as cantidad,sum(venta) as venta from #dbtrans group by grupo,subgrupo,producto '+
	 ' order by grupo asc, subgrupo asc,  ' + @sorden 
exec sp_executesql @sql
*/

set @sql=' select grupo,subgrupo,tipoProducto , producto, sum(cantidad) as cantidad,sum(venta) as venta, sum(isnull(neto,0)) as neto,sum(isnull(costo,0)) as costo from #dbtrans group by grupo,subgrupo,tipoProducto ,producto '+
	 ' order by grupo asc, subgrupo asc,  ' + @sorden 
exec sp_executesql @sql


END



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




CREATE PROCEDURE [dbo].[spRep_RegVentaIntegrado]
@flagTipo as bit,
@flagRedondeo as bit,
@flagRegVenta as bit,
@tTipoDoc as nvarchar(20),
@tEstadoDoc as nvarchar(20),
@finicio as smalldatetime,
@ffinal as smalldatetime

AS BEGIN

set nocount on


declare @sNC nvarchar(10)
if @flagTipo=0 
	begin
			CREATE TABLE #DBTRANS (fRegistro datetime, tDocumento varchar(20) collate Modern_Spanish_CI_AS, tCodigoCliente nVarchar(7) collate Modern_Spanish_CI_AS, nNeto float, nImpuesto1 float, nImpuesto2 float, nImpuesto3 float, nVenta float, nRecargo float, nDescuento float, tEstadoDocumento varchar(2) collate Modern_Spanish_CI_AS, tTipoDocumento varchar(2) collate Modern_Spanish_CI_AS, tTemporal varchar(20) collate Modern_Spanish_CI_AS,nNetoSuma float, nImpuestoSuma1 float, nImpuestoSuma2 float, nImpuestoSuma3 float, nVentaSuma float, nRecargoSuma float, nDescuentoSuma float)


			/**/
			--inserta documentos
			if @flagRedondeo=1
				begin
				if @flagRegVenta=1
						begin
						--scriterio
								Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento)  
								select fRegistro, substring(tDocumento,1,1)+substring(tDocumento,4,3)+substring(tDocumento,9,7) as tDocumento, tCodigoCliente, ROUND(nNeto, 2) as Nneto, ROUND(nPrecioImpuesto1, 2) as nImpuesto1, ROUND(nPrecioImpuesto2, 2) as nImpuesto2, ROUND(nPrecioImpuesto3, 2) as nImpuesto3, ROUND(nVenta, 2) as nVenta, ROUND(nRecargo, 2) as nRecargo, ROUND(nDescuento, 2) as ndescuento, tEstadoDocumento, tTipoDocumento From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo  
								where RegistroVenta=1 and fRegistro >= @FINICIO and fRegistro <= @FFINAL and tTipoDocumento <>  '00'   
								and  (ttipodocumento like case @ttipodoc when '' then '%' else @ttipodoc+'%' end ) 
								and  (mdocumento.testadodocumento  like case @testadodoc when '' then '%' else @testadodoc+'%' end ) 
								order by tdocumento

					end
					else
						begin
								Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento)  
								select fRegistro, substring(tDocumento,1,1)+substring(tDocumento,4,3)+substring(tDocumento,9,7) as tDocumento, tCodigoCliente, ROUND(nNeto, 2) as Nneto, ROUND(nPrecioImpuesto1, 2) as nImpuesto1, ROUND(nPrecioImpuesto2, 2) as nImpuesto2, ROUND(nPrecioImpuesto3, 2) as nImpuesto3, ROUND(nVenta, 2) as nVenta, ROUND(nRecargo, 2) as nRecargo, ROUND(nDescuento, 2) as ndescuento, tEstadoDocumento, tTipoDocumento From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo  
								where  fRegistro >= @FINICIO and fRegistro <= @FFINAL and tTipoDocumento <>  '00'   
								and  (ttipodocumento like case @ttipodoc when '' then '%' else @ttipodoc+'%' end ) 
								and  (mdocumento.testadodocumento  like case @testadodoc when '' then '%' else @testadodoc+'%' end ) 
								order by tdocumento
						end
			 		
				
				end
			else
				begin
					if @flagRegVenta=1 
							begin
								Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento) 
								select fRegistro, substring(tDocumento,1,1)+substring(tDocumento,4,3)+substring(tDocumento,9,7) as tDocumento, tCodigoCliente, nNeto, nPrecioImpuesto1 as nImpuesto1, nPrecioImpuesto2 as nImpuesto2, nPrecioImpuesto3 as nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo 
								where RegistroVenta=1 and fRegistro >= @FINICIO and fRegistro <= @FFINAL and tTipoDocumento <>  '00' 
								and  (ttipodocumento like case @ttipodoc when '' then '%' else @ttipodoc+'%' end ) 
								and  (mdocumento.testadodocumento  like case @testadodoc when '' then '%' else @testadodoc+'%' end ) 
								order by tdocumento
							end
					else
							begin
								Insert into #DBTRANS (fRegistro, tDocumento, tCodigoCliente, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento) 
								select fRegistro, substring(tDocumento,1,1)+substring(tDocumento,4,3)+substring(tDocumento,9,7) as tDocumento, tCodigoCliente, nNeto, nPrecioImpuesto1 as nImpuesto1, nPrecioImpuesto2 as nImpuesto2, nPrecioImpuesto3 as nImpuesto3, nVenta, nRecargo, nDescuento, tEstadoDocumento, tTipoDocumento From dbo.MDOCUMENTO LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo 
								where  fRegistro >= @FINICIO and fRegistro <= @FFINAL and tTipoDocumento <>  '00' 
								and  (ttipodocumento like case @ttipodoc when '' then '%' else @ttipodoc+'%' end ) 
								and  (mdocumento.testadodocumento  like case @testadodoc when '' then '%' else @testadodoc+'%' end ) 
								order by tdocumento
							end 
				end


			--inserta nota de creditos
			if @flagRedondeo=1
				begin
			--xcriterio
						   Insert into #DBTRANS (fRegistro, tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tEstadoDocumento, tTipoDocumento, tTemporal)  
             					   SELECT dbo.MNOTACREDITO.fFecha AS fRegistro, substring(dbo.MNOTACREDITO.tNotaCredito,1,1)+substring(dbo.MNOTACREDITO.tNotaCredito,4,3)+substring(dbo.MNOTACREDITO.tNotaCredito,9,7) AS tDocumento, ROUND(dbo.MNOTACREDITO.nNeto, 2) as nneto, ROUND(dbo.MNOTACREDITO.nImpuesto1, 2) as nimpuesto1, ROUND(dbo.MNOTACREDITO.nImpuesto2, 2) as nimpuesto2, ROUND(dbo.MNOTACREDITO.nImpuesto3, 2) as nimpuesto3, ROUND(dbo.MNOTACREDITO.nVenta, 2) as nventa,   
            						   dbo.MNOTACREDITO.tEstadoDocumento, dbo.vTipoDocumento.Codigo AS tTipoDocumento, dbo.MNOTACREDITO.tDocumento AS tTemporal  
   							   FROM dbo.MNOTACREDITO LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.MNOTACREDITO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vTipoDocumento ON SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 1, 1) = dbo.vTipoDocumento.Prefijo  
							   where MNOTACREDITO.fFecha >= @fInicio and MNOTACREDITO.fFecha <= @ffinal    
						   and  (codigo like case @ttipodoc when '' then '%' else @ttipodoc+'%' end ) 
	 					   and  (mnotacredito.testadodocumento  like case @testadodoc when '' then '%' else @testadodoc+'%' end ) 
						  order by tdocumento

				end
			else
				begin
 						  Insert into #DBTRANS (fRegistro, tDocumento, nNeto, nImpuesto1, nImpuesto2, nImpuesto3, nVenta, tEstadoDocumento, tTipoDocumento, tTemporal)  
								   SELECT dbo.MNOTACREDITO.fFecha AS fRegistro, substring(dbo.MNOTACREDITO.tNotaCredito,1,1)+substring(dbo.MNOTACREDITO.tNotaCredito,4,3)+substring(dbo.MNOTACREDITO.tNotaCredito,9,7) AS tDocumento, dbo.MNOTACREDITO.nNeto, dbo.MNOTACREDITO.nImpuesto1, dbo.MNOTACREDITO.nImpuesto2, dbo.MNOTACREDITO.nImpuesto3, dbo.MNOTACREDITO.nVenta,  
								   dbo.MNOTACREDITO.tEstadoDocumento, dbo.vTipoDocumento.Codigo AS tTipoDocumento, dbo.MNOTACREDITO.tDocumento AS tTemporal  
								   FROM dbo.MNOTACREDITO LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.MNOTACREDITO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vTipoDocumento ON SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 1, 1) = dbo.vTipoDocumento.Prefijo  
							   where MNOTACREDITO.fFecha >= @fInicio and MNOTACREDITO.fFecha <= @ffinal    
						   and  (codigo like case @ttipodoc when '' then '%' else @ttipodoc+'%' end ) 
	 					   and  (mnotacredito.testadodocumento  like case @testadodoc when '' then '%' else @testadodoc+'%' end ) 
              					   order by tdocumento
			 
				end
			--print @sql



			select @sNc= Codigo from vTipoDocumento where Prefijo='N'

			--Se pone en negativo las notas de crdito
			 update #DBTRANS set nNeto = nNeto * -1 , nImpuesto1 = nImpuesto1 * -1, nImpuesto2 = nImpuesto2 * -1, nImpuesto3 = nImpuesto3 * -1, nVenta = nVenta * -1 where tTipoDocumento=@sNC and tEstadoDocumento<>'04'

			 update #DBTRANS set tCodigoCliente = dbo.MDOCUMENTO.tCodigoCliente FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.#DBTRANS.tTemporal = dbo.MDOCUMENTO.tDocumento where #DBTRANS.tTipoDocumento=@sNC

			   
			--se Pone en cero los anulados
			 update #DBTRANS set nNeto = 0, nImpuesto1 = 0, nImpuesto2 = 0, nImpuesto3 = 0, nVenta = 0, nRecargo = 0, nDescuento = 0 where tEstadoDocumento='04'


				select vTipoDocumento.Sunat,  Min(tDocumento) as Minimo, Max(tDocumento) as Maximo, sum(nNeto) as Neto, sum(nImpuesto1) as Impuesto1, sum(nImpuesto2) as Impuesto2 , sum(nImpuesto3) as Impuesto3, sum(nVenta) as Venta, sum(isnull(nRecargo,0)-isnull(nDescuento,0)) as Descuento 
      				from #DBTRANS LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.#DBTRANS.tTipoDocumento = dbo.vTipoDocumento.Codigo 
					Group by  vTipoDocumento.Sunat order by 1
	end

if @flagTipo=1
	begin

	CREATE TABLE #DBTRANST  (
											tTipoDocumento nvarchar(3) collate Modern_Spanish_CI_AS,
										    tSerie nvarchar(20) collate Modern_Spanish_CI_AS,
											tNumero nvarchar(20) collate Modern_Spanish_CI_AS,
											fRegistro nvarchar(30) collate Modern_Spanish_CI_AS,
											tRuc nvarchar(20) collate Modern_Spanish_CI_AS,
											tRazonSocial nvarchar(250) collate Modern_Spanish_CI_AS ,
											tDireccion nvarchar(250)  collate Modern_Spanish_CI_AS, 
											nNeto float, 
											nImpuesto1 float, 
											nImpuesto2 float, 
											nImpuesto3 float, 
											nVenta float, 
											nRecargo float, 
											nDescuento float, 
											tEstado nvarchar(30)  collate Modern_Spanish_CI_AS, 
											tcodigoestado nvarchar(10)  collate Modern_Spanish_CI_AS, 
											tcodigoCliente nvarchar(10)  collate Modern_Spanish_CI_AS )
 

	--inserta documentos
				if @flagRedondeo=1
						begin
						if @flagRegVenta=1 
							begin
											-- tickets con ruc y facturas detallados
														  inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero ,fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) 
														  SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, '') AS Ruc, ISNULL(dbo.vCliente.Descripcion, '') AS Razon, ISNULL(dbo.vCliente.tDireccion, '') AS Direccion, round(dbo.MDOCUMENTO.nNeto,2) nneto,  round(dbo.MDOCUMENTO.nPrecioImpuesto1,2) nImpuesto1, round(dbo.MDOCUMENTO.nPrecioImpuesto2,2) nImpuesto2, round(dbo.MDOCUMENTO.nPrecioImpuesto3,2) nImpuesto3, round(dbo.MDOCUMENTO.nVenta,2) nVenta, round(dbo.MDOCUMENTO.nRecargo,2) nRecargo, round(dbo.MDOCUMENTO.nDescuento,2) nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, '') AS tCodigoCliente 
														  FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo 
														  WHERE  (dbo.vTipoDocumento.RegistroVenta = 1) AND (dbo.MDOCUMENTO.fRegistro >= @FINICIO) AND (dbo.MDOCUMENTO.fRegistro <=@FFINAL) AND (dbo.MDOCUMENTO.tEstadoDocumento <>'04') AND (ISNULL(dbo.vCliente.tIdentidad,  '')<>  '') AND (LEN(ISNULL(dbo.vCliente.tIdentidad,  '')) >= 11)  
														  ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro 
										

											-- tickets sin ruc y boletas acumuladas
														  inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero ,fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) 
														  SELECT    dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie,  (min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))+ '/'++max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7)) ) AS tDocumento, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, '' AS Ruc, '' AS Razon, '' AS Direccion, SUM(round(dbo.MDOCUMENTO.nNeto,2)) AS nneto, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto1, 2)) AS nImpuesto1, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto2, 2)) AS nImpuesto2, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto3, 2)) AS nImpuesto3, SUM(ROUND(dbo.MDOCUMENTO.nVenta, 2)) AS nVenta, SUM(ROUND(dbo.MDOCUMENTO.nRecargo, 2)) AS nRecargo, SUM(ROUND(dbo.MDOCUMENTO.nDescuento, 2)) AS nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, '' AS tCodigoCliente 
														  FROM   dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo 
														  WHERE     (dbo.vTipoDocumento.RegistroVenta = 1) AND (ISNULL(dbo.vCliente.tIdentidad, '') = '' ) AND (LEN(ISNULL(dbo.vCliente.tIdentidad, '')) < 11) AND   (dbo.MDOCUMENTO.fRegistro >= @FINICIO) AND (dbo.MDOCUMENTO.fRegistro <= @FFINAL) AND  (dbo.vTipoDocumento.Sunat <> '01') AND (dbo.MDOCUMENTO.tEstadoDocumento <> '04') 
														  GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103), dbo.vEstadoDocumento.Descripcion, dbo.MDOCUMENTO.tEstadoDocumento 
														  ORDER BY dbo.vTipoDocumento.Sunat, Serie, 4 
											

											-- ANULADOS CON RUC detallados
														  inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero ,fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente )
														  SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, '') AS Ruc, ISNULL(dbo.vCliente.Descripcion, '') AS Razon, ISNULL(dbo.vCliente.tDireccion,  '') AS Direccion, round(dbo.MDOCUMENTO.nNeto,2) nNeto,  round(dbo.MDOCUMENTO.nPrecioImpuesto1,2) nImpuesto1, round(dbo.MDOCUMENTO.nPrecioImpuesto2,2) nImpuesto2, round(dbo.MDOCUMENTO.nPrecioImpuesto3,2) nImpuesto3, round(dbo.MDOCUMENTO.nVenta,2) nVenta, round(dbo.MDOCUMENTO.nRecargo,2) nRecargo, round(dbo.MDOCUMENTO.nDescuento,2) nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, '') AS tCodigoCliente 
														  FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo 
														  WHERE  (dbo.vTipoDocumento.RegistroVenta = 1) AND (dbo.MDOCUMENTO.fRegistro >= @FINICIO) AND (dbo.MDOCUMENTO.fRegistro <= @FFINAL) AND (dbo.MDOCUMENTO.tEstadoDocumento = '04') AND (ISNULL(dbo.vCliente.tIdentidad, '') <>  '') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, '')) >= 11) 
														  ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro 

											--print @sql
										 
						
											-- ANULADOS SIN RUC resumidos
														  inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero ,fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente )
														  SELECT  dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie,(min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))+ '/'++max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) )) AS tDocumento, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO,  '' AS Ruc,  '' AS Razon,  '' AS Direccion, SUM(round(dbo.MDOCUMENTO.nNeto,2)) AS NNETO, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto1, 2)) AS nImpuesto1, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto2, 2)) AS nImpuesto2, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto3, 2)) AS nImpuesto3, SUM(ROUND(dbo.MDOCUMENTO.nVenta, 2)) AS nVenta, SUM(ROUND(dbo.MDOCUMENTO.nRecargo, 2)) AS nRecargo, SUM(ROUND(dbo.MDOCUMENTO.nDescuento, 2)) AS nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, '' AS tCodigoCliente 
														  FROM         dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo 
														  WHERE     (dbo.vTipoDocumento.RegistroVenta = 1) AND (ISNULL(dbo.vCliente.tIdentidad,  '') =  '') AND (LEN(ISNULL(dbo.vCliente.tIdentidad,  '')) < 11) AND  (dbo.MDOCUMENTO.fRegistro >= @FINICIO) AND (dbo.MDOCUMENTO.fRegistro <= @FFINAL) AND  (dbo.MDOCUMENTO.tEstadoDocumento = '04') 
														  GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103),  dbo.vEstadoDocumento.Descripcion, dbo.MDOCUMENTO.tEstadoDocumento 
														  ORDER BY dbo.vTipoDocumento.Sunat, Serie,4
											--print @sql
											
								
						 end	

						if @flagRegVenta=0
							begin
											-- tickets con ruc y facturas detallados
														 inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero ,fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) 
														 SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, '') AS Ruc, ISNULL(dbo.vCliente.Descripcion,'') AS Razon, ISNULL(dbo.vCliente.tDireccion, '') AS Direccion, round(dbo.MDOCUMENTO.nNeto,2) nneto,  round(dbo.MDOCUMENTO.nPrecioImpuesto1,2) nImpuesto1, round(dbo.MDOCUMENTO.nPrecioImpuesto2,2) nImpuesto2, round(dbo.MDOCUMENTO.nPrecioImpuesto3,2) nImpuesto3, round(dbo.MDOCUMENTO.nVenta,2) nVenta, round(dbo.MDOCUMENTO.nRecargo,2) nRecargo, round(dbo.MDOCUMENTO.nDescuento,2) nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, '') AS tCodigoCliente 
														 FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo 
														 WHERE   (dbo.MDOCUMENTO.fRegistro >= @FINICIO) AND (dbo.MDOCUMENTO.fRegistro <= @FFINAL) AND (dbo.MDOCUMENTO.tEstadoDocumento <>'04') AND (ISNULL(dbo.vCliente.tIdentidad, '') <>  '') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, '')) >= 11) 
														 ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro
											

											-- tickets sin ruc y boletas acumuladas
														inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero ,fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) 
														SELECT    dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie,(min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))+ '/'++max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) )) AS tDocumento, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, '' AS Ruc, '' AS Razon,'' AS Direccion, SUM(round(dbo.MDOCUMENTO.nNeto,2)) AS nneto, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto1, 2)) AS nImpuesto1, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto2, 2)) AS nImpuesto2, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto3, 2)) AS nImpuesto3, SUM(ROUND(dbo.MDOCUMENTO.nVenta, 2)) AS nVenta, SUM(ROUND(dbo.MDOCUMENTO.nRecargo, 2)) AS nRecargo, SUM(ROUND(dbo.MDOCUMENTO.nDescuento, 2)) AS nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, '' AS tCodigoCliente  
														FROM   dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo 
														WHERE      (ISNULL(dbo.vCliente.tIdentidad, '' ) = '') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, '')) < 11) AND   (dbo.MDOCUMENTO.fRegistro >= @FINICIO) AND (dbo.MDOCUMENTO.fRegistro <= @FFINAL) AND  (dbo.vTipoDocumento.Sunat <> '01')  AND (dbo.MDOCUMENTO.tEstadoDocumento <> '04') 
														GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103), dbo.vEstadoDocumento.Descripcion, dbo.MDOCUMENTO.tEstadoDocumento 
														ORDER BY dbo.vTipoDocumento.Sunat, Serie, 4
											
											-- ANULADOS CON RUC detallados
														inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero ,fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) 
														SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, '') AS Ruc, ISNULL(dbo.vCliente.Descripcion, '') AS Razon, ISNULL(dbo.vCliente.tDireccion,'') AS Direccion, round(dbo.MDOCUMENTO.nNeto,2) nneto,  round(dbo.MDOCUMENTO.nPrecioImpuesto1,2) nImpuesto1, round(dbo.MDOCUMENTO.nPrecioImpuesto2,2) nImpuesto2, round(dbo.MDOCUMENTO.nPrecioImpuesto3,2) nImpuesto3, round(dbo.MDOCUMENTO.nVenta,2) nVenta, round(dbo.MDOCUMENTO.nRecargo,2) nRecargo, round(dbo.MDOCUMENTO.nDescuento,2) nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, '') AS tCodigoCliente 
														FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo 
														WHERE   (dbo.MDOCUMENTO.fRegistro >= @FINICIO)  AND (dbo.MDOCUMENTO.fRegistro <= @FFINAL) AND (dbo.MDOCUMENTO.tEstadoDocumento = '04') AND (ISNULL(dbo.vCliente.tIdentidad, '') <> '') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, '')) >= 11) 
														ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro 

											--print @sql
											
						
											-- ANULADOS SIN RUC resumidos
														inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero ,fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) 
														SELECT  dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, (min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))+ '/'++max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) )) AS tDocumento, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, '' AS Ruc, '' AS Razon, ''  AS Direccion, SUM(round(dbo.MDOCUMENTO.nNeto,2)) AS NNETO, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto1, 2)) AS nImpuesto1, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto2, 2)) AS nImpuesto2, SUM(ROUND(dbo.MDOCUMENTO.nPrecioImpuesto3, 2)) AS nImpuesto3, SUM(ROUND(dbo.MDOCUMENTO.nVenta, 2)) AS nVenta, SUM(ROUND(dbo.MDOCUMENTO.nRecargo, 2)) AS nRecargo, SUM(ROUND(dbo.MDOCUMENTO.nDescuento, 2)) AS nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, '' AS tCodigoCliente 
														FROM         dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo
														WHERE    (ISNULL(dbo.vCliente.tIdentidad, '') = '') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, '')) < 11) AND  (dbo.MDOCUMENTO.fRegistro >= @FINICIO) AND (dbo.MDOCUMENTO.fRegistro <= @FFINAL)  AND  (dbo.MDOCUMENTO.tEstadoDocumento = '04' ) 
														GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103),  dbo.vEstadoDocumento.Descripcion, dbo.MDOCUMENTO.tEstadoDocumento 
														ORDER BY dbo.vTipoDocumento.Sunat, Serie,4
											
											
										
							end
					end 
					if @flagRedondeo=0
					    begin
						if @flagRegVenta=1	
							begin
										-- tickets con ruc y facturas detallados
											inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero ,fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) 
											SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, '') AS Ruc, ISNULL(dbo.vCliente.Descripcion, '') AS Razon, ISNULL(dbo.vCliente.tDireccion, '') AS Direccion, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1 as  nImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2 nImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3 nImpuesto3, dbo.MDOCUMENTO.nVenta nVenta, dbo.MDOCUMENTO.nRecargo as nRecargo, dbo.MDOCUMENTO.nDescuento as nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, '') AS tCodigoCliente 
											FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo 
											WHERE  (dbo.vTipoDocumento.RegistroVenta = 1) AND (dbo.MDOCUMENTO.fRegistro >= @FINICIO)  AND (dbo.MDOCUMENTO.fRegistro <= @FFINAL) AND (dbo.MDOCUMENTO.tEstadoDocumento <>'04') AND (ISNULL(dbo.vCliente.tIdentidad,  '') <>'') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, '')) >= 11) 
													and  (ttipodocumento like case @ttipodoc when '' then '%' else @ttipodoc+'%' end ) 								and  (mdocumento.testadodocumento  like case @testadodoc when '' then '%' else @testadodoc+'%' end ) 
											ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro
											
											

											-- tickets sin ruc y boletas acumuladas
											inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero ,fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) 
											SELECT    dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, (min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))+ '/'++max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) )) AS tDocumento, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO,   ''  AS Ruc,  ''  AS Razon,  '' AS Direccion, SUM(dbo.MDOCUMENTO.nNeto) AS nneto, SUM(dbo.MDOCUMENTO.nPrecioImpuesto1) AS nImpuesto1, SUM(dbo.MDOCUMENTO.nPrecioImpuesto2) AS nImpuesto2, SUM(dbo.MDOCUMENTO.nPrecioImpuesto3) AS nImpuesto3, SUM(dbo.MDOCUMENTO.nVenta) AS nVenta, SUM(dbo.MDOCUMENTO.nRecargo) AS nRecargo, SUM(dbo.MDOCUMENTO.nDescuento) AS nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, '' AS tCodigoCliente 
											FROM   dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo 
											WHERE     (dbo.vTipoDocumento.RegistroVenta = 1) AND (ISNULL(dbo.vCliente.tIdentidad, '') = '') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, '')) < 11) AND   (dbo.MDOCUMENTO.fRegistro >= @FINICIO) AND (dbo.MDOCUMENTO.fRegistro <= @FFINAL)  AND  (dbo.vTipoDocumento.Sunat <> '01') AND (dbo.MDOCUMENTO.tEstadoDocumento <> '04') 
													and  (ttipodocumento like case @ttipodoc when '' then '%' else @ttipodoc+'%' end ) 								and  (mdocumento.testadodocumento  like case @testadodoc when '' then '%' else @testadodoc+'%' end ) 
											GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103), dbo.vEstadoDocumento.Descripcion, dbo.MDOCUMENTO.tEstadoDocumento 
											ORDER BY dbo.vTipoDocumento.Sunat, Serie, 4
											

											-- ANULADOS CON RUC detallados
											inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero ,fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) 
											SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad,   '' ) AS Ruc, ISNULL(dbo.vCliente.Descripcion,  '' ) AS Razon, ISNULL(dbo.vCliente.tDireccion,  '' ) AS Direccion, dbo.MDOCUMENTO.nNeto,  dbo.MDOCUMENTO.nPrecioImpuesto1 as  nImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2 as  nImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3 as  nImpuesto3, dbo.MDOCUMENTO.nVenta as nVenta, dbo.MDOCUMENTO.nRecargo as nRecargo, dbo.MDOCUMENTO.nDescuento as nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente,  '' ) AS tCodigoCliente  
											FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo  
											WHERE  (dbo.vTipoDocumento.RegistroVenta = 1) AND (dbo.MDOCUMENTO.fRegistro >=  @FINICIO) AND (dbo.MDOCUMENTO.fRegistro <= @FFINAL)  AND (dbo.MDOCUMENTO.tEstadoDocumento = '04' ) AND (ISNULL(dbo.vCliente.tIdentidad, '') <> '') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, '' )) >= 11) 
													and  (ttipodocumento like case @ttipodoc when '' then '%' else @ttipodoc+'%' end ) 								and  (mdocumento.testadodocumento  like case @testadodoc when '' then '%' else @testadodoc+'%' end ) 
											ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro 

											
											
						
											-- ANULADOS SIN RUC resumidos
											inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero ,fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) 
											SELECT  dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, (min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))+ '/'++max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) )) AS tDocumento, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, '' AS Ruc, '' AS Razon, ''  AS Direccion, SUM(dbo.MDOCUMENTO.nNeto) AS NNETO, SUM(dbo.MDOCUMENTO.nPrecioImpuesto1) AS nImpuesto1, SUM(dbo.MDOCUMENTO.nPrecioImpuesto2) AS nImpuesto2, SUM(dbo.MDOCUMENTO.nPrecioImpuesto3) AS nImpuesto3, SUM(dbo.MDOCUMENTO.nVenta) AS nVenta, SUM(dbo.MDOCUMENTO.nRecargo) AS nRecargo, SUM(dbo.MDOCUMENTO.nDescuento) AS nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, '' AS tCodigoCliente 
											FROM         dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo 
											WHERE     (dbo.vTipoDocumento.RegistroVenta = 1) AND (ISNULL(dbo.vCliente.tIdentidad, '') = '') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, '')) < 11) AND  (dbo.MDOCUMENTO.fRegistro >= @FINICIO)  AND (dbo.MDOCUMENTO.fRegistro <= @FFINAL) AND  (dbo.MDOCUMENTO.tEstadoDocumento = '04' )
													and  (ttipodocumento like case @ttipodoc when '' then '%' else @ttipodoc+'%' end ) 								and  (mdocumento.testadodocumento  like case @testadodoc when '' then '%' else @testadodoc+'%' end ) 
											GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103),  dbo.vEstadoDocumento.Descripcion, dbo.MDOCUMENTO.tEstadoDocumento 
											ORDER BY dbo.vTipoDocumento.Sunat, Serie, 4
																								
							end
						if @flagRegVenta=0 
							begin
														-- tickets con ruc y facturas detallados
											inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero ,fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) 
											SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, '') AS Ruc, ISNULL(dbo.vCliente.Descripcion, '') AS Razon, ISNULL(dbo.vCliente.tDireccion, '') AS Direccion, dbo.MDOCUMENTO.nNeto, dbo.MDOCUMENTO.nPrecioImpuesto1 as  nImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2 nImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3 nImpuesto3, dbo.MDOCUMENTO.nVenta nVenta, dbo.MDOCUMENTO.nRecargo as nRecargo, dbo.MDOCUMENTO.nDescuento as nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, '') AS tCodigoCliente 
											FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo 
											WHERE   (dbo.MDOCUMENTO.fRegistro >= @FINICIO) AND (dbo.MDOCUMENTO.fRegistro <= @FFINAL) AND (dbo.MDOCUMENTO.tEstadoDocumento <>'04') AND (ISNULL(dbo.vCliente.tIdentidad, '') <> '') AND (LEN(ISNULL(dbo.vCliente.tIdentidad, '')) >= 11) 
													and  (ttipodocumento like case @ttipodoc when '' then '%' else @ttipodoc+'%' end ) 								and  (mdocumento.testadodocumento  like case @testadodoc when '' then '%' else @testadodoc+'%' end ) 
											ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro 
											

											-- tickets sin ruc y boletas acumuladas
											inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero ,fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente )
											SELECT    dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, (min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))+ '/'++max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) )) AS tDocumento, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, '' AS Ruc, '' AS Razon,  '' AS Direccion, SUM(dbo.MDOCUMENTO.nNeto) AS nneto, SUM(dbo.MDOCUMENTO.nPrecioImpuesto1) AS nImpuesto1, SUM(dbo.MDOCUMENTO.nPrecioImpuesto2) AS nImpuesto2, SUM(dbo.MDOCUMENTO.nPrecioImpuesto3) AS nImpuesto3, SUM(dbo.MDOCUMENTO.nVenta) AS nVenta, SUM(dbo.MDOCUMENTO.nRecargo) AS nRecargo, SUM(dbo.MDOCUMENTO.nDescuento) AS nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, '' AS tCodigoCliente 
											FROM   dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo 
											WHERE     (ISNULL(dbo.vCliente.tIdentidad, '') =  '' ) AND (LEN(ISNULL(dbo.vCliente.tIdentidad,  '')) < 11) AND   (dbo.MDOCUMENTO.fRegistro >= @FINICIO)  AND (dbo.MDOCUMENTO.fRegistro <= @FFINAL)  AND  (dbo.vTipoDocumento.Sunat <> '01') AND (dbo.MDOCUMENTO.tEstadoDocumento <> '04') 
													and  (ttipodocumento like case @ttipodoc when '' then '%' else @ttipodoc+'%' end ) 								and  (mdocumento.testadodocumento  like case @testadodoc when '' then '%' else @testadodoc+'%' end ) 
											GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103), dbo.vEstadoDocumento.Descripcion, dbo.MDOCUMENTO.tEstadoDocumento 
											ORDER BY dbo.vTipoDocumento.Sunat, Serie, 4
											

											-- ANULADOS CON RUC detallados
											inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero ,fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) 
											SELECT dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) AS tDocumento, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, '') AS Ruc, ISNULL(dbo.vCliente.Descripcion, '') AS Razon, ISNULL(dbo.vCliente.tDireccion, '') AS Direccion, dbo.MDOCUMENTO.nNeto,  dbo.MDOCUMENTO.nPrecioImpuesto1 as  nImpuesto1, dbo.MDOCUMENTO.nPrecioImpuesto2 as  nImpuesto2, dbo.MDOCUMENTO.nPrecioImpuesto3 as  nImpuesto3, dbo.MDOCUMENTO.nVenta as nVenta, dbo.MDOCUMENTO.nRecargo as nRecargo, dbo.MDOCUMENTO.nDescuento as nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente,'') AS tCodigoCliente 
											FROM dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo 
											WHERE   (dbo.MDOCUMENTO.fRegistro >= @FINICIO) AND (dbo.MDOCUMENTO.fRegistro <=  @FFINAL) AND (dbo.MDOCUMENTO.tEstadoDocumento =  '04') AND (ISNULL(dbo.vCliente.tIdentidad, '') <> '' ) AND (LEN(ISNULL(dbo.vCliente.tIdentidad, '')) >= 11) 
													and  (ttipodocumento like case @ttipodoc when '' then '%' else @ttipodoc+'%' end ) 								and  (mdocumento.testadodocumento  like case @testadodoc when '' then '%' else @testadodoc+'%' end ) 
											ORDER BY dbo.vTipoDocumento.Sunat, serie, dbo.MDOCUMENTO.fRegistro 

											
											
						
											-- ANULADOS SIN RUC resumidos
											inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero ,fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente )
											SELECT  dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3) AS Serie,  (min(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7))+ '/'++max(SUBSTRING(dbo.MDOCUMENTO.tDocumento, 9, 7) )) AS tDocumento, CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103) AS FREGISTRO, ''  AS Ruc,  '' AS Razon, '' AS Direccion, SUM(dbo.MDOCUMENTO.nNeto) AS NNETO, SUM(dbo.MDOCUMENTO.nPrecioImpuesto1) AS nImpuesto1, SUM(dbo.MDOCUMENTO.nPrecioImpuesto2) AS nImpuesto2, SUM(dbo.MDOCUMENTO.nPrecioImpuesto3) AS nImpuesto3, SUM(dbo.MDOCUMENTO.nVenta) AS nVenta, SUM(dbo.MDOCUMENTO.nRecargo) AS nRecargo, SUM(dbo.MDOCUMENTO.nDescuento) AS nDescuento, dbo.vEstadoDocumento.Descripcion AS Estado, dbo.MDOCUMENTO.tEstadoDocumento, '' AS tCodigoCliente 
											FROM         dbo.MDOCUMENTO INNER JOIN dbo.vEstadoDocumento ON dbo.MDOCUMENTO.tEstadoDocumento = dbo.vEstadoDocumento.Codigo LEFT OUTER JOIN dbo.vCliente ON dbo.MDOCUMENTO.tCodigoCliente = dbo.vCliente.Codigo LEFT OUTER JOIN dbo.vTipoDocumento ON dbo.MDOCUMENTO.tTipoDocumento = dbo.vTipoDocumento.Codigo 
											WHERE     (ISNULL(dbo.vCliente.tIdentidad,  '' ) =  '' ) AND (LEN(ISNULL(dbo.vCliente.tIdentidad,  '' )) < 11) AND  (dbo.MDOCUMENTO.fRegistro >= @FINICIO)  AND (dbo.MDOCUMENTO.fRegistro <= @FFINAL ) AND  (dbo.MDOCUMENTO.tEstadoDocumento = '04' ) 
													and  (ttipodocumento like case @ttipodoc when '' then '%' else @ttipodoc+'%' end ) 								and  (mdocumento.testadodocumento  like case @testadodoc when '' then '%' else @testadodoc+'%' end ) 
											GROUP BY dbo.vTipoDocumento.Sunat, SUBSTRING(dbo.MDOCUMENTO.tDocumento, 4, 3), CONVERT(NVARCHAR, dbo.MDOCUMENTO.fRegistro, 103),  dbo.vEstadoDocumento.Descripcion, dbo.MDOCUMENTO.tEstadoDocumento 
											ORDER BY dbo.vTipoDocumento.Sunat, Serie,4
											
											
							end 
						 end
						--INSERTAR NOTA DE CREDITOS
						IF @flagRedondeo=1
							begin
								inserT into #DBTRANST (tTipoDocumento ,tSerie ,tNumero ,fRegistro ,tRuc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) 
								SELECT dbo.vTipoDocumento.Sunat AS tTipodocumento, SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 4, 3) AS serie, SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 9, 7) AS tDocumento, CONVERT(NVARCHAR, dbo.MNOTACREDITO.fFecha, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad,  '' ) AS ruc, ISNULL(dbo.vCliente.Descripcion,  '' ) AS razon, ISNULL(dbo.vCliente.tDireccion,  '' ) AS direccion, round(dbo.MNOTACREDITO.nNeto,2) as nneto, round(dbo.MNOTACREDITO.nImpuesto1,2) as nimpuesto1, round(dbo.MNOTACREDITO.nImpuesto2,2) as nImpuesto2, round(dbo.MNOTACREDITO.nImpuesto3,2) as nImpuesto3, round(dbo.MNOTACREDITO.nVenta,2) as nVenta,0 as nrecargo,0 as ndescuento, dbo.vEstadoDocumento.Descripcion AS estado, dbo.MNOTACREDITO.tEstadoDocumento AS testadodocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, '') AS tcodigocliente 
								FROM         dbo.vEstadoDocumento RIGHT OUTER JOIN dbo.MNOTACREDITO ON dbo.vEstadoDocumento.Codigo = dbo.MNOTACREDITO.tEstadoDocumento LEFT OUTER JOIN  dbo.vCliente RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.vCliente.Codigo = dbo.MDOCUMENTO.tCodigoCliente ON dbo.MNOTACREDITO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vTipoDocumento ON SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 1, 1) = dbo.vTipoDocumento.Prefijo 
								WHERE     (dbo.MNOTACREDITO.fFecha >=  @FINICIO ) AND (dbo.MNOTACREDITO.fFecha <= @FFINAL)
									and  (vTipoDocumento.codigo like case @ttipodoc when '' then '%' else @ttipodoc+'%' end ) 
	 								and  (mnotacredito.testadodocumento  like case @testadodoc when '' then '%' else @testadodoc+'%' end ) 
								ORDER BY dbo.MNOTACREDITO.fFecha, dbo.MNOTACREDITO.tNotaCredito
								

							end
						if @flagRedondeo=0
							begin
								inserT into #DBTRANST (tTipoDocumento ,					tSerie ,											tNumero ,														fRegistro ,													tRuc ,																tRazonSocial  ,															tDireccion ,														 nNeto ,					 nImpuesto1 ,										nImpuesto2 ,								 nImpuesto3 ,					nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente ) 
								SELECT dbo.vTipoDocumento.Sunat AS tTipodocumento, SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 4, 3) AS serie, SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 9, 7) AS tDocumento, CONVERT(NVARCHAR, dbo.MNOTACREDITO.fFecha, 103) AS FREGISTRO, ISNULL(dbo.vCliente.tIdentidad, '') AS ruc, ISNULL(dbo.vCliente.Descripcion,  '' ) AS razon, ISNULL(dbo.vCliente.tDireccion,  '' ) AS direccion,dbo.MNOTACREDITO.nNeto as nneto,  dbo.MNOTACREDITO.nImpuesto1  as nimpuesto1,  dbo.MNOTACREDITO.nImpuesto2  as nImpuesto2,  dbo.MNOTACREDITO.nImpuesto3  as nImpuesto3, dbo.MNOTACREDITO.nVenta  as nVenta,0 as nrecargo,0 as ndescuento, dbo.vEstadoDocumento.Descripcion AS estado, dbo.MNOTACREDITO.tEstadoDocumento AS testadodocumento, ISNULL(dbo.MDOCUMENTO.tCodigoCliente, '' ) AS tcodigocliente 
								FROM         dbo.vEstadoDocumento RIGHT OUTER JOIN dbo.MNOTACREDITO ON dbo.vEstadoDocumento.Codigo = dbo.MNOTACREDITO.tEstadoDocumento LEFT OUTER JOIN  dbo.vCliente RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.vCliente.Codigo = dbo.MDOCUMENTO.tCodigoCliente ON dbo.MNOTACREDITO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vTipoDocumento ON SUBSTRING(dbo.MNOTACREDITO.tNotaCredito, 1, 1) = dbo.vTipoDocumento.Prefijo 
								WHERE     (dbo.MNOTACREDITO.fFecha >= @FINICIO) AND (dbo.MNOTACREDITO.fFecha <= @FFINAL)
											and  (vTipoDocumento.codigo like case @ttipodoc when '' then '%' else @ttipodoc+'%' end ) 
	 										and  (mnotacredito.testadodocumento  like case @testadodoc when '' then '%' else @testadodoc+'%' end ) 
								ORDER BY dbo.MNOTACREDITO.fFecha, dbo.MNOTACREDITO.tNotaCredito


							end
					--se Pone en cero los anulados
 					 update #DBTRANST set nNeto = 0, nImpuesto1 = 0, nImpuesto2 = 0, nImpuesto3 = 0, nVenta = 0, nRecargo = 0, nDescuento = 0 where tcodigoEstado='04'
					

					--Se pone en negativo las notas de crdito
					
					 update #DBTRANST set nNeto = nNeto * -1 , nImpuesto1 = nImpuesto1 * -1, nImpuesto2 = nImpuesto2 * -1, nImpuesto3 = nImpuesto3 * -1, nVenta = nVenta * -1 where tTipoDocumento= '07' and tCODIGOEstado<> '04'


				--	print @sql
				
					select tTipoDocumento ,tSerie ,tNumero ,fRegistro ,ltrim(tRuc) as truc ,tRazonSocial  ,tDireccion , nNeto , nImpuesto1 , nImpuesto2 , nImpuesto3 , nVenta , nRecargo , nDescuento , tEstado , tcodigoestado , tcodigoCliente from #DBTRANST 
					order by    ttipodocumento,tserie,fregistro
					





	end
END




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

CREATE PROCEDURE [dbo].[spRep_VentaMensualCanalesIntegrado]
@sPrecio as nvarchar(60),
@sAno as nvarchar(4),
@sMes as nvarchar(4),
@sFecha as nvarchar(400),
@dHour as float

AS BEGIN
set nocount on
declare @sql nvarchar(4000)
declare @comilla nvarchar(5)
set @sql=''
set @comilla=''''

	CREATE TABLE #DBTRANS (Dia int, Salon Float, Delivery Float, Llevar Float, Canal4 Float, Canal5 Float, Venta float, Cantidad Int, Pax Int, TipoPedido nVarchar(50) collate Modern_Spanish_CI_AS,costo float)

	set @sql= ' insert #DBTRANS select (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end) as dia, ' + 
              ' (case when mpedido.ttipopedido='+@comilla+ '01'+@comilla+' then sum(' + @sPrecio + ') else 0 end) as Salon, ' + 
	      ' (case when mpedido.ttipopedido='+@comilla+ '02'+@comilla+' then Sum(' + @sPrecio + ') else 0 end) as Delivery, ' + 
              ' (case when mpedido.ttipopedido='+@comilla+ '03'+@comilla+' then Sum(' + @sPrecio + ') else 0 end) as Llevar, ' + 
  	      ' (case when mpedido.ttipopedido='+@comilla+ '04'+@comilla+' then Sum(' + @sPrecio + ') else 0 end) as Canal4, ' + 
      	      ' (case when mpedido.ttipopedido='+@comilla+ '05'+@comilla+' then Sum(' + @sPrecio + ') else 0 end) as Canal5, ' + 
     	      ' sum(' + @sPrecio + ') as Venta,  0, 0,  MPEDIDO.tTipoPedido, sum((dbo.DPEDIDO.nInsumo+dbo.DPEDIDO.nGasto+dbo.DPEDIDO.nManoObra)*dbo.dpedido.ncantidad ) as costo ' + 
     	      ' FROM dbo.DPEDIDO INNER JOIN  dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN   dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' + 
     	      ' Where mpedido.testadopedido<>'+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sFecha + 
     	      ' group by (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end), Mpedido.ttipopedido ' + 
     	      ' order by (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end)' 

    EXECUTE sp_executesql @sql
                
    set @sql= 'update #DBTRANS set Cantidad= T1.nC1 + T1.nC2 + T1.nC3 + T1.nC4 + T1.nC5, Pax=T1.nAdulto   from mpedido, ' + 
           ' (select (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + ' then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end) as dia, ' + 
           ' (case when mpedido.ttipopedido='+@comilla+ '01'+@comilla+' then sum(nadulto) else 0 end) nAdulto, ' + 
           ' (case when mpedido.ttipopedido='+@comilla+ '01'+@comilla+' then count(mPedido.tCodigoPedido) else 0 end) nC1, ' + 
           ' (case when mpedido.ttipopedido='+@comilla+ '02'+@comilla+' then count(mPedido.tCodigoPedido) else 0 end) nC2, ' + 
           ' (case when mpedido.ttipopedido='+@comilla+ '03'+@comilla+' then count(mPedido.tCodigoPedido) else 0 end) nC3, ' + 
           ' (case when mpedido.ttipopedido='+@comilla+ '04'+@comilla+' then count(mPedido.tCodigoPedido) else 0 end) nC4, ' + 
           ' (case when mpedido.ttipopedido='+@comilla+ '05'+@comilla+' then count(mPedido.tCodigoPedido) else 0 end) nC5,   tTipoPedido   from mpedido ' + 
           ' Where mpedido.testadopedido<>'+@comilla+ '03'+@comilla+' and ' + @sFecha + 
           ' group by (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + ' then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end), Mpedido.ttipopedido) T1 ' + 
           ' WHERE #DBTRANS.Dia = T1.dia and  #DBTRANS.TipoPedido = T1.tTipoPedido' 
 EXECUTE sp_executesql @sql

        UPDATE #dbtrans SET tipopedido=(select Descripcion from vtipopedido where codigo=#dbtrans.tipopedido)
        
		SELECT tipopedido, sum(venta)  as ventas ,sum(pax),sum(cantidad) FROM #dbtrans GROUP BY tipopedido

END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




CREATE PROCEDURE spRep_VentaMensualIntegrado
@sPrecio as nvarchar(150),
@sAno as nvarchar(4),
@sMes as nvarchar(4),
@sFecha as nvarchar(400),
@dHour as float,
@tipo as nvarchar(1),
@metaMensual as float,
@diames as float
AS BEGIN
set nocount on
declare @sql nvarchar(4000)
declare @comilla nvarchar(5)
set @sql=''
set @comilla=''''

CREATE TABLE #DBTRANS (Dia int, Salon Float, Delivery Float, Llevar Float, Canal4 Float, Canal5 Float, Venta float, Cantidad Int, Pax Int, TipoPedido nVarchar(3) collate Modern_Spanish_CI_AS,costo float)
	set @sql= ' insert #DBTRANS select (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end) as dia, ' + 
              ' (case when mpedido.ttipopedido='+@comilla+ '01'+@comilla+' then sum(' + @sPrecio + ') else 0 end) as Salon, ' + 
	      ' (case when mpedido.ttipopedido='+@comilla+ '02'+@comilla+' then Sum(' + @sPrecio + ') else 0 end) as Delivery, ' + 
              ' (case when mpedido.ttipopedido='+@comilla+ '03'+@comilla+' then Sum(' + @sPrecio + ') else 0 end) as Llevar, ' + 
  	      ' (case when mpedido.ttipopedido='+@comilla+ '04'+@comilla+' then Sum(' + @sPrecio + ') else 0 end) as Canal4, ' + 
      	      ' (case when mpedido.ttipopedido='+@comilla+ '05'+@comilla+' then Sum(' + @sPrecio + ') else 0 end) as Canal5, ' + 
     	      ' sum(' + @sPrecio + ') as Venta,  0, 0,  MPEDIDO.tTipoPedido, sum((dbo.DPEDIDO.nInsumo+dbo.DPEDIDO.nGasto+dbo.DPEDIDO.nManoObra)*dbo.dpedido.ncantidad ) as costo ' + 
     	      ' FROM dbo.DPEDIDO INNER JOIN  dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN   dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' + 
     	      ' Where mpedido.testadopedido<>'+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sFecha + 
     	      ' group by (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end), Mpedido.ttipopedido ' + 
     	      ' order by (case when DATEPART(hh,Mpedido.fregistro) >= ' +ltrim(str(@dHour)) + ' then day(Mpedido.fRegistro) else day(dateadd(day, -1, Mpedido.fRegistro))  end)' 

    EXECUTE sp_executesql @sql
                
    set @sql= 'update #DBTRANS set Cantidad= T1.nC1 + T1.nC2 + T1.nC3 + T1.nC4 + T1.nC5, Pax=T1.nAdulto   from mpedido, ' + 
           ' (select (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + ' then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end) as dia, ' + 
           ' (case when mpedido.ttipopedido='+@comilla+ '01'+@comilla+' then sum(nadulto) else 0 end) nAdulto, ' + 
           ' (case when mpedido.ttipopedido='+@comilla+ '01'+@comilla+' then count(mPedido.tCodigoPedido) else 0 end) nC1, ' + 
           ' (case when mpedido.ttipopedido='+@comilla+ '02'+@comilla+' then count(mPedido.tCodigoPedido) else 0 end) nC2, ' + 
           ' (case when mpedido.ttipopedido='+@comilla+ '03'+@comilla+' then count(mPedido.tCodigoPedido) else 0 end) nC3, ' + 
           ' (case when mpedido.ttipopedido='+@comilla+ '04'+@comilla+' then count(mPedido.tCodigoPedido) else 0 end) nC4, ' + 
           ' (case when mpedido.ttipopedido='+@comilla+ '05'+@comilla+' then count(mPedido.tCodigoPedido) else 0 end) nC5,   tTipoPedido   from mpedido ' + 
           ' Where mpedido.testadopedido<>'+@comilla+ '03'+@comilla+' and ' + @sFecha + 
           ' group by (case when DATEPART(hh,fregistro) >= ' +ltrim(str(@dHour)) + ' then day(fRegistro) else day(dateadd(day, -1, fRegistro))  end), Mpedido.ttipopedido) T1 ' + 
           ' WHERE #DBTRANS.Dia = T1.dia and  #DBTRANS.TipoPedido = T1.tTipoPedido' 
 EXECUTE sp_executesql @sql
if @tipo='1'
	begin
		set @sql= 'select Dia, sum(Venta),sum(costo) from #DBTRANS Group by Dia' 
		EXECUTE sp_executesql @sql    
	--print @sql
	end
if @tipo='2'
	begin 
		CREATE TABLE #DBTRANST (Dia int, venta float, costo float)
		INSERT INTO #DBTRANST
		select Dia, sum(isnull(Venta,0)),sum(isnull(costo,0)) from #DBTRANS Group by Dia 
		
		
		declare @DiaVa as float
	
		declare @DiaFalta as float
		
		declare @totalVenta as float
		declare @totalcosto as float
		declare @PendienteVenta as float
		declare @pendientecosto as float

		set @diava=isnull((select max(dia) from #dbtrans),0) 
		set @totalventa=isnull((select sum(isnull(venta,0)) from #dbtranst),0)
		set @totalcosto=isnull((select sum(isnull(costo,0)) from #dbtranst),0)
		
		
		set @diafalta=@diames-@diava
		--print @diafalta
		INSERT INTO #DBTRANST
		values (100,@totalventa,@totalcosto)
		
		INSERT INTO #DBTRANST
		values (200,@metaMensual,@metaMensual)
		
		if @metamensual<=0 
			begin
				INSERT INTO #DBTRANST
				values (300,0,0)	
			end
		if @metamensual>0
			begin
				INSERT INTO #DBTRANST
				values (300,round(@totalventa*100/@metamensual,2),round(@totalcosto*100/@metamensual,2))	
			end 
		
		
		if @diafalta<=0
		begin
				INSERT INTO #DBTRANST
				values (400,0,0)	
		end
		if @diafalta>0
		begin


		if @totalventa>=@metamensual
			begin
				set @pendienteventa=0
			end
		if @totalventa<@metamensual
			begin
				set @pendienteventa=round(((@metamensual-@totalventa)/@diafalta),2)
			end
		if @totalcosto>=@metamensual
			begin
				set @pendientecosto=0
			end
		if @totalcosto<@metamensual
			begin
				set @pendientecosto=round(((@metamensual-@totalcosto)/@diafalta),2)
				 
			end
--		print @pendienteventa
--		print @pendientecosto
--		
--		print  '-'
--		print @metamensual
--		print @totalcosto
--		print @diafalta
--		print round(((@metamensual -@totalcosto)/@diafalta),2)

		INSERT INTO #DBTRANST
				values (400,@pendienteventa,@pendientecosto)	

		end
		SELECT    substring('000',1,3-len(ltrim(str(dia))))+ltrim(str(dia)) as dia, venta,costo FROM #DBTRANST
	end


END



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


/****** Objeto:  StoredProcedure [dbo].[USP_KDS_GrabarPath]    Fecha de la secuencia de comandos: 08/05/2011 14:51:33 ******/
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
Create Proc [dbo].[USP_KDS_GrabarPath] 
@tOrderInfo as NVARCHAR(600),
@tOrderStatus as NVARCHAR(600),
@tBump as NVARCHAR(600)
AS
Update TPARAMETRO 
Set
	tOrderInfo = @tOrderInfo,
	tOrderStatus = @tOrderStatus,
	tBump = @tBump
GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
/****** Objeto:  StoredProcedure [dbo].[USP_KDS_ObtenerArea]    Fecha de la secuencia de comandos: 08/05/2011 14:51:34 ******/
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
CREATE Proc [dbo].[USP_KDS_ObtenerArea]
@Codigo as nvarchar(20)
AS
Select ISNULL(KDS,0) as 'KDS' 
from vArea 
Where Codigo = @Codigo
GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO

/****** Objeto:  StoredProcedure [dbo].[USP_KDS_ObtenerAreaImpresionKDS]    Fecha de la secuencia de comandos: 08/05/2011 14:51:34 ******/
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
CREATE Proc [dbo].[USP_KDS_ObtenerAreaImpresionKDS]  
@tCodigoProducto as nvarchar(7), 
@tItemCombo as nvarchar(3),
@tCodigoPedido as nvarchar(10),
@tItem as nvarchar(3)
AS  
if (@tItemCombo <> '')
BEGIN
	Set @tCodigoProducto = (Select tProductoCombo from CPedido Where tCodigoPedido = @tCodigoPedido And tItem = @tItem And tItemCombo  = @tItemCombo)
END

Select   
	tCodigoProducto,P.tArea  
from
	TPRODUCTOAREA AS P  
	LEFT JOIN vAREA AS A ON P.tArea = A.Codigo  
Where   
	tCodigoProducto = @tCodigoProducto  
	And KDS = 1
GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
/****** Objeto:  StoredProcedure [dbo].[USP_KDS_ObtenerCategoria]    Fecha de la secuencia de comandos: 08/05/2011 14:51:35 ******/
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
CREATE Proc [dbo].[USP_KDS_ObtenerCategoria]
@tCodigoGrupo Varchar(2),
@tCodigoSubGrupo Varchar(4)
as
Select  (Select tResumido from TGrupo Where tCodigoGrupo = @tCodigoGrupo) 
+ '-' + (Select tResumido from TSubGrupo Where tCodigoSubGrupo = @tCodigoSubGrupo) as 'Categoria'

GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
/****** Objeto:  StoredProcedure [dbo].[USP_KDS_ObtenerDetalleCombo]    Fecha de la secuencia de comandos: 08/05/2011 14:51:35 ******/
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
CREATE proc [dbo].[USP_KDS_ObtenerDetalleCombo]  
@tCodigoPedido as nvarchar(10),  
@tItem as nvarchar(3),
@lImprime as nvarchar(1) 
as  
if (@lImprime = '1') 
Begin
	Select 
		tItem, 
		tItemCombo	
	from 
		CPedido 
	Where 
		tCodigoPedido = @tCodigoPedido 
		And tItem = @tItem
		And lImprime = 1
End
Else
Begin
	Select 
		tItem, 
		tItemCombo	
	from 
		CPedido 
	Where 
		tCodigoPedido = @tCodigoPedido 
		And tItem = @tItem
End 
GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
/****** Objeto:  StoredProcedure [dbo].[USP_KDS_ObtenerDetallePedido]    Fecha de la secuencia de comandos: 08/05/2011 14:51:36 ******/
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO

CREATE Proc [dbo].[USP_KDS_ObtenerDetallePedido]    
@tCodigoPedido as varchar(10)      
AS      
select       
      D.tCodigoPedido,
      D.Producto 'Combo',
      ISNULL('('+P.tResumido+')',P2.tResumido) as 'Producto',
      D.tItem,
      C.tItemCombo,
      D.tCodigoProducto,
      D.tCodigoGrupo,
      D.tCodigoSubGrupo,
      D.nCantidad,
      D.tArea,
      D.lCombinacion
from       
      vPedidoDetalle D      
      left Join CPedido as C On D.tItem = C.tItem And D.tCodigoPedido = C.tCodigoPedido      
      left Join TProducto P On C.tProductoCombo = P.tCodigoProducto      
      Left Join TProducto P2 On P2.tCodigoProducto = D.tCodigoProducto
where       
      D.tEstadoItem ='N'       
      and D.tCodigoPedido = @tCodigoPedido    
      And (D.lImprime = '0' OR ISNULL(C.lImprime,'1') = '0')

GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
/****** Objeto:  StoredProcedure [dbo].[USP_KDS_ObtenerNombreMesaXCodigo]    Fecha de la secuencia de comandos: 08/05/2011 14:51:36 ******/
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
Create Proc [dbo].[USP_KDS_ObtenerNombreMesaXCodigo]
@tCodigoMesa as NVARCHAR(3)
AS
Select tDetallado,tResumido
from tMesa 
Where tCodigoMesa = @tCodigoMesa
GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
/****** Objeto:  StoredProcedure [dbo].[USP_KDS_ObtenerPath]    Fecha de la secuencia de comandos: 08/05/2011 14:51:36 ******/
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO

CREATE Proc [dbo].[USP_KDS_ObtenerPath] 
AS
Select 
	ISNULL(tOrderInfo,'') as tOrderInfo, 
	ISNULL(tOrderStatus,'') as tOrderStatus,
	ISNULL(tBump,'') as tBump
From 
	TPARAMETRO
GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
/****** Objeto:  StoredProcedure [dbo].[USP_KDS_ObtenerProductoArea]    Fecha de la secuencia de comandos: 08/05/2011 14:51:37 ******/
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
CREATE Proc [dbo].[USP_KDS_ObtenerProductoArea]
@tCodigoProducto as nvarchar(7),
@tArea as nvarchar(3)
AS
Select 
	Count(*) cantidad 
from 
	TPRODUCTOAREA AS Pa
	Left Join vArea A On Pa.tArea = A.Codigo
Where 
	Pa.tCodigoProducto = @tCodigoProducto
	--And Pa.tArea = '001'
	And ISNULL(A.KDS,0) > 0 
GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
/****** Objeto:  StoredProcedure [dbo].[USP_KDS_ObtenerProductoPedido]    Fecha de la secuencia de comandos: 08/05/2011 14:51:37 ******/
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
CREATE PROC [dbo].[USP_KDS_ObtenerProductoPedido]        
@tCodigoPedido AS NVARCHAR(10),        
@tItem AS NVARCHAR(3)    
AS  
SELECT  
	ISNULL(A.Codigo,'') AS 'Area',        
	PRO.tResumido ,D.tItem,A.KDS       
FROM         
	DPEDIDO AS D        
	LEFT JOIN TPRODUCTO AS PRO ON PRO.tCodigoProducto = D.tCodigoProducto        
	LEFT JOIN TPRODUCTOAREA AS P  ON D.tCodigoProducto = P.tCodigoProducto        
	LEFT JOIN vAREA AS A ON P.tArea = A.Codigo          
WHERE           
	D.tCodigoPedido = @tCodigoPedido 
	AND D.tItem = @tItem 
	AND (ISNULL(A.KDS,0) = 1 OR A.Codigo IS NULL)  
UNION  
SELECT  
	ISNULL(A.Codigo,'') AS 'Area',        
	PRO.tResumido ,C.tItem,A.KDS       
FROM         
	CPEDIDO AS C  
	LEFT JOIN TPRODUCTO AS PRO ON PRO.tCodigoProducto = C.tProductoCombo        
	LEFT JOIN TPRODUCTOAREA AS P  ON C.tProductoCombo = P.tCodigoProducto        
	LEFT JOIN vAREA AS A ON P.tArea = A.Codigo          
WHERE           
	C.tCodigoPedido = @tCodigoPedido  
	AND C.tItem = @tItem  
	AND ISNULL(A.KDS,0) = 1
GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
/****** Objeto:  StoredProcedure [dbo].[USP_KDS_ObtenerProductoPedidoDeCombo]    Fecha de la secuencia de comandos: 08/05/2011 14:51:37 ******/
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
CREATE PROC [dbo].[USP_KDS_ObtenerProductoPedidoDeCombo]
@tCodigoPedido AS NVARCHAR(10),          
@tItem AS NVARCHAR(3),
@xItem AS NVARCHAR(3)
AS
SELECT    
	ISNULL(A.Codigo,'') AS 'Area',          
	PROP.tResumido AS 'ProtResumido',PRO.tResumido ,C.tItem,A.KDS         
FROM
	CPEDIDO AS C    
	LEFT JOIN TPRODUCTO AS PRO ON PRO.tCodigoProducto = C.tProductoCombo
	LEFT JOIN TPRODUCTO AS PROP ON PROP.tCodigoProducto = C.tProducto
	LEFT JOIN TPRODUCTOAREA AS P  ON C.tProductoCombo = P.tCodigoProducto          
	LEFT JOIN vAREA AS A ON P.tArea = A.Codigo
WHERE             
	C.tCodigoPedido = @tCodigoPedido    
	AND C.tItem = @tItem
	AND C.tItemCombo = @xItem
	AND ISNULL(A.KDS,0) = 1
GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
/****** Objeto:  StoredProcedure [dbo].[USP_KDS_ObtenerProductoPedidoImpresos]    Fecha de la secuencia de comandos: 08/05/2011 14:51:38 ******/
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
CREATE Proc [dbo].[USP_KDS_ObtenerProductoPedidoImpresos]
@tCodigoPedido as nvarchar(10),    
@tItem as nvarchar(3)
as
Select  
	D.tCodigoPedido, D.tItem, D.tCodigoProducto
FROM     
	DPEDIDO AS D
WHERE       
	D.tCodigoPedido = @tCodigoPedido  
	And D.tItem = @tItem     
	And D.lImprime = 1
GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
/****** Objeto:  StoredProcedure [dbo].[USP_KDS_ObtenerPropiedadesProducto]    Fecha de la secuencia de comandos: 08/05/2011 14:51:38 ******/
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
CREATE Proc [dbo].[USP_KDS_ObtenerPropiedadesProducto]   
@tCodigoPedido as VARCHAR(10),    
@tItem as Varchar(3),  
@tItemCombo as Varchar(3) = NULL,    
@tProducto as Varchar(7)  
AS      
if (@tItemCombo = '')   
BEGIN  
	SELECT     
		PP.tCodigoPedido ,          
		PP.tCodigoPropiedad,       
		PP.tEnlace,         
		PP.tProducto,           
		isnull(P.tDetallado,'') as 'Propiedad',          
		isnull(O.tDetallado,'') as 'Operador',     
		isnull(P.tOperador,'') as tOperador          
	FROM     
		dbo.TPRODUCTOPROPIEDAD PP          
		left JOIN dbo.TPROPIEDAD P ON P.tCodigoPropiedad=PP.tCodigoPropiedad AND P.tProducto=PP.tProducto          
		left JOIN dbo.TOPERADOR O ON O.tOperador=P.tOperador          
	WHERE     
		PP.tCodigoPedido=@tCodigoPedido AND    
		PP.tItem=@tItem --AND    
		--PP.tProducto='0000230'  
	UNION
	SELECT 
		tCodigoPedido,
		'99999' as 'tCodigoPropiedad',
		'99999' as 'tEnlace',	
		tCodigoProducto,
		tObservacion as 'Propiedad',
		'!' as 'Operador',  
		'99999'as 'tOperador'
	FROM 
		dPedido 
	WHERE 
		tCodigoPedido = @tCodigoPedido And tItem = @tItem And tObservacion <> ''

END  
ELSE  
BEGIN  
	SELECT     
		PP.tCodigoPedido ,  
		PP.tCodigoPropiedad,  
		PP.tEnlace,  
		PP.tProducto,  
		isnull(P.tDetallado,'') as 'Propiedad',  
		isnull(O.tDetallado,'') as 'Operador',  
		isnull(P.tOperador,'') as tOperador          
	FROM     
		dbo.TCOMBOPROPIEDAD PP  
		left JOIN dbo.TPROPIEDAD P ON P.tCodigoPropiedad=PP.tCodigoPropiedad AND P.tProducto=PP.tProducto          
		left JOIN dbo.TOPERADOR O ON O.tOperador=P.tOperador          
	WHERE     
		PP.tCodigoPedido = @tCodigoPedido AND    
		PP.tItem = @tItem AND    
		PP.tItemCombo = @tItemCombo  
		--PP.tProducto = '0000230'  

	UNION
	SELECT 
		tCodigoPedido,
		'99999' as 'tCodigoPropiedad',
		'99999' as 'tEnlace',	
		tCodigoProducto,
		tObservacion as 'Propiedad',
		'!' as 'Operador',  
		'99999'as 'tOperador'
	FROM 
		dPedido 
	WHERE 
		tCodigoPedido = @tCodigoPedido And tItem = @tItem And tObservacion <> ''
END
GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
/****** Objeto:  StoredProcedure [dbo].[USP_KDS_ObtenerTipoPedido]    Fecha de la secuencia de comandos: 08/05/2011 14:51:39 ******/
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
Create Proc [dbo].[USP_KDS_ObtenerTipoPedido]
@tCodigo as nVarchar(2)
AS
	Select tDetallado
	from TTABLA 
	Where tTabla = 'TIPOPEDIDO' And tCodigo =  @tCodigo
GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO

GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON
GO

CREATE PROCEDURE [dbo].[spRep_PaloteoProduccionPorMes]
@flagProduccion as bit,
@flagVenta as bit,
@flagCortesia as bit,
@flagCuentaCte as bit,
@flagCombinacion as bit,
@flagCargo as bit,
@flagPedidosFacturados as bit,
@flagPedidosFacturadosCortesia as bit,
@flagPrecioCosto as bit , -- si selecciona precio costo
@tSalon as nvarchar (30),  
@tTipoProducto as nvarchar(30),
@tMozo as nvarchar(30),
@tTipoPedido as nvarchar(30),
@tArea as nvarchar(30),
@tCaja as nvarchar(30),
@tUsuario as nvarchar(30),
@tUnidadNegocio as nvarchar(30),
@tGrupo as nvarchar(30),
@tSubGrupo as nvarchar(30),
@tCodigoProducto as nvarchar(30),
@tCodigoCliente as nvarchar(30),
@sPrecio as nvarchar(300),
@sBoton2 as nvarchar(30),
@sBoton3 as nvarchar(30),
@sBoton4 as nvarchar(30),
@sBoton5 as nvarchar(30),
@finicio as smalldatetime,
@ffinal as smalldatetime,
@dHour as float,
@flagValorMuestra as bit

AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @sqlP nvarchar(4000)
declare @Actualizaciones nvarchar(1000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(3000)
declare @sCriteriox nvarchar(3000)
declare @xCriterio nvarchar(3000)
declare @sCostoPropiedad nvarchar(2000)
declare @sCombo nvarchar(2000)
declare @sCostoComboPropiedad nvarchar(2000)
declare @sFiltro nvarchar(1000)
set @sfiltro=''
set @comilla=''''
	
	CREATE TABLE #DBTRANS (tLocal nVarChar(3) collate Modern_Spanish_CI_AS, local nVarChar(30) collate Modern_Spanish_CI_AS, Salon nVarChar(30) collate Modern_Spanish_CI_AS, tMesa nVarChar(3) collate Modern_Spanish_CI_AS, TipoProducto nVarChar(100) collate Modern_Spanish_CI_AS, Grupo nVarChar(50) collate Modern_Spanish_CI_AS, SubGrupo nVarChar(50) collate Modern_Spanish_CI_AS, Producto nVarChar(3500) collate Modern_Spanish_CI_AS, Cantidad Float, Venta Float, Pedido nVarchar(10) collate Modern_Spanish_CI_AS, Documento nVarChar(20) collate Modern_Spanish_CI_AS, Fecha DateTime, tTipoPedido nVarchar(2) collate Modern_Spanish_CI_AS, Area nVarChar(30) collate Modern_Spanish_CI_AS, tCodigoProducto nVarChar(7) collate Modern_Spanish_CI_AS, tItem nVarChar(3) collate Modern_Spanish_CI_AS, tItemCombo nVarChar(3) collate Modern_Spanish_CI_AS, Venta2 float,tAgrupacion nVarChar(100) collate Modern_Spanish_CI_AS, TipoPedido VarChar(50) collate Modern_Spanish_CI_AS)


	set @scriterio=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @scriteriox=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @xCriterio=' MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + '  and MDOCUMENTO.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla


	if @tsalon <>''
		SET @sCriterio=@sCriterio + ' and MPEDIDO.tSalon like ' + @comilla+@tsalon+'%'+@comilla
	if @ttipoProducto<>''
		SET @sCriterio=@sCriterio + ' and tTipoProducto like  ' + @comilla+@tTipoProducto+'%'+@comilla
	if @tmozo<>''
		SET @sCriterio=@sCriterio + ' and tMozo like  ' + @comilla+@tMozo+'%'+@comilla
	if @ttipoPedido<>''
		SET @sCriterio=@sCriterio + ' and MPEDIDO.tTipoPedido like  ' + @comilla+@tTipoPedido+'%'+@comilla
		SET @sCriteriox=@sCriteriox + ' and MPEDIDO.tTipoPedido like  ' + @comilla+@tTipoPedido+'%'+@comilla
	if @tarea<> ''
		SET @sCriterio=@sCriterio + ' and Area like  ' + @comilla+@tArea+'%'+@comilla
	if @tcaja <>''
		SET @sCriterio=@sCriterio + ' and MPEDIDO.tCaja  like ' + @comilla+@tCaja+'%'+@comilla
	if @tusuario <>''
		SET @sCriterio=@sCriterio + ' and MPEDIDO.tUsuario  like ' + @comilla+@tUsuario+'%'+@comilla
	if @tUnidadNegocio<>''
		SET @sCriterio=@sCriterio + ' and DPEDIDO.tUnidadNegocio like ' + @comilla+@tUnidadNegocio+'%'+@comilla
	if @tgrupo <> ''
		SET @sCriterio=@sCriterio + ' and vProducto.Grupo like ' + @comilla+@tGrupo+'%'+@comilla
	if @tsubgrupo <> ''
		SET @sCriterio=@sCriterio + ' and subGrupo like ' + @comilla+@tSubGrupo+'%'+@comilla
	if @tcodigoproducto <> ''
		SET @sCriterio=@sCriterio + ' and DPEDIDO.tCodigoProducto like ' + @comilla+@tCodigoProducto+'%'+@comilla
	if @tcodigocliente <> ''
		set @sFiltro= ' and MDOCUMENTO.tCodigoCliente like ' + @comilla+@tCodigoCliente+'%'+@comilla
	--print @scriterio
	--print @sfiltro
if @flagProduccion=1 --produccion
	  BEGIN
				  set @sql=      'Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) '+
						        ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' aS Venta, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, (case when DATEPART(hh,Mpedido.ffecha) >= ' +ltrim(str(@dHour)) + ' then Mpedido.ffecha else Mpedido.ffecha-1 end), dbo.MPEDIDO.tTipoPedido , dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem '+
								' FROM dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ' +
                				' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and '+ @sCriterio + @sFiltro 

 
					EXECUTE  sp_executesql @sql
					--print @sql
	  --Actualiza Costos de las Propiedades
	  set @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
                       		 ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       		 ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                     		 ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') AND ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	  --Actualiza Costos de los Combos
	  set @sCombo = ' Update #DBTRANS set Venta = T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
          		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
               		' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
	                ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ' +
         	        ' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

	  --Actualiza Costos de los Combos de las Propiedades
	  set @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
                            ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' + 
                            ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                            ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @scriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ' +
                            ' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
	  END 
	
if @flagVenta=1 --venta
	  BEGIN
	
						set @sql=    	' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem )  ' +
               							' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' +@sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, (case when DATEPART(hh,Mpedido.ffecha) >= ' +ltrim(str(@dHour)) + ' then Mpedido.ffecha else Mpedido.ffecha-1 end), dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                						' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
                						' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado ='+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio + ' and ' + @xCriterio +  @sFiltro
						EXECUTE  sp_executesql @sql
			--print @sql
	
	  --  Actualiza Costos de las Propiedades
	  set  @sCostoPropiedad =   'Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' + 
                      		  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       		  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
	                          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox  + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
	  --  Actualiza Costos de los Combos
	  set @sCombo =   ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
               		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
	                ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
          	        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + ' and ' + @xCriterio +  @sFiltro + 
	                ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	  --Actualiza Costos de los Combos de las Propiedades
	  set @sCostoComboPropiedad = 	' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                            		' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                          	        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+' ) and '+ @sCriteriox  +                          		' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2  ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem ' 
	 END

if @flagCortesia=1 --cortesia
	 BEGIN
		  
		 		set @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
           							' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' +  @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, (case when DATEPART(hh,Mpedido.ffecha) >= ' +ltrim(str(@dHour)) + ' then Mpedido.ffecha else Mpedido.ffecha-1 end), dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
           							' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.tMesa.tCodigoMesa = dbo.MPEDIDO.tMesa ' + 
									' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and ' + @scriterio
		
				EXECUTE  sp_executesql @sql
		  
	      --Actualiza Costos de las Propiedades
		set  @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                        ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and ' + @sCriteriox  + 
                        ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

 	     --Actualiza Costos de los Combos
		set  @sCombo = ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN  dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and '+ @scriteriox + 
	       ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	     --Actualiza Costos de los Combos de las Propiedades
		set  @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+ ' and ' +  @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

	 END
if @flagCuentaCte=1 --cuenta corriente
     BEGIN
	
				set     @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
               										' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, (case when DATEPART(hh,Mpedido.ffecha) >= ' +ltrim(str(@dHour)) + ' then Mpedido.ffecha else Mpedido.ffecha-1 end), dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                									' FROM dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ' +
                									' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and '+ @scriterio + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ')'
				EXECUTE  sp_executesql @sql
			 
 	  
	 --Actualiza Costos de las Propiedades
	 set  @sCostoPropiedad =    ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
             			           ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
		                           ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ') ' + 
                        		   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
             
     --Actualiza Costos de los Combos
	 set  @sCombo = 		   ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               				   ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               				   ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
               				   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

     --Actualiza Costos de los Combos de las Propiedades
	 set  @sCostoComboPropiedad =    ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             			' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             			' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
                             			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
	 END

if @flagCombinacion=1 --combinacion
	 BEGIN
	
	 Set @sql= ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem, tItemCombo ) ' +
									  ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, ' + @sPrecio + '  AS Venta, dbo.CPEDIDO.tCodigoPedido AS Pedido, dbo.DPEDIDO.tDocumento AS Documento, (case when DATEPART(hh,Mpedido.ffecha) >= ' +ltrim(str(@dHour)) + ' then Mpedido.ffecha else Mpedido.ffecha-1 end), dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo ' +
        							  ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem ON dbo.vProducto.Codigo = dbo.CPEDIDO.tProductoCombo ON dbo.MPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido ' +
                					  ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and ' + @sCriterio
			EXECUTE  sp_executesql @sql
 
	 
	 --Actualiza Costos de las Propiedades
	      SET @sCostoPropiedad = 'select 1'

      	--Actualiza Costos de los Combos
	      SET @sCombo = 'SELECT 1'
      
	 --Actualiza Costos de los Combos de las Propiedades
          set @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             	 	  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja  ' +
                             	 	  ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem and T1.tItemCombo = T2.tItemCombo '                     
	 END

if @flagCargo=1 --cargo
	 BEGIN
			set @sql =      'Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
                      					'SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + '  AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, (case when DATEPART(hh,Mpedido.ffecha) >= ' +ltrim(str(@dHour)) + ' then Mpedido.ffecha else Mpedido.ffecha-1 end), dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                     	 				'FROM dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ' +
			         	 				'where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem= '+@comilla+'N'+@comilla+' and ' + @sCriterio
	   
			  EXECUTE  sp_executesql @sql
	
	      SET @sCostoPropiedad = 'select 1'

	      SET @sCostoComboPropiedad = 'SELECT 1'
	--Actualiza Costos  de los Combos
	      set @sCombo = ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
              ' FROM dbo.CPEDIDO INNER JOIN  dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
              ' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +
              ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'	
	 END
	
if @flagPedidosFacturados=1 --pedidos facturados  
	 BEGIN
	
					set @sql=       'Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' + 
                					'SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  '+ @sPrecio +'  AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, (case when DATEPART(hh,Mpedido.ffecha) >= ' +ltrim(str(@dHour)) + ' then Mpedido.ffecha else Mpedido.ffecha-1 end), dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' + 
                					'FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                					'WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio + @sFiltro
		
					EXECUTE  sp_executesql @sql
			
        --Actualiza Costos de las Propiedades
  		SET    @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
                            ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                            ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                            ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox +
                            ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

  		--Actualiza Costos de los Combos xx
 		SET     @sCombo = ' Update #DBTRANS set Venta= T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
            			  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
             			  ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
               			  ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox +  @sFiltro +
               			  ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
       /*T1.tCodigoProducto = T2.tCodigoProducto and*/
      		--Actualiza Costos de los Combos de las Propiedades
 		SET     @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             			' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             			' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' +  @sCriteriox +
                             			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
	 END
if @flagPedidosFacturadosCortesia=1 --pedidos facturados como cortesia
	 BEGIN
		set     @sql =  ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta, Pedido, Documento, Fecha, tTipoPedido, Area, tCodigoProducto, tItem ) ' +
                				' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, (case when DATEPART(hh,Mpedido.ffecha) >= ' +ltrim(str(@dHour)) + ' then Mpedido.ffecha else Mpedido.ffecha-1 end), dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Area, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
								' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                				' WHERE dbo.MDOCUMENTO.tCortesia <>'+@comilla+' '+@comilla+' and dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio +  @sFiltro
		EXECUTE  sp_executesql @sql
			
	  	--Actualiza Costos de las Propiedades
		set      @sCostoPropiedad = 	' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
                            	' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                        	' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                        	' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + 
                        	' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

      		--Actualiza Costos de los Combos xx
		set     @sCombo = 	' Update #DBTRANS  set Venta= T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
               			' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
               			' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
               			' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @scriteriox +  @sFiltro + 
               			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2  ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
      
      		--Actualiza Costos de los Combos de las Propiedades
		set     @sCostoComboPropiedad = 	' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
                             		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             		' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             		' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + 
                             		' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
	 END
/**/
if (@flagPrecioCosto=1) 
	begin
		IF LEN(@SCOSTOPROPIEDAD)>9 
				BEGIN 
	 				EXECUTE  sp_executesql @sCostoPropiedad
				END
		IF LEN(@SCOMBO)>9 
				BEGIN
					EXECUTE  sp_executesql @sCombo
				END
		IF LEN(@sCostoComboPropiedad)>9 
				BEGIN
					EXECUTE  sp_executesql @sCostoComboPropiedad	
				END
			--print @sCostoPropiedad
			--print @sCombo
			--print @sCostoComboPropiedad
	end


/**/
update #DBTRANS set tipopedido=vtipopedido.descripcion from #dbtrans inner join dbo.vtipopedido on dbo.#dbtrans.ttipopedido=dbo.vtipopedido.codigo
/**/
set @Actualizaciones = 'update #DBTRANS set Salon = '+@comilla+'Sin Salon'+@comilla+' where isnull(Salon,'+@comilla+'0'+@comilla+') = '+@comilla+'0'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+ @comilla+@sBoton2 +@comilla+ ' where tTipoPedido ='+@comilla+'02'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+ @comilla+@sBoton3 +@comilla+  ' where tTipoPedido ='+@comilla+'03'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+ @comilla+@sBoton4 +@comilla+ ' where tTipoPedido ='+@comilla+'04'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+ @comilla+@sBoton5 +@comilla+  ' where tTipoPedido ='+@comilla+'05'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Local = vLocal.Descripcion FROM #DBTRANS INNER JOIN dbo.vLocal ON dbo.#DBTRANS.tLocal = dbo.vLocal.Codigo '
EXEC sp_executesql @Actualizaciones
/**/
	declare @totalUnidadEnero as float
	select @totalUnidadEnero=isnull(sum(cantidad),0) from #dbtrans where month(fecha)=1
	declare @totalUnidadFebrero as float
	select @totalUnidadFebrero=isnull(sum(cantidad),0) from #dbtrans where month(fecha)=2
	declare @totalUnidadMarzo as float
	select @totalUnidadMarzo=isnull(sum(cantidad),0) from #dbtrans where month(fecha)=3
	declare @totalUnidadAbril as float
	select @totalUnidadAbril=isnull(sum(cantidad),0) from #dbtrans where month(fecha)=4
	declare @totalUnidadMayo as float
	select @totalUnidadMayo=isnull(sum(cantidad),0) from #dbtrans where month(fecha)=5
	declare @totalUnidadJunio as float
	select @totalUnidadJunio=isnull(sum(cantidad),0) from #dbtrans where month(fecha)=6
	declare @totalUnidadJulio as float
	select @totalUnidadJulio=isnull(sum(cantidad),0) from #dbtrans where month(fecha)=7
	declare @totalUnidadAgosto as float
	select @totalUnidadAgosto=isnull(sum(cantidad),0) from #dbtrans where month(fecha)=8
	declare @totalUnidadSetiembre as float
	select @totalUnidadSetiembre=isnull(sum(cantidad),0) from #dbtrans where month(fecha)=9
	declare @totalUnidadOctubre as float
	select @totalUnidadOctubre=isnull(sum(cantidad),0) from #dbtrans where month(fecha)=10
	declare @totalUnidadNoviembre as float
	select @totalUnidadNoviembre=isnull(sum(cantidad),0) from #dbtrans where month(fecha)=11
	declare @totalUnidadDiciembre as float
	select @totalUnidadDiciembre=isnull(sum(cantidad),0) from #dbtrans where month(fecha)=12

	/**/	
	declare @totalVentaEnero as float
	select @totalVentaEnero=isnull(sum(Venta),0) from #dbtrans where month(fecha)=1
	declare @totalVentaFebrero as float
	select @totalVentaFebrero=isnull(sum(Venta),0) from #dbtrans where month(fecha)=2
	declare @totalVentaMarzo as float
	select @totalVentaMarzo=isnull(sum(Venta),0) from #dbtrans where month(fecha)=3
	declare @totalVentaAbril as float
	select @totalVentaAbril=isnull(sum(Venta),0) from #dbtrans where month(fecha)=4
	declare @totalVentaMayo as float
	select @totalVentaMayo=isnull(sum(Venta),0) from #dbtrans where month(fecha)=5
	declare @totalVentaJunio as float
	select @totalVentaJunio=isnull(sum(Venta),0) from #dbtrans where month(fecha)=6
	declare @totalVentaJulio as float
	select @totalVentaJulio=isnull(sum(Venta),0) from #dbtrans where month(fecha)=7
	declare @totalVentaAgosto as float
	select @totalVentaAgosto=isnull(sum(Venta),0) from #dbtrans where month(fecha)=8
	declare @totalVentaSetiembre as float
	select @totalVentaSetiembre=isnull(sum(Venta),0) from #dbtrans where month(fecha)=9
	declare @totalVentaOctubre as float
	select @totalVentaOctubre=isnull(sum(Venta),0) from #dbtrans where month(fecha)=10
	declare @totalVentaNoviembre as float
	select @totalVentaNoviembre=isnull(sum(Venta),0) from #dbtrans where month(fecha)=11
	declare @totalVentaDiciembre as float
	select @totalVentaDiciembre=isnull(sum(Venta),0) from #dbtrans where month(fecha)=12

/**/	


	--select max(Local) as Local , max(Salon) as Salon, max(TipoProducto) as TipoProducto, Grupo, SubGrupo, Producto, sum(Cantidad) as Cantidad, sum(Venta) as Venta From #DBTRANS group by Grupo, SubGrupo, Producto
	
	--select * into xProductoMes from #DBTRANS
	update #dbtrans set tagrupacion=(select isnull(tagrupacion,'') from tsubgrupo inner join tproducto on tsubgrupo.tcodigoSubGrupo=tproducto.tsubgrupo
									where tproducto.tcodigoproducto=#dbtrans.tcodigoproducto)


	SELECT '1' as quiebre, GRUPO,SUBGRUPO,tcodigoproducto,PRODUCTO,tipoproducto,tagrupacion,MONTH(FECHA) mes,SUM(ISnull(CANTIDAD,0)) cantidad,sum(isnull(venta,0)) venta ,
	0 as Enero,0 as Febrero,0 as Marzo,0 as Abril,0 as Mayo,0 as Junio, 0 as Julio,0 AS Agosto, 0 as Setiembre,0 as Octubre,0 as Noviembre,0 as Diciembre
	FROM #DBTRANS WHERE TCODIGOPRODUCTO IS NOT NULL group by GRUPO,SUBGRUPO,tcodigoproducto,PRODUCTO,MONTH(FECHA),tipoproducto,tagrupacion
	
	union

	select '2' as quiebre,'%Unidades' as GRUPO,'' as SUBGRUPO,'' as tcodigoproducto, '' as PRODUCTO,tipoproducto,'' as tagrupacion, 1  mes, 0 cantidad,0 venta,
	(select isnull(sum(b.cantidad)*100 / @totalUnidadEnero,0) from #dbtrans b where month(b.fecha)='1' and b.tipoproducto=#dbtrans.tipoproducto) as Enero,
	(select isnull(sum(b.cantidad)*100 / @totalUnidadFebrero,0) from #dbtrans b where month(b.fecha)='2' and b.tipoproducto=#dbtrans.tipoproducto) as Febrero,
	(select isnull(sum(b.cantidad)*100 / @totalUnidadMarzo,0) from #dbtrans b where month(b.fecha)='3' and b.tipoproducto=#dbtrans.tipoproducto) as Marzo,
	(select isnull(sum(b.cantidad)*100 / @totalUnidadAbril,0) from #dbtrans b where month(b.fecha)='4' and b.tipoproducto=#dbtrans.tipoproducto) as Abril,
	(select isnull(sum(b.cantidad)*100 / @totalUnidadMayo,0) from #dbtrans b where month(b.fecha)='5' and b.tipoproducto=#dbtrans.tipoproducto) as Mayo,
	(select isnull(sum(b.cantidad)*100 / @totalUnidadJunio,0) from #dbtrans b where month(b.fecha)='6' and b.tipoproducto=#dbtrans.tipoproducto) as Junio,
	(select isnull(sum(b.cantidad)*100 / @totalUnidadJulio,0) from #dbtrans b where month(b.fecha)='7' and b.tipoproducto=#dbtrans.tipoproducto) as Julio,
	(select isnull(sum(b.cantidad)*100 / @totalUnidadAgosto,0) from #dbtrans b where month(b.fecha)='8' and b.tipoproducto=#dbtrans.tipoproducto) as Agosto,
	(select isnull(sum(b.cantidad)*100 / @totalUnidadSetiembre,0) from #dbtrans b where month(b.fecha)='9' and b.tipoproducto=#dbtrans.tipoproducto) as Setiembre,
	(select isnull(sum(b.cantidad)*100 / @totalUnidadOctubre,0) from #dbtrans b where month(b.fecha)='10' and b.tipoproducto=#dbtrans.tipoproducto) as Octubre,
	(select isnull(sum(b.cantidad)*100 / @totalUnidadNoviembre,0) from #dbtrans b where month(b.fecha)='11' and b.tipoproducto=#dbtrans.tipoproducto) as Noviembre,
	(select isnull(sum(b.cantidad)*100 / @totalUnidadDiciembre,0) from #dbtrans b where month(b.fecha)='12' and b.tipoproducto=#dbtrans.tipoproducto) as Diciembre

	FROM #DBTRANS WHERE TCODIGOPRODUCTO IS NOT NULL group by tipoproducto
	UNION 
	select '3' as quiebre,'%Soles' as GRUPO,'' as SUBGRUPO,'' as tcodigoproducto, '' as PRODUCTO,   tipoproducto,'' as tagrupacion, 1  mes, 0 cantidad,0 venta,
	(select isnull(sum(b.venta) * 100 / @totalVentaEnero,0) from #dbtrans b where month(b.fecha)='1' and b.tipoproducto=#dbtrans.tipoproducto) as Enero,
	(select isnull(sum(b.venta) * 100 / @totalVentaFebrero,0) from #dbtrans b where month(b.fecha)='2' and b.tipoproducto=#dbtrans.tipoproducto) as Febrero,
	(select isnull(sum(b.venta) * 100 / @totalVentaMarzo,0) from #dbtrans b where month(b.fecha)='3' and b.tipoproducto=#dbtrans.tipoproducto) as Marzo,
	(select isnull(sum(b.venta) * 100 / @totalVentaAbril,0) from #dbtrans b where month(b.fecha)='4' and b.tipoproducto=#dbtrans.tipoproducto) as Abril,
	(select isnull(sum(b.venta) * 100 / @totalVentaMayo,0) from #dbtrans b where month(b.fecha)='5' and b.tipoproducto=#dbtrans.tipoproducto) as Mayo,
	(select isnull(sum(b.venta) * 100 / @totalVentaJunio,0) from #dbtrans b where month(b.fecha)='6' and b.tipoproducto=#dbtrans.tipoproducto) as Junio,
	(select isnull(sum(b.venta) * 100 / @totalVentaJulio,0) from #dbtrans b where month(b.fecha)='7' and b.tipoproducto=#dbtrans.tipoproducto) as Julio,
	(select isnull(sum(b.venta) * 100 / @totalVentaAgosto,0) from #dbtrans b where month(b.fecha)='8' and b.tipoproducto=#dbtrans.tipoproducto) as Agosto,
	(select isnull(sum(b.venta) * 100 / @totalVentaSetiembre,0) from #dbtrans b where month(b.fecha)='9' and b.tipoproducto=#dbtrans.tipoproducto) as Setiembre,
	(select isnull(sum(b.venta) * 100 / @totalVentaOctubre,0) from #dbtrans b where month(b.fecha)='10' and b.tipoproducto=#dbtrans.tipoproducto) as Octubre,
	(select isnull(sum(b.venta) * 100 / @totalVentaNoviembre,0) from #dbtrans b where month(b.fecha)='11' and b.tipoproducto=#dbtrans.tipoproducto) as Noviembre,
	(select isnull(sum(b.venta) * 100 / @totalVentaDiciembre,0) from #dbtrans b where month(b.fecha)='12' and b.tipoproducto=#dbtrans.tipoproducto) as Diciembre
	FROM #DBTRANS WHERE TCODIGOPRODUCTO IS NOT NULL group by tipoproducto
	UNION 
	select '4' as quiebre,'%Soles' as GRUPO,'' as SUBGRUPO,'' as tcodigoproducto, '' as PRODUCTO,tipopedido as tipoproducto,'' as tagrupacion, 1  mes, 0 cantidad,0 venta,
	(select isnull(sum(b.venta) * 100 / @totalVentaEnero,0) from #dbtrans b where month(b.fecha)='1' and b.tipopedido=#dbtrans.tipopedido) as Enero,
	(select isnull(sum(b.venta) * 100 / @totalVentaFebrero,0) from #dbtrans b where month(b.fecha)='2' and b.tipopedido=#dbtrans.tipopedido) as Febrero,
	(select isnull(sum(b.venta) * 100 / @totalVentaMarzo,0) from #dbtrans b where month(b.fecha)='3' and b.tipopedido=#dbtrans.tipopedido) as Marzo,
	(select isnull(sum(b.venta) * 100 / @totalVentaAbril,0) from #dbtrans b where month(b.fecha)='4' and b.tipopedido=#dbtrans.tipopedido) as Abril,
	(select isnull(sum(b.venta) * 100 / @totalVentaMayo,0) from #dbtrans b where month(b.fecha)='5' and b.tipopedido=#dbtrans.tipopedido) as Mayo,
	(select isnull(sum(b.venta) * 100 / @totalVentaJunio,0) from #dbtrans b where month(b.fecha)='6' and b.tipopedido=#dbtrans.tipopedido) as Junio,
	(select isnull(sum(b.venta) * 100 / @totalVentaJulio,0) from #dbtrans b where month(b.fecha)='7' and b.tipopedido=#dbtrans.tipopedido) as Julio,
	(select isnull(sum(b.venta) * 100 / @totalVentaAgosto,0) from #dbtrans b where month(b.fecha)='8' and b.tipopedido=#dbtrans.tipopedido) as Agosto,
	(select isnull(sum(b.venta) * 100 / @totalVentaSetiembre,0) from #dbtrans b where month(b.fecha)='9' and b.tipopedido=#dbtrans.tipopedido) as Setiembre,
	(select isnull(sum(b.venta) * 100 / @totalVentaOctubre,0) from #dbtrans b where month(b.fecha)='10' and b.tipopedido=#dbtrans.tipopedido) as Octubre,
	(select isnull(sum(b.venta) * 100 / @totalVentaNoviembre,0) from #dbtrans b where month(b.fecha)='11' and b.tipopedido=#dbtrans.tipopedido) as Noviembre,
	(select isnull(sum(b.venta) * 100 / @totalVentaDiciembre,0) from #dbtrans b where month(b.fecha)='12' and b.tipopedido=#dbtrans.tipopedido) as Diciembre
	FROM #DBTRANS WHERE TCODIGOPRODUCTO IS NOT NULL group by tipopedido
	ORDER BY 1, tipoproducto

END
 


 
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON
GO

CREATE PROCEDURE [dbo].[sp_CopiaArchivosRemotos]
@ServerRemoto     NVARCHAR(50),
@BddInforest      NVARCHAR(100)

AS

BEGIN
      DECLARE @Isql     NVARCHAR(4000)

      --INICIALIZA LAS TABLAS
      DELETE FROM TPARAMETRO
      DELETE FROM TTABLA
      DELETE FROM TGRUPO
      DELETE FROM TSUBGRUPO
      DELETE FROM TPRODUCTO
      DELETE FROM TPROPIEDAD
      DELETE FROM TOPERADOR

      --TABLA PARAMETROS
      SET @Isql = 'INSERT INTO TPARAMETRO SELECT * FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source=' + @ServerRemoto + ';User ID=infhotel;Password=4gust1n-fl0r14n'').' + @BddInforest + '.dbo.TPRODUCTO'
      EXECUTE sp_executesql @Isql

      --TABLA TTABLA
      SET @Isql = 'INSERT INTO TTABLA SELECT * FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source=' + @ServerRemoto + ';User ID=infhotel;Password=4gust1n-fl0r14n'').' + @BddInforest + '.dbo.TTABLA'
      EXECUTE sp_executesql @Isql

      --TABLA TGRUPO
      SET @Isql = 'INSERT INTO TGRUPO SELECT * FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source=' + @ServerRemoto + ';User ID=infhotel;Password=4gust1n-fl0r14n'').' + @BddInforest + '.dbo.TGRUPO'
      EXECUTE sp_executesql @Isql

      --TABLA TSUBGRUPO
      SET @Isql = 'INSERT INTO TSUBGRUPO SELECT * FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source=' + @ServerRemoto + ';User ID=infhotel;Password=4gust1n-fl0r14n'').' + @BddInforest + '.dbo.TSUBGRUPO'
      EXECUTE sp_executesql @Isql

      --TABLA TPRODUCTO
      SET @Isql = 'INSERT INTO TPRODUCTO SELECT * FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source=' + @ServerRemoto + ';User ID=infhotel;Password=4gust1n-fl0r14n'').' + @BddInforest + '.dbo.TPRODUCTO'
      EXECUTE sp_executesql @Isql

      --TABLA TPROPIEDAD
      SET @Isql = 'INSERT INTO TPROPIEDAD SELECT * FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source=' + @ServerRemoto + ';User ID=infhotel;Password=4gust1n-fl0r14n'').' + @BddInforest + '.dbo.TPROPIEDAD'
      EXECUTE sp_executesql @Isql

      --TABLA TOPERADOR
      SET @Isql = 'INSERT INTO TOPERADOR SELECT * FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source=' + @ServerRemoto + ';User ID=infhotel;Password=4gust1n-fl0r14n'').' + @BddInforest + '.dbo.TOPERADOR'
      EXECUTE sp_executesql @Isql
END

 


 
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON
GO

CREATE Proc [dbo].[USP_KDS_GrabarTiempoSalidaDPedido]
@tCodigoPedido as NVARCHAR(10),
@tItem AS NVARCHAR(3),
@fSalida AS DATETIME
AS
declare @count int
set @count=(select count(tCodigoPedido) from DPedidoKds where tCodigoPedido = SUBSTRING(CAST(Year(@fSalida) AS NVARCHAR),3,2)+ RIGHT('00000000'+@tCodigoPedido,8) And tItem = RIGHT('000'+@tItem,3)) 
if(@count=0)    
begin	
	Insert Into DPedidoKds 
	Values(	
		SUBSTRING(CAST(Year(@fSalida) AS NVARCHAR),3,2)+ RIGHT('00000000'+@tCodigoPedido,8),
		RIGHT('000'+@tItem,3),
		@fSalida)
end
else
begin
	Update DPedidoKds
	Set fSalida = @fSalida
	Where tCodigoPedido = SUBSTRING(CAST(Year(@fSalida) AS NVARCHAR),3,2)+ RIGHT('00000000'+@tCodigoPedido,8) And tItem = RIGHT('000'+@tItem,3)
end
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON
GO

CREATE PROCEDURE [dbo].[spRep_TiempoDeliveryIntegrado] 
@finicio as smalldatetime,
@ffinal as smalldatetime,
@R1 as float, 
@R2 as float
AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(3000)
set @comilla=''''

                set @scriterio=' and  MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla

				CREATE TABLE #DBTRANS (Pedido nVarChar(15) collate Modern_Spanish_CI_AS, 
				fregistroCd datetime ,
				fregistro nvarchar(30) ,
				nRecepcion int,
				fSalida nvarchar(30) ,
				fEntrega nvarchar(30) ,
				nEnvio int,
				fPago nvarchar(30) ,
				nTotal int,
				Zona nVarChar(250) collate Modern_Spanish_CI_AS, 
				Referencia nVarChar(250) collate Modern_Spanish_CI_AS, 
				Ttelefono nVarChar(50) collate Modern_Spanish_CI_AS,
				Motorizado nVarChar(150) collate Modern_Spanish_CI_AS, 
				Cliente nvarchar(200) collate Modern_Spanish_CI_AS)

				create table #dbtrans1
				(
				pedido nvarchar(20) collate Modern_Spanish_CI_AS,
				ntotal int
				)


				create table #dbtransT 
				(
				pedido nvarchar(20)  collate Modern_Spanish_CI_AS,
				ntotal int,
				tA int,
				tb	int,
				tc	int
				)


				set @sql= ' insert into #dbtrans '  + 
				' SELECT dbo.MPEDIDO.tCodigoPedido AS pedido,  convert(datetime,isnull(dbo.MPEDIDO.fRegistroCD,mpedido.fregistro),120)  as fRegistroCD, convert(nvarchar,dbo.MPEDIDO.fRegistro,120)  AS fRegistro, ISNULL(DATEDIFF(minute, dbo.MPEDIDO.fRegistroCD, dbo.MPEDIDO.fRegistro), 0) AS nRecepcion,  convert(nvarchar, (SELECT MAX(DISTINCT dbo.MDOCUMENTO.fRegistro) FROM  dbo.DPAGODOCUMENTO INNER JOIN dbo.DPEDIDO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento INNER JOIN dbo.MDOCUMENTO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.MDOCUMENTO.tDocumento WHERE     (dbo.DPEDIDO.tCodigoPedido =  dbo.MPEDIDO.tCodigoPedido) GROUP BY dbo.MDOCUMENTO.fRegistro) ,120) as fSalida, convert(nvarchar,dbo.MPEDIDO.fEntregaClienteCD,120) AS fEntrega, 0 AS nEnvio, ' +
				'             CONVERT(nvarchar,(SELECT     MAX(DISTINCT dbo.DPAGODOCUMENTO.fRegistro)   FROM dbo.DPAGODOCUMENTO INNER JOIN dbo.DPEDIDO ON dbo.DPAGODOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento WHERE      (dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido)),120) AS fPago, 0 AS Total, dbo.vZona.Descripcion AS Zona,  dbo.TDELIVERY.tDireccion AS Referencia, dbo.TDELIVERY.tTelefono, dbo.vMotorizado.Descripcion AS Motorizado, dbo.TDELIVERY.tApellido + '+@comilla+ ', '+@comilla+' + isnull(dbo.TDELIVERY.tNombre, '+@comilla+'Nombre'+@comilla+') AS Cliente    ' +
				'             FROM dbo.MPEDIDO INNER JOIN dbo.TDELIVERY ON dbo.MPEDIDO.tClienteDelivery = dbo.TDELIVERY.tCodigoDelivery LEFT OUTER JOIN dbo.vMotorizado ON dbo.MPEDIDO.tMotorizado = dbo.vMotorizado.Codigo  LEFT OUTER JOIN dbo.vZona ON dbo.TDELIVERY.tZona = dbo.vZona.Codigo   ' +
				' where mpedido.testadopedido<>'+@comilla+ '03'+@comilla+' and mpedido.tTipoPedido='+@comilla+ '02'+@comilla +@sCriterio +
				' order by mpedido.tcodigopedido '
                           
               --print @sql

               EXEC sp_executesql @sql

			   insert into #dbtrans1
			   select pedido ,  ISNULL(DATEDIFF(minute, convert(datetime,fregistrocd,120), convert(datetime,fEntrega,120)), 0) AS nTotal
			   from #dbtrans
			   order by pedido

			   insert into #dbtransT
				select pedido,ntotal, case when ntotal  < @r1 then 1 else 0 end 
				, case when ntotal >=@r1 and ntotal <=@r2 then 1 else 0 end, case when ntotal> @r2 then 1 else 0 end 
				from #dbtrans1		


				select count( pedido) pedidos,sum(ntotal) total,  
				round(cast(sum(ntotal) as float)/count(pedido),2) promedio , min(ntotal) minimo,
				max(ntotal) maximo, sum(ta) ta, sum(tb) tb,sum(tc) tc
				from #dbtransT
				having count(pedido)>0
 END
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create PROCEDURE [dbo].[sp_ComparativoConsumo]
@BDALMACEN as nvarchar(25) ,
@finicio as datetime,
@ffinal as datetime,
@vch_SubArea as nvarchar(3),
@vch_Condicion as nvarchar(3000)
	
as 
BEGIN

set nocount on

--set @BDALMACEN = 'ALMACENPRESTO'
Declare @SQL as nvarchar(4000)
--DROP table #DBARTI1 
CREATE TABLE #DBARTI1 (
			tcodigofamilia nVarChar(2) collate Modern_Spanish_CI_AS, 
			familia nVarChar(150) collate Modern_Spanish_CI_AS, 
			tcodigosubfamilia nVarChar(4) collate Modern_Spanish_CI_AS, 
			subfamilia nVarChar(150) collate Modern_Spanish_CI_AS, 
			tcodigoproducto nVarChar(7) collate Modern_Spanish_CI_AS, 
			tdetallado nVarChar(150) collate Modern_Spanish_CI_AS, 
			tunidadsalida nVarChar(3) collate Modern_Spanish_CI_AS, 
			unidadsalida nVarChar(150) collate Modern_Spanish_CI_AS,
			ConsumoRealCant	Float, 
			ConsumoRealValor	Float, 
			ConsumoPrevisto	Float,
			ConsumoPrevistoValor Float,
			nFactor nVarChar(150) collate Modern_Spanish_CI_AS, 
			)

CREATE TABLE #DBCONSREAL (
			tcodigoproducto nVarChar(7) collate Modern_Spanish_CI_AS, 
			Venta	Float,
			Valor	Float
			)

--DROP table #DBTRANS1 
CREATE TABLE #DBTRANS1 (
			tTipoProducto nVarChar(1) collate Modern_Spanish_CI_AS, 
			Familia nVarChar(150) collate Modern_Spanish_CI_AS, 
			SubFamilia nVarChar(150) collate Modern_Spanish_CI_AS, 
			Insumo nVarChar(180) collate Modern_Spanish_CI_AS, 
			UnidadSalida nVarChar(150) collate Modern_Spanish_CI_AS, 
			nConsumo float, 
			nPrecio float, 
			tItem nVarChar(3) collate Modern_Spanish_CI_AS, 
			tInsumo nVarChar(7) collate Modern_Spanish_CI_AS,
			grupo int
			)

if @vch_SubArea=''
	begin
		if @vch_Condicion<>''
			begin
				
				set @SQL='Insert into #DBARTI1 (tcodigofamilia, familia, tcodigosubfamilia, subfamilia, tcodigoproducto, tdetallado, tunidadsalida, unidadsalida,nFactor) '
				set @SQL=@SQL + 'select tcodigofamilia, familia, tcodigosubfamilia, subfamilia, tcodigoproducto, tdetallado, tunidadsalida, unidadsalida,nFactor '
				set @SQL=@SQL + 'from ' + @BDALMACEN + '.dbo.vProducto '
				set @SQL=@SQL + 'where ' + rtrim(ltrim(@vch_Condicion))
				print '3'+@Sql
				exec sp_executesql @Sql

			end
		else
			begin
				
				set @SQL='Insert into #DBARTI1 (tcodigofamilia, familia, tcodigosubfamilia, subfamilia, tcodigoproducto, tdetallado, tunidadsalida, unidadsalida,nFactor ) '
				set @SQL=@SQL + 'select tcodigofamilia, familia, tcodigosubfamilia, subfamilia, tcodigoproducto, tdetallado, tunidadsalida, unidadsalida,nFactor  '
				set @SQL=@SQL+'from ' + @BDALMACEN + '.dbo.vproducto '
				print '2'+@Sql
				exec sp_executesql @Sql

			end

		set @SQL='Insert into #DBCONSREAL '
		set @SQL=@SQL + 'select tcodigoproducto, round(nsalida,5) as Venta , round(nvalor/nsalida,5) as Valor '
		set @SQL=@SQL + 'from ' + @BDALMACEN + '.dbo.msubkardex  '
		set @SQL=@SQL + 'where ttipodocumento=''95'' and fregistro between convert(datetime,'''+ convert(varchar,@finicio) +''') and convert(datetime,'''+ convert(varchar,@ffinal) +''') '
		set @SQL=@SQL + 'order by tcodigoproducto '
				print '3'+@Sql
				exec sp_executesql @Sql
				print 'paso 3'
	end
else
	begin
		if @vch_Condicion<>''
			begin
				set @SQL='Insert into #DBARTI1 (tcodigofamilia, familia, tcodigosubfamilia, subfamilia, tcodigoproducto, tdetallado, tunidadsalida, unidadsalida,nFactor ) '
				set @SQL=@SQL + 'SELECT ' + @BDALMACEN + '.dbo.vProducto.tCodigoFamilia, ' + @BDALMACEN + '.dbo.vProducto.Familia, ' + @BDALMACEN + '.dbo.vProducto.tCodigoSubFamilia, ' + @BDALMACEN + '.dbo.vProducto.SubFamilia, '
				set @SQL=@SQL + '' + @BDALMACEN + '.dbo.vProducto.tCodigoProducto, ' + @BDALMACEN + '.dbo.vProducto.tDetallado, ' + @BDALMACEN + '.dbo.vProducto.tUnidadSalida, ' + @BDALMACEN + '.dbo.vProducto.UnidadSalida, ' + @BDALMACEN + '.dbo.vProducto.nFactor '
				set @SQL=@SQL + 'FROM ' + @BDALMACEN + '.dbo.TSUBSTOCK INNER JOIN '
				set @SQL=@SQL + '' + @BDALMACEN + '.dbo.vProducto ON ' + @BDALMACEN + '.dbo.TSUBSTOCK.tCodigoProducto = ' + @BDALMACEN + '.dbo.vProducto.tCodigoProducto '
				set @SQL=@SQL + 'WHERE (' + @BDALMACEN + '.dbo.TSUBSTOCK.tCodigoSubArea = ''' + @vch_SubArea + ''') and ' + rtrim(ltrim(@vch_Condicion)) + ''
				set @SQL=@SQL + 'ORDER BY ' + @BDALMACEN + '.dbo.vProducto.tCodigoProducto ' 

				print '4'+@Sql
				exec sp_executesql @Sql
			end
		else
			begin
				set @SQL='Insert into #DBARTI1 (tcodigofamilia, familia, tcodigosubfamilia, subfamilia, tcodigoproducto, tdetallado, tunidadsalida, unidadsalida,nFactor ) '
				set @SQL=@SQL + 'SELECT ' + @BDALMACEN + '.dbo.vProducto.tCodigoFamilia, ' + @BDALMACEN + '.dbo.vProducto.Familia, ' + @BDALMACEN + '.dbo.vProducto.tCodigoSubFamilia, ' + @BDALMACEN + '.dbo.vProducto.SubFamilia, '
				set @SQL=@SQL + '' + @BDALMACEN + '.dbo.vProducto.tCodigoProducto, ' + @BDALMACEN + '.dbo.vProducto.tDetallado, ' + @BDALMACEN + '.dbo.vProducto.tUnidadSalida, ' + @BDALMACEN + '.dbo.vProducto.UnidadSalida, ' + @BDALMACEN + '.dbo.vProducto.nFactor  '
				set @SQL=@SQL + 'FROM ' + @BDALMACEN + '.dbo.TSUBSTOCK INNER JOIN '
				set @SQL=@SQL + '' + @BDALMACEN + '.dbo.vProducto ON ' + @BDALMACEN + '.dbo.TSUBSTOCK.tCodigoProducto = ' + @BDALMACEN + '.dbo.vProducto.tCodigoProducto '
				set @SQL=@SQL + 'WHERE (' + @BDALMACEN + '.dbo.TSUBSTOCK.tCodigoSubArea = ''' + @vch_SubArea + ''') '
				set @SQL=@SQL + 'ORDER BY ' + @BDALMACEN + '.dbo.vProducto.tCodigoProducto ' 

				print '5'+@Sql
				exec sp_executesql @Sql
			end
	
--		set @SQL='Insert into #DBCONSREAL '
--		set @SQL=@SQL + 'select tcodigoproducto,sum(round(nsalida,4)) as Venta '
--		set @SQL=@SQL + 'from ' + @BDALMACEN + '.dbo.msubkardex  '
--		set @SQL=@SQL + 'where ttipodocumento=''95'' and fregistro between convert(datetime,'''+ convert(varchar,@finicio) +''') and convert(datetime,'''+ convert(varchar,@ffinal) +''') AND tcodigosubarea.Area = ''' + @vch_SubArea + ''' '
--		set @SQL=@SQL + 'group by tcodigoproducto '
--		set @SQL=@SQL + 'order by tcodigoproducto'

		set @SQL='Insert into #DBCONSREAL '
		set @SQL=@SQL + 'select tcodigoproducto,round(nsalida,5) as Venta , round(nvalor/nsalida,5) as Valor '
		set @SQL=@SQL + 'from ' + @BDALMACEN + '.dbo.msubkardex  '
		set @SQL=@SQL + 'where ttipodocumento=''95'' and fregistro between convert(datetime,'''+ convert(varchar,@finicio) +''') and convert(datetime,'''+ convert(varchar,@ffinal) +''') AND tcodigosubarea = ''' + @vch_SubArea + ''' '
		set @SQL=@SQL + 'order by tcodigoproducto '

		print '6'+@Sql
		exec sp_executesql @Sql

	end

--select * from #DBARTI1
DECLARE @Contador INT
	--Inserta Platos
SET @Contador = 1
WHILE (@Contador <=5)
BEGIN
	set @SQL='Insert into #DBTRANS1 '
	set @SQL=@SQL + 'SELECT ''P'' AS tTipoProducto,'
	set @SQL=@SQL + 'VINSUMO.Familia, '
	set @SQL=@SQL + 'VINSUMO.SubFamilia, '
	set @SQL=@SQL + 'VINSUMO.tDetallado as Insumo, '
	set @SQL=@SQL + 'VINSUMO.UnidadSalida, '
	set @SQL=@SQL + 'round(DRV.nCantidad*dbo.DPEDIDO.nCantidad / vInsumo.nFactor,5) AS nConsumo, '
	set @SQL=@SQL + 'round(DRV.nPrecio* vInsumo.nFactor,5), '
	set @SQL=@SQL + 'DPEDIDO.tItem,'
	set @SQL=@SQL + 'vInsumo.tCodigoProducto as tinsumo,1 as grupo  '
	set @SQL=@SQL + 'FROM dbo.MPEDIDO INNER JOIN dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto INNER JOIN ' + @BDALMACEN + '.dbo.MRECETAVENTA MRV INNER JOIN ' + @BDALMACEN + '.dbo.DRECETAVENTA DRV ON MRV.tRecetaVenta = DRV.tRecetaVenta AND MRV.tLocal = DRV.tLocal INNER JOIN ' + @BDALMACEN + '.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.DPEDIDO.tCodigoProducto = MRV.tCodigoPlato ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido '
	set @SQL=@SQL + 'WHERE  dbo.MPEDIDO.tEstadoPedido <> ''03'' AND (dbo.DPEDIDO.tEstadoItem =''N'') AND (dbo.MPEDIDO.tTipoPedido =''0'+ rtrim(ltrim(@Contador)) +''') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo =''R'') AND DRV.lCanal' + rtrim(ltrim(@Contador)) + '=1  and MPEDIDO.fRegistro >= convert(datetime,'''+ convert(varchar,@finicio) +''') And MPEDIDO.fRegistro <= convert(datetime,'''+ convert(varchar,@ffinal) +''')'


 
	print '7'+@Sql
	exec sp_executesql @SQL

SET @Contador = @Contador + 1
END

	set @SQL='Insert into #DBTRANS1 '
	set @SQL=@SQL + 'SELECT ''P'' AS tTipoProducto, vInsumo.Familia, '
	set @SQL=@SQL + 'vInsumo.SubFamilia, '
	set @SQL=@SQL + 'vInsumo.tDetallado as Insumo, '
	set @SQL=@SQL + 'vInsumo.UnidadSalida, '
	set @SQL=@SQL + 'round(vInsumo.nFactor*dbo.DPEDIDO.nCantidad,5) as nConsumo, '
	set @SQL=@SQL + 'round(vInsumo.nPrecioPromedio / vInsumo.nFactor,5) as nPrecio, '
	set @SQL=@SQL + ''''' as tItem, '
	set @SQL=@SQL + 'dbo.vProducto.tEnlace AS tinsumo, 2 as grupo '
	set @SQL=@SQL + 'FROM dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto INNER JOIN ' + @BDALMACEN + '.dbo.vProducto vInsumo ON dbo.vProducto.tEnlace = vInsumo.tCodigoProducto INNER JOIN  dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido '
	set @SQL=@SQL + 'WHERE (dbo.MPEDIDO.tEstadoPedido <> ''03'') AND (dbo.DPEDIDO.tEstadoItem = ''N'') AND (dbo.vProducto.lCombinacion = 0) and MPEDIDO.fRegistro >= convert(datetime,'''+ convert(varchar,@finicio) +''') And MPEDIDO.fRegistro <= convert(datetime,'''+ convert(varchar,@ffinal) +''')'
 
	print '8'+@Sql
    EXECUTE  sp_executesql @sql

		--Inserta Platos Combos
SET @Contador = 1
WHILE (@Contador <=5)
BEGIN
	set @SQL='Insert into #DBTRANS1 '
	set @SQL=@SQL + 'SELECT ''C'' AS tTipoProducto, vInsumo.Familia, '
	set @SQL=@SQL + 'vInsumo.SubFamilia, '
	set @SQL=@SQL + 'vInsumo.tDetallado as Insumo, '
	set @SQL=@SQL + 'vInsumo.UnidadSalida, '
	set @SQL=@SQL + 'round(DRV.nCantidad*dbo.DPEDIDO.nCantidad / vInsumo.nFactor,5) AS nConsumo, '
	set @SQL=@SQL + 'round(DRV.nPrecio* vInsumo.nFactor,5), '
	set @SQL=@SQL + 'dbo.CPEDIDO.tItem, '
	set @SQL=@SQL + 'vInsumo.tCodigoProducto AS tinsumo , 3 as grupo '
	set @SQL=@SQL + 'FROM  '+ @BDALMACEN +'.dbo.MRECETAVENTA MRV INNER JOIN   '+ @BDALMACEN +'.dbo.DRECETAVENTA DRV ON MRV.tLocal = DRV.tLocal AND MRV.tRecetaVenta = DRV.tRecetaVenta INNER JOIN   '+ @BDALMACEN +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN    dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN  dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON MRV.tRecetaVenta = dbo.vProducto.tEnlace INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido '
	set @SQL=@SQL + 'WHERE dbo.MPEDIDO.tEstadoPedido <> ''03'' AND (dbo.DPEDIDO.tEstadoItem = ''N'') AND (dbo.MPEDIDO.tTipoPedido = ''0'+ rtrim(ltrim(@Contador)) +''') AND (dbo.vProducto.lCombinacion = 0) AND (dbo.vProducto.tDescargo = ''R'') AND (DRV.lCanal'+ rtrim(ltrim(@Contador)) +' = 1)  and MPEDIDO.fRegistro >= convert(datetime,'''+ convert(varchar,@finicio) +''') And MPEDIDO.fRegistro <= convert(datetime,'''+ convert(varchar,@ffinal) +''')'
 
	print '9'+@Sql
	exec sp_executesql @SQL

SET @Contador = @Contador + 1
END

	set @SQL='Insert into #DBTRANS1 '
	set @SQL=@SQL + 'SELECT ''C'' AS tTipoProducto, vInsumo.Familia, '
	set @SQL=@SQL + 'vInsumo.SubFamilia, '
	set @SQL=@SQL + 'vInsumo.tDetallado as Insumo, '
	set @SQL=@SQL + 'vInsumo.UnidadSalida, '
	set @SQL=@SQL + 'round(vInsumo.nFactor*dbo.DPEDIDO.nCantidad,5) as nConsumo, '
	set @SQL=@SQL + 'round(vInsumo.nPrecioPromedio / vInsumo.nFactor,5) as nPrecio, '
	set @SQL=@SQL + ''''' as tItem, '
	set @SQL=@SQL + 'dbo.vProducto.tEnlace AS  tinsumo , 4 as grupo '
	set @SQL=@SQL + 'FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.vProducto INNER JOIN '+ @BDALMACEN +'.dbo.vProducto vInsumo ON dbo.vProducto.tEnlace = vInsumo.tCodigoProducto ON  dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido '
	set @SQL=@SQL + 'WHERE (dbo.MPEDIDO.tEstadoPedido <> ''03'') AND (dbo.DPEDIDO.tEstadoItem = ''N'') AND (dbo.vProducto.lCombinacion = 0)  and MPEDIDO.fRegistro >= convert(datetime,'''+ convert(varchar,@finicio) +''') And MPEDIDO.fRegistro <= convert(datetime,'''+ convert(varchar,@ffinal) +''')'
 
	print '10'+@Sql
    EXECUTE  sp_executesql @sql

--'Inserta Platos Propiedades
	set @SQL='Insert into #DBTRANS1 '
	set @SQL=@SQL + 'SELECT ''X'' AS tTipoProducto, vInsumo.Familia, '
	set @SQL=@SQL + 'vInsumo.SubFamilia, '
	set @SQL=@SQL + 'vInsumo.tDetallado as Insumo, '
	set @SQL=@SQL + 'vInsumo.UnidadSalida, '
	set @SQL=@SQL + 'round(DRV.nCantidad*dbo.DPEDIDO.nCantidad / vInsumo.nFactor,5) AS nConsumo, '
	set @SQL=@SQL + 'round(DRV.nPrecio* vInsumo.nFactor,5), '
	set @SQL=@SQL + ''''' as tItem, '
	set @SQL=@SQL + 'dbo.vProducto.tEnlace AS  tinsumo, 5 as grupo '
	set @SQL=@SQL + 'FROM dbo.vProducto INNER JOIN dbo.DPEDIDO ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem inner JOIN '+ @BDALMACEN +'.dbo.MRECETAPROPIEDAD MRV INNER JOIN '+ @BDALMACEN +'.dbo.DRECETAPROPIEDAD DRV ON MRV.tLocal = DRV.tLocal AND MRV.tRecetaPropiedad = DRV.tRecetaPropiedad INNER JOIN '+ @BDALMACEN +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto ON dbo.TPRODUCTOPROPIEDAD.tCodigoPropiedad = MRV.tCodigoPropiedad inner JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido '
	set @SQL=@SQL + 'WHERE (dbo.MPEDIDO.tEstadoPedido <> ''03'') AND (dbo.DPEDIDO.tEstadoItem = ''N'') AND  (dbo.vProducto.lCombinacion = 0) and MPEDIDO.fRegistro >= convert(datetime,'''+ convert(varchar,@finicio) +''') And MPEDIDO.fRegistro <= convert(datetime,'''+ convert(varchar,@ffinal) +''')'
	print '11'+@Sql
	EXECUTE  sp_executesql @sql

--Inserta Productos directos de las Propiedades
	set @SQL='Insert into #DBTRANS1 '
	set @SQL=@SQL + 'SELECT ''X'' AS tTipoProducto, vInsumo.Familia, '
	set @SQL=@SQL + 'vInsumo.SubFamilia, '
	set @SQL=@SQL + 'vInsumo.tDetallado as Insumo, '
	set @SQL=@SQL + 'vInsumo.UnidadSalida, '
	set @SQL=@SQL + 'round(vInsumo.nFactor*dbo.DPEDIDO.nCantidad ,5)AS nConsumo, '
	set @SQL=@SQL + 'round(vInsumo.nPrecioPromedio / vInsumo.nFactor,5) AS nPrecio, '
	set @SQL=@SQL + ''''' as tItem, '
	set @SQL=@SQL + 'dbo.vProducto.tEnlace AS tinsumo, 6 as grupo '
	set @SQL=@SQL + 'FROM dbo.vProducto INNER JOIN dbo.DPEDIDO INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem INNER JOIN '+ @BDALMACEN +'.dbo.vProducto vInsumo ON dbo.TPRODUCTOPROPIEDAD.tEnlace = vInsumo.tCodigoProducto ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido '
	set @SQL=@SQL + 'WHERE (dbo.MPEDIDO.tEstadoPedido <> ''03'') AND (dbo.DPEDIDO.tEstadoItem = ''N'')   AND (dbo.vProducto.lCombinacion = 0) AND tCodigoPropiedad <>''9999''  and MPEDIDO.fRegistro >= convert(datetime,'''+ convert(varchar,@finicio) +''') And MPEDIDO.fRegistro <= convert(datetime,'''+ convert(varchar,@ffinal) +''')'
	print '12'+@Sql
	EXECUTE  sp_executesql @sql

	--Inserta Propiedades de los Combos
	set @SQL='Insert into #DBTRANS1 '
	set @SQL=@SQL + 'SELECT ''Y'' AS tTipoProducto, vInsumo.Familia, '
	set @SQL=@SQL + 'vInsumo.SubFamilia, '
	set @SQL=@SQL + 'vInsumo.tDetallado as Insumo, '
	set @SQL=@SQL + 'vInsumo.UnidadSalida, '
	set @SQL=@SQL + 'round(DRV.nCantidad*dbo.DPEDIDO.nCantidad / vInsumo.nFactor,5) AS nConsumo, '
	set @SQL=@SQL + 'round(DRV.nPrecio* vInsumo.nFactor,5), '
	set @SQL=@SQL + ''''', '
	set @SQL=@SQL + 'dbo.vProducto.tEnlace AS tinsumo, 7 as grupo '
	set @SQL=@SQL + 'FROM '+ @BDALMACEN +'.dbo.MRECETAPROPIEDAD MRV INNER JOIN '+ @BDALMACEN +'.dbo.DRECETAPROPIEDAD DRV ON MRV.tRecetaPropiedad = DRV.tRecetaPropiedad INNER JOIN '+ @BDALMACEN +'.dbo.vProducto vInsumo ON DRV.tCodigoProducto = vInsumo.tCodigoProducto INNER JOIN dbo.TCOMBOPROPIEDAD INNER JOIN dbo.DPEDIDO INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON dbo.TCOMBOPROPIEDAD.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.TCOMBOPROPIEDAD.tItem = dbo.CPEDIDO.tItem AND dbo.TCOMBOPROPIEDAD.tItemCombo = dbo.CPEDIDO.tItemCombo ON MRV.tRecetaPropiedad = dbo.TCOMBOPROPIEDAD.tEnlace INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido '
	set @SQL=@SQL + 'WHERE (dbo.MPEDIDO.tEstadoPedido <> ''03'') AND (dbo.DPEDIDO.tEstadoItem = ''N'')  AND (dbo.vProducto.lCombinacion = 0)  and MPEDIDO.fRegistro >= convert(datetime,'''+ convert(varchar,@finicio) +''') And MPEDIDO.fRegistro <= convert(datetime,'''+ convert(varchar,@ffinal) +''')'
	print '13'+@Sql
    EXECUTE  sp_executesql @sql
			
	--Inserta Productos directos de las Propiedades de los combos
	set @SQL='Insert into #DBTRANS1 '
	set @SQL=@SQL + 'SELECT ''Y'' AS tTipoProducto, vInsumo.Familia, '
	set @SQL=@SQL + 'vInsumo.SubFamilia, '
	set @SQL=@SQL + 'vInsumo.tDetallado as Insumo, '
	set @SQL=@SQL + 'vInsumo.UnidadSalida, '
	set @SQL=@SQL + 'round(vInsumo.nFactor*dbo.DPEDIDO.nCantidad,5) as nConsumo, '
	set @SQL=@SQL + 'round(vInsumo.nPrecioPromedio / vInsumo.nFactor,5) as nPrecio, '
	set @SQL=@SQL + ''''', '
	set @SQL=@SQL + 'dbo.vProducto.tEnlace AS tinsumo, 8 as grupo '
	set @SQL=@SQL + 'FROM dbo.vProducto INNER JOIN '+ @BDALMACEN +'.dbo.vProducto vInsumo INNER JOIN dbo.DPEDIDO INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem ON vInsumo.tCodigoProducto = dbo.TCOMBOPROPIEDAD.tEnlace ON  dbo.vProducto.Codigo = dbo.TCOMBOPROPIEDAD.tProducto INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido '
	set @SQL=@SQL + 'WHERE (dbo.MPEDIDO.tEstadoPedido <> ''03'') AND (dbo.DPEDIDO.tEstadoItem = ''N'') AND (dbo.vProducto.lCombinacion = 0) AND tCodigoPropiedad <>''9999'' and MPEDIDO.fRegistro >= convert(datetime,'''+ convert(varchar,@finicio) +''') And MPEDIDO.fRegistro <=convert(datetime,'''+ convert(varchar,@ffinal) +''')'
	print '14'+@Sql
	EXECUTE  sp_executesql @sql


update #DBARTI1 set ConsumoRealCant=0, ConsumoRealValor=0, ConsumoPrevisto=0, ConsumoPrevistoValor=0


DECLARE @tcodigoproducto varchar(7), @Venta float, @Valor float
DECLARE cActualizar CURSOR FOR
--select tCodigoProveedor, tRazonSocial, CantDocumentos, nTotal,nPorcentaje from ' + @vch_sTempora2 + ' 
select tcodigoproducto,sum(Venta), sum(Valor*Venta) as Valor from #DBCONSREAL group by tcodigoproducto
OPEN cActualizar
FETCH  next from cActualizar INTO @tcodigoproducto, @Venta, @Valor
WHILE (@@FETCH_STATUS = 0 )
BEGIN
	
--	Set @nSum = @nSum + @nPorcentaje
	update #DBARTI1 set ConsumoRealCant=round(@Venta,5),ConsumoRealValor=round(@Valor,5) where tcodigoproducto=@tcodigoproducto
	FETCH  next from cActualizar INTO @tcodigoproducto, @Venta, @Valor
END 
CLOSE cActualizar
DEALLOCATE cActualizar



DECLARE @tInsumo varchar(7), @nConsumo float, @Valor1 float
DECLARE cActualizar2 CURSOR FOR
--select tCodigoProveedor, tRazonSocial, CantDocumentos, nTotal,nPorcentaje from ' + @vch_sTempora2 + ' 
--select tcodigoproducto,Venta from #DBCONSREAL
select tInsumo, sum(nConsumo), sum(nPrecio*nConsumo) as Valor from #DBTRANS1 group by tInsumo
OPEN cActualizar2
FETCH  next from cActualizar2 INTO @tInsumo, @nConsumo, @Valor1
WHILE (@@FETCH_STATUS = 0 )
BEGIN
	
--	Set @nSum = @nSum + @nPorcentaje
	update #DBARTI1 set ConsumoPrevisto=round(@nConsumo,5),ConsumoPrevistoValor=round(@Valor1,5) where tcodigoproducto=@tInsumo
	FETCH  next from cActualizar2 INTO  @tInsumo, @nConsumo, @Valor1
END 
CLOSE cActualizar2
DEALLOCATE cActualizar2


SELECT 
tcodigofamilia, familia, tcodigosubfamilia, 
subfamilia, tcodigoproducto, tdetallado , tunidadsalida , 
unidadsalida, round(ConsumoRealCant,5) as ConsumoRealCant,round(ConsumoRealValor,5) as ConsumoRealValor, 
round(ConsumoPrevisto,5) as ConsumoPrevisto, round(ConsumoPrevistoValor,5) as ConsumoPrevistoValor
FROM #DBARTI1


END

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE [dbo].[spRep_TipoProductoVentaIntegrado]
@flagPropiedades as bit,
@flagProduccion as bit,
@flagVenta as bit,
@flagCortesia as bit,
@flagCuentaCte as bit,
@flagPedidosFacturados as bit,
@flagCombinacion as bit, 
@flagCargo as bit,
@flagOpcion as bit, -- 1=detallado 0=resumido
@flagVVenta as bit,
@flagVNeto as bit,
@flagVCosto as bit,
@tTipoProducto as nvarchar(30),
@tTipoPedido as nvarchar(30),
@tGrupo as nvarchar(30),
@tSubGrupo as nvarchar(30),
@sPrecio as nvarchar(250),
@sNeto as nvarchar(250),
@sCosto as nvarchar(250),
@sOrden as nvarchar(200),
@sBoton2 as nvarchar(30),
@sBoton3 as nvarchar(30),
@sBoton4 as nvarchar(30),
@sBoton5 as nvarchar(30),
@finicio as smalldatetime,
@ffinal as smalldatetime

AS BEGIN

set nocount on
declare @sql nvarchar(4000)
declare @sqlP nvarchar(4000)
declare @Actualizaciones nvarchar(1000)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(3000)
declare @sCriteriox nvarchar(3000)
declare @xCriterio nvarchar(3000)
declare @sCostoPropiedad nvarchar(2000)
declare @sCombo nvarchar(2000)
declare @sCostoComboPropiedad nvarchar(2000)
declare @sCostoPropiedad2 nvarchar(2000)
declare @sCombo2 nvarchar(2000)
declare @sCostoComboPropiedad2 nvarchar(2000)

declare @sFiltro nvarchar(1000)

set @sCostoPropiedad2 =''
set @sCombo2 =''
set @sCostoComboPropiedad2=''

set @comilla=''''
	
	CREATE TABLE #DBTRANS (tLocal nVarChar(10) collate Modern_Spanish_CI_AS, Local nVarChar(50) collate Modern_Spanish_CI_AS, Salon nVarChar(50) collate Modern_Spanish_CI_AS, tMesa nVarChar(10) collate Modern_Spanish_CI_AS, TipoProducto nVarChar(50) collate Modern_Spanish_CI_AS, Grupo nVarChar(100) collate Modern_Spanish_CI_AS, SubGrupo nVarChar(100) collate Modern_Spanish_CI_AS, Producto nVarChar(3500) collate Modern_Spanish_CI_AS, Cantidad Float, Venta Float,neto float,costo float, Pedido nVarchar(15) collate Modern_Spanish_CI_AS, Documento nVarChar(25) collate Modern_Spanish_CI_AS, Fecha DateTime, tTipoPedido nVarchar(10) collate Modern_Spanish_CI_AS, tCodigoProducto nVarchar(10) collate Modern_Spanish_CI_AS, tItem nVarchar(5) collate Modern_Spanish_CI_AS)


	set @scriterio=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @scriteriox=' MPEDIDO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + ' and mpedido.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla
	set @xCriterio=' MDOCUMENTO.fRegistro >= '+ @comilla + LTRIM(STR(MONTH(@FINICIO)))+'/'+LTRIM(STR(DAY(@FINICIO)))+'/'+LTRIM(STR(YEAR(@FINICIO)))+ ' ' + convert(varchar(8),@fInicio,108)+ @comilla + '  and MDOCUMENTO.fregistro <= ' +@comilla + LTRIM(STR(MONTH(@FFINAL)))+'/'+LTRIM(STR(DAY(@FFINAL)))+'/'+LTRIM(STR(YEAR(@FFINAL)))+ ' ' + convert(varchar(8),@ffinal,108)+ @comilla


	if @ttipoProducto<>''
		SET @sCriterio=@sCriterio + ' and TipoProducto like  ' + @comilla+@tTipoProducto+'%'+@comilla
	if @ttipoPedido<>''
		SET @sCriterio=@sCriterio + ' and MPEDIDO.tTipoPedido like  ' + @comilla+@tTipoPedido+'%'+@comilla
		SET @sCriteriox=@sCriteriox + ' and MPEDIDO.tTipoPedido like  ' + @comilla+@tTipoPedido+'%'+@comilla
	if @tgrupo <> ''
		SET @sCriterio=@sCriterio + ' and Grupo like ' + @comilla+@tGrupo+'%'+@comilla
	if @tsubgrupo <> ''
		SET @sCriterio=@sCriterio + ' and subGrupo like ' + @comilla+@tSubGrupo+'%'+@comilla
	-- print @scriterio
	--print @sfiltro
	

if @flagProduccion=1 --produccion
begin
	if @flagPropiedades=0
		begin	
			SET  @sql= ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem ) ' +
					   ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @sCosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
					   ' FROM  dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ' +
					   ' where MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+ 'N'+@comilla+' and '+  @sCriterio
		end 
    else
		begin
			set @sql=' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem ) '+
			 			 ' SELECT   distinct  dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,'+  @sPrecio +' as Venta,' + @sNeto + ' AS Neto,' + @sCosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido , dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
				 		 ' FROM         dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND  dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON  dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa  '+
						 ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' AND (dbo.vpaloteoproduccionpropiedades.tCodigoPropiedad IS NULL )  and '+ @sCriterio 
		end 

	
 	--Actualiza Costos de loas propiedades
	 set @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
                       		 ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       		 ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                     		 ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') AND ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '


      --Actualiza Costos de los Combos

        set @sCombo = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
          		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
               		' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
	                ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ' +
         	        ' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
      --Actualiza Costos de los Combos de las Propiedades

	set @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' +
                            ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' + 
                            ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                            ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @scriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ' +
                            ' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

--Actualiza Costos de loas propiedades
	 set @sCostoPropiedad2 = ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN ' +
                       		 ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       		 ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                     		 ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') AND ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '


      --Actualiza Costos de los Combos

        set @sCombo2 = ' Update #DBTRANS set costo=t1.costo+t2.costo  FROM #DBTRANS as T1 INNER JOIN ' +
          		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
               		' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
	                ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ' +
         	        ' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
      --Actualiza Costos de los Combos de las Propiedades

	set @sCostoComboPropiedad2 = ' Update #DBTRANS set costo=t1.costo+t2.costo  FROM #DBTRANS as T1 INNER JOIN ' +
                            ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' + 
                            ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                            ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @scriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ' +
                            ' ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
END 
	
if @flagVenta=1 --venta
begin
		if @flagPropiedades=0
			begin

				 set @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
							' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' + @sPrecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
							' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento  ' +
							' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+ 'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+ 'F'+@comilla+') and ' + @sCriterio + ' and ' + @xCriterio
			end
		else
			begin
				set	@sql =  ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido,  tCodigoProducto, tItem )  ' +
               				' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, ' +@sPrecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido,   dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                			' FROM  dbo.vProducto RIGHT OUTER JOIN dbo.vPaloteoProduccionPropiedades RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vPaloteoProduccionPropiedades.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.vPaloteoProduccionPropiedades.tItem = dbo.DPEDIDO.tItem ON dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
                			' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado ='+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio + ' and ' + @xCriterio  
			end
	--  Actualiza Costos de las Propiedades
	set  @sCostoPropiedad =   'Update #DBTRANS set  Venta = Venta + T2.Costo  FROM #DBTRANS as T1 INNER JOIN ' + 
                      		  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       		  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
	                          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox  + 
				  ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	--  Actualiza Costos de los Combos
	set @sCombo =   ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
               		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
	                ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
          	        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + ' and ' + @xCriterio +  
	                ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2  ON  T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	--Actualiza Costos de los Combos de las Propiedades
	set @sCostoComboPropiedad = 	' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                            		' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                          	        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+' ) and '+ @sCriteriox  +
                           		' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2  ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem ' 
	
	--  Actualiza Costos de las Propiedades
	set  @sCostoPropiedad2 =   'Update #DBTRANS set  costo=t1.costo+t2.costo  FROM #DBTRANS as T1 INNER JOIN ' + 
                      		  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                       		  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
	                          ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox  + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	--  Actualiza Costos de los Combos
	set @sCombo2 =   ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN ' +
               		' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
	                ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
          	        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + ' and ' + @xCriterio +  
	                ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2  ON  T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
	
	--Actualiza Costos de los Combos de las Propiedades
	set @sCostoComboPropiedad2 = 	' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                            		' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                          	        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+' ) and '+ @sCriteriox  +
                           		' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2  ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem ' 

end

if @flagCortesia=1 --cortesia
begin
		if @flagPropiedades=0 
			begin
				SET @sql =	 ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
							 ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, '+ @sPrecio+' AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
							 ' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento  ' +
							 ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+ '03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+ 'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+ 'C'+@comilla+' and ' +@sCriterio
			end
		else
			begin

				set @sql =   ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto, costo, Pedido, Documento, Fecha, tTipoPedido,  tCodigoProducto, tItem ) ' +
           					 ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, '+  @sPrecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido,   dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
           					 ' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.vProducto RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ON  dbo.vProducto.Codigo = dbo.DPEDIDO.tCodigoProducto ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ' + 
							 ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @scriterio
			end



     --Actualiza Costos de las Propiedades
		set  @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' + 
			' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                        ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and ' + @sCriteriox  + 
                        ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '



 	     --Actualiza Costos de los Combos
		set  @sCombo = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN  dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and '+ @scriteriox + 
	       ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '


	     --Actualiza Costos de los Combos de las Propiedades
		set  @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+ ' and ' +  @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
     --Actualiza Costos de las Propiedades
		set  @sCostoPropiedad2 = ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                        ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                        ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and ' + @sCriteriox  + 
                        ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

 	     --Actualiza Costos de los Combos
		set  @sCombo2 = ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN  dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+' and '+ @scriteriox + 
	       ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

	     --Actualiza Costos de los Combos de las Propiedades
		set  @sCostoComboPropiedad2 = ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND dbo.DPEDIDO.tFacturado = '+@comilla+'C'+@comilla+ ' and ' +  @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'

end 
if @flagCuentaCte=1 --cuenta corriente
begin
		if @flagPropiedades=0 
			begin
				set @sql =  ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
							' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
							' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.TMESA  ' + 
							' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+''+@comilla+')<>'+@comilla+''+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriterio + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and '+ @xCriterio + ')'
			end
		else
			begin
				set @sql =  ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido,  tCodigoProducto, tItem ) ' +
               			    ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido,  dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' + 
                		    ' FROM   dbo.vPaloteoProduccionPropiedades RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vPaloteoProduccionPropiedades.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.vPaloteoProduccionPropiedades.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN  dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
                		    ' where  isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and '+ @scriterio + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ')'
			end
      
     --Actualiza Costos de las Propiedades
		set  @sCostoPropiedad =    ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
             			           ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
		                           ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ') ' + 
                        		   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
             
      --Actualiza Costos de los Combos
		set  @sCombo = 		   ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               				   ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               				   ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
               				   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

      --Actualiza Costos de los Combos de las Propiedades
		set  @sCostoComboPropiedad =    ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             			' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             			' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
                             			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

     --Actualiza Costos de las Propiedades
		set  @sCostoPropiedad2 =    ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
             			           ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN  dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
		                           ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and ' + @xCriterio + ') ' + 
                        		   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
             
      --Actualiza Costos de los Combos
		set  @sCombo2 = 		   ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
               				   ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
               				   ' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
               				   ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

      --Actualiza Costos de los Combos de las Propiedades
		set  @sCostoComboPropiedad2 =    ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             			' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             			' where isnull(MPEDIDO.tClienteCtaCte,'+@comilla+' '+@comilla+')<>'+@comilla+' '+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox + ' and dbo.DPEDIDO.tCodigoPedido not in (SELECT dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ' + @xCriterio + ') ' +
                             			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '
END

if @flagCombinacion=1 --combinacion
begin
		if @flagPropiedades=0
			begin
				set @sql =  ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem ) ' + 
						    ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad,  ' + @sPrecio +' AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.CPEDIDO.tCodigoPedido AS Pedido, dbo.DPEDIDO.tDocumento AS Documento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
							' FROM dbo.TMESA RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.TMESA  ' +
							' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' and ' + @sCriterio
			end
		else
			begin
				set @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem  ) ' +
						   ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.CPEDIDO.nCantidad, ' + @sPrecio + '  AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.CPEDIDO.tCodigoPedido AS Pedido, dbo.DPEDIDO.tDocumento AS Documento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
        				   ' FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.vPaloteoProduccionPropiedadesCombos RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.vPaloteoProduccionPropiedadesCombos.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND  dbo.vPaloteoProduccionPropiedadesCombos.tItem = dbo.CPEDIDO.tItem AND dbo.vPaloteoProduccionPropiedadesCombos.tItemCombo = dbo.CPEDIDO.tItemCombo ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
                		   ' where MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+'  AND  dbo.vProducto.Descripcion  IS NOT NULL AND (dbo.vPaloteoProduccionPropiedadesCombos.tCodigoPropiedad IS NULL) and ' + @sCriterio
			end

   

	--Actualiza Costos de las Propiedades
	      SET @sCostoPropiedad = 'SELECT 1'

      	--Actualiza Costos de los Combos
	      SET @sCombo = 'SELECT 1'
      
	--Actualiza Costos de los Combos de las Propiedades
    	      set @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             	 	  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja  ' +
                             	 	  ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem   '                     

	--Actualiza Costos de las Propiedades
	      SET @sCostoPropiedad2 = 'SELECT 1'

      	--Actualiza Costos de los Combos
	      SET @sCombo2 = 'SELECT 1'
      
	--Actualiza Costos de los Combos de las Propiedades
    	      set @sCostoComboPropiedad2 = ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             	 	  ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja  ' +
                             	 	  ' WHERE (dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+') AND (dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+') and ' + @sCriteriox + ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.CPEDIDO.tItemCombo) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem   '                     
end

if @flagCargo=1 --cargo
begin
		if @flagPropiedades=0
			begin
				set  @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' +
							' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, '+ @Sprecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' + 
							' FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.TMESA ' +
							' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriterio
			end
		else
			begin
				set @sql =  ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido,  tCodigoProducto, tItem ) ' +
                      		' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' + @sPrecio + '  AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo,  dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' +
                     		' FROM         dbo.vPaloteoProduccionPropiedades RIGHT OUTER JOIN dbo.DPEDIDO ON dbo.vPaloteoProduccionPropiedades.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.vPaloteoProduccionPropiedades.tItem = dbo.DPEDIDO.tItem LEFT OUTER JOIN  dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.TCAJA RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.TCAJA.tCaja = dbo.MPEDIDO.tCaja ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido ' +
			         		' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem= '+@comilla+'N'+@comilla+' AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio
			end		

            
       --Actualiza Costos de los Combos
	      SET @sCostoPropiedad = 'SELECT 1'

	      SET @sCostoComboPropiedad = 'SELECT 1'
	--Actualiza Costos  de los Combos
	      set @sCombo = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
              ' FROM dbo.CPEDIDO INNER JOIN  dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
              ' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +
              ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'	
       --Actualiza Costos de los Combos
	      SET @sCostoPropiedad2 = 'SELECT 1'

	      SET @sCostoComboPropiedad2 = 'SELECT 1'
	--Actualiza Costos  de los Combos
	      set @sCombo2 = ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0))  * dbo.CPEDIDO.nCantidad) AS Costo ' +
              ' FROM dbo.CPEDIDO INNER JOIN  dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
              ' where MPEDIDO.tEstadoPedido = '+@comilla+'05'+@comilla+' and DPEDIDO.tEstadoItem='+@comilla+'N'+@comilla+' and ' + @sCriteriox +
              ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) as T2 ON T1.tCodigoProducto = T2.tCodigoProducto and T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'	

end	
	
if @flagPedidosFacturados=1 --pedidos facturados
begin	
		if @flagPropiedades=0
			begin
			set   @sql = ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido, tCodigoProducto, tItem )  ' + 
						 ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  ' +@sPrecio + ' AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido, dbo.vProducto.Codigo, dbo.DPEDIDO.tItem  ' +
						 ' FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento  ' +
						 ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriterio
			end
		else
			begin
			 set @sql=   ' Insert into #DBTRANS (tLocal, Salon, tMesa, TipoProducto, Grupo, SubGrupo, Producto, Cantidad, Venta,neto,costo, Pedido, Documento, Fecha, tTipoPedido,  tCodigoProducto, tItem ) ' + 
                	 	 ' SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon, dbo.MPEDIDO.tMesa, dbo.vProducto.TipoProducto, dbo.vProducto.Grupo, dbo.vProducto.SubGrupo, dbo.vProducto.Descripcion AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad,  '+ @sPrecio +'  AS Venta,' + @sNeto + ' AS Neto,' + @scosto + ' AS Costo, dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido,   dbo.vProducto.Codigo, dbo.DPEDIDO.tItem ' + 
                		 ' FROM         dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vPaloteoProduccionPropiedades ON dbo.DPEDIDO.tCodigoPedido = dbo.vPaloteoProduccionPropiedades.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.vPaloteoProduccionPropiedades.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON  dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN  dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento LEFT OUTER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' + 
                		 ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+')  AND (dbo.vPaloteoProduccionPropiedades.tCodigoPropiedad IS NULL) and ' + @sCriterio  

			end		

  --Actualiza Costos de las Propiedades
  		SET    @sCostoPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
                            ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                            ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                            ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox +
                            ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

  		--Actualiza Costos de los Combos xx
 		SET     @sCombo = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN ' +
            			  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
             			  ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
               			  ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + 
               			  ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON   T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
      
      		--Actualiza Costos de los Combos de las Propiedades
 		SET     @sCostoComboPropiedad = ' Update #DBTRANS set Venta = Venta + T2.Costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             			' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             			' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' +  @sCriteriox +
                             			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
  --Actualiza Costos de las Propiedades
  		SET    @sCostoPropiedad2 = ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN ' +
                            ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TPRODUCTOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TPRODUCTOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS Costo ' +
                            ' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.TPRODUCTOPROPIEDAD ON dbo.DPEDIDO.tCodigoPedido = dbo.TPRODUCTOPROPIEDAD.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.TPRODUCTOPROPIEDAD.tItem LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                            ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox +
                            ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem '

  		--Actualiza Costos de los Combos xx
 		SET     @sCombo2 = ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN ' +
            			  ' (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto, SUM((ISNULL(dbo.CPEDIDO.nInsumo, 0) + ISNULL(dbo.CPEDIDO.nGasto, 0) + ISNULL(dbo.CPEDIDO.nManoObra, 0)) * dbo.CPEDIDO.nCantidad) AS Costo ' +
             			  ' FROM dbo.CPEDIDO INNER JOIN dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento ' +
               			  ' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' + @sCriteriox + 
               			  ' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.DPEDIDO.tCodigoProducto) as T2 ON   T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
      
      		--Actualiza Costos de los Combos de las Propiedades
 		SET     @sCostoComboPropiedad2 = ' Update #DBTRANS set costo=t1.costo+t2.costo FROM #DBTRANS as T1 INNER JOIN (SELECT dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, SUM((ISNULL(dbo.TCOMBOPROPIEDAD.nInsumo, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nGasto, 0) + ISNULL(dbo.TCOMBOPROPIEDAD.nManoObra, 0)) * dbo.DPEDIDO.nCantidad) AS costo ' +
                             			' FROM dbo.DPEDIDO INNER JOIN dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN dbo.TCOMBOPROPIEDAD ON dbo.CPEDIDO.tCodigoPedido = dbo.TCOMBOPROPIEDAD.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.TCOMBOPROPIEDAD.tItem AND dbo.CPEDIDO.tItemCombo = dbo.TCOMBOPROPIEDAD.tItemCombo LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo INNER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo INNER JOIN dbo.TCAJA ON dbo.MPEDIDO.tCaja = dbo.TCAJA.tCaja ' +
                             			' WHERE dbo.MPEDIDO.tEstadoPedido <> '+@comilla+'03'+@comilla+' AND dbo.DPEDIDO.tEstadoItem = '+@comilla+'N'+@comilla+' AND (dbo.DPEDIDO.tFacturado = '+@comilla+'P'+@comilla+' OR dbo.DPEDIDO.tFacturado = '+@comilla+'F'+@comilla+') and ' +  @sCriteriox +
                             			' GROUP BY dbo.DPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem) as T2 ON T1.Pedido = T2.tCodigoPedido and T1.tItem = T2.tItem'
end

EXEC sp_executesql @sql
--PRINT @SQL

update #DBTRANS set tLocal =  vSalon.tLocal FROM #DBTRANS INNER JOIN dbo.TMESA ON dbo.#DBTRANS.tMesa = dbo.TMESA.tCodigoMesa INNER JOIN dbo.vSalon ON dbo.TMESA.tSalon = dbo.vSalon.Codigo 

	if @sCombo2!= 'SELECT 1'
		BEGIN
 			EXEC sp_executesql @sCombo2
		END 
	IF @sCostoComboPropiedad2!='SELECT 1'	
		BEGIN		
			EXEC sp_executesql @sCostoComboPropiedad2
		END
	IF @sCostoPropiedad2!='SELECT 1'	
		BEGIN		
			EXEC sp_executesql @sCostoPropiedad2
		END

		--EXEC sp_executesql @sCostoPropiedad2
if @flagVCosto=1
begin
	if @flagPropiedades=0
		begin
			IF @sCostoPropiedad!='SELECT 1'	
				BEGIN		
					EXEC sp_executesql @sCostoPropiedad
				END
		end

	if @sCombo!= 'SELECT 1'
		BEGIN
			EXEC sp_executesql @sCombo
		END 
	IF @sCostoComboPropiedad!='SELECT 1'	
		BEGIN		
			EXEC sp_executesql @sCostoComboPropiedad

		END
			--EXEC sp_executesql @sCombo
			--EXEC sp_executesql @sCostoComboPropiedad
end

 


set @Actualizaciones = 'update #DBTRANS set Salon = '+@comilla+'Sin Salon'+@comilla+' where isnull(Salon,'+@comilla+'0'+@comilla+') = '+@comilla+'0'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+@comilla+ @sBoton2 + @comilla+' where tTipoPedido ='+@comilla+'02'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+ @comilla+@sBoton3 +@comilla+ ' where tTipoPedido ='+@comilla+'03'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+@comilla+ @sBoton4 +@comilla+ ' where tTipoPedido ='+@comilla+'04'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Salon = '+ @comilla+@sBoton5+@comilla + ' where tTipoPedido ='+@comilla+'05'+@comilla
EXEC sp_executesql @Actualizaciones
set @Actualizaciones = 'update #DBTRANS set Local = vLocal.Descripcion FROM #DBTRANS INNER JOIN dbo.vLocal ON dbo.#DBTRANS.tLocal = dbo.vLocal.Codigo '
EXEC sp_executesql @Actualizaciones

/**/

--select  right('00'+ ltrim(str(+day(fecha))),2)  + '/'+ right('00'+ltrim(str(month(fecha))),2)  +'/'+  ltrim(str(year(fecha))) as Dia, sum(venta) as venta from #DBTRANS group by right('00'+ ltrim(str(+day(fecha))),2) +'/'+right('00'+ltrim(str(month(fecha))),2) +'/'+ ltrim(str(year(fecha)))  

select tipoproducto , producto,sum(cantidad) as cantidad, sum(venta) as venta,sum(neto) as neto,sum(costo) as costo from #dbtrans group by tipoproducto,producto order by  producto




/**/
--EXEC sp_executesql @sql


END

 
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


CREATE PROCEDURE [dbo].[USP_KDS_ResporteTiempoPedido]
@fInicio As smalldatetime,
@fFinal As smalldatetime
AS BEGIN

SELECT 
	K.tCodigoPedido As Pedido,
    P.tDetallado As Producto,
	CONVERT(VARCHAR(8),MIN(K.fSalida - ISNULL(D.fEnvio,D.fRegistro)),108) As TiempoCorto, 
	CONVERT(VARCHAR(8),MAX(K.fSalida - ISNULL(D.fEnvio,D.fRegistro)),108) As TiempoLargo,+'00:'+
    CONVERT(VARCHAR(5),DATEADD(MI,SUM((DATEPART(HH, CONVERT(Datetime, (K.fSalida - ISNULL(D.fEnvio,D.fRegistro)))) +
    DATEPART(MI, CONVERT(Datetime, (K.fSalida - ISNULL(D.fEnvio,D.fRegistro)))))*60 +
    DATEPART(SS, CONVERT(Datetime, (K.fSalida - ISNULL(D.fEnvio,D.fRegistro)))))/COUNT(*),'19000101'),108)
    As TiempoPromedio
                    
FROM 
	DPEDIDOKDS K 
	INNER JOIN DPEDIDO D ON K.tCodigoPedido = D.tCodigoPedido
	INNER JOIN TPRODUCTO P ON D.tCodigoProducto = P.tCodigoProducto

   WHERE (D.fRegistro >= @fInicio and D.fRegistro <= @fFinal) and D.tEstadoItem='N'

GROUP BY 
	K.tCodigoPedido,
    P.tDetallado

ORDER BY K.tCodigoPedido ASC

END

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE [dbo].[USP_KDS_ResporteTiempoProducto]
@fInicio As smalldatetime,
@fFinal As smalldatetime,
@tGrupo As nvarchar(10),
@tSubGrupo As nvarchar(10),
@tProducto As nvarchar(30)
AS BEGIN

SELECT 
    G.tDetallado As Grupo,
	S.tDetallado AS SubGrupo,
	P.tDetallado As Producto,
	CONVERT(VARCHAR(8),MIN(K.fSalida - ISNULL(D.fEnvio,D.fRegistro)),108) As TiempoCorto, 
	CONVERT(VARCHAR(8),MAX(K.fSalida - ISNULL(D.fEnvio,D.fRegistro)),108) As TiempoLargo,+'00:'+
    CONVERT(VARCHAR(5),DATEADD(MI,SUM((DATEPART(HH, CONVERT(Datetime, (K.fSalida - ISNULL(D.fEnvio,D.fRegistro)))) +
    DATEPART(MI, CONVERT(Datetime, (K.fSalida - ISNULL(D.fEnvio,D.fRegistro)))))*60 +
    DATEPART(SS, CONVERT(Datetime, (K.fSalida - ISNULL(D.fEnvio,D.fRegistro)))))/COUNT(*),'19000101'),108)
    As TiempoPromedio
                    
FROM 
	DPEDIDOKDS K 
	INNER JOIN DPEDIDO D ON K.tCodigoPedido = D.tCodigoPedido
	INNER JOIN TPRODUCTO P ON D.tCodigoProducto = P.tCodigoProducto
	INNER JOIN TSUBGRUPO S ON P.tSubgrupo = S.tCodigoSubgrupo
	INNER JOIN TGRUPO G ON S.tCodigoGrupo = G.tCodigoGrupo

    WHERE (D.fRegistro >= @fInicio and D.fRegistro <= @fFinal) 
    and (G.tCodigoGrupo=@tGrupo or @tGrupo='') 
    and (S.tCodigoSubgrupo=@tSubGrupo or @tSubGrupo='')
    and (P.tCodigoProducto=@tProducto or @tProducto='')
    and D.tEstadoItem='N' 

GROUP BY 
	G.tDetallado,
	S.tDetallado,
	P.tDetallado
END

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO
 

CREATE PROCEDURE [dbo].[spRep_RegVentaSunat]
@fInicio As smalldatetime,
@fFinal As smalldatetime,
@tCliente As nvarchar(20),
@tTipoDoc As nvarchar(20),
@tEstadoDoc As nvarchar(20),
@tCaja As nvarchar(5),
@sOrden As nvarchar(140),
@flagRegVenta As bit,
@flagRedondeo As bit,
@DiaContable As bit

AS
BEGIN 
SET NOCOUNT ON 
DECLARE @sNC nVarchar(10)
DECLARE @sEstDoc nVarchar(10)

CREATE TABLE #DBTRANS (Voucher nVarchar(50), fEmision datetime, fVencim datetime,TDoc nVarchar(4) collate Modern_Spanish_CI_AS, Serie nVarchar(50) collate Modern_Spanish_CI_AS,Numero nVarchar(50) collate Modern_Spanish_CI_AS,Doc nVarchar(2) collate Modern_Spanish_CI_AS, NumeroR nVarchar(50) collate Modern_Spanish_CI_AS,RazonSocial nVarchar(100) collate Modern_Spanish_CI_AS,ValorFact nVarchar(50) collate Modern_Spanish_CI_AS,Descuento Float,Recargo Float,BaseImOpGra Float,Exonerada Float, Inafecta Float,ISC nVarchar(50) collate Modern_Spanish_CI_AS,IGV Float, OtrosTrib Float, ImporteT Float, TipoCambio Float,Fecha nVarchar(50),TD nVarchar(4) collate Modern_Spanish_CI_AS,SerieN nVarchar(50) collate Modern_Spanish_CI_AS,NumeroN nVarchar(50) collate Modern_Spanish_CI_AS, tTemporal nVarchar(50) collate Modern_Spanish_CI_AS,nValorFactSuma float,nBaseImpGrabSum float,nExoneradaSum float,nInafectaSum float,nISCSum float,nIGVSum float,nOtrosTSum float,nImportTSum float, Documento nVarchar(50) collate Modern_Spanish_CI_AS)	
CREATE TABLE #DBTRANSTEMP (Voucher nVarchar(50), fEmision datetime, fVencim datetime,TDoc nVarchar(4) collate Modern_Spanish_CI_AS, Serie nVarchar(50) collate Modern_Spanish_CI_AS,Numero nVarchar(50) collate Modern_Spanish_CI_AS,Doc nVarchar(2) collate Modern_Spanish_CI_AS, NumeroR nVarchar(50) collate Modern_Spanish_CI_AS,RazonSocial nVarchar(100) collate Modern_Spanish_CI_AS,ValorFact nVarchar(50) collate Modern_Spanish_CI_AS,Descuento Float,Recargo Float,BaseImOpGra Float,Exonerada Float, Inafecta Float,ISC nVarchar(50) collate Modern_Spanish_CI_AS,IGV Float, OtrosTrib Float, ImporteT Float, TipoCambio Float,Fecha nVarchar(50),TD nVarchar(4) collate Modern_Spanish_CI_AS,SerieN nVarchar(50) collate Modern_Spanish_CI_AS,NumeroN nVarchar(50) collate Modern_Spanish_CI_AS, tTemporal nVarchar(50) collate Modern_Spanish_CI_AS,nValorFactSuma float,nBaseImpGrabSum float,nExoneradaSum float,nInafectaSum float,nISCSum float,nIGVSum float,nOtrosTSum float,nImportTSum float, Documento nVarchar(50) collate Modern_Spanish_CI_AS)	
CREATE TABLE #DBTRANSTEMP1 (Voucher nVarchar(50), fEmision datetime, fVencim datetime,TDoc nVarchar(4) collate Modern_Spanish_CI_AS, Serie nVarchar(50) collate Modern_Spanish_CI_AS,Numero nVarchar(50) collate Modern_Spanish_CI_AS,Doc nVarchar(2) collate Modern_Spanish_CI_AS, NumeroR nVarchar(50) collate Modern_Spanish_CI_AS,RazonSocial nVarchar(100) collate Modern_Spanish_CI_AS,ValorFact nVarchar(50) collate Modern_Spanish_CI_AS,Descuento Float,Recargo Float,BaseImOpGra Float,Exonerada Float, Inafecta Float,ISC nVarchar(50) collate Modern_Spanish_CI_AS,IGV Float, OtrosTrib Float, ImporteT Float, TipoCambio Float,Fecha nVarchar(50),TD nVarchar(4) collate Modern_Spanish_CI_AS,SerieN nVarchar(50) collate Modern_Spanish_CI_AS,NumeroN nVarchar(50) collate Modern_Spanish_CI_AS, tTemporal nVarchar(50) collate Modern_Spanish_CI_AS,nValorFactSuma float,nBaseImpGrabSum float,nExoneradaSum float,nInafectaSum float,nISCSum float,nIGVSum float,nOtrosTSum float,nImportTSum float, Documento nVarchar(50) collate Modern_Spanish_CI_AS)	

			DECLARE @nValorFact As float
			DECLARE @nBaseImpGrab As float
			DECLARE @nExonerada As float
			DECLARE @nInafecta As float
			DECLARE @nISC As float
			DECLARE @nIGV As float
			DECLARE @nOtrosT As float
			DECLARE @nImportT As float
            DECLARE @numero As float
            DECLARE @incre As float
            DECLARE @tDocumento As nVarchar(50)
            DECLARE @PorcentD float
            DECLARE @PorcentR float

            set @numero = 0
			set @incre = 0			
            Set @nValorFact = 0
			Set @nBaseImpGrab = 0
			Set @nExonerada = 0
			Set @nInafecta = 0
			Set @nISC = 0
			Set @nIGV = 0
			Set @nOtrosT = 0
			Set @nImportT = 0
            Set @PorcentD = 0
            Set @PorcentR = 0

If @DiaContable=0
BEGIN

If @flagRedondeo=0
 BEGIN
 
   If @flagRegVenta=0
      BEGIN

        If @sOrden='Correlativo'
           BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,  
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               (SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0)))As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As IGV,--vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As OtrosTrib,--vDocumentoGrilla
               VM.nVenta As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' ' As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento 
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY M.fRegistro,M.tDocumento

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito  As Documento 
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   INNER JOIN dDocumento D
                   ON D.tDocumento = N.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fFecha >= @fInicio AND N.fFecha <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------

				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'

				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END


        If @sOrden='Montos'
           BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT  
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               (SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0)))As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As IGV,--vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As OtrosTrib,--vDocumentoGrilla
               VM.nVenta As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento  
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY ImporteT

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito  As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fFecha >= @fInicio AND N.fFecha <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
         END

         If @sOrden='Fechas'
          BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT  
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher, 
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               (SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0)))As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As IGV,--vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As OtrosTrib,--vDocumentoGrilla
               VM.nVenta As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento  
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY M.fRegistro

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc


---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT 
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fFecha >= @fInicio AND N.fFecha <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
         END
    END


-----------SOLO-VENTAS----------
----------------------------


    If @flagRegVenta=1
      BEGIN

        If @sOrden='Correlativo'
           BEGIN
----------DOCUMENTOS----------DIEGO
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,  
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
                0 As Descuento,
                0 As Recargo,
               (SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0)))As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As IGV,--vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As OtrosTrib,--vDocumentoGrilla
               VM.nVenta As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento   
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (VT.RegistroVenta = 1) 
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.tTipodocumento,M.tDocumento,M.fPago,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY M.fRegistro,M.tDocumento

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc


---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT  
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fFecha >= @fInicio AND N.fFecha <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END


      If @sOrden='Montos'
         BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               (SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0)))As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As IGV,--vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As OtrosTrib,--vDocumentoGrilla
               VM.nVenta As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento   
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (VT.RegistroVenta = 1)
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY ImporteT

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc


---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT 
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fFecha >= @fInicio AND N.fFecha <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
         END


       If @sOrden='Fechas'
         BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT 
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               (SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0)))As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As IGV,--vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As OtrosTrib,--vDocumentoGrilla
               VM.nVenta As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento  
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (VT.RegistroVenta = 1)
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY M.fRegistro

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc


---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT  
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fFecha >= @fInicio AND N.fFecha <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Codigo FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END
    END
END


--------------------------------------
-------------------REDONDEO------------


If @flagRedondeo=1
 BEGIN

   If @flagRegVenta=0
      BEGIN

        If @sOrden='Correlativo'
           BEGIN

----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               ROUND((SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0))),2)As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               ROUND((SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento),2) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As IGV,--vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As OtrosTrib,--vDocumentoGrilla
               ROUND(VM.nVenta,2) As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento  
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY M.fRegistro,M.tDocumento

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT  
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fFecha >= @fInicio AND N.fFecha <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END

        If @sOrden='Montos'
           BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               ROUND((SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0))),2)As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               ROUND((SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento),2) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As IGV,--vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As OtrosTrib,--vDocumentoGrilla
               ROUND(VM.nVenta,2) As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento  
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY ImporteT
				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT  
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fFecha >= @fInicio AND N.fFecha <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
         END


         If @sOrden='Fechas'
          BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               ROUND((SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0))),2)As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               ROUND((SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento),2) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As IGV,--vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As OtrosTrib,--vDocumentoGrilla
               ROUND(VM.nVenta,2) As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento  
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY M.fRegistro

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT  
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fFecha >= @fInicio AND N.fFecha <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito

----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END
    END


-----------SOLO-VENTAS----------
----------------------------

    If @flagRegVenta=1
      BEGIN

        If @sOrden='Correlativo'
           BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               ROUND((SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0))),2)As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               ROUND((SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento),2) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As IGV,--vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As OtrosTrib,--vDocumentoGrilla
               ROUND(VM.nVenta,2) As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento  
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (VT.RegistroVenta = 1)
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY M.fRegistro,M.tDocumento

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT 
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fFecha >= @fInicio AND N.fFecha <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END

      If @sOrden='Montos'
         BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher, 
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               ROUND((SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0))),2)As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               ROUND((SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento),2) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As IGV,--vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As OtrosTrib,--vDocumentoGrilla
               ROUND(VM.nVenta,2) As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento   
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (VT.RegistroVenta = 1)
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY ImporteT

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT 
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fFecha >= @fInicio AND N.fFecha <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
         END

       If @sOrden='Fechas'
         BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               ROUND((SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0))),2)As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               ROUND((SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento),2) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As IGV,--vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As OtrosTrib,--vDocumentoGrilla
               ROUND(VM.nVenta,2) As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento  
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (VT.RegistroVenta = 1)
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY M.fRegistro

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT 
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento 
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fFecha >= @fInicio AND N.fFecha <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END
    END
END
--------------VAN --VIENEN----------------------------
				SELECT @numero=COUNT(*) FROM #DBTRANS
				WHILE @incre<=@numero
				BEGIN
					INSERT INTO #DBTRANSTEMP SELECT TOP 1 * FROM #DBTRANS

					SELECT @tdocumento = Documento FROM #DBTRANSTEMP

					DELETE FROM #DBTRANS WHERE Documento = @tdocumento
                    ----------------------------
--                    --------DESCUENTOS------------
--                    SELECT @PorcentD = Descuento FROM #DBTRANSTEMP
--                    UPDATE #DBTRANSTEMP SET BaseImOpGra = BaseImOpGra * @PorcentD, 
--                                    Inafecta = Inafecta * @PorcentD, IGV = IGV * @PorcentD,
--                                    OtrosTrib  = OtrosTrib * @PorcentD 
--                    WHERE Documento = @tdocumento 
--
--                     -------RECARGOS-------
--                    SELECT @PorcentR = Recargo FROM #DBTRANSTEMP
--                    UPDATE #DBTRANSTEMP SET BaseImOpGra = BaseImOpGra+(BaseImOpGra*@PorcentR), 
--                                    Inafecta = Inafecta+(Inafecta*@PorcentR), IGV = IGV+(IGV*@PorcentR),
--                                    OtrosTrib  = OtrosTrib+(OtrosTrib*@PorcentR)
--                    WHERE Documento = @tdocumento
                    -------------------------------

					UPDATE #DBTRANSTEMP SET nBaseImpGrabSum=@nBaseImpGrab,
						   nExoneradaSum=@nExonerada, nInafectaSum=@nInafecta, nIGVSum=@nIGV,
						   nOtrosTSum=@nOtrosT, nImportTSum=@nImportT
					WHERE Documento = @tdocumento

					SELECT @nBaseImpGrab = @nBaseImpGrab + ISNULL(BaseImOpGra,0),
						   @nExonerada = @nExonerada + ISNULL(Exonerada,0),
						   @nInafecta = @nInafecta + ISNULL(Inafecta,0),
						   @nIGV = @nIGV + ISNULL(IGV,0), 
						   @nOtrosT = @nOtrosT + ISNULL(OtrosTrib,0),
						   @nImportT = @nImportT + ISNULL(ImporteT,0)
					FROM #DBTRANSTEMP

					INSERT INTO #DBTRANSTEMP1 SELECT * FROM #DBTRANSTEMP

					DELETE FROM #DBTRANSTEMP

					SET @incre=@incre+1

				END
----------------------------------------------------------------------------------
SELECT Voucher, fEmision, fVencim, TDoc, Serie, Numero, Doc, NumeroR, RazonSocial, ValorFact, BaseImOpGra, Exonerada, Inafecta, ISC, IGV, OtrosTrib, ImporteT, TipoCambio, Fecha, TD, SerieN, NumeroN, nValorFactSuma, nBaseImpGrabSum, nExoneradaSum, nInafectaSum, nISCSum, nIGVSum, nOtrosTSum, nImportTSum,Documento   FROM #DBTRANSTEMP1
	
END









--------DIA CONTABLE

If @DiaContable=1
BEGIN

If @flagRedondeo=0
 BEGIN
 
   If @flagRegVenta=0
      BEGIN

        If @sOrden='Correlativo'
           BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,  
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               (SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0)))As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As IGV,--vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As OtrosTrib,--vDocumentoGrilla
               VM.nVenta As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' ' As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento  
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fDiaContable >= @fInicio AND M.fDiaContable <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY M.fRegistro,M.tDocumento

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   INNER JOIN dDocumento D
                   ON D.tDocumento = N.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fDiaContable >= @fInicio AND N.fDiaContable <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------

				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'

				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END


        If @sOrden='Montos'
           BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT  
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               (SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0)))As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As IGV,--vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As OtrosTrib,--vDocumentoGrilla
               VM.nVenta As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento  
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fDiaContable >= @fInicio AND M.fDiaContable <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY ImporteT

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fDiaContable >= @fInicio AND N.fDiaContable <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
         END

         If @sOrden='Fechas'
          BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT  
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher, 
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               (SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0)))As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As IGV,--vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As OtrosTrib,--vDocumentoGrilla
               VM.nVenta As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento  
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fDiaContable >= @fInicio AND M.fDiaContable <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY M.fRegistro

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc


---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT 
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fDiaContable >= @fInicio AND N.fDiaContable <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
         END
    END


-----------SOLO-VENTAS----------
----------------------------


    If @flagRegVenta=1
      BEGIN

        If @sOrden='Correlativo'
           BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,  
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               (SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0)))As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As IGV,--vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As OtrosTrib,--vDocumentoGrilla
               VM.nVenta As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento  
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fDiaContable >= @fInicio AND M.fDiaContable <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (VT.RegistroVenta = 1) 
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY M.fRegistro,M.tDocumento

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc


---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT  
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fDiaContable >= @fInicio AND N.fDiaContable <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END


      If @sOrden='Montos'
         BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               (SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0)))As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As IGV,--vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As OtrosTrib,--vDocumentoGrilla
               VM.nVenta As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento  
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fDiaContable >= @fInicio AND M.fDiaContable <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (VT.RegistroVenta = 1)
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY ImporteT

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc


---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT 
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fDiaContable >= @fInicio AND N.fDiaContable <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
         END


       If @sOrden='Fechas'
         BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT 
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               (SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0)))As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As IGV,--vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As OtrosTrib,--vDocumentoGrilla
               VM.nVenta As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento  
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fDiaContable >= @fInicio AND M.fDiaContable <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (VT.RegistroVenta = 1)
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY M.fRegistro

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc


---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT  
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fDiaContable >= @fInicio AND N.fDiaContable <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Codigo FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END
    END
END


--------------------------------------
-------------------REDONDEO------------


If @flagRedondeo=1
 BEGIN

   If @flagRegVenta=0
      BEGIN

        If @sOrden='Correlativo'
           BEGIN

----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               ROUND((SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0))),2)As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               ROUND((SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento),2) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As IGV,--vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As OtrosTrib,--vDocumentoGrilla
               ROUND(VM.nVenta,2) As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento  
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fDiaContable >= @fInicio AND M.fDiaContable <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY M.fRegistro,M.tDocumento

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT  
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento 
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fDiaContable >= @fInicio AND N.fDiaContable <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END

        If @sOrden='Montos'
           BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               ROUND((SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0))),2)As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               ROUND((SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento),2) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As IGV,--vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As OtrosTrib,--vDocumentoGrilla
               ROUND(VM.nVenta,2) As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento  
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fDiaContable >= @fInicio AND M.fDiaContable <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY ImporteT
				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT  
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fDiaContable >= @fInicio AND N.fDiaContable <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
         END


         If @sOrden='Fechas'
          BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               ROUND((SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0))),2)As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               ROUND((SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento),2) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As IGV,--vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As OtrosTrib,--vDocumentoGrilla
               ROUND(VM.nVenta,2) As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento   
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fDiaContable >= @fInicio AND M.fDiaContable <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY M.fRegistro

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT  
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fDiaContable >= @fInicio AND N.fDiaContable <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito

----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END
    END


-----------SOLO-VENTAS----------
----------------------------

    If @flagRegVenta=1
      BEGIN

        If @sOrden='Correlativo'
           BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               ROUND((SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0))),2)As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               ROUND((SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento),2) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As IGV,--vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As OtrosTrib,--vDocumentoGrilla
               ROUND(VM.nVenta,2) As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento   
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fDiaContable >= @fInicio AND M.fDiaContable <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (VT.RegistroVenta = 1)
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY M.fRegistro,M.tDocumento

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT 
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento 
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fDiaContable >= @fInicio AND N.fDiaContable <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END

      If @sOrden='Montos'
         BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher, 
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               ROUND((SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0))),2)As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               ROUND((SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento),2) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As IGV,--vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As OtrosTrib,--vDocumentoGrilla
               ROUND(VM.nVenta,2) As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento  
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fDiaContable >= @fInicio AND M.fDiaContable <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (VT.RegistroVenta = 1)
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY ImporteT

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT 
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fDiaContable >= @fInicio AND N.fDiaContable <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
         END

       If @sOrden='Fechas'
         BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(M.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(M.fRegistro))),2)+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher,
               M.fRegistro As fEmision,
               M.fPago As fVencim, --mDocumento
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.ttipodocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero,---mDocumento
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               '0.00' As ValorFact, --vDocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               ROUND((SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0))),2)As BaseImOpGra,--dDocumento
               0 As Exonerada,--dDocumento
               ROUND((SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento),2) As Inafecta,--dDocumento
               '0.00' As ISC,----vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As IGV,--vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As OtrosTrib,--vDocumentoGrilla
               ROUND(VM.nVenta,2) As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum,M.tDocumento As Documento  
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fDiaContable >= @fInicio AND M.fDiaContable <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (VT.RegistroVenta = 1)
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora
            ORDER BY M.fRegistro

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT 
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(MONTH(N.fRegistro))),2)+RIGHT('0'+LTRIM(STR(DAY(N.fRegistro))),2)+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               N.fRegistro As fEmision, --vNotacredito
               N.fFecha As fVencim, --vNotacredito
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,--vNotacredito
               RIGHT(N.tNotaCredito,9) As Numero,----vNotacredito
              (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               '0.00' As ValorFact, ----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               0.00 As Exonerada,----vNotacredito
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               '0.00' As ISC,------vNotacredito
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nValorFactSuma,0 As nBaseImpGrabSum,0 As nExoneradaSum,0 As nInafectaSum,0 As nISCSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum, N.tNotaCredito As Documento
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fDiaContable >= @fInicio AND N.fDiaContable <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.tNotaCredito
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1, Exonerada = Exonerada * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0, Exonerada = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END
    END
END
--------------VAN --VIENEN----------------------------
				SELECT @numero=COUNT(*) FROM #DBTRANS
				WHILE @incre<=@numero
				BEGIN

					INSERT INTO #DBTRANSTEMP SELECT TOP 1 * FROM #DBTRANS 

					SELECT @tdocumento = Documento FROM #DBTRANSTEMP

					DELETE FROM #DBTRANS WHERE Documento = @tdocumento
                    ----------------------------
                    --------DESCUENTOS------------
--                    SELECT @PorcentD = Descuento FROM #DBTRANSTEMP
--                    UPDATE #DBTRANSTEMP SET BaseImOpGra = BaseImOpGra * @PorcentD, 
--                                    Inafecta = Inafecta * @PorcentD, IGV = IGV * @PorcentD,
--                                    OtrosTrib  = OtrosTrib * @PorcentD 
--                    WHERE Documento = @tdocumento 
--
--                     -------RECARGOS-------
--                    SELECT @PorcentR = Recargo FROM #DBTRANSTEMP
--                    UPDATE #DBTRANSTEMP SET BaseImOpGra = BaseImOpGra+(BaseImOpGra*@PorcentR), 
--                                    Inafecta = Inafecta+(Inafecta*@PorcentR), IGV = IGV+(IGV*@PorcentR),
--                                    OtrosTrib  = OtrosTrib+(OtrosTrib*@PorcentR)
--                    WHERE Documento = @tdocumento
                    ----------------------------

					UPDATE #DBTRANSTEMP SET nBaseImpGrabSum=@nBaseImpGrab,
						   nExoneradaSum=@nExonerada, nInafectaSum=@nInafecta, nIGVSum=@nIGV,
						   nOtrosTSum=@nOtrosT, nImportTSum=@nImportT
					WHERE Documento = @tdocumento

					SELECT @nBaseImpGrab = @nBaseImpGrab + ISNULL(BaseImOpGra,0),
						   @nExonerada = @nExonerada + ISNULL(Exonerada,0),
						   @nInafecta = @nInafecta + ISNULL(Inafecta,0),
						   @nIGV = @nIGV + ISNULL(IGV,0), 
						   @nOtrosT = @nOtrosT + ISNULL(OtrosTrib,0),
						   @nImportT = @nImportT + ISNULL(ImporteT,0)
					FROM #DBTRANSTEMP

					INSERT INTO #DBTRANSTEMP1 SELECT * FROM #DBTRANSTEMP

					DELETE FROM #DBTRANSTEMP

					SET @incre=@incre+1

				END
----------------------------------------------------------------------------------
SELECT Voucher, fEmision, fVencim, TDoc, Serie, Numero, Doc, NumeroR, RazonSocial, ValorFact, BaseImOpGra, Exonerada, Inafecta, ISC, IGV, OtrosTrib, ImporteT, TipoCambio, Fecha, TD, SerieN, NumeroN, nValorFactSuma, nBaseImpGrabSum, nExoneradaSum, nInafectaSum, nISCSum, nIGVSum, nOtrosTSum, nImportTSum,Documento  FROM #DBTRANSTEMP1
	
END
END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create  Proc USP_UpdateReplicado    
@WhereReplicado as Varchar(4000),    
@TablaReplicado as varchar(20)    
AS    
begin

Declare @Query as NVARCHAR(4000)    
Set @Query = N'Update ' + @TablaReplicado + N' Set lReplica = 0 Where ' + @WhereReplicado    
exec sp_executesql @Query     

End
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


CREATE PROCEDURE [DBO].[USP_LISTADOMENSAJES]
AS
BEGIN
	SELECT '('+convert(varchar,datepart(hh,getdate()-ffinal)*60+datepart(mi,getdate()-ffinal))+' min) '+ Mensaje from tmensajecocina where lactivo=1
END
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE [DBO].[USP_CERRAR_MENSAJES_CIERRETURNO](
	@usuario varchar(15),
	@tcaja varchar(3)
)
AS
BEGIN
	update tmensajecocina set lactivo = 0, ffinal = getdate(),tUsuarioFinal = @usuario  where lactivo = 1 and tcaja =@tcaja 
END
GO 
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE [DBO].[USP_AGREGARMENSAJE](
	@codigo varchar(8),
	@usuario  varchar(15),
	@mensaje  varchar(30),
	@tcaja varchar(3),
	@lactivo  bit
)
AS 
BEGIN
		set @mensaje = upper(ltrim(rtrim(@mensaje)))
		insert into tmensajecocina values(@codigo,@usuario,@mensaje,getdate(),getdate(),@usuario,@tcaja,@lactivo)
END
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE [DBO].[USP_MODIFICARMENSAJE](
	@usuario varchar(15),
	@codigo varchar(8),
	@mensaje varchar(30),
	@tcaja varchar(3),
	@lactivo bit
)
AS
BEGIN
	set @mensaje = upper(ltrim(rtrim(@mensaje)))
	update tmensajecocina set mensaje=@mensaje,ffinal=getdate(),lactivo=@lactivo,tUsuarioFinal=@usuario
		where codigo=@codigo 
END
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE [DBO].[USP_LISTARMENSAJES](
	@fechaini datetime,
	@fechafin datetime,
	@tcaja varchar(3)
)
AS 
set nocount on 
BEGIN
	IF @tcaja = '' 
		BEGIN
			select codigo,tusuarioreg,mensaje,convert(varchar,fregistro,120)as fRegistro,convert(varchar,ffinal,120) as ffinal,
			tusuariofinal,tCaja,lactivo from tmensajeCocina 
			WHERE (FREGISTRO >= @fechaini AND FREGISTRO <= @fechafin) 
		END
	ELSE
		BEGIN 
			select codigo,tusuarioreg,mensaje,convert(varchar,fregistro,120)as fRegistro,convert(varchar,ffinal,120) as ffinal,
			tusuariofinal,tCaja,lactivo from tmensajeCocina 
			WHERE tcaja = @tcaja
		END

END
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO
CREATE PROCEDURE [DBO].[USP_ELIMINARRMENSAJES](
	@tCODIGO varchar(8)
)
AS 
set nocount on 
BEGIN

	DELETE FROM tmensajeCocina WHERE CODIGO=@TCODIGO
END
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO
CREATE PROCEDURE [dbo].[USP_MODIFICARINSUMOS](
	@CODIGO VARCHAR(8),
	@USUARIO VARCHAR(15),--
	@DESCRIPCION VARCHAR(50),--
	@TCAJA VARCHAR(3),--
	@ACTIVO BIT,--
	@NSTOCK FLOAT,--
	@MODULO BIT ,
	@LINSUMO BIT
)
AS
BEGIN 
	SET  @DESCRIPCION = UPPER(LTRIM(RTRIM(@DESCRIPCION)))
	IF @MODULO = 1
		BEGIN
			UPDATE TINSUMO SET DESCRIPCION = @DESCRIPCION,NSTOCK = @NSTOCK, TUSUARIOMODIFICACION = @USUARIO, TCAJAMODIFICACION = @TCAJA,LACTIVO = @ACTIVO, LINSUMO=@LINSUMO,
			FMODIFICACION = GETDATE()		
			WHERE TCODIGO = @CODIGO
		END
	ELSE
		BEGIN
			UPDATE TINSUMO SET DESCRIPCION = @DESCRIPCION,TUSUARIOMODIFICACION = @USUARIO, TCAJAMODIFICACION = @TCAJA,LACTIVO = @ACTIVO,LINSUMO=@LINSUMO,
			FMODIFICACION = GETDATE()
			WHERE TCODIGO = @CODIGO
		END	
END
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO
CREATE PROCEDURE [dbo].[USP_LISTARINSUMOS](
@MODULO BIT
)
AS
SET NOCOUNT ON
	/*
		@MODULO 1 : INFOREST 
		@MODULO 0 : ADMISNITRACION
	*/
BEGIN 
	IF @MODULO = 1 
		BEGIN		
			SELECT TCODIGO,TUSUARIOREG,DESCRIPCION,NSTOCK,FREGISTRO,TCAJAREG,TUSUARIOMODIFICACION,
					FMODIFICACION,TCAJAMODIFICACION,LACTIVO,LINSUMO
			FROM
					TINSUMO
			ORDER 
				BY DESCRIPCION
		END
	ELSE 
		BEGIN
			SELECT TCODIGO,TUSUARIOREG,DESCRIPCION,FREGISTRO,TCAJAREG,TUSUARIOMODIFICACION,
					FMODIFICACION,TCAJAMODIFICACION,LACTIVO,LINSUMO
			FROM 	
					TINSUMO
			ORDER 
				BY DESCRIPCION
		END
END
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO
CREATE PROCEDURE [dbo].[USP_AGREGARINSUMOS](
	@CODIGO VARCHAR(8),
	@USUARIO VARCHAR(15),
	@DESCRIPCION VARCHAR(50),
	@NSTOCK FLOAT,
	@TCAJA VARCHAR(3),
	@ACTIVO BIT,
	@INSUMO BIT
)
AS 
BEGIN 
	SET @DESCRIPCION = UPPER(LTRIM(RTRIM(@DESCRIPCION)))
	INSERT INTO TINSUMO VALUES (@CODIGO,@DESCRIPCION,@NSTOCK,@USUARIO,GETDATE(),@TCAJA,@USUARIO,GETDATE(),@TCAJA,@ACTIVO,@INSUMO)
END
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE [dbo].[USP_ELIMINARINSUMOS](
	@CODIGO VARCHAR(8)
)
AS
BEGIN 
	DELETE FROM TINSUMO WHERE TCODIGO= @CODIGO
END
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create function sgsnet_sps_split    
/*********************************************************************************************    

* Autor Creacin  : RN    
* Fecha Creacin  : 25/07/2006    
***********************************************************************************************    

***********************************************************************************************/    
(    
@cadena    VARCHAR(8000),    
@delimitador   CHAR(1),    
@vezAparicion     INT    
)    
RETURNS VARCHAR(255)    
AS    
BEGIN    
 DECLARE @resultado VARCHAR(255)    
    DECLARE @indice INT    
    DECLARE @nroAparicion INT    
    DECLARE @valor varchar(4000)    
    SELECT @indice = 1    
    SELECT @nroAparicion=1    
    IF @cadena IS NULL     
    BEGIN    
  SET @resultado=''     
 RETURN @resultado    
    END    
    WHILE @indice !=0    
        BEGIN     
         -- indice de la 1era ocurrencia del delimitador    
         SELECT @indice = CHARINDEX(@delimitador,@cadena)    
         IF @indice !=0    
			BEGIN    
   --saca el valor antes del indice    
				SELECT @valor = LEFT(@cadena,@indice - 1)    
			END    
         ELSE    
          SELECT @valor = @cadena    
		IF @nroAparicion=@vezAparicion     
			BEGIN    
			SET @resultado= @valor     
			RETURN @resultado    
		END    
		SET @nroAparicion=@nroAparicion+1    
  --elimina la cadena ya extraida     
         SELECT @cadena = RIGHT(@cadena,LEN(@cadena) - @indice)    
         IF LEN(@cadena) = 0 SET @indice=1    
     END    
 RETURN @resultado    
END    

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROC USP_actualizaStockInsumo
(

	@vi_detalles varchar(4000) ,
	@vi_numdet	int ,
	@vch_Salida      nvarchar(50) OUTPUT
)

AS
BEGIN
 BEGIN TRANSACTION
SET NOCOUNT on
--BEGIN TRY

	        DECLARE @codigoInsumo VARCHAR(8)
			declare @cantidad	float
			declare @vl_contador INT
			declare @vl_item varchar(MAX)
			declare @stockactual float
			DECLARE @vchMsgError    varchar(100)
			  set @vl_contador = 1     ;  
			  while (@vl_contador <= @vi_numdet)        
			  begin        
			   --Obteniendo datos        
 	   select @vl_item = dbo.[sgsnet_sps_split](@vi_detalles, '$', @vl_contador);        
			        
			   select @codigoInsumo = dbo.[sgsnet_sps_split](@vl_item, '|', 1);        
			   select @cantidad = CAST(dbo.[sgsnet_sps_split](@vl_item, '|', 2) AS float)           ;
			
				select @stockactual=nstock from tinsumo where tcodigo=@codigoinsumo
			
				if @stockactual-@cantidad<0 
 
					BEGIN
						  ROLLBACK TRANSACTION
--						  SET @vchMsgError = 'No hay StockDisponible'
						set @vch_Salida=(select descripcion from tinsumo where tcodigo=@codigoinsumo)
--						  RAISERROR(@vchMsgError,16,1)
  					     RETURN(-1)
   
					end
				else
					begin
					set @vch_Salida='1'
					update tinsumo set nstock=@stockactual-@cantidad where tcodigo=@codigoinsumo
					end
			   set @vl_contador = @vl_contador + 1;        
			  end;
     COMMIT TRANSACTION
-- END TRY
--BEGIN CATCH
--ROLLBACK
--END CATCH
END

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO   




SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create PROC [dbo].[usp_GenInsertarDiaContable] 
 @tUsuario as nVarchar(15),
 @fDiaContable as datetime 
as 
begin
insert into tdiacontable(fdiacontable,lapertura,lcierre,tusuario,fregistro) values(convert(nvarchar,@fDiaContable,112),1,0,@tUsuario,getdate())

end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create PROC [dbo].[usp_GenObtieneDiaContable] 
 @lDiaContable as bit , --1=automatico 0=manual
 @sHoraCierre as nvarchar(5), --por si es automatico
 @tUsuario as nVarchar(15),
 @fDiaContable as datetime output
as 
begin
 
set @fDiaContable=(select max(fDiaContable) from tdiacontable where lCierre=0)

if @lDiaContable=1 --automatico
begin
	if (@fDiaContable is null) -- no hay datos
			begin 
				if convert(nvarchar,getdate(),108)>@sHoraCierre --hora actual mayor a la hora de cierre automatico
							begin
								insert into tdiacontable(fdiacontable,lapertura,lcierre,tusuario,fregistro) values(convert(nvarchar,getdate(),112),1,0,@tUsuario,getdate())
								set @fDiaContable=convert(nvarchar,getdate(),112)
							end
				else
							begin
								insert into tdiacontable(fdiacontable,lapertura,lcierre,tusuario,fregistro) values(convert(nvarchar,getdate()-1,112),1,0,@tUsuario,getdate())
								set @fDiaContable=convert(nvarchar,getdate()-1,112)
							end
			end
	else
			begin
				if convert(nvarchar,getdate(),108)>@sHoraCierre --hora actual mayor a la hora de cierre automatico
					begin
						if convert(nvarchar,getdate(),112)>@fDiaContable
							begin
								update tdiacontable set lcierre=1, tusuariocierre=@tusuario,fregistrocierre=getdate() where fdiacontable=@fdiacontable AND LCIERRE=0
								insert into tdiacontable(fdiacontable,lapertura,lcierre,tusuario,fregistro) values(convert(nvarchar,getdate(),112),1,0,@tUsuario,getdate())
								set @fDiaContable=convert(nvarchar,getdate(),112)
							end 
					end 
			end
end
if @lDiaContable=0 --manual
begin
	if (@fDiaContable is null) -- no hay datos
			begin 
								set @fdiacontable='19900101'
			
			end
end 
select @fDiaContable
end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create procedure [dbo].[ups_ObtieneFechaHora]
as
BEGIN
select getdate()
END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE [dbo].[spRep_RegVentaSunatAD]
@fInicio As smalldatetime,
@fFinal As smalldatetime,
@tCliente As nvarchar(20),
@tTipoDoc As nvarchar(20),
@tEstadoDoc As nvarchar(20),
@tCaja As nvarchar(5),
@sOrden As nvarchar(140),
@flagRegVenta As bit,
@flagRedondeo As bit,
@DiaContable As bit

AS
BEGIN 
SET NOCOUNT ON 
DECLARE @sNC nVarchar(10)
DECLARE @sEstDoc nVarchar(10)

CREATE TABLE #DBTRANS (Voucher nVarchar(50),fEmision nVarchar(50) collate Modern_Spanish_CI_AS, fVencim nVarchar(50) collate Modern_Spanish_CI_AS,TDoc nVarchar(4) collate Modern_Spanish_CI_AS, Serie nVarchar(50) collate Modern_Spanish_CI_AS,Numero1 nVarchar(50) collate Modern_Spanish_CI_AS,Numero2 nVarchar(50) collate Modern_Spanish_CI_AS,Doc nVarchar(2) collate Modern_Spanish_CI_AS, NumeroR nVarchar(50) collate Modern_Spanish_CI_AS,RazonSocial nVarchar(100) collate Modern_Spanish_CI_AS,Descuento Float,Recargo Float,BaseImOpGra Float, Inafecta Float,IGV Float, OtrosTrib Float, ImporteT Float, TipoCambio Float,Fecha nVarchar(50),TD nVarchar(4) collate Modern_Spanish_CI_AS,SerieN nVarchar(50) collate Modern_Spanish_CI_AS,NumeroN nVarchar(50) collate Modern_Spanish_CI_AS, tTemporal nVarchar(50) collate Modern_Spanish_CI_AS,nBaseImpGrabSum float,nInafectaSum float,nIGVSum float,nOtrosTSum float,nImportTSum float)	
CREATE TABLE #DBTRANSTEMP (Voucher nVarchar(50),fEmision nVarchar(50) collate Modern_Spanish_CI_AS, fVencim nVarchar(50) collate Modern_Spanish_CI_AS,TDoc nVarchar(4) collate Modern_Spanish_CI_AS, Serie nVarchar(50) collate Modern_Spanish_CI_AS,Numero1 nVarchar(50) collate Modern_Spanish_CI_AS,Numero2 nVarchar(50) collate Modern_Spanish_CI_AS,Doc nVarchar(2) collate Modern_Spanish_CI_AS, NumeroR nVarchar(50) collate Modern_Spanish_CI_AS,RazonSocial nVarchar(100) collate Modern_Spanish_CI_AS,Descuento Float,Recargo Float,BaseImOpGra Float, Inafecta Float,IGV Float, OtrosTrib Float, ImporteT Float, TipoCambio Float,Fecha nVarchar(50),TD nVarchar(4) collate Modern_Spanish_CI_AS,SerieN nVarchar(50) collate Modern_Spanish_CI_AS,NumeroN nVarchar(50) collate Modern_Spanish_CI_AS, tTemporal nVarchar(50) collate Modern_Spanish_CI_AS,nBaseImpGrabSum float,nInafectaSum float,nIGVSum float,nOtrosTSum float,nImportTSum float)	
CREATE TABLE #DBTRANSTEMP1 (Voucher nVarchar(50),fEmision nVarchar(50) collate Modern_Spanish_CI_AS, fVencim nVarchar(50) collate Modern_Spanish_CI_AS,TDoc nVarchar(4) collate Modern_Spanish_CI_AS, Serie nVarchar(50) collate Modern_Spanish_CI_AS,Numero1 nVarchar(50) collate Modern_Spanish_CI_AS,Numero2 nVarchar(50) collate Modern_Spanish_CI_AS,Doc nVarchar(2) collate Modern_Spanish_CI_AS, NumeroR nVarchar(50) collate Modern_Spanish_CI_AS,RazonSocial nVarchar(100) collate Modern_Spanish_CI_AS,Descuento Float,Recargo Float,BaseImOpGra Float, Inafecta Float,IGV Float, OtrosTrib Float, ImporteT Float, TipoCambio Float,Fecha nVarchar(50),TD nVarchar(4) collate Modern_Spanish_CI_AS,SerieN nVarchar(50) collate Modern_Spanish_CI_AS,NumeroN nVarchar(50) collate Modern_Spanish_CI_AS, tTemporal nVarchar(50) collate Modern_Spanish_CI_AS,nBaseImpGrabSum float,nInafectaSum float,nIGVSum float,nOtrosTSum float,nImportTSum float)	
CREATE TABLE #DBTRANSTEMP2 (Voucher nVarchar(50),fEmision nVarchar(50) collate Modern_Spanish_CI_AS, fVencim nVarchar(50) collate Modern_Spanish_CI_AS,TDoc nVarchar(4) collate Modern_Spanish_CI_AS, Serie nVarchar(50) collate Modern_Spanish_CI_AS,Numero1 nVarchar(50) collate Modern_Spanish_CI_AS,Numero2 nVarchar(50) collate Modern_Spanish_CI_AS,Doc nVarchar(2) collate Modern_Spanish_CI_AS, NumeroR nVarchar(50) collate Modern_Spanish_CI_AS,RazonSocial nVarchar(100) collate Modern_Spanish_CI_AS,Descuento Float,Recargo Float,BaseImOpGra Float, Inafecta Float,IGV Float, OtrosTrib Float, ImporteT Float, TipoCambio Float,Fecha nVarchar(50),TD nVarchar(4) collate Modern_Spanish_CI_AS,SerieN nVarchar(50) collate Modern_Spanish_CI_AS,NumeroN nVarchar(50) collate Modern_Spanish_CI_AS, tTemporal nVarchar(50) collate Modern_Spanish_CI_AS,nBaseImpGrabSum float,nInafectaSum float,nIGVSum float,nOtrosTSum float,nImportTSum float)	
CREATE TABLE #DBTRANSTEMP3 (Voucher nVarchar(50),fEmision nVarchar(50) collate Modern_Spanish_CI_AS, fVencim nVarchar(50) collate Modern_Spanish_CI_AS,TDoc nVarchar(4) collate Modern_Spanish_CI_AS, Serie nVarchar(50) collate Modern_Spanish_CI_AS,Numero1 nVarchar(50) collate Modern_Spanish_CI_AS,Numero2 nVarchar(50) collate Modern_Spanish_CI_AS,Doc nVarchar(2) collate Modern_Spanish_CI_AS, NumeroR nVarchar(50) collate Modern_Spanish_CI_AS,RazonSocial nVarchar(100) collate Modern_Spanish_CI_AS,Descuento Float,Recargo Float,BaseImOpGra Float, Inafecta Float,IGV Float, OtrosTrib Float, ImporteT Float, TipoCambio Float,Fecha nVarchar(50),TD nVarchar(4) collate Modern_Spanish_CI_AS,SerieN nVarchar(50) collate Modern_Spanish_CI_AS,NumeroN nVarchar(50) collate Modern_Spanish_CI_AS, tTemporal nVarchar(50) collate Modern_Spanish_CI_AS,nBaseImpGrabSum float,nInafectaSum float,nIGVSum float,nOtrosTSum float,nImportTSum float)	

			DECLARE @nBaseImpGrab As float
			DECLARE @nInafecta As float
			DECLARE @nIGV As float
			DECLARE @nOtrosT As float
			DECLARE @nImportT As float
            DECLARE @numero As float
            DECLARE @incre As float
            DECLARE @tDocumento As nVarchar(50)
            DECLARE @PorcentD float
            DECLARE @PorcentR float

            DECLARE @numero1 As float
            DECLARE @incre1 As float
            DECLARE @tDocumento1 As nVarchar(50)
			DECLARE @nBaseImpGrab1 As float
			DECLARE @nInafecta1 As float
			DECLARE @nIGV1 As float
			DECLARE @nOtrosT1 As float
			DECLARE @nImportT1 As float

            set @numero1 = 0
			set @incre1 = 0
            set @numero = 0
			set @incre = 0			
			Set @nBaseImpGrab = 0
			Set @nInafecta = 0
			Set @nIGV = 0
			Set @nOtrosT = 0
			Set @nImportT = 0
            Set @PorcentD = 0
            Set @PorcentR = 0

			Set @nBaseImpGrab1 = 0
			Set @nInafecta1 = 0
			Set @nIGV1 = 0
			Set @nOtrosT1 = 0
			Set @nImportT1 = 0


If @DiaContable=0
BEGIN

If @flagRedondeo=0
 BEGIN
 
   If @flagRegVenta=0
      BEGIN

        If @sOrden='Correlativo'
           BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+LTRIM(STR(MONTH(M.fRegistro)))+LTRIM(STR(DAY(M.fRegistro)))+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher, 
               CONVERT(NVARCHAR, M.fRegistro, 103) As fEmision,
               CONVERT(NVARCHAR, M.fPago, 103) As fVencim,
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.tTipoDocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero1 = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero1,---mDocumento
               '' As Numero2,
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               (SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0)))As BaseImOpGra,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento) As Inafecta,--dDocumento
               (SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As IGV,--vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As OtrosTrib,--vDocumentoGrilla
               VM.nVenta As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' ' As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nBaseImpGrabSum,0 As nInafectaSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora,M.tCodigoCliente
            ORDER BY M.fRegistro

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+LTRIM(STR(MONTH(N.fRegistro)))+LTRIM(STR(DAY(N.fRegistro)))+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               CONVERT(NVARCHAR, N.fRegistro, 103) As fEmision,
               CONVERT(NVARCHAR, N.fFecha, 103) As fVencim,               
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,
               RIGHT(N.tNotaCredito,9) As Numero1,----vNotacredito
               '' As Numero2,
               (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nBaseImpGrabSum,0 As nInafectaSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum  
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   INNER JOIN dDocumento D
                   ON D.tDocumento = N.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fFecha >= @fInicio AND N.fFecha <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.fRegistro
----------------------------------------------------------------------

				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'

				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END

    END


-----------SOLO-VENTAS----------
----------------------------


    If @flagRegVenta=1
      BEGIN

        If @sOrden='Correlativo'
           BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+LTRIM(STR(MONTH(M.fRegistro)))+LTRIM(STR(DAY(M.fRegistro)))+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher, 
               CONVERT(NVARCHAR, M.fRegistro, 103) As fEmision,
               CONVERT(NVARCHAR, M.fPago, 103) As fVencim,
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.tTipoDocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero1 = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero1,---mDocumento
               '' As Numero2,
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               (SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0)))As BaseImOpGra,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento) As Inafecta,--dDocumento
               (SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As IGV,--vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As OtrosTrib,--vDocumentoGrilla
               VM.nVenta As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nBaseImpGrabSum,0 As nInafectaSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (VT.RegistroVenta = 1) 
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora,M.tCodigoCliente
            ORDER BY M.fRegistro

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc


---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT  
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+LTRIM(STR(MONTH(N.fRegistro)))+LTRIM(STR(DAY(N.fRegistro)))+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               CONVERT(NVARCHAR, N.fRegistro, 103) As fEmision,
               CONVERT(NVARCHAR, N.fFecha, 103) As fVencim,
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,
               RIGHT(N.tNotaCredito,9) As Numero1,----vNotacredito
               '' As Numero2,
               (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nBaseImpGrabSum,0 As nInafectaSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum  
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fFecha >= @fInicio AND N.fFecha <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.fRegistro
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END
    END
END


--------------------------------------
-------------------REDONDEO------------


If @flagRedondeo=1
 BEGIN

   If @flagRegVenta=0
      BEGIN

        If @sOrden='Correlativo'
           BEGIN

----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+LTRIM(STR(MONTH(M.fRegistro)))+LTRIM(STR(DAY(M.fRegistro)))+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher, 
               CONVERT(NVARCHAR, M.fRegistro, 103) As fEmision,
               CONVERT(NVARCHAR, M.fPago, 103) As fVencim,
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.tTipoDocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero1 = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero1,---mDocumento
               '' As Numero2,
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               ROUND((SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0))),2)As BaseImOpGra,--dDocumento
               ROUND((SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento),2) As Inafecta,--dDocumento
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As IGV,--vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As OtrosTrib,--vDocumentoGrilla
               ROUND(VM.nVenta,2) As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' ' As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nBaseImpGrabSum,0 As nInafectaSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora,M.tCodigoCliente
            ORDER BY M.fRegistro

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT  
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+LTRIM(STR(MONTH(N.fRegistro)))+LTRIM(STR(DAY(N.fRegistro)))+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               CONVERT(NVARCHAR, N.fRegistro, 103) As fEmision,
               CONVERT(NVARCHAR, N.fFecha, 103) As fVencim,
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,
               RIGHT(N.tNotaCredito,9) As Numero1,
               '' As Numero2,
               (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nBaseImpGrabSum,0 As nInafectaSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum  
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fFecha >= @fInicio AND N.fFecha <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.fRegistro
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END
    END


-----------SOLO-VENTAS----------
----------------------------

    If @flagRegVenta=1
      BEGIN

        If @sOrden='Correlativo'
           BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+LTRIM(STR(MONTH(M.fRegistro)))+LTRIM(STR(DAY(M.fRegistro)))+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher, 
               CONVERT(NVARCHAR, M.fRegistro, 103) As fEmision,
               CONVERT(NVARCHAR, M.fPago, 103) As fVencim,
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.tTipoDocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero1 = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero1,---mDocumento
               '' As Numero2,
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               ROUND((SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0))),2)As BaseImOpGra,--dDocumento
               ROUND((SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento),2) As Inafecta,--dDocumento
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As IGV,--vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As OtrosTrib,--vDocumentoGrilla
               ROUND(VM.nVenta,2) As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nBaseImpGrabSum,0 As nInafectaSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (VT.RegistroVenta = 1)
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora,M.tCodigoCliente
            ORDER BY M.fRegistro

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT 
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+LTRIM(STR(MONTH(N.fRegistro)))+LTRIM(STR(DAY(N.fRegistro)))+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               CONVERT(NVARCHAR, N.fRegistro, 103) As fEmision,
               CONVERT(NVARCHAR, N.fFecha, 103) As fVencim,
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,
               RIGHT(N.tNotaCredito,9) As Numero1,
               '' As Numero2,
               (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nBaseImpGrabSum,0 As nInafectaSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fFecha >= @fInicio AND N.fFecha <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.fRegistro
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END
    END

  END


--------------VAN --VIENEN----------------------------
				SELECT @numero=COUNT(*) FROM #DBTRANS
				WHILE @incre<=@numero
				BEGIN
					INSERT INTO #DBTRANSTEMP SELECT TOP 1 * FROM #DBTRANS

					SELECT @tdocumento = Numero1+Voucher FROM #DBTRANSTEMP

					DELETE FROM #DBTRANS WHERE Numero1+Voucher = @tdocumento
                    ----------------------------
                    --------DESCUENTOS------------
--                    SELECT @PorcentD = Descuento FROM #DBTRANSTEMP
--                    UPDATE #DBTRANSTEMP SET BaseImOpGra = BaseImOpGra * @PorcentD, 
--                                    Inafecta = Inafecta * @PorcentD, IGV = IGV * @PorcentD,
--                                    OtrosTrib  = OtrosTrib * @PorcentD 
--                    WHERE Numero1+Voucher = @tdocumento 
--
--                     -------RECARGOS-------
--                    SELECT @PorcentR = Recargo FROM #DBTRANSTEMP
--                    UPDATE #DBTRANSTEMP SET BaseImOpGra = BaseImOpGra+(BaseImOpGra*@PorcentR), 
--                                    Inafecta = Inafecta+(Inafecta*@PorcentR), IGV = IGV+(IGV*@PorcentR),
--                                    OtrosTrib  = OtrosTrib+(OtrosTrib*@PorcentR)
--                    WHERE Numero1+Voucher = @tdocumento
                    ----------------------------

					UPDATE #DBTRANSTEMP SET nBaseImpGrabSum=@nBaseImpGrab,
						   nInafectaSum=@nInafecta, nIGVSum=@nIGV,
						   nOtrosTSum=@nOtrosT, nImportTSum=@nImportT
					WHERE Numero1+TDoc+Doc = @tdocumento

					SELECT @nBaseImpGrab = @nBaseImpGrab + ISNULL(BaseImOpGra,0),
						   @nInafecta = @nInafecta + ISNULL(Inafecta,0),
						   @nIGV = @nIGV + ISNULL(IGV,0), 
						   @nOtrosT = @nOtrosT + ISNULL(OtrosTrib,0),
						   @nImportT = @nImportT + ISNULL(ImporteT,0)
					FROM #DBTRANSTEMP

					INSERT INTO #DBTRANSTEMP1 SELECT * FROM #DBTRANSTEMP

					DELETE FROM #DBTRANSTEMP

					SET @incre=@incre+1

				END
----------------------------REPORTE AD---------------------------------------
 
				INSERT INTO #DBTRANSTEMP2 SELECT * FROM #DBTRANSTEMP1 WHERE NumeroR is null AND TDoc <> '07' 

				DELETE FROM #DBTRANSTEMP1 
				WHERE Numero1+Voucher in (SELECT Numero1+Voucher  FROM #DBTRANSTEMP2)
				 				 

				INSERT INTO #DBTRANSTEMP1 SELECT MAX(Voucher),CONVERT(NVARCHAR, fEmision, 103) As fEmision,'' As fVencim,TDoc, Serie,MIN(Numero1) As Numero1,MAX(Numero1)As Numero2,
				'' As Doc, '' As NumeroR,'' As RazonSocial,SUM(Descuento) As Descuento,SUM(Recargo) As Recargo,
				SUM(BaseImOpGra) As BaseImOpGra,SUM(Inafecta) As Inafecta, SUM(IGV) AS IGV, SUM(OtrosTrib) As OtrosTrib, SUM(ImporteT) As ImporteT,
				TipoCambio As TipoCambio, '' As Fecha, '' As TD, '' As SerieN, '' As NumeroN,'' As tTemporal,
				SUM(nBaseImpGrabSum) As nBaseImpGrabSum, SUM(nInafectaSum) As nInafectaSum, SUM(nIGVSum) As nIGVSum, SUM(nOtrosTSum) As nOtrosTSum, SUM(nImportTSum) As nImportTSum 
				FROM #DBTRANSTEMP2
				GROUP BY
				CONVERT(NVARCHAR, fEmision, 103),TDoc, Serie, TipoCambio

-----------------------------------------------
				DELETE FROM #DBTRANSTEMP2
				UPDATE #DBTRANSTEMP1 SET nBaseImpGrabSum=0,nInafectaSum=0,nIGVSum=0,nOtrosTSum=0,nImportTSum=0 


				SELECT @numero1=COUNT(*) FROM #DBTRANSTEMP1
				WHILE @incre1<=@numero1
				BEGIN
					INSERT INTO #DBTRANSTEMP2 SELECT TOP 1 * FROM #DBTRANSTEMP1 ORDER BY SUBSTRING(fEmision,7,4),SUBSTRING(fEmision,4,2),SUBSTRING(fEmision,1,2),Serie,Numero1

					SELECT @tdocumento1 = Numero1+Voucher FROM #DBTRANSTEMP2

					DELETE FROM #DBTRANSTEMP1 WHERE Numero1+Voucher = @tdocumento1

					UPDATE #DBTRANSTEMP2 SET nBaseImpGrabSum=@nBaseImpGrab1,
						   nInafectaSum=@nInafecta1, nIGVSum=@nIGV1,
						   nOtrosTSum=@nOtrosT1, nImportTSum=@nImportT1
					WHERE Numero1+Voucher = @tdocumento1

					SELECT @nBaseImpGrab1 = @nBaseImpGrab1 + ISNULL(BaseImOpGra,0),
						   @nInafecta1 = @nInafecta1 + ISNULL(Inafecta,0),
						   @nIGV1 = @nIGV1 + ISNULL(IGV,0), 
						   @nOtrosT1 = @nOtrosT1 + ISNULL(OtrosTrib,0),
						   @nImportT1 = @nImportT1 + ISNULL(ImporteT,0)
					FROM #DBTRANSTEMP2

					INSERT INTO #DBTRANSTEMP3 SELECT * FROM #DBTRANSTEMP2

					DELETE FROM #DBTRANSTEMP2

					SET @incre1=@incre1+1

				END 
------------------------------------------------------------------------------------------------
SELECT fEmision, fVencim, TDoc, Serie, Numero1, Numero2, Doc, NumeroR, RazonSocial, BaseImOpGra, Inafecta, IGV, OtrosTrib, ImporteT, TipoCambio, Fecha, TD, SerieN, NumeroN, nBaseImpGrabSum, nInafectaSum, nIGVSum, nOtrosTSum, nImportTSum  FROM #DBTRANSTEMP3
ORDER BY SUBSTRING(fEmision,7,4),SUBSTRING(fEmision,4,2),SUBSTRING(fEmision,1,2),Serie,Numero1
END









--------DIA_CONTABLE----


If @DiaContable=1
BEGIN

If @flagRedondeo=0
 BEGIN
 
   If @flagRegVenta=0
      BEGIN

        If @sOrden='Correlativo'
           BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+LTRIM(STR(MONTH(M.fRegistro)))+LTRIM(STR(DAY(M.fRegistro)))+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher, 
               CONVERT(NVARCHAR, M.fRegistro, 103) As fEmision,
               CONVERT(NVARCHAR, M.fPago, 103) As fVencim,
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.tTipoDocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero1 = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero1,---mDocumento
               '' As Numero2,
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               (SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0)))As BaseImOpGra,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento) As Inafecta,--dDocumento
               (SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As IGV,--vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As OtrosTrib,--vDocumentoGrilla
               VM.nVenta As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' ' As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nBaseImpGrabSum,0 As nInafectaSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fDiaContable >= @fInicio AND M.fDiaContable <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora,M.tCodigoCliente
            ORDER BY M.fRegistro

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+LTRIM(STR(MONTH(N.fRegistro)))+LTRIM(STR(DAY(N.fRegistro)))+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               CONVERT(NVARCHAR, N.fRegistro, 103) As fEmision,
               CONVERT(NVARCHAR, N.fFecha, 103) As fVencim,               
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,
               RIGHT(N.tNotaCredito,9) As Numero1,----vNotacredito
               '' As Numero2,
               (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nBaseImpGrabSum,0 As nInafectaSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum  
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   INNER JOIN dDocumento D
                   ON D.tDocumento = N.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fDiaContable >= @fInicio AND N.fDiaContable <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.fRegistro
----------------------------------------------------------------------

				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'

				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END

    END


-----------SOLO-VENTAS----------
----------------------------


    If @flagRegVenta=1
      BEGIN

        If @sOrden='Correlativo'
           BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+LTRIM(STR(MONTH(M.fRegistro)))+LTRIM(STR(DAY(M.fRegistro)))+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher, 
               CONVERT(NVARCHAR, M.fRegistro, 103) As fEmision,
               CONVERT(NVARCHAR, M.fPago, 103) As fVencim,
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.tTipoDocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero1 = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero1,---mDocumento
               '' As Numero2,
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               (SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0)))As BaseImOpGra,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento) As Inafecta,--dDocumento
               (SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As IGV,--vDocumentoGrilla
               (SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento) As OtrosTrib,--vDocumentoGrilla
               VM.nVenta As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nBaseImpGrabSum,0 As nInafectaSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fDiaContable >= @fInicio AND M.fDiaContable <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (VT.RegistroVenta = 1) 
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora,M.tCodigoCliente
            ORDER BY M.fRegistro

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc


---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT  
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+LTRIM(STR(MONTH(N.fRegistro)))+LTRIM(STR(DAY(N.fRegistro)))+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               CONVERT(NVARCHAR, N.fRegistro, 103) As fEmision,
               CONVERT(NVARCHAR, N.fFecha, 103) As fVencim,
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,
               RIGHT(N.tNotaCredito,9) As Numero1,----vNotacredito
               '' As Numero2,
               (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nBaseImpGrabSum,0 As nInafectaSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum  
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fDiaContable >= @fInicio AND N.fDiaContable <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.fRegistro
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END
    END
END


--------------------------------------
-------------------REDONDEO------------


If @flagRedondeo=1
 BEGIN

   If @flagRegVenta=0
      BEGIN

        If @sOrden='Correlativo'
           BEGIN

----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+LTRIM(STR(MONTH(M.fRegistro)))+LTRIM(STR(DAY(M.fRegistro)))+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher, 
               CONVERT(NVARCHAR, M.fRegistro, 103) As fEmision,
               CONVERT(NVARCHAR, M.fPago, 103) As fVencim,
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.tTipoDocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero1 = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero1,---mDocumento
               '' As Numero2,
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               ROUND((SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0))),2)As BaseImOpGra,--dDocumento
               ROUND((SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento),2) As Inafecta,--dDocumento
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As IGV,--vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As OtrosTrib,--vDocumentoGrilla
               ROUND(VM.nVenta,2) As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' ' As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nBaseImpGrabSum,0 As nInafectaSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fDiaContable >= @fInicio AND M.fDiaContable <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora,M.tCodigoCliente
            ORDER BY M.fRegistro

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT  
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+LTRIM(STR(MONTH(N.fRegistro)))+LTRIM(STR(DAY(N.fRegistro)))+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               CONVERT(NVARCHAR, N.fRegistro, 103) As fEmision,
               CONVERT(NVARCHAR, N.fFecha, 103) As fVencim,
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,
               RIGHT(N.tNotaCredito,9) As Numero1,
               '' As Numero2,
               (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nBaseImpGrabSum,0 As nInafectaSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum  
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fDiaContable >= @fInicio AND N.fDiaContable <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.fRegistro
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END
    END


-----------SOLO-VENTAS----------
----------------------------

    If @flagRegVenta=1
      BEGIN

        If @sOrden='Correlativo'
           BEGIN
----------DOCUMENTOS----------
           INSERT INTO #DBTRANS 
            SELECT
               RIGHT(LTRIM(STR(YEAR(M.fRegistro))),2)+LTRIM(STR(MONTH(M.fRegistro)))+LTRIM(STR(DAY(M.fRegistro)))+'-'+RIGHT(LEFT(M.tDocumento,6),3)+RIGHT(M.tDocumento,5)As Voucher, 
               CONVERT(NVARCHAR, M.fRegistro, 103) As fEmision,
               CONVERT(NVARCHAR, M.fPago, 103) As fVencim,
               VT.Sunat As TDoc, --mDocumento
              (SELECT Serie = CASE M.tTipoDocumento WHEN '02' THEN M.tSerieImpresora
               ELSE LEFT(RIGHT(M.tDocumento,14),5) END) As Serie,---mDocumento
              (SELECT Numero1 = CASE M.tTipoDocumento WHEN '02' THEN LEFT(RIGHT(M.tDocumento,14),5)+ '-' +RIGHT(M.tDocumento,9)
               ELSE RIGHT(M.tDocumento,9) END) As Numero1,---mDocumento
               '' As Numero2,
              (SELECT Doc = CASE VM.tCodigoCliente WHEN ' ' THEN ' '
               ELSE '6' END) As Doc,---mDocumento
               C.RUC As NumeroR,--vDocumento
               VM.Cliente As RazonSocial,---DocumentoGrilla
               0 As Descuento,
               0 As Recargo,
               ROUND((SELECT SUM(D.nPrecioNeto*nCantidad)
               FROM dDocumento D
               WHERE D.tDocumento = M.tDocumento AND 
               ((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
                OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0))),2)As BaseImOpGra,--dDocumento
               ROUND((SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento),2) As Inafecta,--dDocumento
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto1,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As IGV,--vDocumentoGrilla
               ROUND((SELECT SUM(ISNULL(D.nPrecioImpuesto2,0)*D.nCantidad) FROM dDocumento D WHERE D.tDocumento = M.tDocumento),2) As OtrosTrib,--vDocumentoGrilla
               ROUND(VM.nVenta,2) As ImporteT, --vDocumentoGrilla
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               ' '  As Fecha, --vNotaCredito
               ' ' As TD, --NotaCredito
               ' ' As SerieN,---NotaCredito
               ' ' As NumeroN, ---NotaCredito
               M.tEstadoDocumento As tTemporal,
               0 As nBaseImpGrabSum,0 As nInafectaSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum
            FROM mDocumento M INNER JOIN vDocumentoGrilla VM
                 ON M.tDocumento = VM.tDocumento
                 INNER JOIN vDocumento C 
                 ON VM.tDocumento = C.tDocumento
                 INNER JOIN dDocumento D
                 ON M.tDocumento = D.tDocumento
                 LEFT JOIN  tTipoCambio T
                 ON CONVERT(VARCHAR,M.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                 INNER JOIN VtipoDocumento VT
                 ON M.tTipoDocumento = VT.Codigo
            WHERE (M.fDiaContable >= @fInicio AND M.fDiaContable <= @fFinal) 
                 AND (VM.tCodigoCliente=@tCliente OR @tCliente='') 
                 AND (M.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
                 AND (M.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                 AND (M.tCaja=@tCaja OR @tCaja='')
                 AND (VT.RegistroVenta = 1)
                 AND (M.tTipoDocumento<>'00')
            GROUP BY M.fRegistro,M.fPago,M.tTipodocumento,VM.tCodigoCliente,C.RUC,VM.Cliente,
                 VM.nVenta,D.tDocumento,M.tDocumento,T.nVenta,T.nOficial,VT.Sunat,
                 VM.nPrecioImpuesto1,VM.nPrecioImpuesto2,M.tEstadoDocumento,M.tSerieImpresora,M.tCodigoCliente
            ORDER BY M.fRegistro

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.mDocumento 
                ON dbo.#DBTRANS.tTemporal = dbo.mDocumento.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc

---------------NOTA CREDITO---------------
          INSERT INTO #DBTRANS 
           SELECT 
               RIGHT(LTRIM(STR(YEAR(N.fRegistro))),2)+LTRIM(STR(MONTH(N.fRegistro)))+LTRIM(STR(DAY(N.fRegistro)))+'-'+RIGHT(LEFT(N.tNotaCredito,6),3)+RIGHT(N.tNotacredito,5)As Voucher,  
               CONVERT(NVARCHAR, N.fRegistro, 103) As fEmision,
               CONVERT(NVARCHAR, N.fFecha, 103) As fVencim,
              (SELECT VT.Sunat FROM VTipoDocumento VT 
                WHERE Prefijo='N') As TDoc, ----vNotacredito
               LEFT(RIGHT(N.tNotaCredito,14),5) As Serie,
               RIGHT(N.tNotaCredito,9) As Numero1,
               '' As Numero2,
               (SELECT Doc = CASE ISNULL(N.Identidad,' ') WHEN ' ' THEN ' '
                ELSE '6' END) As Doc,-----vNotacredito
               N.Identidad As NumeroR,----vNotacredito
               N.Cliente As RazonSocial,-----vNotacredito
               0 As Descuento,
               0 As Recargo,
               N.nNeto As BaseImOpGra,--dDocumento
               (SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
               WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
               OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = N.tDocumento) As Inafecta,--dDocumento
               N.nImpuesto1 As IGV,--vDocumentoGrilla
               N.nImpuesto2 As OtrosTrib,--vDocumentoGrilla
               N.nVenta As ImporteT, ------vNotacredito
               (SELECT TipoCambio = CASE T.nOficial WHEN '0' THEN T.nVenta
                 ELSE T.nOficial END) As TipoCambio,---tTipoCambio
               CONVERT(NVARCHAR,M.fRegistro,103) As Fecha, --mDocumento
               (SELECT VT.sunat FROM VtipoDocumento VT
               WHERE VT.Codigo=M.tTipoDocumento) As TD, --mDocumento
               LEFT(RIGHT(M.tDocumento,14),5) As SerieN,---mDocumento
               RIGHT(M.tDocumento,9) As NumeroN, ---mDocumento
               N.tEstadoDocumento As tTemporal,
               0 As nBaseImpGrabSum,0 As nInafectaSum,0 As nIGVSum,0 As nOtrosTSum,0 As nImportTSum
             FROM vNotaCredito N LEFT JOIN  tTipoCambio T
                   ON CONVERT(VARCHAR,N.fRegistro,23)=CONVERT(VARCHAR,T.fFecha,23)
                   INNER JOIN mDocumento M 
                   ON N.tDocumento = M.tDocumento
                   LEFT JOIN tCliente C
                   ON N.Identidad = C.tIdentidad
             WHERE (N.fDiaContable >= @fInicio AND N.fDiaContable <= @fFinal) 
                   AND (C.tCodigoCliente=@tCliente OR @tCliente='') 
                   AND (@tTipoDoc='' OR @tTipoDoc='03' OR M.tTipoDocumento='03')
                   AND (N.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
                   AND (N.tCaja=@tCaja OR @tCaja='')
                   AND (M.tTipoDocumento<>'00')
             GROUP BY N.fRegistro,N.fFecha,N.tNotaCredito,N.Identidad,N.Cliente,
                      N.nNeto,N.nImpuesto1,N.nImpuesto2,N.nVenta,M.fRegistro,T.nOficial,
                      T.nVenta,M.tTipodocumento,M.tDocumento,N.tEstadoDocumento,N.tDocumento
             ORDER BY N.fRegistro
----------------------------------------------------------------------
				SELECT @sNc= Sunat FROM vTipoDocumento WHERE Prefijo='N'
		        
				UPDATE #DBTRANS SET BaseImOpGra = BaseImOpGra * -1,
							Inafecta = Inafecta * -1, IGV = IGV * -1, 
							OtrosTrib = OtrosTrib * -1, ImporteT = ImporteT * -1  
				WHERE TDoc = @sNC 

				UPDATE #DBTRANS SET NumeroR = dbo.vCliente.tIdentidad, RazonSocial = dbo.vCliente.Descripcion
				FROM dbo.#DBTRANS LEFT OUTER JOIN dbo.vCliente ON dbo.#DBTRANS.NumeroR = dbo.vCliente.tIdentidad
				WHERE dbo.#DBTRANS.TDoc = @sNC

				SELECT @sEstDoc= Codigo FROM vEstadoDocumento WHERE tResumido='ANULADO'
		        
				UPDATE #DBTRANS SET Doc='0',NumeroR=' ', RazonSocial='Anulado',
                                    BaseImOpGra = 0,
							        Inafecta = 0, IGV = 0, 
							        OtrosTrib = 0, ImporteT = 0
                FROM dbo.#DBTRANS 
                INNER JOIN dbo.vNotaCredito 
                ON dbo.#DBTRANS.tTemporal = dbo.vNotaCredito.tEstadoDocumento  
				WHERE dbo.#DBTRANS.tTemporal = @sEstDoc
        END
    END

  END


--------------VAN --VIENEN----------------------------
				SELECT @numero=COUNT(*) FROM #DBTRANS
				WHILE @incre<=@numero
				BEGIN
					INSERT INTO #DBTRANSTEMP SELECT TOP 1 * FROM #DBTRANS

					SELECT @tdocumento = Numero1+Voucher FROM #DBTRANSTEMP

					DELETE FROM #DBTRANS WHERE Numero1+Voucher = @tdocumento
                    ----------------------------
                    --------DESCUENTOS------------
--                    SELECT @PorcentD = Descuento FROM #DBTRANSTEMP
--                    UPDATE #DBTRANSTEMP SET BaseImOpGra = BaseImOpGra * @PorcentD, 
--                                    Inafecta = Inafecta * @PorcentD, IGV = IGV * @PorcentD,
--                                    OtrosTrib  = OtrosTrib * @PorcentD 
--                    WHERE Numero1+Voucher = @tdocumento 
--
--                     -------RECARGOS-------
--                    SELECT @PorcentR = Recargo FROM #DBTRANSTEMP
--                    UPDATE #DBTRANSTEMP SET BaseImOpGra = BaseImOpGra+(BaseImOpGra*@PorcentR), 
--                                    Inafecta = Inafecta+(Inafecta*@PorcentR), IGV = IGV+(IGV*@PorcentR),
--                                    OtrosTrib  = OtrosTrib+(OtrosTrib*@PorcentR)
--                    WHERE Numero1+Voucher = @tdocumento
                    ----------------------------

					UPDATE #DBTRANSTEMP SET nBaseImpGrabSum=@nBaseImpGrab,
						   nInafectaSum=@nInafecta, nIGVSum=@nIGV,
						   nOtrosTSum=@nOtrosT, nImportTSum=@nImportT
					WHERE Numero1+Voucher = @tdocumento

					SELECT @nBaseImpGrab = @nBaseImpGrab + ISNULL(BaseImOpGra,0),
						   @nInafecta = @nInafecta + ISNULL(Inafecta,0),
						   @nIGV = @nIGV + ISNULL(IGV,0), 
						   @nOtrosT = @nOtrosT + ISNULL(OtrosTrib,0),
						   @nImportT = @nImportT + ISNULL(ImporteT,0)
					FROM #DBTRANSTEMP

					INSERT INTO #DBTRANSTEMP1 SELECT * FROM #DBTRANSTEMP

					DELETE FROM #DBTRANSTEMP

					SET @incre=@incre+1

				END
----------------------------REPORTE AD---------------------------------------
 
				INSERT INTO #DBTRANSTEMP2 SELECT * FROM #DBTRANSTEMP1 WHERE NumeroR is null AND TDoc <> '07' 

				DELETE FROM #DBTRANSTEMP1 
				WHERE Numero1+Voucher in (SELECT Numero1+Voucher  FROM #DBTRANSTEMP2)
				 				 

				INSERT INTO #DBTRANSTEMP1 SELECT MAX(Voucher),CONVERT(NVARCHAR, fEmision, 103) As fEmision,'' As fVencim,TDoc, Serie,MIN(Numero1) As Numero1,MAX(Numero1)As Numero2,
				'' As Doc, '' As NumeroR,'' As RazonSocial,SUM(Descuento) As Descuento,SUM(Recargo) As Recargo,
				SUM(BaseImOpGra) As BaseImOpGra,SUM(Inafecta) As Inafecta, SUM(IGV) AS IGV, SUM(OtrosTrib) As OtrosTrib, SUM(ImporteT) As ImporteT,
				TipoCambio As TipoCambio, '' As Fecha, '' As TD, '' As SerieN, '' As NumeroN,'' As tTemporal,
				SUM(nBaseImpGrabSum) As nBaseImpGrabSum, SUM(nInafectaSum) As nInafectaSum, SUM(nIGVSum) As nIGVSum, SUM(nOtrosTSum) As nOtrosTSum, SUM(nImportTSum) As nImportTSum 
				FROM #DBTRANSTEMP2
				GROUP BY
				CONVERT(NVARCHAR, fEmision, 103),TDoc, Serie, TipoCambio

-----------------------------------------------
				DELETE FROM #DBTRANSTEMP2
				UPDATE #DBTRANSTEMP1 SET nBaseImpGrabSum=0,nInafectaSum=0,nIGVSum=0,nOtrosTSum=0,nImportTSum=0 


				SELECT @numero1=COUNT(*) FROM #DBTRANSTEMP1
				WHILE @incre1<=@numero1
				BEGIN
					INSERT INTO #DBTRANSTEMP2 SELECT TOP 1 * FROM #DBTRANSTEMP1 ORDER BY SUBSTRING(fEmision,7,4),SUBSTRING(fEmision,4,2),SUBSTRING(fEmision,1,2),Serie,Numero1

					SELECT @tdocumento1 = Numero1+Voucher FROM #DBTRANSTEMP2

					DELETE FROM #DBTRANSTEMP1 WHERE Numero1+Voucher = @tdocumento1

					UPDATE #DBTRANSTEMP2 SET nBaseImpGrabSum=@nBaseImpGrab1,
						   nInafectaSum=@nInafecta1, nIGVSum=@nIGV1,
						   nOtrosTSum=@nOtrosT1, nImportTSum=@nImportT1
					WHERE Numero1+Voucher = @tdocumento1

					SELECT @nBaseImpGrab1 = @nBaseImpGrab1 + ISNULL(BaseImOpGra,0),
						   @nInafecta1 = @nInafecta1 + ISNULL(Inafecta,0),
						   @nIGV1 = @nIGV1 + ISNULL(IGV,0), 
						   @nOtrosT1 = @nOtrosT1 + ISNULL(OtrosTrib,0),
						   @nImportT1 = @nImportT1 + ISNULL(ImporteT,0)
					FROM #DBTRANSTEMP2

					INSERT INTO #DBTRANSTEMP3 SELECT * FROM #DBTRANSTEMP2

					DELETE FROM #DBTRANSTEMP2

					SET @incre1=@incre1+1

				END 
------------------------------------------------------------------------------------------------
SELECT fEmision, fVencim, TDoc, Serie, Numero1, Numero2, Doc, NumeroR, RazonSocial, BaseImOpGra, Inafecta, IGV, OtrosTrib, ImporteT, TipoCambio, Fecha, TD, SerieN, NumeroN, nBaseImpGrabSum, nInafectaSum, nIGVSum, nOtrosTSum, nImportTSum  FROM #DBTRANSTEMP3
ORDER BY SUBSTRING(fEmision,7,4),SUBSTRING(fEmision,4,2),SUBSTRING(fEmision,1,2),Serie,Numero1
END
END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


CREATE PROCEDURE [dbo].[usp_Cheff_ObtenerResumenColores]   --'001',21
@AREA NVARCHAR(3), 
@total float
AS
begin

DECLARE @ENVIO BIT
SELECT @ENVIO = ISNULL(lEnvioChef,0) FROM TPARAMETRO
DECLARE @CANT INT
SELECT  @CANT = COUNT(*) FROM TAREACHEF WHERE lAREA=1

CREATE TABLE #DBTRANS (pedido nVarChar(15) collate Modern_Spanish_CI_AS, 
					   item  nVarChar(3) collate Modern_Spanish_CI_AS,
					   codigoProducto nVarChar(7) collate Modern_Spanish_CI_AS,
					   producto nVarChar(200) collate Modern_Spanish_CI_AS,
					   cantidad Float,
						estado nVarChar(1) collate Modern_Spanish_CI_AS)

CREATE TABLE #DBTRANS2
(
PRODUCTO nVarChar(200) collate Modern_Spanish_CI_AS,
					   cantidad Float)

BEGIN
print '1'


IF @CANT = 0

			INSERT INTO #DBTRANS
			SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  , 
								  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 

			CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

					CASE WHEN @ENVIO = 1 THEN

						  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '5'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '5'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
									 ) end 
									)

						  ELSE

									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '1'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '0'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
									 ) end 
									)
						   END

					ELSE
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
						 ) end 
						)

					END

			ELSE 
			'5' 
			END As estado

			FROM         
								  dbo.MPEDIDO INNER JOIN
								  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
								  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto   RIGHT OUTER JOIN
								  dbo.TPRODUCTOAREA INNER JOIN
								  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto
			WHERE   isnull(dpedido.latendidoc,0)=0 and  (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and  dpedido.fenvio is not null  AND varea.CODIGO=@AREA

			UNION

			SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  ,  
								  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 


			CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

					CASE WHEN @ENVIO = 1 THEN

						  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '5'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '5'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
									 ) end 
									)

						  ELSE

									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '1'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '0'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
									 ) end 
									)
						   END

					ELSE
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
						 ) end 
						)

					END

			ELSE 
			'5' 
			END As estado

			FROM      
								  dbo.MPEDIDO INNER JOIN
								  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
								  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto    
			WHERE     isnull(dpedido.latendidoc,0)=0 and (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null    and 
			mpedido.tcodigopedido+dpedido.titem in ( 
			SELECT     dbo.CPEDIDO.tCodigoPedido + dbo.CPEDIDO.tItem AS Expr1
			FROM         dbo.TPRODUCTOAREA INNER JOIN
								  dbo.TPRODUCTO ON dbo.TPRODUCTOAREA.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
								  dbo.CPEDIDO ON dbo.TPRODUCTO.tCodigoProducto = dbo.CPEDIDO.tProductoCombo INNER JOIN
								  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo INNER JOIN
								  dbo.MPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido
			WHERE     (dbo.vArea.Codigo = @area)
			GROUP BY dbo.CPEDIDO.tCodigoPedido, dbo.CPEDIDO.tItem, dbo.MPEDIDO.tEstadoPedido
			HAVING      (dbo.MPEDIDO.tEstadoPedido <> N'03')
			)


ELSE


			INSERT INTO #DBTRANS
			SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  , 
								  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 

			CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

					CASE WHEN @ENVIO = 1 THEN

						  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '5'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '5'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
									 ) end 
									)

						  ELSE

									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '1'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '0'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
									 ) end 
									)
						   END

					ELSE
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
						 ) end 
						)

					END

			ELSE 
			'5' 
			END As estado

			FROM         
								  dbo.MPEDIDO INNER JOIN
								  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
								  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto   RIGHT OUTER JOIN
								  dbo.TPRODUCTOAREA INNER JOIN
								  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto
								  AND dbo.MPEDIDO.tcaja NOT IN (select TCAJA from dbo.TAREACHEF)   
			WHERE   isnull(dpedido.latendidoc,0)=0 and  (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and  dpedido.fenvio is not null  AND varea.CODIGO=@AREA


			UNION


			SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  , 
								  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 

			CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

					CASE WHEN @ENVIO = 1 THEN

						  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '5'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '5'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
									 ) end 
									)

						  ELSE

									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '1'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '0'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
									 ) end 
									)
						   END

					ELSE
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
						 ) end 
						)

					END

			ELSE 
			'5' 
			END As estado

			FROM         
								  dbo.MPEDIDO INNER JOIN
								  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
								  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto   RIGHT OUTER JOIN
								  dbo.TPRODUCTOAREA INNER JOIN
								  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto
								  INNER JOIN dbo.TAREACHEF ON dbo.TAREACHEF.tCaja = dbo.MPEDIDO.tCaja AND dbo.TPRODUCTOAREA.tArea NOT IN (Select tArea From dbo.TAREACHEF) 
			WHERE   isnull(dpedido.latendidoc,0)=0 and  (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and  dpedido.fenvio is not null  AND varea.CODIGO=@AREA


			UNION


			SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  ,  
								  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 


			CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

					CASE WHEN @ENVIO = 1 THEN

						  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '5'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '5'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
									 ) end 
									)

						  ELSE

									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '1'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '0'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
									 ) end 
									)
						   END

					ELSE
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
						 ) end 
						)

					END

			ELSE 
			'5' 
			END As estado

			FROM      
								  dbo.MPEDIDO INNER JOIN
								  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
								  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto    
			WHERE     isnull(dpedido.latendidoc,0)=0 and (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null    and 
			mpedido.tcodigopedido+dpedido.titem in ( 
			SELECT     dbo.CPEDIDO.tCodigoPedido + dbo.CPEDIDO.tItem AS Expr1
			FROM         dbo.TPRODUCTOAREA INNER JOIN
								  dbo.TPRODUCTO ON dbo.TPRODUCTOAREA.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
								  dbo.CPEDIDO ON dbo.TPRODUCTO.tCodigoProducto = dbo.CPEDIDO.tProductoCombo INNER JOIN
								  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo INNER JOIN
								  dbo.MPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido
			WHERE     (dbo.vArea.Codigo = @area)
			GROUP BY dbo.CPEDIDO.tCodigoPedido, dbo.CPEDIDO.tItem, dbo.MPEDIDO.tEstadoPedido
			HAVING      (dbo.MPEDIDO.tEstadoPedido <> N'03')
			)

END

print '2'
INSERT INTO #DBTRANS2
select estado,sum(cantidad) as cantidad
from  #DBTRANS
group by estado
order by estado

print '3'
SELECT CASE WHEN producto=2 then 'ROJO' ELSE
 (CASE WHEN producto=1 then 'VERDE' ELSE (CASE WHEN producto=0 then 'AMBAR' ELSE 'NCANTADO' END) END) END as estado, 
cantidad, 
(round(cantidad * 100/@total,2) ) porcentaje 
FROM 
#dbtrans2

END

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO



CREATE PROCEDURE [dbo].[usp_Cheff_ObtenerResumen]
@AREA NVARCHAR(3)
AS
begin
DECLARE @ENVIO BIT
SELECT @ENVIO = ISNULL(lEnvioChef,0) FROM TPARAMETRO
DECLARE @CANT INT
SELECT  @CANT = COUNT(*) FROM TAREACHEF WHERE lAREA=1


CREATE TABLE #DBTRANS (pedido nVarChar(15) collate Modern_Spanish_CI_AS, 
					   item  nVarChar(3) collate Modern_Spanish_CI_AS,
					   codigoProducto nVarChar(7) collate Modern_Spanish_CI_AS,
					   producto nVarChar(200) collate Modern_Spanish_CI_AS,
					   cantidad Float,
					   estado nVarChar(1) collate Modern_Spanish_CI_AS)

create table #DBTRANS2
(
PRODUCTO nVarChar(200) collate Modern_Spanish_CI_AS,
					   cantidad Float,
					total float
)

BEGIN


IF @CANT = 0

			INSERT INTO #DBTRANS
			SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  , 
								  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 

			CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

					CASE WHEN @ENVIO = 1 THEN

						  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '5'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '5'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
									 ) end 
									)

						  ELSE

									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '1'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '0'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
									 ) end 
									)
						   END

					ELSE
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
						 ) end 
						)

					END

			ELSE 
			'5' 
			END As estado

			FROM         
								  dbo.MPEDIDO INNER JOIN
								  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
								  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto   RIGHT OUTER JOIN
								  dbo.TPRODUCTOAREA INNER JOIN
								  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto
			WHERE    isnull(dpedido.latendidoc,0)=0 and  (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null  AND varea.CODIGO=@AREA

			UNION

			SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  ,  
								  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 
			CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

					CASE WHEN @ENVIO = 1 THEN

						  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '5'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '5'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
									 ) end 
									)

						  ELSE

									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '1'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '0'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
									 ) end 
									)
						   END

					ELSE
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
						 ) end 
						)

					END

			ELSE 
			'5' 
			END As estado

			FROM      
								  dbo.MPEDIDO INNER JOIN
								  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
								  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto    
			WHERE    isnull(dpedido.latendidoc,0)=0 and  (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null    and 
			mpedido.tcodigopedido+dpedido.titem in ( 
			SELECT     dbo.CPEDIDO.tCodigoPedido + dbo.CPEDIDO.tItem AS Expr1
			FROM         dbo.TPRODUCTOAREA INNER JOIN
								  dbo.TPRODUCTO ON dbo.TPRODUCTOAREA.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
								  dbo.CPEDIDO ON dbo.TPRODUCTO.tCodigoProducto = dbo.CPEDIDO.tProductoCombo INNER JOIN
								  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo INNER JOIN
								  dbo.MPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido
			WHERE     (dbo.vArea.Codigo = @area)
			GROUP BY dbo.CPEDIDO.tCodigoPedido, dbo.CPEDIDO.tItem, dbo.MPEDIDO.tEstadoPedido
			HAVING      (dbo.MPEDIDO.tEstadoPedido <>N'03')
			)


ELSE

			INSERT INTO #DBTRANS
			SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  , 
								  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 

			CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

					CASE WHEN @ENVIO = 1 THEN

						  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '5'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '5'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
									 ) end 
									)

						  ELSE

									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '1'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '0'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
									 ) end 
									)
						   END

					ELSE
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
						 ) end 
						)

					END

			ELSE 
			'5' 
			END As estado

			FROM         
								  dbo.MPEDIDO INNER JOIN
								  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
								  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto   RIGHT OUTER JOIN
								  dbo.TPRODUCTOAREA INNER JOIN
								  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto
								  AND dbo.MPEDIDO.tcaja NOT IN (select TCAJA from dbo.TAREACHEF) 
			WHERE    isnull(dpedido.latendidoc,0)=0 and  (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null  AND varea.CODIGO=@AREA


			UNION


			SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  , 
								  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 

			CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

					CASE WHEN @ENVIO = 1 THEN

						  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '5'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '5'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
									 ) end 
									)

						  ELSE

									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '1'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '0'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
									 ) end 
									)
						   END

					ELSE
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
						 ) end 
						)

					END

			ELSE 
			'5' 
			END As estado

			FROM         
								  dbo.MPEDIDO INNER JOIN
								  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
								  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto   RIGHT OUTER JOIN
								  dbo.TPRODUCTOAREA INNER JOIN
								  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto
								  INNER JOIN dbo.TAREACHEF ON dbo.TAREACHEF.tCaja = dbo.MPEDIDO.tCaja AND dbo.TPRODUCTOAREA.tArea NOT IN (Select tArea From dbo.TAREACHEF)
			WHERE    isnull(dpedido.latendidoc,0)=0 and  (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null  AND varea.CODIGO=@AREA


			UNION


			SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  ,  
								  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 
			CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

					CASE WHEN @ENVIO = 1 THEN

						  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '5'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '5'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
									 ) end 
									)

						  ELSE

									(
										case when datediff(ss,dpedido.fCantadoC,getdate())<  
														case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
												 then '1'
									else 
									( 
									case when datediff(ss,dpedido.fCantadoC,getdate())>= 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									and datediff(ss,dpedido.fCantadoC,getdate())< 
														case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
												then '0'

									else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
									 ) end 
									)
						   END

					ELSE
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
						 ) end 
						)

					END

			ELSE 
			'5' 
			END As estado

			FROM      
								  dbo.MPEDIDO INNER JOIN
								  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
								  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto    
			WHERE    isnull(dpedido.latendidoc,0)=0 and  (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null    and 
			mpedido.tcodigopedido+dpedido.titem in ( 
			SELECT     dbo.CPEDIDO.tCodigoPedido + dbo.CPEDIDO.tItem AS Expr1
			FROM         dbo.TPRODUCTOAREA INNER JOIN
								  dbo.TPRODUCTO ON dbo.TPRODUCTOAREA.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
								  dbo.CPEDIDO ON dbo.TPRODUCTO.tCodigoProducto = dbo.CPEDIDO.tProductoCombo INNER JOIN
								  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo INNER JOIN
								  dbo.MPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido
			WHERE     (dbo.vArea.Codigo = @area)
			GROUP BY dbo.CPEDIDO.tCodigoPedido, dbo.CPEDIDO.tItem, dbo.MPEDIDO.tEstadoPedido
			HAVING      (dbo.MPEDIDO.tEstadoPedido <>N'03')
			)
END

INSERT INTO #DBTRANS2
select producto,sum(cantidad) as cantidad, 0
from  #DBTRANS
group by producto
order by producto

UPDATE #dbtrans2 set total=(select sum(cantidad) from #dbtrans)

SELECT producto, cantidad , total FROM #dbtrans2

END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create procedure usp_Cheff_ObtieneOrdenColumnaAreaPantalla  
@area nvarchar(3)
as
begin
select nColumna,lmuestra,nOrden,nAncho from tareapantalla
where tarea=@area
order by nOrden
end 

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE [dbo].[usp_Prototipo_Usuario_Validar]
(
	@Usr varchar(20),
	@Psw varchar(20)
)
AS
BEGIN
	SELECT COUNT(*)
	FROM  TUSUARIO 
	WHERE tResumido=@Usr AND tPassword=@Psw
END

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO








SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO
create procedure usp_Cheff_ObtieneCadenaGrilla
@tarea nvarchar(3)
as
begin

select tdescripcionmostrar,tdescripcioninterna,nancho,1 as alinea,lmuestra   from tareapantalla
where tarea=@tarea
order by norden

end
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


CREATE PROCEDURE [dbo].[usp_Cheff_ActualizaDetalleCantado]
@tcodigopedido nvarchar(10),
@titem nvarchar(3),
@tcodigoproducto nvarchar(7)
 
AS

BEGIN

declare @cantado bit


	select @cantado=isnull(lcantadoc,0)
	from dpedido where tcodigopedido=@tcodigopedido and titem=@titem and tcodigoproducto=@tcodigoproducto


	if @cantado=0
	begin
		update dpedido set lcantadoc=1 , fcantadoc=getdate()
		where tcodigopedido=@tcodigopedido and titem=@titem and tcodigoproducto=@tcodigoproducto
	end

	if @cantado=1
	begin
		update dpedido set lTipoEnvio=1
		where tcodigopedido=@tcodigopedido and titem=@titem and tcodigoproducto=@tcodigoproducto
	end


END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create procedure [dbo].[usp_Cheff_deleteColumnasAreas]
@tArea nvarchar(3)
as
begin
delete from tareapantalla where tarea=@tArea
end


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE procedure  [dbo].[usp_Cheff_InsertaColumnaAreaPantalla]
@tarea nvarchar(3),
@ncolumna int,
@lmuestra bit,
@norden int,
@nancho float, 
@usuario nvarchar(15),
@tDescripcionMostrar nvarchar(50),
@tDescripcionInterna nvarchar(50)
as
begin
insert into tareapantalla
values (@tarea,@ncolumna,@lmuestra,@norden, @nancho,@usuario,getdate(),@tDescripcionMostrar,@tDescripcionInterna)
end




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create procedure usp_Cheff_ObtieneAreasPantalla
as
BEGIN
select codigo,descripcion from varea

where lcheffcontrol=1
order by descripcion
END

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO







SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create procedure [dbo].[usp_Cheff_ActualizaDetalleComboAtendido]
@tcodigopedido nvarchar(10),
@titem nvarchar(3),
@titemCombo nvarchar(3),
@tcodigoproducto nvarchar(7),
@tusuario nvarchar(15),
@area nvarchar(3)
as
begin

update cpedido set latendidoc=1 , fatendidoc=getdate(), tUsuarioAtendio=@tusuario
where tcodigopedido=@tcodigopedido and titem=@titem and titemcombo=@titemcombo 
and tproductocombo=@tcodigoproducto

declare @cantidadPendiente as int

 SELECT   @cantidadPendiente=  count(*)
FROM         dbo.CPEDIDO INNER JOIN
                      dbo.TPRODUCTO ON dbo.CPEDIDO.tProductoCombo = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.TPRODUCTOAREA ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto INNER JOIN
                      dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo
WHERE     (dbo.CPEDIDO.tCodigoPedido = @tcodigopedido) AND (dbo.CPEDIDO.tItem =@titem) 
and varea.codigo=@area and isnull(cpedido.latendidoc,0)=0  

 
if @cantidadPendiente =  0
begin

update dpedido set latendidoc=1 , fatendidoc=getdate(), tUsuarioAtendio=@tusuario
where tcodigopedido=@tcodigopedido and titem=@titem 
end 

end
 
 

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO





SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create procedure [dbo].[ups_ObtieneFechaHoraS]
(
	@FECHA		NVARCHAR(100)	OUTPUT
)
as
BEGIN
SET @FECHA=convert(char(11),GETDATE(),103) + CONVERT(varchar(25), GETDATE(), 108)
print @FECHA
END

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create procedure [dbo].[usp_Cheff_ActualizaDetalleAtendido]
@tcodigopedido nvarchar(10),
@titem nvarchar(3),
@tcodigoproducto nvarchar(7),
@tusuario nvarchar(15)
as

begin

update dpedido set latendidoc=1 , fatendidoc=getdate(), tUsuarioAtendio=@tusuario
where tcodigopedido=@tcodigopedido and titem=@titem and tcodigoproducto=@tcodigoproducto

declare @lCombinacion bit

select @lcombinacion=lcombinacion
from dpedido where tcodigopedido=@tcodigopedido and titem=@titem and tcodigoproducto=@tcodigoproducto

if @lcombinacion=1
begin

update cpedido set latendidoc=1 , fatendidoc=getdate(), tUsuarioAtendio=@tusuario
where tcodigopedido=@tcodigopedido and titem=@titem  

end 

end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create procedure [dbo].[usp_Cheff_ReactivaDetalleAtendido]
@tcodigopedido nvarchar(10),
@titem nvarchar(3),
@tcodigoproducto nvarchar(7),
@tusuario nvarchar(15)
as
begin

declare @cantidad int 


update dpedido set latendidoc=NULL , fatendidoc=NULL, tUsuarioAtendio='', lCantadoC=0, fCantadoC= NULL
where tcodigopedido=@tcodigopedido and titem=@titem and tcodigoproducto=@tcodigoproducto

set @cantidad=0

set @cantidad=(select count(*) from dpedido where tcodigopedido=@tcodigopedido 
and titem=@titem and isnull(lcombinacion,0)=1)

if @cantidad>0 
begin
update cpedido
set latendidoc=0
where tcodigopedido=@tcodigopedido 
and titem=@titem  
and tproducto=@tcodigoproducto
end

end

 
 
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF 
GO


CREATE PROCEDURE [dbo].[usp_Cheff_ObtieneRegistros] 
@AREA NVARCHAR(3)
AS
begin
--DECLARE @FECHA SMALLDATETIME
DECLARE @ENVIO BIT
SELECT @ENVIO = ISNULL(lEnvioChef,0) FROM TPARAMETRO

DECLARE @CANT INT
SELECT  @CANT = COUNT(*) FROM TAREACHEF WHERE lAREA=1

IF @CANT = 0

		SELECT     dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS TipoPedido,dpedido.titem as item  , CONVERT(datetime, dbo.DPEDIDO.fEnvio, 
						  110) AS Envio, dbo.vSalon.tResumido AS Salon, dbo.TMESA.tResumido AS Mesa, dbo.MPEDIDO.tObservacion AS ObservacionP, 
						  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, CONVERT(bit, ISNULL(DATALENGTH(dbo.DPEDIDO.tObservacion), 0)) 
						  AS lObservacion, CONVERT(bit, ISNULL(T1.nPropiedad, 0)) AS lPropiedad, 
		CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

			CASE WHEN @ENVIO = 1 THEN
				  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
							(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
								case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end then '5'
							else 
							( 
							case when datediff(ss,dpedido.fCantadoC,getdate())>= 
												case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
							and datediff(ss,dpedido.fCantadoC,getdate())< 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end then '5'

							else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
							 ) end 
							)

				  ELSE

							(
								case when datediff(ss,dpedido.fCantadoC,getdate())<  
										case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end then '1'
							else 
							( 
							case when datediff(ss,dpedido.fCantadoC,getdate())>= 
												case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
							and datediff(ss,dpedido.fCantadoC,getdate())< 
									case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end then '0'

							else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
							 ) end 
							)
				   END

			ELSE
				(
					case when datediff(ss,dpedido.fCantadoC,getdate())<  
							case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end then '1'
				else 
				( 
				case when datediff(ss,dpedido.fCantadoC,getdate())>= 
							case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
				and datediff(ss,dpedido.fCantadoC,getdate())< 
							case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end then '0'

				else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
				 ) end 
				)

			END

		ELSE 
		'5' 
		END As estado,

		isnull(dbo.dpedido.tobservacion,'') as observacionD, isnull(dpedido.lcombinacion,0) as lCombinacion, 

		(SELECT Duracion = Case dbo.dPedido.lCantadoC  WHEN 1 THEN  LTRIM(STR(((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) / (3600))) +'h '+ ltrim(Str( (((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) % (3600)) /(60) )) + 'm ' + ltrim(str((((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) % (3600)) %(60) )) + 's' ELSE '00'+'h '+'00'+'m '+'00'+'s' END )as Duracion, 

		vmozo.tresumido as Mozo, isnull(dbo.dpedido.norden,0) as Orden, RIGHT( CONVERT(DATETIME, dpedido.fenvio, 108),8) as Hora, isnull(dpedido.lcantadoc,0) cantado

		FROM         dbo.vMozo RIGHT OUTER JOIN
						  dbo.MPEDIDO INNER JOIN
						  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
						  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
						  dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
						  dbo.vSalon INNER JOIN
						  dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
							  (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
								FROM          dbo.TPRODUCTOPROPIEDAD
								GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem RIGHT OUTER JOIN
						  dbo.TPRODUCTOAREA INNER JOIN
						  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto                        
		WHERE   isnull(dpedido.latendidoc,0)=0 and   (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') 
		and isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null  AND varea.CODIGO=@AREA   
		
		UNION

		SELECT    dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS TipoPedido,dpedido.titem as item  , CONVERT(datetime, dbo.DPEDIDO.fEnvio, 
						  110) AS Envio, dbo.vSalon.tResumido AS Salon, dbo.TMESA.tResumido AS Mesa, dbo.MPEDIDO.tObservacion AS ObservacionP, 
						  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, CONVERT(bit, ISNULL(DATALENGTH(dbo.DPEDIDO.tObservacion), 0)) 
						  AS lObservacion, CONVERT(bit, ISNULL(T1.nPropiedad, 0)) AS lPropiedad, 

		CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

			CASE WHEN @ENVIO = 1 THEN

				  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
							(
								case when datediff(ss,dpedido.fCantadoC,getdate())<  
									case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end then '5'
							else 
							( 
							case when datediff(ss,dpedido.fCantadoC,getdate())>= 
									case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
							and datediff(ss,dpedido.fCantadoC,getdate())< 
									case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end then '5'

							else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
							 ) end 
							)

				  ELSE
							(
								case when datediff(ss,dpedido.fCantadoC,getdate())<  
										case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end then '1'
							else 
							( 
							case when datediff(ss,dpedido.fCantadoC,getdate())>= 
										case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
							and datediff(ss,dpedido.fCantadoC,getdate())< 
										case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end then '0'

							else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
							 ) end 
							)
				   END

			ELSE
				(
				case when datediff(ss,dpedido.fCantadoC,getdate())<  
									case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
							 then '1'
				else 
				( 
				case when datediff(ss,dpedido.fCantadoC,getdate())>= 
									case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
				and datediff(ss,dpedido.fCantadoC,getdate())< 
									case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
							then '0'

				else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
				 ) end 
				)

			END

		ELSE 
		'5' 
		END As estado,
		
		isnull(dbo.dpedido.tobservacion,'') as observacionD, isnull(dpedido.lcombinacion,0) as lCombinacion,

		(SELECT Duracion = Case dbo.dPedido.lCantadoC  WHEN 1 THEN  LTRIM(STR(((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) / (3600))) +'h '+ ltrim(Str( (((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) % (3600)) /(60) )) + 'm ' + ltrim(str((((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) % (3600)) %(60) )) + 's' ELSE '00'+'h '+'00'+'m '+'00'+'s' END )as Duracion, 

		vmozo.tresumido as Mozo, isnull(dbo.dpedido.norden,0) as Orden,RIGHT( CONVERT(DATETIME, dpedido.fenvio, 108),8) as Hora, isnull(dpedido.lcantadoc,0) cantado

		FROM         dbo.vMozo RIGHT OUTER JOIN
						  dbo.MPEDIDO INNER JOIN
						  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
						  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
						  dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
						  dbo.vSalon INNER JOIN
						  dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
							  (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
								FROM          dbo.TPRODUCTOPROPIEDAD
								GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem 
		WHERE     (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and isnull(dpedido.latendidoc,0)=0 and dpedido.fenvio is not null    and 
		mpedido.tcodigopedido+dpedido.titem in ( 
		SELECT     dbo.CPEDIDO.tCodigoPedido + dbo.CPEDIDO.tItem AS Expr1
		FROM         dbo.TPRODUCTOAREA INNER JOIN
						  dbo.TPRODUCTO ON dbo.TPRODUCTOAREA.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
						  dbo.CPEDIDO ON dbo.TPRODUCTO.tCodigoProducto = dbo.CPEDIDO.tProductoCombo INNER JOIN
						  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo INNER JOIN
						  dbo.MPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido
		WHERE     (dbo.vArea.Codigo = @AREA)
		GROUP BY dbo.CPEDIDO.tCodigoPedido, dbo.CPEDIDO.tItem, dbo.MPEDIDO.tEstadoPedido
		HAVING      (dbo.MPEDIDO.tEstadoPedido  <> '03')
		)
		ORDER BY 4

ELSE


		SELECT     dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS TipoPedido,dpedido.titem as item  , CONVERT(datetime, dbo.DPEDIDO.fEnvio, 
							  110) AS Envio, dbo.vSalon.tResumido AS Salon, dbo.TMESA.tResumido AS Mesa, dbo.MPEDIDO.tObservacion AS ObservacionP, 
							  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, CONVERT(bit, ISNULL(DATALENGTH(dbo.DPEDIDO.tObservacion), 0)) 
							  AS lObservacion, CONVERT(bit, ISNULL(T1.nPropiedad, 0)) AS lPropiedad, 

		CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

				CASE WHEN @ENVIO = 1 THEN

					  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
								(
									case when datediff(ss,dpedido.fCantadoC,getdate())<  
													case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
											 then '5'
								else 
								( 
								case when datediff(ss,dpedido.fCantadoC,getdate())>= 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								and datediff(ss,dpedido.fCantadoC,getdate())< 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
											then '5'

								else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
								 ) end 
								)

					  ELSE

								(
								case when datediff(ss,dpedido.fCantadoC,getdate())<  
										case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end then '1'
								else 
								( 
								case when datediff(ss,dpedido.fCantadoC,getdate())>= 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								and datediff(ss,dpedido.fCantadoC,getdate())< 
										case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end then '0'

								else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
								 ) end 
								)
					   END

				ELSE
					(
						case when datediff(ss,dpedido.fCantadoC,getdate())<  
										case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								 then '1'
					else 
					( 
					case when datediff(ss,dpedido.fCantadoC,getdate())>= 
										case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
					and datediff(ss,dpedido.fCantadoC,getdate())< 
										case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
								then '0'

					else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
					 ) end 
					)

				END

		ELSE 
		'5' 
		END As estado,

		isnull(dbo.dpedido.tobservacion,'') as observacionD, isnull(dpedido.lcombinacion,0) as lCombinacion, 

		(SELECT Duracion = Case dbo.dPedido.lCantadoC  WHEN 1 THEN  LTRIM(STR(((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) / (3600))) +'h '+ ltrim(Str( (((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) % (3600)) /(60) )) + 'm ' + ltrim(str((((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) % (3600)) %(60) )) + 's' ELSE '00'+'h '+'00'+'m '+'00'+'s' END )as Duracion, 

		vmozo.tresumido as Mozo, isnull(dbo.dpedido.norden,0) as Orden, RIGHT( CONVERT(DATETIME, dpedido.fenvio, 108),8) as Hora, isnull(dpedido.lcantadoc,0) cantado

		FROM         dbo.vMozo RIGHT OUTER JOIN
							  dbo.MPEDIDO INNER JOIN
							  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
							  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
							  dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
							  dbo.vSalon INNER JOIN
							  dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
								  (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
									FROM          dbo.TPRODUCTOPROPIEDAD
									GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem RIGHT OUTER JOIN
							  dbo.TPRODUCTOAREA INNER JOIN
							  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto
							  AND dbo.MPEDIDO.tcaja NOT IN (select TCAJA from dbo.TAREACHEF)                       
		WHERE   isnull(dpedido.latendidoc,0)=0 and   (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') 
		and isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null  AND varea.CODIGO=@AREA   


		UNION


		SELECT     dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS TipoPedido,dpedido.titem as item  , CONVERT(datetime, dbo.DPEDIDO.fEnvio, 
							  110) AS Envio, dbo.vSalon.tResumido AS Salon, dbo.TMESA.tResumido AS Mesa, dbo.MPEDIDO.tObservacion AS ObservacionP, 
							  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, CONVERT(bit, ISNULL(DATALENGTH(dbo.DPEDIDO.tObservacion), 0)) 
							  AS lObservacion, CONVERT(bit, ISNULL(T1.nPropiedad, 0)) AS lPropiedad, 

		CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

				CASE WHEN @ENVIO = 1 THEN

					  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
								(
									case when datediff(ss,dpedido.fCantadoC,getdate())<  
													case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
											 then '5'
								else 
								( 
								case when datediff(ss,dpedido.fCantadoC,getdate())>= 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								and datediff(ss,dpedido.fCantadoC,getdate())< 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
											then '5'

								else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
								 ) end 
								)

					  ELSE

								(
									case when datediff(ss,dpedido.fCantadoC,getdate())<  
													case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
											 then '1'
								else 
								( 
								case when datediff(ss,dpedido.fCantadoC,getdate())>= 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								and datediff(ss,dpedido.fCantadoC,getdate())< 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
											then '0'

								else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
								 ) end 
								)
					   END

				ELSE
					(
						case when datediff(ss,dpedido.fCantadoC,getdate())<  
										case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								 then '1'
					else 
					( 
					case when datediff(ss,dpedido.fCantadoC,getdate())>= 
										case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
					and datediff(ss,dpedido.fCantadoC,getdate())< 
										case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
								then '0'

					else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
					 ) end 
					)

				END

		ELSE 
		'5' 
		END As estado,


		isnull(dbo.dpedido.tobservacion,'') as observacionD, isnull(dpedido.lcombinacion,0) as lCombinacion, 

		(SELECT Duracion = Case dbo.dPedido.lCantadoC  WHEN 1 THEN  LTRIM(STR(((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) / (3600))) +'h '+ ltrim(Str( (((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) % (3600)) /(60) )) + 'm ' + ltrim(str((((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) % (3600)) %(60) )) + 's' ELSE '00'+'h '+'00'+'m '+'00'+'s' END )as Duracion, 

		vmozo.tresumido as Mozo, isnull(dbo.dpedido.norden,0) as Orden, RIGHT( CONVERT(DATETIME, dpedido.fenvio, 108),8) as Hora, isnull(dpedido.lcantadoc,0) cantado

		FROM         dbo.vMozo RIGHT OUTER JOIN
							  dbo.MPEDIDO INNER JOIN
							  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
							  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
							  dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
							  dbo.vSalon INNER JOIN
							  dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
								  (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
									FROM          dbo.TPRODUCTOPROPIEDAD
									GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem RIGHT OUTER JOIN
							  dbo.TPRODUCTOAREA INNER JOIN
							  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto
							  INNER JOIN dbo.TAREACHEF ON dbo.TAREACHEF.tCaja = dbo.MPEDIDO.tCaja AND dbo.TPRODUCTOAREA.tArea NOT IN (Select tArea From dbo.TAREACHEF)                         
		WHERE   isnull(dpedido.latendidoc,0)=0 and   (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') 
		and isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null  AND varea.CODIGO=@AREA  


		UNION


		SELECT    dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS TipoPedido,dpedido.titem as item  , CONVERT(datetime, dbo.DPEDIDO.fEnvio, 
							  110) AS Envio, dbo.vSalon.tResumido AS Salon, dbo.TMESA.tResumido AS Mesa, dbo.MPEDIDO.tObservacion AS ObservacionP, 
							  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, CONVERT(bit, ISNULL(DATALENGTH(dbo.DPEDIDO.tObservacion), 0)) 
							  AS lObservacion, CONVERT(bit, ISNULL(T1.nPropiedad, 0)) AS lPropiedad, 


		CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

				CASE WHEN @ENVIO = 1 THEN

					  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
								(
									case when datediff(ss,dpedido.fCantadoC,getdate())<  
													case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
											 then '5'
								else 
								( 
								case when datediff(ss,dpedido.fCantadoC,getdate())>= 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								and datediff(ss,dpedido.fCantadoC,getdate())< 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
											then '5'

								else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
								 ) end 
								)

					  ELSE

								(
									case when datediff(ss,dpedido.fCantadoC,getdate())<  
													case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
											 then '1'
								else 
								( 
								case when datediff(ss,dpedido.fCantadoC,getdate())>= 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								and datediff(ss,dpedido.fCantadoC,getdate())< 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
											then '0'

								else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
								 ) end 
								)
					   END

				ELSE
					(
						case when datediff(ss,dpedido.fCantadoC,getdate())<  
										case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								 then '1'
					else 
					( 
					case when datediff(ss,dpedido.fCantadoC,getdate())>= 
										case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
					and datediff(ss,dpedido.fCantadoC,getdate())< 
										case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
								then '0'

					else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
					 ) end 
					)

				END

		ELSE 
		'5' 
		END As estado,

		 isnull(dbo.dpedido.tobservacion,'') as observacionD, isnull(dpedido.lcombinacion,0) as lCombinacion,

		(SELECT Duracion = Case dbo.dPedido.lCantadoC  WHEN 1 THEN  LTRIM(STR(((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) / (3600))) +'h '+ ltrim(Str( (((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) % (3600)) /(60) )) + 'm ' + ltrim(str((((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) % (3600)) %(60) )) + 's' ELSE '00'+'h '+'00'+'m '+'00'+'s' END )as Duracion, 

		 vmozo.tresumido as Mozo, isnull(dbo.dpedido.norden,0) as Orden,RIGHT( CONVERT(DATETIME, dpedido.fenvio, 108),8) as Hora, isnull(dpedido.lcantadoc,0) cantado

		FROM         dbo.vMozo RIGHT OUTER JOIN
							  dbo.MPEDIDO INNER JOIN
							  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
							  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
							  dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
							  dbo.vSalon INNER JOIN
							  dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
								  (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
									FROM          dbo.TPRODUCTOPROPIEDAD
									GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem 
		WHERE     (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and isnull(dpedido.latendidoc,0)=0 and dpedido.fenvio is not null    and 
		mpedido.tcodigopedido+dpedido.titem in ( 
		SELECT     dbo.CPEDIDO.tCodigoPedido + dbo.CPEDIDO.tItem AS Expr1
		FROM         dbo.TPRODUCTOAREA INNER JOIN
							  dbo.TPRODUCTO ON dbo.TPRODUCTOAREA.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
							  dbo.CPEDIDO ON dbo.TPRODUCTO.tCodigoProducto = dbo.CPEDIDO.tProductoCombo INNER JOIN
							  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo INNER JOIN
							  dbo.MPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido
		WHERE     (dbo.vArea.Codigo = @AREA)
		GROUP BY dbo.CPEDIDO.tCodigoPedido, dbo.CPEDIDO.tItem, dbo.MPEDIDO.tEstadoPedido
		HAVING      (dbo.MPEDIDO.tEstadoPedido  <> '03')
		)
		ORDER BY 4
END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO



CREATE PROCEDURE [dbo].[usp_Cheff_ObtieneRegistrosAtendidos]  
@fechaAtendido nvarchar(100),
@area nvarchar(3)

AS
BEGIN

DECLARE @CANT INT
SELECT  @CANT = COUNT(*) FROM TAREACHEF WHERE lAREA=1

IF @CANT = 0

		SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS TipoPedido,dpedido.titem as item  , CONVERT(datetime, dbo.DPEDIDO.fEnvio, 
							  110) AS Envio, dbo.vSalon.tResumido AS Salon, dbo.TMESA.tResumido AS Mesa, dbo.MPEDIDO.tObservacion AS ObservacionP, 
							  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, CONVERT(bit, ISNULL(DATALENGTH(dbo.DPEDIDO.tObservacion), 0)) 
							  AS lObservacion, CONVERT(bit, ISNULL(T1.nPropiedad, 0)) AS lPropiedad, 
		CASE WHEN dPedido.lCantadoC=1 THEN (
		case when datediff(ss,dpedido.fCantadoC,getdate())< case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end  then '1'
		else ( case when datediff(ss,dpedido.fCantadoC,getdate())> case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end and datediff(ss,dpedido.fCantadoC,getdate())< case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '0'
		else ( case when datediff(ss,dpedido.fCantadoC,getdate())> case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
		 ) end 
		) ELSE '5' END As estado,
		 isnull(dbo.dpedido.tobservacion,'') as observacionD, isnull(dpedido.lcombinacion,0) as lCombinacion, 

		 LTRIM(STR(((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) / (3600))) +'h '+ ltrim(Str( (((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) % (3600)) /(60) )) + 'm ' + ltrim(str((((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) % (3600)) %(60) )) + 's' as Duracion,

		 vmozo.tresumido as Mozo, isnull(dbo.dpedido.norden,0) as Orden  ,isnull(dpedido.tusuarioatendio,'') as atendio,  RIGHT( CONVERT(DATETIME, dpedido.fenvio, 108),8) as Hora

		FROM         dbo.vMozo RIGHT OUTER JOIN
							  dbo.MPEDIDO INNER JOIN
							  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
							  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
							  dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
							  dbo.vSalon INNER JOIN
							  dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
								  (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
									FROM          dbo.TPRODUCTOPROPIEDAD
									GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem RIGHT OUTER JOIN
							  dbo.TPRODUCTOAREA INNER JOIN
							  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto 
		WHERE     (dbo.MPEDIDO.tEstadoPedido  <> '04') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and isnull(dpedido.latendidoc,0)=1
		and dpedido.fatendidoc >=@fechaAtendido and varea.codigo=@area

		UNION

		SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS TipoPedido,dpedido.titem as item  , CONVERT(datetime, dbo.DPEDIDO.fEnvio, 
							  110) AS Envio, dbo.vSalon.tResumido AS Salon, dbo.TMESA.tResumido AS Mesa, dbo.MPEDIDO.tObservacion AS ObservacionP, 
							  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, CONVERT(bit, ISNULL(DATALENGTH(dbo.DPEDIDO.tObservacion), 0)) 
							  AS lObservacion, CONVERT(bit, ISNULL(T1.nPropiedad, 0)) AS lPropiedad, 
		CASE WHEN dPedido.lCantadoC=1 THEN (
		case when datediff(ss,dpedido.fCantadoC,getdate())< case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end  then '1'
		else ( case when datediff(ss,dpedido.fCantadoC,getdate())> case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end and datediff(ss,dpedido.fCantadoC,getdate())< case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '0'
		else ( case when datediff(ss,dpedido.fCantadoC,getdate())> case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
		 ) end 
		) ELSE '5' END As estado,
		 isnull(dbo.dpedido.tobservacion,'') as observacionD, isnull(dpedido.lcombinacion,0) as lCombinacion,

		LTRIM(STR(((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) / (3600))) +'h '+ ltrim(Str( (((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) % (3600)) /(60) )) + 'm ' + ltrim(str((((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) % (3600)) %(60) )) + 's' as Duracion,

		 vmozo.tresumido as Mozo, isnull(dbo.dpedido.norden,0) as Orden  ,isnull(dpedido.tusuarioatendio,'') as atendio,  RIGHT( CONVERT(DATETIME, dpedido.fenvio, 108),8) as Hora

		FROM         dbo.vMozo RIGHT OUTER JOIN
							  dbo.MPEDIDO INNER JOIN
							  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
							  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
							  dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
							  dbo.vSalon INNER JOIN
							  dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
								  (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
									FROM          dbo.TPRODUCTOPROPIEDAD
									GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem  
		WHERE     (dbo.MPEDIDO.tEstadoPedido  <> '04') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and isnull(dpedido.latendidoc,0)=1
		and dpedido.fatendidoc >= @fechaAtendido and mpedido.tcodigopedido+dpedido.titem  
		in ( 
		SELECT     dbo.CPEDIDO.tCodigoPedido + dbo.CPEDIDO.tItem AS Expr1
		FROM         dbo.TPRODUCTOAREA INNER JOIN
							  dbo.TPRODUCTO ON dbo.TPRODUCTOAREA.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
							  dbo.CPEDIDO ON dbo.TPRODUCTO.tCodigoProducto = dbo.CPEDIDO.tProductoCombo INNER JOIN
							  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo INNER JOIN
							  dbo.MPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido
		WHERE     (dbo.vArea.Codigo = @area)
		GROUP BY dbo.CPEDIDO.tCodigoPedido, dbo.CPEDIDO.tItem, dbo.MPEDIDO.tEstadoPedido
		HAVING      (dbo.MPEDIDO.tEstadoPedido = N'01')
		)

		ORDER BY 4


ELSE
		SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS TipoPedido,dpedido.titem as item  , CONVERT(datetime, dbo.DPEDIDO.fEnvio, 
							  110) AS Envio, dbo.vSalon.tResumido AS Salon, dbo.TMESA.tResumido AS Mesa, dbo.MPEDIDO.tObservacion AS ObservacionP, 
							  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, CONVERT(bit, ISNULL(DATALENGTH(dbo.DPEDIDO.tObservacion), 0)) 
							  AS lObservacion, CONVERT(bit, ISNULL(T1.nPropiedad, 0)) AS lPropiedad, 
		CASE WHEN dPedido.lCantadoC=1 THEN (
		case when datediff(ss,dpedido.fCantadoC,getdate())< case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end  then '1'
		else ( case when datediff(ss,dpedido.fCantadoC,getdate())> case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end and datediff(ss,dpedido.fCantadoC,getdate())< case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '0'
		else ( case when datediff(ss,dpedido.fCantadoC,getdate())> case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
		 ) end 
		) ELSE '5' END As estado,
		 isnull(dbo.dpedido.tobservacion,'') as observacionD, isnull(dpedido.lcombinacion,0) as lCombinacion, 

		 LTRIM(STR(((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) / (3600))) +'h '+ ltrim(Str( (((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) % (3600)) /(60) )) + 'm ' + ltrim(str((((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) % (3600)) %(60) )) + 's' as Duracion,

		 vmozo.tresumido as Mozo, isnull(dbo.dpedido.norden,0) as Orden  ,isnull(dpedido.tusuarioatendio,'') as atendio,  RIGHT( CONVERT(DATETIME, dpedido.fenvio, 108),8) as Hora

		FROM         dbo.vMozo RIGHT OUTER JOIN
							  dbo.MPEDIDO INNER JOIN
							  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
							  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
							  dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
							  dbo.vSalon INNER JOIN
							  dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
								  (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
									FROM          dbo.TPRODUCTOPROPIEDAD
									GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem RIGHT OUTER JOIN
							  dbo.TPRODUCTOAREA INNER JOIN
							  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto
							  AND dbo.MPEDIDO.tcaja NOT IN (select TCAJA from dbo.TAREACHEF) 
		WHERE     (dbo.MPEDIDO.tEstadoPedido  <> '04') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and isnull(dpedido.latendidoc,0)=1
		and dpedido.fatendidoc >=@fechaAtendido and varea.codigo=@area


		UNION


		SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS TipoPedido,dpedido.titem as item  , CONVERT(datetime, dbo.DPEDIDO.fEnvio, 
							  110) AS Envio, dbo.vSalon.tResumido AS Salon, dbo.TMESA.tResumido AS Mesa, dbo.MPEDIDO.tObservacion AS ObservacionP, 
							  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, CONVERT(bit, ISNULL(DATALENGTH(dbo.DPEDIDO.tObservacion), 0)) 
							  AS lObservacion, CONVERT(bit, ISNULL(T1.nPropiedad, 0)) AS lPropiedad, 
		CASE WHEN dPedido.lCantadoC=1 THEN (
		case when datediff(ss,dpedido.fCantadoC,getdate())< case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end  then '1'
		else ( case when datediff(ss,dpedido.fCantadoC,getdate())> case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end and datediff(ss,dpedido.fCantadoC,getdate())< case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '0'
		else ( case when datediff(ss,dpedido.fCantadoC,getdate())> case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
		 ) end 
		) ELSE '5' END As estado,
		 isnull(dbo.dpedido.tobservacion,'') as observacionD, isnull(dpedido.lcombinacion,0) as lCombinacion, 

		 LTRIM(STR(((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) / (3600))) +'h '+ ltrim(Str( (((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) % (3600)) /(60) )) + 'm ' + ltrim(str((((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) % (3600)) %(60) )) + 's' as Duracion,

		 vmozo.tresumido as Mozo, isnull(dbo.dpedido.norden,0) as Orden  ,isnull(dpedido.tusuarioatendio,'') as atendio,  RIGHT( CONVERT(DATETIME, dpedido.fenvio, 108),8) as Hora

		FROM         dbo.vMozo RIGHT OUTER JOIN
							  dbo.MPEDIDO INNER JOIN
							  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
							  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
							  dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
							  dbo.vSalon INNER JOIN
							  dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
								  (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
									FROM          dbo.TPRODUCTOPROPIEDAD
									GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem RIGHT OUTER JOIN
							  dbo.TPRODUCTOAREA INNER JOIN
							  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto
							  INNER JOIN dbo.TAREACHEF ON dbo.TAREACHEF.tCaja = dbo.MPEDIDO.tCaja AND dbo.TPRODUCTOAREA.tArea NOT IN (Select tArea From dbo.TAREACHEF) 
		WHERE     (dbo.MPEDIDO.tEstadoPedido  <> '04') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and isnull(dpedido.latendidoc,0)=1
		and dpedido.fatendidoc >=@fechaAtendido AND varea.CODIGO=@area  


		UNION


		SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS TipoPedido,dpedido.titem as item  , CONVERT(datetime, dbo.DPEDIDO.fEnvio, 
							  110) AS Envio, dbo.vSalon.tResumido AS Salon, dbo.TMESA.tResumido AS Mesa, dbo.MPEDIDO.tObservacion AS ObservacionP, 
							  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, CONVERT(bit, ISNULL(DATALENGTH(dbo.DPEDIDO.tObservacion), 0)) 
							  AS lObservacion, CONVERT(bit, ISNULL(T1.nPropiedad, 0)) AS lPropiedad, 
		CASE WHEN dPedido.lCantadoC=1 THEN (
		case when datediff(ss,dpedido.fCantadoC,getdate())< case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end  then '1'
		else ( case when datediff(ss,dpedido.fCantadoC,getdate())> case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end and datediff(ss,dpedido.fCantadoC,getdate())< case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '0'
		else ( case when datediff(ss,dpedido.fCantadoC,getdate())> case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
		 ) end 
		) ELSE '5' END As estado,
		 isnull(dbo.dpedido.tobservacion,'') as observacionD, isnull(dpedido.lcombinacion,0) as lCombinacion,

		LTRIM(STR(((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) / (3600))) +'h '+ ltrim(Str( (((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) % (3600)) /(60) )) + 'm ' + ltrim(str((((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) % (3600)) %(60) )) + 's' as Duracion,

		 vmozo.tresumido as Mozo, isnull(dbo.dpedido.norden,0) as Orden  ,isnull(dpedido.tusuarioatendio,'') as atendio,  RIGHT( CONVERT(DATETIME, dpedido.fenvio, 108),8) as Hora

		FROM         dbo.vMozo RIGHT OUTER JOIN
							  dbo.MPEDIDO INNER JOIN
							  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
							  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
							  dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
							  dbo.vSalon INNER JOIN
							  dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
								  (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
									FROM          dbo.TPRODUCTOPROPIEDAD
									GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem  
		WHERE     (dbo.MPEDIDO.tEstadoPedido  <> '04') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and isnull(dpedido.latendidoc,0)=1
		and dpedido.fatendidoc >= @fechaAtendido and mpedido.tcodigopedido+dpedido.titem  
		in ( 
		SELECT     dbo.CPEDIDO.tCodigoPedido + dbo.CPEDIDO.tItem AS Expr1
		FROM         dbo.TPRODUCTOAREA INNER JOIN
							  dbo.TPRODUCTO ON dbo.TPRODUCTOAREA.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
							  dbo.CPEDIDO ON dbo.TPRODUCTO.tCodigoProducto = dbo.CPEDIDO.tProductoCombo INNER JOIN
							  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo INNER JOIN
							  dbo.MPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido
		WHERE     (dbo.vArea.Codigo = @area)
		GROUP BY dbo.CPEDIDO.tCodigoPedido, dbo.CPEDIDO.tItem, dbo.MPEDIDO.tEstadoPedido
		HAVING      (dbo.MPEDIDO.tEstadoPedido = N'01')
		)

		ORDER BY 4

END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create procedure [dbo].[usp_Cheff_ObtieneComboRegistros]
@tcodigopedido nvarchar(10),
@titem nvarchar(3),
@tcodigoproducto nvarchar(7),
@area nvarchar(3),
@tipo nvarchar(3)

as

begin

set nocount on

if @tipo='1' -- pendiente
begin

 SELECT     dbo.CPEDIDO.tCodigoPedido AS cPedido, dbo.CPEDIDO.tItem AS cItem, dbo.CPEDIDO.tItemCombo AS cItemCombo, 
                      dbo.CPEDIDO.tProducto AS cProducto, dbo.CPEDIDO.tProductoCombo AS cProductoCombo, dbo.TPRODUCTO.tResumido AS cNProductoCombo, 
                      dbo.CPEDIDO.nCantidad AS cCantidad, ISNULL(dbo.CPEDIDO.tObservacion, N'') AS cObservacion
FROM         dbo.CPEDIDO INNER JOIN
                      dbo.TPRODUCTO ON dbo.CPEDIDO.tProductoCombo = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.TPRODUCTOAREA ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto INNER JOIN
                      dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo
WHERE     (dbo.CPEDIDO.tCodigoPedido = @tcodigopedido) AND (dbo.CPEDIDO.tItem =@titem) AND (dbo.CPEDIDO.tProducto = @tcodigoproducto) 
and 
varea.codigo=@area and isnull(cpedido.latendidoc,0)=0  
end
if @tipo='2'--atendido
begin

 SELECT     dbo.CPEDIDO.tCodigoPedido AS cPedido, dbo.CPEDIDO.tItem AS cItem, dbo.CPEDIDO.tItemCombo AS cItemCombo, 
                      dbo.CPEDIDO.tProducto AS cProducto, dbo.CPEDIDO.tProductoCombo AS cProductoCombo, dbo.TPRODUCTO.tResumido AS cNProductoCombo, 
                      dbo.CPEDIDO.nCantidad AS cCantidad, ISNULL(dbo.CPEDIDO.tObservacion, N'') AS cObservacion
FROM         dbo.CPEDIDO INNER JOIN
                      dbo.TPRODUCTO ON dbo.CPEDIDO.tProductoCombo = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.TPRODUCTOAREA ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto INNER JOIN
                      dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo
WHERE     (dbo.CPEDIDO.tCodigoPedido = @tcodigopedido) AND (dbo.CPEDIDO.tItem =@titem) AND (dbo.CPEDIDO.tProducto = @tcodigoproducto) 
and 
varea.codigo=@area and isnull(cpedido.latendidoc,0)=1  
end

end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO





SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create procedure [dbo].[usp_Cheff_ObtienePropiedades]
@tcodigopedido nvarchar(10),
@titem nvarchar(3),
@tcodigoproducto nvarchar(7)
as
set nocount on
BEGIN
create table #dbtrans (propiedad   nVarChar(max) collate Modern_Spanish_CI_AS)
create table #dbtrans1 (propiedad   nVarChar(max) collate Modern_Spanish_CI_AS)
INSERT #DBTRANS
select vpropiedad.operador + ' ' + vpropiedad.descripcion as propiedad from tproductopropiedad inner join vpropiedad on tproductopropiedad.tcodigopropiedad=vpropiedad.codigo
where tcodigopedido=@tcodigopedido and titem=@titem and tproducto=@tcodigoproducto
order by 1

declare @iTems int
declare @contador int
declare @va nvarchar(max)
insert #dbtrans1 values ('')
select @items=count(*) from #dbtrans
PRINT @items
set @contador=1
while (@contador<=@iTems )
	begin
		select top 1 @va=propiedad from #dbtrans order by 1
		update #dbtrans1 set propiedad=propiedad+'-'+@va
		delete from #dbtrans where propiedad=@va
		set @contador=@contador+1
		--print str(@contador) + 'x'
	end
select * from #dbtrans1
END




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


CREATE PROCEDURE [dbo].[usp_Cheff_ObtieneRegistrosDespacho]   --   '001'
@AREA NVARCHAR(3)
as
begin
set nocount on
--DECLARE @FECHA SMALLDATETIME
DECLARE @ENVIO BIT
--SELECT @FECHA = lFechaChef FROM TPARAMETRO
SELECT @ENVIO = ISNULL(lEnvioChef,0) FROM TPARAMETRO

CREATE TABLE #DBTRANS (Pedido nVarChar(20) collate Modern_Spanish_CI_AS,
					   Tipo nVarChar(200) collate Modern_Spanish_CI_AS, 
					   Mesa nVarChar(80) collate Modern_Spanish_CI_AS,
					   Salon nVarChar(80) collate Modern_Spanish_CI_AS, 
					   Observacion nVarChar(250) collate Modern_Spanish_CI_AS, 
					   Mozo nVarChar(250) collate Modern_Spanish_CI_AS, 
					   Prioridad bit, 
					   Cliente nVarChar(400) collate Modern_Spanish_CI_AS,
					   estado nVarChar(1) collate Modern_Spanish_CI_AS)

insert #DBTRANS
SELECT  distinct   dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS Tipo, ISNULL(dbo.TMESA.tResumido, N'') AS Mesa, 
                      ISNULL(dbo.vSalon.tResumido, N'') AS Salon, ISNULL(dbo.MPEDIDO.tObservacion, N'') AS Observacion, ISNULL(dbo.vMozo.tResumido, N'') AS Mozo, 
                      dbo.MPEDIDO.lPrioridad AS Prioridad, ISNULL(dbo.vDelivery.tApellido + ' ' + dbo.vDelivery.tNombre, N'') AS Cliente, A1.estado
FROM         dbo.vTipoPedido RIGHT OUTER JOIN
                      dbo.MPEDIDO INNER JOIN
                          (SELECT     dbo.DPEDIDO.tCodigoPedido, MAX(
CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

		CASE WHEN @ENVIO = 1 THEN

			  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '0'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '0' else '0' end) end
						 ) end 
						)

			  ELSE

						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '2'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '3' else 'x' end) end
						 ) end 
						)
			   END

		ELSE
			(
				case when datediff(ss,dpedido.fCantadoC,getdate())<  
								case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						 then '1'
			else 
			( 
			case when datediff(ss,dpedido.fCantadoC,getdate())>= 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
			and datediff(ss,dpedido.fCantadoC,getdate())< 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
						then '2'

			else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '3' else 'x' end) end
			 ) end 
			)

		END

ELSE 
'0' 
END) As estado
                            FROM          dbo.MPEDIDO AS MPEDIDO_1 INNER JOIN
                                                   dbo.DPEDIDO ON MPEDIDO_1.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido LEFT OUTER JOIN
                                                   dbo.TPRODUCTOAREA INNER JOIN
                                                   dbo.TPRODUCTO ON dbo.TPRODUCTOAREA.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto ON 
                                                   dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto
                            WHERE      (dbo.TPRODUCTOAREA.tArea = @area) AND (dbo.DPEDIDO.tEstadoItem = 'N')  
                            GROUP BY dbo.DPEDIDO.tCodigoPedido, MPEDIDO_1.tEstadoPedido
                            HAVING      (MPEDIDO_1.tEstadoPedido <> N'03')) AS A1 ON dbo.MPEDIDO.tCodigoPedido = A1.tCodigoPedido ON 
                      dbo.vTipoPedido.Codigo = dbo.MPEDIDO.tTipoPedido LEFT OUTER JOIN
                      dbo.vDelivery ON dbo.MPEDIDO.tClienteDelivery = dbo.vDelivery.Codigo LEFT OUTER JOIN
                      dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo LEFT OUTER JOIN
                      dbo.vSalon INNER JOIN
                      dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa
WHERE  isnull(dbo.mpedido.latendidoc,0)=0 and    (dbo.MPEDIDO.tEstadoPedido <> '03') AND (ISNULL(dbo.MPEDIDO.nReimpresion, 0) > 0) AND ( (dbo.MPEDIDO.tCodigoPedido IN
                          (SELECT DISTINCT DPEDIDO_1.tCodigoPedido
                            FROM          dbo.DPEDIDO AS DPEDIDO_1 INNER JOIN
                                                   dbo.TPRODUCTOAREA AS TPRODUCTOAREA_1 ON DPEDIDO_1.tCodigoProducto = TPRODUCTOAREA_1.tCodigoProducto
                            WHERE      (TPRODUCTOAREA_1.tArea = @AREA) AND (DPEDIDO_1.tEstadoItem = 'N')  )))

ORDER BY dbo.MPEDIDO.tCodigoPedido asc


 insert #DBTRANS
SELECT  distinct   dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS Tipo, ISNULL(dbo.TMESA.tResumido, N'') AS Mesa, 
                      ISNULL(dbo.vSalon.tResumido, N'') AS Salon, ISNULL(dbo.MPEDIDO.tObservacion, N'') AS Observacion, ISNULL(dbo.vMozo.tResumido, N'') AS Mozo, 
                      dbo.MPEDIDO.lPrioridad AS Prioridad, ISNULL(dbo.vDelivery.tApellido + ' ' + dbo.vDelivery.tNombre, N'') AS Cliente, A1.estado
FROM         dbo.vTipoPedido RIGHT OUTER JOIN
                      dbo.MPEDIDO INNER JOIN
                          (SELECT     dbo.DPEDIDO.tCodigoPedido, MAX(
CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

		CASE WHEN @ENVIO = 1 THEN

			  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '0'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '0' else '0' end) end
						 ) end 
						)

			  ELSE

						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '2'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '3' else 'x' end) end
						 ) end 
						)
			   END

		ELSE
			(
				case when datediff(ss,dpedido.fCantadoC,getdate())<  
								case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						 then '1'
			else 
			( 
			case when datediff(ss,dpedido.fCantadoC,getdate())>= 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
			and datediff(ss,dpedido.fCantadoC,getdate())< 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
						then '2'

			else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '3' else 'x' end) end
			 ) end 
			)

		END

ELSE 
'0' 
END) As estado
FROM         dbo.TPRODUCTO AS TPRODUCTO_1 RIGHT OUTER JOIN
                      dbo.CPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN
                      dbo.TPRODUCTO ON dbo.CPEDIDO.tProductoCombo = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.TPRODUCTOAREA ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto RIGHT OUTER JOIN
                      dbo.MPEDIDO AS MPEDIDO_1 ON dbo.DPEDIDO.tCodigoPedido = MPEDIDO_1.tCodigoPedido ON 
                      TPRODUCTO_1.tCodigoProducto = dbo.DPEDIDO.tCodigoProducto
WHERE     (dbo.TPRODUCTOAREA.tArea = @AREA) AND (dbo.DPEDIDO.tEstadoItem = 'N')  
GROUP BY dbo.DPEDIDO.tCodigoPedido, MPEDIDO_1.tEstadoPedido
HAVING      (MPEDIDO_1.tEstadoPedido<> N'03')) AS A1 ON dbo.MPEDIDO.tCodigoPedido = A1.tCodigoPedido ON 
                      dbo.vTipoPedido.Codigo = dbo.MPEDIDO.tTipoPedido LEFT OUTER JOIN
                      dbo.vDelivery ON dbo.MPEDIDO.tClienteDelivery = dbo.vDelivery.Codigo LEFT OUTER JOIN
                      dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo LEFT OUTER JOIN
                      dbo.vSalon INNER JOIN
                      dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa
WHERE  isnull(dbo.mpedido.latendidoc,0)=0 and    (dbo.MPEDIDO.tEstadoPedido <> '03') AND (ISNULL(dbo.MPEDIDO.nReimpresion, 0) > 0) AND ( 
(dbo.mpedido.tcodigopedido in (SELECT     dbo.CPEDIDO.tCodigoPedido
FROM         dbo.TPRODUCTOAREA INNER JOIN
                      dbo.TPRODUCTO ON dbo.TPRODUCTOAREA.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.CPEDIDO ON dbo.TPRODUCTO.tCodigoProducto = dbo.CPEDIDO.tProductoCombo INNER JOIN
                      dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem
WHERE     (dbo.TPRODUCTOAREA.tArea = @area) AND (dbo.DPEDIDO.tEstadoItem = 'N')  
GROUP BY dbo.CPEDIDO.tCodigoPedido)))

ORDER BY dbo.MPEDIDO.tCodigoPedido asc

 
	select Pedido, Tipo,Mesa,Salon,Observacion,Mozo,Prioridad,Cliente,isnull(MAX(ESTADO),4) estado  from #DBTRANS
	group by PEDIDO, TIPO,MESA,SALON,OBSERVACION,MOZO,PRIORIDAD,CLIENTE
	order by 1
END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create procedure [dbo].[usp_Cheff_ObtieneRegistrosDespachoAtendidos]   --   '001'
@fechaAtendido NVARCHAR(100),
@AREA NVARCHAR(3)
as
begin
set nocount on
CREATE TABLE #DBTRANS (Pedido nVarChar(20) collate Modern_Spanish_CI_AS,
					   Tipo nVarChar(200) collate Modern_Spanish_CI_AS, 
					   Mesa nVarChar(80) collate Modern_Spanish_CI_AS,
					   Salon nVarChar(80) collate Modern_Spanish_CI_AS, 
					   Observacion nVarChar(250) collate Modern_Spanish_CI_AS, 
					   Mozo nVarChar(250) collate Modern_Spanish_CI_AS, 
					   Prioridad bit, 
					   Cliente nVarChar(400) collate Modern_Spanish_CI_AS,
					   estado nVarChar(1) collate Modern_Spanish_CI_AS,usuario nVarChar(50) collate Modern_Spanish_CI_AS)


 insert #DBTRANS
SELECT  distinct   dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS Tipo, ISNULL(dbo.TMESA.tResumido, N'') AS Mesa, 
                      ISNULL(dbo.vSalon.tResumido, N'') AS Salon, ISNULL(dbo.MPEDIDO.tObservacion, N'') AS Observacion, ISNULL(dbo.vMozo.tResumido, N'') AS Mozo, 
                      dbo.MPEDIDO.lPrioridad AS Prioridad, ISNULL(dbo.vDelivery.tApellido + ' ' + dbo.vDelivery.tNombre, N'') AS Cliente, '' estado,mpedido.tusuarioatendio as atendio
FrOM         dbo.vTipoPedido RIGHT OUTER JOIN
                      dbo.MPEDIDO ON dbo.vTipoPedido.Codigo = dbo.MPEDIDO.tTipoPedido LEFT OUTER JOIN
                      dbo.vDelivery ON dbo.MPEDIDO.tClienteDelivery = dbo.vDelivery.Codigo LEFT OUTER JOIN
                      dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo LEFT OUTER JOIN
                      dbo.vSalon INNER JOIN
                      dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa
WHERE  isnull(dbo.mpedido.latendidoc,0)=1 and     mpedido.fatendidoc >=@fechaAtendido  and (dbo.MPEDIDO.tEstadoPedido <>'03') AND (ISNULL(dbo.MPEDIDO.nReimpresion, 0) > 0) AND ( (dbo.MPEDIDO.tCodigoPedido IN
                          (SELECT DISTINCT DPEDIDO_1.tCodigoPedido
                            FROM          dbo.DPEDIDO AS DPEDIDO_1 INNER JOIN
                                                   dbo.TPRODUCTOAREA AS TPRODUCTOAREA_1 ON DPEDIDO_1.tCodigoProducto = TPRODUCTOAREA_1.tCodigoProducto
                            WHERE      (TPRODUCTOAREA_1.tArea = @AREA) AND (DPEDIDO_1.tEstadoItem = 'N')  )))
 

ORDER BY dbo.MPEDIDO.tCodigoPedido asc

 insert #DBTRANS
SELECT DISTINCT 
                        dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS Tipo, ISNULL(dbo.TMESA.tResumido, N'') AS Mesa, 
                      ISNULL(dbo.vSalon.tResumido, N'') AS Salon, ISNULL(dbo.MPEDIDO.tObservacion, N'') AS Observacion, ISNULL(dbo.vMozo.tResumido, N'') AS Mozo, 
                      dbo.MPEDIDO.lPrioridad AS Prioridad, ISNULL(dbo.vDelivery.tApellido + ' ' + dbo.vDelivery.tNombre, N'') AS Cliente, '' AS estado, 
                      dbo.MPEDIDO.tUsuarioAtendio AS atendio
FROM         dbo.vTipoPedido RIGHT OUTER JOIN
                      dbo.MPEDIDO ON dbo.vTipoPedido.Codigo = dbo.MPEDIDO.tTipoPedido LEFT OUTER JOIN
                      dbo.vDelivery ON dbo.MPEDIDO.tClienteDelivery = dbo.vDelivery.Codigo LEFT OUTER JOIN
                      dbo.vMozo ON dbo.MPEDIDO.tMozo = dbo.vMozo.Codigo LEFT OUTER JOIN
                      dbo.vSalon INNER JOIN
                      dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa
WHERE     (ISNULL(dbo.MPEDIDO.lAtendidoC, 0) = 1) AND (dbo.MPEDIDO.fAtendidoC >= @fechaAtendido) AND (dbo.MPEDIDO.tEstadoPedido <>'03') AND 
                      (ISNULL(dbo.MPEDIDO.nReimpresion, 0) > 0) AND (dbo.MPEDIDO.tCodigoPedido IN
                          (SELECT     CPEDIDO_1.tCodigoPedido
                            FROM          dbo.TPRODUCTOAREA AS TPRODUCTOAREA_1 INNER JOIN
                                                   dbo.TPRODUCTO AS TPRODUCTO_2 ON TPRODUCTOAREA_1.tCodigoProducto = TPRODUCTO_2.tCodigoProducto INNER JOIN
                                                   dbo.CPEDIDO AS CPEDIDO_1 ON TPRODUCTO_2.tCodigoProducto = CPEDIDO_1.tProductoCombo INNER JOIN
                                                   dbo.DPEDIDO AS DPEDIDO_1 ON CPEDIDO_1.tCodigoPedido = DPEDIDO_1.tCodigoPedido AND 
                                                   CPEDIDO_1.tItem = DPEDIDO_1.tItem
                            WHERE      (TPRODUCTOAREA_1.tArea = @area) AND (DPEDIDO_1.tEstadoItem = 'N')
                            GROUP BY CPEDIDO_1.tCodigoPedido))
ORDER BY Pedido





select Pedido, Tipo,Mesa,Salon,Observacion,Mozo,Prioridad,Cliente,isnull(MAX(ESTADO),4) estado, usuario as atendio  from #DBTRANS
group by PEDIDO, TIPO,MESA,SALON,OBSERVACION,MOZO,PRIORIDAD,CLIENTE,usuario
order by 1
end

  




  

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create procedure [dbo].usp_Cheff_ActualizaCabeceraAtendido
@tcodigopedido nvarchar(10),
@tusuario nvarchar(15)
as

begin

update mpedido set latendidoc=1 , fatendidoc=getdate(), tUsuarioAtendio=@tusuario
where tcodigopedido=@tcodigopedido  

end
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create procedure [dbo].[usp_Cheff_deleteColumnasAreasDespacho]
@tArea nvarchar(3)
as
begin
delete from TAREAPANTALLADESPACHO where tarea=@tArea
end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create procedure  [dbo].[usp_Cheff_InsertaColumnaAreaPantallaDespacho]
@tarea nvarchar(3),
@ncolumna int,
@lmuestra bit,
@norden int,
@nancho float, 
@usuario nvarchar(15),
@tDescripcionMostrar nvarchar(50),
@tDescripcionInterna nvarchar(50)
as
begin
	insert into tareapantalladespacho
	values (@tarea,@ncolumna,@lmuestra,@norden, @nancho,@usuario,getdate(),@tDescripcionMostrar,@tDescripcionInterna)
end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create procedure [dbo].[usp_Cheff_ObtieneOrdenColumnaAreaPantallaDespacho]  
@area nvarchar(3)
as
begin
select nColumna,lmuestra,nOrden,nAncho from tareapantalladespacho
where tarea=@area
order by nOrden
end 


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create procedure [dbo].[usp_Cheff_ObtieneCadenaGrillaDespacho]
@tarea nvarchar(3)
as
begin

select tdescripcionmostrar,tdescripcioninterna,nancho,1 as alinea,lmuestra   from tareapantalladespacho
where tarea=@tarea
order by norden

end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create procedure [dbo].[usp_Cheff_ObtieneDetallePedido]
@pedido nvarchar(15),
@area nvarchar(3)
as
begin
set nocount on

SELECT     dbo.MPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.TPRODUCTO.tResumido, dbo.DPEDIDO.nCantidad
FROM         dbo.DPEDIDO INNER JOIN
                      dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.TPRODUCTOAREA ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto
WHERE   MPEDIDO.TCODIGOPEDIDO=@pedido and (dbo.TPRODUCTOAREA.tArea = @area) AND (ISNULL(dbo.DPEDIDO.lImprime, 0) = 1) AND (dbo.DPEDIDO.tEstadoItem = 'N') and dpedido.lcombinacion=0
union
SELECT     dbo.MPEDIDO.tCodigoPedido, dbo.DPEDIDO.tItem, dbo.TPRODUCTO.tResumido, dbo.DPEDIDO.nCantidad
FROM         dbo.DPEDIDO INNER JOIN
                      dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN
                      dbo.TPRODUCTOAREA ON dbo.CPEDIDO.tProductoCombo = dbo.TPRODUCTOAREA.tCodigoProducto
WHERE   MPEDIDO.TCODIGOPEDIDO=@pedido and  (dbo.TPRODUCTOAREA.tArea =  @area) AND (ISNULL(dbo.DPEDIDO.lImprime, 0) = 1) AND (dbo.DPEDIDO.tEstadoItem = 'N')  and dpedido.lcombinacion=1

end 


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO







SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create PROCEDURE [dbo].[usp_Cheff_ReporteTiempoProductoResumido]        -- '20120101','20121212','','',''
@fInicio As smalldatetime,
@fFinal As smalldatetime,
@tGrupo as nvarchar(30),
@tSubGrupo as nvarchar(30),
@tCodigoProducto as nvarchar(30),
@Orden AS NVARCHAR(1),
@tArea AS NVARCHAR(3)

AS BEGIN
set nocount on
create table #dbtrans2
(grupo varchar(400) collate Modern_Spanish_CI_AS,
 subgrupo varchar(400) collate Modern_Spanish_CI_AS,
 producto varchar(400) collate Modern_Spanish_CI_AS,
 tiempo float,
diferencia float,
cantidad float
)


insert into #dbtrans2
SELECT     vproducto.grupo,vproducto.subgrupo, dbo.vProducto.tResumido AS Producto,  case when dbo.vProducto.nTiempo = 0 then 1 else dbo.vProducto.nTiempo end AS Tiempo, case when DATEDIFF(mi, isnull(dbo.DPEDIDO.fEnvio,1), isnull(dbo.DPEDIDO.fAtendidoC,1)) <=0 then 1 else DATEDIFF(mi, isnull(dbo.DPEDIDO.fEnvio,1), isnull(dbo.DPEDIDO.fAtendidoC,1)) end
                      AS Diferencia, dpedido.ncantidad as cantidad
FROM         dbo.vTipoPedido INNER JOIN
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.vTipoPedido.Codigo = dbo.MPEDIDO.tTipoPedido LEFT OUTER JOIN
                      dbo.vSalon INNER JOIN
                      dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
                      dbo.vMozo ON dbo.DPEDIDO.tmozod = dbo.vMozo.Codigo
WHERE      (ISNULL(dbo.DPEDIDO.lAtendidoC, 0) = 1) AND (dbo.MPEDIDO.tEstadoPedido <> '04') AND 
                      (dbo.DPEDIDO.tEstadoItem = 'N')  and (mpedido.fregistro>=@fInicio) and (mpedido.fregistro<=@fFinal) and (vproducto.tgrupo=@tgrupo or @tgrupo='') and (vproducto.tsubgrupo=@tsubgrupo or @tsubgrupo='') and (vproducto.codigo=@tcodigoproducto or @tcodigoproducto='')
					and vproducto.codigo  in (select tcodigoproducto from tproductoarea where ( tarea=@tArea or @tarea='') )

ORDER BY dbo.MPEDIDO.tCodigoPedido 

if @Orden='0' 
begin
print '1'
select grupo,subgrupo,producto,tiempo,sum(cantidad) as cantidad,round(sum(Isnull(diferencia,0))/sum(cantidad),2) tiempoPromedio, sum(diferencia) as tiempo   from #dbtrans2
group by grupo,subgrupo,producto,tiempo
order by producto
end

else
begin
select grupo,subgrupo,producto,tiempo,sum(cantidad) as cantidad,round(sum(Isnull(diferencia,0))/sum(cantidad),2) tiempoPromedio, sum(diferencia) as tiempo   from #dbtrans2
group by grupo,subgrupo,producto,tiempo
order by   sum(Isnull(diferencia,0)) / (tiempo*sum(cantidad))
end

END





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO






SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create PROCEDURE [dbo].[usp_Cheff_ReporteTiempoProductoDetallado]    
@fInicio As smalldatetime,
@fFinal As smalldatetime,
@tGrupo as nvarchar(30),
@tSubGrupo as nvarchar(30),
@tCodigoProducto as nvarchar(30),
@Orden AS NVARCHAR(1),
@tArea AS NVARCHAR(3)

AS BEGIN
set nocount on 
IF @ORDEN='0' 
BEGIN

SELECT       dbo.MPEDIDO.tCodigoPedido, dbo.vTipoPedido.Descripcion AS Tipo, ISNULL(dbo.vMozo.tResumido, N'') AS Mozo, 
                      ISNULL(dbo.vSalon.Descripcion, N'') AS Salon, ISNULL(dbo.TMESA.tResumido, N'') AS Mesa, dbo.DPEDIDO.tItem AS Item, dbo.vProducto.Codigo, 
                      dbo.vProducto.tResumido AS Producto, dbo.DPEDIDO.fEnvio AS Envio, dbo.DPEDIDO.fCantadoC, dbo.DPEDIDO.fAtendidoC AS Atendido, 
                      dbo.DPEDIDO.tUsuarioAtendio AS AtendidoPor, dbo.vProducto.nTiempo AS Tiempo,case when DATEDIFF(mi, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.fAtendidoC) <=0 then 1 else DATEDIFF(mi, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.fAtendidoC) end 
                      AS Diferencia, case when dbo.vProducto.nTiempo <= DATEDIFF(mi, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.fAtendidoC)  then '0' else ( case when dbo.vProducto.nTiempo = DATEDIFF(mi, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.fAtendidoC) then '1' else '2' end  ) end estado, vproducto.grupo, vproducto.subgrupo, dpedido.ncantidad cantidad,
				CASE WHEN (case when DATEDIFF(mi, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.fAtendidoC) <=0 then 1 else DATEDIFF(mi, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.fAtendidoC) end )<= (dbo.vProducto.nTiempo*dpedido.ncantidad  ) THEN 'A TIEMPO' ELSE 'DEMORA' END AS TIEMPO
FROM         dbo.vTipoPedido INNER JOIN
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.vTipoPedido.Codigo = dbo.MPEDIDO.tTipoPedido LEFT OUTER JOIN
                      dbo.vSalon INNER JOIN
                      dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
                      dbo.vMozo ON dbo.DPEDIDO.tmozod = dbo.vMozo.Codigo
WHERE       (ISNULL(dbo.DPEDIDO.lAtendidoC, 0) = 1) AND (dbo.MPEDIDO.tEstadoPedido <> '04') AND 
                      (dbo.DPEDIDO.tEstadoItem = 'N')  and (mpedido.fregistro>=@fInicio) and (mpedido.fregistro<=@fFinal) and (vproducto.tgrupo=@tgrupo or @tgrupo='') and (vproducto.tsubgrupo=@tsubgrupo or @tsubgrupo='') and (vproducto.codigo=@tcodigoproducto or @tcodigoproducto='')
			and vproducto.codigo  in (select tcodigoproducto from tproductoarea where ( tarea=@tArea or @tarea='') )
ORDER BY  dbo.vProducto.tResumido , case when DATEDIFF(mi, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.fAtendidoC) <=0 then 1 else DATEDIFF(mi, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.fAtendidoC) end desc
END
ELSE
SELECT       dbo.MPEDIDO.tCodigoPedido, dbo.vTipoPedido.Descripcion AS Tipo, ISNULL(dbo.vMozo.tResumido, N'') AS Mozo, 
                      ISNULL(dbo.vSalon.Descripcion, N'') AS Salon, ISNULL(dbo.TMESA.tResumido, N'') AS Mesa, dbo.DPEDIDO.tItem AS Item, dbo.vProducto.Codigo, 
                      dbo.vProducto.tResumido AS Producto, dbo.DPEDIDO.fEnvio AS Envio, dbo.DPEDIDO.fCantadoC, dbo.DPEDIDO.fAtendidoC AS Atendido, 
                      dbo.DPEDIDO.tUsuarioAtendio AS AtendidoPor, dbo.vProducto.nTiempo AS Tiempo,case when DATEDIFF(mi, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.fAtendidoC) <=0 then 1 else DATEDIFF(mi, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.fAtendidoC) end 
                      AS Diferencia, case when dbo.vProducto.nTiempo <= DATEDIFF(mi, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.fAtendidoC)  then '0' else ( case when dbo.vProducto.nTiempo = DATEDIFF(mi, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.fAtendidoC) then '1' else '2' end  ) end estado, vproducto.grupo, vproducto.subgrupo, dpedido.ncantidad cantidad,
				CASE WHEN (case when DATEDIFF(mi, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.fAtendidoC) <=0 then 1 else DATEDIFF(mi, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.fAtendidoC) end )<= (dbo.vProducto.nTiempo*dpedido.ncantidad ) THEN 'A TIEMPO' ELSE 'DEMORA' END AS TIEMPO
FROM         dbo.vTipoPedido INNER JOIN
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.vTipoPedido.Codigo = dbo.MPEDIDO.tTipoPedido LEFT OUTER JOIN
                      dbo.vSalon INNER JOIN
                      dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
                      dbo.vMozo ON dbo.DPEDIDO.tmozod = dbo.vMozo.Codigo
WHERE      (ISNULL(dbo.DPEDIDO.lAtendidoC, 0) = 1) AND (dbo.MPEDIDO.tEstadoPedido <> '04') AND 
                      (dbo.DPEDIDO.tEstadoItem = 'N')  and (mpedido.fregistro>=@fInicio) and (mpedido.fregistro<=@fFinal) and (vproducto.tgrupo=@tgrupo or @tgrupo='') and (vproducto.tsubgrupo=@tsubgrupo or @tsubgrupo='') and (vproducto.codigo=@tcodigoproducto or @tcodigoproducto='')
				and vproducto.codigo  in (select tcodigoproducto from tproductoarea where ( tarea=@tArea or @tarea='') )
ORDER BY case when DATEDIFF(mi, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.fAtendidoC) <=0 then 1 else DATEDIFF(mi, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.fAtendidoC) end desc--,CASE WHEN (case when DATEDIFF(mi, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.fAtendidoC) <=0 then 1 else DATEDIFF(mi, dbo.DPEDIDO.fEnvio, dbo.DPEDIDO.fAtendidoC) end )<= (dbo.vProducto.nTiempo*dpedido.ncantidad ) THEN 'A TIEMPO' ELSE 'DEMORA' END 


END




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE procedure [dbo].[usp_Cheff_ObtenerResumeng]--       '001'
@AREA NVARCHAR(20)
as
begin
set @area=UPPER(@AREA)
CREATE TABLE #DBTRANS (			descripcion nvarchar(100) collate Modern_Spanish_CI_AS,
								pedido nVarChar(15) collate Modern_Spanish_CI_AS, 
                                item  nVarChar(3) collate Modern_Spanish_CI_AS,
                                codigoProducto nVarChar(7) collate Modern_Spanish_CI_AS,
                                producto nVarChar(200) collate Modern_Spanish_CI_AS,
                                cantidad Float,
								 estado nVarChar(1) collate Modern_Spanish_CI_AS)

create table #DBTRANS2
(
PRODUCTO nVarChar(200) collate Modern_Spanish_CI_AS,
                                cantidad Float,
								descripcion nvarchar(100) collate Modern_Spanish_CI_AS,
							   total float,
							   estado nVarChar(1) collate Modern_Spanish_CI_AS
								
)

--begin
insert into #DBTRANS
SELECT      dbo.vArea.Descripcion,dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  , 
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 
                                   case when datediff(mi,dpedido.fenvio,getdate())=tproducto.ntiempo then '0'
                                   else ( case when datediff(mi,dpedido.fenvio,getdate())< tproducto.ntiempo then '1'
                                   else ( case when datediff(mi,dpedido.fenvio,getdate())> tproducto.ntiempo then '2' else 'x' end) end
) end as estado
FROM         
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto   RIGHT OUTER JOIN
                      dbo.TPRODUCTOAREA INNER JOIN
                      dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto
WHERE     (dbo.MPEDIDO.tEstadoPedido = '01') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and isnull(dpedido.latendidoc,0)=0 and dpedido.fenvio is not null  --AND varea.CODIGO=@AREA
union
SELECT      dbo.vArea.Descripcion,dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  ,  
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 
                                   case when datediff(mi,dpedido.fenvio,getdate())=tproducto.ntiempo then '0'
                                   else ( case when datediff(mi,dpedido.fenvio,getdate())< tproducto.ntiempo then '1'
                                   else ( case when datediff(mi,dpedido.fenvio,getdate())> tproducto.ntiempo then '2' else 'x' end) end
) end as estado  
FROM      
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto  RIGHT OUTER JOIN
                      dbo.TPRODUCTOAREA INNER JOIN
                      dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto  
WHERE     (dbo.MPEDIDO.tEstadoPedido = '01') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and isnull(dpedido.latendidoc,0)=0 and dpedido.fenvio is not null    and 
mpedido.tcodigopedido+dpedido.titem in ( 
SELECT     tCodigoPedido+ tItem 
FROM      dbo.TPRODUCTOAREA INNER JOIN
          dbo.TPRODUCTO ON dbo.TPRODUCTOAREA.tCodigoProducto =  dbo.TPRODUCTO.tCodigoProducto INNER JOIN
          dbo.CPEDIDO ON dbo.TPRODUCTO.tCodigoProducto = dbo.CPEDIDO.tProductoCombo INNER JOIN
              dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo
--WHERE VAREA.CODIGO=@area
GROUP BY tCodigoPedido, tItem
)

insert into #DBTRANS2
select producto,sum(cantidad),  descripcion,0, estado
from #DBTRANS
group by producto,descripcion, estado
order by producto,descripcion

update #dbtrans2 set total=(select sum(cantidad) from #dbtrans)

--select producto,descripcion,cantidad,(select sum(cantidad) from #DBTRANS2) total from #DBTRANS2
select producto,cantidad,g.descripcion,cantgroup,(select sum(cantidad) from #DBTRANS2) total ,case when estado=0 then 'A'
                                   else ( case when estado=1 then 'V' else ( case when estado=2 then 'R' end) end) end as estadoc,estado
from #DBTRANS2 g
inner join (select descripcion,sum(cantidad) cantgroup from #DBTRANS2 group by descripcion) v on g.descripcion=v.descripcion
where g.descripcion=@area
end




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


CREATE procedure [dbo].[usp_Cheff_ObtenerResumenz] -- '001'
--@AREA NVARCHAR(3)
as
begin

CREATE TABLE #DBTRANS (			descripcion nvarchar(100) collate Modern_Spanish_CI_AS,
								pedido nVarChar(15) collate Modern_Spanish_CI_AS, 
                                item  nVarChar(3) collate Modern_Spanish_CI_AS,
                                codigoProducto nVarChar(7) collate Modern_Spanish_CI_AS,
                                producto nVarChar(200) collate Modern_Spanish_CI_AS,
                                cantidad Float,
								 estado nVarChar(1) collate Modern_Spanish_CI_AS)

create table #DBTRANS2
(
PRODUCTO nVarChar(200) collate Modern_Spanish_CI_AS,
                                cantidad Float,
								descripcion nvarchar(100) collate Modern_Spanish_CI_AS,
							   total float,
								estado nVarChar(1) collate Modern_Spanish_CI_AS
								
)

--begin
insert into #DBTRANS
SELECT      dbo.vArea.Descripcion,dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  , 
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 
                                   case when datediff(mi,dpedido.fenvio,getdate())=tproducto.ntiempo then '0'
                                   else ( case when datediff(mi,dpedido.fenvio,getdate())< tproducto.ntiempo then '1'
                                   else ( case when datediff(mi,dpedido.fenvio,getdate())> tproducto.ntiempo then '2' else 'x' end) end
) end as estado
FROM         
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto   RIGHT OUTER JOIN
                      dbo.TPRODUCTOAREA INNER JOIN
                      dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto
WHERE     (dbo.MPEDIDO.tEstadoPedido = '01') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and isnull(dpedido.latendidoc,0)=0 and dpedido.fenvio is not null and dbo.vArea.lcheffcontrol=1 --AND varea.CODIGO=@AREA
union
SELECT      dbo.vArea.Descripcion,dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  ,  
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 
                                   case when datediff(mi,dpedido.fenvio,getdate())=tproducto.ntiempo then '0'
                                   else ( case when datediff(mi,dpedido.fenvio,getdate())< tproducto.ntiempo then '1'
                                   else ( case when datediff(mi,dpedido.fenvio,getdate())> tproducto.ntiempo then '2' else 'x' end) end
) end as estado  
FROM      
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto  RIGHT OUTER JOIN
                      dbo.TPRODUCTOAREA INNER JOIN
                      dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto  
WHERE     (dbo.MPEDIDO.tEstadoPedido = '01') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and isnull(dpedido.latendidoc,0)=0 and dpedido.fenvio is not null    and 
mpedido.tcodigopedido+dpedido.titem in ( 
SELECT     tCodigoPedido+ tItem 
FROM      dbo.TPRODUCTOAREA INNER JOIN
          dbo.TPRODUCTO ON dbo.TPRODUCTOAREA.tCodigoProducto =  dbo.TPRODUCTO.tCodigoProducto INNER JOIN
          dbo.CPEDIDO ON dbo.TPRODUCTO.tCodigoProducto = dbo.CPEDIDO.tProductoCombo INNER JOIN
              dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo
--WHERE VAREA.CODIGO=@area
GROUP BY tCodigoPedido, tItem
)

insert into #DBTRANS2
select producto,sum(cantidad),  descripcion,0, estado
from #DBTRANS
group by producto,descripcion,estado
order by producto,descripcion

update #dbtrans2 set total=(select sum(cantidad) from #dbtrans)

select distinct(descripcion) from #DBTRANS2
end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE procedure [dbo].[usp_Cheff_ObtenerResument]      --'001'
@AREA NVARCHAR(20)
as
begin
set @area=UPPER(@AREA)
CREATE TABLE #DBTRANS (			descripcion nvarchar(100) collate Modern_Spanish_CI_AS,
								pedido nVarChar(15) collate Modern_Spanish_CI_AS, 
                                item  nVarChar(3) collate Modern_Spanish_CI_AS,
                                codigoProducto nVarChar(7) collate Modern_Spanish_CI_AS,
                                producto nVarChar(200) collate Modern_Spanish_CI_AS,
                                cantidad Float,
								 estado nVarChar(1) collate Modern_Spanish_CI_AS)

create table #DBTRANS2
(
PRODUCTO nVarChar(200) collate Modern_Spanish_CI_AS,
                                cantidad Float,
								descripcion nvarchar(100) collate Modern_Spanish_CI_AS,
							   total float,
							   estado nVarChar(1) collate Modern_Spanish_CI_AS
								
)

create table #DBTRANS3
(
                                cantidad float,
								porcentaje Float,
								estado nVarChar(1) collate Modern_Spanish_CI_AS,
								descripcion nvarchar(100) collate Modern_Spanish_CI_AS
							  
								
)

create table #DBTRANS4
(								area nvarchar(100) collate Modern_Spanish_CI_AS,
								estado float,
								color nVarChar(1) collate Modern_Spanish_CI_AS
)
--begin
insert into #DBTRANS
SELECT      dbo.vArea.Descripcion,dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  , 
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 
                                   case when datediff(mi,dpedido.fenvio,getdate())=tproducto.ntiempo then '0'
                                   else ( case when datediff(mi,dpedido.fenvio,getdate())< tproducto.ntiempo then '1'
                                   else ( case when datediff(mi,dpedido.fenvio,getdate())> tproducto.ntiempo then '2' else 'x' end) end
) end as estado
FROM         
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto   RIGHT OUTER JOIN
                      dbo.TPRODUCTOAREA INNER JOIN
                      dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto
WHERE     (dbo.MPEDIDO.tEstadoPedido = '01') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and isnull(dpedido.latendidoc,0)=0 and dpedido.fenvio is not null and dbo.vArea.lcheffcontrol=1 --AND varea.CODIGO=@AREA
union
SELECT      dbo.vArea.Descripcion,dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  ,  
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 
                                   case when datediff(mi,dpedido.fenvio,getdate())=tproducto.ntiempo then '0'
                                   else ( case when datediff(mi,dpedido.fenvio,getdate())< tproducto.ntiempo then '1'
                                   else ( case when datediff(mi,dpedido.fenvio,getdate())> tproducto.ntiempo then '2' else 'x' end) end
) end as estado  
FROM      
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto  RIGHT OUTER JOIN
                      dbo.TPRODUCTOAREA INNER JOIN
                      dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto  
WHERE     (dbo.MPEDIDO.tEstadoPedido = '01') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and isnull(dpedido.latendidoc,0)=0 and dpedido.fenvio is not null    and 
mpedido.tcodigopedido+dpedido.titem in ( 
SELECT     tCodigoPedido+ tItem 
FROM      dbo.TPRODUCTOAREA INNER JOIN
          dbo.TPRODUCTO ON dbo.TPRODUCTOAREA.tCodigoProducto =  dbo.TPRODUCTO.tCodigoProducto INNER JOIN
          dbo.CPEDIDO ON dbo.TPRODUCTO.tCodigoProducto = dbo.CPEDIDO.tProductoCombo INNER JOIN
              dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo
--WHERE VAREA.CODIGO=@area
GROUP BY tCodigoPedido, tItem
)

insert into #DBTRANS2
select producto,sum(cantidad),  descripcion,0, estado
from #DBTRANS
group by producto,descripcion, estado
order by producto,descripcion

update #dbtrans2 set total=(select sum(cantidad) from #dbtrans)

--select producto,descripcion,cantidad,(select sum(cantidad) from #DBTRANS2) total from #DBTRANS2
--select producto,cantidad,g.descripcion,cantgroup,(select sum(cantidad) from #DBTRANS2) total ,case when estado=0 then 'A'
 --                                  else ( case when estado=1 then 'V' else ( case when estado=2 then 'R' end) end) end as estadoc,estado
--from #DBTRANS2 g
--inner join (select descripcion,sum(cantidad) cantgroup from #DBTRANS2 group by descripcion) v on g.descripcion=v.descripcion
------------
--select case when sum(cantidad) is null then 0 else sum(cantidad) as cantidad,case when (sum(cantidad)/(select sum(cantidad) from #DBTRANS2 ))*100 is null then 0 else ((sum(cantidad)/(select sum(cantidad) from #DBTRANS2 ))*100) as porcentaje,case when estado=0 then 'A'
--else ( case when estado=1 then 'V' else ( case when estado=2 then 'R' end) end) end as estadoc 
--from #DBTRANS2 
--group by estado
-------------
--select g.descripcion,cantgroup, cantidad,((cantgroup/(select sum(cantidad) from #DBTRANS2))*100) as total, case when estado=0 then 'A'
--                                  else ( case when estado=1 then 'V' else ( case when estado=2 then 'R' end) end) end as estadoc,estado
-------------------------------
--select descripcion,case when sum(cantidad) is null then 0 else sum(cantidad) end as cantidad,(sum(cantidad)/total)*100 as porcentaje,estado from #DBTRANS2 where estado='2' group by descripcion, total, estado
--union all
--select descripcion,case when sum(cantidad) is null then 0 else sum(cantidad) end as cantidad,(sum(cantidad)/total)*100 as porcentaje,estado from #DBTRANS2 where estado='1' group by descripcion, total, estado
--union all
--select descripcion,case when sum(cantidad) is null then 0 else sum(cantidad) end as cantidad,(sum(cantidad)/total)*100 as porcentaje,estado from #DBTRANS2 where estado='0' group by descripcion, total, estado
------------------------------------
--insert into #DBTRANS4 values(1,'R')
--insert into #DBTRANS4 values(0,'A')
--insert into #DBTRANS4 values(2,'V')
------------------------------------
--select sum(cantidad) as cantidad,d.descripcion,d.estado as estado 
--from #DBTRANS2 d 
--full join #DBTRANS4 t on d.estado=t.estado
--full join varea r on d.descripcion=r.descripcion
--where d.estado=2 
--select * from varea
--group by d.descripcion,d.estado
declare cursor_pruebat cursor for
select descripcion from varea
declare @des varchar(25)
--declare @apellidos varchar(25)
open cursor_pruebat
fetch next from cursor_pruebat
into @des
while @@fetch_status = 0
begin
--print 'El Nombre de la persona es: ' + @nombres + ' y sus apellidos: ' + @apellidos
insert into #DBTRANS4 values (@des,2,'R')
insert into #DBTRANS4 values (@des,0,'A')
insert into #DBTRANS4 values (@des,1,'V')
fetch next from cursor_pruebat
into @des
end
close cursor_pruebat 
deallocate cursor_pruebat 
--select * from #DBTRANS4
select p.cant,x.totalx,case when x.totalx=0 then 0 else ROUND((x.totalx/p.cant),2) end as porcentaje,x.area,x.estado,case when estado='0' then 'A' else (case when estado='1' then 'V' else (case when estado='2' then 'R' end) end) end as color,case when estado='0' then '1' else (case when estado='1' then '0' else (case when estado='2' then '2' end) end) end as valor from(
select case when sum(cantidad) is null then 0 else sum(cantidad) end as totalx,t.area as area,t.estado as estado
from #DBTRANS2 h
right outer join #DBTRANS4 t on h.descripcion=t.area and h.estado=t.estado
group by h.descripcion,t.estado,t.area) x
inner join (select sum(cantidad)as cant, descripcion from #DBTRANS2 group by descripcion) p on x.area=p.descripcion
where x.area=@area
order by valor

--left outer join #DBTRANS4 g on d.estado=g.estado
--where d.estado=1 
--group by descripcion,d.estado,cantidad
--select * from varea

--select * from #DBTRANS3

--select * from #DBTRANS3

--select case when sum(cantidad) is null then 0 else sum(cantidad) end as cantidad,case when sum(porcentaje) is null then 0 else sum(porcentaje) end as porcentaje,'R' as estadoc,descripcion from #DBTRANS3 where estado=0 group by descripcion
--select case when cantidad is null then 0 else cantidad end as cant from #DBTRANS3 --where estado=0
--select case when cantidad is null then 0 else cantidad from #DBTRANS3 where estado=1
--order by estado
--group by descripcion
--from #DBTRANS2 g
--inner join (select descripcion,sum(cantidad) cantgroup from #DBTRANS2 group by descripcion) v on g.descripcion=v.descripcion
--select (select (case when sum(cantidad) is null then 0 else sum(cantidad) end) as cantidad from #DBTRANS2)sum(cantidad) as cantidad,(sum(cantidad)/(select sum(cantidad) from #DBTRANS2 ))*100 as porcentaje,'R' as estadoc
--from #DBTRANS2 
end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc [dbo].[usp_validarUsuario]
@susuario nvarchar(15),
@scontrasenia nvarchar(50)
as
BEGIN
select *
from tusuario
where tresumido=@susuario and tpassword=@scontrasenia
END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE procedure  [dbo].[usp_Cheff_LimpaPedidos]
@fecha nvarchar(100),
@usuario nvarchar(15)
as
begin


update dpedido
set latendidoc=1,fatendidoc=fenvio , fcantadoc=fenvio,lcantadoc=1,tusuarioAtendio=@usuario
from dpedido inner join mpedido on mpedido.tcodigopedido=dpedido.tcodigopedido
where mpedido.fregistro<@fecha and isnull(dpedido.latendidoc,0)=0
 

update mpedido
set latendidoc=1,fatendidoc=fregistro , tusuarioAtendio=@usuario
from mpedido
where mpedido.fregistro<@fecha and isnull(mpedido.latendidoc,0)=0



end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE procedure [dbo].[usp_Cheff_RevertirDetalleCantado]
@tcodigopedido nvarchar(10),
@titem nvarchar(3),
@tcodigoproducto nvarchar(7)
 
as

begin

declare @cantado bit


select @cantado=isnull(lcantadoc,0)
from dpedido where tcodigopedido=@tcodigopedido and titem=@titem and tcodigoproducto=@tcodigoproducto

--if @cantado=0
--begin
--
--update dpedido set lcantadoc=1 , fcantadoc=getdate()
--where tcodigopedido=@tcodigopedido and titem=@titem and tcodigoproducto=@tcodigoproducto
--end
if @cantado=1
begin
 
update dpedido set lcantadoc=0 ,fcantadoc=null
where tcodigopedido=@tcodigopedido and titem=@titem and tcodigoproducto=@tcodigoproducto
end

end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO












SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE procedure [dbo].[usp_Cheff_ObtienePropiedadesItemsCombos]
@tcodigopedido nvarchar(10),
@titem nvarchar(3),
@titemCombo nvarchar(3)
as
set nocount on
BEGIN
create table #dbtrans (propiedad   nVarChar(max) collate Modern_Spanish_CI_AS)
create table #dbtrans1 (propiedad   nVarChar(max) collate Modern_Spanish_CI_AS)
INSERT #DBTRANS
select vpropiedad.operador + ' ' + vpropiedad.descripcion as propiedad from 
TCOMBOPROPIEDAD inner join vpropiedad on 
TCOMBOPROPIEDAD.tcodigopropiedad=vpropiedad.codigo
where tcodigopedido=@tcodigopedido and titem=@titem and  tItemCombo=@titemCombo
order by 1

declare @iTems int
declare @contador int
declare @va nvarchar(max)
insert #dbtrans1 values ('')
select @items=count(*) from #dbtrans
PRINT @items
set @contador=1
while (@contador<=@iTems )
	begin
		select top 1 @va=propiedad from #dbtrans order by 1
		update #dbtrans1 set propiedad=propiedad+'-'+@va
		delete from #dbtrans where propiedad=@va
		set @contador=@contador+1
		--print str(@contador) + 'x'
	end
select * from #dbtrans1
END





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc usp_Seg_cLientes
@tModulo nvarchar(50),
@tDbName nvarchar(50),
@nCantidad int
as

begin
set nocount on
declare @nlicencias int
declare @nlicenciasActuales int
IF NOT OBJECT_ID('tempdb.dbo.#sp_who2') IS NULL  
DROP TABLE dbo.#sp_who2  
  
CREATE TABLE #sp_who2  
    (SPID INT,   
    Status VARCHAR(1000) NULL,   
    Login SYSNAME NULL,   
    HostName SYSNAME NULL,   
    BlkBy SYSNAME NULL,   
    DBName SYSNAME NULL,   
    Command VARCHAR(1000) NULL,   
    CPUTime INT NULL,   
    DiskIO INT NULL,   
    LastBatch VARCHAR(1000) NULL,   
    ProgramName VARCHAR(1000) NULL,   
    SPID2 INT,  
    REQUESTID INT)   
   
    -- Inserto los valores  
    INSERT INTO #sp_who2  
    EXEC sp_who2  
 
 
    select @nlicenciasActuales=isnull(count(HostName),0)  from #sp_who2
    where ProgramName=@tModulo and DBName=@tDbName 
	
	if @nlicenciasActuales > @nCantidad 
 
		begin 
			select 0 ------------------------- NO INGRESA AL SISTEMA
		end
	ELSE
		BEGIN
			select 1 ------------------------- INGRESA
		END
 
    end 

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO







SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


create proc [dbo].[usp_Seg_verConexiones]   
 @dbName nvarchar(150) ,
 @ProgramName nvarchar(150)
as

begin
set nocount on
 
IF NOT OBJECT_ID('tempdb.dbo.#sp_who2') IS NULL  
DROP TABLE dbo.#sp_who2  
  
CREATE TABLE #sp_who2  
    (SPID INT,   
    Status VARCHAR(1000) NULL,   
    Login SYSNAME NULL,   
    HostName SYSNAME NULL,   
    BlkBy SYSNAME NULL,   
    DBName SYSNAME NULL,   
    Command VARCHAR(1000) NULL,   
    CPUTime INT NULL,   
    DiskIO INT NULL,   
    LastBatch VARCHAR(1000) NULL,   
    ProgramName VARCHAR(1000) NULL,   
    SPID2 INT, 
	requestid int)   
   
    -- Inserto los valores  
    INSERT INTO #sp_who2  
    EXEC sp_who2  
  
    select PROGRAMNAME,DBNAME,HOSTNAME from #sp_who2
	where   UPPER(dbname)=UPPER(@dbName) and UPPER(programname)=UPPER(@programname)
	order by programname,dbname,hostname
    end 



SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[spRep_PlanillaMovilidad] 
@tMotorizado as nvarchar(20),
@finicio as smalldatetime,
@ffinal as smalldatetime,
@nMonto AS float, 
@tTipo as nvarchar(1),
@tTarifa As nVarchar(1)


AS 
BEGIN
SET NOCOUNT ON 
DECLARE @sCriterio nvarchar(140)
CREATE TABLE #DBTRANS (DNI nVarchar(50)collate Modern_Spanish_CI_AS, TRABAJADOR  nVarchar(200) collate Modern_Spanish_CI_AS,
                       MOTIVO nVarchar(200) collate Modern_Spanish_CI_AS, DESTINO nVarchar(500) collate Modern_Spanish_CI_AS,
                       IMPORTE Float, TARIFA  nVarchar(4) collate Modern_Spanish_CI_AS,
                       Fecha Varchar(50) collate Modern_Spanish_CI_AS, MES nVarchar(50) collate Modern_Spanish_CI_AS)	

IF @tTipo='D'

BEGIN
	IF len(@tmotorizado)=0
		BEGIN
				INSERT INTO #DBTRANS
				SELECT     dbo.TMOTORIZADODATOS.tDocumentoIdentidad AS DNI, dbo.vMotorizado.Descripcion AS TRABAJADOR, 
									  'Entrega de Pedido: N ' + dbo.MPEDIDO.tCodigoPedido AS MOTIVO, dbo.vDelivery.tDireccion + '  ' + dbo.vDelivery.tReferencia AS DESTINO, 
									  ISNULL(dbo.MPEDIDO.nTarifaMotorizado, 0) AS IMPORTE, mpedido.nTarifaExtra As TARIFA, '' FECHA, '' MES
				FROM         dbo.vMotorizado INNER JOIN
									  dbo.TMOTORIZADODATOS ON dbo.vMotorizado.Codigo = dbo.TMOTORIZADODATOS.tCodigo INNER JOIN
									  dbo.MPEDIDO ON dbo.vMotorizado.Codigo = dbo.MPEDIDO.tMotorizado INNER JOIN
									  dbo.vDelivery ON dbo.MPEDIDO.tClienteDelivery = dbo.vDelivery.Codigo
				WHERE   mpedido.fasignacion >= @fInicio and mpedido.fasignacion<= @ffinal 
				and (vmotorizado.codigo in ( select tmotorizado    from mpedido 
											 where fasignacion>=@finicio and  fasignacion<=@ffinal and mpedido.testadopedido<>'03'
											 group by tmotorizado
											 having sum(isnull(ntarifamotorizado,0))>@nMonto ))
											 order by 2
									
				--REASIGNACIONES							
				INSERT INTO #DBTRANS
				SELECT     dbo.TMOTORIZADODATOS.tDocumentoIdentidad AS DNI, dbo.vMotorizado.Descripcion AS TRABAJADOR, 
									  'Entrega de Pedido: N ' + dbo.MPEDIDO.tCodigoPedido AS MOTIVO, dbo.vDelivery.tDireccion + '  ' + dbo.vDelivery.tReferencia AS DESTINO, 
									  ISNULL(dbo.MPEDIDO.nTarifaMotorizadoN, 0) AS IMPORTE, mpedido.nTarifaExtraN As TARIFA, '' FECHA, '' MES
				FROM         dbo.vMotorizado INNER JOIN
									  dbo.TMOTORIZADODATOS ON dbo.vMotorizado.Codigo = dbo.TMOTORIZADODATOS.tCodigo INNER JOIN
									  dbo.MPEDIDO ON dbo.vMotorizado.Codigo = dbo.MPEDIDO.tMotorizadoN INNER JOIN
									  dbo.vDelivery ON dbo.MPEDIDO.tClienteDelivery = dbo.vDelivery.Codigo
				WHERE  mpedido.fasignacion >= @fInicio and mpedido.fasignacion<= @ffinal 
				and (vmotorizado.codigo in ( select tmotorizadoN    from mpedido 
											 where fasignacion>=@finicio and  fasignacion<=@ffinal and mpedido.testadopedido<>'03'
											 group by tmotorizadoN
											 having sum(isnull(ntarifamotorizadoN,0))>@nMonto ))
											 order by 2
		END
		
	ELSE
	
		BEGIN
				INSERT INTO #DBTRANS
				SELECT     dbo.TMOTORIZADODATOS.tDocumentoIdentidad AS DNI, dbo.vMotorizado.Descripcion AS TRABAJADOR, 
									  'Entrega de Pedido: N ' + dbo.MPEDIDO.tCodigoPedido AS MOTIVO, dbo.vDelivery.tDireccion + '  ' + dbo.vDelivery.tReferencia AS DESTINO, 
									  ISNULL(dbo.MPEDIDO.nTarifaMotorizado, 0) AS IMPORTE, mpedido.nTarifaExtra As TARIFA, '' FECHA, '' MES
				FROM         dbo.vMotorizado INNER JOIN
									  dbo.TMOTORIZADODATOS ON dbo.vMotorizado.Codigo = dbo.TMOTORIZADODATOS.tCodigo INNER JOIN
									  dbo.MPEDIDO ON dbo.vMotorizado.Codigo = dbo.MPEDIDO.tMotorizado INNER JOIN
									  dbo.vDelivery ON dbo.MPEDIDO.tClienteDelivery = dbo.vDelivery.Codigo
				WHERE (vmotorizado.codigo=@tmotorizado or @tmotorizado is null) and   mpedido.fasignacion >= @fInicio and mpedido.fasignacion<= @ffinal
				and (vmotorizado.codigo in ( select tmotorizado    from mpedido 
											 where fasignacion>=@finicio and  fasignacion<=@ffinal and mpedido.testadopedido<>'03'
											 group by tmotorizado
											 having sum(isnull(ntarifamotorizado,0))>@nMonto ))
				                             order by 2
				
				--REASIGNACION
				INSERT INTO #DBTRANS
				SELECT     dbo.TMOTORIZADODATOS.tDocumentoIdentidad AS DNI, dbo.vMotorizado.Descripcion AS TRABAJADOR, 
									  'Entrega de Pedido: N ' + dbo.MPEDIDO.tCodigoPedido AS MOTIVO, dbo.vDelivery.tDireccion + '  ' + dbo.vDelivery.tReferencia AS DESTINO, 
									  ISNULL(dbo.MPEDIDO.nTarifaMotorizadoN, 0) AS IMPORTE, mpedido.nTarifaExtraN As TARIFA, '' FECHA, '' MES
				FROM         dbo.vMotorizado INNER JOIN
									  dbo.TMOTORIZADODATOS ON dbo.vMotorizado.Codigo = dbo.TMOTORIZADODATOS.tCodigo INNER JOIN
									  dbo.MPEDIDO ON dbo.vMotorizado.Codigo = dbo.MPEDIDO.tMotorizadoN INNER JOIN
									  dbo.vDelivery ON dbo.MPEDIDO.tClienteDelivery = dbo.vDelivery.Codigo
				WHERE (vmotorizado.codigo=@tmotorizado or @tmotorizado is null) and  mpedido.fasignacion >= @fInicio and mpedido.fasignacion<= @ffinal
				and (vmotorizado.codigo in ( select tmotorizadoN    from mpedido 
											 where fasignacion>=@finicio and  fasignacion<=@ffinal and mpedido.testadopedido<>'03'
											 group by tmotorizadoN
											 having sum(isnull(nTarifaMotorizadoN,0))>@nMonto ))
				                             order by 2
				
		END
					
END



ELSE



BEGIN

		IF len(@tmotorizado)=0
			BEGIN
			            INSERT INTO #DBTRANS 
						SELECT     dbo.TMOTORIZADODATOS.tDocumentoIdentidad AS DNI, dbo.vMotorizado.Descripcion AS TRABAJADOR, 
											  '' MOTIVO,'' DESTINO, SUM(ISNULL(dbo.MPEDIDO.nTarifaMotorizado, 0)) AS IMPORTE, mpedido.nTarifaExtra As TARIFA, '' FECHA, '' MES
						FROM         dbo.vMotorizado INNER JOIN
											  dbo.TMOTORIZADODATOS ON dbo.vMotorizado.Codigo = dbo.TMOTORIZADODATOS.tCodigo INNER JOIN
											  dbo.MPEDIDO ON dbo.vMotorizado.Codigo = dbo.MPEDIDO.tMotorizado
						WHERE  mpedido.fasignacion >= @fInicio and mpedido.fasignacion<= @ffinal
						GROUP BY dbo.TMOTORIZADODATOS.tDocumentoIdentidad, dbo.vMotorizado.Descripcion, dbo.vMotorizado.Codigo, mpedido.nTarifaExtra
						HAVING      (SUM(ISNULL(dbo.MPEDIDO.nTarifaMotorizado, 0))>@nMonto) 
						ORDER BY TRABAJADOR
						
						
						--REASIGNACION
						INSERT INTO #DBTRANS 
						SELECT     dbo.TMOTORIZADODATOS.tDocumentoIdentidad AS DNI, dbo.vMotorizado.Descripcion AS TRABAJADOR, 
											  '' MOTIVO,'' DESTINO, SUM(ISNULL(dbo.MPEDIDO.nTarifaMotorizadoN, 0)) AS IMPORTE, mpedido.nTarifaExtraN As TARIFA, '' FECHA, '' MES
						FROM         dbo.vMotorizado INNER JOIN
											  dbo.TMOTORIZADODATOS ON dbo.vMotorizado.Codigo = dbo.TMOTORIZADODATOS.tCodigo INNER JOIN
											  dbo.MPEDIDO ON dbo.vMotorizado.Codigo = dbo.MPEDIDO.tMotorizadoN
						WHERE  mpedido.fasignacion >= @fInicio and mpedido.fasignacion<= @ffinal
						GROUP BY dbo.TMOTORIZADODATOS.tDocumentoIdentidad, dbo.vMotorizado.Descripcion, dbo.vMotorizado.Codigo, mpedido.nTarifaExtraN
						HAVING      (SUM(ISNULL(dbo.MPEDIDO.nTarifaMotorizadoN, 0))>@nMonto) 
						ORDER BY TRABAJADOR
						
			END
			
			
		ELSE
		
		
			BEGIN
			            INSERT INTO #DBTRANS
						SELECT     dbo.TMOTORIZADODATOS.tDocumentoIdentidad AS DNI, dbo.vMotorizado.Descripcion AS TRABAJADOR, 
											  '' MOTIVO,'' DESTINO, SUM(ISNULL(dbo.MPEDIDO.nTarifaMotorizado, 0)) AS IMPORTE, mpedido.nTarifaExtra As TARIFA, '' FECHA, '' MES
						FROM         dbo.vMotorizado INNER JOIN
											  dbo.TMOTORIZADODATOS ON dbo.vMotorizado.Codigo = dbo.TMOTORIZADODATOS.tCodigo INNER JOIN
											  dbo.MPEDIDO ON dbo.vMotorizado.Codigo = dbo.MPEDIDO.tMotorizado
						WHERE  mpedido.fasignacion >= @fInicio and mpedido.fasignacion<= @ffinal
						GROUP BY dbo.TMOTORIZADODATOS.tDocumentoIdentidad, dbo.vMotorizado.Descripcion, dbo.vMotorizado.Codigo, mpedido.nTarifaExtra
						HAVING      (SUM(ISNULL(dbo.MPEDIDO.nTarifaMotorizado, 0))>@nMonto) AND (dbo.vMotorizado.Codigo =@tmotorizado)
						ORDER BY TRABAJADOR
						
						
						--REASIGNACION
						INSERT INTO #DBTRANS
						SELECT     dbo.TMOTORIZADODATOS.tDocumentoIdentidad AS DNI, dbo.vMotorizado.Descripcion AS TRABAJADOR, 
											  '' MOTIVO,'' DESTINO, SUM(ISNULL(dbo.MPEDIDO.nTarifaMotorizadoN, 0)) AS IMPORTE, mpedido.nTarifaExtraN As TARIFA, '' FECHA, '' MES
						FROM         dbo.vMotorizado INNER JOIN
											  dbo.TMOTORIZADODATOS ON dbo.vMotorizado.Codigo = dbo.TMOTORIZADODATOS.tCodigo INNER JOIN
											  dbo.MPEDIDO ON dbo.vMotorizado.Codigo = dbo.MPEDIDO.tMotorizadoN
						WHERE   mpedido.fasignacion >= @fInicio and mpedido.fasignacion<= @ffinal
						GROUP BY dbo.TMOTORIZADODATOS.tDocumentoIdentidad, dbo.vMotorizado.Descripcion, dbo.vMotorizado.Codigo, mpedido.nTarifaExtraN
						HAVING      (SUM(ISNULL(dbo.MPEDIDO.nTarifaMotorizadoN, 0))>@nMonto) AND (dbo.vMotorizado.Codigo =@tmotorizado)
						ORDER BY TRABAJADOR
						
			END

END



IF @tTipo='D'
 
	If @tTarifa = 'O' -- Oficial
		Begin
		  SELECT * FROM #DBTRANS WHERE TARIFA <>'1' 
		End 
	Else If @tTarifa = 'E'  -- Extra
		Begin
		  SELECT * FROM #DBTRANS WHERE TARIFA <>'0' 
		End 
	Else  -- Todos
		Begin
		  SELECT * FROM #DBTRANS 
		End  
ELSE

	If @tTarifa = 'O' -- Oficial
		Begin
			SELECT DNI,TRABAJADOR,SUM(IMPORTE) AS IMPORTE, MOTIVO, DESTINO, TARIFA, Fecha, MES FROM #DBTRANS 
			WHERE TARIFA <>'1'
			GROUP BY DNI,TRABAJADOR ,DESTINO, MOTIVO ,TARIFA, Fecha, MES 
		End 
	Else If @tTarifa = 'E'  -- Extra
		Begin
		  	SELECT DNI,TRABAJADOR,SUM(IMPORTE) AS IMPORTE, MOTIVO, DESTINO, TARIFA, Fecha, MES FROM #DBTRANS 
			WHERE TARIFA <>'0'
			GROUP BY DNI,TRABAJADOR ,DESTINO, MOTIVO ,TARIFA, Fecha, MES 
		End 
	Else  -- Todos
		Begin
			SELECT DNI,TRABAJADOR,SUM(IMPORTE) AS IMPORTE, Fecha,MES from #DBTRANS 
			GROUP BY DNI,TRABAJADOR, Fecha,MES 
		End  
 
END


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[spRep_PlanillaMovilidadGeneral] 
@tMotorizado as nvarchar(20),
@finicio as smalldatetime,
@ffinal as smalldatetime

AS 
BEGIN
SET NOCOUNT ON 
DECLARE @sCriterio nvarchar(140)
CREATE TABLE #DBTRANS (DNI nVarchar(50)collate Modern_Spanish_CI_AS, TRABAJADOR  nVarchar(200) collate Modern_Spanish_CI_AS,
                       OFICIAL Float, EXTRA Float, IMPORTE Float)

BEGIN

		IF len(@tmotorizado)=0
			BEGIN
			            INSERT INTO #DBTRANS 
						SELECT     dbo.TMOTORIZADODATOS.tDocumentoIdentidad AS DNI, dbo.vMotorizado.Descripcion AS TRABAJADOR, 
						            (SELECT OFICIAL = CASE dbo.MPEDIDO.nTarifaExtra WHEN '0' THEN SUM(ISNULL(dbo.MPEDIDO.nTarifaMotorizado, 0))
                                       ELSE 0 END) As OFICIAL,
                                    (SELECT EXTRA = CASE dbo.MPEDIDO.nTarifaExtra WHEN '1' THEN SUM(ISNULL(dbo.MPEDIDO.nTarifaMotorizado, 0))
                                       ELSE 0 END) As EXTRA,
                                       0 As IMPORTE
						FROM         dbo.vMotorizado INNER JOIN
											  dbo.TMOTORIZADODATOS ON dbo.vMotorizado.Codigo = dbo.TMOTORIZADODATOS.tCodigo INNER JOIN
											  dbo.MPEDIDO ON dbo.vMotorizado.Codigo = dbo.MPEDIDO.tMotorizado
						WHERE    mpedido.fasignacion >= @fInicio and mpedido.fasignacion<= @ffinal
						GROUP BY dbo.TMOTORIZADODATOS.tDocumentoIdentidad, dbo.vMotorizado.Descripcion, dbo.vMotorizado.Codigo, mpedido.nTarifaExtra
						ORDER BY TRABAJADOR
						
						
						--REASIGNACION
						INSERT INTO #DBTRANS 
						SELECT     dbo.TMOTORIZADODATOS.tDocumentoIdentidad AS DNI, dbo.vMotorizado.Descripcion AS TRABAJADOR, 
						            (SELECT OFICIAL = CASE dbo.MPEDIDO.nTarifaExtraN WHEN '0' THEN SUM(ISNULL(dbo.MPEDIDO.nTarifaMotorizadoN, 0))
                                       ELSE 0 END) As OFICIAL,
                                    (SELECT EXTRA = CASE dbo.MPEDIDO.nTarifaExtraN WHEN '1' THEN SUM(ISNULL(dbo.MPEDIDO.nTarifaMotorizadoN, 0))
                                       ELSE 0 END) As EXTRA,
                                       0 As IMPORTE
						FROM         dbo.vMotorizado INNER JOIN
											  dbo.TMOTORIZADODATOS ON dbo.vMotorizado.Codigo = dbo.TMOTORIZADODATOS.tCodigo INNER JOIN
											  dbo.MPEDIDO ON dbo.vMotorizado.Codigo = dbo.MPEDIDO.tMotorizadoN
						WHERE mpedido.fasignacion >= @fInicio and mpedido.fasignacion<= @ffinal
						GROUP BY dbo.TMOTORIZADODATOS.tDocumentoIdentidad, dbo.vMotorizado.Descripcion, dbo.vMotorizado.Codigo, mpedido.nTarifaExtraN
						ORDER BY TRABAJADOR
						
			END
			
			
		ELSE
		
		
			BEGIN
			            INSERT INTO #DBTRANS
						SELECT     dbo.TMOTORIZADODATOS.tDocumentoIdentidad AS DNI, dbo.vMotorizado.Descripcion AS TRABAJADOR, 
						            (SELECT OFICIAL = CASE dbo.MPEDIDO.nTarifaExtra WHEN '0' THEN SUM(ISNULL(dbo.MPEDIDO.nTarifaMotorizado, 0))
                                       ELSE 0 END) As OFICIAL,
                                    (SELECT EXTRA = CASE dbo.MPEDIDO.nTarifaExtra WHEN '1' THEN SUM(ISNULL(dbo.MPEDIDO.nTarifaMotorizado, 0))
                                       ELSE 0 END) As EXTRA,
                                       0 As IMPORTE
						FROM         dbo.vMotorizado INNER JOIN
											  dbo.TMOTORIZADODATOS ON dbo.vMotorizado.Codigo = dbo.TMOTORIZADODATOS.tCodigo INNER JOIN
											  dbo.MPEDIDO ON dbo.vMotorizado.Codigo = dbo.MPEDIDO.tMotorizado
						WHERE mpedido.fasignacion >= @fInicio and mpedido.fasignacion<= @ffinal
						GROUP BY dbo.TMOTORIZADODATOS.tDocumentoIdentidad, dbo.vMotorizado.Descripcion, dbo.vMotorizado.Codigo, mpedido.nTarifaExtra
						HAVING   (dbo.vMotorizado.Codigo =@tmotorizado)
						ORDER BY TRABAJADOR
						
						
						--REASIGNACION
						INSERT INTO #DBTRANS
						SELECT     dbo.TMOTORIZADODATOS.tDocumentoIdentidad AS DNI, dbo.vMotorizado.Descripcion AS TRABAJADOR, 
						            (SELECT OFICIAL = CASE dbo.MPEDIDO.nTarifaExtraN WHEN '0' THEN SUM(ISNULL(dbo.MPEDIDO.nTarifaMotorizadoN, 0))
                                       ELSE 0 END) As OFICIAL,
                                    (SELECT EXTRA = CASE dbo.MPEDIDO.nTarifaExtraN WHEN '1' THEN SUM(ISNULL(dbo.MPEDIDO.nTarifaMotorizadoN, 0))
                                       ELSE 0 END) As EXTRA,
                                       0 As IMPORTE
						FROM         dbo.vMotorizado INNER JOIN
											  dbo.TMOTORIZADODATOS ON dbo.vMotorizado.Codigo = dbo.TMOTORIZADODATOS.tCodigo INNER JOIN
											  dbo.MPEDIDO ON dbo.vMotorizado.Codigo = dbo.MPEDIDO.tMotorizadoN
						WHERE mpedido.fasignacion >= @fInicio and mpedido.fasignacion<= @ffinal
						GROUP BY dbo.TMOTORIZADODATOS.tDocumentoIdentidad, dbo.vMotorizado.Descripcion, dbo.vMotorizado.Codigo, mpedido.nTarifaExtraN
						HAVING   (dbo.vMotorizado.Codigo =@tmotorizado)
						ORDER BY TRABAJADOR
						
			END

END

						SELECT DNI,TRABAJADOR,SUM(OFICIAL) AS OFICIAL, SUM(EXTRA) AS EXTRA, (SUM(OFICIAL) + SUM(EXTRA)) AS IMPORTE  from #DBTRANS 
						GROUP BY DNI,TRABAJADOR
 
END

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


create Procedure [dbo].[sp_CargaPedidoReqExternoDirectosInforest]
@fch_fFechaInicio datetime,
@fch_fFechaFin datetime
AS
BEGIN

set nocount on


SELECT     dbo.DPEDIDO.tCodigoPedido, dbo.MPEDIDO.fFecha, dbo.DPEDIDO.fEnvio, dbo.MPEDIDO.fProgramacion, dbo.DPEDIDO.tCodigoProducto, dbo.DPEDIDO.nCantidad, 
                      dbo.DPEDIDO.tItem, dbo.TPRODUCTO.tDescargo, dbo.TPRODUCTO.tEnlace, dbo.MPEDIDO.tTipoPedido, dbo.vArea.tValor AS tSubalmacen
FROM         dbo.TPRODUCTO RIGHT OUTER JOIN
                      dbo.DPEDIDO ON dbo.TPRODUCTO.tCodigoProducto = dbo.DPEDIDO.tCodigoProducto RIGHT OUTER JOIN
                      dbo.MPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TCANALVENTA ON dbo.DPEDIDO.tTipoPedido = dbo.TCANALVENTA.tCodigoCanalVenta INNER JOIN
                      dbo.vArea ON dbo.TPRODUCTO.tArea = dbo.vArea.Codigo
WHERE len(dbo.TPRODUCTO.tEnlace)=7 and dbo.TCANALVENTA.lCanalCentralPedidos=1 and (dbo.MPEDIDO.tEstadoPedido <> '03') AND (ISNULL(dbo.DPEDIDO.lTransferido, 0) = 0) AND (dbo.DPEDIDO.tEstadoItem = 'N') AND (dbo.MPEDIDO.fFecha >= convert(datetime,@fch_fFechaInicio)) AND (dbo.MPEDIDO.fFecha <= convert(datetime,@fch_fFechaFin))

--WHERE dbo.TCANALVENTA.lCanalCentralPedidos=1 and (dbo.MPEDIDO.tEstadoPedido <> '03') AND (ISNULL(dbo.DPEDIDO.lTransferido, 0) = 0) AND (dbo.DPEDIDO.tEstadoItem = 'N') AND (dbo.MPEDIDO.fFecha >= convert(datetime,@fch_fFechaInicio)) AND (dbo.MPEDIDO.fFecha <= convert(datetime,@fch_fFechaFin))

END

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

create Procedure [dbo].[sp_CargaPedidoReqExternoInforest]
@fch_fFechaInicio datetime,
@fch_fFechaFin datetime
AS
BEGIN

set nocount on

SELECT dbo.DPEDIDO.tCodigoPedido, dbo.MPEDIDO.fFecha,dbo.DPEDIDO.fEnvio, dbo.MPEDIDO.fProgramacion, dbo.DPEDIDO.tCodigoProducto, 
dbo.DPEDIDO.nCantidad, dbo.DPEDIDO.tItem, dbo.TPRODUCTO.tDescargo , dbo.TPRODUCTO.tEnlace, dbo.MPEDIDO.tTipoPedido, dbo.DPEDIDO.tSubalmacen
FROM 
dbo.TPRODUCTO 
RIGHT OUTER JOIN 
dbo.DPEDIDO ON 
dbo.TPRODUCTO.tCodigoProducto = dbo.DPEDIDO.tCodigoProducto 
RIGHT OUTER JOIN 
dbo.MPEDIDO 
ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido
INNER JOIN dbo.TCANALVENTA ON dbo.DPEDIDO.tTipoPedido=dbo.TCANALVENTA.tCodigoCanalVenta
WHERE len(dbo.TPRODUCTO.tEnlace)='5' and dbo.TCANALVENTA.lCanalCentralPedidos=1 and (dbo.MPEDIDO.tEstadoPedido <> '03') AND (ISNULL(dbo.DPEDIDO.lTransferido, 0) = 0) AND (dbo.DPEDIDO.tEstadoItem = 'N') AND (dbo.MPEDIDO.fFecha >= convert(datetime,@fch_fFechaInicio)) AND (dbo.MPEDIDO.fFecha <= convert(datetime,@fch_fFechaFin))

END


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO
CREATE proc [dbo].[usp_AdmCen_ActualizarTablaCampos]
@tcodigo nvarchar(500),
@tAgrupacion nvarchar(500),
@lestado nvarchar(1),
@tUsuario nvarchar(4000)
as
begin

if @lestado='1'
begin
			update timportacion
			set limportar=1,tUsuario=@tUsuario,fregistro=getdate()
			where tpadre=@tcodigo and tagrupaciontabla=@tAgrupacion
end 
if @lestado='0'
begin
			update timportacion
			set limportar=0,tUsuario=@tUsuario,fregistro=getdate()
			where tpadre=@tcodigo and tagrupaciontabla=@tAgrupacion
end

end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc [dbo].[usp_AdmCen_ActualizarTablaPrincipal]
@tcodigo nvarchar(500),
@lestado nvarchar(1),
@tUsuario nvarchar(4000)
as
begin

if @lestado='1'
begin
update timportacion
set limportar=1,tUsuario=@tUsuario,fregistro=getdate()
where tcodigo=@tcodigo
end 
if @lestado='0'
begin
update timportacion
set limportar=0,tUsuario=@tUsuario,fregistro=getdate()
where tcodigo=@tcodigo
end

end

 

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO

create procedure [dbo].[usp_AdmCen_ObtenerCamposxTablas] --  'LUCHO\SV2008','tonyjactual'  
@sModulo nvarchar(4000),
@sServidor nvarchar(4000),
@sBaseDato nvarchar(4000),
@sUsuario nvarchar(4000)

as
begin

begin transaction 

DECLARE @ErrorCode  int  

declare @cantidadFilas int
declare @contador int
declare @camposIns nvarchar(4000)
declare @campos nvarchar(4000)
declare @keysIns nvarchar(4000)
declare @keys nvarchar(4000)
declare @NombreTabla nvarchar(4000)
declare @isql nvarchar(4000)
declare @keysva nvarchar(4000)
declare @campo nvarchar(4000)
declare @comilla nvarchar(10)
set @contador=1
set @cantidadFilas=0
SET @CAMPOS=''
set @keys=''
SET @CAMPOSIns=''
set @keysIns=''
set @comilla=''''
	
SELECT @ErrorCode = @@ERROR

/**//**/
/* 
indentificar que tablas son las que se migraran
*/
CREATE TABLE #DBTRANSTABLAS (tcodigotabla nVarChar(4000) collate Modern_Spanish_CI_AS,ttablaInterna nVarChar(4000) collate Modern_Spanish_CI_AS, ttablaTemporal nVarChar(4000) collate Modern_Spanish_CI_AS)
CREATE TABLE #DBTRANSTABLAS2 (tcodigotabla nVarChar(4000) collate Modern_Spanish_CI_AS,ttablaInterna nVarChar(4000) collate Modern_Spanish_CI_AS, ttablaTemporal nVarChar(4000) collate Modern_Spanish_CI_AS)
insert  into #DBTRANSTABLAS
select TPADRE as Codigo,  ttablainterna as ttablainterna, '' ttablaTemporal
from TIMPORTACION
WHERE limportar=1 AND TPADRE IS NOT NULL
group by tpadre, TTABLAMOSTRAR, ttablainterna
ORDER BY 1
insert into #DBTRANSTABLAS2 select * from #DBTRANSTABLAS order by 1

declare @posicionPunto int
declare @contadorTablas int
declare @ttabla nvarchar(4000)
declare @cantidadTablas int
declare @codigoTablaI nvarchar(4000)
declare @flag nvarchar(4000)
declare @nombreTTabla nvarchar(500)

set @cantidadtablas=0
set @codigotablai=''
set @nombreTTabla=''
select @cantidadTablas=count(*) from #DBTRANSTABLAS 
set @contadorTablas=1
while (@contadorTablas<=@cantidadTablas)
begin

	set @nombreTTabla=''
	set @posicionPunto=0
	set @flag=right('000'+ ltrim(str(@contadortablas+7)),3)
	--print @flag
	select @ttabla=ttablainterna , @codigotablai=tcodigotabla from #DBTRANSTABLAS order by 2
	SET @NombreTabla = dbo.CreaTabla(@flag , GETDATE())
	
	 select @posicionPunto=charindex('.', @ttabla)
	 
	 if @posicionPunto=0 
		begin
			
			SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.'+@TTABLA
			EXECUTE sp_executesql @Isql
			
			IF @ErrorCode <> 0
            BEGIN
                -- Rollback the Transaction
                ROLLBACK

                RAISERROR ('Error al obtener datos del servidor remoto ' , 16, 1)
                insert timportacionlog values(@sModulo,getdate(),@sUsuario,'ERROR','Error al obtener datos del servidor remoto ' + @nombretabla)
                RETURN
            END
            
		end
	  else
		begin
			set @nombreTTabla=	substring(@ttabla,charindex('.',@ttabla)+1,len(@ttabla))
			
			SET @Isql = 'SELECT * INTO ' + @NombreTabla + ' FROM OPENDATASOURCE(''SQLOLEDB'',''Data Source='+@sServidor+';User ID=infhotel;Password=4gust1n-fl0r14n'').'+@sBaseDato+'.dbo.ttabla '+ 'where ttabla= '+@comilla+@nombreTTabla+@comilla
			--print @isql
			EXECUTE sp_executesql @Isql
			
			IF @ErrorCode <> 0
            BEGIN
                -- Rollback the Transaction
                ROLLBACK

                RAISERROR ('Error al obtener datos del servidor remoto '  , 16, 1)
                 insert timportacionlog values(@sModulo,getdate(),@sUsuario,'ERROR','Error al obtener datos del servidor remoto ' + @nombretabla)
                RETURN
            END

		end
		update #DBTRANSTABLAS2 set ttablaTemporal=@nombretabla where tcodigotabla=@codigotablai
		delete from #DBTRANSTABLAS where tcodigotabla=@codigotablai
	
		set @contadorTablas=@contadorTablas+1
		
		
end

set @contadorTablas=1
set @nombreTTabla=''
CREATE TABLE #DBTRANS (tcampo nVarChar(4000) collate Modern_Spanish_CI_AS)
CREATE TABLE #DBKEYS (tcodigo nVarChar(4000) collate Modern_Spanish_CI_AS)
declare @tCodigo nvarchar(4000)
while (@contadorTablas<=@cantidadTablas)
begin
	print @contadorTablas
	print @cantidadTablas 
	
		set @nombreTTabla=''
		set @ttabla=''
		set @tcodigo=''
		set @nombreTabla=''
		set @posicionPunto=0
		
		
		select @ttabla=ttablainterna , @tcodigo=tcodigotabla, @NombreTabla=ttablaTemporal from #DBTRANSTABLAS2 order by 2
		
	    select @posicionPunto=charindex('.', @ttabla)

		print @ttabla
		print @tcodigo
		print @nombretabla
		
		print 'entra' + str(@posicionPunto)
		if @posicionPunto=0 
		begin
		
										/*2 obtener los campos que son PRIMARY KEY */
										insert into #DBKEYS
										select   UPPER(c.COLUMN_NAME )
										from     INFORMATION_SCHEMA.TABLE_CONSTRAINTS pk , INFORMATION_SCHEMA.KEY_COLUMN_USAGE c
										where     pk.TABLE_NAME = @TTABLA
										and    CONSTRAINT_TYPE = 'PRIMARY KEY'
										and    c.TABLE_NAME = pk.TABLE_NAME
										and    c.CONSTRAINT_NAME = pk.CONSTRAINT_NAME
										 /*2 los campos que son PRIMARY KEY se almacenaron 
										 COMO TABLA EN #DBKEYS  */
					 


										
											 /*3 obtener los campos que se van a replicar de la tabla
											 y que no son PRIMARY KEYS
											 */
											insert into #dbtrans
											SELECT  upper(COL.name) AS columna 
											FROM syscolumns COL JOIN sysobjects OBJ ON OBJ.id = COL.id
											WHERE OBJ.name = @tTabla AND (OBJ.xtype='U' OR OBJ.xtype='V')
											 and upper(col.name) not in (
											select upper(tcampointerno)
											from
											TIMPORTACION
											where limportar
											=0
											and tpadre=@tCodigo
											 )   and upper(col.name) not in (select * from #dbkeys)


											declare @nCantidadCP int
											
											
											
											set @nCantidadCP=(select count(*) FROM #dbtrans)
											
											if @nCantidadCP>0
											begin
																
																set @contador=1
																set @cantidadFilas=0
																select @cantidadFilas=count(*) from #dbtrans
																set @campos=''
																set @camposins=''
																WHILE  @contador<=@cantidadFilas
																	BEGIN
																		SELECT TOP 1 @CAMPO=TCAMPO FROM #DBTRANS 
																		
																		SET @campos=@campos+ @CAMPO+'='+@nombretabla+'.'+@campo+','
																		set @camposIns=@camposIns+@campo+','
																		--print @campos
																		--print @camposIns
																		--print @contador
																		--print @cantidadFilas
																		DELETE FROM #DBTRANS WHERE TCAMPO=@CAMPO
																			
																	SET @contador=@contador+1
																	
																	END
																/*3. LOS CAMPOS COMO    STRING EN @CAMPOS*/



																set @keysIns=''
																set @contador=1
																set @cantidadFilas=0
																select @cantidadFilas=count(*) from #dbkeys
																set @keysva=''
																set @keys=''
																while (@contador<=@cantidadFilas)
																begin 
																	select top 1 @keysva=tcodigo
																	from #dbkeys
																	set @keys=@keys+@ttabla+'.'+@keysva+'='+@nombretabla+'.'+@keysva+' and '
																	set @keysIns=@KeysIns+@keysva+'+'
																	delete from #dbkeys where TCODIGO=@keysva
																	set @contador=@contador+1

																end
																   --BEGIN TRANSACTION
													 
																set @campos=left(@campos, len(@campos)-1)
																set @keys=left(@keys, len(@keys)-4)
																set @keysIns=left(@keysIns, len(@keysIns)-1)
																
																--print @campos
																--print @keys
																--print @keysins
																/*actualizacion de registros*/

																set @isql='update ' +@ttabla +' set '+ @campos + ' from ' + @nombretabla+ ' where ' + @keys
															--	print @isql
																EXECUTE sp_executesql @Isql
																IF @ErrorCode <> 0
																BEGIN
																	-- Rollback the Transaction
																	ROLLBACK
																	insert timportacionlog values(@sModulo,getdate(),@sUsuario,'ERROR','Error al actualizar tabla local ' + @ttabla)
																	RAISERROR ('Error AL ACTUALIZAR TABLA LOCAL', 16, 1)
																	RETURN
																END
																/*fin*/

																/*insert de registros que estan en la central mas no en la tienda*/

																set @isql='insert into ' +@ttabla +' select * from ' + @nombretabla + ' where  ' +@keysIns + ' not in ( select '+@keysins+' from '+ @ttabla +')' 
																--print @isql
																EXECUTE sp_executesql @Isql
																
																 IF @ErrorCode <> 0
																BEGIN
																	-- Rollback the Transaction
																	ROLLBACK
																	insert timportacionlog values(@sModulo,getdate(),@sUsuario,'ERROR','Error al insertar tabla local ' + @ttabla)
																	RAISERROR ('Error AL insertar TABLA LOCAL', 16, 1)
																	RETURN
																END

											end
											else
											begin
															
															print  @ttabla
															print @nombretabla
															print ' aqui'
															
															--insertar todo'
															set @isql="delete from " +@ttabla
															
															EXECUTE sp_executesql @Isql
															
															set @isql='insert into ' +@ttabla +' select * from ' + @nombretabla 
															 print @isql
															EXECUTE sp_executesql @Isql
															
															 IF @ErrorCode <> 0
															BEGIN
																-- Rollback the Transaction
																ROLLBACK
																insert timportacionlog values(@sModulo,getdate(),@sUsuario,'ERROR','Error al insertar tabla local ' + @ttabla)
																RAISERROR ('Error AL insertar TABLA LOCAL', 16, 1)
																RETURN
															END
											
											
											
											end





			 end
			 else
			 begin
				--print'entra'
				--	print '1'
					
									
									set @nombreTTabla=substring(@ttabla,charindex('.',@ttabla)+1,len(@ttabla))
								--	print @nombretabla
								    set @ttabla= substring(@ttabla,1, charindex('.',@ttabla)-1)
								--    print @ttabla
										/*2 obtener los campos que son PRIMARY KEY */
										insert into #DBKEYS
										select   UPPER(c.COLUMN_NAME )
										from     INFORMATION_SCHEMA.TABLE_CONSTRAINTS pk , INFORMATION_SCHEMA.KEY_COLUMN_USAGE c
										where     pk.TABLE_NAME = @TTABLA
										and    CONSTRAINT_TYPE = 'PRIMARY KEY'
										and    c.TABLE_NAME = pk.TABLE_NAME
										and    c.CONSTRAINT_NAME = pk.CONSTRAINT_NAME
										 /*2 los campos que son PRIMARY KEY se almacenaron 
										 COMO TABLA EN #DBKEYS  */
										 
										 
										
											 /*3 obtener los campos que se van a replicar de la tabla
											 y que no son PRIMARY KEYS
											 */
											insert into #dbtrans
											SELECT  upper(COL.name) AS columna 
											FROM syscolumns COL JOIN sysobjects OBJ ON OBJ.id = COL.id
											WHERE OBJ.name = @tTabla AND (OBJ.xtype='U' OR OBJ.xtype='V')
											 and upper(col.name) not in (
											select upper(tcampointerno)
											from
											TIMPORTACION
											where limportar
											=0
											and tpadre=@tCodigo
											 )   and upper(col.name) not in (select * from #dbkeys)

											set @contador=1
											set @cantidadFilas=0
											select @cantidadFilas=count(*) from #dbtrans
											set @campos=''
											set @camposins=''
											WHILE  @contador<=@cantidadFilas
												BEGIN
													SELECT TOP 1 @CAMPO=TCAMPO FROM #DBTRANS 
													
													SET @campos=@campos+ @CAMPO+'='+@nombretabla+'.'+@campo+','
													set @camposIns=@camposIns+@campo+','
													--print @campos
													--print @camposIns
													--print @contador
													--print @cantidadFilas
													DELETE FROM #DBTRANS WHERE TCAMPO=@CAMPO
														
												SET @contador=@contador+1
												
												END
											/*3. LOS CAMPOS COMO    STRING EN @CAMPOS*/




											set @keysIns=''
											set @contador=1
											set @cantidadFilas=0
											select @cantidadFilas=count(*) from #dbkeys
											set @keysva=''
											set @keys=''
											while (@contador<=@cantidadFilas)
											begin 
												select top 1 @keysva=tcodigo
												from #dbkeys
												set @keys=@keys+@ttabla+'.'+@keysva+'='+@nombretabla+'.'+@keysva+' and '
												set @keysIns=@KeysIns+@keysva+'+'
												delete from #dbkeys where TCODIGO=@keysva
												set @contador=@contador+1

											end
											   --BEGIN TRANSACTION
								 
											set @campos=left(@campos, len(@campos)-1)
											set @keys=left(@keys, len(@keys)-4)
											set @keysIns=left(@keysIns, len(@keysIns)-1)
											
											--print @campos
											--print @keys
											--print @keysins
											/*actualizacion de registros*/

											set @isql='update ' +@ttabla + ' set '+ @campos + ' from ' + @nombretabla+ ' where TTABLA.ttabla='+@comilla+@nombrettabla+@comilla +' and ' + @keys
										--	print @isql
											EXECUTE sp_executesql @Isql
											
											 IF @ErrorCode <> 0
											BEGIN
												-- Rollback the Transaction
												ROLLBACK
												insert timportacionlog values(@sModulo,getdate(),@sUsuario,'ERROR','Error al actualizar tabla local ' + @ttabla)
												RAISERROR ('Error AL ACTUALIZAR TABLA LOCAL', 16, 1)
												RETURN
											END
											
											
											/*fin*/

											/*insert de registros que estan en la central mas no en la tienda*/

											set @isql='insert into ' +@ttabla +' select * from ' + @nombretabla + ' where  ' +@keysIns + ' not in ( select '+@keysins+' from '+ @ttabla +')' 
										--	print @isql
											EXECUTE sp_executesql @Isql
											
											 IF @ErrorCode <> 0
											BEGIN
												-- Rollback the Transaction
												ROLLBACK
												insert timportacionlog values(@sModulo,getdate(),@sUsuario,'ERROR','Error al insertar tabla local ' + @ttabla)
												RAISERROR ('Error AL insertar TABLA LOCAL', 16, 1)
												RETURN
											END
										 
			 end 
		
 			 SET @Isql = 'DROP TABLE ' + @NombreTabla; EXEC (@Isql)
			 delete from #DBTRANSTABLAS2 where tcodigotabla=@tcodigo--=tcodigotabla, @NombreTabla=ttablaTemporal from  order by 1
			 DELETE FROM #DBTRANS
	         DELETE FROM #DBKEYS
		  	 set @contadorTablas=@contadorTablas+1
		  	 print 'next'
end
insert timportacionlog values(@sModulo,getdate(),@sUsuario,'CORRECTO','PROCESO SATISFACTORIO ' )
												 
 commit transaction
end


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO






SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO
CREATE proc [dbo].[usp_AdmCen_ObtenerDependenciaPadres]
@tcodigo nvarchar(500)
as
begin
 declare @Agrupacion nvarchar(100)
 select @agrupacion=tagrupacion from timportacion where tcodigo=@tcodigo
 select tcodigo from timportacion
 where TAGRUPACION=@AGRUPACION and tcodigo<>@tcodigo and right(tcodigo,4)='0000'
 group by tcodigo
end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO





SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO
CREATE procedure [dbo].[usp_AdmCen_ObtenerTablas]
as

begin

SELECT TCODIGO,'T' tTIPO, TTABLAMOSTRAR,'' AS TAGRUPACION,
LIMPORTAR,'' TPADRE
FROM TIMPORTACION
 where right(tcodigo,4)='0000' and loculto=0

UNION

select TCODIGO,'C' tTTIPO,'' TTABLAMOSTRAR,TAGRUPACIONTABLA,  
LIMPORTAR,TPADRE
from timportacion
 where right(tcodigo,4)<>'0000' and loculto=0
GROUP BY TCODIGO,  TAGRUPACIONTABLA,
 LIMPORTAR,TPADRE
ORDER BY 1

 
end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO
CREATE procedure [dbo].[usp_AdmCen_ObtenerTablasPrincipales]
as
begin
select TPADRE as Codigo, TTABLAMOSTRAR as Tabla, ttablainterna as ttablainterna
from timportacion
WHERE limportar=1 AND TPADRE IS NOT NULL
group by tpadre, TTABLAMOSTRAR, ttablainterna
ORDER BY 1
end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create procedure [dbo].[usp_AdmCen_ObtenerPermisosUsuario]
@tUsuario nvarchar(4000)

as

begin

declare @codigoGrupo nvarchar(500)

select @codigoGrupo=tgrupoUsuario from tusuario 
where tResumido =@tUsuario

if @codigoGrupo='00'
	begin
		select '11'
	end
 else
	begin
		select ltrim(str(isnull(lopcion19,0))) + ltrim(str(isnull(lopcion20,0))) from tgrupousuario
		where tgrupousuario=@codigogrupo
	end 
 
end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

 CREATE proc usp_Aud_ObtenerMozos
as
begin
select Codigo,Descripcion,tResumido,lactivo 
from vMozo where SUBSTRING(codigo,1,1)<>'*' 
order by tResumido 
end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROC usp_Aud_ObtenerSalones
as
begin

select codigo, descripcion,tresumido, lactivo,tlocal,[local], 
isnull(ticono,'') ticono from vsalon ORDER BY tResumido
end

 

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

  CREATE proc [dbo].[usp_Aud_ValidadUsuario]
@susuario nvarchar(15),
@scontrasenia nvarchar(50)
as
BEGIN
select tCodigoUsuario, tDetallado,tResumido,lActivo
from vGrupoUsuario
where tresumido=@susuario and tpassword=@scontrasenia
and lModulo04=1
END



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

 CREATE proc [dbo].[usp_Aud_ObtenerMotivoEliminacion]
as
begin
select Codigo,Descripcion,tResumido,lactivo from Vmotivoeliminacion where lActivo=1
order by tResumido
end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc [dbo].[usp_Aud_ObtenerUsuarios]
as
begin
Select tCodigoUsuario, tDetallado,tResumido,lActivo from TUSUARIO where lActivo = 1 and tgrupousuario <>'00' order by tResumido
end
 

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

 CREATE proc [dbo].usp_Aud_ObtenerEstadoImpreso
as
begin
select '01' as codigo ,'Impresos' as Estado
union
select '02' as codigo, 'No Impresos' as Estado
end


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc dbo.usp_Aud_ObtenerTurnos
as
begin

Select tTurno as Codigo, tCaja, convert(nVarChar,fInicial, 120) as Inicio, isnull(convert(nvarchar,fFinal,120),'') as fFinal 
from MTURNO 
order by tTurno DESC

end


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

Create procedure [dbo].[usp_ObtenerTipoDocumento]
AS
BEGIN
Select Codigo,Descripcion,Prefijo,lActivo,Sunat from vTipoDocumento 
Where lActivo = 1
END
GO

Create procedure [dbo].[usp_ObtenerCliente]
AS
BEGIN
Select Codigo,tIdentidad,Descripcion from vCliente 
Where lActivo = 1
END
GO

Create procedure [dbo].[usp_ObtenerEstadoDocumento]
AS
BEGIN
Select Codigo,Descripcion from vEstadoDocumento
Where lActivo = 1
END
GO

Create procedure [dbo].[usp_ObtenerCaja]
AS
BEGIN
select tCaja, tDescripcion, lActivo from TCAJA
Where lActivo = 1
END
GO


CREATE PROCEDURE [dbo].[spRep_ControlDocumentos]
@fInicio As smalldatetime,
@fFinal As smalldatetime,
@tTipoDoc As nvarchar(20),
@tEstadoDoc As nvarchar(20),
@tUsuario As nvarchar(15),
@tCaja As nvarchar(5)

AS 

	BEGIN

		CREATE TABLE #DBTRANS (Fecha datetime, Documento nVarchar(20) collate Modern_Spanish_CI_AS,
								Autorizacion nVarchar(25) collate Modern_Spanish_CI_AS,TipoDocumento nVarchar(50) collate Modern_Spanish_CI_AS,
								Turno nVarchar(15) collate Modern_Spanish_CI_AS,
								Usuario  nVarchar(15) collate Modern_Spanish_CI_AS,
								Caja nVarchar(4) collate Modern_Spanish_CI_AS,
								Afecto float, NoAfecto float, Impuesto1 float, Impuesto2 float, Impuesto3 float, Total float,
								Estado nVarchar(50) collate Modern_Spanish_CI_AS, FechaAnulacion datetime,
								UsuarioAnulo nVarchar(15) collate Modern_Spanish_CI_AS,
								ObservacionAnulo nVarchar(200) collate Modern_Spanish_CI_AS)
									
		INSERT INTO #DBTRANS 
		SELECT m.fRegistro As Fecha, m.tDocumento As Documento, m.tAutorizacion As Autorizacion, v.descripcion As TipoDocumento,
		       m.tTurno As Turno, m.tUsuario As Usuario, m.tCaja as Caja,
					(SELECT SUM(D.nPrecioNeto*nCantidad)
					FROM dDocumento D
					WHERE D.tDocumento = m.tDocumento AND 
					((D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2=0) 
					OR (D.nPrecioImpuesto1>0 AND D.nPrecioImpuesto2>0))) As Afecto,
					
					(SELECT ISNULL(SUM(D.nPrecioNeto*nCantidad),0) FROM dDocumento D
					WHERE ((D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2>0)
					OR(D.nPrecioImpuesto1<=0 AND D.nPrecioImpuesto2<=0)) AND D.tDocumento = M.tDocumento) As NoAfecto,
               
			   m.nPrecioImpuesto1 As Impuesto1, m.nPrecioImpuesto2 As Impuesto2, m.nPrecioImpuesto3 As Impuesto3,
			   m.nVenta As Total, ve.Descripcion As Estado, m.fRegistroAnulado As FechaAnulacion, m.tUsuarioAnulado As UsuarioAnulo,
			   m.tObservacion As ObservacionAnulo
		FROM MDOCUMENTO m 
		INNER JOIN DDOCUMENTO d ON m.tDocumento = d.tDocumento 
		LEFT JOIN vTipoDocumento v ON m.tTipoDocumento = v.Codigo
		LEFT JOIN vEstadoDocumento ve ON m.tEstadoDocumento = ve.Codigo
		WHERE (m.fRegistro >= @fInicio AND m.fRegistro <= @fFinal) 
			 AND (m.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
			 AND (m.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
			 AND (m.tUsuario=@tUsuario OR @tUsuario='')
			 AND (m.tCaja=@tCaja OR @tCaja='')
		GROUP BY m.fRegistro, m.tDocumento, m.tAutorizacion, v.Descripcion, m.tTurno, m.tUsuario, m.tCaja, m.nPrecioImpuesto1, m.nPrecioImpuesto2, m.nPrecioImpuesto3,
		         m.nVenta, ve.Descripcion, m.fRegistroAnulado, m.tUsuarioAnulado, m.tObservacion 


	END
	
    SELECT  Fecha,Documento,Autorizacion,TipoDocumento,Turno,Usuario,Caja,Afecto,NoAfecto,Impuesto1,Impuesto2,Impuesto3,Total,Estado,FechaAnulacion,UsuarioAnulo,ObservacionAnulo FROM #DBTRANS

GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc usp_AutSol_ObtenerTipoTramite
as
begin
select tCodigoTramite,tDescripcion,lSolicitaNAnteriorAutorizacion,lActivo from TTRAMITE
order by tDescripcion
end			

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc [dbo].[usp_AutSol_ValidadUsuario]
@susuario nvarchar(15),
@scontrasenia nvarchar(50)
as
BEGIN
select tCodigoUsuario, tDetallado,tResumido,lActivo
from vGrupoUsuario
where tresumido=@susuario and tpassword=@scontrasenia
and lModulo05=1
END
		
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc usp_AutSol_ObtenerTiposDocumentos
as
begin
select Codigo,Descripcion,'false' as sel from vTipoDocumento

where lActivo=1 and Codigo<>'00'
order by Descripcion
end
	

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create  proc usp_AutSol_ObtenerEstablecimientoSeries
as
begin
select '001' as establecimiento,tSerie as serie ,vTipoDocumento.Codigo,  vTipoDocumento.Prefijo  from TTIPODOCUMENTOIMPRESORA
inner join vTipoDocumento
on TTIPODOCUMENTOIMPRESORA.tTipoEmision=vTipoDocumento.Codigo
order by 1,2
end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create  proc [dbo].[usp_AutSol_ObtenerTipoDocumentoSerieAProcesar]
@tTipo nvarchar(3),
@tCodigoSolicitud nvarchar(10)
as
begin
if @tTipo='1' -- inclusion de puntos de ventas o tipos deocumentos
	begin
		select CONVERT(bit, 1) Procesar, dbo.vTipoDocumento.Descripcion,  '001' as establecimiento, 
		tSerie as serie ,
		vTipoDocumento.Codigo,  vTipoDocumento.Prefijo , 
		'000000001' FolioInicial,
		'999999999' FolioFinal , 
		TTIPODOCUMENTOIMPRESORA.tCaja caja, isnull(TSOLICITUDDETALLE.tCodigoSolicitud,'') as tCodigoSolicitud, isnull(TSOLICITUDDETALLE.nCorrelativo,'') as nCorrelativo
		from TTIPODOCUMENTOIMPRESORA
		inner join vTipoDocumento
		on TTIPODOCUMENTOIMPRESORA.tTipoEmision=vTipoDocumento.Codigo
		left join TSOLICITUDDETALLE on dbo.TSOLICITUDDETALLE.tSerieCaja=TTIPODOCUMENTOIMPRESORA.tSerie 
		and dbo.TSOLICITUDDETALLE.tCaja=TTIPODOCUMENTOIMPRESORA.tCaja 
		and TTIPODOCUMENTOIMPRESORA.tTipoEmision=dbo.TSOLICITUDDETALLE.tTipoDocumento
		and (isnull(dbo.TSOLICITUDDETALLE.tCodigoSolicitud,'') = @tCodigoSolicitud)
		where Codigo<>'00' and isnull(TTIPODOCUMENTOIMPRESORA.tNumeroAutorizacion,'')='' and ISNULL(TTIPODOCUMENTOIMPRESORA.fCaducidad,'')=''
		order by 2,3,4
	end
else
	begin
		select CONVERT(bit, 1) Procesar, dbo.vTipoDocumento.Descripcion,  '001' as establecimiento, 
		tSerie as serie,
		vTipoDocumento.Codigo,  vTipoDocumento.Prefijo , 
		'000000001' FolioInicial,
		'999999999' FolioFinal, 
		TTIPODOCUMENTOIMPRESORA.tCaja caja, isnull(TSOLICITUDDETALLE.tCodigoSolicitud,'') as tCodigoSolicitud, isnull(TSOLICITUDDETALLE.nCorrelativo,'') as nCorrelativo
		from TTIPODOCUMENTOIMPRESORA
		inner join vTipoDocumento
		on TTIPODOCUMENTOIMPRESORA.tTipoEmision=vTipoDocumento.Codigo
		left join TSOLICITUDDETALLE on dbo.TSOLICITUDDETALLE.tSerieCaja=TTIPODOCUMENTOIMPRESORA.tSerie 
		and dbo.TSOLICITUDDETALLE.tCaja=TTIPODOCUMENTOIMPRESORA.tCaja 
		and TTIPODOCUMENTOIMPRESORA.tTipoEmision=dbo.TSOLICITUDDETALLE.tTipoDocumento
		and (isnull(dbo.TSOLICITUDDETALLE.tCodigoSolicitud,'') = @tCodigoSolicitud)
		where Codigo<>'00' 
		order by 2,3,4
	end
end	

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc usp_AutSol_ObtieneAutorizacionAnterior
@codigo nvarchar(5)
as
begin
select ISNULL(lSolicitaNAnteriorAutorizacion,0) AutorizacionAnterior  from TTRAMITE
where tCodigoTramite=@codigo

end		

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc usp_AutSol_InsertarSolicitudCab 
@codigoTramite nvarchar(5),
@codigoEstadoSolicitud nvarchar(2),
@numeroAutorizacion nvarchar(50),
@numeroAutorizacionAnterior nvarchar(50),
@fFechaEmision datetime,
@fFechaCaducidad datetime,
@tUsuario nvarchar(150),
@tCodigoSolicitud  nvarchar(10) output
as

begin

declare @codigoSolicitud nvarchar(10)
set @codigoSolicitud=RIGHT( '000000000' + ltrim(str((select isnull(MAX(tCodigoSolicitud),0)+1 from TSOLICITUD))) ,10)
insert into  TSOLICITUD (tCodigoSolicitud,tCodigoTramite,tEstadoSolicitud,tNumeroAutorizacion,tNumeroAutorizacionAnterior,fFechaEmision,fFechaCaducidad,fRegistro,tUsuario)
values(@codigoSolicitud,@codigoTramite,@codigoEstadoSolicitud,@numeroAutorizacion,@numeroAutorizacionAnterior,@fFechaEmision,@fFechaCaducidad,GETDATE(),@tUsuario)
set @tCodigoSolicitud=@codigoSolicitud

end	

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create proc [dbo].[usp_AutSol_InsertarSolicitudDetalle]
@tCodigoSolicitud nvarchar(10),
@tTipoDocumento nvarchar(2),
@tSerieEstablecimiento nvarchar(50),
@tSerieCaja nvarchar(50),
@tFolioInicial nvarchar(50),
@tFolioFinal nvarchar(50),
@tEstadoSolicitud nvarchar(2),
@tUsuario nvarchar(150),
@tCaja nvarchar(3) ,
@nCorrelativo nvarchar(3) 
as
begin

declare @nItem int

set @nItem = convert(int,@nCorrelativo)

insert into TSOLICITUDDETALLE ( tCodigoSolicitud,nCorrelativo, tTipoDocumento, tSerieEstablecimiento, tSerieCaja, tFolioInicial, tFolioFinal,   tEstadoDetalle,fRegistro, tUsuario, tcaja)
						values(@tCodigoSolicitud,	   @nitem,@tTipoDocumento,@tSerieEstablecimiento,@tSerieCaja,@tFolioInicial,@tFolioFinal,@tEstadoSolicitud,GETDATE(),@tUsuario,@tCaja)
end
		
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc usp_AutSol_ObtenerSolicitudes
as
begin

SELECT TSOLICITUD.*, TTRAMITE.tDescripcion,  dbo.vEstadoSolicitud.Descripcion AS EstadoSol
FROM         dbo.TSOLICITUD INNER JOIN
                      dbo.TTRAMITE ON dbo.TSOLICITUD.tCodigoTramite = dbo.TTRAMITE.tCodigoTramite LEFT OUTER JOIN
                      dbo.vEstadoSolicitud ON dbo.TSOLICITUD.tEstadoSolicitud = dbo.vEstadoSolicitud.Codigo
order by tCodigoSolicitud desc
end		

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc usp_AutSol_ObtenerTiposDocumentosActualizar 
@tCodigoSolicitud nvarchar(10)
as
begin

create table #dbtrans (codigo nvarchar(2) collate Modern_Spanish_CI_AS, descripcion nvarchar(200) collate Modern_Spanish_CI_AS, sel nvarchar(200) collate Modern_Spanish_CI_AS)
insert into #dbtrans
select Codigo,Descripcion,'false'  as sel from vTipoDocumento
where lActivo=1 and Codigo<>'00'
order by Descripcion

update #dbtrans set sel='true'
where codigo in (select TTIPODOCUMENTO from TSOLICITUDDETALLE where tCodigoSolicitud=@tCodigoSolicitud group by TTIPODOCUMENTO)

select * from #dbtrans
order by descripcion

end
		

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc [dbo].[usp_AutSol_ObtenerTipoDocumentoSerieActualizar]
@tCodigoSolicitud nvarchar(10)
as
begin
SELECT     CONVERT(bit, 1) AS Procesar, dbo.vTipoDocumento.Descripcion, '001' AS establecimiento, dbo.TSOLICITUDDETALLE.tSerieCaja AS serie, 
                      dbo.vTipoDocumento.Codigo, dbo.vTipoDocumento.Prefijo, 
                      +dbo.TSOLICITUDDETALLE.tFolioInicial AS FolioInicial,
                      + dbo.TSOLICITUDDETALLE.tFolioFinal AS FolioFinal, 
                      TSOLICITUDDETALLE.tcaja AS caja, TSOLICITUDDETALLE.tCodigoSolicitud, TSOLICITUDDETALLE.nCorrelativo
FROM         dbo.vTipoDocumento INNER JOIN
                      dbo.TSOLICITUDDETALLE ON dbo.vTipoDocumento.Codigo = dbo.TSOLICITUDDETALLE.tTipoDocumento
WHERE     (dbo.TSOLICITUDDETALLE.tCodigoSolicitud =@tCodigoSolicitud)
order by 2,3,4

end		

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create proc usp_AutSol_ActualizarSolicitudCab 
 
@numeroAutorizacion nvarchar(50),
@numeroAutorizacionAnterior nvarchar(50),
@fFechaEmision datetime,
@fFechaCaducidad datetime,
@tUsuario nvarchar(150),
@tCodigoSolicitud  nvarchar(10) 
as

begin

UPDATE TSOLICITUD
SET tNumeroAutorizacion=@numeroAutorizacion, tNumeroAutorizacionAnterior=@numeroAutorizacionAnterior,
fFechaEmision=@fFechaEmision,fFechaCaducidad=@fFechaCaducidad,tUsuarioModifica=@tUsuario,fRegistroModifica=GETDATE()
WHERE tCodigoSolicitud=@tCodigoSolicitud
 
 delete from TSOLICITUDDETALLE where tCodigoSolicitud=@tCodigoSolicitud
end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc [dbo].[usp_AutSol_ActualizaEstadoSolicitudDetalle]
@tCodigoSolicitud nvarchar(10),
@tItem int,
@tEstadoSolicitud nvarchar(2),
@tUsuario nvarchar(150)
as
begin
--declare @nItem int
--set @nitem=(select COUNT(*) + 1 from TSOLICITUDDETALLE where tCodigoSolicitud=@tCodigoSolicitud)

UPDATE TSOLICITUDDETALLE SET tEstadoDetalle=@tEstadoSolicitud, tUsuarioModifica=@tUsuario,fRegistroModifica=GETDATE() WHERE tCodigoSolicitud=@tCodigoSolicitud and nCorrelativo=@tItem


end		

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc usp_AutSol_AnularSolicitud
@tcodigoSolicitud nvarchar(10),
@tUsuario nvarchar(150)
as
begin

update TSOLICITUD set tEstadoSolicitud='05', tUsuarioModifica=@tUsuario, fRegistroModifica=GETDATE()

where tCodigoSolicitud=@tcodigoSolicitud

end		

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc [dbo].[usp_AutSol_ObtenerTipoDocumentoSerieAntes]
@tCodigoSolicitud nvarchar(10)
as
begin
SELECT CONVERT(bit, 1) AS Procesar, dbo.vTipoDocumento.Descripcion, '001' AS establecimiento, 
dbo.TSOLICITUDDETALLE.tSerieCaja AS serie, 
                      dbo.vTipoDocumento.Codigo, dbo.vTipoDocumento.Prefijo,
                       dbo.TSOLICITUDDETALLE.tFolioInicial  AS FolioInicial, 
                      isnull(right(dbo.TTIPODOCUMENTOIMPRESORA.tUltimoNumero,9),'999999999')AS FolioFinal, 
                      dbo.TSOLICITUDDETALLE.tCaja AS caja, TSOLICITUDDETALLE.tCodigoSolicitud, TSOLICITUDDETALLE.nCorrelativo
FROM         dbo.vTipoDocumento INNER JOIN
                      dbo.TSOLICITUDDETALLE ON dbo.vTipoDocumento.Codigo = dbo.TSOLICITUDDETALLE.tTipoDocumento INNER JOIN
                      dbo.TTIPODOCUMENTOIMPRESORA ON dbo.TSOLICITUDDETALLE.tCaja = dbo.TTIPODOCUMENTOIMPRESORA.tCaja AND 
                      dbo.TSOLICITUDDETALLE.tTipoDocumento = dbo.TTIPODOCUMENTOIMPRESORA.tTipoEmision
WHERE     (dbo.TSOLICITUDDETALLE.tCodigoSolicitud = @tCodigoSolicitud)
ORDER BY dbo.vTipoDocumento.Descripcion, establecimiento, serie

end		

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc usp_AutSol_obtenerSolicitudXAutorizacion
@tNumeroAutorizacion nvarchar(150)
as
begin
select ISNULL(tCodigoSolicitud,'') as CodigoSolicitud from TSOLICITUD
where tNumeroAutorizacion=@tNumeroAutorizacion

end		

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

create proc usp_AutSol_ActualizarTiposDeDocumentos
@tTipo nvarchar(1),
@tCaja nvarchar(3),
@tTipoEmision nvarchar(3),
@tSerie nvarchar(50),
@tNumeroAutorizacion nvarchar(150),
@fregistro datetime,
@tCaducidad  datetime
as
 
begin
  if @tTipo='1'
  begin
update TTIPODOCUMENTOIMPRESORA
set tNumeroAutorizacion=@tNumeroAutorizacion,fInicio=@fregistro,fcaducidad=@tcaducidad
where TCAJA=@tcaja
and tTipoEmision=@tTipoEMision 
and
tSerie=@tserie
end
else
begin
update TTIPODOCUMENTOIMPRESORA
set tNumeroAutorizacion='',fInicio=null,fcaducidad=''
where TCAJA=@tcaja
and tTipoEmision=@tTipoEMision 
and
tSerie=@tserie
end
end	

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE [dbo].[spRep_ComprobantesVentas] 
@tCliente As nvarchar(20),
@tTipoDoc As nvarchar(20),
@tEstadoDoc As nvarchar(20),
@tAutorizacion As nvarchar(20),
--@tTipoDoc As bit,
--@tEstadoDoc As bit,
--@tAutorizacion As bit,
@fInicio As smalldatetime,
@fFinal As smalldatetime

AS
	BEGIN
		CREATE TABLE #DBTRANS (ruc nVarchar(15), RazonSocial nVarchar(200) collate Modern_Spanish_CI_AS, fEmision datetime, 
							   Usuario nVarchar(15) collate Modern_Spanish_CI_AS,
							   CodigoAutorizacion nVarchar(50) collate Modern_Spanish_CI_AS,
							   Serie nVarchar(50) collate Modern_Spanish_CI_AS,
							   Correlativo nVarchar(50) collate Modern_Spanish_CI_AS,
							   SubTotal Float,Imp1 Float, Imp2 Float, Imp3 Float, Descuento Float, Total Float)	
		                       
		INSERT INTO #DBTRANS 
		SELECT vc.tIdentidad AS ruc, vc.Descripcion AS RazonSocial,
			   m.fRegistro AS fEmision, m.tUsuario As Usuario, m.tAutorizacion As CodigoAutorizacion,
			   RIGHT(LEFT(m.tDocumento, 4),3) + ' - ' + RIGHT(LEFT(m.tDocumento, 7), 3) As Serie,
			   RIGHT(m.tDocumento,8) As Correlativo,
			   m.nNeto As SubTotal, m.nPrecioImpuesto1 As Imp1, m.nPrecioImpuesto2 As Imp2, m.nPrecioImpuesto3 As Imp3,
			   m.nDescuento As Descuento,m.nVenta As Total
		FROM
		MDOCUMENTO m LEFT JOIN vCliente vc ON m.tCodigoCliente = vc.Codigo
		WHERE (m.fRegistro >= @fInicio AND m.fRegistro <= @fFinal)
		       AND (vc.Codigo=@tCliente OR @tCliente='') 
               AND (m.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
               AND (m.tEstadoDocumento=@tEstadoDoc OR @tEstadoDoc='')
               AND (m.tAutorizacion=@tAutorizacion OR @tAutorizacion='')
               AND (m.tTipoDocumento<>'00')
	END

SELECT ruc, RazonSocial, fEmision, Usuario, CodigoAutorizacion, Serie, Correlativo, SubTotal, Imp1, Imp2, Imp3, Descuento, Total FROM #DBTRANS
	
		

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE [dbo].[spRep_AutorizacionAutoimpresion] 
@tTipoDoc As nvarchar(20),
@tTipoTramite As nvarchar(20),
@tEstado As nvarchar(20),
@fInicio As smalldatetime,
@fFinal As smalldatetime
AS


	BEGIN
		CREATE TABLE #DBTRANS (TipoDocumento nVarchar(50) collate Modern_Spanish_CI_AS,
		                       TipoTramite nVarchar(100) collate Modern_Spanish_CI_AS, 
							   Autorizacion nVarchar(50) collate Modern_Spanish_CI_AS,
							   Serie nVarchar(50) collate Modern_Spanish_CI_AS,
							   FolioInicial nVarchar(50) collate Modern_Spanish_CI_AS,
							   FolioFinal nVarchar(50) collate Modern_Spanish_CI_AS,
							   FechaEmision Datetime,FechaCaducidad nVarchar(10) collate Modern_Spanish_CI_AS,
							   Estado nVarchar(50) collate Modern_Spanish_CI_AS)	
		                       
		INSERT INTO #DBTRANS 
		SELECT vt.Descripcion As TipoDocumento, tt.tDescripcion As TipoTramite, ts.tNumeroAutorizacion As Autorizacion,
		       tsd.tSerieEstablecimiento + ' ' + tsd.tSerieCaja As Serie, tsd.tFolioInicial As FolioInicial, tsd.tFolioFinal As FolioFinal,
		       ts.fFechaEmision As FechaEmision, ts.fFechaCaducidad As FechaCaducidad, 
		       ttb.tDetallado As Estado
		FROM TSOLICITUDDETALLE tsd
		LEFT JOIN TSOLICITUD ts ON tsd.tCodigoSolicitud = ts.tCodigoSolicitud
		LEFT JOIN TTRAMITE tt ON tt.tCodigoTramite = ts.TcodigoTramite
		LEFT JOIN vTipoDocumento vt ON tsd.tTipoDocumento = vt.Codigo
		LEFT JOIN TTABLA ttb ON ttb.TCODIGO = ts.tEstadoSolicitud  
		WHERE  TTABLA = 'ESTADOSOLICITUD' AND
		      (ts.fRegistro >= @fInicio AND ts.fRegistro <= @fFinal)
			   AND (tsd.tTipoDocumento=@tTipoDoc OR @tTipoDoc='')
			   AND (tt.tCodigoTramite=@tTipoTramite OR @tTipoTramite='')
			   AND (ts.tEstadoSolicitud=@tEstado OR @tEstado='')
	END		   
		
SELECT TipoDocumento,TipoTramite,Autorizacion,Serie,FolioInicial,FolioFinal,FechaEmision,FechaCaducidad,Estado  FROM #DBTRANS

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO
	
CREATE procedure [dbo].[usp_AutSol_ObtenerTipoDocumento]
AS
Select Codigo,Descripcion,Prefijo,lActivo,isnull(Sunat,'') from vTipoDocumento 
Where lActivo = 1

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE procedure [dbo].[usp_AutSol_ObtenerCliente]
AS
Select Codigo,tIdentidad,Descripcion from vCliente 
Where lActivo = 1

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE procedure [dbo].[usp_AutSol_ObtenerEstadoDocumento]
AS
Select Codigo,Descripcion from vEstadoDocumento
Where lActivo = 1

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

Create procedure [dbo].[usp_AutSol_ObtenerCaja]
AS
select tCaja, tDescripcion, lActivo from TCAJA
Where lActivo = 1
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

Create procedure [dbo].[usp_AutSol_ObtenerSolicitud]
AS
select tCodigoSolicitud,tCodigoTramite,tEstadoSolicitud,tNumeroAutorizacion from TSOLICITUD
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO
Create procedure [dbo].[usp_AutSol_ObtenerTramite]
AS
select tCodigoTramite,tDescripcion,lSolicitaNAnteriorAutorizacion,lActivo from TTRAMITE 
Where lActivo = 1
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 

GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

Create procedure [dbo].[usp_AutSol_ObtenerEstadoTramite]
AS
select tCodigo,tDetallado,lActivo from TTABLA where TTABLA = 'ESTADOSOLICITUD' AND lActivo = 1


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE sp_UpdFotoDelivery
@tCodigo 	    nvarchar(10),
@oFoto			    IMAGE	
AS
BEGIN
UPDATE tdelivery SET iFoto=@oFoto
	WHERE tCodigoDelivery=@tCodigo 

END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_TraeDatosVentas_SyBase]
--@FecInicio	NVARCHAR(20),
--@FecFinal	NVARCHAR(20)

AS
BEGIN    
SET NOCOUNT ON
	
	--////TRANSACCION TRANSFERENCIA VENTAS...///////
	
	SELECT  DISTINCT dbo.MDOCUMENTO.tDocumento, dbo.MPEDIDO.tClienteDelivery, dbo.TDELIVERY.TDIRECCION,
			dbo.TDELIVERY.TTELEFONO
	INTO	#SYBASE1
	FROM    dbo.MDOCUMENTO INNER JOIN
			dbo.DDOCUMENTO ON dbo.MDOCUMENTO.tDocumento = dbo.DDOCUMENTO.tDocumento INNER JOIN
			dbo.DPEDIDO ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento INNER JOIN
			dbo.MPEDIDO ON dbo.DDOCUMENTO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido INNER JOIN
			dbo.TDELIVERY ON dbo.MPEDIDO.TCLIENTEDELIVERY=dbo.TDELIVERY.TCODIGODELIVERY
	GROUP BY MDOCUMENTO.TDOCUMENTO, dbo.MPEDIDO.tClienteDelivery, dbo.TDELIVERY.TDIRECCION,
			dbo.TDELIVERY.TTELEFONO
	
	SELECT	mDoc.tTipoDocumento as 'TIPO_DOC','001' as 'ESTABLECIMIENTO',
			SUBSTRING(mDoc.tDocumento,5,3) as 'PTO_EMI',CONVERT(INT,RIGHT(mDoc.tDocumento,8)) as 'SECUENCIA',
			mDoc.tCaja as 'AREA', mDoc.fRegistro as 'FECHA',ISNULL(#SYBASE1.tClienteDelivery,'9999999999') as 'COD_CLI',
			tCli.tidentidad as 'COD_LEGAL',tCli.tEmpresa as 'NOMBRE_LEGAL',
			LEFT(#SYBASE1.tDireccion,100) as 'DIRECCION',LEFT(#SYBASE1.tTelefono,100) as 'TELEFONO',
			mDoc.tAutorizacion as 'AUTORIZACION',
			--CONVERT(DECIMAL(11,2),mDoc.nNeto+mDoc.nDescuento) as 'SUBTOTAL',
			CONVERT(DECIMAL(11,2),mDoc.nVenta)-CONVERT(DECIMAL(11,2),mDoc.nPrecioImpuesto1)-CONVERT(DECIMAL(11,2),mDoc.nPrecioImpuesto2+CONVERT(DECIMAL(11,2),mDoc.nDescuento)) as 'SUBTOTAL',
			CONVERT(DECIMAL(11,2),mDoc.nDescuento) as 'DESCUENTO',
			CONVERT(DECIMAL(11,2),0) as 'EXENTO',
			CONVERT(DECIMAL(11,2),mDoc.nPrecioImpuesto1) as 'IMPUESTO',
			CONVERT(DECIMAL(11,2),mDoc.nPrecioImpuesto2) as 'SERVICIO',
			CONVERT(DECIMAL(11,2),mDoc.nVenta) as 'TOTAL',
			CONVERT(DECIMAL(5,2),tPar.Impuesto1) as 'POR_IMPUESTO',
			'' as 'ZONA_ID',
			(CASE WHEN mDoc.tEstadoDocumento='04' then 'D' else 'A' end) as 'ESTADO',
			mDoc.tEstadoDocumento,
			mDoc.tDocumento
	FROM	MDOCUMENTO mDoc INNER JOIN VTIPODOCUMENTO vTipDoc ON mDoc.Ttipodocumento=vTipDoc.Codigo
			LEFT JOIN TCLIENTE tCli ON mDoc.tCodigoCliente=tCli.tCodigoCliente
			LEFT JOIN #SYBASE1 ON mDoc.tDocumento=#SYBASE1.tDocumento
			,TPARAMETRO tPar
	WHERE	mDoc.tTipoDocumento='01'
			--AND mDoc.fRegistro BETWEEN @FecInicio AND @FecFinal 
			AND isnull(mDoc.lReplica,1)=1

END

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_TraeDatosPagos_SyBase]
--@FecInicio	NVARCHAR(20),
--@FecFinal	NVARCHAR(20)

AS
BEGIN    
SET NOCOUNT ON
	
	--////TRANSACCION TRANSFERENCIA PAGOS...///////
	SELECT	mDoc.tTipoDocumento as 'TIPO_DOC','001' as 'ESTABLECIMIENTO',
			SUBSTRING(mDoc.tDocumento,5,3) as 'PTO_EMI',CONVERT(INT,RIGHT(mDoc.tDocumento,9)) as 'SECUENCIA',
			dPagDoc.tTipoPago AS 'CODFPAG',CONVERT(DECIMAL(11,2),dPagDoc.nMonto) AS 'MONTO',
			dPagDoc.tDocumento as 'TDOCUMENTO',
			mDoc.tCaja AS 'TCAJA' 
	FROM	DPAGODOCUMENTO dPagDoc INNER JOIN MDOCUMENTO mDoc ON dPagDoc.tDocumento=mDoc.tDocumento
			INNER JOIN VTIPODOCUMENTO vTipDoc ON mDoc.Ttipodocumento=vTipDoc.Codigo
	WHERE	mDoc.tTipoDocumento='01'
			--AND dPagDoc.fRegistro BETWEEN @FecInicio AND @FecFinal 
			AND isnull(dPagDoc.lReplica,1)=1
	
	
END


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_InsUptSocioDelivery_SyBASE]
AS
BEGIN

	UPDATE TDELIVERY 
	SET		tApellido=LEFT(SYBASE.NOMBRE,49),
			tTelefono=SYBASE.NRO_IDENTIFICACION,
			fModificacion=GETDATE(),
			tEstadoFrecuente=SYBASE.ORIGEN,
			tTipoIdentidad=(CASE WHEN ISNULL(NRO_IDENTIFICACION,'')='' THEN '' ELSE '02' END),
			tIdentidad=SYBASE.NRO_IDENTIFICACION
	FROM TDELIVERY INNER JOIN SOCIOS_SYBASE SYBASE ON TDELIVERY.tCodigoDelivery=SYBASE.externo_codcli
	
	INSERT INTO [dbo].[TDELIVERY]
           ([tCodigoDelivery],[tTipoCliente],[tApellido],[tNombre],[tDireccion],[tTelefono],[tReferencia],[tZona],[tDistrito],[tCodigoCliente]
           ,[tCodigoTarjeta],[tNumeroTarjeta],[tFechaTarjeta],[nDescuento],[fNacimiento],[tEmail],[tObservacion],[lActivo],[lPuntos],[nAcumulado]
           ,[nUtilizado],[nDisponible],[tUsuario],[fRegistro],[fModificacion],[lReplica],[tEstadoFrecuente],[lExcluyeProductos],[lClienteCtaCte]
           ,[nConsumo],[nLinea],[tTipoCtaCte],[tSubTipoCtaCte],[tTipoIdentidad],[tIdentidad])

	--INSERT INTO TDELIVERY (tCodigoDelivery,tTipoCliente,tApellido,tTelefono,lActivo,tUsuario,fRegistro,tEstadoFrecuente,tTipoIdentidad,tIdentidad)
	SELECT	externo_codcli,'01',LEFT(NOMBRE,49),'','',NRO_IDENTIFICACION,'','','','',
			'','','',0,'','','',1,0,0,
			0,0,'MASTER',GETDATE(),'',0,ORIGEN,0,0,
			0,0,'','',(CASE WHEN ISNULL(NRO_IDENTIFICACION,'')='' THEN '' ELSE '02' END),ISNULL(NRO_IDENTIFICACION,'')
	FROM SOCIOS_SYBASE WHERE externo_codcli NOT IN (SELECT tCodigoDelivery FROM TDELIVERY)
END





SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
	
CREATE PROCEDURE [dbo].[sp_CreaTemporalSocio_SyBASE]
AS
BEGIN

	if exists (select * from dbo.sysobjects where id = object_id(N'[SOCIOS_SYBASE]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
			DROP TABLE [dbo].[SOCIOS_SYBASE]
			
	CREATE TABLE SOCIOS_SYBASE
	(
		contacto_id	INT,
		nombre	NVARCHAR(100),
		tipo_identificacion	NVARCHAR(5),
		nro_identificacion	NVARCHAR(20),
		contactotipo_id	INT,
		persona_id	INT,
		socio_id	NVARCHAR(50),
		titulo	NVARCHAR(10),
		archivo_foto	NVARCHAR(200),
		relacion	NVARCHAR(20),
		estado_contacto	NVARCHAR(1),
		externo_codcli	NVARCHAR(10),
		contactosocio	INT,
		socio	INT,
		nombreresponsable	NVARCHAR(100),
		socio_situacion	NVARCHAR(1),
		fecha_nacimiento	DATETIME,
		id_estado_civil	NVARCHAR(1),
		fecha_ingreso	DATETIME,
		externo_codcli_responsable	NVARCHAR(100),
		orden	INT,
		origen	NVARCHAR(2)
	)		
	
	DELETE FROM SOCIOS_SYBASE
END



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc usp_Inforest_ObtenerInsumosCriticos  -- '1300000016'
@tCodigoPedido as nvarchar(15)
as
begin
set nocount on

CREATE TABLE #DBTRANS (ncantidad float, tCodigoInsumo nVarChar(20) collate Modern_Spanish_CI_AS)

insert #DBTRANS 
select sum(ncantidad) ncantidad, TPRODUCTO.TCODIGOINSUMO 
from dpedido inner join tproducto 
on dpedido.tcodigoproducto=tproducto.tcodigoproducto 
INNER JOIN  dbo.TINSUMO ON dbo.TPRODUCTO.tcodigoInsumo = dbo.TINSUMO.tcodigo  
where tcodigopedido=@tCodigoPedido and lcontrolinsumocritico=1 
and isnull(limprime,0)=0 AND ISNULL(TCODIGOINSUMO,''  )<>'' 
and (tinsumo.lactivo=1) 
group by tcodigoinsumo

insert #DBTRANS 
SELECT     SUM(dbo.CPEDIDO.nCantidad) AS ncantidad, dbo.TPRODUCTO.tCodigoInsumo
FROM         dbo.CPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido AND dbo.CPEDIDO.tItem = dbo.DPEDIDO.tItem INNER JOIN
                      dbo.TINSUMO INNER JOIN
                      dbo.TPRODUCTO ON dbo.TINSUMO.tcodigo = dbo.TPRODUCTO.tCodigoInsumo ON dbo.CPEDIDO.tProductoCombo = dbo.TPRODUCTO.tCodigoProducto
WHERE     (dbo.TPRODUCTO.lControlInsumoCritico = 1) AND (dbo.TINSUMO.lactivo = 1) AND (ISNULL(dbo.cPEDIDO.lImprime, 0) = 0) AND 
                      (dbo.DPEDIDO.tCodigoPedido = @tCodigoPedido) AND (ISNULL(dbo.TPRODUCTO.tCodigoInsumo, N'') <> '') AND (dbo.DPEDIDO.lCombinacion = 1)
GROUP BY dbo.TPRODUCTO.tCodigoInsumo
 
 
select  SUM(ncantidad), tCodigoInsumo
from #DBTRANS
 group by tCodigoInsumo
order by 2

end


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc usp_Inforest_RevertirInsumosCriticos   --  '1300000024','001'
@tCodigoPedido as nvarchar(15),
@sitem as nvarchar(10)
as
begin
set nocount on

CREATE TABLE #DBTRANS (ncantidad float, tCodigoInsumo nVarChar(20) collate Modern_Spanish_CI_AS)

insert into #DBTRANS
select ncantidad , tcodigoinsumo
from dpedido inner join 
tproducto on dpedido.tcodigoproducto=tproducto.tcodigoproducto 
where tcodigopedido=@tCodigoPedido and titem=@sitem
and tproducto.lControlInsumoCritico=1 
and isnull(tproducto.tcodigoinsumo,'')<>''  
and isnull(dpedido.limprime,0)=1


insert into #DBTRANS
SELECT     dbo.DPEDIDO.nCantidad * dbo.CPEDIDO.nCantidad AS nCantidad , dbo.TPRODUCTO.tCodigoInsumo
FROM         dbo.DPEDIDO INNER JOIN                       dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido 
= dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN                       
dbo.TPRODUCTO ON dbo.CPEDIDO.tProductoCombo = dbo.TPRODUCTO.tCodigoProducto 
WHERE    cpedido.tcodigopedido=@tCodigoPedido  and 
cpedido.tItem = @sitem 
and  (dbo.TPRODUCTO.lControlInsumoCritico = 1) AND (ISNULL(dbo.TPRODUCTO.tCodigoInsumo, '') <> '') AND (ISNULL(dbo.CPEDIDO.lImprime, 0) = 1)



 
select tCodigoInsumo,  SUM(ncantidad) as ncantidad
from #DBTRANS
 group by tCodigoInsumo
order by 2

end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc usp_Inforest_RevertirInsumosCriticosCabecera   --  '1300000024','001'
@tCodigoPedido as nvarchar(15) 

as
begin
set nocount on

CREATE TABLE #DBTRANS (ncantidad float, tCodigoInsumo nVarChar(20) collate Modern_Spanish_CI_AS)

insert into #DBTRANS
select ncantidad , tcodigoinsumo
from dpedido inner join 
tproducto on dpedido.tcodigoproducto=tproducto.tcodigoproducto 
where tcodigopedido=@tCodigoPedido 
and tproducto.lControlInsumoCritico=1 
and isnull(tproducto.tcodigoinsumo,'')<>''  
and isnull(dpedido.limprime,0)=1


insert into #DBTRANS
SELECT     dbo.DPEDIDO.nCantidad * dbo.CPEDIDO.nCantidad AS nCantidad , dbo.TPRODUCTO.tCodigoInsumo
FROM         dbo.DPEDIDO INNER JOIN                       dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido 
= dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem INNER JOIN                       
dbo.TPRODUCTO ON dbo.CPEDIDO.tProductoCombo = dbo.TPRODUCTO.tCodigoProducto 
WHERE    cpedido.tcodigopedido=@tCodigoPedido  
and  (dbo.TPRODUCTO.lControlInsumoCritico = 1) AND (ISNULL(dbo.TPRODUCTO.tCodigoInsumo, '') <> '') AND (ISNULL(dbo.CPEDIDO.lImprime, 0) = 1)



 
select tCodigoInsumo,  SUM(ncantidad) as ncantidad
from #DBTRANS
 group by tCodigoInsumo
order by 2

end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc usp_Inforest_ValidaDeliveryCliente   	 
@tcodigoDelivery nvarchar(7),
@tcodigoClienteF nvarchar(5)
as
begin
declare @cant int
declare @correla int
set @cant=(select COUNT(*) from tdeliverycliente where tcodigodelivery=@tcodigoDelivery and tcodigocliente=@tcodigoClienteF)

if @cant=0
	begin
		set @correla=(select ISNULL(max(ncorrelativo),0) from tdeliverycliente ) + 1
		insert into tdeliverycliente values (@correla,@tcodigoDelivery,@tcodigoClienteF)
	end 
end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE [dbo].[spRep_VentaIntervaloIntegrado]
@INTERVALO AS int,
@TipoPedido1 as nvarchar(100),
@TipoPedido2 as nvarchar(100),
@TipoPedido3 as nvarchar(100),
@TipoPedido4 as nvarchar(100),
@TipoPedido5 as nvarchar(100),
@TipoPedido6 as nvarchar(100),
@DIA1 as nvarchar(100),
@DIA2 as nvarchar(100),
@DIA3 as nvarchar(100),
@DIA4 as nvarchar(100),
@DIA5 as nvarchar(100),
@DIA6 as nvarchar(100),
@DIA7 as nvarchar(100),
@fInicio as nvarchar(25),
@fFinal as nvarchar(25),
@flagProduccion as bit,
@flagVenta as bit,
@flagCortesia as bit,
@flagCuentaCte as bit,
@flagPedidosFacturados as bit,
@flagCombinacion as bit,
@flagCargo  as bit
AS BEGIN

SET NOCOUNT ON

declare @sql as nvarchar(4000)
declare @sPrecio as nvarchar(250)
declare @comilla nvarchar(5)
declare @sCriterio nvarchar(3000)
declare @sCriteriox nvarchar(3000)
declare @xCriterio nvarchar(3000)
declare @sCostoPropiedad nvarchar(2000)
declare @sCombo nvarchar(2000)
declare @sCostoComboPropiedad nvarchar(2000)
declare @sCostoPropiedad2 nvarchar(2000)
declare @sCombo2 nvarchar(2000)
declare @sCostoComboPropiedad2 nvarchar(2000)
declare @flagVCosto as bit
set @flagVCosto=0
set @comilla=''''
set @sCostoPropiedad2 =''
set @sCombo2 =''
set @sCostoComboPropiedad2=''

	CREATE TABLE #DBTRANS (tLocal nVarChar(10) collate Modern_Spanish_CI_AS, Local nVarChar(50) collate Modern_Spanish_CI_AS, Salon nVarChar(50) collate Modern_Spanish_CI_AS,  Cantidad Float, Venta Float, Pedido nVarchar(15) collate Modern_Spanish_CI_AS, Documento nVarChar(25) collate Modern_Spanish_CI_AS, Fecha DateTime, tTipoPedido nVarchar(10) collate Modern_Spanish_CI_AS)
	CREATE TABLE #RESUMEN ( Pedido nVarchar(15) collate Modern_Spanish_CI_AS,TOTAL Float,tTipoPedido nVarchar(10) collate Modern_Spanish_CI_AS, Fecha DateTime,DIA nVarchar(10) collate Modern_Spanish_CI_AS)
 	CREATE TABLE #RESUMEN2 ( Pedido nVarchar(15) collate Modern_Spanish_CI_AS,TOTAL Float,tTipoPedido nVarchar(10) collate Modern_Spanish_CI_AS, Fecha DateTime,DIA nVarchar(10) collate Modern_Spanish_CI_AS)
if @flagProduccion=1 --produccion
begin
			Insert into #DBTRANS (tLocal, Salon,   Cantidad, Venta,  Pedido, Documento, Fecha, tTipoPedido  ) 
			SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon,   dbo.DPEDIDO.nCantidad AS Cantidad, dpedido.nprecioventa*dpedido.ncantidad AS Venta,  dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido 
			FROM  dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa 
			where MPEDIDO.tEstadoPedido <> '03' and DPEDIDO.tEstadoItem='N'  and mpedido.fregistro>=@finicio and mpedido.fregistro<=@ffinal
END 
	
if @flagVenta=1 --venta
begin
			Insert into #DBTRANS (tLocal, Salon,  Cantidad, Venta,  Pedido, Documento, Fecha, tTipoPedido )  
			SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon,   dbo.DPEDIDO.nCantidad AS Cantidad, dpedido.nprecioventa*dpedido.ncantidad AS Venta,  dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido
			FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento  
			WHERE dbo.MPEDIDO.tEstadoPedido <> '03'  AND dbo.DPEDIDO.tEstadoItem = 'N'  AND (dbo.DPEDIDO.tFacturado =  'P' OR dbo.DPEDIDO.tFacturado =  'F' ) and  mpedido.fregistro>=@finicio and mpedido.fregistro<=@ffinal and  mdocumento.fregistro>=@finicio and mdocumento.fregistro<=@ffinal
end

if @flagCortesia=1 --cortesia
begin
			Insert into #DBTRANS (tLocal, Salon,  Cantidad, Venta,  Pedido, Documento, Fecha, tTipoPedido )  
			SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon,   dbo.DPEDIDO.nCantidad AS Cantidad, dpedido.nprecioventa*dpedido.ncantidad AS Venta,  dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido 
			FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.tMesa LEFT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento
			WHERE dbo.MPEDIDO.tEstadoPedido <>   '03'  AND dbo.DPEDIDO.tEstadoItem =  'N' AND dbo.DPEDIDO.tFacturado =   'C'  and mpedido.fregistro>=@finicio and mpedido.fregistro<=@ffinal 
end 
if @flagCuentaCte=1 --cuenta corriente
begin
			Insert into #DBTRANS (tLocal, Salon,   Cantidad, Venta,  Pedido, Documento, Fecha, tTipoPedido )  
			SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon,  dbo.DPEDIDO.nCantidad AS Cantidad,  dpedido.nprecioventa*dpedido.ncantidad AS Venta,  dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido
			FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.TMESA  
			where isnull(MPEDIDO.tClienteCtaCte, '' )<> ''  and DPEDIDO.tEstadoItem= 'N'  and mpedido.fregistro>=@finicio and mpedido.fregistro<=@ffinal and dbo.DPEDIDO.tCodigoPedido not in (SELECT distinct dbo.DPEDIDO.tCodigoPedido FROM dbo.DPEDIDO RIGHT OUTER JOIN dbo.MDOCUMENTO ON dbo.DPEDIDO.tDocumento = dbo.MDOCUMENTO.tDocumento Where ISNULL(tCodigoPedido,0)<>0 and mdocumento.fregistro>=@finicio and mdocumento.fregistro<=@ffinal )
END

if @flagCombinacion=1 --combinacion
begin
			Insert into #DBTRANS (tLocal, Salon,   Cantidad, Venta , Pedido, Documento, Fecha, tTipoPedido ) 
			SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon,   dbo.CPEDIDO.nCantidad,  cpedido.nventa*dpedido.ncantidad AS Venta,  dbo.CPEDIDO.tCodigoPedido AS Pedido, dbo.DPEDIDO.tDocumento AS Documento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido
			FROM dbo.TMESA RIGHT OUTER JOIN dbo.MPEDIDO LEFT OUTER JOIN dbo.vSalon ON dbo.MPEDIDO.tSalon = dbo.vSalon.Codigo RIGHT OUTER JOIN dbo.DPEDIDO RIGHT OUTER JOIN dbo.CPEDIDO ON dbo.DPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido AND dbo.DPEDIDO.tItem = dbo.CPEDIDO.tItem LEFT OUTER JOIN dbo.vProducto ON dbo.CPEDIDO.tProductoCombo = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.CPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.TMESA  
			where MPEDIDO.tEstadoPedido <>  '03'  and   mpedido.fregistro>=@finicio and mpedido.fregistro<=@ffinal
end

if @flagCargo=1 --cargo
begin
			Insert into #DBTRANS (tLocal, Salon,  Cantidad, Venta,  Pedido, Documento, Fecha, tTipoPedido )   
			SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon,   dbo.DPEDIDO.nCantidad AS Cantidad,  dpedido.nprecioventa*dpedido.ncantidad AS  Venta,  dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido
			FROM dbo.TMESA RIGHT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido ON dbo.TMESA.tCodigoMesa = dbo.MPEDIDO.TMESA 
			where MPEDIDO.tEstadoPedido =  '05' and DPEDIDO.tEstadoItem= 'N' and  mpedido.fregistro>=@finicio and mpedido.fregistro<=@ffinal
end	
	
if @flagPedidosFacturados=1 --pedidos facturados
begin	
			Insert into #DBTRANS (tLocal, Salon,   Cantidad, Venta,  Pedido, Documento, Fecha, tTipoPedido)  
			SELECT dbo.vSalon.tLocal, dbo.vSalon.Descripcion AS Salon,   dbo.DPEDIDO.nCantidad AS Cantidad,   dpedido.nprecioventa*dpedido.ncantidad     AS Venta,  dbo.DPEDIDO.tCodigoPedido , dbo.DPEDIDO.tDocumento, dbo.MPEDIDO.fFecha, dbo.MPEDIDO.tTipoPedido
			FROM dbo.MDOCUMENTO RIGHT OUTER JOIN dbo.DPEDIDO LEFT OUTER JOIN dbo.vProducto ON dbo.DPEDIDO.tCodigoProducto = dbo.vProducto.Codigo LEFT OUTER JOIN dbo.vSalon RIGHT OUTER JOIN dbo.MPEDIDO ON dbo.vSalon.Codigo = dbo.MPEDIDO.tSalon ON dbo.DPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido LEFT OUTER JOIN dbo.TMESA ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa ON dbo.MDOCUMENTO.tDocumento = dbo.DPEDIDO.tDocumento  
			WHERE dbo.MPEDIDO.tEstadoPedido <>  '03'  AND dbo.DPEDIDO.tEstadoItem =  'N'  AND (dbo.DPEDIDO.tFacturado =  'P'  OR dbo.DPEDIDO.tFacturado =  'F' ) and  mpedido.fregistro>=@finicio and mpedido.fregistro<=@ffinal
end

				INSERT INTO #RESUMEN		
				SELECT PEDIDO, SUM(VENTA) AS TOTAL,MPEDIDO.TTIPOPEDIDO,MPEDIDO.FFECHA, upper(DATEPART(dw, dbo.MPEDIDO.fFecha)) as DIA
				FROM #DBTRANS INNER JOIN MPEDIDO ON #DBTRANS.PEDIDO=MPEDIDO.TCODIGOPEDIDO
				WHERE upper(DATEPART(dw, dbo.MPEDIDO.fFecha)) IN (@DIA1,@DIA2,@DIA3,@DIA4,@DIA5,@DIA6,@DIA7)
				GROUP BY PEDIDO,MPEDIDO.TTIPOPEDIDO,MPEDIDO.FFECHA
				ORDER BY 1
   
  
if UPPER(@TipoPedido6)='TODOS'
	BEGIN
		INSERT INTO #RESUMEN2 
		SELECT * FROM #RESUMEN
	END 
ELSE
	BEGIN
		INSERT INTO #RESUMEN2 
		SELECT #RESUMEN.Pedido, ROUND(#RESUMEN.TOTAL,2), #RESUMEN.tTipoPedido, #RESUMEN.Fecha, #RESUMEN.DIA 
		FROM   #RESUMEN LEFT OUTER JOIN dbo.vTipoPedido ON #RESUMEN.tTipoPedido = dbo.vTipoPedido.Codigo
		WHERE UPPER(VTIPOPEDIDO.DESCRIPCION) IN (@TIPOPEDIDO1,@TIPOPEDIDO2,@TIPOPEDIDO3,@TIPOPEDIDO4,@TIPOPEDIDO5)

	END


 	CREATE TABLE #RESUMEN3 (Pedido nVarchar(15) collate Modern_Spanish_CI_AS,
							TOTAL Float , 
							Fecha DateTime,
							DIA nVarchar(10) collate Modern_Spanish_CI_AS,
							NOMBREDIA nVarchar(20) collate Modern_Spanish_CI_AS,
							GRUPO INT,
							RANGO nVarchar(30) collate Modern_Spanish_CI_AS)

INSERT INTO #RESUMEN3
SELECT PEDIDO,TOTAL,FECHA,DIA,(case when dia =1 then 'DOMINGO' ELSE ( CASE WHEN DIA=2 THEN  'LUNES ' ELSE ( CASE WHEN DIA=3 THEN 'MARTES' ELSE (CASE WHEN DIA=4 THEN 'MIERCOLES' ELSE (CASE WHEN DIA=5 THEN 'JUEVES' ELSE ( CASE WHEN DIA=6 THEN 'VIERNES' ELSE  'SABADO'  END  ) END  ) END  ) END ) END)END ) AS NOMBREDIA,
FLOOR((DATEPART(hour,Fecha)*60+DATEPART(minute,Fecha))/@INTERVALO) as Grupo,
substring('00',1,2-len(ltrim(str(datepart(hour,Fecha))))) + 
ltrim(str(datepart(hour,Fecha))) + ':' + (case when datepart(minute,Fecha) <@INTERVALO then '00' else 
substring('00',1,2-len(ltrim(str(datepart(minute,Fecha)/@INTERVALO))*@INTERVALO))+ 
ltrim(str((datepart(minute,Fecha)/@INTERVALO ) *@intervalo)) end )
+ '-'+ substring('00',1,2-len(ltrim(str(datepart(hour,Fecha))))) + ltrim(str(datepart(hour,Fecha))) + ':'+
(case when datepart(minute,Fecha) <@INTERVALO
then substring('00',1,2-len(ltrim(str(@INTERVALO-1)) ))+ ltrim(str(STR(@INTERVALO-1)))
else substring('00',1,2-len(ltrim(str((datepart(minute,Fecha)/@INTERVALO)*@INTERVALO +@INTERVALO-1))))
+ltrim(str(datepart(minute,Fecha)/@INTERVALO*@INTERVALO+@INTERVALO-1)) end  ) as Rango
 FROM #RESUMEN2
ORDER BY 5,1

SELECT GRUPO,RANGO,COUNT(PEDIDO) PEDIDO , SUM(TOTAL) TOTAL FROM #RESUMEN3
GROUP BY GRUPO,RANGO
END
 
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


CREATE PROCEDURE [dbo].[usp_Cheff_ObtieneResumenProductos] 
@AREA NVARCHAR(3)
AS
BEGIN


DECLARE @ENVIO BIT
SELECT @ENVIO = ISNULL(lEnvioChef,0) FROM TPARAMETRO
DECLARE @CANT INT
SELECT  @CANT = COUNT(*) FROM TAREACHEF WHERE lAREA=1

CREATE TABLE #DBTRANSTEMP1 (Pedido nVarchar(50),item nVarchar(3) collate Modern_Spanish_CI_AS,
                            codigoProducto nVarchar(50) collate Modern_Spanish_CI_AS,
                            Producto nVarchar(50) collate Modern_Spanish_CI_AS,
                            Cantidad Float,Estado nVarchar(2) collate Modern_Spanish_CI_AS, Cantado bit)	

CREATE TABLE #DBTRANSTEMP2 (
                            codigoProducto nVarchar(50) collate Modern_Spanish_CI_AS,
                            Producto nVarchar(50) collate Modern_Spanish_CI_AS,
                            Rojo INT,
                            Ambar INT,
                            Verde INT,
                            NoCantado INT,
                            SumCantidad Float,
                            SumTotal Float)

--INSERTA 1

IF @CANT = 0

			INSERT INTO #DBTRANSTEMP1
			SELECT     dbo.MPEDIDO.tCodigoPedido AS Pedido,dpedido.titem as item,
								  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto,
								   dbo.DPEDIDO.nCantidad AS Cantidad,
			CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN

					CASE WHEN @ENVIO=1 THEN

							CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
								(
									case when datediff(ss,dpedido.fCantadoC,getdate())<  
													case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
											 then '5'
								else 
								( 
								case when datediff(ss,dpedido.fCantadoC,getdate())>= 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								and datediff(ss,dpedido.fCantadoC,getdate())< 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
											then '5'

								else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
								 ) end 
								)
							ELSE
								(
									case when datediff(ss,dpedido.fCantadoC,getdate())<  
													case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
											 then '1'
								else 
								( 
								case when datediff(ss,dpedido.fCantadoC,getdate())>= 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								and datediff(ss,dpedido.fCantadoC,getdate())< 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
											then '0'

								else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
								 ) end 
								)
							END 

					ELSE
						(
						case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
						 ) end 
						)
					END
			ELSE 
			'5'

			END As Estado,

			isnull(dpedido.lcantadoc,0) Cantado

			FROM         dbo.vMozo RIGHT OUTER JOIN
								  dbo.MPEDIDO INNER JOIN
								  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
								  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
								  dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
								  dbo.vSalon INNER JOIN
								  dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
									  (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
										FROM          dbo.TPRODUCTOPROPIEDAD
										GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem RIGHT OUTER JOIN
								  dbo.TPRODUCTOAREA INNER JOIN
								  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto 
			WHERE   isnull(dpedido.latendidoc,0)=0 and   (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null  AND varea.CODIGO=@AREA 


ELSE

			INSERT INTO #DBTRANSTEMP1
			SELECT     dbo.MPEDIDO.tCodigoPedido AS Pedido,dpedido.titem as item,
								  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto,
								   dbo.DPEDIDO.nCantidad AS Cantidad,
			CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN

					CASE WHEN @ENVIO=1 THEN

							CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
								(
									case when datediff(ss,dpedido.fCantadoC,getdate())<  
													case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
											 then '5'
								else 
								( 
								case when datediff(ss,dpedido.fCantadoC,getdate())>= 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								and datediff(ss,dpedido.fCantadoC,getdate())< 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
											then '5'

								else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
								 ) end 
								)
							ELSE
								(
									case when datediff(ss,dpedido.fCantadoC,getdate())<  
													case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
											 then '1'
								else 
								( 
								case when datediff(ss,dpedido.fCantadoC,getdate())>= 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								and datediff(ss,dpedido.fCantadoC,getdate())< 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
											then '0'

								else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
								 ) end 
								)
							END 

					ELSE
						(
						case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
						 ) end 
						)
					END
			ELSE 
			'5'

			END As Estado,

			isnull(dpedido.lcantadoc,0) Cantado

			FROM         dbo.vMozo RIGHT OUTER JOIN
								  dbo.MPEDIDO INNER JOIN
								  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
								  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
								  dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
								  dbo.vSalon INNER JOIN
								  dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
									  (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
										FROM          dbo.TPRODUCTOPROPIEDAD
										GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem RIGHT OUTER JOIN
								  dbo.TPRODUCTOAREA INNER JOIN
								  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto
								  AND dbo.MPEDIDO.tcaja NOT IN (select TCAJA from dbo.TAREACHEF)   
			WHERE   isnull(dpedido.latendidoc,0)=0 and   (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null  AND varea.CODIGO=@AREA 


			UNION


			SELECT     dbo.MPEDIDO.tCodigoPedido AS Pedido,dpedido.titem as item,
								  DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto,
								   dbo.DPEDIDO.nCantidad AS Cantidad,
			CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN

					CASE WHEN @ENVIO=1 THEN

							CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
								(
									case when datediff(ss,dpedido.fCantadoC,getdate())<  
													case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
											 then '5'
								else 
								( 
								case when datediff(ss,dpedido.fCantadoC,getdate())>= 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								and datediff(ss,dpedido.fCantadoC,getdate())< 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
											then '5'

								else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
								 ) end 
								)
							ELSE
								(
									case when datediff(ss,dpedido.fCantadoC,getdate())<  
													case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
											 then '1'
								else 
								( 
								case when datediff(ss,dpedido.fCantadoC,getdate())>= 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								and datediff(ss,dpedido.fCantadoC,getdate())< 
													case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
											then '0'

								else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
								 ) end 
								)
							END 

					ELSE
						(
						case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
						 ) end 
						)
					END
			ELSE 
			'5'

			END As Estado,

			isnull(dpedido.lcantadoc,0) Cantado

			FROM         dbo.vMozo RIGHT OUTER JOIN
								  dbo.MPEDIDO INNER JOIN
								  dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
								  dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
								  dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
								  dbo.vSalon INNER JOIN
								  dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
									  (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
										FROM          dbo.TPRODUCTOPROPIEDAD
										GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem RIGHT OUTER JOIN
								  dbo.TPRODUCTOAREA INNER JOIN
								  dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto
								  INNER JOIN dbo.TAREACHEF ON dbo.TAREACHEF.tCaja = dbo.MPEDIDO.tCaja AND dbo.TPRODUCTOAREA.tArea NOT IN (Select tArea From dbo.TAREACHEF)  
			WHERE   isnull(dpedido.latendidoc,0)=0 and   (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null  AND varea.CODIGO=@AREA 
			ORDER BY dbo.MPEDIDO.tCodigoPedido


--INSERTA DETALLE
INSERT INTO #DBTRANSTEMP2 select codigoproducto,producto,
case when estado=2 then sum(cantidad)
 else 0 End As Rojo, 
case when estado=0 then sum(cantidad)
 else 0 End As Ambar,  
case when estado=1 then sum(cantidad)
 else 0 End As Verde,                        
case when estado=5 then sum(cantidad)
 else 0 End As NoCantado,
sum(cantidad) as SumCantidad,0 as SumTotal
FROM #DBTRANSTEMP1
GROUP BY codigoproducto,producto,estado

UPDATE #DBTRANSTEMP2 SET SumTotal=(select sum(sumcantidad) from #DBTRANSTEMP2)


--MUESTRA EL DETALLE
SELECT producto As Producto,sum(rojo) As Rojo,
       sum(ambar) As Ambar,sum(verde) As Verde,
       sum(nocantado) As NoC,sum(sumcantidad) As TOTAL, SumTotal As SumTotal
FROM #DBTRANSTEMP2
GROUP BY codigoproducto,producto,SumTotal
ORDER BY producto

END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc usp_Inforest_ObtienePedidosPorSocios

as
begin

set nocount on

 select vpedidocabecera.codigo as Pedido,tCaja,TipoPedido, isnull(vsalon.tresumido,'') as Salon, isnull(Mesa,'') Mesa, 
 sum(nVenta) Venta, mozo as Mesero, ISNULL(Cliente,'') Cliente from vpedidocabecera
 left  join vpedidodetalle on codigo=tcodigopedido  left join vsalon on tsalon=vsalon.codigo
 where testadoPedido='01' and isnull(cliente,'') <>''
 group by vpedidocabecera.codigo,tcaja,tipopedido, mesa, mozo,Cliente, isnull(vsalon.tresumido,'')
 order by cliente asc
 end


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE procedure usp_Inforest_ObtieneClientesFactura    
@tcodigoDelivery nvarchar(10)
as
 
begin
set nocount on
	CREATE TABLE #DBTRANS 
	(
	Codigo nVarChar(20)	collate Modern_Spanish_CI_AS,
	Descripcion nVarChar(400)	collate Modern_Spanish_CI_AS,
	tIdentidad nVarChar(400)	collate Modern_Spanish_CI_AS,
	tDireccion nVarChar(400)	collate Modern_Spanish_CI_AS,
	lactivo bit,
	Relacionado nVarChar(400)	collate Modern_Spanish_CI_AS
	)
	
	insert into #dbtrans
	select codigo,descripcion,tidentidad,tdireccion,lactivo , ''
	from vcliente where lactivo=1 order by descripcion
 	
	update #dbtrans
	set Relacionado='SI' where codigo in (select tcodigocliente from tdeliverycliente where tcodigodelivery=@tcodigoDelivery)
	update #dbtrans
	set Relacionado='NO' where codigo not in (select tcodigocliente from tdeliverycliente where tcodigodelivery=@tcodigoDelivery)
	
	select * from #dbtrans
	order by Relacionado , descripcion
	
	
end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE proc usp_Inforest_ObtenerClientesFrecuente
as
begin
set nocount on

SELECT dbo.TDELIVERY.tCodigoDelivery AS Codigo,    isnull(dbo.tdelivery.tidentidad,'') tidentidad,  
	dbo.TDELIVERY.tTelefono, LTRIM(dbo.TDELIVERY.tApellido) + ' ' + LTRIM(dbo.TDELIVERY.tNombre) AS Cliente,  
           dbo.TDELIVERY.nDescuento, ltrim(dbo.TDELIVERY.treferencia) as treferencia, 
           dbo.vZona.Descripcion AS Zona, tcodigodelivery as codDely FROM dbo.TDELIVERY   
           LEFT OUTER JOIN dbo.vZona ON dbo.TDELIVERY.tZona = dbo.vZona.Codigo Where (dbo.TDELIVERY.lActivo = 1)  
           
           Union 
           SELECT 'C' + Tcodigopariente AS CODIGO, '' as tidentidad ,
         deliveryTelefono AS TTELEFONO,   PARIENTE AS CLIENTE, 
			0 NDESCUENTO,  FRECUENTE AS TREFERENCIA, CASE WHEN LCONYUGUE=0 THEN 'HIJO(A)' ELSE 'CONYUGUE' END AS ZONA , tcodigodelivery as codDely From VPARIENTE  
end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE [dbo].[sp_UpdFotoProducto]
@tCodigo 	    nvarchar(10),
@oFoto			    IMAGE	
AS
BEGIN
UPDATE TPRODUCTO SET oFoto=@oFoto
	WHERE tCodigoProducto=@tCodigo 

END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


-------------- NUEVOS SP -----------------------
CREATE PROCEDURE [dbo].[usp_Cheff_ObtenerResumenColoresXCaja]
@AREA NVARCHAR(3), 
@total float
as
begin

--DECLARE @FECHA SMALLDATETIME
DECLARE @ENVIO BIT
--SELECT @FECHA = lFechaChef FROM TPARAMETRO
SELECT @ENVIO = ISNULL(lEnvioChef,0) FROM TPARAMETRO


CREATE TABLE #DBTRANS (pedido nVarChar(15) collate Modern_Spanish_CI_AS, 
					   item  nVarChar(3) collate Modern_Spanish_CI_AS,
					   codigoProducto nVarChar(7) collate Modern_Spanish_CI_AS,
					   producto nVarChar(200) collate Modern_Spanish_CI_AS,
					   cantidad Float,
						estado nVarChar(1) collate Modern_Spanish_CI_AS)

create table #DBTRANS2
(
PRODUCTO nVarChar(200) collate Modern_Spanish_CI_AS,
					   cantidad Float)

begin
print '1'
insert into #DBTRANS
SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  , 
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 

CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

		CASE WHEN @ENVIO = 1 THEN

			  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '5'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '5'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
						 ) end 
						)

			  ELSE

						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
						 ) end 
						)
			   END

		ELSE
			(
				case when datediff(ss,dpedido.fCantadoC,getdate())<  
								case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						 then '1'
			else 
			( 
			case when datediff(ss,dpedido.fCantadoC,getdate())>= 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
			and datediff(ss,dpedido.fCantadoC,getdate())< 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
						then '0'

			else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
			 ) end 
			)

		END

ELSE 
'5' 
END As estado


FROM         
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto   RIGHT OUTER JOIN
                      dbo.TPRODUCTOAREA INNER JOIN 
                      dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo   
                      ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto 
WHERE   isnull(dpedido.latendidoc,0)=0 and  (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') 
and isnull(dpedido.limprime,0)<>0 and  dpedido.fenvio is not null  AND varea.CODIGO=@AREA
AND  dbo.DPEDIDO.tCajaD IN (SELECT tCaja  FROM TAREACHEF WHERE tArea=@AREA)  


UNION


SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  , 
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 

CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

		CASE WHEN @ENVIO = 1 THEN

			  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '5'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '5'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
						 ) end 
						)

			  ELSE

						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
						 ) end 
						)
			   END

		ELSE
			(
				case when datediff(ss,dpedido.fCantadoC,getdate())<  
								case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						 then '1'
			else 
			( 
			case when datediff(ss,dpedido.fCantadoC,getdate())>= 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
			and datediff(ss,dpedido.fCantadoC,getdate())< 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
						then '0'

			else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
			 ) end 
			)

		END

ELSE 
'5' 
END As estado


FROM         
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto   RIGHT OUTER JOIN
                      dbo.TPRODUCTOAREA INNER JOIN
                      dbo.TAREACHEF ON dbo.TAREACHEF.tArea = dbo.TPRODUCTOAREA.tArea
                      ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto 
WHERE   isnull(dpedido.latendidoc,0)=0 and  (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') AND
 isnull(dpedido.limprime,0)<>0 AND  dpedido.fenvio is not null  
 AND dbo.TAREACHEF.tArea= dbo.TPRODUCTOAREA.tArea --AND dbo.TAREACHEF.tCaja= dbo.DPEDIDO.tCajaD
 AND  dbo.DPEDIDO.tCajaD IN (SELECT tCaja  FROM TAREACHEF WHERE tArea=@AREA)

UNION


SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  ,  
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 


CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

		CASE WHEN @ENVIO = 1 THEN

			  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '5'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '5'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
						 ) end 
						)

			  ELSE

						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
						 ) end 
						)
			   END

		ELSE
			(
				case when datediff(ss,dpedido.fCantadoC,getdate())<  
								case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						 then '1'
			else 
			( 
			case when datediff(ss,dpedido.fCantadoC,getdate())>= 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
			and datediff(ss,dpedido.fCantadoC,getdate())< 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
						then '0'

			else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
			 ) end 
			)

		END

ELSE 
'5' 
END As estado

FROM      
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto    
WHERE     isnull(dpedido.latendidoc,0)=0 and (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null    and 
mpedido.tcodigopedido+dpedido.titem in ( 
SELECT     dbo.CPEDIDO.tCodigoPedido + dbo.CPEDIDO.tItem AS Expr1
FROM         dbo.TPRODUCTOAREA INNER JOIN
                      dbo.TPRODUCTO ON dbo.TPRODUCTOAREA.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.CPEDIDO ON dbo.TPRODUCTO.tCodigoProducto = dbo.CPEDIDO.tProductoCombo INNER JOIN
                      dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo INNER JOIN
                      dbo.MPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido
WHERE     (dbo.vArea.Codigo = @area)
GROUP BY dbo.CPEDIDO.tCodigoPedido, dbo.CPEDIDO.tItem, dbo.MPEDIDO.tEstadoPedido
HAVING      (dbo.MPEDIDO.tEstadoPedido <> N'03')
)
end

print '2'
insert into #DBTRANS2
select estado,sum(cantidad) as cantidad
from  #DBTRANS
group by estado
order by estado

print '3'

 
select case when producto=2 then 'ROJO' ELSE
 (CASE WHEN producto=1 then 'VERDE' ELSE (CASE WHEN producto=0 then 'AMBAR' ELSE 'NCANTADO' END) END) END as estado, 
cantidad, 
(round(cantidad * 100/@total,2) ) porcentaje 
from 
#dbtrans2

END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO




CREATE PROCEDURE [dbo].[usp_Cheff_ObtenerResumenXCaja]--       '001'
@AREA NVARCHAR(3)
as
begin

--DECLARE @FECHA SMALLDATETIME
DECLARE @ENVIO BIT
--SELECT @FECHA = lFechaChef FROM TPARAMETRO
SELECT @ENVIO = ISNULL(lEnvioChef,0) FROM TPARAMETRO

CREATE TABLE #DBTRANS (pedido nVarChar(15) collate Modern_Spanish_CI_AS, 
					   item  nVarChar(3) collate Modern_Spanish_CI_AS,
					   codigoProducto nVarChar(7) collate Modern_Spanish_CI_AS,
					   producto nVarChar(200) collate Modern_Spanish_CI_AS,
					   cantidad Float,
					   estado nVarChar(1) collate Modern_Spanish_CI_AS)

create table #DBTRANS2
(
PRODUCTO nVarChar(200) collate Modern_Spanish_CI_AS,
					   cantidad Float,
					total float
)



begin
insert into #DBTRANS
SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  , 
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 



CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

		CASE WHEN @ENVIO = 1 THEN

			  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '5'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '5'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
						 ) end 
						)

			  ELSE

						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
						 ) end 
						)
			   END

		ELSE
			(
				case when datediff(ss,dpedido.fCantadoC,getdate())<  
								case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						 then '1'
			else 
			( 
			case when datediff(ss,dpedido.fCantadoC,getdate())>= 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
			and datediff(ss,dpedido.fCantadoC,getdate())< 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
						then '0'

			else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
			 ) end 
			)

		END

ELSE 
'5' 
END As estado



FROM         
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto   RIGHT OUTER JOIN
                      dbo.TPRODUCTOAREA INNER JOIN 
                      dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo   
                      ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto 
WHERE    isnull(dpedido.latendidoc,0)=0 and  (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') 
and isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null  AND varea.CODIGO=@AREA
AND  dbo.DPEDIDO.tCajaD IN (SELECT tCaja  FROM TAREACHEF WHERE tArea=@AREA)  


UNION


SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  , 
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 



CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

		CASE WHEN @ENVIO = 1 THEN

			  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '5'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '5'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
						 ) end 
						)

			  ELSE

						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
						 ) end 
						)
			   END

		ELSE
			(
				case when datediff(ss,dpedido.fCantadoC,getdate())<  
								case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						 then '1'
			else 
			( 
			case when datediff(ss,dpedido.fCantadoC,getdate())>= 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
			and datediff(ss,dpedido.fCantadoC,getdate())< 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
						then '0'

			else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
			 ) end 
			)

		END

ELSE 
'5' 
END As estado



FROM         
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto   RIGHT OUTER JOIN
                      dbo.TPRODUCTOAREA INNER JOIN
                      dbo.TAREACHEF ON dbo.TAREACHEF.tArea = dbo.TPRODUCTOAREA.tArea
                      ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto
WHERE    isnull(dpedido.latendidoc,0)=0 and  (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') 
AND isnull(dpedido.limprime,0)<>0 AND dpedido.fenvio is not null 
AND dbo.TAREACHEF.tArea= dbo.TPRODUCTOAREA.tArea --AND dbo.TAREACHEF.tCaja= dbo.DPEDIDO.tCajaD
AND  dbo.DPEDIDO.tCajaD IN (SELECT tCaja  FROM TAREACHEF WHERE tArea=@AREA)  


UNION


SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido,  dpedido.titem as item  ,  
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, 


CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

		CASE WHEN @ENVIO = 1 THEN

			  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '5'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '5'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
						 ) end 
						)

			  ELSE

						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
						 ) end 
						)
			   END

		ELSE
			(
				case when datediff(ss,dpedido.fCantadoC,getdate())<  
								case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						 then '1'
			else 
			( 
			case when datediff(ss,dpedido.fCantadoC,getdate())>= 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
			and datediff(ss,dpedido.fCantadoC,getdate())< 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
						then '0'

			else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
			 ) end 
			)

		END

ELSE 
'5' 
END As estado



FROM      
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto    
WHERE    isnull(dpedido.latendidoc,0)=0 and  (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null    and 
mpedido.tcodigopedido+dpedido.titem in ( 
SELECT     dbo.CPEDIDO.tCodigoPedido + dbo.CPEDIDO.tItem AS Expr1
FROM         dbo.TPRODUCTOAREA INNER JOIN
                      dbo.TPRODUCTO ON dbo.TPRODUCTOAREA.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.CPEDIDO ON dbo.TPRODUCTO.tCodigoProducto = dbo.CPEDIDO.tProductoCombo INNER JOIN
                      dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo INNER JOIN
                      dbo.MPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido
WHERE     (dbo.vArea.Codigo = @area)
GROUP BY dbo.CPEDIDO.tCodigoPedido, dbo.CPEDIDO.tItem, dbo.MPEDIDO.tEstadoPedido
HAVING      (dbo.MPEDIDO.tEstadoPedido <>N'03')
)
end


insert into #DBTRANS2
select producto,sum(cantidad) as cantidad, 0
from  #DBTRANS
group by producto
order by producto

update #dbtrans2 set total=(select sum(cantidad) from #dbtrans)

select producto, cantidad , total from #dbtrans2

END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE procedure [dbo].[usp_Cheff_ObtieneAreasPantallaxCaja]
@AREA NVARCHAR(3)
AS
BEGIN
select tCaja from TAREACHEF 
where tArea = @AREA

END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO

CREATE procedure [dbo].[usp_Cheff_ObtieneAreaxCaja]
@AREA NVARCHAR(3)
AS
BEGIN
select * from TAREACHEF 
where tArea = @AREA AND lArea = 1

END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO



CREATE procedure [dbo].[usp_Cheff_ObtieneRegistrosAtendidosXCaja]  
@fechaAtendido nvarchar(100),
@area nvarchar(3)

AS
BEGIN

SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS TipoPedido,dpedido.titem as item  , CONVERT(datetime, dbo.DPEDIDO.fEnvio, 
                      110) AS Envio, dbo.vSalon.tResumido AS Salon, dbo.TMESA.tResumido AS Mesa, dbo.MPEDIDO.tObservacion AS ObservacionP, 
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, CONVERT(bit, ISNULL(DATALENGTH(dbo.DPEDIDO.tObservacion), 0)) 
                      AS lObservacion, CONVERT(bit, ISNULL(T1.nPropiedad, 0)) AS lPropiedad, 
CASE WHEN dPedido.lCantadoC=1 THEN (
case when datediff(ss,dpedido.fCantadoC,getdate())< case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end  then '1'
else ( case when datediff(ss,dpedido.fCantadoC,getdate())> case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end and datediff(ss,dpedido.fCantadoC,getdate())< case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '0'
else ( case when datediff(ss,dpedido.fCantadoC,getdate())> case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
 ) end 
) ELSE '5' END As estado,
 isnull(dbo.dpedido.tobservacion,'') as observacionD, isnull(dpedido.lcombinacion,0) as lCombinacion, 

 LTRIM(STR(((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) / (3600))) +'h '+ ltrim(Str( (((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) % (3600)) /(60) )) + 'm ' + ltrim(str((((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) % (3600)) %(60) )) + 's' as Duracion,

 vmozo.tresumido as Mozo, isnull(dbo.dpedido.norden,0) as Orden  ,isnull(dpedido.tusuarioatendio,'') as atendio,  RIGHT( CONVERT(DATETIME, dpedido.fenvio, 108),8) as Hora

FROM         dbo.vMozo RIGHT OUTER JOIN
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
                      dbo.vSalon INNER JOIN
                      dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
                          (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
                            FROM          dbo.TPRODUCTOPROPIEDAD
                            GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem RIGHT OUTER JOIN
                      dbo.TPRODUCTOAREA INNER JOIN 
                      dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo   
                      ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto 
WHERE     (dbo.MPEDIDO.tEstadoPedido  <> '04') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and isnull(dpedido.latendidoc,0)=1
and dpedido.fatendidoc >=@fechaAtendido and varea.codigo=@area
AND  dbo.DPEDIDO.tCajaD IN (SELECT tCaja  FROM TAREACHEF WHERE tArea=@AREA)  



UNION



SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS TipoPedido,dpedido.titem as item  , CONVERT(datetime, dbo.DPEDIDO.fEnvio, 
                      110) AS Envio, dbo.vSalon.tResumido AS Salon, dbo.TMESA.tResumido AS Mesa, dbo.MPEDIDO.tObservacion AS ObservacionP, 
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, CONVERT(bit, ISNULL(DATALENGTH(dbo.DPEDIDO.tObservacion), 0)) 
                      AS lObservacion, CONVERT(bit, ISNULL(T1.nPropiedad, 0)) AS lPropiedad, 
CASE WHEN dPedido.lCantadoC=1 THEN (
case when datediff(ss,dpedido.fCantadoC,getdate())< case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end  then '1'
else ( case when datediff(ss,dpedido.fCantadoC,getdate())> case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end and datediff(ss,dpedido.fCantadoC,getdate())< case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '0'
else ( case when datediff(ss,dpedido.fCantadoC,getdate())> case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
 ) end 
) ELSE '5' END As estado,
 isnull(dbo.dpedido.tobservacion,'') as observacionD, isnull(dpedido.lcombinacion,0) as lCombinacion, 

 LTRIM(STR(((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) / (3600))) +'h '+ ltrim(Str( (((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) % (3600)) /(60) )) + 'm ' + ltrim(str((((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) % (3600)) %(60) )) + 's' as Duracion,

 vmozo.tresumido as Mozo, isnull(dbo.dpedido.norden,0) as Orden  ,isnull(dpedido.tusuarioatendio,'') as atendio,  RIGHT( CONVERT(DATETIME, dpedido.fenvio, 108),8) as Hora

FROM         dbo.vMozo RIGHT OUTER JOIN
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
                      dbo.vSalon INNER JOIN
                      dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
                          (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
                            FROM          dbo.TPRODUCTOPROPIEDAD
                            GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem RIGHT OUTER JOIN
                      dbo.TPRODUCTOAREA INNER JOIN
                      dbo.TAREACHEF ON dbo.TAREACHEF.tArea = dbo.TPRODUCTOAREA.tArea
                      ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto
WHERE     (dbo.MPEDIDO.tEstadoPedido  <> '04') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and isnull(dpedido.latendidoc,0)=1
and dpedido.fatendidoc >=@fechaAtendido AND dbo.TAREACHEF.tArea= dbo.TPRODUCTOAREA.tArea 
AND  dbo.DPEDIDO.tCajaD IN (SELECT tCaja  FROM TAREACHEF WHERE tArea=@AREA)  



UNION



SELECT      dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS TipoPedido,dpedido.titem as item  , CONVERT(datetime, dbo.DPEDIDO.fEnvio, 
                      110) AS Envio, dbo.vSalon.tResumido AS Salon, dbo.TMESA.tResumido AS Mesa, dbo.MPEDIDO.tObservacion AS ObservacionP, 
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, CONVERT(bit, ISNULL(DATALENGTH(dbo.DPEDIDO.tObservacion), 0)) 
                      AS lObservacion, CONVERT(bit, ISNULL(T1.nPropiedad, 0)) AS lPropiedad, 
CASE WHEN dPedido.lCantadoC=1 THEN (
case when datediff(ss,dpedido.fCantadoC,getdate())< case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end  then '1'
else ( case when datediff(ss,dpedido.fCantadoC,getdate())> case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end and datediff(ss,dpedido.fCantadoC,getdate())< case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '0'
else ( case when datediff(ss,dpedido.fCantadoC,getdate())> case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
 ) end 
) ELSE '5' END As estado,
 isnull(dbo.dpedido.tobservacion,'') as observacionD, isnull(dpedido.lcombinacion,0) as lCombinacion,

LTRIM(STR(((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) / (3600))) +'h '+ ltrim(Str( (((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) % (3600)) /(60) )) + 'm ' + ltrim(str((((datediff(second, dpedido.fCantadoC, DPEDIDO.FATENDIDOC)) % (24 * 60 * 60)) % (3600)) %(60) )) + 's' as Duracion,

 vmozo.tresumido as Mozo, isnull(dbo.dpedido.norden,0) as Orden  ,isnull(dpedido.tusuarioatendio,'') as atendio,  RIGHT( CONVERT(DATETIME, dpedido.fenvio, 108),8) as Hora

FROM         dbo.vMozo RIGHT OUTER JOIN
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
                      dbo.vSalon INNER JOIN
                      dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
                          (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
                            FROM          dbo.TPRODUCTOPROPIEDAD
                            GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem  
WHERE     (dbo.MPEDIDO.tEstadoPedido  <> '04') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and isnull(dpedido.latendidoc,0)=1
and dpedido.fatendidoc >= @fechaAtendido and mpedido.tcodigopedido+dpedido.titem  
in ( 
SELECT     dbo.CPEDIDO.tCodigoPedido + dbo.CPEDIDO.tItem AS Expr1
FROM         dbo.TPRODUCTOAREA INNER JOIN
                      dbo.TPRODUCTO ON dbo.TPRODUCTOAREA.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.CPEDIDO ON dbo.TPRODUCTO.tCodigoProducto = dbo.CPEDIDO.tProductoCombo INNER JOIN
                      dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo INNER JOIN
                      dbo.MPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido
WHERE     (dbo.vArea.Codigo = @area)
GROUP BY dbo.CPEDIDO.tCodigoPedido, dbo.CPEDIDO.tItem, dbo.MPEDIDO.tEstadoPedido
HAVING      (dbo.MPEDIDO.tEstadoPedido = N'01')
)



ORDER BY 4
end


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


CREATE PROCEDURE [dbo].[usp_Cheff_ObtieneRegistrosxCaja] 
@AREA NVARCHAR(3)
as
begin
--DECLARE @FECHA SMALLDATETIME
DECLARE @ENVIO BIT
--SELECT @FECHA = lFechaChef FROM TPARAMETRO
SELECT @ENVIO = ISNULL(lEnvioChef,0) FROM TPARAMETRO


SELECT     dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS TipoPedido,dpedido.titem as item  , CONVERT(datetime, dbo.DPEDIDO.fEnvio, 
                      110) AS Envio, dbo.vSalon.tResumido AS Salon, dbo.TMESA.tResumido AS Mesa, dbo.MPEDIDO.tObservacion AS ObservacionP, 
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, CONVERT(bit, ISNULL(DATALENGTH(dbo.DPEDIDO.tObservacion), 0)) 
                      AS lObservacion, CONVERT(bit, ISNULL(T1.nPropiedad, 0)) AS lPropiedad, 



CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

		CASE WHEN @ENVIO = 1 THEN

			  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '5'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '5'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
						 ) end 
						)

			  ELSE

						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
						 ) end 
						)
			   END

		ELSE
			(
				case when datediff(ss,dpedido.fCantadoC,getdate())<  
								case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						 then '1'
			else 
			( 
			case when datediff(ss,dpedido.fCantadoC,getdate())>= 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
			and datediff(ss,dpedido.fCantadoC,getdate())< 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
						then '0'

			else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
			 ) end 
			)

		END

ELSE 
'5' 
END As estado,


isnull(dbo.dpedido.tobservacion,'') as observacionD, isnull(dpedido.lcombinacion,0) as lCombinacion, 

(SELECT Duracion = Case dbo.dPedido.lCantadoC  WHEN 1 THEN  LTRIM(STR(((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) / (3600))) +'h '+ ltrim(Str( (((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) % (3600)) /(60) )) + 'm ' + ltrim(str((((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) % (3600)) %(60) )) + 's' ELSE '00'+'h '+'00'+'m '+'00'+'s' END )as Duracion, 

vmozo.tresumido as Mozo, isnull(dbo.dpedido.norden,0) as Orden, RIGHT( CONVERT(DATETIME, dpedido.fenvio, 108),8) as Hora, isnull(dpedido.lcantadoc,0) cantado

FROM         dbo.vMozo RIGHT OUTER JOIN
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
                      dbo.vSalon INNER JOIN
                      dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
                          (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
                            FROM          dbo.TPRODUCTOPROPIEDAD
                            GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem RIGHT OUTER JOIN
                      dbo.TPRODUCTOAREA INNER JOIN 
                      dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo   
                      ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto  
WHERE   isnull(dpedido.latendidoc,0)=0 and   (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') 
AND isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null  AND varea.CODIGO=@AREA 
AND  dbo.DPEDIDO.tCajaD IN (SELECT tCaja  FROM TAREACHEF WHERE tArea=@AREA)   
 

UNION


SELECT     dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS TipoPedido,dpedido.titem as item  , CONVERT(datetime, dbo.DPEDIDO.fEnvio, 
                      110) AS Envio, dbo.vSalon.tResumido AS Salon, dbo.TMESA.tResumido AS Mesa, dbo.MPEDIDO.tObservacion AS ObservacionP, 
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, CONVERT(bit, ISNULL(DATALENGTH(dbo.DPEDIDO.tObservacion), 0)) 
                      AS lObservacion, CONVERT(bit, ISNULL(T1.nPropiedad, 0)) AS lPropiedad, 



CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

		CASE WHEN @ENVIO = 1 THEN

			  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '5'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '5'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
						 ) end 
						)

			  ELSE

						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
						 ) end 
						)
			   END

		ELSE
			(
				case when datediff(ss,dpedido.fCantadoC,getdate())<  
								case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						 then '1'
			else 
			( 
			case when datediff(ss,dpedido.fCantadoC,getdate())>= 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
			and datediff(ss,dpedido.fCantadoC,getdate())< 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
						then '0'

			else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
			 ) end 
			)

		END

ELSE 
'5' 
END As estado,


isnull(dbo.dpedido.tobservacion,'') as observacionD, isnull(dpedido.lcombinacion,0) as lCombinacion, 

(SELECT Duracion = Case dbo.dPedido.lCantadoC  WHEN 1 THEN  LTRIM(STR(((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) / (3600))) +'h '+ ltrim(Str( (((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) % (3600)) /(60) )) + 'm ' + ltrim(str((((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) % (3600)) %(60) )) + 's' ELSE '00'+'h '+'00'+'m '+'00'+'s' END )as Duracion, 

vmozo.tresumido as Mozo, isnull(dbo.dpedido.norden,0) as Orden, RIGHT( CONVERT(DATETIME, dpedido.fenvio, 108),8) as Hora, isnull(dpedido.lcantadoc,0) cantado

FROM         dbo.vMozo RIGHT OUTER JOIN
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
                      dbo.vSalon INNER JOIN
                      dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
                          (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
                            FROM          dbo.TPRODUCTOPROPIEDAD
                            GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem RIGHT OUTER JOIN
                      dbo.TPRODUCTOAREA INNER JOIN
                      dbo.TAREACHEF ON dbo.TAREACHEF.tArea = dbo.TPRODUCTOAREA.tArea
                      ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto 
WHERE   isnull(dpedido.latendidoc,0)=0 and   (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') 
AND isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null AND dbo.TAREACHEF.tArea= dbo.TPRODUCTOAREA.tArea 
AND  dbo.DPEDIDO.tCajaD IN (SELECT tCaja  FROM TAREACHEF WHERE tArea=@AREA) 


UNION




SELECT    dbo.MPEDIDO.tCodigoPedido AS Pedido, dbo.vTipoPedido.Descripcion AS TipoPedido,dpedido.titem as item  , CONVERT(datetime, dbo.DPEDIDO.fEnvio, 
                      110) AS Envio, dbo.vSalon.tResumido AS Salon, dbo.TMESA.tResumido AS Mesa, dbo.MPEDIDO.tObservacion AS ObservacionP, 
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto, dbo.DPEDIDO.nCantidad AS Cantidad, CONVERT(bit, ISNULL(DATALENGTH(dbo.DPEDIDO.tObservacion), 0)) 
                      AS lObservacion, CONVERT(bit, ISNULL(T1.nPropiedad, 0)) AS lPropiedad, 


CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN 

		CASE WHEN @ENVIO = 1 THEN

			  CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '5'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '5'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
						 ) end 
						)

			  ELSE

						(
							case when datediff(ss,dpedido.fCantadoC,getdate())<  
											case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
									 then '1'
						else 
						( 
						case when datediff(ss,dpedido.fCantadoC,getdate())>= 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						and datediff(ss,dpedido.fCantadoC,getdate())< 
											case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
									then '0'

						else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
						 ) end 
						)
			   END

		ELSE
			(
				case when datediff(ss,dpedido.fCantadoC,getdate())<  
								case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						 then '1'
			else 
			( 
			case when datediff(ss,dpedido.fCantadoC,getdate())>= 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
			and datediff(ss,dpedido.fCantadoC,getdate())< 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
						then '0'

			else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else 'x' end) end
			 ) end 
			)

		END

ELSE 
'5' 
END As estado,


 isnull(dbo.dpedido.tobservacion,'') as observacionD, isnull(dpedido.lcombinacion,0) as lCombinacion,

(SELECT Duracion = Case dbo.dPedido.lCantadoC  WHEN 1 THEN  LTRIM(STR(((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) / (3600))) +'h '+ ltrim(Str( (((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) % (3600)) /(60) )) + 'm ' + ltrim(str((((datediff(second, dpedido.fCantadoC, GETDATE())) % (24 * 60 * 60)) % (3600)) %(60) )) + 's' ELSE '00'+'h '+'00'+'m '+'00'+'s' END )as Duracion, 

 vmozo.tresumido as Mozo, isnull(dbo.dpedido.norden,0) as Orden,RIGHT( CONVERT(DATETIME, dpedido.fenvio, 108),8) as Hora, isnull(dpedido.lcantadoc,0) cantado

FROM         dbo.vMozo RIGHT OUTER JOIN
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
                      dbo.vSalon INNER JOIN
                      dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
                          (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
                            FROM          dbo.TPRODUCTOPROPIEDAD
                            GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem 
WHERE     (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') and isnull(dpedido.limprime,0)<>0 and isnull(dpedido.latendidoc,0)=0 and dpedido.fenvio is not null    and 
mpedido.tcodigopedido+dpedido.titem in ( 
SELECT     dbo.CPEDIDO.tCodigoPedido + dbo.CPEDIDO.tItem AS Expr1
FROM         dbo.TPRODUCTOAREA INNER JOIN
                      dbo.TPRODUCTO ON dbo.TPRODUCTOAREA.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.CPEDIDO ON dbo.TPRODUCTO.tCodigoProducto = dbo.CPEDIDO.tProductoCombo INNER JOIN
                      dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo INNER JOIN
                      dbo.MPEDIDO ON dbo.CPEDIDO.tCodigoPedido = dbo.MPEDIDO.tCodigoPedido
WHERE     (dbo.vArea.Codigo = @AREA)
GROUP BY dbo.CPEDIDO.tCodigoPedido, dbo.CPEDIDO.tItem, dbo.MPEDIDO.tEstadoPedido
HAVING      (dbo.MPEDIDO.tEstadoPedido  <> '03')
)

ORDER BY 4
END

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


CREATE PROCEDURE [dbo].[usp_Cheff_ObtieneResumenProductosXCaja] 
@AREA NVARCHAR(3)
AS
BEGIN
--DECLARE @FECHA SMALLDATETIME
DECLARE @ENVIO BIT
--SELECT @FECHA = lFechaChef FROM TPARAMETRO
SELECT @ENVIO = ISNULL(lEnvioChef,0) FROM TPARAMETRO

CREATE TABLE #DBTRANSTEMP1 (Pedido nVarchar(50),item nVarchar(3) collate Modern_Spanish_CI_AS,
                            codigoProducto nVarchar(50) collate Modern_Spanish_CI_AS,
                            Producto nVarchar(50) collate Modern_Spanish_CI_AS,
                            Cantidad Float,Estado nVarchar(2) collate Modern_Spanish_CI_AS, Cantado bit)	

CREATE TABLE #DBTRANSTEMP2 (
                            codigoProducto nVarchar(50) collate Modern_Spanish_CI_AS,
                            Producto nVarchar(50) collate Modern_Spanish_CI_AS,
                            Rojo INT,
                            Ambar INT,
                            Verde INT,
                            NoCantado INT,
                            SumCantidad Float,
                            SumTotal Float)

--INSERTA 1
INSERT INTO #DBTRANSTEMP1
SELECT     dbo.MPEDIDO.tCodigoPedido AS Pedido,dpedido.titem as item,
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto,
                       dbo.DPEDIDO.nCantidad AS Cantidad,
CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN

		CASE WHEN @ENVIO=1 THEN

				CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
                    (
						case when datediff(ss,dpedido.fCantadoC,getdate())<  
										case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								 then '5'
					else 
					( 
					case when datediff(ss,dpedido.fCantadoC,getdate())>= 
										case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
					and datediff(ss,dpedido.fCantadoC,getdate())< 
										case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
								then '5'

					else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
					 ) end 
					)
			    ELSE
					(
						case when datediff(ss,dpedido.fCantadoC,getdate())<  
										case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								 then '1'
					else 
					( 
					case when datediff(ss,dpedido.fCantadoC,getdate())>= 
										case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
					and datediff(ss,dpedido.fCantadoC,getdate())< 
										case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
								then '0'

					else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
					 ) end 
					)
				END 

		ELSE
			(
			case when datediff(ss,dpedido.fCantadoC,getdate())<  
								case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						 then '1'
			else 
			( 
			case when datediff(ss,dpedido.fCantadoC,getdate())>= 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
			and datediff(ss,dpedido.fCantadoC,getdate())< 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
						then '0'

			else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
			 ) end 
			)
        END
ELSE 
'5'

END As Estado,

isnull(dpedido.lcantadoc,0) Cantado

FROM         dbo.vMozo RIGHT OUTER JOIN
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
                      dbo.vSalon INNER JOIN
                      dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
                          (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
                            FROM          dbo.TPRODUCTOPROPIEDAD
                            GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem RIGHT OUTER JOIN
                      dbo.TPRODUCTOAREA INNER JOIN 
                      dbo.vArea ON dbo.TPRODUCTOAREA.tArea = dbo.vArea.Codigo   
                      ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto 
WHERE   isnull(dpedido.latendidoc,0)=0 and   (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') 
and isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null  AND varea.CODIGO=@AREA 
AND  dbo.DPEDIDO.tCajaD IN (SELECT tCaja  FROM TAREACHEF WHERE tArea=@AREA)  


UNION


SELECT     dbo.MPEDIDO.tCodigoPedido AS Pedido,dpedido.titem as item,
                      DBO.TPRODUCTO.TCODIGOPRODUCTO AS codigoProducto,dbo.TPRODUCTO.TDETALLADO AS Producto,
                       dbo.DPEDIDO.nCantidad AS Cantidad,
CASE WHEN isnull(dPedido.lCantadoC,1)=1 THEN

		CASE WHEN @ENVIO=1 THEN

				CASE WHEN isnull(dPedido.lTipoEnvio,0)=0 THEN
                    (
						case when datediff(ss,dpedido.fCantadoC,getdate())<  
										case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								 then '5'
					else 
					( 
					case when datediff(ss,dpedido.fCantadoC,getdate())>= 
										case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
					and datediff(ss,dpedido.fCantadoC,getdate())< 
										case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
								then '5'

					else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '5' else '5' end) end
					 ) end 
					)
			    ELSE
					(
						case when datediff(ss,dpedido.fCantadoC,getdate())<  
										case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
								 then '1'
					else 
					( 
					case when datediff(ss,dpedido.fCantadoC,getdate())>= 
										case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
					and datediff(ss,dpedido.fCantadoC,getdate())< 
										case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
								then '0'

					else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
					 ) end 
					)
				END 

		ELSE
			(
			case when datediff(ss,dpedido.fCantadoC,getdate())<  
								case when dpedido.ncantidad>1 then  (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
						 then '1'
			else 
			( 
			case when datediff(ss,dpedido.fCantadoC,getdate())>= 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else tproducto.ntiempo*60 end 
			and datediff(ss,dpedido.fCantadoC,getdate())< 
								case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2)+60 else (tproducto.ntiempo*60)+60 end 
						then '0'

			else ( case when datediff(ss,dpedido.fCantadoC,getdate())>= case when dpedido.ncantidad>1 then (tproducto.ntiempo * 60) + ((tproducto.ntiempo * 60)/2) else (tproducto.ntiempo*60)+60 end then '2' else '5' end) end
			 ) end 
			)
        END
ELSE 
'5'

END As Estado,

isnull(dpedido.lcantadoc,0) Cantado

FROM         dbo.vMozo RIGHT OUTER JOIN
                      dbo.MPEDIDO INNER JOIN
                      dbo.DPEDIDO ON dbo.MPEDIDO.tCodigoPedido = dbo.DPEDIDO.tCodigoPedido INNER JOIN
                      dbo.TPRODUCTO ON dbo.DPEDIDO.tCodigoProducto = dbo.TPRODUCTO.tCodigoProducto INNER JOIN
                      dbo.vTipoPedido ON dbo.MPEDIDO.tTipoPedido = dbo.vTipoPedido.Codigo ON dbo.vMozo.Codigo = dbo.DPEDIDO.tmozod LEFT OUTER JOIN
                      dbo.vSalon INNER JOIN
                      dbo.TMESA ON dbo.vSalon.Codigo = dbo.TMESA.tSalon ON dbo.MPEDIDO.tMesa = dbo.TMESA.tCodigoMesa LEFT OUTER JOIN
                          (SELECT     tCodigoPedido, tItem, CASE WHEN COUNT(tProducto) > 0 THEN 1 ELSE 0 END AS nPropiedad
                            FROM          dbo.TPRODUCTOPROPIEDAD
                            GROUP BY tCodigoPedido, tItem) AS T1 ON dbo.DPEDIDO.tCodigoPedido = T1.tCodigoPedido AND dbo.DPEDIDO.tItem = T1.tItem RIGHT OUTER JOIN
                      dbo.TPRODUCTOAREA INNER JOIN
                      dbo.TAREACHEF ON dbo.TAREACHEF.tArea = dbo.TPRODUCTOAREA.tArea
                      ON dbo.TPRODUCTO.tCodigoProducto = dbo.TPRODUCTOAREA.tCodigoProducto 
WHERE   isnull(dpedido.latendidoc,0)=0 and   (dbo.MPEDIDO.tEstadoPedido <> '03') and (dbo.dpedido.testadoitem='N') AND
isnull(dpedido.limprime,0)<>0 and dpedido.fenvio is not null  AND dbo.TAREACHEF.tArea= dbo.TPRODUCTOAREA.tArea --AND dbo.TAREACHEF.tCaja= dbo.DPEDIDO.tCajaD
AND  dbo.DPEDIDO.tCajaD IN (SELECT tCaja  FROM TAREACHEF WHERE tArea=@AREA)  
ORDER BY dbo.MPEDIDO.tCodigoPedido


--INSERTA DETALLE
INSERT INTO #DBTRANSTEMP2 select codigoproducto,producto,
case when estado=2 then sum(cantidad)
 else 0 End As Rojo, 
case when estado=0 then sum(cantidad)
 else 0 End As Ambar,  
case when estado=1 then sum(cantidad)
 else 0 End As Verde,                        
case when estado=5 then sum(cantidad)
 else 0 End As NoCantado,
sum(cantidad) as SumCantidad,0 as SumTotal
FROM #DBTRANSTEMP1
GROUP BY codigoproducto,producto,estado

UPDATE #DBTRANSTEMP2 SET SumTotal=(select sum(sumcantidad) from #DBTRANSTEMP2)


--MUESTRA EL DETALLE
SELECT producto As Producto,sum(rojo) As Rojo,
       sum(ambar) As Ambar,sum(verde) As Verde,
       sum(nocantado) As NoC,sum(sumcantidad) As TOTAL, SumTotal As SumTotal
FROM #DBTRANSTEMP2
GROUP BY codigoproducto,producto,SumTotal
ORDER BY producto

END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO



CREATE PROCEDURE [dbo].[spRep_AnulacionPedidoIntegrado]
@flagFranja as bit,
@fInicio as smalldatetime,
@fFinal as smalldatetime,
@flagNoImp as bit,
@flagImp as bit,
@flagTodos as bit


AS BEGIN

SET NOCOUNT ON

	CREATE TABLE #DBTRANS (
	                       FechaPedido nVarChar(50) collate Modern_Spanish_CI_AS, 
	                       Turno nVarChar(20) collate Modern_Spanish_CI_AS, 
	                       Mesa nVarChar(50) collate Modern_Spanish_CI_AS, 
	                       Pedido nVarChar(20) collate Modern_Spanish_CI_AS,
	                       Producto nVarChar(150) collate Modern_Spanish_CI_AS, 
	                       Cantidad Float, Venta Float, FechaProducto nVarChar(50) collate Modern_Spanish_CI_AS,
	                       Imprime nVarchar(1), FechaAnulaProducto nVarChar(50) collate Modern_Spanish_CI_AS,
	                       FechaAnulaPedido nVarChar(50) collate Modern_Spanish_CI_AS,
	                       Usuario nVarChar(20) collate Modern_Spanish_CI_AS, 
	                       UsuarioAnulaProducto nVarChar(20) collate Modern_Spanish_CI_AS,
	                       UsuarioAnulaPedido nVarChar(20) collate Modern_Spanish_CI_AS,
	                       Motivo nVarChar(100) collate Modern_Spanish_CI_AS)
	                       
IF @flagFranja = 0
                     
BEGIN
	IF @flagTodos = 1
	   BEGIN	
	        --PRODUCTOS ELIMINADOS - ENVIADOS A APEDIDO	  
            INSERT INTO #DBTRANS         
			SELECT CONVERT(NVARCHAR,M.fRegistro,103)+ ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaPedido,M.tTurno As Turno,ISNULL(VM.tDetallado,'') As Mesa,M.tCodigoPedido As Pedido,
				   V.tResumido As Producto, A.nCantidad As Cantidad, A.nPrecioVenta As Venta, CONVERT(NVARCHAR,A.fRegistro,103) As FechaProducto,
				   A.lImprime As Imprime, CONVERT(NVARCHAR,A.fRegistroAnulado,103)  As FechaAnulaProducto, '' As FechaAnulaPedido, M.tUsuario As Usuario,
				   A.tUsuarioAnulado As UsuarioAnulaProducto, '' As UsuarioAnulaPedido, 
				   (CASE VE.Descripcion WHEN 'Otro' THEN A.tObservacionAnulado Else VE.Descripcion END) As Motivo    
			FROM MPEDIDO M INNER JOIN APEDIDO A ON M.tCodigoPedido = A.tCodigoPedido
						   INNER JOIN vProducto V ON A.tCodigoProducto = V.Codigo              
						   LEFT JOIN TMESA VM ON M.tMesa = VM.tCodigoMesa
						   LEFT JOIN vMotivoEliminacion VE ON A.tMotivoEliminacion = VE.Codigo
			WHERE M.tEstadoPedido <> '03' AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
			
			--PEDIDOS ELIMINADOS
			INSERT INTO #DBTRANS 
			SELECT CONVERT(NVARCHAR,M.fRegistro,103) + ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaPedido,M.tTurno As Turno,ISNULL(VM.tDetallado,'') As Mesa,M.tCodigoPedido As Pedido,
				   V.tResumido As Producto, A.nCantidad As Cantidad, A.nPrecioVenta As Venta, CONVERT(NVARCHAR,A.fRegistro,103) As FechaProducto,
				   A.lImprime As Imprime, CONVERT(NVARCHAR,A.fRegistroAnulado,103) As FechaAnulaProducto, CONVERT(NVARCHAR,M.fRegAnulado,103) As FechaAnulaPedido, M.tUsuario As Usuario,
				   A.tUsuarioAnulado As UsuarioAnulaProducto, M.tUsuarioAnulado As UsuarioAnulaPedido, 
				   (CASE VE.Descripcion WHEN 'Otro' THEN M.tObservacionAnulado Else VE.Descripcion END) As Motivo    
			FROM MPEDIDO M 
						   INNER JOIN APEDIDO A ON M.tCodigoPedido = A.tCodigoPedido
						   INNER JOIN vProducto V ON A.tCodigoProducto = V.Codigo             
						   LEFT JOIN TMESA VM ON M.tMesa = VM.tCodigoMesa
						   LEFT JOIN vMotivoEliminacion VE ON A.tMotivoEliminacion = VE.Codigo
			WHERE M.tEstadoPedido = '03' AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
			
			--PRODUCTOS ELIMINADOS DE SUS DETALLES
			INSERT INTO #DBTRANS 
			SELECT CONVERT(NVARCHAR,M.fRegistro,103) + ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaPedido,M.tTurno As Turno,ISNULL(VM.tDetallado,'') As Mesa,M.tCodigoPedido As Pedido,
				   V.tResumido As Producto, D.nCantidad As Cantidad, D.nPrecioVenta As Venta, CONVERT(NVARCHAR,D.fRegistro,103) As FechaProducto,
				   D.lImprime As Imprime, '' As FechaAnulaProducto, CONVERT(NVARCHAR,M.fRegAnulado,103) As FechaAnulaPedido, M.tUsuario As Usuario,
				   '' As UsuarioAnulaProducto, M.tUsuarioAnulado As UsuarioAnulaPedido, 
				   (CASE VE.Descripcion WHEN 'Otro' THEN M.tObservacionAnulado Else VE.Descripcion END) As Motivo    
			FROM MPEDIDO M 
						   INNER JOIN DPEDIDO D ON M.tCodigoPedido = D.tCodigoPedido
						   INNER JOIN vProducto V ON D.tCodigoProducto = V.Codigo             
						   LEFT JOIN TMESA VM ON M.tMesa = VM.tCodigoMesa
						   LEFT JOIN vMotivoEliminacion VE ON M.tMotivoAnulacion = VE.Codigo
			WHERE M.tEstadoPedido = '03' AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
			
		END	
				
	IF @flagNoImp = 1
	    BEGIN
	        INSERT INTO #DBTRANS 
			SELECT CONVERT(NVARCHAR,M.fRegistro,103)+ ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaPedido,M.tTurno As Turno,ISNULL(VM.tDetallado,'') As Mesa,M.tCodigoPedido As Pedido,
				   V.tResumido As Producto, A.nCantidad As Cantidad, A.nPrecioVenta As Venta, CONVERT(NVARCHAR,A.fRegistro,103) As FechaProducto,
				   A.lImprime As Imprime, CONVERT(NVARCHAR,A.fRegistroAnulado,103)  As FechaAnulaProducto, '' As FechaAnulaPedido, M.tUsuario As Usuario,
				   A.tUsuarioAnulado As UsuarioAnulaProducto, '' As UsuarioAnulaPedido, 
				   (CASE VE.Descripcion WHEN 'Otro' THEN A.tObservacionAnulado Else VE.Descripcion END) As Motivo    
			FROM MPEDIDO M INNER JOIN APEDIDO A ON M.tCodigoPedido = A.tCodigoPedido
						   INNER JOIN vProducto V ON A.tCodigoProducto = V.Codigo              
						   LEFT JOIN TMESA VM ON M.tMesa = VM.tCodigoMesa
						   LEFT JOIN vMotivoEliminacion VE ON A.tMotivoEliminacion = VE.Codigo
			WHERE M.tEstadoPedido <> '03' AND A.lImprime=0 AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
				
			INSERT INTO #DBTRANS 
			SELECT CONVERT(NVARCHAR,M.fRegistro,103) + ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaPedido,M.tTurno As Turno,ISNULL(VM.tDetallado,'') As Mesa,M.tCodigoPedido As Pedido,
				   V.tResumido As Producto, A.nCantidad As Cantidad, A.nPrecioVenta As Venta, CONVERT(NVARCHAR,A.fRegistro,103) As FechaProducto,
				   A.lImprime As Imprime, CONVERT(NVARCHAR,A.fRegistroAnulado,103) As FechaAnulaProducto, CONVERT(NVARCHAR,M.fRegAnulado,103) As FechaAnulaPedido, M.tUsuario As Usuario,
				   A.tUsuarioAnulado As UsuarioAnulaProducto, M.tUsuarioAnulado As UsuarioAnulaPedido, 
				   (CASE VE.Descripcion WHEN 'Otro' THEN M.tObservacionAnulado Else VE.Descripcion END) As Motivo    
			FROM MPEDIDO M 
						   INNER JOIN APEDIDO A ON M.tCodigoPedido = A.tCodigoPedido
						   INNER JOIN vProducto V ON A.tCodigoProducto = V.Codigo             
						   LEFT JOIN TMESA VM ON M.tMesa = VM.tCodigoMesa
						   LEFT JOIN vMotivoEliminacion VE ON A.tMotivoEliminacion = VE.Codigo
			WHERE M.tEstadoPedido = '03' AND A.lImprime=0 AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
			
			INSERT INTO #DBTRANS 
			SELECT CONVERT(NVARCHAR,M.fRegistro,103) + ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaPedido,M.tTurno As Turno,ISNULL(VM.tDetallado,'') As Mesa,M.tCodigoPedido As Pedido,
				   V.tResumido As Producto, D.nCantidad As Cantidad, D.nPrecioVenta As Venta, CONVERT(NVARCHAR,D.fRegistro,103) As FechaProducto,
				   D.lImprime As Imprime, '' As FechaAnulaProducto, CONVERT(NVARCHAR,M.fRegAnulado,103) As FechaAnulaPedido, M.tUsuario As Usuario,
				   '' As UsuarioAnulaProducto, M.tUsuarioAnulado As UsuarioAnulaPedido, 
				   (CASE VE.Descripcion WHEN 'Otro' THEN M.tObservacionAnulado Else VE.Descripcion END) As Motivo    
			FROM MPEDIDO M 
						   INNER JOIN DPEDIDO D ON M.tCodigoPedido = D.tCodigoPedido
						   INNER JOIN vProducto V ON D.tCodigoProducto = V.Codigo             
						   LEFT JOIN TMESA VM ON M.tMesa = VM.tCodigoMesa
						   LEFT JOIN vMotivoEliminacion VE ON M.tMotivoAnulacion = VE.Codigo
			WHERE M.tEstadoPedido = '03' AND D.lImprime=0 AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
		END		
				
				
	IF @flagImp = 1
	    BEGIN
            INSERT INTO #DBTRANS 
			SELECT CONVERT(NVARCHAR,M.fRegistro,103)+ ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaPedido,M.tTurno As Turno,ISNULL(VM.tDetallado,'') As Mesa,M.tCodigoPedido As Pedido,
				   V.tResumido As Producto, A.nCantidad As Cantidad, A.nPrecioVenta As Venta, CONVERT(NVARCHAR,A.fRegistro,103) As FechaProducto,
				   A.lImprime As Imprime, CONVERT(NVARCHAR,A.fRegistroAnulado,103)  As FechaAnulaProducto, '' As FechaAnulaPedido, M.tUsuario As Usuario,
				   A.tUsuarioAnulado As UsuarioAnulaProducto, '' As UsuarioAnulaPedido, 
				   (CASE VE.Descripcion WHEN 'Otro' THEN A.tObservacionAnulado Else VE.Descripcion END) As Motivo    
			FROM MPEDIDO M INNER JOIN APEDIDO A ON M.tCodigoPedido = A.tCodigoPedido
						   INNER JOIN vProducto V ON A.tCodigoProducto = V.Codigo              
						   LEFT JOIN TMESA VM ON M.tMesa = VM.tCodigoMesa
						   LEFT JOIN vMotivoEliminacion VE ON A.tMotivoEliminacion = VE.Codigo
			WHERE M.tEstadoPedido <> '03' AND A.lImprime=1 AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
				
			INSERT INTO #DBTRANS 
			SELECT CONVERT(NVARCHAR,M.fRegistro,103) + ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaPedido,M.tTurno As Turno,ISNULL(VM.tDetallado,'') As Mesa,M.tCodigoPedido As Pedido,
				   V.tResumido As Producto, A.nCantidad As Cantidad, A.nPrecioVenta As Venta, CONVERT(NVARCHAR,A.fRegistro,103) As FechaProducto,
				   A.lImprime As Imprime, CONVERT(NVARCHAR,A.fRegistroAnulado,103) As FechaAnulaProducto, CONVERT(NVARCHAR,M.fRegAnulado,103) As FechaAnulaPedido, M.tUsuario As Usuario,
				   A.tUsuarioAnulado As UsuarioAnulaProducto, M.tUsuarioAnulado As UsuarioAnulaPedido, 
				   (CASE VE.Descripcion WHEN 'Otro' THEN M.tObservacionAnulado Else VE.Descripcion END) As Motivo    
			FROM MPEDIDO M 
						   INNER JOIN APEDIDO A ON M.tCodigoPedido = A.tCodigoPedido
						   INNER JOIN vProducto V ON A.tCodigoProducto = V.Codigo             
						   LEFT JOIN TMESA VM ON M.tMesa = VM.tCodigoMesa
						   LEFT JOIN vMotivoEliminacion VE ON A.tMotivoEliminacion = VE.Codigo
			WHERE M.tEstadoPedido = '03' AND A.lImprime=1 AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
			
			INSERT INTO #DBTRANS 
			SELECT CONVERT(NVARCHAR,M.fRegistro,103) + ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaPedido,M.tTurno As Turno,ISNULL(VM.tDetallado,'') As Mesa,M.tCodigoPedido As Pedido,
				   V.tResumido As Producto, D.nCantidad As Cantidad, D.nPrecioVenta As Venta, CONVERT(NVARCHAR,D.fRegistro,103) As FechaProducto,
				   D.lImprime As Imprime, '' As FechaAnulaProducto, CONVERT(NVARCHAR,M.fRegAnulado,103) As FechaAnulaPedido, M.tUsuario As Usuario,
				   '' As UsuarioAnulaProducto, M.tUsuarioAnulado As UsuarioAnulaPedido, 
				   (CASE VE.Descripcion WHEN 'Otro' THEN M.tObservacionAnulado Else VE.Descripcion END) As Motivo    
			FROM MPEDIDO M 
						   INNER JOIN DPEDIDO D ON M.tCodigoPedido = D.tCodigoPedido
						   INNER JOIN vProducto V ON D.tCodigoProducto = V.Codigo             
						   LEFT JOIN TMESA VM ON M.tMesa = VM.tCodigoMesa
						   LEFT JOIN vMotivoEliminacion VE ON M.tMotivoAnulacion = VE.Codigo
			WHERE M.tEstadoPedido = '03' AND D.lImprime=1 AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
		END			
END
	
	
	
--FRANJA HORARIA
	
IF @flagFranja = 1

DECLARE @numdias int
DECLARE @contaDias int
DECLARE @finicial as datetime
SET @numdias=(select   DATEDIFF ( day , @finicio,@ffinal))
 
SET @contaDias=0
SET @finicial=@finicio
WHILE (@contadias<=@numdias)
	BEGIN
	SET @finicio=(select dateadd(day,@contadias,@finicial))	
	SET @ffinal= (select  cast(convert(nvarchar,@finicio,112)   + ' '  + CONVERT(VARCHAR,@ffinal,108) as datetime))
                    
BEGIN

	IF @flagTodos = 1
	   BEGIN	
	        --PRODUCTOS ELIMINADOS - ENVIADOS A APEDIDO	  
            INSERT INTO #DBTRANS         
			SELECT CONVERT(NVARCHAR,M.fRegistro,103)+ ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaPedido,M.tTurno As Turno,ISNULL(VM.tDetallado,'') As Mesa,M.tCodigoPedido As Pedido,
				   V.tResumido As Producto, A.nCantidad As Cantidad, A.nPrecioVenta As Venta, CONVERT(NVARCHAR,A.fRegistro,103) As FechaProducto,
				   A.lImprime As Imprime, CONVERT(NVARCHAR,A.fRegistroAnulado,103)  As FechaAnulaProducto, '' As FechaAnulaPedido, M.tUsuario As Usuario,
				   A.tUsuarioAnulado As UsuarioAnulaProducto, '' As UsuarioAnulaPedido, 
				   (CASE VE.Descripcion WHEN 'Otro' THEN A.tObservacionAnulado Else VE.Descripcion END) As Motivo    
			FROM MPEDIDO M INNER JOIN APEDIDO A ON M.tCodigoPedido = A.tCodigoPedido
						   INNER JOIN vProducto V ON A.tCodigoProducto = V.Codigo              
						   LEFT JOIN TMESA VM ON M.tMesa = VM.tCodigoMesa
						   LEFT JOIN vMotivoEliminacion VE ON A.tMotivoEliminacion = VE.Codigo
			WHERE M.tEstadoPedido <> '03' AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
			
			--PEDIDOS ELIMINADOS
			INSERT INTO #DBTRANS 
			SELECT CONVERT(NVARCHAR,M.fRegistro,103) + ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaPedido,M.tTurno As Turno,ISNULL(VM.tDetallado,'') As Mesa,M.tCodigoPedido As Pedido,
				   V.tResumido As Producto, A.nCantidad As Cantidad, A.nPrecioVenta As Venta, CONVERT(NVARCHAR,A.fRegistro,103) As FechaProducto,
				   A.lImprime As Imprime, CONVERT(NVARCHAR,A.fRegistroAnulado,103) As FechaAnulaProducto, CONVERT(NVARCHAR,M.fRegAnulado,103) As FechaAnulaPedido, M.tUsuario As Usuario,
				   A.tUsuarioAnulado As UsuarioAnulaProducto, M.tUsuarioAnulado As UsuarioAnulaPedido, 
				   (CASE VE.Descripcion WHEN 'Otro' THEN M.tObservacionAnulado Else VE.Descripcion END) As Motivo    
			FROM MPEDIDO M 
						   INNER JOIN APEDIDO A ON M.tCodigoPedido = A.tCodigoPedido
						   INNER JOIN vProducto V ON A.tCodigoProducto = V.Codigo             
						   LEFT JOIN TMESA VM ON M.tMesa = VM.tCodigoMesa
						   LEFT JOIN vMotivoEliminacion VE ON A.tMotivoEliminacion = VE.Codigo
			WHERE M.tEstadoPedido = '03' AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
			
			--PRODUCTOS ELIMINADOS DE SUS DETALLES
			INSERT INTO #DBTRANS 
			SELECT CONVERT(NVARCHAR,M.fRegistro,103) + ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaPedido,M.tTurno As Turno,ISNULL(VM.tDetallado,'') As Mesa,M.tCodigoPedido As Pedido,
				   V.tResumido As Producto, D.nCantidad As Cantidad, D.nPrecioVenta As Venta, CONVERT(NVARCHAR,D.fRegistro,103) As FechaProducto,
				   D.lImprime As Imprime, '' As FechaAnulaProducto, CONVERT(NVARCHAR,M.fRegAnulado,103) As FechaAnulaPedido, M.tUsuario As Usuario,
				   '' As UsuarioAnulaProducto, M.tUsuarioAnulado As UsuarioAnulaPedido, 
				   (CASE VE.Descripcion WHEN 'Otro' THEN M.tObservacionAnulado Else VE.Descripcion END) As Motivo    
			FROM MPEDIDO M 
						   INNER JOIN DPEDIDO D ON M.tCodigoPedido = D.tCodigoPedido
						   INNER JOIN vProducto V ON D.tCodigoProducto = V.Codigo             
						   LEFT JOIN TMESA VM ON M.tMesa = VM.tCodigoMesa
						   LEFT JOIN vMotivoEliminacion VE ON M.tMotivoAnulacion = VE.Codigo
			WHERE M.tEstadoPedido = '03' AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
			
		END	
				
	IF @flagNoImp = 1
	    BEGIN
	        INSERT INTO #DBTRANS 
			SELECT CONVERT(NVARCHAR,M.fRegistro,103)+ ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaPedido,M.tTurno As Turno,ISNULL(VM.tDetallado,'') As Mesa,M.tCodigoPedido As Pedido,
				   V.tResumido As Producto, A.nCantidad As Cantidad, A.nPrecioVenta As Venta, CONVERT(NVARCHAR,A.fRegistro,103) As FechaProducto,
				   A.lImprime As Imprime, CONVERT(NVARCHAR,A.fRegistroAnulado,103)  As FechaAnulaProducto, '' As FechaAnulaPedido, M.tUsuario As Usuario,
				   A.tUsuarioAnulado As UsuarioAnulaProducto, '' As UsuarioAnulaPedido, 
				   (CASE VE.Descripcion WHEN 'Otro' THEN A.tObservacionAnulado Else VE.Descripcion END) As Motivo    
			FROM MPEDIDO M INNER JOIN APEDIDO A ON M.tCodigoPedido = A.tCodigoPedido
						   INNER JOIN vProducto V ON A.tCodigoProducto = V.Codigo              
						   LEFT JOIN TMESA VM ON M.tMesa = VM.tCodigoMesa
						   LEFT JOIN vMotivoEliminacion VE ON A.tMotivoEliminacion = VE.Codigo
			WHERE M.tEstadoPedido <> '03' AND A.lImprime=0 AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
				
			INSERT INTO #DBTRANS 
			SELECT CONVERT(NVARCHAR,M.fRegistro,103) + ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaPedido,M.tTurno As Turno,ISNULL(VM.tDetallado,'') As Mesa,M.tCodigoPedido As Pedido,
				   V.tResumido As Producto, A.nCantidad As Cantidad, A.nPrecioVenta As Venta, CONVERT(NVARCHAR,A.fRegistro,103) As FechaProducto,
				   A.lImprime As Imprime, CONVERT(NVARCHAR,A.fRegistroAnulado,103) As FechaAnulaProducto, CONVERT(NVARCHAR,M.fRegAnulado,103) As FechaAnulaPedido, M.tUsuario As Usuario,
				   A.tUsuarioAnulado As UsuarioAnulaProducto, M.tUsuarioAnulado As UsuarioAnulaPedido, 
				   (CASE VE.Descripcion WHEN 'Otro' THEN M.tObservacionAnulado Else VE.Descripcion END) As Motivo    
			FROM MPEDIDO M 
						   INNER JOIN APEDIDO A ON M.tCodigoPedido = A.tCodigoPedido
						   INNER JOIN vProducto V ON A.tCodigoProducto = V.Codigo             
						   LEFT JOIN TMESA VM ON M.tMesa = VM.tCodigoMesa
						   LEFT JOIN vMotivoEliminacion VE ON A.tMotivoEliminacion = VE.Codigo
			WHERE M.tEstadoPedido = '03' AND A.lImprime=0 AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
			
			INSERT INTO #DBTRANS 
			SELECT CONVERT(NVARCHAR,M.fRegistro,103) + ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaPedido,M.tTurno As Turno,ISNULL(VM.tDetallado,'') As Mesa,M.tCodigoPedido As Pedido,
				   V.tResumido As Producto, D.nCantidad As Cantidad, D.nPrecioVenta As Venta, CONVERT(NVARCHAR,D.fRegistro,103) As FechaProducto,
				   D.lImprime As Imprime, '' As FechaAnulaProducto, CONVERT(NVARCHAR,M.fRegAnulado,103) As FechaAnulaPedido, M.tUsuario As Usuario,
				   '' As UsuarioAnulaProducto, M.tUsuarioAnulado As UsuarioAnulaPedido, 
				   (CASE VE.Descripcion WHEN 'Otro' THEN M.tObservacionAnulado Else VE.Descripcion END) As Motivo    
			FROM MPEDIDO M 
						   INNER JOIN DPEDIDO D ON M.tCodigoPedido = D.tCodigoPedido
						   INNER JOIN vProducto V ON D.tCodigoProducto = V.Codigo             
						   LEFT JOIN TMESA VM ON M.tMesa = VM.tCodigoMesa
						   LEFT JOIN vMotivoEliminacion VE ON M.tMotivoAnulacion = VE.Codigo
			WHERE M.tEstadoPedido = '03' AND D.lImprime=0 AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
		END		
				
				
	IF @flagImp = 1
	    BEGIN
            INSERT INTO #DBTRANS 
			SELECT CONVERT(NVARCHAR,M.fRegistro,103)+ ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaPedido,M.tTurno As Turno,ISNULL(VM.tDetallado,'') As Mesa,M.tCodigoPedido As Pedido,
				   V.tResumido As Producto, A.nCantidad As Cantidad, A.nPrecioVenta As Venta, CONVERT(NVARCHAR,A.fRegistro,103) As FechaProducto,
				   A.lImprime As Imprime, CONVERT(NVARCHAR,A.fRegistroAnulado,103)  As FechaAnulaProducto, '' As FechaAnulaPedido, M.tUsuario As Usuario,
				   A.tUsuarioAnulado As UsuarioAnulaProducto, '' As UsuarioAnulaPedido, 
				   (CASE VE.Descripcion WHEN 'Otro' THEN A.tObservacionAnulado Else VE.Descripcion END) As Motivo    
			FROM MPEDIDO M INNER JOIN APEDIDO A ON M.tCodigoPedido = A.tCodigoPedido
						   INNER JOIN vProducto V ON A.tCodigoProducto = V.Codigo              
						   LEFT JOIN TMESA VM ON M.tMesa = VM.tCodigoMesa
						   LEFT JOIN vMotivoEliminacion VE ON A.tMotivoEliminacion = VE.Codigo
			WHERE M.tEstadoPedido <> '03' AND A.lImprime=1 AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
				
			INSERT INTO #DBTRANS 
			SELECT CONVERT(NVARCHAR,M.fRegistro,103) + ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaPedido,M.tTurno As Turno,ISNULL(VM.tDetallado,'') As Mesa,M.tCodigoPedido As Pedido,
				   V.tResumido As Producto, A.nCantidad As Cantidad, A.nPrecioVenta As Venta, CONVERT(NVARCHAR,A.fRegistro,103) As FechaProducto,
				   A.lImprime As Imprime, CONVERT(NVARCHAR,A.fRegistroAnulado,103) As FechaAnulaProducto, CONVERT(NVARCHAR,M.fRegAnulado,103) As FechaAnulaPedido, M.tUsuario As Usuario,
				   A.tUsuarioAnulado As UsuarioAnulaProducto, M.tUsuarioAnulado As UsuarioAnulaPedido, 
				   (CASE VE.Descripcion WHEN 'Otro' THEN M.tObservacionAnulado Else VE.Descripcion END) As Motivo    
			FROM MPEDIDO M 
						   INNER JOIN APEDIDO A ON M.tCodigoPedido = A.tCodigoPedido
						   INNER JOIN vProducto V ON A.tCodigoProducto = V.Codigo             
						   LEFT JOIN TMESA VM ON M.tMesa = VM.tCodigoMesa
						   LEFT JOIN vMotivoEliminacion VE ON A.tMotivoEliminacion = VE.Codigo
			WHERE M.tEstadoPedido = '03' AND A.lImprime=1 AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
			
			INSERT INTO #DBTRANS 
			SELECT CONVERT(NVARCHAR,M.fRegistro,103) + ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaPedido,M.tTurno As Turno,ISNULL(VM.tDetallado,'') As Mesa,M.tCodigoPedido As Pedido,
				   V.tResumido As Producto, D.nCantidad As Cantidad, D.nPrecioVenta As Venta, CONVERT(NVARCHAR,D.fRegistro,103) As FechaProducto,
				   D.lImprime As Imprime, '' As FechaAnulaProducto, CONVERT(NVARCHAR,M.fRegAnulado,103) As FechaAnulaPedido, M.tUsuario As Usuario,
				   '' As UsuarioAnulaProducto, M.tUsuarioAnulado As UsuarioAnulaPedido, 
				   (CASE VE.Descripcion WHEN 'Otro' THEN M.tObservacionAnulado Else VE.Descripcion END) As Motivo    
			FROM MPEDIDO M 
						   INNER JOIN DPEDIDO D ON M.tCodigoPedido = D.tCodigoPedido
						   INNER JOIN vProducto V ON D.tCodigoProducto = V.Codigo             
						   LEFT JOIN TMESA VM ON M.tMesa = VM.tCodigoMesa
						   LEFT JOIN vMotivoEliminacion VE ON M.tMotivoAnulacion = VE.Codigo
			WHERE M.tEstadoPedido = '03' AND D.lImprime=1 AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 
		END	
		
			SET @contadias=@contadias+1
	END	
	
END	

							
SELECT FechaPedido,Turno,Mesa,Pedido,Producto,Cantidad,Venta,FechaProducto,Imprime,FechaAnulaProducto,
       FechaAnulaPedido,Usuario,UsuarioAnulaProducto,UsuarioAnulaPedido,Motivo      
FROM #DBTRANS 
ORDER BY #DBTRANS.FechaPedido, #DBTRANS.Pedido 


END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


CREATE PROCEDURE [dbo].[spRep_AnulacionDocumentoIntegrado]
@flagFranja as bit,
@fInicio as smalldatetime,
@fFinal as smalldatetime

AS BEGIN

SET NOCOUNT ON

	CREATE TABLE #DBTRANS (
	                       FechaDocumento nVarChar(50) collate Modern_Spanish_CI_AS, 
	                       Turno nVarChar(20) collate Modern_Spanish_CI_AS, 
	                       Documento nVarChar(50) collate Modern_Spanish_CI_AS, 
                           Monto Float, Motivo nVarChar(200) collate Modern_Spanish_CI_AS,
	                       UsuarioAnulo nVarChar(20) collate Modern_Spanish_CI_AS, 
	                       FechaAnulacion nVarChar(50) collate Modern_Spanish_CI_AS,
	                       Pedido nVarChar(20) collate Modern_Spanish_CI_AS,
	                       UsuarioPedido nVarChar(20) collate Modern_Spanish_CI_AS)

IF @flagFranja = 0
                     
	BEGIN
	    INSERT INTO #DBTRANS
		SELECT CONVERT(NVARCHAR,M.fRegistro,103)+ ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaDocumento,
		       M.tTurno As Turno, M.tDocumento As Documento, M.nVenta As Monto,
			   M.tObservacion As Motivo, M.tUsuarioAnulado As UsuarioAnulo, CONVERT(NVARCHAR,M.fRegistroAnulado,103)  As FechaAnulacion,
			   MAX(D.tCodigoPedido) As Pedido, MP.tUsuario  As UsuarioPedido
		FROM MDOCUMENTO M LEFT JOIN DDOCUMENTO D ON M.tDocumento = D.tDocumento
			 INNER JOIN MPEDIDO MP ON MP.tCodigoPedido = D.tCodigoPedido
		WHERE M.tEstadoDocumento='04' AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 

		GROUP BY M.fRegistro,M.tTurno, M.tDocumento, M.nVenta,
				 M.tObservacion, M.tUsuarioAnulado,MP.tUsuario, M.fRegistroAnulado
	END        


IF @flagFranja = 1

DECLARE @numdias int
DECLARE @contaDias int
DECLARE @finicial as datetime
SET @numdias=(select   DATEDIFF ( day , @finicio,@ffinal))
 
SET @contaDias=0
SET @finicial=@finicio
WHILE (@contadias<=@numdias)
	BEGIN
	SET @finicio=(select dateadd(day,@contadias,@finicial))	
	SET @ffinal= (select  cast(convert(nvarchar,@finicio,112)   + ' '  + CONVERT(VARCHAR,@ffinal,108) as datetime))
	                     
	BEGIN
	    INSERT INTO #DBTRANS
		SELECT CONVERT(NVARCHAR,M.fRegistro,103)+ ' ' + CONVERT(NVARCHAR,M.fRegistro,108) As FechaDocumento,M.tTurno As Turno, M.tDocumento As Documento, M.nVenta As Monto,
			   M.tObservacion As Motivo, M.tUsuarioAnulado As UsuarioAnulo, CONVERT(NVARCHAR,M.fRegistroAnulado,103) As FechaAnulacion,
			   MAX(D.tCodigoPedido) As Pedido, MP.tUsuario  As UsuarioPedido
		FROM MDOCUMENTO M LEFT JOIN DDOCUMENTO D ON M.tDocumento = D.tDocumento
			 INNER JOIN MPEDIDO MP ON MP.tCodigoPedido = D.tCodigoPedido
		WHERE M.tEstadoDocumento='04' AND (M.fRegistro >= @fInicio AND M.fRegistro <= @fFinal) 

		GROUP BY M.fRegistro,M.tTurno, M.tDocumento, M.nVenta,
				 M.tObservacion, M.tUsuarioAnulado,MP.tUsuario, M.fRegistroAnulado
	END   
	  SET @contadias=@contadias+1
    END

SELECT 
FechaDocumento, Turno, Documento, Monto, Motivo, UsuarioAnulo, FechaAnulacion,Pedido,UsuarioPedido
FROM #DBTRANS 
ORDER BY #DBTRANS.FechaDocumento, #DBTRANS.Documento 
	
END
         
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


CREATE PROCEDURE [dbo].[spRep_MensajeUsuario]
@fInicio As smalldatetime,
@fFinal As smalldatetime,
@tTipo As nvarchar(20),
@tCaja As nvarchar(20),
@tMozo As nvarchar(20)

AS
BEGIN 
SET NOCOUNT ON 

CREATE TABLE #DBTRANS (Pedido nVarchar(20), TipoPedido  nVarchar(50) collate Modern_Spanish_CI_AS,
                       Mesa nVarchar(200) collate Modern_Spanish_CI_AS,Mesero nVarchar(200) collate Modern_Spanish_CI_AS,
                       FechaRegistro nVarchar(200) collate Modern_Spanish_CI_AS, Caja nVarchar(200) collate Modern_Spanish_CI_AS,
                       Mensaje nVarchar(200) collate Modern_Spanish_CI_AS,UsuarioEnvia nVarchar(30) collate Modern_Spanish_CI_AS)	

INSERT INTO #DBTRANS
SELECT T.tCodigoPedido As Pedido, T.tTipoPedido As TipoPedido, T.tMesa As Mesa, T.tMozo As Mesero, 
       CONVERT(NVARCHAR,T.fRegistro,103)+ ' ' + CONVERT(NVARCHAR,T.fRegistro,108) As FechaRegistro,
       T.tCaja As Caja, T.tMensaje As Mensaje, T.tUsuario As UsuarioEnvia
FROM TMENSAJEUSUARIO T INNER JOIN MPEDIDO M
     ON T.tCodigoPedido = M.tCodigoPedido
WHERE (T.fRegistro >= @fInicio AND T.fRegistro <= @fFinal) 
     AND (M.tTipoPedido=@tTipo OR @tTipo='')
     AND (M.tCaja=@tCaja OR @tCaja='')
     AND (M.tMozo=@tMozo OR @tMozo='')
ORDER BY T.tCodigoPedido, T.fRegistro

SELECT * FROM #DBTRANS

END


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




